/* This file created by JSCacher. Last modified: Fri Apr 17 16:01:04 EDT 2020 */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})}this.batch_.push(a)};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];a[b]=null;try{c()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(h){b.reject(h)}};e.prototype.createResolveAndReject_=function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(h){this.reject_(h);return}"function"==typeof b?
this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)f.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(l){c.reject(l)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(u){f(u)}}:b}var d,f,g=new e(function(a,b){d=a;f=b});this.callWhenSettled_(c(a,d),c(b,f));return g};
e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_);}}var d=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(c)};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,d){for(var e=$jscomp.makeIterator(a),f=e.next();!f.done;f=e.next())c(f.value).callWhenSettled_(b,
d)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;k--;0==k&&a(g)}}var g=[],k=0;do g.push(void 0),k++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");
$jscomp.polyfill("Promise.prototype.finally",function(a){return a?a:function(a){return this.then(function(b){return Promise.resolve(a()).then(function(){return b})},function(b){return Promise.resolve(a()).then(function(){throw b;})})}},"es9","es3");$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};
$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};$jscomp.Symbol=function(){function a(c){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(c||"")+"_"+b++,c)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};
$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;$jscomp.generator={};$jscomp.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};
$jscomp.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};$jscomp.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};$jscomp.generator.Context.prototype.stop_=function(){this.isRunning_=!1};
$jscomp.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};$jscomp.generator.Context.prototype.next_=function(a){this.yieldResult=a};$jscomp.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};$jscomp.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};
$jscomp.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};$jscomp.generator.Context.prototype.yieldAll=function(a,b){a=$jscomp.makeIterator(a);var c=a.next();$jscomp.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};
$jscomp.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};$jscomp.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};$jscomp.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};$jscomp.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};$jscomp.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
$jscomp.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};$jscomp.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
$jscomp.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};$jscomp.generator.Context.prototype.forIn=function(a){return new $jscomp.generator.Context.PropertyIterator(a)};
$jscomp.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};$jscomp.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};$jscomp.generator.Engine_=function(a){this.context_=new $jscomp.generator.Context;this.program_=a};
$jscomp.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(a){return{value:a,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);$jscomp.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
$jscomp.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};$jscomp.initSymbolIterator();this[Symbol.iterator]=function(){return this}};$jscomp.generator.createGenerator=function(a,b){b=new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(b));$jscomp.setPrototypeOf&&$jscomp.setPrototypeOf(b,a.prototype);return b};
$jscomp.asyncExecutePromiseGenerator=function(a){function b(b){return a.next(b)}function c(b){return a.throw(b)}return new Promise(function(d,e){function f(a){a.done?d(a.value):Promise.resolve(a.value).then(b,c).then(f,e)}f(a.next())})};$jscomp.asyncExecutePromiseGeneratorFunction=function(a){return $jscomp.asyncExecutePromiseGenerator(a())};$jscomp.asyncExecutePromiseGeneratorProgram=function(a){return $jscomp.asyncExecutePromiseGenerator(new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(a)))};
function Bubblelines(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.INTERVAL=50;this.DISMISS_DELAY=2500;this.UNIFORM_LINE_LENGTH=!0;this.SEPARATE_LINES_FOR_TERMS=!1;this.MAX_LINE_WIDTH=this.MAX_LABEL_WIDTH=0;this.DRAW_TITLES=!0;this.DRAW_SHORT_TITLES=!1;this.graphSeparation=this.MIN_GRAPH_SEPARATION=50;this.yIndex=0;this.mouseOver=!1;this.clearToolTipId=this.intervalId=null;this.overBubbles=[];this.lastClickedBubbles={};this.ctx=this.canvas=this.dragInfo=null;this.maxDocLength=
2;this.maxFreq={term:null,value:0};this.maxRadius=0;this.cache=new Ext.util.MixedCollection;this.currentTerms={};this.termsFilter=[];this.bubbleSpacing=50;this.initialized=!1}
Bubblelines.prototype={constructor:Bubblelines,initializeCanvas:function(){var a=this.container,b=a.getHeight(),c=a.getWidth();this.DRAW_SHORT_TITLES=500>c;var d=Ext.id("bubblelines");a.add({xtype:"container",width:c,height:b,html:'\x3ccanvas id\x3d"'+d+'" width\x3d"'+c+'" height\x3d"'+b+'"\x3e\x3c/canvas\x3e',border:!1,listeners:{afterrender:{fn:function(a){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),
!1);this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1);this.canvas.addEventListener("mouseenter",this.mouseEnterHandler.bind(this),!1);this.canvas.addEventListener("mouseleave",this.mouseLeaveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doBubblelinesLayout:function(){if(this.initialized){var a=
this.container.getWidth();this.DRAW_SHORT_TITLES=500>a;this.setTitleWidthsAndMaxTitleWidth();for(var b=Ext.DomQuery.jsSelect("div:not(div[class*\x3dterm])",this.container.el.dom),c=0;c<b.length;c++)Ext.fly(b[c]).setWidth(a);this.canvas.width=a;b=75;this.DRAW_SHORT_TITLES&&(b=50);this.setMaxLineWidth(a-this.MAX_LABEL_WIDTH-b);this.setLineLengths();this.recache();this.setCanvasHeight();this.drawGraph()}},addDocToCache:function(a){this.cacheBubbles(a);this.calculateBubbleRadii(a);a.lineLength=600;a.freqCounts=
{};!1===this.cache.containsKey(a.id)?this.cache.add(a):this.cache.replace(a.id,a);this.cache.sort("index","ASC")},addTermsToDoc:function(a,b){var c;for(c in a)var d=c;this.currentTerms[d]=!0;b=this.cache.get(b);Ext.apply(b.terms,a);this.cacheBubbles(b)?this.recache():this.calculateBubbleRadii(b)},cacheBubbles:function(a){var b=!1,c;for(c in a.terms){for(var d=a.terms[c],e=d.distributions.length,f=a.lineLength/e,g=[],k=0,h=0,l=0,m=0;m<e;m++){var n=d.distributions[m];n>h&&(h=n);g.push({id:Ext.id(null,
"bub"),x:l,freq:n,radius:0,bin:m,tokenPositions:d.positions.slice(k,k+=n)});l+=f}a.terms[c].maxDistribution=h;a.terms[c].pos=g;h>this.maxFreq.value&&(b=!0,this.setMaxFreq({term:c,value:h}))}return b},calculateBubbleRadii:function(a,b){var c=Math.log(this.maxFreq.value),d=Math.log(2)/2,e;for(e in a.terms){var f=a.terms[e];if(f&&(null==b||e==b))for(var g=0;g<f.pos.length;g++){var k=f.pos[g];k.radius=0<k.freq?Math.max(Math.log(k.freq),d)/c*this.maxRadius:0}}},recache:function(){this.cache.each(function(a){this.cacheBubbles(a);
this.calculateBubbleRadii(a)},this)},getTotalHeight:function(){var a=this.maxRadius;this.cache.each(function(b,c,d){a+=b.height},this);return a},setCanvasHeight:function(){this.calculateGraphHeights();var a=this.getTotalHeight(),b=this.container.dom;if(void 0!==b){b=Ext.DomQuery.jsSelect("div",b);for(var c=0;c<b.length;c++)Ext.fly(b[c]).setHeight(a)}this.canvas&&(this.canvas.height=a)},setMaxLineWidth:function(a){this.maxRadius=a/30;this.MAX_LINE_WIDTH=a-this.maxRadius/2},calculateGraphHeights:function(){var a=
.5*this.maxRadius;if(this.SEPARATE_LINES_FOR_TERMS){var b=this.termsFilter;this.cache.each(function(c,e,f){e=this.maxRadius*b.length;for(f=0;f<b.length;f++)c.terms[b[f]]||(e-=this.maxRadius);0==e&&(e=this.maxRadius);c.height=e+a},this)}else{var c=Math.max(this.maxRadius,this.MIN_GRAPH_SEPARATION);this.cache.each(function(b,e,f){b.height=c+a},this)}},findLongestDocument:function(a){a=a.getTotalWordTokens();a>this.maxDocLength&&(this.maxDocLength=a)},getTitleWidth:function(a){var b=a.title;this.DRAW_SHORT_TITLES&&
(b=this.cache.indexOf(a)+1+")");this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";return this.ctx.measureText(b).width},setTitleWidthsAndMaxTitleWidth:function(){this.cache.each(function(a,b){b=this.getTitleWidth(a);a.titleWidth=b;b>this.MAX_LABEL_WIDTH&&(this.MAX_LABEL_WIDTH=b)},this)},setLineLengths:function(){this.cache.each(function(a,b){b=this.UNIFORM_LINE_LENGTH?this.MAX_LINE_WIDTH:Math.log(a.getTotalWordTokens())/Math.log(this.maxDocLength)*this.MAX_LINE_WIDTH;a.lineLength=b},this)},
drawGraph:function(a){null!=this.intervalId&&clearInterval(this.intervalId);this.mouseOver?this.intervalId=setInterval(this.doDraw.bind(this,[a]),this.INTERVAL):setTimeout(this.doDraw.bind(this,[a]),5)},doDraw:function(a){this.clearCanvas();this.yIndex=this.maxRadius;!0===a&&(this.yIndex+=30);this.cache.each(this.drawDocument,this);!0===a?this.drawLegend():this.drawToolTip();this.doDrag()},drawDocument:function(a,b,c){if(!a.hidden){var d=a.lineLength,e=this.MAX_LABEL_WIDTH-a.titleWidth,f=5;this.ctx.textBaseline=
"top";this.ctx.font="bold 12px Verdana";if(null!=this.dragInfo&&this.dragInfo.oldIndex==b)this.ctx.fillStyle="rgba(128, 128, 128, 0.5)",f+=e,this.ctx.fillText(a.title,f,this.yIndex),this.SEPARATE_LINES_FOR_TERMS&&(this.yIndex+=a.height);else{c=function(){f=g.MAX_LABEL_WIDTH+g.maxRadius;g.ctx.strokeStyle="rgba(128, 128, 128, 1.0)";g.ctx.fillStyle="rgba(128, 128, 128, 1.0)";g.ctx.lineWidth=.25;g.ctx.beginPath();g.ctx.moveTo(f,g.yIndex-6);g.ctx.lineTo(f,g.yIndex+6);g.ctx.stroke();g.ctx.beginPath();g.ctx.moveTo(f,
g.yIndex);g.ctx.lineTo(f+d,g.yIndex);g.ctx.stroke();g.ctx.beginPath();g.ctx.moveTo(f+d,g.yIndex-6);g.ctx.lineTo(f+d,g.yIndex+6);g.ctx.stroke()};this.DRAW_TITLES&&(f+=e,this.ctx.fillStyle="rgba(128, 128, 128, 1.0)",e=a.title,this.DRAW_SHORT_TITLES&&(e=b+1+")"),this.ctx.fillText(e,f,this.yIndex));this.yIndex+=4;var g=this;this.SEPARATE_LINES_FOR_TERMS?null!=this.termsFilter&&0!==this.termsFilter.length||c():c();e=2*Math.PI;var k=0;a.freqCounts={};var h=a.terms,l=null!=this.lastClickedBubbles[b],m=0,
n;for(n in h)if(-1!==this.termsFilter.indexOf(n)){var p=h[n];if(p){m++;this.SEPARATE_LINES_FOR_TERMS&&c();var r=0,q=p.color.join(",");this.ctx.strokeStyle="rgba("+q+", 1)";this.ctx.fillStyle="rgba("+q+", 0.35)";this.ctx.lineWidth=.25;k+=p.rawFreq;r+=p.rawFreq;for(var u=l&&this.lastClickedBubbles[b][n],v=0;v<p.pos.length;v++){var C=p.pos[v];if(0<C.radius){var w=!1;u&&this.lastClickedBubbles[b][n]==C.id&&(this.ctx.strokeStyle="rgba(0, 0, 0, 0.75)",this.ctx.fillStyle="rgba("+q+", 0.5)",this.ctx.lineWidth=
1,w=!0);this.ctx.beginPath();this.ctx.arc(C.x+f,this.yIndex,C.radius,0,e,!0);this.ctx.closePath();this.ctx.fill();this.ctx.stroke();w&&(this.ctx.strokeStyle="rgba("+q+", 1)",this.ctx.fillStyle="rgba("+q+", 0.35)",this.ctx.lineWidth=.25)}}a.freqCounts[n]=r;this.SEPARATE_LINES_FOR_TERMS&&(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(r,f+d+5,this.yIndex-4),this.yIndex+=this.maxRadius)}}this.SEPARATE_LINES_FOR_TERMS&&0==m&&(c(),this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",
this.ctx.font="10px Verdana",this.ctx.fillText(0,f+d+5,this.yIndex-4),this.yIndex+=this.maxRadius);f+=d;this.SEPARATE_LINES_FOR_TERMS||(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(k,f+5,this.yIndex-4))}this.yIndex=this.SEPARATE_LINES_FOR_TERMS?this.yIndex+.5*this.maxRadius:this.yIndex+a.height;this.yIndex-=4}},drawLegend:function(){var a=this.MAX_LABEL_WIDTH+this.maxRadius;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.typeStore&&this.typeStore.each(function(b){var c=
b.get("color").join(",");this.ctx.fillStyle="rgb("+c+")";b=b.get("type");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},this)},drawToolTip:function(){if(0<this.overBubbles.length){this.ctx.lineWidth=.5;this.ctx.fillStyle="rgba(224, 224, 224, 0.8)";this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)";var a=this.overBubbles[0].x,b=this.overBubbles[0].y;a+110>this.canvas.width&&(a-=110);if(null==this.overBubbles[0].label){var c=this.cache.get(this.overBubbles[0].docIndex);var d=1;for(var e in c.freqCounts)d++;
d*=16;b+d>this.canvas.height&&(b-=d);this.ctx.fillRect(a,b,110,d);this.ctx.strokeRect(a,b,110,d);a+=10;b+=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)";this.ctx.font="10px Verdana";for(e in c.freqCounts)this.ctx.fillText(e+": "+c.freqCounts[e],a,b,90),b+=16}else for(d=16*this.overBubbles.length+10,b+d>this.canvas.height&&(b-=d),this.ctx.fillRect(a,b,110,d),this.ctx.strokeRect(a,b,110,d),a+=10,b+=10,this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.font="10px Verdana",c=0;c<this.overBubbles.length;c++)e=
this.overBubbles[c],this.ctx.fillText(e.label+": "+e.freq,a,b,90),b+=16;null==this.clearToolTipId&&(this.clearToolTipId=setTimeout(this.clearToolTip.bind(this),this.DISMISS_DELAY))}},clearToolTip:function(){this.overBubbles=[];clearTimeout(this.clearToolTipId);this.clearToolTipId=null},mouseEnterHandler:function(a){this.mouseOver=!0;this.drawGraph()},mouseLeaveHandler:function(a){this.mouseOver=!1;null!=this.intervalId&&clearInterval(this.intervalId);this.overBubbles=[];this.drawGraph()},moveHandler:function(a){this.clearToolTip();
this.overBubbles=[];var b=a.layerX-this.MAX_LABEL_WIDTH,c=a.layerY,d=.25*this.maxRadius,e=-1;this.cache.each(function(a,b,f){if(c<d)return!1;d+=a.height;if(c<d)return e=b,!1},this);if(null!=this.dragInfo)this.dragInfo.x=a.layerX,this.dragInfo.y=c,e>=this.cache.getCount()?e=this.cache.getCount()-1:0>e&&(e=c+this.maxRadius>this.canvas.height?this.cache.getCount()-1:0),this.dragInfo.newIndex=e,document.body.style.cursor="move";else if(0<=e&&e<this.cache.getCount())if(0<=b){var f=!1;b-=this.maxRadius;
var g=this.cache.get(e);if(b>=g.lineLength)this.overBubbles=[{docIndex:e,x:a.layerX+10,y:a.layerY+10}];else{b=Math.round(b/(g.lineLength/this.bubbleSpacing));var k=this.maxRadius;0<e&&(k=d-(this.cache.get(e).height-.75*this.maxRadius));k=Math.round((c-k)/this.maxRadius);var h=0,l;for(l in g.terms)if(-1!==this.termsFilter.indexOf(l)){var m=g.terms[l];m?(this.SEPARATE_LINES_FOR_TERMS&&h==k||!this.SEPARATE_LINES_FOR_TERMS)&&m.pos[b]&&0<m.pos[b].radius&&(f=!0,this.overBubbles.push({label:l,type:m,docId:g.id,
docIndex:e,xIndex:b,yIndex:k,freq:m.pos[b].freq,id:m.pos[b].id,tokenPositions:m.pos[b].tokenPositions,x:a.layerX+10,y:a.layerY+10})):this.SEPARATE_LINES_FOR_TERMS&&h--;h++}}document.body.style.cursor=f?"pointer":"auto"}else document.body.style.cursor="move";else document.body.style.cursor="auto"},mouseDownHandler:function(a){var b=a.layerX,c=a.layerY;if(b<this.MAX_LABEL_WIDTH){var d=.25*this.maxRadius,e=-1;this.cache.each(function(a,b,k){if(c<d)return!1;d+=a.height;if(c<d)return e=b,!1},this);0<=
e&&e<this.cache.getCount()&&(this.dragInfo={oldIndex:e,newIndex:e,xOffset:b-5,yOffset:5,x:b,y:c})}},mouseUpHandler:function(a){this.dragInfo=null},doDrag:function(){if(null!=this.dragInfo){for(var a={},b=0;b<this.cache.getCount();b++)b<this.dragInfo.oldIndex&&b<this.dragInfo.newIndex?a[b]=b:b<this.dragInfo.oldIndex&&b>=this.dragInfo.newIndex?a[b]=b+1:b==this.dragInfo.oldIndex?a[b]=this.dragInfo.newIndex:b>this.dragInfo.oldIndex&&b>this.dragInfo.newIndex?a[b]=b:b>this.dragInfo.oldIndex&&b<=this.dragInfo.newIndex&&
(a[b]=b-1);this.dragInfo.oldIndex=this.dragInfo.newIndex;this.cache.reorder(a);a=this.cache.get(this.dragInfo.oldIndex);this.ctx.fillStyle="rgba(128, 128, 128, 1)";this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";this.ctx.fillText(a.title,this.dragInfo.x-this.dragInfo.xOffset,this.dragInfo.y-this.dragInfo.yOffset)}},clickHandler:function(a){this.lastClickedBubbles={};if(0<this.overBubbles.length&&this.overBubbles[0].label){a=[];for(var b=[],c=[],d=0;d<this.overBubbles.length;d++){var e=
this.overBubbles[d];c.push({term:e.label,docIndex:e.docIndex,docId:e.docId,tokenPositions:e.tokenPositions});null==this.lastClickedBubbles[e.docIndex]&&(this.lastClickedBubbles[e.docIndex]={});this.lastClickedBubbles[e.docIndex][e.label]=e.id;a.push(e.docId+":"+e.label);b.push(e.tokenPositions)}b=Ext.flatten(b);b.sort();void 0!==this.externalClickHandler&&this.externalClickHandler(c)}this.overBubbles=[]},setMaxFreq:function(a){null==a&&(a=this.findMaxFreq());this.maxFreq=a},findMaxFreq:function(){var a=
{term:"",value:0};this.cache.each(function(b){for(var c in b.terms){var d=b.terms[c].maxDistribution;d>a.value&&(a={term:c,value:d})}},this);return a},getNewColor:function(){for(var a=null,b=0;b<this.colors.length&&(a=this.colors[b],-1!=this.typeStore.findExact("color",a));b++)a=null;null==a&&(a=[128,128,128]);return a},removeAllTerms:function(){this.cache.each(function(a){a.terms={}},this);this.currentTerms={};this.termsFilter=[]},removeTerm:function(a){delete this.currentTerms[a];var b=!1;this.cache.each(function(c){for(var d in c.terms)d==
a&&(this.maxFreq.term==a&&(this.maxFreq={term:null,value:0},b=!0),delete c.terms[d])},this);for(var c in this.lastClickedBubbles){var d=this.lastClickedBubbles[c],e;for(e in d)e==a&&delete this.lastClickedBubbles[c][e]}b&&(this.setMaxFreq(),this.calculateBubbleRadii(),this.drawGraph())},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Knots(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.MAX_LINE_LENGTH=0;this.LINE_SIZE=2.5;this.progressiveDraw=!0;this.progDrawDone=!1;this.drawStep=0;this.mouseOver=!1;this.refreshInterval=100;this.forceRedraw=!1;this.lastDrawTime=(new Date).getTime();this.intervalId=null;this.startAngle=315;this.angleIncrement=15;this.ctx=this.canvas=null;this.currentDoc={terms:{},lineLength:void 0};this.maxDocLength=0;this.offset={x:0,y:0};this.termsFilter=[];this.initialized=
!1;this.audio=a.audio;this.audioCtx=null}
Knots.prototype={constructor:Knots,initializeCanvas:function(){var a=this.container,b=a.getHeight()-5,c=a.getWidth();this.MAX_LINE_LENGTH=Math.sqrt(c*c+b*b);var d=Ext.id("knots");a.add({xtype:"container",width:c,height:b,html:'\x3ccanvas id\x3d"'+d+'" width\x3d"'+c+'" height\x3d"'+b+'"\x3e\x3c/canvas\x3e',border:!1,listeners:{afterrender:{fn:function(a){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),!1);
this.canvas.addEventListener("mousedown",this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doLayout:function(){if(this.initialized){var a=this.container.getWidth(),b=this.container.getHeight()-5;this.canvas.width=a;this.canvas.height=b;this.recache();this.buildGraph()}},buildGraph:function(a){null!=this.intervalId&&
(this.progDrawDone=!1,clearInterval(this.intervalId));this.forceRedraw=!0;this.drawStep=a||0;for(var b in this.currentDoc.terms)this.currentDoc.terms[b].done=!1;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50):this.doDraw(!1)},drawGraph:function(a){null!=this.intervalId&&(this.progDrawDone=!1,clearInterval(this.intervalId));this.forceRedraw=!0;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[a]),50):this.doDraw(!1,a)},doDraw:function(a){var b=
(new Date).getTime();if(this.forceRedraw||b-this.lastDrawTime>=this.refreshInterval)if(this.forceRedraw=!1,this.clearCanvas(),this.ctx.save(),this.ctx.translate(this.offset.x,this.offset.y),this.drawDocument(this.currentDoc),this.originOpacity=.5,this.originColor="128,128,128",this.ctx.lineWidth=15*Math.abs(this.originOpacity-1),this.ctx.fillStyle="rgba("+this.originColor+",1.0)",this.ctx.strokeStyle="rgba("+this.originColor+","+this.originOpacity+")",this.ctx.beginPath(),this.ctx.arc(0,0,2*this.LINE_SIZE,
0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),a||this.ctx.stroke(),this.ctx.restore(),this.ctx.lineWidth=1,!0===a&&this.drawLegend(),this.lastDrawTime=(new Date).getTime(),this.progressiveDraw){a=!0;for(var c in this.currentDoc.terms)a=a&&this.currentDoc.terms[c].done;(this.progDrawDone=a)?(clearInterval(this.intervalId),this.intervalId=null,this.muteTerms()):this.drawStep++}},setAudio:function(a){(this.audio=a)||this.muteTerms()},muteTerms:function(){for(t in this.currentDoc.terms)this.currentDoc.terms[t].audio&&
(this.currentDoc.terms[t].audio.gainNode.gain.value=0)},drawDocument:function(a){a=a.terms;for(var b in a)if(-1!=this.termsFilter.indexOf(b)){var c=a[b];if(c&&c.pos){var d=[[0,0],[0,0]];if(this.progressiveDraw){var e=this.drawStep+1;c.pos.length<=this.drawStep?(c.done=!0,e=c.pos.length,c.audio&&(c.audio.gainNode.gain.value=0)):(this.audio&&c.audio&&(c.audio.gainNode.gain.value=.1,setTimeout(function(){c.audio.gainNode.gain.value=0},.75*this.refreshInterval)),c.done=!1);for(var f=0;f<e;f++){var g=
c.pos[f];this.drawPolygon(g,d,c.color);d=[[g.polygon[0][3],g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}}else for(f=0;f<c.pos.length;f++)g=c.pos[f],this.drawPolygon(g,d,c.color),d=[[g.polygon[0][3],g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}}},drawPolygon:function(a,b,c){var d=a.polygon[0],e=a.polygon[1];this.ctx.beginPath();this.ctx.moveTo(b[0][0],b[0][1]);this.ctx.lineTo(d[0],e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(b[1][0],b[1][1]);this.ctx.closePath();this.ctx.fillStyle=
"rgba("+c+", 0.6)";this.ctx.fill();this.ctx.beginPath();this.ctx.moveTo(d[0],e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(d[2],e[2]);this.ctx.lineTo(d[3],e[3]);this.ctx.closePath();a.over&&(this.ctx.fillStyle="rgba("+c+", 1.0)");this.ctx.fill()},drawLegend:function(){var a=5;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.termStore.each(function(b){var c=b.get("color");this.ctx.fillStyle="rgb("+c+")";b=b.get("term");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},
this)},setCurrentDoc:function(a){this.currentDoc=a;this.cacheCurrentDocument()},addTerms:function(a){Ext.apply(this.currentDoc.terms,a);this.recache()},removeTerm:function(a){this.currentDoc.terms[a].audio&&this.currentDoc.terms[a].audio.oscillator.stop();delete this.currentDoc.terms[a];this.recache()},removeAllTerms:function(){for(term in this.currentDoc.terms)this.currentDoc.terms[term].audio&&this.currentDoc.terms[term].audio.oscillator.stop();this.currentDoc.terms={};this.recache()},recache:function(){this.MAX_LINE_LENGTH=
Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height);this.cacheCurrentDocument();this.determineGraphSizeAndPosition()},cacheCurrentDocument:function(){var a=this.MAX_LINE_LENGTH;this.currentDoc.lineLength=a;if(this.audio&&null==this.audioCtx)try{this.audioCtx=new (window.AudioContext||window.webkitAudioContext)}catch(e){}for(var b in this.currentDoc.terms){if(this.audio&&this.audioCtx&&!this.currentDoc.terms[b].audio){var c=this.audioCtx.createOscillator(),d=this.audioCtx.createGain();
c.connect(d);d.connect(this.audioCtx.destination);c.frequency.value=500*Math.random()+150;c.start();d.gain.value=0;this.currentDoc.terms[b].audio={oscillator:c,gainNode:d}}this.cacheTurns(this.currentDoc.terms[b],a)}},cacheTurns:function(a,b){if(0<a.rawFreq){var c=this.currentDoc,d=a.term,e=[];a=a.positions;for(var f=a[a.length-1],g=this.startAngle,k=this.angleIncrement,h,l,m=0,n=0,p=h=0;p<a.length;p++){var r=a[p],q=r/f*b,u=q-h;h=m;l=n;n=this.findEndPoint([m,n],u,g);m=n[0];n=n[1];h=this.getPolygonFromLine([h,
l],[m,n],g,this.LINE_SIZE);e.push({tokenId:r,polygon:h,over:!1});h=q;g+=k}c.terms[d].pos=e;c.terms[d].done=!1}},findEndPoint:function(a,b,c){c=this.degreesToRadians(c);return[a[0]+b*Math.cos(c),a[1]+b*Math.sin(c)]},determineGraphSizeAndPosition:function(){var a=this.findBoundingBoxForGraph(),b=a.maxX-a.minX,c=a.maxY-a.minY,d=Math.min(this.canvas.width/b,this.canvas.height/c);d-=.05;this.offset.x=Math.abs(a.minX*d-(this.canvas.width/2-b*d/2));this.offset.y=Math.abs(a.minY*d-(this.canvas.height/2-c*
d/2));this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*this.canvas.height)*d;this.cacheCurrentDocument()},findBoundingBoxForGraph:function(){var a=null,b=null,c=null,d=null,e;for(e in this.currentDoc.terms)for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var k=f[g].polygon;k=this.getBoundingBox(k[0],k[1]);if(null==a||k[0]<a)a=k[0];if(null==b||k[2]>b)b=k[2];if(null==c||k[1]<c)c=k[1];if(null==d||k[3]>d)d=k[3]}return{minX:a,minY:c,maxX:b,maxY:d}},getBoundingBox:function(a,
b){return[Math.min(a[0],a[2]),Math.min(b[0],b[2]),Math.max(a[0],a[2]),Math.max(b[0],b[2])]},degreesToRadians:function(a){return Math.PI/180*a},clickHandler:function(a){var b=a.layerX-this.offset.x;a=a.layerY-this.offset.y;var c=null,d=0,e;for(e in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(e))for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var k=f[g].polygon;if(this.isPointInPolygon(k[0],k[1],b,a)){c=e;d=f[g].tokenId;break}}c&&void 0!==this.externalClickHandler&&this.externalClickHandler({term:c,
tokenId:d})},moveHandler:function(a){var b=a.layerX-this.offset.x,c=a.layerY-this.offset.y;if(null!=this.dragInfo)document.body.style.cursor="move",this.dragInfo.lastX=this.dragInfo.x,this.dragInfo.lastY=this.dragInfo.y,this.dragInfo.x=a.layerX,this.dragInfo.y=a.layerY,b=this.dragInfo.y-this.dragInfo.lastY,this.offset.x+=this.dragInfo.x-this.dragInfo.lastX,this.offset.y+=b;else{this.mouseOver=!1;for(var d in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(d)){a=this.currentDoc.terms[d].pos;
for(var e=0;e<a.length;e++)if(this.mouseOver)this.currentDoc.terms[d].pos[e].over=!1;else{var f=a[e].polygon;this.isPointInPolygon(f[0],f[1],b,c)?this.mouseOver=this.currentDoc.terms[d].pos[e].over=!0:this.currentDoc.terms[d].pos[e].over=!1}}if(this.mouseOver){if(document.body.style.cursor="pointer",!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50)}else if(document.body.style.cursor="auto",
!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),this.doDraw(!1)}},mouseDownHandler:function(a){var b=a.layerX;a=a.layerY;this.dragInfo={lastX:b,lastY:a,x:b,y:a}},mouseUpHandler:function(a){this.dragInfo=null},getPolygonFromLine:function(a,b,c,d){var e=c+90,f=c-90;c=this.findEndPoint(a,d,e);a=this.findEndPoint(a,d,f);f=this.findEndPoint(b,d,f);b=this.findEndPoint(b,d,e);return[[c[0],a[0],f[0],b[0]],[c[1],a[1],f[1],b[1]]]},isPointInPolygon:function(a,b,
c,d){var e,f=3,g=!1;for(e=0;4>e;e++)(b[e]<d&&b[f]>=d||b[f]<d&&b[e]>=d)&&a[e]+(d-b[e])/(b[f]-b[e])*(a[f]-a[e])<c&&(g=!g),f=e;return g},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Cirrus(a){function b(a){a="#"==a.charAt(0)?a.substring(1,7):a;var b=[];b.push(parseInt(a.substring(0,2),16));b.push(parseInt(a.substring(2,4),16));b.push(parseInt(a.substring(4,6),16));return b}var c=this;this.config=a;var d=Ext.id(null,"cirrusCanvas");if(null==this.config.containerId)alert("You must provide a valid container ID!");else{var e="#"+this.config.containerId,f=null,g=null;this.clear=function(){this.canvas.width=this.canvas.width};this.addWords=function(a){f.addWords(a)};this.arrangeWords=
function(){f.arrangeWords()};this.clearAll=function(){f.setWords([]);f.grid=[];this.clear()};this.resizeWords=function(){c.setCanvasDimensions();f.resetWordCoordinates();f.calculateSizeAdjustment();f.resizeWords();f.arrangeWords();g=null};this.setCanvasDimensions=function(){var a=$(e)[0],b=Math.max(a.offsetHeight,a.clientHeight);this.canvas.width=Math.max(a.offsetWidth,a.clientWidth);this.canvas.height=b};$(document).ready(function(){if(0==$("#"+c.config.containerId).length)alert("You must provide a valid container ID!");
else{c.canvas=document.createElement("canvas");c.canvas.setAttribute("id",d);c.canvas.setAttribute("tabIndex",1);c.setCanvasDimensions();$(e).append(c.canvas);d="#"+d;c.context=c.canvas.getContext("2d");c.wordData=[];c.useFadeEffect=!0;c.colors=[[116,116,181],[139,163,83],[189,157,60],[171,75,75],[174,61,155]];f=new WordController(c);for(var a in c.config){"words"==a&&(c.wordData=c.config[a]);"layout"==a&&("circle"==c.config[a]?f.layout=f.CIRCLE:"square"==c.config[a]&&(f.layout=f.SQUARE));if("colors"==
a&&$.isArray(c.config[a])&&0<c.config[a].length){c.colors=[];for(var h in c.config[a])c.colors.push(b(c.config[a][h]))}"background"==a&&$(d).css("background-color",c.config[a]);"fade"==a&&("true"==c.config[a]?c.useFadeEffect=!0:"false"==c.config[a]&&(c.useFadeEffect=!1));"smoothness"==a&&(f.wordsToArrange=Math.max(1,Math.min(20,parseInt(c.config[a]))))}0<c.wordData.length&&(c.clear(),f.addWords(c.wordData),f.arrangeWords());$(window).resize(function(){null!=g&&clearTimeout(g);g=setTimeout(c.resizeWords,
1E3)});$(d).keypress(function(a){114==a.which&&f.arrangeWords()});$(d).click(function(a){a=f.handleWordClick(a);void 0!==a&&c.config.clickHandler&&c.config.clickHandler({term:a.text,value:a.value})});$(d).mouseover(function(a){f.startUpdates()});$(d).mouseout(function(a){f.stopUpdates()});$(d).mousemove(function(a){f.handleMouseMove(a)})}})}};function Word(a,b,c,d,e){this.relativeSize=this.rotation=this.width=this.height=0;this.mask=null;this.size=0;this.text=a;this.color=c;this.origSize=b;this.rolloverText=d;this.value=e||0;this.ty=this.tx=this.y=this.x=0;this.fontFamily="Arial";this.fontSize=12;this.alpha=1;this.isOver=this.live=!1;this.draw=function(a){a.save();a.fillStyle="rgba("+this.color[0]+","+this.color[1]+","+this.color[2]+","+this.alpha+")";a.textBaseline="alphabetic";a.font=this.fontSize+"px "+this.fontFamily;a.translate(this.x+
this.tx,this.y+this.ty);a.rotate(this.rotation);a.fillText(this.text,0,0);a.restore()}};function WordController(a){function b(a){for(var b=Math.log(10*a.relativeSize)*Math.LOG10E,c=(b+a.relativeSize)/2,d=0,e=0;e<a.text.length;e++){var f=a.text.charAt(e);d="f"==f||"i"==f||"j"==f||"l"==f||"r"==f||"t"==f?d+b/3:"m"==f||"w"==f?d+b/(4/3):d+b/1.9}return c*d}function c(){q.sort(function(a,b){return a.origSize>b.origSize?-1:a.origSize<b.origSize?1:0})}function d(){for(var a=0;a<q.length;a++){var c=q[a];var d=c;var e=f.sizeAdjustment;e*=b(d);d=(Math.sqrt(6)*Math.sqrt(6*Math.pow(d.text.length,
2)+e*d.text.length)-6*d.text.length)/(2*d.text.length);c.fontSize=d>f.minFontSize?d:f.minFontSize;c.fontFamily="Impact";d=c;g.context.save();g.context.textBaseline="alphabetic";g.context.font=d.fontSize+"px "+d.fontFamily;d.width=g.context.measureText(d.text).width;d.height=Math.ceil(1.15*g.context.measureText("m").width);g.context.restore();c.tx=0;c.ty=c.height;d=0;f.getWordOrientation()===f.MIXED&&null==c.text.match(/\s/)&&.66<Math.random()&&(d=c.height,c.height=c.width,c.width=d,0==Math.round(Math.random())?
(d=90,c.ty=0):(d=-90,c.ty=c.height,c.tx=c.width));c.size=Math.max(c.height,c.width);c.rotation=Math.PI/180*d;g.context.fillStyle=g.canvas.style.backgroundColor;g.context.fillRect(0,0,g.canvas.width,g.canvas.height);c.draw(g.context);d=g.context.getImageData(c.x,c.y,c.width,c.height);e=[];for(var k=0;k<c.width;k++){var h=Math.floor(k/f.COARSENESS)*f.COARSENESS;null==e[h]&&(e[h]={});for(var l=0;l<c.height;l++){var m=Math.floor(l/f.COARSENESS)*f.COARSENESS;var n=4*(k+l*d.width);n=[d.data[n],d.data[n+
1],d.data[n+2],d.data[n+3]];"rgb("+n[0]+", "+n[1]+", "+n[2]+")"!=g.canvas.style.backgroundColor&&(e[h][m]=!0);e[h][m]&&(l=m+f.COARSENESS)}}c.mask=e}}function e(){g.clear();for(var a=q.length;a--;){var b=q[a];b.alpha=1;b.live&&b.draw(g.context)}a=$(g.canvas);if(null!=n){a.css("cursor","pointer");g.context.save();g.context.textBaseline="alphabetic";g.context.font="12px Arial";b=g.context.measureText(n.text).width;var c=g.context.measureText(n.value).width;b=(b>c?b:c)+20;c=p+15;var d=r+25,e=a.width();
a=a.height();c+b>=e&&(c-=b);d+40>=a&&(d-=40);g.context.fillStyle="rgba(255,255,255,0.9)";g.context.strokeStyle="rgba(100,100,100,0.9)";g.context.translate(c,d);g.context.fillRect(0,0,b,40);g.context.strokeRect(0,0,b,40);g.context.fillStyle="rgba(0,0,0,0.9)";g.context.fillText(n.text+":",8,18);g.context.fillText(n.value,8,30);g.context.restore()}else a.css("cursor","default")}var f=this,g=a;this.CIRCLE=0;this.ratio=1;var k=this.CIRCLE;this.getLayout=function(){return k};this.setLayout=function(a){k=
a};this.HORIZONTAL=0;var h=this.MIXED=1;this.getWordOrientation=function(){return h};this.setWordOrientation=function(a){h=a};this.UPDATE_RATE=25;this.COARSENESS=5;this.grid=[];var l=0,m;this.doingArrange=!1;this.wordsToArrange=5;var n=null,p=0,r=0,q=[];this.getWords=function(){return q};this.setWords=function(a){q=a};this.sizeAdjustment=100;this.minFontSize=12;this.largestWordSize=0;this.smallestWordSize=1E4;var u={};this.addWords=function(a){for(var b=!1,e=0;e<a.length;e++){var k=a[e];var h=null==
k.color||""==k.color?g.colors[Math.floor(Math.random()*g.colors.length)]:k.color;var l=null==k.size||""==k.size?Math.floor(40*Math.random()):parseFloat(k.size);var m=k.word,n=k.label,v=k.value;k=!1;null==u[m]&&(u[m]=!0,l>f.largestWordSize&&(f.largestWordSize=l,k=!0),l<f.smallestWordSize&&(f.smallestWordSize=.8*l,k=!0),m=new Word(m,l,h,n,v),q.push(m));b=k||b}c();this.setRelativeSizes();this.calculateSizeAdjustment();b?this.resizeWords():d()};this.resetWordCoordinates=function(){g.clear();clearTimeout(m);
for(var a=0;a<q.length;a++){var b=q[a];b.x=0;b.y=0;b.tx=0;b.ty=0}};this.calculateSizeAdjustment=function(){this.ratio=g.canvas.width/g.canvas.height;var a=g.canvas.width*g.canvas.height;this.minFontSize=1E5>a?8:12;for(var c=0,d=0;d<q.length;d++){var e=b(q[d]);c+=e}this.sizeAdjustment=a/c};this.setRelativeSizes=function(){for(var a=0;a<q.length;a++){var b=q[a],c=this.smallestWordSize;b.relativeSize=.1+(b.origSize-c)/(this.largestWordSize-c)*.9}};this.resizeWords=function(){g.clear();d();c()};this.arrangeWords=
function(){clearTimeout(m);g.clear();this.toggleLoadingText();if(0<q.length){var a=function(a,b,c){for(var d=0;d<c.width;d+=this.COARSENESS)for(var e=0;e<c.height;e+=this.COARSENESS)c.mask[d]&&c.mask[d][e]&&(this.grid[d+a]||(this.grid[d+a]=[]),this.grid[d+a][e+b]=c)},b=function(a){a.alpha+=.25;a.draw(g.context)},c=function(b,c,d,e){a(b,c,d);d.x=b;d.y=c;d.live=!0;e&&d.draw(g.context)},d=function(a,b,c,d,e){for(var f=0;f<=d;f+=this.COARSENESS)for(var g=0;g<=c;g+=this.COARSENESS)if(e[f]&&e[f][g]&&null!=
this.grid[f+a]&&null!=this.grid[f+a][g+b])return!0;return!1},f=function(){var a=this.wordsToArrange-1,f=g.canvas.width,k=g.canvas.height,h=.5*f,n=.5*k;do{var u=q[l];if(void 0!==u){for(var p=Math.random()*Math.PI,v=.25*Math.random()*u.size,r=.5*(Math.random()-.5),C=.5*u.width,x=.5*u.height;;){var w=Math.floor((h+Math.cos(p)*v*this.ratio-C)/this.COARSENESS)*this.COARSENESS;var E=Math.floor((n+Math.sin(p)*v-x)/this.COARSENESS)*this.COARSENESS;var I=w+C>=f||E+x>=k?!0:d(w,E,u.height,u.width,u.mask);if(!I)break;
p+=r;v+=.05}c(w,E,u);if(g.useFadeEffect)for(w=u.alpha=0;w<l;w++)E=q[w],1>E.alpha&&b(E);else u.alpha=1,u.draw(g.context)}l++;if(l>=q.length){clearTimeout(m);this.doingArrange=!1;this.toggleLoadingText(!1);e();break}}while(a--)};this.grid=[];l=0;f=f.createDelegate(this);d=d.createDelegate(this);c=c.createDelegate(this);b=b.createDelegate(this);a=a.createDelegate(this);this.doingArrange=!0;m=setInterval(f,50)}else alert("Error: There are no words to arrange.")};this.toggleLoadingText=function(a){g.context.save();
g.context.fillStyle=a?"black":g.canvas.style.backgroundColor;g.context.textBaseline="top";g.context.font="10px Arial";a=g.context.measureText("Loading").width+10;g.context.fillText("Loading",g.canvas.width-a,10);g.context.restore()};this.startUpdates=function(){m=setInterval(e,f.UPDATE_RATE)};this.stopUpdates=function(){null!=n&&(n=null,e());clearTimeout(m)};this.handleMouseMove=function(a){if(!this.doingArrange){for(var b=q.length;b--;)q[b].isOver=!1;var c=$(g.canvas).offset(),d=(a.pageX-c.left)%
this.COARSENESS;b=a.pageX-c.left-d;d=(a.pageY-c.top)%this.COARSENESS;a=a.pageY-c.top-d;n=this.findWordByCoords(b,a);null!=n&&(n.isOver=!0,p=b,r=a)}};this.handleWordClick=function(a){var b=$(g.canvas).offset(),c=(a.pageX-b.left)%this.COARSENESS,d=a.pageX-b.left-c;c=(a.pageY-b.top)%this.COARSENESS;a=this.findWordByCoords(d,a.pageY-b.top-c);if(null!=a)return{text:a.text,value:a.value}};this.findWordByCoords=function(a,b){var c=null;null!=this.grid[a]&&(null!=this.grid[a][b]?c=this.grid[a][b]:null!=this.grid[a][b+
this.COARSENESS]&&(c=this.grid[a][b+this.COARSENESS]));null==c&&null!=this.grid[a+this.COARSENESS]&&(null!=this.grid[a+this.COARSENESS][b]?c=this.grid[a+this.COARSENESS][b]:null!=this.grid[a+this.COARSENESS][b+this.COARSENESS]&&(c=this.grid[a+this.COARSENESS][b+this.COARSENESS]));return c}}
Function.prototype.createDelegate=function(a,b,c){var d=this;return function(){var e=b||arguments;if(!0===c)e=Array.prototype.slice.call(arguments,0),e=e.concat(b);else if("number"==typeof c){e=Array.prototype.slice.call(arguments,0);var f=[c,0].concat(b);Array.prototype.splice.apply(e,f)}return d.apply(a||window,e)}};var doubletree={};
(function(){function a(d,f,g){if(d.children){g&&(d.info.origIDs?(d.info.ids={},c(d.info.ids,d.info.origIDs),d.info.count=Object.keys(d.info.ids).length):(d.info.origIDs={},c(d.info.origIDs,d.info.ids),d.info.origCount=Object.keys(d.info.origIDs).length));var e=Object.keys(f);g=0;for(var h=e.length;g<h;g++)delete d.info.ids[e[g]];d.info.count=Object.keys(d.info.ids).length;h=d.children.length;for(g=0;g<h;g++)e=d.children[g],b(e.info.ids,f)?d.children[g]=null:a(e,f,!1);d.children=d.children.filter(function(a){return null!=
a});d.info.continuations=d.children.length;f=d3.max(d.children.map(function(a){return a.maxChildren}));d.maxChildren=Math.max(d.children.length,f)}}function b(a,b){if(!a||!b)return!1;for(var c in a)if(!(c in b))return!1;return!0}function c(a,b){for(var c in b)a[c]=b[c]}function d(){}doubletree.DoubleTree=function(){function b(a){a.each(function(a,b){f.push(this.node())})}var f=[],g=600,k=400,h=!1,l={left:[],right:[]},m={alt:d,shift:d,click:d},n=!0,p=!0,r=doubletree.sortByStrFld("token"),q=doubletree.tokenText,
u=function(a){return doubletree.fieldText(a,"POS")},v=function(a){return"rgba(255,255,255,1)"},C=function(a){return"rgba(255,255,255,1)"},w=function(a){return"red"},E={node:{fill:"white",stroke:"steelblue","stroke-width":"1.5px"},branch:{stroke:"#aaa","stroke-width":"1.5px"}},L=!1,M=d3.dispatch("idsUpdated");M.on("idsUpdated",function(){this==A?(B.setIds(A.continuationIDs),B.updateContinuations()):this==B&&(A.setIds(B.continuationIDs),A.updateContinuations())});var z,F,A,B,J,D;b.init=function(a){d3.select(d3.selectAll(a)).call(this);
return b};b.redraw=function(){void 0!==z&&void 0!==F&&b.setupFromTries(z,F);return b};b.setupFromTries=function(d,e){z=d.getUniqRoot();F=e.getUniqRoot();var h=z.toTree(l.left),x=F.toTree(l.right);d=!0;0<Object.keys(x.pruned).length&&(a(x,x.pruned,d),a(h,x.pruned,d),d=!1);0<Object.keys(h.pruned).length&&(a(h,h.pruned,d),a(x,h.pruned,d));d={};for(var G in x.info)"continuations"!=G&&"ids"!=G&&"count"!=G&&(d[G]=x.info[G]);d["right continuations"]=x.info.continuations;d["left continuations"]=h.info.continuations;
d.ids={};c(d.ids,x.info.ids);c(d.ids,h.info.ids);d.count=Object.keys(d.ids).length;J=Object.keys(d.ids);if(x.info.origIDs||h.info.origIDs)d.origIDs={},c(d.origIDs,x.info.origIDs),c(d.origIDs,h.info.origIDs),d.origCount=Object.keys(d.origIDs).length;x.info=d;h.info=d;G=Math.max(h.maxChildren,x.maxChildren);if(isNaN(G)||0==G)return L=!1,b;p?D=d3.scaleLog().range([8,14]):(D=function(){return 14},D.domain=function(){});D.domain([Math.min(h.minCount,x.minCount),h.info.count]);var K=g-20-20,I=k-20-20;f.forEach(function(a,
b){b=d3.select(a).select("svg");null==b.node()?(b=d3.select(a).append("svg").attr("width",K+20+20).attr("height",I+20+20).attr("cursor","move").call(d3.zoom().scaleExtent([1,1]).on("zoom",function(){var b=d3.event.transform.x+K/2,c=d3.event.transform.y+I/2;d3.select(a).select("svg \x3e g").attr("transform","translate("+b+","+c+")")})),b.append("g").attr("transform","translate("+K/2+","+I/2+")")):(b.attr("width",K+20+20).attr("height",I+20+20),b.selectAll("g *").remove());A=new doubletree.Tree(b.select("g"),
g,k,h,!0,r,M,D,n,q,u,v,C,w,E);B=new doubletree.Tree(b.select("g"),g,k,x,!1,r,M,D,n,q,u,v,C,w,E)});A.handleAltPress=m.alt;B.handleAltPress=m.alt;A.handleShiftPress=m.shift;B.handleShiftPress=m.shift;A.handleClick=m.click;B.handleClick=m.click;L=!0;return b};b.setupFromArrays=function(a,c,d,e,f,g,k,l){void 0==f&&z&&(f=z.caseSensitive());void 0==g&&z&&(g=z.fieldNames());void 0==k&&z&&(k=z.fieldDelim());void 0==l&&z&&(l=z.distinguishingFieldsArray());z=new doubletree.Trie(f,g,k,l);F=new doubletree.Trie(f,
g,k,l);f=c.length;for(g=0;g<f;g++){k=e?e[g]:g;l=c[g];var m=a[g].slice(),n=d[g].slice();m.push(l);m.reverse();n.unshift(l);h?(F.addNgram(m,k),z.addNgram(n,k)):(z.addNgram(m,k),F.addNgram(n,k))}b.setupFromTries(z,F);return b};b.filteredIDs=function(){return J};b.search=function(a){A.search(a);B.search(a);a=d3.select(f[0]);var b=a.selectAll("text.foundText");if(b.empty())return 0;b=b[0].length;null!=a.selectAll("text.rtNdText.foundText").node()&&b--;return b};b.clearSearch=function(){A.clearSearch();
B.clearSearch();return b};b.updateTokenExtras=function(){A.showTokenExtras(n);B.showTokenExtras(n);var a=d3.select(f[0]).select('.tokenExtra[display\x3d"inline"]');a.empty()||"0px"==a.style("height")&&b.redraw();return b};b.visWidth=function(a){if(!arguments.length)return g;g=a;return b};b.visHeight=function(a){if(!arguments.length)return k;k=a;return b};b.prefixesOnRight=function(a){if(!arguments.length)return h;h=a;return b};b.filters=function(a){if(!arguments.length)return l;l=a;return b};b.handlers=
function(a){if(!arguments.length)return m;m=a;return b};b.showTokenExtra=function(a){if(!arguments.length)return n;n=a;return b};b.scaleLabels=function(a){if(!arguments.length)return p;p=a;return b};b.succeeded=function(){return L};b.sortFun=function(a){if(!arguments.length)return r;r=a;return b};b.nodeText=function(a){if(!arguments.length)return q;q=a;return b};b.tokenExtraText=function(a){if(!arguments.length)return u;u=a;return b};b.rectColor=function(a){if(!arguments.length)return v;v=a;return b};
b.rectBorderColor=function(a){if(!arguments.length)return C;C=a;return b};b.continuationColor=function(a){if(!arguments.length)return w;w=a;return b};b.basicStyles=function(a){if(!arguments.length)return E;Object.keys(E).forEach(function(b){b in a&&Object.keys(E[b]).forEach(function(c){c in a[b]&&(E[b][c]=a[b][c])})});return b};return b};doubletree.Tree=function(a,b,c,d,h,l,m,n,p,r,q,u,v,C,w){function e(a){a.children&&(a._children=a.children,a._children.forEach(e),a.children=null)}function f(a){a.parent&&
a.parent.children.forEach(function(b){b!=a&&e(b)})}function g(a,b){d3.event.altKey?H.handleAltPress(a,b):d3.event.shiftKey?H.handleShiftPress(a,b):(H.handleClick(a,b),a.parent&&(H.continuationIDs!=a.data.info.ids&&(H.setIds(a.data.info.ids),H.clickedNode=a.id,m.call("idsUpdated",H)),f(a),k(a,!0)))}function k(a,b){a.children?(a.children&&1==a.children.length&&k(a.children[0],!0),a._children=a.children,a.children=null):(a.children=a._children,a._children=null,a.children&&1==a.children.length&&k(a.children[0],
!1));b&&H.update(a)}function F(a){return h?-a:a}var A=p,B=u;b=b-20-20;c=c-20-20;var J=0,D;l||(l=doubletree.sortByStrFld("token"));J=0;var G=d3.tree().size([c,b]).nodeSize([40,40]),N=d3.linkHorizontal().x(function(a){return F(a.y)}).y(function(a){return a.x});a=a.append("g").attr("transform","translate(20,20)");this.readJSONTree=function(a){D=d3.hierarchy(a);D.x0=0;D.y0=0;D.children.forEach(e);this.update(D)};this.update=function(b){var c=G(D).descendants();c.forEach(function(a){var b=a.textSize;if(void 0==
b){b=0;for(var c=a.parent;null!=c;){var d=Ext.draw.TextMeasurer.measureText(c.data.name,"arial").width;b+=d;c=c.parent}a.textSize=b}a.y=25*a.depth+b});var d=a.selectAll("g.node_"+h).data(c,function(a){return a.id||(a.id=++J)}),e=d.enter().append("g").attr("class","node node_"+h).attr("cursor","pointer").attr("transform",function(a){return"translate("+F(b.y0)+","+b.x0+")"}).on("click",g);e.append("title").text(function(a){return doubletree.infoToText(a.data.info)});e.append("circle").attr("r",1E-6).style("fill",
function(a){return a._children?"#fff":w.node.fill}).style("stroke",function(a){return w.node.stroke});var f=e.append("text").attr("class",function(a){return 0==a.depth?"rtNdText":""}).attr("x",function(a){return a.children||a._children?0:h?10:-10}).attr("text-anchor",function(a){return a.parent?a.children||a._children?h?"end":"start":h?"start":"end":"middle"}).style("font-size",function(a){return n(a.data.info.count)+"pt"});f.append("tspan").attr("dy",".35em").attr("class","tokenText").text(function(a){return r(a.data.info,
1>a.depth)}).style("fill-opacity",1E-6);f.append("tspan").attr("dx",".35em").attr("class","tokenExtra").text(function(a){return q(a.data.info,1>a.depth)}).style("fill-opacity",1E-6);this.drawRects();e=e.merge(d);e.transition().duration(200).attr("transform",function(a){return"translate("+F(a.y)+","+a.x+")"});e.select("circle").attr("r",function(a){return a.children||a._children?1E-6:4.5}).style("fill",function(a){return a._children?"#fff":w.node.fill}).style("stroke-width",w.node["stroke-width"]);
e.selectAll("tspan").style("fill-opacity",1);d=d.exit().transition().duration(200).attr("transform",function(a){return"translate("+F(b.y)+","+b.x+")"}).remove();d.select("circle").attr("r",1E-6);d.selectAll("tspan").style("fill-opacity",1E-6);d=a.selectAll("path.link_"+h).data(D.links(),function(a){return a.source.id+"-"+a.target.id});d.enter().insert("path","g").attr("class","link link_"+h).attr("d",function(a){a={x:b.x0,y:b.y0};return N({source:a,target:a})}).style("fill","none").style("stroke",
w.branch.stroke).style("stroke-width",w.branch["stroke-width"]).merge(d).transition().duration(200).attr("d",N);d.exit().transition().duration(200).attr("d",function(a){a={x:b.x0,y:b.y0};return N({source:a,target:a})}).remove();c.forEach(function(a){a.x0=a.x;a.y0=a.y});this.updateContinuations()};this.drawRects=function(){var b=A?"inline":"none";a.selectAll(".tokenExtra").attr("display",b);b=a.selectAll("g.node_"+h);b.selectAll("rect").remove();b.insert("rect","text").attr("class","nodeRect").attr("height",
function(){var a=this.parentElement.getBBox().height;6>a&&(a=6.1);return a-6}).attr("y",function(a){return a.parent?-.5*this.parentElement.getBBox().height/2:-.5*this.parentElement.getBBox().height/2-2}).attr("width",function(){return this.parentElement.getBBox().width}).attr("x",function(a){var b=this.parentElement.getBBox().width;return a.parent?h?-.5*b:0:-.33333*b}).style("stroke-opacity",1).style("stroke-width",1).style("stroke",function(a){return v(a.data.info)}).style("fill",function(a){return B(a.data.info)}).style("fill-opacity",
function(a){return 1})};var H=this;this.setIds=function(a){H.continuationIDs=a};this.updateContinuations=function(){a.selectAll("g.node_"+h+" text").classed("continuation",function(a){a:{var b=H.continuationIDs||{},c;for(c in a.data.info.ids)if(c in b){a=!0;break a}a=!1}return a}).style("fill",function(a){return d3.select(this).classed("continuation")?C(a.data.info):"#444"})};this.search=function(b){a.selectAll("g.node text").classed("foundText",function(a){return b.test(r(a.data.info))})};this.clearSearch=
function(){a.selectAll("g.node text").classed("foundText",!1)};this.showTokenExtras=function(a){if(0==arguments.length)return A;A=a;this.drawRects();return this};this.setRectColor=function(a){if(0==arguments.length)return B;B=a;this.drawRects();return this};this.handleAltPress=function(){};this.handleShifttPress=function(){};this.handleClick=function(){};this.readJSONTree(d);return this};doubletree.sortByStrFld=function(a){return function(b,c){var d=void 0==b.data.info[a],e=void 0==c.data.info[a];
if(d&&e)return 0;if(d)return-1;if(e)return 1;b=b.data.info[a].join(" ").toLowerCase();c=c.data.info[a].join(" ").toLowerCase();return b<c?-1:b>c?1:0}};doubletree.sortByCount=function(){return function(a,b){return b.data.info.count-a.data.info.count}};doubletree.sortByContinuations=function(){return function(a,b){return b.data.info.continuations-a.data.info.continuations}};doubletree.filterByMinCount=function(a){return function(b){return b.count>=a}};doubletree.filterByMaxCount=function(a){return function(b){return b.count<=
a}};doubletree.filterByPOS=function(a){var b=new RegExp(a);return function(a){return a.POS&&0<a.POS.filter(function(a){return-1<a.search(b)}).length}};doubletree.fieldText=function(a,b){return a[b]};doubletree.tokenText=function(a){var b="";void 0!==a.token&&(b=a.token);return b};doubletree.infoToText=function(a){var b="",c;for(c in a)b="ids"==c||"origIDs"==c?b+(c+"\t:\t"+Object.keys(a[c]).join(",")+"\n"):b+(c+"\t:\t"+a[c]+"\n");return b}})();doubletree=doubletree||{};
(function(){doubletree.Trie=function(a,b,c,d,e){function f(a,b,c){this.id=b;this.count=c;this.info={count:c,ids:{}};if(null==a)this.item=h;else{this.item=a;this.info.ids={};this.info.ids[b]=!0;a=a.split(n);for(var d in a)this.info[m[d]]=[a[d]]}this.nodes={};this.addNgram=function(a,b,c){c||(c=1);if(0<a.length){var d=a.shift();var e=d.split(n);var g=r&&this.item==h?"":e.filter(function(a,b){return-1<p.indexOf(m[b])}).map(function(a){return l?a.toLocaleLowerCase():a}).join(n)}else g=d=k;if(g in this.nodes&&
this.nodes[g]instanceof f){var u=this.nodes[g];u.info.count+=c;u.info.ids[b]=!0;for(var q in e)g=e[q],-1==u.info[m[q]].indexOf(g)&&u.info[m[q]].push(g)}else u=new f(d,b,c),this.nodes[g]=u;d!=k&&u.addNgram(a,b,c)};this.getUniqRoot=function(){if(this.item==h){var a=Object.keys(this.nodes);if(1==a.length)return this.nodes[a[0]]}return this};this.toTree=function(a){function b(a,c,d){var e={children:[]};e.name=d.item;e.info={};for(var f in d.info)if("Object"===typeof d.info[f]){e.info[f]={};for(var k in d.info[f])e.info[f][k]=
this.info[f][k]}else e.info[f]=d.info[f];e.pruned={};for(var h in d.nodes)f=d.nodes[h],k=a[c],!k||k&&k(f.info)?(e.children.push(b(a,c+1,f)),f.pruned!={}&&g(e.pruned,f.pruned)):g(e.pruned,f.info.ids);e.info.continuations=e.children.length;0==e.children.length?(e.children=null,e.maxChildren=0,e.maxLen=e.name?e.name.length:0,e.minCount=e.info.count):(a=d3.max(e.children.map(function(a){return a.maxChildren})),e.maxChildren=Math.max(e.children.length,a),a=d3.max(e.children.map(function(a){return a.maxLen})),
e.maxLen=Math.max(a,e.name.length),e.minCount=d3.min(e.children.map(function(a){return a.minCount})));return e}a||(a=[]);var c=JSON.parse(JSON.stringify(this));return b(a,0,c)}}function g(a,b){for(var c in b)a[c]=b[c]}var k=" ",h="_root_",l=!a&&!0;b||(b=["item"]);var m=b;n||(n="\t");var n=c;p||(p=[m[0]]);var p=d,r=e;void 0==r&&(r=!0);var q=new f(h,-1,0);this.addNgram=function(a,b,c){q.addNgram(a,b,c)};this.getUniqRoot=function(){var a=new doubletree.Trie(!l,m,n,p);a.trie(q.getUniqRoot());return a};
this.toTree=function(a,b){return q.toTree(a,b)};this.serialize=function(){return JSON.stringify(this)};this.deserialize=function(a){a=JSON.parse(a);k=a.endNG();h=a.rootName();l=a.caseSensitive();m=a.fieldNames();n=a.fieldDelim();p=a.distinguishingFieldsArray();q=a.trie()};this.endNG=function(){return k};this.rootName=function(){return h};this.trie=function(a){0<arguments.length&&(q=a);return q};this.caseSensitive=function(){return!l};this.fieldNames=function(){return m};this.fieldDelim=function(){return n};
this.distinguishingFieldsArray=function(){return p}}})();function TermsRadio(a){this.parent=a.parent;this.container=a.container;this.isSliderVisible=void 0==a.showSlider?!0:a.showSlider;this.chart=null;this.absMinFreq=this.absMaxFreq=0;this.allData=[];this.continueTransition=!0;this.counterSeries=[];this.displayData=[];this.isTransitioning=this.dragged=!1;this.lastSticky=this.lastSlippery=null;this.maxFont=30;this.numDataPoints=this.minFreq=0;this.numVisPoints=5;this.overlayQueue=[];this.recordsLength=this.records=0;this.reselectTop=!1;this.sliderDragSum=
this.shiftCount=0;this.titlesArray=[];this.transitionCall="draw";this.valFraction=1;this.win=0;this.bPadding=25;this.lPadding=40;this.rPadding=20;this.tPadding=10;this.sliderHeightRatio=.1;this.sliderHeight=0;this.sliderBPadding=10;this.largestH=this.largestW=0;this.xAxisEl=void 0;this.xAxis=d3.axisBottom();this.xScale=d3.scaleLinear();this.xSliderScale=d3.scaleLinear();this.yAxisEl=void 0;this.yAxis=d3.axisLeft();this.yScale=d3.scaleLinear();this.ySliderScale=d3.scaleLinear();this.fontScale=d3.scaleLinear();
this.opacityScale=d3.scaleLinear();this.container.on("resize",this.doResize,this)}
TermsRadio.prototype={constructor:TermsRadio,loadRecords:function(a){this.initData(a);this.prepareData();for(a=this.shiftCount;0<a--;)this.displayData.shift();null!=this.chart?this.redraw():this.initializeChart()},highlightQuery:function(a,b){var c=null;"document"===this.parent.getApiParam("mode")&&(c=this.parent.getCorpus().getDocument(0).getId());a=this.buildParamsBundle({wordString:a,docId:c});b?this.manageOverlaySticky(a):this.manageOverlaySlippery(a)},highlightRecord:function(a,b){a={wordString:a.get("term"),
docId:a.get("docId")};a=this.buildParamsBundle(a);b?this.manageOverlaySticky(a):this.manageOverlaySlippery(a)},initData:function(a){this.records=a;this.recordsLength=this.records.length;this.numVisPoints=parseInt(this.parent.getApiParam("visibleBins"));this.shiftCount=parseInt(this.parent.getApiParam("position"));"document"===this.parent.getApiParam("mode")?(this.numDataPoints=this.records[0].get("distributions").length,a=parseInt(this.parent.getApiParam("bins")),this.numDataPoints!==a&&(this.numDataPoints=
a,this.loadStore())):this.numDataPoints=this.records[0].get("distributions").length;this.counterSeries=[];a=[];for(var b=this.absMaxFreq=0;b<this.numDataPoints;b++)for(var c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]>this.absMaxFreq&&(this.absMaxFreq=this.records[c].get("distributions")[b]);this.absMinFreq=this.absMaxFreq;for(b=0;b<this.numDataPoints;b++)for(c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]<=this.absMinFreq&&0!==this.records[c].get("distributions")[b]&&
(this.absMinFreq=this.records[c].get("distributions")[b]);0>this.absMinFreq&&(this.absMinFreq=0);this.minFreq=1.01*this.absMinFreq;for(b=0;b<this.numDataPoints;b++){for(c=0;c<this.recordsLength;c++){var d=this.records[c],e=d.get("distributions")[b];0<e&&a.push({freq:e,wordString:d.get("term"),counter:b,posInSeries:0,numInSeries:0,docId:d.get("docId")})}this.counterSeries.push(a);a=[]}},prepareData:function(){var a=[],b=[],c=[],d=[];this.allData=[];this.displayData=[];this.numDataPoints<this.numVisPoints&&
(this.numVisPoints=this.numDataPoints);this.shiftCount+this.numVisPoints>this.numDataPoints&&(this.shiftCount=this.numDataPoints-this.numVisPoints);for(var e=0;e<this.numDataPoints;e++){for(var f=0,g=0;g<this.counterSeries[e].length;g++){var k=0;0===f&&(b.push(this.counterSeries[e][g]),c.push({freq:this.counterSeries[e][g].freq,frequencyArray:b,numInSeries:0}),a.push(c),b=[],c=[],k=f=1);for(var h=0;h<a[e].length&&0===k;h++)this.counterSeries[e][g].freq===a[e][h].freq&&(k=a[e][h].numInSeries,this.counterSeries[e][g].posInSeries=
++k,a[e][h].numInSeries=k,a[e][h].frequencyArray.push(this.counterSeries[e][g]),k=1);0===k&&(d.push(this.counterSeries[e][g]),a[e].push({freq:this.counterSeries[e][g].freq,frequencyArray:d,numInSeries:0}),d=[])}(1>this.counterSeries[e].length||0===f)&&a.push([])}for(e=0;e<this.numDataPoints;e++)for(g=0;g<a[e].length;g++)for(++a[e][g].numInSeries,h=0;h<a[e][g].frequencyArray.length;h++)a[e][g].frequencyArray[h].numInSeries=a[e][g].numInSeries;for(e=0;e<this.numDataPoints;e++)this.allData.push({allDataInternal:a[e],
outerCounter:e});a=[];b=[];for(e=0;e<this.numVisPoints+this.shiftCount;e++){for(g=0;g<this.recordsLength;g++)this.allData[e].allDataInternal[g]&&b.push({freq:this.allData[e].allDataInternal[g].freq,inSeries:this.allData[e].allDataInternal[g].numInSeries,frequencyArray:this.allData[e].allDataInternal[g].frequencyArray,dotObject:[{counter:e,freq:this.allData[e].allDataInternal[g].freq}]});a.push(b);b=[]}for(e=0;e<this.numVisPoints+this.shiftCount;e++)this.displayData.push({displayInternal:a[e],outerCounter:e})},
manageMvtButtons:function(){this.parent.queryById("play").setPlaying(this.isTransitioning)},nextR:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.numVisPoints+
this.shiftCount,freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq}]});this.displayData.push({displayInternal:a,outerCounter:this.numVisPoints+this.shiftCount})},toggleRightCheck:function(){this.numVisPoints+this.shiftCount<this.numDataPoints?(this.continueTransition=this.isTransitioning=!0,this.manageMvtButtons(),this.nextR(),this.shiftCount=++this.shiftCount,this.manageXScale(),this.parent.setApiParams({position:this.shiftCount}),this.transitionCall="right",this.animateVis(),
this.displayData.shift()):(this.continueTransition=this.isTransitioning=!1,this.manageMvtButtons())},nextL:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.shiftCount,freq:this.allData[this.shiftCount].allDataInternal[b].freq}]});
this.displayData.unshift({displayInternal:a,outerCounter:this.shiftCount})},startScroll:function(){var a=this;a.numDataPoints>a.numVisPoints&&0===a.shiftCount&&(a.isTransitioning=!0,this.manageMvtButtons(),setTimeout(function(){a.toggleRightCheck()},3E3))},initializeChart:function(){this.initChart();this.drawXAxis();this.drawYAxis();this.drawChart();this.isSliderVisible&&(this.drawSlider(),this.drawVerticalSlider(),this.redrawSliderOverlay());this.transitionCall="draw"},redraw:function(){this.transitionCall=
"redraw";this.updateFullPath();this.redrawXAxis();this.redrawYAxis();this.redrawChart();this.isSliderVisible&&(this.redrawSlider(),this.redrawVerticalSlider(),this.redrawSliderOverlay());this.redrawChartOverlay()},initChart:function(){var a=this.container.getHeight(),b=this.container.getWidth(),c=Ext.DomHelper.append(this.container.down("div[class$\x3dinnerCt]"),'\x3csvg class\x3d"chart" width\x3d"'+b+'" height\x3d"'+a+'"\x3e\x3c/svg\x3e');this.chart=d3.select(c);this.setSliderHeight();this.largestW=
b;this.largestH=a-this.getSliderHeight();a=this.tPadding+this.getSliderHeight();this.chart.append("clipPath").attr("id","clip1").append("rect").attr("class","clipping-rectangle").attr("x",0).attr("y",a).attr("width",b).attr("height",this.largestH);this.chart.append("g").attr("class","overlay").attr("clip-path","url(#clip1)");this.setTitleLength()},doResize:function(){if(this.chart){var a=this.container.getHeight(),b=this.container.getWidth();this.setSliderHeight();this.largestH=a-this.getSliderHeight();
this.largestW=b;this.chart.attr("height",a).attr("width",b);this.setTitleLength();this.chart.select("rect[class\x3dclipping-rectangle]").attr("x",0).attr("y",this.tPadding+this.getSliderHeight()).attr("width",b).attr("height",this.largestH);this.redraw()}},drawXAxis:function(){var a=this,b=this.container.getHeight();this.container.getWidth();this.manageAllXScales();this.xAxis=d3.axisBottom(a.xScale).ticks(Math.round(a.numVisPoints)).tickFormat(function(b){var c;"document"===a.parent.getApiParam("mode")&&
(c="Segment "+(parseInt(b)+1));"corpus"===a.parent.getApiParam("mode")&&(c=b+1+". "+a.titlesArray[b]);return c});this.xAxisEl=this.chart.append("g").attr("class","axisX").attr("transform","translate(0,"+(b-this.bPadding)+")").call(this.xAxis);this.styleXAxis()},styleXAxis:function(){this.xAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.xAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges");this.xAxisEl.selectAll("path").style("fill",
"none").style("stroke","black").style("shape-rendering","crispEdges")},redrawXAxis:function(){this.chart.selectAll("g[class\x3daxisX]").remove();this.drawXAxis()},drawYAxis:function(){var a=this.container.getHeight(),b=this.container.getWidth();this.manageAllYScales();var c=d3.scaleLinear().domain([200,700]).range([5,15]),d=d3.format(".2r");this.yAxis=d3.axisLeft(this.yScale).ticks(c(a)).tickFormat(function(a){var b=Math.log(a)/Math.log(10)+1E-6;return.7>Math.abs(b-Math.floor(b))?d(a):""}).tickSize(-b+
this.rPadding+this.lPadding);this.yAxisEl=this.chart.append("g").attr("class","axisY").attr("transform","translate("+this.lPadding+",0)").call(this.yAxis);this.yAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.yAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges").style("stroke-opacity",.05);this.yAxisEl.selectAll("path").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges")},
redrawYAxis:function(){this.chart.selectAll("g[class\x3daxisY]").remove();this.drawYAxis()},drawChart:function(){var a=this;this.chart.selectAll("g[class\x3dsection]").data(a.displayData,function(a){return a.outerCounter}).enter().append("g").attr("class","section").attr("clip-path","url(#clip1)").selectAll("g").data(function(a){return a.displayInternal}).enter().append("g").attr("class","frequencies").on("mouseover",function(){d3.select(this).style("fill","red")}).on("mouseout",function(){d3.select(this).style("fill",
"black")}).selectAll("text").data(function(a){return a.frequencyArray}).enter().append("text").attr("class",function(b){return a.removeFilteredCharacters(b.wordString)}).attr("x",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/b.numInSeries*.8;b=b.counter+a.callOffset()+c+d;return a.xScale(b)}).attr("y",function(b){return a.yScale(b.freq)}).attr("text-anchor","middle").attr("transform",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/b.numInSeries*.8;c=b.counter+a.callOffset()+c+d;b=b.freq;
return"translate(0, 0) rotate(-20 "+a.xScale(c)+" "+a.yScale(b)+")"}).style("font-size",function(b){return a.fontScale(b.freq)+"px"}).style("fill-opacity",function(b){return a.opacityScale(b.freq)}).text(function(a){return a.wordString}).on("mouseover",function(b){d3.select(this).style("cursor","pointer").style("font-size",function(b){return a.fontScale(b.freq)*a.maxFont/a.fontScale(b.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("mouseout",function(b){d3.select(this).style("cursor",
"auto").style("font-size",function(b){return a.fontScale(b.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("click",function(b){b=a.buildParamsBundle(b);a.manageOverlaySticky(b)}).append("title").text(function(a){return a.wordString})},redrawChart:function(){this.chart.selectAll("g[class\x3dsection]").remove();this.drawChart()},drawVerticalSlider:function(){},redrawVerticalSlider:function(){this.chart.selectAll("rect[class\x3dminimap]").remove();this.drawVerticalSlider()},drawSlider:function(){this.container.getHeight();
var a=this.container.getWidth()-(this.rPadding+this.lPadding),b=this.lPadding,c=this.lPadding+(this.numVisPoints-1)/(this.numDataPoints-1)*a;this.chart.append("line").attr("class","slider axis").attr("x1",this.lPadding).attr("x2",this.container.getWidth()-this.rPadding).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding+this.sliderHeight).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider axis").attr("x1",
this.lPadding).attr("x2",this.lPadding).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider").attr("id","before").attr("x1",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width",
"1");this.chart.append("line").attr("class","slider").attr("id","after").attr("x1",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");b=this.chart.append("rect").attr("class","slider").attr("id","boxBefore").attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.sliderHeight).attr("width",
a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move");a=this.chart.append("rect").attr("class","slider").attr("id","boxAfter").attr("x",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y",this.tPadding).attr("height",this.sliderHeight).attr("width",a*(this.numDataPoints-this.numVisPoints-this.shiftCount+this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor",
"move");var d=this;c=d3.drag().on("drag",function(a){if(!d.isTransitioning){this.drag=!0;a=d.parent.getWidth();var b=parseInt(d3.event.dx),c,e;d.sliderDragSum+=d3.event.dx;d.chart.selectAll("#before").attr("x1",function(){c=parseInt(this.getAttribute("x1"));parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});d.chart.selectAll("#after").attr("x1",function(){e=parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});if(c+b<d.lPadding||e+b>a-d.rPadding)b=
0;d.chart.select("#boxBefore").attr("width",function(){return parseInt(this.getAttribute("width"))+b});d.chart.select("#boxAfter").attr("x",function(){return parseInt(this.getAttribute("x"))+b}).attr("width",function(){return Math.max(0,parseInt(this.getAttribute("width"))-b)});d.chart.selectAll("#before").attr("x1",function(){return parseInt(this.getAttribute("x1"))+b}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+b});d.chart.selectAll("#after").attr("x1",function(){return parseInt(this.getAttribute("x1"))+
b}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+b})}}).on("end",function(a){if(this.drag){this.drag=!1;a=d3.scaleLinear().domain([0,d.container.getWidth()-(d.lPadding+d.rPadding)]).range([0,d.numDataPoints])(d.sliderDragSum);var b,c=d.shiftCount;0<a&&(b=Math.floor(a));0>a&&(b=Math.ceil(a));d.shiftCount+=b;0>d.shiftCount&&(d.shiftCount=0);d.shiftCount>d.numDataPoints-1&&(d.shiftCount=d.numDataPoints-1);d.shiftCount!==c&&(d.sliderDragSum=0,d.parent.setApiParams({position:d.shiftCount}),
d.prepareData(),d.redraw())}});b.call(c);a.call(c)},removeSlider:function(a){this.chart.selectAll("rect[class\x3dslider]").remove();this.chart.selectAll("line[class~\x3dslider]").remove();a&&this.chart.selectAll("g[class\x3dslider]").remove()},redrawSlider:function(){this.removeSlider();this.drawSlider()},animateVis:function(){var a=this;this.parent.getApiParam("mode");this.container.getHeight();var b=this.container.getWidth(),c=this.getDuration();if("left"===this.transitionCall||"right"===this.transitionCall){this.xAxisEl.transition().duration(c).ease(d3.easeLinear).call(this.xAxis);
this.styleXAxis();this.drawChart();this.chart.selectAll(".frequencies").transition().duration(c).ease(d3.easeLinear).selectAll("text").attr("x",function(b){return a.xScale(b.counter+(.5/b.numInSeries-.5)+b.posInSeries/b.numInSeries*.8)}).attr("transform",function(b){var c=b.freq;return"translate(0, 0) rotate(-20 "+a.xScale(b.counter+(.5/b.numInSeries-.5)+b.posInSeries/b.numInSeries*.8)+" "+a.yScale(c)+")"});b-=this.rPadding+this.lPadding;var d=this.lPadding,e=this.lPadding+(this.numVisPoints-1)/(this.numDataPoints-
1)*b;this.chart.select("#before").transition().duration(c).ease(d3.easeLinear).attr("x1",b*this.shiftCount/(this.numDataPoints-1)+d).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+d).attr("y1",this.tPadding+this.getSliderHeight()).attr("y2",this.tPadding).on("end",function(){a.parent.isMasked()&&a.parent.unmask();a.continueTransition?setTimeout(function(){a.callTransition()},50):(a.isTransitioning=!1,a.manageMvtButtons())});this.chart.select("#after").transition().duration(c).ease(d3.easeLinear).attr("x1",
b*this.shiftCount/(this.numDataPoints-1)+e).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+e).attr("y1",this.tPadding+this.getSliderHeight()).attr("y2",this.tPadding);this.chart.select("#boxBefore").transition().duration(c).ease(d3.easeLinear).attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",b*this.shiftCount/(this.numDataPoints-1));this.chart.select("#boxAfter").transition().duration(c).ease(d3.easeLinear).attr("x",b*this.shiftCount/(this.numDataPoints-
1)+e).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",b*(this.numDataPoints-this.numVisPoints-this.shiftCount)/(this.numDataPoints-1))}this.redrawChartOverlay()},callTransition:function(){"left"===this.transitionCall&&this.toggleLeftCheck();"right"===this.transitionCall&&this.toggleRightCheck()},buildParamsBundle:function(a){var b=a.wordString,c={};if("document"===this.parent.getApiParam("mode")){a=a.docId;var d=this.parent.getCorpus().getDocument(a).get("totalTokens")-
1;c.tokenIdStart=parseInt(this.category*d/this.numDataPoints);c.docIdType=a+":"+b}return{params:c,type:b}},manageOverlaySlippery:function(a){for(var b=a.type,c=this.removeFilteredCharacters(a.type),d="on",e=this.overlayQueue.length;0<=--e;)c===this.overlayQueue[e].selector&&(d="off");c===this.lastSticky&&(d="off",this.lastSticky=null);"on"===d&&(c!==this.lastSlippery?(d=this.prepareFullPath(b),a={word:b,selector:c,params:a,fullPath:d.path,pathMin:d.min,pathMax:d.max,colour:"red"},null!==this.lastSlippery&&
(this.chartOverlayOff(this.lastSlippery),this.isSliderVisible&&this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null),this.chartOverlayOn(a),this.isSliderVisible&&this.sliderOverlayOn(a),this.lastSlippery=c):(this.chartOverlayOff(c),this.isSliderVisible&&this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null))},manageOverlaySticky:function(a){a=a.type;this.transitionCall="draw";this.isTermSelected(a)?this.doTermDeselect(a,!0):this.doTermSelect(a,!0)},getTermIndex:function(a){var b=
-1;a=a=this.removeFilteredCharacters(a);for(var c=this.overlayQueue.length;0<=--c;)a===this.overlayQueue[c].selector&&(b=c);return b},isTermSelected:function(a){return-1!==this.getTermIndex(a)},doTermSelect:function(a,b){var c=c=this.removeFilteredCharacters(a),d=this.parent.getApiParam("selectedWords");d.push(a);this.parent.setApiParams({selectedWords:d});d=this.parent.getApplication().getColorForTerm(a,!0);if(!0===b)b=this.parent.query("[xtype\x3dlegend]")[0],b.getStore().add({name:a,mark:d});else{b=
this.parent.query("[xtype\x3dlegend]")[0];var e=b.getStore().findRecord("name",a);null!==e&&(e.set("mark",d),b.refresh())}b=this.prepareFullPath(a);a={word:a,selector:c,params:{params:{},type:a},fullPath:b.path,pathMin:b.min,pathMax:b.max,colour:d};c===this.lastSlippery&&(this.isSliderVisible&&this.sliderOverlayOff(c),this.lastSlippery=null);this.chart.select("g[class\x3dfrequency-line-"+c.replace(/'/g,"\\'")+"]").remove();this.overlayQueue.push(a);this.chartOverlayOn(a);this.isSliderVisible&&this.sliderOverlayOn(a)},
doTermDeselect:function(a,b){var c=this.removeFilteredCharacters(a),d=this.getTermIndex(a);!0===b&&(b=this.parent.query("[xtype\x3dlegend]")[0],d=b.getStore().findExact("name",a),b.getStore().removeAt(d));a=this.parent.getApiParam("selectedWords");b=0;for(var e=a.length;b<e;b++)a[b]===c&&(a.splice(b,1),this.parent.setApiParams({selectedWords:a}));this.chartOverlayOff(c);this.overlayQueue.splice(d,1);this.isSliderVisible&&this.sliderOverlayOff(c);this.lastSticky=c},prepareFullPath:function(a){for(var b=
[],c=this.absMaxFreq,d=this.absMinFreq,e=0,f=this.allData.length;e<f;e++){for(var g=foundB=0,k=this.allData[e].allDataInternal.length;g<k;g++)for(var h=0,l=this.allData[e].allDataInternal[g].frequencyArray.length;h<l;h++)if(this.allData[e].allDataInternal[g].frequencyArray[h].wordString===a){var m=this.allData[e].allDataInternal[g].frequencyArray[h].freq;b.push({x:e,y:m});m<c&&(c=m);m>d&&(d=m);foundB=1}0===foundB&&(g=this.minFreq,b.push({x:e,y:g}),g<c&&(c=g),g>d&&(d=g))}return{path:b,min:c,max:d}},
updateFullPath:function(){for(var a=this.overlayQueue.length;0<a--;){var b=this.prepareFullPath(this.overlayQueue[a].word);this.overlayQueue[a].fullPath=b.path;this.overlayQueue[a].pathMin=b.min;this.overlayQueue[a].pathMax=b.max}},buildSliderPath:function(a){var b=this;return d3.line().x(function(a){return b.xSliderScale(a.x)}).y(function(a){return b.ySliderScale(a.y)}).curve(d3.curveNatural)(a)},sliderOverlayOn:function(a){this.transitionSliderOverlay(a);this.chart.append("g").attr("class","slider").attr("id",
"slider-line-"+a.word).append("path").attr("d",this.buildSliderPath(a.fullPath)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");this.redrawSlider()},sliderOverlayOff:function(a){this.chart.selectAll("g[id\x3dslider-line-"+a.replace(/'/g,"\\'")+"]").remove();this.transitionSliderOverlay()},redrawSliderOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.sliderOverlayOff(this.overlayQueue[a].selector),this.sliderOverlayOn(this.overlayQueue[a])},transitionSliderOverlay:function(a){this.updateYSliderScale(a||
0);for(a=this.overlayQueue.length;0<a--;)this.chart.selectAll("g#slider-line-"+this.overlayQueue[a].selector.replace(/'/g,"\\'")).select("path").transition().duration(300).ease(d3.easeLinear).attr("d",this.buildSliderPath(this.overlayQueue[a].fullPath))},preparePath:function(a){for(var b=[],c,d,e=0;3>e&&0<this.shiftCount-e;e++){for(var f=c=0;f<this.allData[this.shiftCount-(1+e)].allDataInternal.length;f++)for(var g=0;g<this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray.length;g++)this.allData[this.shiftCount-
(1+e)].allDataInternal[f].frequencyArray[g].wordString===a&&(c=this.yScale(this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray[g].freq),b.unshift({x:this.shiftCount-(1+e),y:c}),c=1);0===c&&(f=this.yScale(this.minFreq),b.unshift({x:this.shiftCount-(1+e),y:f}))}e=this.shiftCount;for(c=this.numVisPoints+this.shiftCount;e<c;e++){f=d=0;for(var k=this.allData[e].allDataInternal.length;f<k;f++){g=0;for(var h=this.allData[e].allDataInternal[f].frequencyArray.length;g<h;g++)this.allData[e].allDataInternal[f].frequencyArray[g].wordString===
a&&(d=this.yScale(this.allData[e].allDataInternal[f].frequencyArray[g].freq),b.push({x:e,y:d}),d=1)}0===d&&(f=this.yScale(this.minFreq),b.push({x:e,y:f}))}for(e=0;3>e&&this.numVisPoints+this.shiftCount+e<this.numDataPoints;e++){for(f=c=0;f<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal.length;f++)for(g=0;g<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray.length;g++)this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].wordString===
a&&(d=this.yScale(this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].freq),b.push({x:this.numVisPoints+this.shiftCount+e,y:d}),c=1);0===c&&(f=this.yScale(this.minFreq),b.push({x:this.numVisPoints+this.shiftCount+e,y:f}))}return b},chartOverlayOn:function(a){var b=this;this.chart.selectAll("g[class\x3dsection]").selectAll("g[class\x3dfrequencies]").selectAll("text[class\x3d"+a.selector.replace(/'/g,"\\'")+"]").style("fill",a.colour).style("fill-opacity",1);var c=
this.preparePath(a.word),d,e=d3.line().x(function(a){d=a.x;return b.xScale(a.x+b.callOffset())}).y(function(a){return a.y}).curve(d3.curveNatural);a=this.chart.select(".overlay").append("g").attr("class","frequency-line-"+a.selector).append("path").attr("d",e(c)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");c=this.xScale(d)-this.xScale(d+this.callOffset());"left"!==this.transitionCall&&"right"!==this.transitionCall||a.transition().duration(b.getDuration()).ease(d3.easeLinear).attr("transform",
"translate("+c+")")},chartOverlayOff:function(a){var b=this;this.chart.selectAll("text."+a.replace(/'/g,"\\'")).style("fill","black").style("fill-opacity",function(a){return b.opacityScale(a.freq)});this.chart.select("g.frequency-line-"+a.replace(/'/g,"\\'")).remove()},redrawChartOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.chartOverlayOff(this.overlayQueue[a].selector),this.chartOverlayOn(this.overlayQueue[a])},manageAllYScales:function(){this.manageFontScale();this.manageOpacityScale();
this.manageYScale();this.manageYSliderScale()},manageFontScale:function(){this.fontScale.domain([this.minFreq,this.absMaxFreq*this.valFraction]).range([10,this.maxFont])},manageOpacityScale:function(){this.opacityScale.domain([0,this.absMaxFreq*this.valFraction]).range([.4,.8])},manageYScale:function(){"linear"==this.parent.getApiParam("yAxisScale")&&(this.yScale=d3.scaleLinear());"log"==this.parent.getApiParam("yAxisScale")&&(this.yScale=d3.scaleLog());this.yScale.domain([this.minFreq,this.absMaxFreq*
this.valFraction*1.25]).rangeRound([this.container.getHeight()-this.bPadding,this.tPadding+this.getSliderHeight()])},manageYSliderScale:function(){var a=this.tPadding,b=this.tPadding+this.getSliderHeight();"linear"==this.parent.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scaleLinear());"log"==this.parent.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scaleLog());this.ySliderScale.domain([this.minFreq,this.absMaxFreq]).rangeRound([b,a])},updateYSliderScale:function(a){a=a||0;for(var b=this.minFreq,
c=0,d=this.overlayQueue.length;0<d--;)this.overlayQueue[d].pathMin<b&&(b=this.overlayQueue[d].pathMin),this.overlayQueue[d].pathMax>c&&(c=this.overlayQueue[d].pathMax);0!=a&&a.pathMin<b&&(b=a.pathMin);0!=a&&a.pathMax>c&&(c=a.pathMax);this.ySliderScale.domain([b,c])},manageAllXScales:function(){this.manageXScale();this.manageXSliderScale()},manageXScale:function(){this.xScale.domain([this.shiftCount-.5,this.numVisPoints+this.shiftCount-.5]).range([this.lPadding,this.container.getWidth()-this.rPadding])},
manageXSliderScale:function(){this.xSliderScale.domain([0,this.numDataPoints-1]).range([this.lPadding,this.container.getWidth()-this.rPadding])},getSliderHeight:function(){return this.isSliderVisible?this.sliderHeight+this.sliderBPadding:0},setSliderHeight:function(){this.sliderHeight=Math.max(10,this.container.getHeight()*this.sliderHeightRatio)},hideSlider:function(){this.isSliderVisible=!1;this.removeSlider(!0);this.doResize()},showSlider:function(){this.isSliderVisible=!0;this.doResize()},setTitleLength:function(){this.titlesArray=
[];for(var a=d3.scaleLinear().domain([350,1250]).range([10,40]),b=this.parent.getCorpus(),c=0,d=b.getDocumentsCount();c<d;c++){var e=b.getDocument(c);e=e.getShortTitle();e.length<=a(this.container.getWidth())?this.titlesArray.push(e):(e=e.substring(0,a(this.container.getWidth())-3),this.titlesArray.push(e+"..."))}},callOffset:function(){if("draw"===this.transitionCall||"redraw"===this.transitionCall)var a=0;"left"===this.transitionCall&&(a=-1);"right"===this.transitionCall&&(a=1);return a},removeFilteredCharacters:function(a){return a||
""},getDuration:function(){return this.numDataPoints*(100-this.parent.getSpeed())}};Ext.define("Voyant.util.Assignable",{transferable:["assign"],assign:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);Ext.isString(a)?window[a]=this:Voyant.application.showError("The 'assign' method expects a string argument. ("+typeof a+") "+a);return this}});Ext.define("Voyant.util.Api",{constructor:function(a){var b=[];if(!this.isApplication){var c=this.getApplication?this.getApplication():Voyant.application;if(this.mixins)for(e in this.mixins){var d=Ext.ClassManager.get(e);d&&d.api&&b.splice(0,0,d.api)}this.addParentApi(b,Ext.ClassManager.getClass(c));c.getApiParams&&b.push(c.getApiParams())}this.addParentApi(b,Ext.ClassManager.getClass(this));this.api={};b.forEach(function(a){for(e in a)this.api[e]={initial:a[e],value:a[e]}},this);b=Ext.Object.fromQueryString(document.location.search);
c=this.getXType?this.getXType():void 0;for(var e in b)this.api[e]?this.setApiParam(e,b[e]):c&&0<e.indexOf(".")&&(d=e.substring(e.indexOf(".")+1))&&d in this.api&&this.setApiParam(d,b[e]);if(a&&Ext.isObject(a.api)){for(e in a.api)this.api[e]&&this.setApiParam(e,a.api[e]);delete a.api}b.type&&"query"in this.api&&!this.getApiParam("query")&&this.setApiParam("query",b.type)},addParentApi:function(a,b){b.api&&a.splice(0,0,b.api);b.superclass&&this.addParentApi(a,b.superclass.self)},getApiParam:function(a,
b){return void 0!==this.api[a]?this.api[a].value:b},getApiParams:function(a,b){a=a||Object.keys(this.api);var c={};Ext.isString(a)&&(a=[a]);a.forEach(function(a){var d=this.getApiParam(a);if(b||!Ext.isEmpty(d))c[a]=d},this);return c},getModifiedApiParams:function(){var a={},b;for(b in this.api)this.api[b].initial!=this.api[b].value&&(a[b]=this.api[b].value);return a},setApiParams:function(a){for(var b in a)this.setApiParam(b,a[b])},setApiParam:function(a,b){this.api&&this.api[a]&&(this.api[a].value=
b)}});Ext.define("Voyant.util.Localization",{statics:{DEFAULT_LANGUAGE:"en",LANGUAGE:"en",i18n:{}},languageStore:Ext.create("Ext.data.ArrayStore",{fields:["code","language"],data:[["en","English"]]}),getLanguage:function(a){var b=this.languageStore.findRecord(2==a.length?"code":"language",a);if(b)return b.get(2==a.length?"language":"code")},localize:function(a,b){return this._localizeObject(this,a,b)},_localizeObject:function(a,b,c){var d=this._localizeClass(Ext.ClassManager.getClass(a),b,c);if(d)return d;
if(a.mixins)for(mixin in a.mixins)if(d=this._localizeClass(Ext.ClassManager.getClass(a.mixins[mixin]),b,c))return d;return a.superclass&&(d=this._localizeObject(a.superclass,b,c))?d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"},_localizeClass:function(a,b,c){if(a&&a.i18n&&a.i18n[b]){var d=!1;a.i18n[b]&&(d=a.i18n[b]);return d?d.isTemplate?d.apply(c):d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"}return!1},getLanguageToolMenu:function(){return{type:"language",tooltip:this.localize("languageTitle"),
xtype:"toolmenu",glyph:"xf1ab@FontAwesome",handler:this.showLanguageOptions,scope:this}},showLanguageOptions:function(){var a=this,b="ar bs cz en es fr he hr it ja pt sr".split(" ").map(function(a){return{text:this.localize(a),value:a}},this);b.sort(function(a,b){return a.text.localeCompare(b.text)});b.splice(0,0,{text:this.localize("autoRecommended"),value:""});(new Ext.window.Window({title:this.localize("languageTitle"),modal:!0,items:{xtype:"form",items:[{xtype:"combo",name:"lang",value:this.getApiParam("lang")||
"",queryMode:"local",editable:!1,fieldLabel:this.localize("chooseLanguage"),width:450,labelAlign:"right",labelWidth:150,displayField:"text",valueField:"value",store:{fields:["text","value"],data:b}}],buttons:[{text:this.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:this.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(b){var c=b.up("form");if(c.isDirty()){var e=a.getApplication(),f=e.getModifiedApiParams();
e.getCorpus()?f.corpus=e.getCorpus().getAliasOrId():delete f.panels;delete f.lang;c=c.getValues();c.lang&&(f.lang=c.lang);location.assign("./?"+Ext.Object.toQueryString(f))}b.up("window").close()},scope:a}]},bodyPadding:5})).show()}});Ext.define("Voyant.util.Colors",{config:{palettes:void 0,colorTermAssociations:void 0},constructor:function(a){this.setPalettes({"default":[[0,0,255],[51,197,51],[255,0,255],[121,51,255],[28,255,255],[255,174,0],[30,177,255],[182,242,58],[255,0,164],[51,102,153],[34,111,52],[155,20,104],[109,43,157],[128,130,33],[111,76,10],[119,115,165],[61,177,169],[202,135,115],[194,169,204],[181,212,228],[182,197,174],[255,197,197],[228,200,124],[197,179,159]]});this.resetColorTermAssociations();if(void 0!==d3){a=
d3.scaleOrdinal(d3.schemeCategory10).range().map(function(a){return this.hexToRgb(a)},this);var b=d3.scaleOrdinal(d3.schemeCategory20).range().map(function(a){return this.hexToRgb(a)},this),c=d3.scaleOrdinal(d3.schemeCategory20b).range().map(function(a){return this.hexToRgb(a)},this),d=d3.scaleOrdinal(d3.schemeCategory20c).range().map(function(a){return this.hexToRgb(a)},this);this.addColorPalette("d3_cat10",a);this.addColorPalette("d3_cat20a",b);this.addColorPalette("d3_cat20b",c);this.addColorPalette("d3_cat20c",
d)}a=Ext.create("Ext.chart.theme.Base").getColors().map(function(a){return this.hexToRgb(a)},this);this.addColorPalette("extjs",a)},resetColorTermAssociations:function(){this.setColorTermAssociations(new Ext.util.MixedCollection)},rgbToHex:function(a){return"#"+(16777216+(a[0]<<16)+(a[1]<<8)+a[2]).toString(16).slice(1)},hexToRgb:function(a){a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(a,c,d,e){return c+c+d+d+e+e});return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],
16),parseInt(a[2],16),parseInt(a[3],16)]:null},addColorPalette:function(a,b){this.getPalettes()[a]=b},getColorPalette:function(a,b){a=a||"default";a=this.getPalettes()[a];void 0===a&&(a=[]);if(b){b=[];for(var c=0;c<a.length;c++)b.push(this.rgbToHex(a[c]));return b}return a},getColor:function(a,b,c){a=a||"default";a=this.getPalettes()[a];b>=a.length&&(b%=a.length);return c?this.rgbToHex(a[b]):a[b]},getColorForTerm:function(a,b,c){a=a||"default";a=this.getPalettes()[a];-1!=b.indexOf(":")&&(b=b.split(":")[1]);
var d=this.getColorTermAssociations().get(b);null==d&&(d=this.getColorTermAssociations().getCount()%a.length,d=a[d],this.getColorTermAssociations().add(b,d));c&&(d=this.rgbToHex(d));return d},setColorForTerm:function(a,b){!1===Array.isArray(b)&&(b=this.hexToRgb(b));this.getColorTermAssociations().replace(a,b)}});Ext.define("Voyant.util.Deferrable",{deferredStack:[],releaseAllDeferred:function(){this.deferredStack=[]},getDeferredCount:function(){return this.deferredStack.length},getDeferred:function(a){var b=new Ext.Deferred;a&&a.transfer&&a.transfer(a,b.promise);!b.promise.show&&window.show&&(b.promise.show=show);b.promise.assign||Ext.apply(b.promise,{assign:(new Voyant.util.Assignable).assign});this.deferredStack.push(b);var c=this;b.promise.always(function(){c.deferredStack.pop()});return b},getPromiseFromDeferred:function(a){return"object"===
typeof a.promise?a.promise:a.promise()},getDeferredNestedPromise:function(a,b,c){var d=arguments.callee.caller,e=Voyant.application.getDeferred(c);a.then(function(a){e.resolve(d.apply(a,b))});return e.promise}});Ext.define("Voyant.util.DetailedError",{extend:"Ext.Error",mixins:["Voyant.util.Localization"],config:{msg:void 0,error:void 0,details:void 0},statics:{i18n:{error:"Error"}},constructor:function(a){this.setMsg(a.msg);this.setError(a.error);this.setDetails(a.details);this.callParent(arguments)},show:function(a){window.showError?showError.call(this):this.showMsg(a)},showMsg:function(a){a=a||{};Ext.applyIf(a,{message:this.getMsg()+"\x3cp class\x3d'error'\x3e\n"+this.getError()+"\u2026 \x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+
escape(this.getDetails())+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/p\x3e",title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)}});Ext.define("Voyant.util.ResponseError",{extend:"Voyant.util.DetailedError",config:{response:void 0},constructor:function(a){this.setResponse(a.response);Ext.applyIf(a,{msg:a.response.statusText,error:"responseText"in a.response?a.response.responseText.split(/(\r\n|\r|\n)/).shift():"",details:"responseText"in a.response?a.response.responseText:""});this.callParent(arguments)}});Ext.define("Voyant.util.SparkLine",{getSparkLine:function(a,b){if(2>a.length)return"";var c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=!1;for(b=0;b<a.length;b++)a[b]<c&&(c=a[b]),a[b]>d&&(d=a[b]),!e&&-1<a[b].toString().indexOf(".")&&(e=!0);var f=(d-c).toString(),g=[];if(e){e=100;for(b=f.indexOf(".")+1;b<f.length;b++)if("0"==f.charAt(b))e*=10;else break;for(b=0;b<a.length;b++)g[b]=parseInt(a[b]*e);d=parseInt(d*e);c=parseInt(c*e)}else{e=1;for(b=f.length-1;-1<b;b--)if("0"==f.charAt(b))e*=10;else break;if(1!=
e){for(b=0;b<a.length;b++)g[b]=a[b]/e;d/=e;c/=e}else g=a}f=Math.floor(1800/((d.toString().length>c.toString().length?d.toString().length:c.toString().length)+1));c="http://chart.apis.google.com/chart?cht\x3dls\x26amp;chco\x3d0077CC\x26amp;chls\x3d1,0,0\x26amp;chds\x3d"+c+","+d;d=Math.ceil(a.length/f);e=0;var k="";a=5>a.length?5:10>a.length?4:20>a.length?3:50>a.length?2:1;for(b=0;b<d;b++){var h=g.slice(e,e+=f);k+="\x3cimg style\x3d'margin: 0; padding: 0;' border\x3d'0' src\x3d'"+c+"\x26amp;chs\x3d"+
a*h.length+"x15\x26amp;chd\x3dt:"+h.join(",")+"' alt\x3d'' class\x3d'chart-";1==d?k+="full":0<b&&b+1<d?k+"middle":k=0==b?k+"left":k+"right";k+="' /\x3e"}return k}});Ext.define("Voyant.util.Toolable",{requires:["Voyant.util.Localization","Voyant.util.Api"],statics:{i18n:{},api:{suppressTools:!1}},constructor:function(a){a=a||{};if(!(this.getApiParam&&"true"==this.getApiParam("suppressTools")||"header"in a&&!1===a.header)){var b=void 0,c=this.up("component");a.moreTools?(b=[],a.moreTools.forEach(function(a){a&&a!=this.xtype&&b.push(this.getMenuItemFromXtype(a))},this)):c&&c.getInitialConfig("moreTools")&&(b=[],c.getInitialConfig("moreTools").forEach(function(a){a&&
a!=this.xtype&&b.push(this.getMenuItemFromXtype(a))},this));b&&this.getApplication().getMoreTools&&b.push({xtype:"menuseparator"});if(this.getApplication().getMoreTools){b=b||[];var d=this.getApplication();c=d.getMoreTools();c.forEach(function(a){var c=[];a.items.forEach(function(a){c.push(this.getMenuItemFromXtype(a))},this);b.push({text:d.localize(a.i18n),glyph:a.glyph,menu:{items:c}})},this)}var e={save:{glyph:"xf08e@FontAwesome",fn:this.exportToolClick,items:void 0},plus:b?{glyph:"xf17a@FontAwesome",
items:b}:void 0,gear:this.showOptionsClick||this.getOptions?{glyph:"xf205@FontAwesome",fn:this.showOptionsClick?this.showOptionsClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());Ext.create("Ext.window.Window",{title:a.localize("optionsTitle"),modal:!0,panel:a,items:{xtype:"form",items:a.getOptions(),listeners:{afterrender:function(b){var c=a.getApiParams(b.getForm().getFields().collect("name"));b.getForm().setValues(c)}},buttons:[{text:a.localize("reset"),glyph:"xf0e2@FontAwesome",
flex:1,panel:a,ui:"default-toolbar",handler:function(a){this.mixins&&this.mixins["Voyant.util.Api"]&&(this.mixins["Voyant.util.Api"].constructor.apply(this),this.getCorpus&&this.getCorpus()&&this.fireEvent("loadedCorpus",this,this.getCorpus()));a.up("window").close()},scope:a},{xtype:"tbfill"},{text:a.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:a.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,panel:a,handler:function(a){function b(a,
b){d.setApiParam&&d.setApiParam(a,b);for(var c=d.getViewport().query("panel,chart"),e=0;e<c.length;e++)c[e].setApiParam&&c[e].setApiParam(a,b);f=!0}var c=a.up("form").getValues();this.setApiParams(c);var d=this.getApplication(),e=d.getCorpus(),f=!1;void 0!=c.stopList&&void 0!=c.stopListGlobal&&c.stopListGlobal&&b("stopList",c.stopList);void 0!=c.palette&&(d.resetColorTermAssociations(),b("palette",c.palette));void 0!=c.categories&&b("categories",c.categories);f&&(e?d.dispatchEvent("loadedCorpus",
this,e):d.dispatchEvent("apiParamsUpdated",this,c));e?this.fireEvent("loadedCorpus",this,e):this.fireEvent("apiParamsUpdated",this,c);a.up("window").close()},scope:a}]},bodyPadding:5}).show()}}:void 0,help:{glyph:"xf128@FontAwesome",fn:this.helpToolClick}};c=[];if(a.includeTools)for(var f in a.includeTools)"object"==typeof a.includeTools[f]&&c.push(a.includeTools[f]);for(f in e)a.includeTools&&!a.includeTools[f]||!e[f]||c.push({type:f,tooltip:this.localize(f+"Tip"),callback:e[f].fn,xtype:"toolmenu",
glyph:e[f].glyph,items:e[f].items});Ext.apply(this,{tools:c});this.on("afterrender",function(){var a=this.getHeader();if(a&&"Desktop"==Ext.os.deviceType&&!this.isXType("corpuscreator")&&!this.isXType("notebook")){var b=a.getEl();b.on("mouseover",function(){this.getHeader().getTools().forEach(function(a){a.show()})},this);b.on("mouseout",function(){this.getHeader().getTools().forEach(function(a){var b=a.config.type||a.type;b&&"help"!=b&&-1==b.indexOf("collapse")&&a.hide()})},this);a.getTools().forEach(function(a,
b){"help"!=a.config.type&&a.hide()})}},this)}},getMenuItemFromXtype:function(a){var b=this.getApplication().getToolConfigFromToolXtype(a);b&&b.tooltip&&delete b.tooltip;return Ext.apply(Ext.clone(b),{xtype:"menuitem",text:b.title,textAlign:"left",handler:function(){this.replacePanel(b.xtype)},scope:this})},maximizeToolClick:function(a){var b=Ext.getClass(a).getName().split(".");url=a.getBaseUrl()+"tool/"+b[b.length-1]+"/";params=a.getModifiedApiParams();!params.corpus&&a.getCorpus&&a.getCorpus()&&
(params.corpus=a.getCorpus().getId());params&&(url+="?"+Ext.Object.toQueryString(params));a.openUrl(url)},exportToolClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());var b="beta.voyant-tools.org"==window.location.hostname?[{html:"\x3cp class\x3d'keyword' style\x3d'text-align: center; font-weight: bold; padding: 4px;'\x3ePlease note that this is the beta server and you should not count on corpora persisting (for bookmarks, embedding, etc.)."}]:[],c=[{xtype:"radio",name:"export",inputValue:"embed",
boxLabel:a.localize("exportViewHtmlEmbed")},{xtype:"radio",name:"export",inputValue:"biblio",boxLabel:a.localize("exportViewBiblio")},{xtype:"radio",name:"export",inputValue:"spyral",boxLabel:a.localize("exportViewSpyral")}];a.getExtraExportItems&&a.getExtraExportItems().forEach(function(a){Ext.applyIf(a,{xtype:"radio",name:"export"});c.push(a)});b.push({xtype:"radio",name:"export",inputValue:"url",boxLabel:"\x3ca href\x3d'"+a.getExportUrl.call(a)+"' target\x3d'_blank'\x3e"+a.localize("exportViewUrl")+
"\x3c/a\x3e",checked:!0,listeners:{afterrender:function(){this.boxLabelEl.on("click",function(){this.up("window").close()},this)}}},{xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportViewFieldset"),items:c});if(a.isXType("grid")){var d=[{xtype:"radio",name:"export",inputValue:"gridCurrentHtml",boxLabel:a.localize("exportGridCurrentHtml")},{xtype:"radio",name:"export",inputValue:"gridCurrentTsv",boxLabel:a.localize("exportGridCurrentTsv")}];a.getExportGridAll&&0==a.getExportGridAll()||
d.push({xtype:"radio",name:"export",inputValue:"gridAllJson",boxLabel:a.localize("exportGridAllJson")},{xtype:"radio",name:"export",inputValue:"gridAllTsv",boxLabel:a.localize("exportGridAllTsv")});b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportGridCurrent"),items:d})}a.getExportVisualization&&!a.getExportVisualization()||0!=a.isXType("grid")||!(a.down("chart")||a.getTargetEl().dom.querySelector("canvas")||a.getTargetEl().dom.querySelector("svg"))||(d=[{xtype:"radio",
name:"export",inputValue:"png",boxLabel:a.localize("exportPng")},{xtype:"slider",width:200,value:1,minValue:.5,maxValue:10,increment:.5,labelAlign:"right",decimalPrecision:1,itemId:"scale",fieldLabel:(new Ext.Template(a.localize("scaleLabel"))).apply([1]),listeners:{change:function(b,c){this.setFieldLabel((new Ext.Template(a.localize("scaleLabel"))).apply([c]))},changecomplete:function(a){a.previousSibling().setValue(!0)}}}],a.getTargetEl().dom.querySelector("svg")&&d.push({xtype:"radio",name:"export",
inputValue:"svg",boxLabel:a.localize("exportSvg")}),b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportVizTitle"),items:d}));Ext.create("Ext.window.Window",{title:a.localize("exportTitle"),modal:!0,items:{xtype:"form",items:b,buttons:[{text:a.localize("exportTitle"),glyph:"xf08e@FontAwesome",flex:1,panel:a,handler:function(b){var c=b.up("form"),d="export"+Ext.String.capitalize(c.getValues()["export"]);Ext.isFunction(a[d])?a[d].call(a,a,c):Ext.Msg.show({title:a.localize("exportError"),
message:a.localize("exportNoFunction"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});b.up("window").close()},scope:a},{text:a.localize("cancelTitle"),glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}}]},bodyPadding:5}).show()},exportSvg:function(a){if(a=this.getTargetEl().dom.querySelector("svg"))a=d3.select(a).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,Ext.Msg.show({title:this.localize("exportSvgTitle"),message:'\x3cimg src\x3d"data:image/svg+xml;base64,'+
btoa(unescape(encodeURIComponent(a)))+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+this.localize("exportSvgMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:a})},exportPngData:function(a){Ext.Msg.show({title:this.localize("exportPngTitle"),message:'\x3cimg class\x3d"thumb" src\x3d"'+a+'" style\x3d"float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/\x3e'+this.localize("exportPngMessage"),buttons:Ext.Msg.OK,
icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:'\x3cimg src\x3d"'+a+'" /\x3e'})},exportPng:function(a,b){var c=1;b&&(b.mask(a.localize("loading")),(a=b.queryById("scale"))&&a.getValue&&(c=a.getValue()));var d=this.down("draw")||this.down("chart");if(d&&(d.isChart||d.isCanvas)){var e=d.innerElement.getSize();a=Array.prototype.slice.call(d.items.items);var f=d.surfaceZIndexes,g;for(g=1;g<a.length;g++){var k=a[g];var h=f[k.type];for(d=g-1;0<=d&&f[a[d].type]>h;)a[d+1]=a[d],d--;a[d+1]=k}var l=document.createElement("canvas");
f=Ext.getClassName(a[0]);c*=a[0].devicePixelRatio;var m=l.getContext("2d");l.width=Math.ceil(e.width*c);l.height=Math.ceil(e.height*c);for(d=0;d<a.length;d++)if(k=a[d],Ext.getClassName(k)===f)for(e=k.getRect(),surfaceSize=k.el.getSize(),g=0;g<k.canvases.length;g++){var n=k.canvases[g];h=n.getOffsetsTo(n.getParent());m.drawImage(n.dom,(e[0]+h[0])*c,(e[1]+h[1])*c,surfaceSize.width*c,surfaceSize.height*c)}b&&b.isVisible()&&b.unmask();return this.exportPngData(l.toDataURL())}g=this.getTargetEl().dom;
if(n=g.querySelector("canvas")){if(1==c)return c=n.toDataURL("image/png"),b&&b.isVisible()&&b.unmask(),this.exportPngData(c);l=document.createElement("canvas");m=l.getContext("2d");l.width=Math.ceil(n.width*c);l.height=Math.ceil(n.height*c);var p=new Image;p.src=n.toDataURL("image/png");p.panel=this;p.onload=function(){m.drawImage(p,0,0,l.width,l.height);r=l.toDataURL("image/png");b&&b.isVisible()&&b.unmask();this.panel.exportPngData.call(this.panel,r)}}else if(d=g.querySelector("svg")){a=g.offsetWidth*
c;g=g.offsetHeight*c;d=d.cloneNode(!0);d.setAttribute("version",1.1);d.setAttribute("xmlns","http://www.w3.org/2000/svg");d.setAttribute("transform","scale("+c+")");d.setAttribute("width",a);d.setAttribute("height",g);var r="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(d.outerHTML)));n=Ext.DomHelper.createDom({tag:"canvas",width:a,height:g});var q=n.getContext("2d");p=new Image;p.src=r;p.panel=this;p.onload=function(){q.drawImage(p,0,0);r=n.toDataURL("image/png");b&&b.isVisible()&&
b.unmask();return this.panel.exportPngData.call(this.panel,r)}}},exportUrl:function(){this.openUrl(this.getExportUrl())},exportEmbed:function(){var a=0==this.isXType("voyantheader");Ext.Msg.show({title:this.localize("exportViewEmbedTitle"),message:this.localize("exportViewEmbedMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:"\x3c!--\tExported from Voyant Tools (voyant-tools.org).\nThe iframe src attribute below uses a relative protocol to better function with both\nhttp and https sites, but if you're embedding this into a local web page (file protocol)\nyou should add an explicit protocol (https if you're using voyant-tools.org, otherwise\nit depends on this server.\nFeel free to change the height and width values or other styling below: --\x3e\n\x3ciframe style\x3d'width: "+
(a?this.getWidth()+"px":"100%")+"; height: "+(a?this.getHeight()+"px":"800px")+";' src\x3d'"+this.getExportUrl(a)+"'\x3e\x3c/iframe\x3e"})},exportBiblio:function(){var a=new Date,b=this.getExportUrl();Ext.Msg.show({title:this.localize("exportBiblioTitle"),message:'\x3cfieldset\x3e\x3clegend\x3eMLA\x3c/legend\x3e\x3cdiv class\x3d"x-selectable"\x3eSinclair, St\u00e9fan and Geoffrey Rockwell. '+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'." ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e. "+Ext.Date.format(a,
"Y")+". Web. "+Ext.Date.format(a,"j M Y")+". \x26lt;"+b+'\x26gt;.\x3c/div\x3e\x3c/fieldset\x3e\x3cbr \x3e\x3cfieldset\x3e\x3clegend\x3eChicago\x3c/legend\x3e\x3cdiv class\x3d"x-selectable"\x3eSt\u00e9fan Sinclair and Geoffrey Rockwell, '+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'", ')+"\x3ci\x3eVoyant Tools\x3c/i\x3e, accessed "+Ext.Date.format(a,"F j, Y")+", "+b+'.\x3c/div\x3e\x3c/fieldset\x3e\x3cbr \x3e\x3cfieldset\x3e\x3clegend\x3eAPA\x3c/legend\x3e\x3cdiv class\x3d"x-selectable"\x3eSinclair, S. \x26amp; G. Rockwell. ('+
Ext.Date.format(a,"Y")+"). "+(this.isXType("voyantheader")?"":this.localize("title")+". ")+"\x3ci\x3eVoyant Tools\x3c/i\x3e. Retrieved "+Ext.Date.format(a,"F j, Y")+", from "+b+"\x3c/div\x3e\x3c/fieldset\x3e",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},exportSpyral:function(){var a=Ext.getClassName(this).split(".").pop(),b=this.getApplication().getModifiedApiParams();0==this.isXType("voyantheader")&&(delete b.panels,Ext.apply(b,this.getModifiedApiParams()),delete b.corpus);var c=b&&"debug"in b;delete b.view;
delete b.debug;a='["'+btoa(encodeURIComponent("\x3ch2\x3eSpyral Notebook Imported from Voyant Tools\x3c/h2\x3e")).replace(/=/g,"%3D")+'","'+btoa(encodeURIComponent('loadCorpus("'+this.getApplication().getCorpus().getAliasOrId()+'").tool("'+("VoyantHeader"==a?"":a)+'"'+(0<Object.keys(b).length?","+Ext.encode(b):"")+");")).replace(/=/g,"%3D")+'"]';this.openUrl(this.getApplication().getBaseUrl()+"spyral/?run\x3dtrue\x26"+(c?"debug\x3dtrue\x26":"")+"inputJsonArrayOfEncodedBase64\x3d"+a)},exportGridCurrentJson:function(a,
b){function c(a){var b={};d.forEach(function(c){b[c.text]=a.get(c.dataIndex)});values.push(b)}b=a.getStore();b.getFields();var d=a.getColumnManager().headerCt.getVisibleGridColumns();values=[];b.buffered?b.data.forEach(c):b.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataJsonMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:Ext.encode(values)})},exportGridCurrentTsv:function(a,b){function c(a){cells=[];e.forEach(function(b){b=
a.get(b.dataIndex);Ext.isString(b)&&(b=b.replace(/\s+/g," "));cells.push(b)});f+=cells.join("\t")+"\n"}b=a.getStore();var d=b.getFields(),e=a.getColumnManager().headerCt.getVisibleGridColumns();d=[];e.forEach(function(a){d.push(a.text)});var f=d.join("\t")+"\n";b.buffered?b.data.forEach(c):b.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataTsvMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:f})},exportGridCurrentHtml:function(a,
b){function c(a){d+="\t\t\x3ctr\x3e\n";e.forEach(function(b){b=a.get(b.dataIndex);Ext.isString(b)&&(b=b.replace(/&/g,"\x26amp;").replace(/</g,"\x26lt;").replace(/>/g,"\x26lg;"));d+="\t\t\t\x3ctd\x3e"+b+"\x3c/td\x3e\n"});d+="\t\t\x3c/tr\x3e\n"}b=a.getStore();b.getFields();var d="\x3ctable\x3e\n\t\x3cthead\x3e\n\t\t\x3ctr\x3e\n",e=a.getColumnManager().headerCt.getVisibleGridColumns();e.forEach(function(a){d+="\t\t\t\x3ctd\x3e"+a.text+"\x3c/td\x3e\n"});d+="\t\t\x3c/tr\x3e\n\t\x3c/thead\x3e\n\t\x3ctbody\x3e\n";
b.buffered?b.data.forEach(c):b.each(c);d+="\t\x3c/tbody\x3e\n\x3c/table\x3e";Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataHtmlMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:d})},exportGridAllJson:function(a,b){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllJsonWarning"),function(b){"yes"==b&&(b={limit:0,start:0},Ext.applyIf(b,a.getStore().getProxy().getExtraParams()),this.openUrl(this.getTromboneUrl()+"?"+
Ext.Object.toQueryString(b)))},this)},exportGridAllTsv:function(a,b){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllTsvWarning"),function(b){"yes"==b&&(b={limit:0,start:0,template:this.getXType()+"2tsv"},Ext.applyIf(b,a.getStore().getProxy().getExtraParams()),this.openUrl(this.getTromboneUrl()+"?"+Ext.Object.toQueryString(b)))},this)},getExportUrl:function(a){var b=this.getApplication().getModifiedApiParams(),c=Ext.getClassName(this).split(".").pop();0==this.isXType("voyantheader")&&
(delete b.panels,Ext.apply(b,this.getModifiedApiParams()),a||(b.view=c));b.corpus||(b.corpus=this.getApplication().getCorpus().getAliasOrId());return this.getApplication().getBaseUrl()+(a?"tool/"+c+"/":"")+"?"+Ext.Object.toQueryString(b)},helpToolClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());var b=a.localize("help",{"default":!1})||a.localize("helpTip");b==a._localizeClass(Ext.ClassManager.get("Voyant.util.Toolable"),"helpTip")?a.openUrl(a.getBaseUrl()+"docs/#!/guide/"+a.getXType()):
Ext.Msg.alert(a.localize("title"),b+"\x3cp\x3e\x3ca href\x3d'"+a.getBaseUrl()+"docs/"+(a.isXType("voyantheader")?"":"#!/guide/"+a.getXType())+"' target\x3d'voyantdocs'\x3e"+a.localize("moreHelp")+"\x3c/a\x3e\x3c/p\x3e")},replacePanel:function(a){var b=this.getApplication().getCorpus();this.getInitialConfig();if(this.isXType("voyantheader")&&this.getApplication().getViewComponent){var c=this.getApplication().getViewComponent();c.removeAll(!0);c.add({xtype:a});b&&this.getApplication().dispatchEvent("loadedCorpus",
c,b);c=Ext.Object.fromQueryString(document.location.search);var d=this.getApplication().getBaseUrl();d+="?corpus\x3d"+b.getAliasOrId();d+="\x26view\x3d"+a;for(var e in c)"corpus"!==e&&"view"!==e&&(d+="\x26"+e+"\x3d"+c[e]);window.history.pushState({corpus:b.getAliasOrId(),view:a},"",d)}else c=this.isXType("voyantheader")&&this.getApplication().getViewComponent?this.getApplication().getViewComponent():this.up("component"),c.remove(this,!0),a=c.add({xtype:a}),c.isXType("voyanttabpanel")&&c.setActiveTab(a),
b&&a.fireEvent("loadedCorpus",a,b);this.getApplication().dispatchEvent("panelChange",this)}});
Ext.define("Voyant.util.ToolMenu",{extend:"Ext.panel.Tool",alias:"widget.toolmenu",renderTpl:['\x3cdiv class\x3d"x-menu-tool-hover"\x3e\x3c/div\x3e\x3ctpl if\x3d"glyph"\x3e\x3cspan id\x3d"{id}-toolEl" class\x3d"{baseCls}-glyph {childElCls}" role\x3d"presentation" style\x3d"font-family: {glyphFontFamily}; \x3ctpl if\x3d"Ext.os.name\x3d\x3d\'iOS\'"\x3emargin-right: 15px; \x3c/tpl\x3e"\x3e\x26#{glyph}\x3c/span\x3e\x3ctpl else\x3e\x3cimg id\x3d"{id}-toolEl" src\x3d"{blank}" class\x3d"{baseCls}-img {baseCls}-{type}{childElCls}" role\x3d"presentation"/\x3e\x3c/tpl\x3e'],privates:{onClick:function(){var a=
this.callParent(arguments);a&&this.items&&(this.toolMenu||(this.toolMenu=new Ext.menu.Menu({items:this.items})),this.toolMenu.showAt(0,0),this.toolMenu.showAt(this.getX()+this.getWidth()-this.toolMenu.getWidth(),this.getY()+this.getHeight()+10));return a},onDestroy:function(){Ext.destroyMembers(this,"toolMenu");this.callParent()}},initComponent:function(){this.callParent(arguments);var a=this.glyph||"xf12e@FontAwesome";if("string"===typeof a){var b=a.split("@");a=b[0];b=b[1]}else"object"===typeof a&&
a.glyphConfig&&(b=a.glyphConfig.split("@"),a=b[0],b=b[1]);Ext.applyIf(this.renderData,{baseCls:this.baseCls,blank:Ext.BLANK_IMAGE_URL,type:this.type,glyph:a,glyphFontFamily:b})}});Ext.define("Voyant.util.Transferable",{transferable:["transfer"],transfer:function(a,b){if(a.transferable)for(var c=0;c<a.transferable.length;c++){var d=a.transferable[c];b[d]=Ext.bind(a[d],b)}if(a.mixins)for(mixin in a.mixins)this.transfer(a.mixins[mixin],b)}});Ext.define("Voyant.util.Variants",{extend:"Ext.Base",constructor:function(a){this.variants=a;this.map={};this.variants.forEach(function(a,c){a.forEach(function(a){this.map[a]=c},this)},this)},getVariants:function(a){var b=[];Ext.isString(a)&&(a=[a]);Ext.isArray(a)&&a.forEach(function(a){void 0!=this.map[a]&&b.push.apply(b,this.variants[this.map[a]])},this);return b}});Ext.define("Voyant.util.Downloadable",{mixins:["Voyant.util.Localization"],statics:{i18n:{},api:{documentFormat:void 0,documentFilename:void 0}},downloadFromCorpusId:function(a){var b=this;Ext.create("Ext.window.Window",{title:this.localize("exportTitle"),modal:!0,items:{xtype:"form",items:{xtype:"downloadoptions"},listeners:{afterrender:function(a){a.getForm().setValues(b.getApiParams(["documentFilename","documentFormat"]))}},buttons:[{text:this.localize("cancelButton"),glyph:"xf00d@FontAwesome",
flex:1,ui:"default-toolbar",handler:function(a){a.up("window").close()}},{text:this.localize("downloadButton"),glyph:"xf00c@FontAwesome",flex:1,handler:function(c){var d=c.up("form").getValues();b.setApiParams(d);b.openDownloadCorpus(a);c.up("window").close()},scope:this}]},bodyPadding:5}).show()},openDownloadCorpus:function(a){a=this.getTromboneUrl()+"?corpus\x3d"+a+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip\x26zipFilename\x3dDownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?
"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(a)}});Ext.define("Voyant.util.Storage",{MAX_LENGTH:95E4,storeResource:function(a,b){var c=Ext.encode(b);if(c.length>this.MAX_LENGTH){var d=new Ext.Deferred,e=Math.ceil(c.length/this.MAX_LENGTH),f=[];for(b=0;b<e;b++)f.push(a+"-chunk"+b);this._doStore(a+"-hasChunks",Ext.encode(f)).then(function(){for(var a=0,b=0,h=0;h<e;h++){var l=c.substr(b,this.MAX_LENGTH);this._doStore(f[h],l).then(function(){a++;a==e&&d.resolve()},function(){d.reject()},null,this);b+=this.MAX_LENGTH}},function(){d.reject()},null,this);
return d.promise}return this._doStore(a,c)},_doStore:function(a,b){var c=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",resourceId:a,storeResource:b}}).then(function(a){c.resolve()},function(a){c.reject()});return c.promise},getStoredResource:function(a){var b=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:a+"-hasChunks"}}).then(function(c){(c=Ext.decode(c.responseText))&&c.storedResource&&
c.storedResource.id&&""!=c.storedResource.id?this._doGetStored(c.storedResource.id,!1).then(function(a){for(var c="",d={},g=0;g<a.length;g++)this._doGetStored(a[g],!0).then(function(e){d[e[0]]=e[1];e=!0;for(var f=a.length-1;0<=f;f--)if(void 0===d[a[f]]){e=!1;break}if(e){for(f=0;f<a.length;f++)c+=d[a[f]];b.resolve(Ext.decode(c))}},function(){b.reject()},null,this)},function(){b.reject()},null,this):this._doGetStored(a,!1).then(function(a){b.resolve(a)},function(){b.reject()},null,this)},function(){b.reject()},
null,this);return b.promise},_doGetStored:function(a,b){var c=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:a,failQuietly:!0}}).then(function(a){var d=Ext.decode(a.responseText);a=d.storedResource.id;d=d.storedResource.resource;0==d.length?c.reject():1!=b?(d=Ext.decode(d),c.resolve(d)):c.resolve([a,d])},function(){c.reject()},null,this);return c.promise}});Ext.define("Voyant.util.DiacriticsRemover",{diacriticsMap:{},constructor:function(){var a=[{base:"A",letters:"A\u24b6\uff21\u00c0\u00c1\u00c2\u1ea6\u1ea4\u1eaa\u1ea8\u00c3\u0100\u0102\u1eb0\u1eae\u1eb4\u1eb2\u0226\u01e0\u00c4\u01de\u1ea2\u00c5\u01fa\u01cd\u0200\u0202\u1ea0\u1eac\u1eb6\u1e00\u0104\u023a\u2c6f"},{base:"AA",letters:"\ua732"},{base:"AE",letters:"\u00c6\u01fc\u01e2"},{base:"AO",letters:"\ua734"},{base:"AU",letters:"\ua736"},{base:"AV",letters:"\ua738\ua73a"},{base:"AY",letters:"\ua73c"},
{base:"B",letters:"B\u24b7\uff22\u1e02\u1e04\u1e06\u0243\u0182\u0181"},{base:"C",letters:"C\u24b8\uff23\u0106\u0108\u010a\u010c\u00c7\u1e08\u0187\u023b\ua73e"},{base:"D",letters:"D\u24b9\uff24\u1e0a\u010e\u1e0c\u1e10\u1e12\u1e0e\u0110\u018b\u018a\u0189\ua779\u00d0"},{base:"DZ",letters:"\u01f1\u01c4"},{base:"Dz",letters:"\u01f2\u01c5"},{base:"E",letters:"E\u24ba\uff25\u00c8\u00c9\u00ca\u1ec0\u1ebe\u1ec4\u1ec2\u1ebc\u0112\u1e14\u1e16\u0114\u0116\u00cb\u1eba\u011a\u0204\u0206\u1eb8\u1ec6\u0228\u1e1c\u0118\u1e18\u1e1a\u0190\u018e"},
{base:"F",letters:"F\u24bb\uff26\u1e1e\u0191\ua77b"},{base:"G",letters:"G\u24bc\uff27\u01f4\u011c\u1e20\u011e\u0120\u01e6\u0122\u01e4\u0193\ua7a0\ua77d\ua77e"},{base:"H",letters:"H\u24bd\uff28\u0124\u1e22\u1e26\u021e\u1e24\u1e28\u1e2a\u0126\u2c67\u2c75\ua78d"},{base:"I",letters:"I\u24be\uff29\u00cc\u00cd\u00ce\u0128\u012a\u012c\u0130\u00cf\u1e2e\u1ec8\u01cf\u0208\u020a\u1eca\u012e\u1e2c\u0197"},{base:"J",letters:"J\u24bf\uff2a\u0134\u0248"},{base:"K",letters:"K\u24c0\uff2b\u1e30\u01e8\u1e32\u0136\u1e34\u0198\u2c69\ua740\ua742\ua744\ua7a2"},
{base:"L",letters:"L\u24c1\uff2c\u013f\u0139\u013d\u1e36\u1e38\u013b\u1e3c\u1e3a\u0141\u023d\u2c62\u2c60\ua748\ua746\ua780"},{base:"LJ",letters:"\u01c7"},{base:"Lj",letters:"\u01c8"},{base:"M",letters:"M\u24c2\uff2d\u1e3e\u1e40\u1e42\u2c6e\u019c"},{base:"N",letters:"N\u24c3\uff2e\u01f8\u0143\u00d1\u1e44\u0147\u1e46\u0145\u1e4a\u1e48\u0220\u019d\ua790\ua7a4"},{base:"NJ",letters:"\u01ca"},{base:"Nj",letters:"\u01cb"},{base:"O",letters:"O\u24c4\uff2f\u00d2\u00d3\u00d4\u1ed2\u1ed0\u1ed6\u1ed4\u00d5\u1e4c\u022c\u1e4e\u014c\u1e50\u1e52\u014e\u022e\u0230\u00d6\u022a\u1ece\u0150\u01d1\u020c\u020e\u01a0\u1edc\u1eda\u1ee0\u1ede\u1ee2\u1ecc\u1ed8\u01ea\u01ec\u00d8\u01fe\u0186\u019f\ua74a\ua74c"},
{base:"OI",letters:"\u01a2"},{base:"OO",letters:"\ua74e"},{base:"OU",letters:"\u0222"},{base:"OE",letters:"\u008c\u0152"},{base:"oe",letters:"\u009c\u0153"},{base:"P",letters:"P\u24c5\uff30\u1e54\u1e56\u01a4\u2c63\ua750\ua752\ua754"},{base:"Q",letters:"Q\u24c6\uff31\ua756\ua758\u024a"},{base:"R",letters:"R\u24c7\uff32\u0154\u1e58\u0158\u0210\u0212\u1e5a\u1e5c\u0156\u1e5e\u024c\u2c64\ua75a\ua7a6\ua782"},{base:"S",letters:"S\u24c8\uff33\u1e9e\u015a\u1e64\u015c\u1e60\u0160\u1e66\u1e62\u1e68\u0218\u015e\u2c7e\ua7a8\ua784"},
{base:"T",letters:"T\u24c9\uff34\u1e6a\u0164\u1e6c\u021a\u0162\u1e70\u1e6e\u0166\u01ac\u01ae\u023e\ua786"},{base:"TZ",letters:"\ua728"},{base:"U",letters:"U\u24ca\uff35\u00d9\u00da\u00db\u0168\u1e78\u016a\u1e7a\u016c\u00dc\u01db\u01d7\u01d5\u01d9\u1ee6\u016e\u0170\u01d3\u0214\u0216\u01af\u1eea\u1ee8\u1eee\u1eec\u1ef0\u1ee4\u1e72\u0172\u1e76\u1e74\u0244"},{base:"V",letters:"V\u24cb\uff36\u1e7c\u1e7e\u01b2\ua75e\u0245"},{base:"VY",letters:"\ua760"},{base:"W",letters:"W\u24cc\uff37\u1e80\u1e82\u0174\u1e86\u1e84\u1e88\u2c72"},
{base:"X",letters:"X\u24cd\uff38\u1e8a\u1e8c"},{base:"Y",letters:"Y\u24ce\uff39\u1ef2\u00dd\u0176\u1ef8\u0232\u1e8e\u0178\u1ef6\u1ef4\u01b3\u024e\u1efe"},{base:"Z",letters:"Z\u24cf\uff3a\u0179\u1e90\u017b\u017d\u1e92\u1e94\u01b5\u0224\u2c7f\u2c6b\ua762"},{base:"a",letters:"a\u24d0\uff41\u1e9a\u00e0\u00e1\u00e2\u1ea7\u1ea5\u1eab\u1ea9\u00e3\u0101\u0103\u1eb1\u1eaf\u1eb5\u1eb3\u0227\u01e1\u00e4\u01df\u1ea3\u00e5\u01fb\u01ce\u0201\u0203\u1ea1\u1ead\u1eb7\u1e01\u0105\u2c65\u0250"},{base:"aa",letters:"\ua733"},
{base:"ae",letters:"\u00e6\u01fd\u01e3"},{base:"ao",letters:"\ua735"},{base:"au",letters:"\ua737"},{base:"av",letters:"\ua739\ua73b"},{base:"ay",letters:"\ua73d"},{base:"b",letters:"b\u24d1\uff42\u1e03\u1e05\u1e07\u0180\u0183\u0253"},{base:"c",letters:"c\u24d2\uff43\u0107\u0109\u010b\u010d\u00e7\u1e09\u0188\u023c\ua73f\u2184"},{base:"d",letters:"d\u24d3\uff44\u1e0b\u010f\u1e0d\u1e11\u1e13\u1e0f\u0111\u018c\u0256\u0257\ua77a"},{base:"dz",letters:"\u01f3\u01c6"},{base:"e",letters:"e\u24d4\uff45\u00e8\u00e9\u00ea\u1ec1\u1ebf\u1ec5\u1ec3\u1ebd\u0113\u1e15\u1e17\u0115\u0117\u00eb\u1ebb\u011b\u0205\u0207\u1eb9\u1ec7\u0229\u1e1d\u0119\u1e19\u1e1b\u0247\u025b\u01dd"},
{base:"f",letters:"f\u24d5\uff46\u1e1f\u0192\ua77c"},{base:"g",letters:"g\u24d6\uff47\u01f5\u011d\u1e21\u011f\u0121\u01e7\u0123\u01e5\u0260\ua7a1\u1d79\ua77f"},{base:"h",letters:"h\u24d7\uff48\u0125\u1e23\u1e27\u021f\u1e25\u1e29\u1e2b\u1e96\u0127\u2c68\u2c76\u0265"},{base:"hv",letters:"\u0195"},{base:"i",letters:"i\u24d8\uff49\u00ec\u00ed\u00ee\u0129\u012b\u012d\u00ef\u1e2f\u1ec9\u01d0\u0209\u020b\u1ecb\u012f\u1e2d\u0268\u0131"},{base:"j",letters:"j\u24d9\uff4a\u0135\u01f0\u0249"},{base:"k",letters:"k\u24da\uff4b\u1e31\u01e9\u1e33\u0137\u1e35\u0199\u2c6a\ua741\ua743\ua745\ua7a3"},
{base:"l",letters:"l\u24db\uff4c\u0140\u013a\u013e\u1e37\u1e39\u013c\u1e3d\u1e3b\u017f\u0142\u019a\u026b\u2c61\ua749\ua781\ua747"},{base:"lj",letters:"\u01c9"},{base:"m",letters:"m\u24dc\uff4d\u1e3f\u1e41\u1e43\u0271\u026f"},{base:"n",letters:"n\u24dd\uff4e\u01f9\u0144\u00f1\u1e45\u0148\u1e47\u0146\u1e4b\u1e49\u019e\u0272\u0149\ua791\ua7a5"},{base:"nj",letters:"\u01cc"},{base:"o",letters:"o\u24de\uff4f\u00f2\u00f3\u00f4\u1ed3\u1ed1\u1ed7\u1ed5\u00f5\u1e4d\u022d\u1e4f\u014d\u1e51\u1e53\u014f\u022f\u0231\u00f6\u022b\u1ecf\u0151\u01d2\u020d\u020f\u01a1\u1edd\u1edb\u1ee1\u1edf\u1ee3\u1ecd\u1ed9\u01eb\u01ed\u00f8\u01ff\u0254\ua74b\ua74d\u0275"},
{base:"oi",letters:"\u01a3"},{base:"ou",letters:"\u0223"},{base:"oo",letters:"\ua74f"},{base:"p",letters:"p\u24df\uff50\u1e55\u1e57\u01a5\u1d7d\ua751\ua753\ua755"},{base:"q",letters:"q\u24e0\uff51\u024b\ua757\ua759"},{base:"r",letters:"r\u24e1\uff52\u0155\u1e59\u0159\u0211\u0213\u1e5b\u1e5d\u0157\u1e5f\u024d\u027d\ua75b\ua7a7\ua783"},{base:"s",letters:"s\u24e2\uff53\u00df\u015b\u1e65\u015d\u1e61\u0161\u1e67\u1e63\u1e69\u0219\u015f\u023f\ua7a9\ua785\u1e9b"},{base:"t",letters:"t\u24e3\uff54\u1e6b\u1e97\u0165\u1e6d\u021b\u0163\u1e71\u1e6f\u0167\u01ad\u0288\u2c66\ua787"},
{base:"tz",letters:"\ua729"},{base:"u",letters:"u\u24e4\uff55\u00f9\u00fa\u00fb\u0169\u1e79\u016b\u1e7b\u016d\u00fc\u01dc\u01d8\u01d6\u01da\u1ee7\u016f\u0171\u01d4\u0215\u0217\u01b0\u1eeb\u1ee9\u1eef\u1eed\u1ef1\u1ee5\u1e73\u0173\u1e77\u1e75\u0289"},{base:"v",letters:"v\u24e5\uff56\u1e7d\u1e7f\u028b\ua75f\u028c"},{base:"vy",letters:"\ua761"},{base:"w",letters:"w\u24e6\uff57\u1e81\u1e83\u0175\u1e87\u1e85\u1e98\u1e89\u2c73"},{base:"x",letters:"x\u24e7\uff58\u1e8b\u1e8d"},{base:"y",letters:"y\u24e8\uff59\u1ef3\u00fd\u0177\u1ef9\u0233\u1e8f\u00ff\u1ef7\u1e99\u1ef5\u01b4\u024f\u1eff"},
{base:"z",letters:"z\u24e9\uff5a\u017a\u1e91\u017c\u017e\u1e93\u1e95\u01b6\u0225\u0240\u2c6c\ua763"}];this.diacriticsMap={};for(var b=0;b<a.length;b++)for(var c=a[b].letters,d=0;d<c.length;d++)this.diacriticsMap[c[d]]=a[b].base},removeDiacritics:function(a){return a.replace(/[^\u0000-\u007E]/g,function(a){return this.diacriticsMap[a]||a}.bind(this))}});Ext.define("Voyant.notebook.util.Show",{transferable:["show"],show:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);show.call(this,this.getString?this.getString(a):this.toString(),!this.getString&&Ext.isNumber(a)?a:void 0)},statics:{show:function(a,b){var c=a;if(this.then)this.then(function(a){show.call(a,a,c)});else{if(Ext.isArray(a)){var d="";a.forEach(function(a){d+=a.getString?a.getString():a.toString()});a=d}else if(Ext.isString(this)||this instanceof
String)Ext.isNumber(a)&&(b=a),a=this;a.toHtml?a=a.toHtml():a.getString?a=a.getString():a.toString&&(a=a.toString());a.then?a.then(function(a){show(a,b)}):(b&&Ext.isNumber(b)&&(a=a.substring(0,b)),0==Voyant.notebook.util.Show.SINGLE_LINE_MODE&&(a="\x3cdiv class\x3d'"+Voyant.notebook.util.Show.MODE+"'\x3e"+a+"\x3c/div\x3e"),Voyant.notebook.util.Show.TARGET.insertHtml("beforeEnd",a))}},showError:function(a,b){var c=Voyant.notebook.util.Show.MODE;Voyant.notebook.util.Show.MODE="error";this instanceof
Voyant.util.ResponseError&&(a=this);a instanceof Voyant.util.ResponseError?(console&&console.error(a.getResponse()),b=a.getResponse().responseText,a=a.getMsg()):(a.stack&&!b&&(b=a.stack),b&&!1===Ext.isString(b)&&(b=b.toString()));console&&console.error(a);b&&(console&&console.error(b),a="\x3ch3\x3e"+a.toString()+"\x3c/h3\x3e\x3cpre\x3e"+Ext.String.htmlEncode(b)+"\x3c/pre\x3e");show(a);Voyant.notebook.util.Show.MODE=c},TARGET:null,MODE:"info",SINGLE_LINE_MODE:!1}});
var show=String.prototype.show=Voyant.notebook.util.Show.show,showError=Voyant.notebook.util.Show.showError;Ext.define("Voyant.notebook.util.Embed",{transferable:["embed"],embed:function(){embed.apply(this,arguments)},constructor:function(a){},statics:{i18n:{},api:{embeddedParameters:void 0,embeddedConfig:void 0},embed:function(a,b){if(this.then)this.then(function(c){embed.call(c,a,b)});else if(Ext.isArray(a))Voyant.notebook.util.Show.SINGLE_LINE_MODE=!0,show("\x3ctable\x3e\x3ctr\x3e"),a.forEach(function(a){show("\x3ctd\x3e");Ext.isArray(a)?a[0].embeddable?a[0].embed.apply(a[0],a.slice(1)):embed.apply(this,
a):embed.apply(this,a);show("\x3c/td\x3e")}),show("\x3c/tr\x3e\x3c/table\x3e"),Voyant.notebook.util.Show.SINGLE_LINE_MODE=!1;else{!this.embeddable||a&&!Ext.isObject(a)||(Ext.isObject(a)&&(b=a),a=this.embeddable[0]);Ext.isString(a)&&(a=Ext.ClassManager.getByAlias("widget."+a.toLowerCase())||Ext.ClassManager.get(a));var c=!1;if(Ext.isFunction(a)){var d=a.getName();this.embeddable&&!0===Ext.Array.each(this.embeddable,function(e){if(e==d){b=b||{};e={};for(key in Ext.ClassManager.get(Ext.getClassName(a)).api)key in
b&&(e[key]=b[key]);if(!e.corpus)if("Voyant.data.model.Corpus"==Ext.getClassName(this))e.corpus=this.getId();else if(this.getCorpus){var f=this.getCorpus();f&&(e.corpus=this.getCorpus().getId())}Ext.applyIf(b,{style:"width: "+(b.width||"90%")+(Ext.isNumber(b.width)?"px":"")+"; height: "+(b.height||"400px")+(Ext.isNumber(b.height)?"px":"")});delete b.width;delete b.height;f=e.corpus;delete e.corpus;Ext.applyIf(e,Voyant.application.getModifiedApiParams());e=Ext.encode(e);e=encodeURIComponent(e);var g=
Ext.id(),k=Voyant.application.getBaseUrlFull()+"tool/"+d.substring(d.lastIndexOf(".")+1)+"/?";show('\x3ciframe style\x3d"'+b.style+'" id\x3d"'+g+'" name\x3d"'+g+'"\x3e\x3c/iframe\x3e');var h=Voyant.application.getDeferred(this);Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:e}}).then(function(a){a={minimal:!0,embeddedApiId:Ext.util.JSON.decode(a.responseText).storedResource.id};f&&(a.corpus=f);Ext.applyIf(a,Voyant.application.getModifiedApiParams());
document.getElementById(g).setAttribute("src",k+Ext.Object.toQueryString(a));h.resolve()}).otherwise(function(a){showError(a);h.reject()});c=!0;return!1}},this)&&Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this);c||(Ext.create(a,b).embed(b),c=!0)}c||Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this)}},showWidgetNotRecognized:function(){var a=Voyant.notebook.util.Embed.i18n.widgetNotRecognized;this.embeddable&&(a+=Voyant.notebook.util.Embed.i18n.tryWidget+"\x3cul\x3e"+this.embeddable.map(function(a){a=
a.substring(a.lastIndexOf(".")+1).toLowerCase();return"\"\x3ca href\x3d'../../docs/#!/guide/"+a+"' target\x3d'voyantdocs'\x3e"+a+'\x3c/a\x3e"'}).join(", ")+"\x3c/ul\x3e");showError(a)}}});embed=Voyant.notebook.util.Embed.embed;Ext.define("Voyant.data.model.AnalysisToken",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"cluster",type:"int"},{name:"clusterCenter",type:"boolean"},{name:"vector"}]});Ext.define("Voyant.data.model.Context",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docIndex",type:"int"},{name:"position",type:"int"},{name:"docId"},{name:"left"},{name:"keyword"},{name:"term"},{name:"right"}],getDocIndex:function(){return this.get("docIndex")},getLeft:function(){return this.get("left")},getMiddle:function(){return this.get("middle")},getHighlightedMiddle:function(){return"\x3cspan class\x3d'keyword'\x3e"+this.getMiddle()+"\x3c/span\x3e"},getRight:function(){return this.get("right")},
getPosition:function(){return this.get("position")},getHighlightedContext:function(){return this.getLeft()+this.getHighlightedMiddle()+this.getRight()}});Ext.define("Voyant.data.model.CorpusFacet",{extend:"Ext.data.Model",idProperty:"label",fields:[{name:"facet"},{name:"label"},{name:"inDocumentsCount",type:"int"}],getLabel:function(){return this.get("label")},getFacet:function(){return this.get("facet")},getInDocumentsCount:function(){return this.get("inDocumentsCount")}});Ext.define("Voyant.data.model.CorpusCollocate",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"contextTerm"},{name:"contextTermRawFreq",type:"int"}],getTerm:function(){return this.getKeyword()},getRawFreq:function(){return this.getKeywordRawFreq()},getKeyword:function(){return this.get("term")},getKeywordRawFreq:function(){return this.get("rawFreq")},getContextTerm:function(){return this.get("contextTerm")},getContextTermRawFreq:function(){return this.get("contextTermRawFreq")}});Ext.define("Voyant.data.model.CorpusTerm",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"id"},{name:"rawFreq",type:"int"},{name:"inDocumentsCount",type:"int"},{name:"relativeFreq",type:"float"},{name:"relativePeakedness",type:"float"},{name:"relativeSkewness",type:"float"},{name:"comparisonRelativeFreqDifference",type:"float"},{name:"distributions"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}}],getTerm:function(){return this.get("term")},
getRawFreq:function(){return parseInt(this.get("rawFreq"))},getInDocumentsCount:function(){return parseInt(this.get("inDocumentsCount"))},getDistributions:function(){return this.get("distributions")},show:function(a){show(this.getString(a))},getString:function(){return this.getTerm()+": "+this.getRawFreq()}});Ext.define("Voyant.data.model.CorpusNgram",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"length",type:"int"},{name:"rawFreq",type:"int"},{name:"distributions"}],getTerm:function(){return this.get("term")}});Ext.define("Voyant.data.model.Dimension",{extend:"Ext.data.Model",fields:[{name:"percentage",type:"number"}]});Ext.define("Voyant.data.model.Document",{extend:"Ext.data.Model",fields:[{name:"corpus"},{name:"id"},{name:"pubDate"},{name:"publisher"},{name:"pubPlace"},{name:"keyword"},{name:"collection"},{name:"index",type:"int"},{name:"tokensCount-lexical",type:"int"},{name:"typesCount-lexical",type:"int"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}},{name:"lastTokenStartOffset-lexical",type:"int"},{name:"title"},{name:"language",
convert:function(a){return Ext.isEmpty(a)?"":a}},{name:"sentencesCount",type:"int"},{name:"averageWordsPerSentence",type:"float",calculate:function(a){return a.sentencesCount?a["tokensCount-lexical"]/a.sentencesCount:0}},{name:"css",type:"string"}],getLexicalTokensCount:function(){return this.get("tokensCount-lexical")},getLexicalTypeTokenRatio:function(){return this.get("typeTokenRatio-lexical")},loadDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);
var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getDocumentTerms();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens({});c.load({params:a,callback:function(a,e,
f){f?b.resolve(c):b.reject(e)}});return b.promise},getTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});Ext.apply(a,{docId:this.get("id")});return this.get("corpus").getTokens(a)},getDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});
Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});return a.corpus?a.corpus.getDocumentTerms(a):this.get("corpus").getDocumentTerms(a)},getIndex:function(){return this.get("index")},getId:function(){return this.get("id")},getFullLabel:function(){var a=this.getAuthor();return this.getTitle()+(a?"("+a+")":"")},getTitle:function(){var a=this.get("title");void 0===a&&(a="");a=Ext.isArray(a)?a.join("; "):a;return a=a.trim().replace(/\s+/g," ")},getTruncated:function(a,
b){if(a.length>b){var c=a.lastIndexOf("/");-1<c&&(a=a.substr(c+1));if(a.length>b){c=a.indexOf(" ",b-5);if(0>c||c>b)c=b;a=a.substring(0,c)+"\u2026"}}return a},getShortTitle:function(){var a=this.getTitle();a=a.replace(/\.(html?|txt|xml|docx?|pdf|rtf|\/)$/,"");a=a.replace(/^(the|a|le|l'|un|une)\s/,"");return this.getTruncated(a,25)},getTinyTitle:function(){return this.getTruncated(this.getShortTitle(),10)},getShortLabel:function(){var a=this.getAuthor(25);return parseInt(this.getIndex())+1+") \x3ci\x3e"+
this.getShortTitle()+"\x3c/i\x3e"+(a?" ("+a+")":"")},getTinyLabel:function(){return parseInt(this.getIndex())+1+") "+this.getTinyTitle()},getPubDate:function(){return this.get("pubDate")},getPublisher:function(){return this.get("publisher")},getPubPlace:function(){return this.get("pubPlace")},getKeyword:function(){return this.getMultiple("keyword")},getCollection:function(){return this.getMultiple("collection")},getAuthor:function(a){this.getMultiple("author")},getMultiple:function(a,b){a=this.get(a)||
"";a=Ext.isArray(a)?a.join("; "):a;a=a.trim().replace(/\s+/g," ");return b?this.getTruncated(author,b):a},getCorpusId:function(){return this.get("corpus").getAliasOrId()},isPlainText:function(){return this.get("extra.Content-Type")&&/plain/i.test(this.get("extra.Content-Type"))?!0:!1},getAverageWordsPerSentence:function(){return this.get("averageWordsPerSentence")},show:function(){show(this.getFullLabel())},getCorpus:function(){return this.get("corpus")},getText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.apply(a,{tool:"corpus.DocumentTokens",corpus:this.getCorpusId()});this.getTokens(a).then(function(a){b.resolve(a)});return b.promise},getPlainText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.apply(a,{outputFormat:"text",template:"docTokens2text",noOthers:!0});return this.getText()},getLemmasArray:function(a){a=a||{};a.docId=this.getId();return this.getCorpus().getLemmasArray(a)},
getEntities:function(a){a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(a,{corpus:this.getCorpus(),docId:this.getId()}))},loadEntities:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);this.getEntities().load({params:a,callback:function(a,d,e){e?b.resolve(a):b.reject(d.error.response)}});
return b.promise},getCSS:function(){return this.get("css")||this.get("parent_css")}});Ext.define("Voyant.data.model.DocumentEntity",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"docIndex",type:"int"},{name:"rawFreq",type:"int"},{name:"type"},{name:"positions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getPositions:function(){return this.get("positions")}});Ext.define("Voyant.data.model.DocumentQueryMatch",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"count",type:"int"},{name:"query"},{name:"distributions"}],getCount:function(){return this.get("count")},getDistributions:function(){return this.get("distributions")},getDocIds:function(){return this.get("docIds")}});Ext.define("Voyant.data.model.DocumentTerm",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"term"},{name:"docIndex",type:"int"},{name:"docId"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"float"},{name:"tfidf",type:"float"},{name:"zscore",type:"float"},{name:"zscoreRatio",type:"float"},{name:"distributions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getRelativeFreq:function(){return this.get("relativeFreq")},
getDistributions:function(){return this.get("distributions")}});Ext.define("Voyant.data.model.PrincipalComponent",{extend:"Ext.data.Model",fields:[{name:"eigenValue",type:"number"},{name:"eigenVectors"}]});Ext.define("Voyant.data.model.RelatedTerm",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"rawFreq",type:"int"}],getSource:function(){return this.get("source")},getTarget:function(){return this.get("target")},show:function(a){show(this.getString(a))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.model.StatisticalAnalysis",{extend:"Ext.data.Model",requires:["Voyant.data.model.PrincipalComponent","Voyant.data.model.Dimension","Voyant.data.model.AnalysisToken"],fields:[{name:"id"}],getPrincipalComponents:function(){var a=[];this.data.principalComponents.forEach(function(b){a.push(Ext.create("Voyant.data.model.PrincipalComponent",b))});return a},getDimensions:function(){var a=[];this.data.dimensions.forEach(function(b){a.push(Ext.create("Voyant.data.model.Dimension",{percentage:b}))});
return a},getTokens:function(){var a=[];this.data.tokens.forEach(function(b){a.push(Ext.create("Voyant.data.model.AnalysisToken",b))});return a}});Ext.define("Voyant.data.model.Token",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docId"},{name:"docIndex",type:"int"},{name:"token"},{name:"rawFreq"},{name:"tokenType"},{name:"position",type:"int"},{name:"startOffset",type:"int"},{name:"endOffset",type:"int"}],statics:{getInfoFromElement:function(a){if(a&&a.getId)return a=a.getId().split("_"),{docIndex:parseInt(a[1]),position:parseInt(a[2])}}},isWord:function(){return"lexical"==this.getTokenType()},isStopword:function(){return"true"==this.get("stopword")},
getTokenType:function(){return this.get("tokenType")},getId:function(){return["",this.getDocIndex(),this.getPosition()].join("_")},getDocIndex:function(){return this.get("docIndex")},getDocId:function(){return this.get("docId")},getTerm:function(){return this.get("term")},getTermWithLineSpacing:function(a){var b=this.getTerm().replace(/<\/?\w+\b.*?>/g,"\x3cbr /\x3e\x3cbr /\x3e").replace(/>\s+</g,"\x3e\x3c").replace(/<br \/><br \/>(<br \/>)+/g,"\x3cbr /\x3e\x3cbr /\x3e");a&&(b=b.replace(/(\r\n|\r|\n)\s*/g,
"\x3cbr /\x3e"));return b},getPosition:function(){return this.get("position")},getDocumentRawFreq:function(){return this.get("rawFreq")}});Ext.define("Voyant.data.model.TermCorrelation",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"correlation",type:"float"},{name:"significance",type:"float"},{name:"source-term",calculate:function(a){return a.source.term}},{name:"target-term",calculate:function(a){return a.target.term}},{name:"source-distributions",calculate:function(a){return a.source.distributions}},{name:"target-distributions",calculate:function(a){return a.target.distributions}}],getSource:function(){return this.get("source")},
getTarget:function(){return this.get("target")},show:function(a){show(this.getString(a))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.store.VoyantStore",{mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],config:{corpus:void 0,parentPanel:void 0},constructor:function(a,b){var c=this;a=a||{};Ext.applyIf(a,{remoteSort:!0,autoLoad:!1,pagePurgeCount:0,pageSize:100,leadingBufferZone:200});a.proxy=a.proxy||{};Ext.applyIf(a.proxy,{type:"ajax",url:Voyant.application.getTromboneUrl(),actionMethods:{read:"POST"},reader:{type:"json",rootProperty:b["proxy.reader.rootProperty"],totalProperty:b["proxy.reader.totalProperty"],
metaProperty:b["proxy.reader.metaProperty"]||"metaData"},simpleSortMode:!0,listeners:{exception:function(a,b,f){c.parentPanel&&c.parentPanel.showError&&c.parentPanel.showError(f)}}});a.proxy.extraParams=a.proxy.extraParams||{};Ext.applyIf(a.proxy.extraParams,{tool:b["proxy.extraParams.tool"]});void 0!==a.parentPanel&&(Ext.applyIf(a.proxy.extraParams,{forTool:a.parentPanel.xtype}),this.setParentPanel(a.parentPanel),a.parentPanel.on("loadedCorpus",function(a,b){this.setCorpus(b)},this),a.listeners=
a.listeners||{},a.listeners.beforeload={fn:function(a,b){var c=this.getParentPanel(),d=a.getProxy();if(void 0!==c){a=c.getApiParams();b=b?1===b?{}:b:{};b.params=b.params||{};d&&this.isBufferedStore&&(Ext.Array.from(this.previouslySetExtraParams).forEach(function(a){d.setExtraParam(a,void 0)}),this.previouslySetExtraParams=[]);for(var e in a)d&&this.isBufferedStore&&(this.previouslySetExtraParams.push(e),d.setExtraParam(e,a[e])),b.params[e]=a[e]}},scope:this});Ext.apply(this,a)},setCorpus:function(a){a&&
this.getProxy&&this.getProxy()&&this.getProxy().setExtraParam("corpus",Ext.isString(a)?a:a.getId());this.callParent(arguments)},getString:function(a){a=this.getCount();return"This store contains "+this.getCount()+" items"+(0<a?" with these fields: "+this.getAt(0).getFields().map(function(a){return a.getName()}).join(", "):"")+"."},embed:function(a,b){!b&&Ext.isObject(a)&&(b=a,a=this.embeddable[0]);b=b||{};var c=[];this.each(function(a){c.push(a.data)},this);Ext.apply(b,{storeJson:JSON.stringify({storeClass:Ext.getClassName(this),
storeData:c})});embed.call(this,a,b)}});Ext.define("Voyant.data.store.CAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CA","proxy.reader.rootProperty":"correspondenceAnalysis","proxy.reader.totalProperty":"correspondenceAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.CAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.ContextsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Context",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentContexts","proxy.reader.rootProperty":"documentContexts.contexts","proxy.reader.totalProperty":"documentContexts.total"}])}});
Ext.define("Voyant.data.store.Contexts",{extend:"Ext.data.Store",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.ContextsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusCollocatesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusCollocate",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusCollocates","proxy.reader.rootProperty":"corpusCollocates.collocates","proxy.reader.totalProperty":"corpusCollocates.total"}])}});
Ext.define("Voyant.data.store.CorpusCollocates",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.CorpusCollocatesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusFacet,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusFacets","proxy.reader.rootProperty":"corpusFacets.facets","proxy.reader.totalProperty":"corpusFacets.total"}])}});
Ext.define("Voyant.data.store.CorpusFacets",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusTerm,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusTerms","proxy.reader.rootProperty":"corpusTerms.terms","proxy.reader.totalProperty":"corpusTerms.total"}])},show:function(a){show(this.getString(a))}});
Ext.define("Voyant.data.store.CorpusTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.CorpusTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentQueryMatchesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentQueryMatch",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsFinder","proxy.reader.rootProperty":"documentsFinder.queries","proxy.reader.totalProperty":void 0,"proxy.reader.metaProperty":"documentsFinder.corpus"}])}});
Ext.define("Voyant.data.store.DocumentQueryMatches",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentQueryMatchesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentTerm",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTerms","proxy.reader.rootProperty":"documentTerms.terms","proxy.reader.totalProperty":"documentTerms.total"}])}});
Ext.define("Voyant.data.store.DocumentTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentEntitiesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentEntity",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentEntities","proxy.reader.rootProperty":"documentEntities.entities","proxy.reader.totalProperty":"documentEntities.total"}])}});
Ext.define("Voyant.data.store.DocumentEntities",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentEntitiesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Document",statics:{i18n:{}},sorters:{property:"index",direction:"ASC"},remoteSort:!0,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsMetadata","proxy.reader.rootProperty":"documentsMetadata.documents","proxy.reader.totalProperty":"documentsMetadata.total"}])},listeners:{load:function(a,b,c,d){if(c){var e=
a.getCorpus();b.forEach(function(a){a.set("corpus",e)})}}},getDocument:function(a){return Ext.isNumber(a)?this.getAt(a):this.getById(a)}});Ext.define("Voyant.data.store.Documents",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.PCA","proxy.reader.rootProperty":"pcaAnalysis","proxy.reader.totalProperty":"pcaAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.PCAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocSimAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentSimilarity","proxy.reader.rootProperty":"documentSimilarity","proxy.reader.totalProperty":"documentSimilarity.total"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.DocSimAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocSimAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusNgram",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusNgrams","proxy.reader.rootProperty":"corpusNgrams.ngrams","proxy.reader.totalProperty":"corpusNgrams.total"}])}});
Ext.define("Voyant.data.store.CorpusNgrams",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.RelatedTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.RelatedTerm",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.SemanticGraph","proxy.reader.rootProperty":"semanticGraph.edges","proxy.reader.totalProperty":"semanticGraph.total"}])}});
Ext.define("Voyant.data.store.RelatedTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.RelatedTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TermCorrelationsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.TermCorrelation",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusTermCorrelations","proxy.reader.rootProperty":"termCorrelations.correlations","proxy.reader.totalProperty":"termCorrelations.total"}])}});
Ext.define("Voyant.data.store.TermCorrelations",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.TermCorrelationsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Token",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTokens","proxy.reader.rootProperty":"documentTokens.tokens","proxy.reader.totalProperty":"documentTokens.total"}])}});
Ext.define("Voyant.data.store.Tokens",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TSNEAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.TSNE","proxy.reader.rootProperty":"tsneAnalysis","proxy.reader.totalProperty":"tsneAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0;a.proxy.extraParams.noCache=1}});
Ext.define("Voyant.data.store.TSNEAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TSNEAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.table.Table",{alternateClassName:["VoyantTable"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show"],embeddable:["Voyant.widget.VoyantTableTransform","Voyant.widget.VoyantChart","Voyant.widget.CodeEditor"],config:{rows:[],headers:[],rowsMap:{},headersMap:{},rowKey:void 0,model:void 0},clone:function(){var a=new VoyantTable;a.setRows(Ext.clone(this.getRows()));a.setHeaders(Ext.clone(this.getHeaders()));a.setRowsMap(Ext.clone(this.getRowsMap()));a.setHeadersMap(Ext.clone(this.getHeadersMap()));
a.setRowKey(Ext.clone(this.getRowKey()));return a},constructor:function(a,b){a=a||{};if(a.fromBlock){if(b=Voyant.notebook.Notebook.getDataFromBlock(a.fromBlock))b=b.trim(),a.rows=[],b.split(/\n+/).forEach(function(b,c){b=b.split("\t");0!=c||a.noHeaders?a.rows.push(b):a.headers=b})}else if(a.count&&Ext.isArray(a.count)){var c={};a.count.forEach(function(a){c[a]=c[a]?c[a]+1:1});b=[];for(var d in c)b.push([d,c[d]]);b.sort(function(a,b){return b[1]-a[1]});a.limit&&b.length>a.limit&&b.splice(a.limit);
a.orientation&&"horizontal"==a.orientation?(a.headers=b.map(function(a){return a[0]}),a.rows=[b.map(function(a){return a[1]})]):(a.headers=a.headers?a.headers:["Item","Count"],a.rows=b)}else if(a.isStore||a.store){d=a.store?a.store:a;if(b&&b.headers)a.headers=b.headers;else if(b=d.getAt(0))a.headers=b.getFields().map(function(a){return a.getName()});a.rows=[];d.each(function(b){var c=b.getData();b=a.headers.map(function(a){return c[a]});a.rows.push(b)},this)}!a.rows&&Ext.isArray(a)&&(a.rows=a);this.getHeaders()||
(a.headers||a.noHeaders||!a.rows?this.setHeaders(Ext.Array.from(a.headers)):this.setHeaders(a.rows.shift()));this.setRows(Ext.Array.from(a.rows));this.setRowKey(a.rowKey?a.rowKey:this.getHeaders()[0]);0==this.getHeaders().length&&(b=this.getRow(0,!1))&&this.setHeaders(b.map(function(a,b){return b}));var e={};this.getHeaders().forEach(function(a,b){e[a]=b});this.setHeadersMap(e);this.reMapRows();this.callParent()},addRow:function(a){if(Ext.isArray(a))if(Ext.isObject(a)){var b=this.getRows().length,
c;for(c in a)this.updateCell(b,c,a[c])}else Ext.isArray(a)&&(this.getRows().push(a),b=this.getColumnIndex(this.getRowKey()),void 0!==b&&void 0!==a[b]&&(this.getRowsMap()[a[b]]=this.getRows().length-1))},eachRecord:function(a,b){for(var c,d=0,e=this.getRows().length;d<e&&(c=this.getRecord(d),!1!==a.call(b||c,c,d,e));d++);},eachRow:function(a,b,c){for(var d,e=0,f=this.getRows().length;e<f&&(d=this.getRow(e,b),!1!==a.call(c||d,d,e,f));e++);},getRow:function(a,b){a=this.getRowIndex(a);if(b){var c={},
d=this.getHeaders();Ext.Array.from(this.getRows()[a]).forEach(function(a,b){c[d[b]||b]=a},this);return c}return this.getRows()[a]},getRecord:function(a){if(this.model)return new this.model(this.getRow(a,!0))},mapRows:function(a,b,c){var d=[];this.eachRow(function(b,f){d.push(a.call(c||this,b,f))},b,this);return d},updateCell:function(a,b,c,d){var e=this.getRows();a=Ext.isNumber(a)?a:this.getRowIndex(a);var f=this.getColumnIndex(b);void 0===e[a]&&(e[a]=[]);e[a][f]=void 0===e[a][f]||d?c:e[a][f]+c;this.getHeaders()[f]===
this.getRowKey()&&(this.getRowsMap()[b]=a)},getRowIndex:function(a){if(Ext.isNumber(a))return a;if(Ext.isString(a)){var b=this.getRowsMap();a in b||(b[a]=this.getRows().length,this.getRows().push(Array(this.getHeaders().length)));return b[a]}},getColumnIndex:function(a){var b=this.getHeaders();if(Ext.isNumber(a))return void 0===b[a]&&(b[a]=a,this.getRows().forEach(function(b){b.splice(a,0,void 0)})),a;if(Ext.isString(a))return a in this.getHeadersMap()||(this.getHeaders().push(a),this.getHeadersMap()[a]=
this.getHeaders().length-1,this.getRows().forEach(function(a){a.push(void 0)})),this.getHeadersMap()[a]},getColumnHeader:function(a){a=this.getColumnIndex(a);return this.getHeaders()[a]},getColumnSum:function(a){return Ext.Array.sum(this.getColumnValues(a,!0))},getColumnMean:function(a){return Ext.Array.mean(this.getColumnValues(a,!0))},getColumnMax:function(a){return Ext.Array.max(this.getColumnValues(a,!0))},getColumnMin:function(a){return Ext.Array.min(this.getColumnValues(a,!0))},getColumnValues:function(a,
b){var c=this.getColumnIndex(a),d=[];this.eachRow(function(a){d.push(a[c])});return b?Ext.Array.clean(d):d},reMapRows:function(){var a=this.getRowKey(),b={};this.eachRow(function(c,d){a in c&&(b[c[a]]=d)},!0);this.setRowsMap(b)},sortByColumn:function(a){var b=this.getRows(),c=Ext.Array.from(a).map(function(a){if(Ext.isObject(a))for(key in a)return{index:this.getColumnIndex(key),direction:-1<a[key].indexOf("asc")?"asc":"desc"};else return{index:this.getColumnIndex(a),direction:"desc"}},this);b.sort(function(a,
b){for(var d=0,e=c.length;d<e;d++){var k=c[d].index;if(a[k]!=b[k])return"asc"==c[d].direction?a[k]>b[k]?1:-1:a[k]>b[k]?-1:1}});this.reMapRows();return this},loadCorrespondenceAnalysis:function(a){return this._doAnalysisLoad("table.CA","Voyant.data.store.CAAnalysis",a)},loadPrincipalComponentAnalysis:function(a){return this._doAnalysisLoad("table.PCA","Voyant.data.store.PCAAnalysis",a)},loadTSNEAnalysis:function(a){return this._doAnalysisLoad("table.TSNE","Voyant.data.store.TSNEAnalysis",a)},_doAnalysisLoad:function(a,
b,c){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);c=c||{};var d=Voyant.application.getDeferred(this);Ext.apply(c,{columnHeaders:!0,rowHeaders:!0,tool:a,analysisInput:this.toTsv(),inputFormat:"tsv"});var e=Ext.create(b,{noCorpus:!0});e.load({params:c,callback:function(a,b,c){c?d.resolve(e,a):d.reject(b.error.response)}});return d.promise},embed:function(a,b){!b&&Ext.isObject(a)&&(b=a,a=this.embeddable[0]);b=b||{};var c=Ext.Array.from(b.headers||this.getHeaders()).map(function(a){return this.getColumnHeader(a)},
this);c={rowkey:this.getRowKey(),config:b,headers:c};if("headers"in b){var d=Ext.Array.from(b.headers).map(function(a){return this.getColumnIndex(a)},this),e=[];this.getRows().forEach(function(a){e.push(d.map(function(b){return a[b]}))});Ext.apply(c,{rows:e})}else Ext.apply(c,{rows:this.getRows()});Ext.apply(b,{tableJson:JSON.stringify(c)});delete b.axes;delete b.series;embed.call(this,a,b)},toTsv:function(a){var b=this.getHeaders().join("\t");this.getRows().forEach(function(c,d){a&&Ext.isNumber(a)&&
d>a||(b+="\n"+c.map(function(a){return Ext.isString(a)?a.replace(/(\n|\t)/g,""):a}).join("\t"))});return b},getString:function(a){a=a||{};var b="\x3ctable class\x3d'voyant-table' style\x3d'"+(a.width?" width: "+a.width:"")+"' id\x3d'"+(a.id?a.id:Ext.id())+"'\x3e",c=this.getHeaders();if(c.length){b+="\x3cthead\x3e\x3ctr\x3e";for(var d=0,e=c.length;d<e;d++)b+="\x3cth\x3e"+c[d]+"\x3c/th\x3e";b+="\x3c/tr\x3e\x3c/thead\x3e"}b+="\x3ctbody\x3e";d=0;for(e=Ext.isNumber(a)?a:this.getRows().length;d<e;d++)(a=
this.getRow(d))&&Ext.isArray(a)&&(b+="\x3ctr\x3e",a.forEach(function(a){b+="\x3ctd\x3e"+a+"\x3c/td\x3e"}),b+="\x3c/tr\x3e");return b+="\x3c/tbody\x3e\x3c/table\x3e"}});Ext.define("Voyant.data.util.NetworkGraph",{alternateClassName:["NetworkGraph"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show"],embeddable:["Voyant.widget.VoyantNetworkGraph"],config:{edges:[],nodes:[]},constructor:function(a,b){a=a||{};this.setEdges(Ext.Array.from(a.edges));this.setNodes(Ext.Array.from(a.nodes));this.callParent([a])},addEdge:function(a,b,c){this.getEdges().push(Ext.isObject(a)?a:{source:a,target:b,value:c})},getNode:function(a){return Ext.Array.binarySearch(this.getNodes(),
a,void 0,void 0,function(a,c){return a.term<c.term?-1:a.term>c.term?1:0})},embed:function(a,b){!b&&Ext.isObject(a)&&(b=a,a=this.embeddable[0]);b=b||{};var c={edges:this.getEdges(),nodes:this.getNodes(),config:b};if(b.limit&&c.edges.length>b.limit){c.edges=c.edges.slice(0,b.limit);var d={};c.edges.forEach(function(a){d["_"+a.source]=!0;d["_"+a.target]=!0});var e=[];c.nodes.forEach(function(a){"_"+a.term in d&&e.push(a)});c.nodes=e}Ext.apply(b,{jsonData:JSON.stringify(c)});embed.call(this,a,b)},getString:function(a){return this.getEdges().map(function(a){a.source+
"-"+a.target}).join("; ")}});Ext.define("Voyant.data.util.Geonames",{mixins:["Voyant.util.Localization"],statics:{i18n:{}},config:{data:{},queries:void 0,corpus:void 0,isIncrementalLoadingOccurrences:!1,previousParams:{}},constructor:function(a,b){a=a||{};this.callParent([a]);this.setCorpus(a.corpus)},load:function(a,b){this.setPreviousParams(a);b=b||Voyant.application.getDeferred(this);var c=this,d={corpus:this.getCorpus().getAliasOrId(),queries:this.getQueries(),tool:"corpus.Dreamscape",limit:200};Ext.apply(d,a||{});a.noOverwrite||
c.setData({});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:d,scope:this}).then(function(d){(d=Ext.JSON.decode(d.responseText))&&d.dreamscape&&d.dreamscape.progress&&new Voyant.widget.ProgressMonitor({progress:d.dreamscape.progress,maxMillisSinceStart:36E5,tool:"corpus.Dreamscape",success:function(){c.load.call(c,a,b)},failure:function(a){Voyant.application.showResponseError(c.localize("failedToFetchGeonames"),a)},scope:c});d&&d.dreamscape&&!d.dreamscape.progress&&(a.noOverwrite||
c.setData(d.dreamscape),b.resolve(d))},function(a){Voyant.application.showResponseError(c.localize("failedToFetchGeonames"),a)});return b.promise},getCitiesCount:function(){return Object.keys(this.getData().locations.locations).length},getTotalCitiesCount:function(){return this.getData().locations.total},hasMoreCities:function(){return this.getCitiesCount()<this.getTotalCitiesCount()},eachCity:function(a,b,c){var d=this.getData().locations.locations,e=[],f;for(f in d)e.push(Ext.apply(d[f],{id:f}));
e.sort(function(a,b){return a.rawFreq==b.rawFreq?a.label-b.label:b.rawFreq-a.rawFreq});c&&e.length>c&&(e=e.slice(0,c));e.forEach(function(c){a.call(b,c)})},getConnectionsCount:function(){return this.getData().connections.connections.length},getTotalConnectionsCount:function(){return this.getData().connections.total},eachConnection:function(a,b,c){var d=this.getData().connections.connections,e=this.getData().locations.locations;orderedConnections=[];for(var f=0,g=d.length;f<g&&!(a.call(b,{source:Ext.apply({id:d[f].source},
e[d[f].source]),target:Ext.apply({id:d[f].target},e[d[f].target]),rawFreq:d[f].rawFreq}),f>c);f++);},getConnectionOccurrence:function(a){if(this.getData().locations){var b=this.getData().connectionOccurrences,c=b.connectionOccurrences;locations=this.getData().locations.locations;if(!this.getIsIncrementalLoadingOccurrences()&&c.length<b.total&&a+100>c.length){this.setIsIncrementalLoadingOccurrences(!0);var d=this;b={};Ext.apply(b,this.getPreviousParams);Ext.apply(b,{start:c.length,noOverwrite:!0,suppressLocations:!0,
suppressConnections:!0});this.load(b).then(function(a){d.setIsIncrementalLoadingOccurrences(!1);d.getData().connectionOccurrences.connectionOccurrences=c.concat(a.dreamscape.connectionOccurrences.connectionOccurrences)})}return c&&c[a]?(b=c[a],b.index=a,Ext.apply(b.source,locations[b.source.location]),Ext.apply(b.target,locations[b.target.location]),b):null}},getAllConnectionOccurrences:function(a,b){debugger;for(var c=[],d=0;d<this.getTotalConnectionsCount();d++){var e=this.getConnectionOccurrence(d);
e&&e.target.id==b&&e.source.id==a&&c.push(e)}return c}});Ext.define("Voyant.data.model.Corpus",{alternateClassName:["Corpus"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show","Voyant.util.Transferable","Voyant.util.Localization","Voyant.util.Assignable"],transferable:"loadCorpusTerms loadTokens getPlainText getText getWords getString getLemmasArray".split(" "),embeddable:"Voyant.panel.Summary Voyant.panel.Cirrus Voyant.panel.Documents Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Trends Voyant.panel.TermsRadio Voyant.panel.DocumentTerms Voyant.panel.TermsBerry Voyant.panel.CollocatesGraph Voyant.panel.Contexts Voyant.panel.WordTree Voyant.panel.Veliza Voyant.panel.ScatterPlot Voyant.panel.Topics".split(" "),
requires:["Voyant.util.ResponseError","Voyant.data.store.CorpusTerms","Voyant.data.store.Documents"],extend:"Ext.data.Model",config:{documentsStore:void 0},statics:{i18n:{}},fields:[{name:"documentsCount",type:"int"},{name:"lexicalTokensCount",type:"int"},{name:"lexicalTypesCount",type:"int"},{name:"createdTime",type:"int"},{name:"createdDate",type:"date",dateFormat:"c"},{name:"title",type:"string"},{name:"subTitle",type:"string"},{name:"languagueCodes",type:"string"}],constructor:function(a,b){a=
a||{};b=b||{};this.callParent([]);var c=Voyant.application.getDeferred(this);if(Ext.isString(a))0==/\s/.test(a)&&-1==a.indexOf(":")?Ext.apply(b,{corpus:a}):Ext.apply(b,{input:a});else if(Ext.isArray(a))Ext.apply(b,{input:a});else if(Ext.isObject(a))Ext.apply(b,a);else return Voyant.application.showError(this.localize("badDataTypeCorpus")+": ("+typeof a+") "+a),Ext.defer(function(){c.reject(this.localize("badDataTypeCorpus")+": ("+typeof a+") "+a)},50,this),c.promise;if(Ext.isObject(b)){if(!b.corpus&&
!b.input&&!b.inlineData)return Voyant.application.showError(this.localize("noCorpusOrInput")+": "+b),Ext.defer(function(){c.reject(this.localize("noCorpusOrInput")+": "+b)},50,this),c.promise;Ext.apply(b,{tool:"corpus.CorpusMetadata"});var d=this;Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:b}).then(function(a){d.set(Ext.JSON.decode(a.responseText).corpus.metadata);if(b.title||b.subTitle)d.set("title",b.title),d.set("subTitle",b.subTitle);return d},function(a){Voyant.application.showResponseError(d.localize("failedCreateCorpus"),
a)}).then(function(a){0==a.getDocumentsCount()&&Voyant.application.showError(d.localize("thisCorpus")+" "+d.localize("isEmpty")+".");!("docsLimit"in b)||!1!==b.docsLimit&&0<b.docsLimit?d.getDocuments().load({params:{limit:"docsLimit"in b?b.docsLimit:d.getDocumentsCount()},callback:function(b,e,k){k?(d.setDocumentsStore(this),c.resolve(a)):c.reject(e)}}):c.resolve(a)})}else Voyant.application.showError(this.localize("badDataTypeCorpus")+": ("+typeof b+") "+b),Ext.defer(function(){c.reject(this.localize("badDataTypeCorpus")+
": ("+typeof b+") "+b)},50,this);return c.promise},getId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("id")},getAliasOrId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("alias")||this.get("id")},loadCorpusTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,
{limit:0});var c=this.getCorpusTerms();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens();c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getCorpusTerms:function(a){return Ext.create("Voyant.data.store.CorpusTerms",
Ext.apply(a||{},{corpus:this}))},getTokens:function(a){return Ext.create("Voyant.data.store.Tokens",Ext.apply(a||{},{corpus:this}))},each:function(a,b){this.getDocuments().each(function(c,d){a.call(b||c,c,d)})},map:function(a,b){return this.getDocuments().getRange().map(function(c,d){return a.call(b||c,c,d)},b||this)},getCorpusCollocates:function(a){return Ext.create("Voyant.data.store.CorpusCollocates",Ext.apply(a||{},{corpus:this}))},getDocumentQueryMatches:function(a){return Ext.create("Voyant.data.store.DocumentQueryMatches",
Ext.apply(a||{},{corpus:this}))},getDocumentTerms:function(a){return Ext.create("Voyant.data.store.DocumentTerms",Ext.apply(a||{},{corpus:this}))},getDocumentEntities:function(a){return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(a||{},{corpus:this}))},loadContexts:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getContexts();
c.load({params:a,callback:function(a,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getContexts:function(a){return Ext.create("Voyant.data.store.Contexts",Ext.apply(a||{},{corpus:this}))},getDocuments:function(a){return this.getDocumentsStore()?this.getDocumentsStore():Ext.create("Voyant.data.store.Documents",Ext.apply(a||{},{corpus:this}))},getDocument:function(a){if(this.getDocumentsStore()){if(a instanceof Voyant.data.model.Document)return a;if(Ext.isNumeric(a))return this.getDocumentsStore().getAt(parseInt(a));
if(Ext.isString(a))return this.getDocumentsStore().getById(a)}return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.getDocumentsStore().getDocument(a)},getDocumentsCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("documentsCount")},getWordTokensCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("lexicalTokensCount")},getWordTypesCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,
arguments):this.get("lexicalTypesCount")},getCreatedTime:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("createdTime")},requiresPassword:function(){var a=this.getNoPasswordAccess();return"NONE"==a||"NONCONSUMPTIVE"==a},getNoPasswordAccess:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("noPasswordAccess")},getTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):
this.get("title")},getSubTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("subTitle")},getRelatedWords:function(a){return Ext.create("Voyant.data.store.RelatedTerms",Ext.apply(a||{},{corpus:this}))},loadRelatedWords:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});this.getRelatedWords().load({params:a,
callback:function(a,d,e){e?b.resolve(a):b.reject(d.error.response)}});return b.promise},getText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments,this);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.applyIf(a,{limit:0,outputFormat:"text",template:"docTokens2text"});Ext.apply(a,{tool:"corpus.DocumentTokens",corpus:this.getAliasOrId()});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:a,success:function(c,d){c=c.responseText.trim();a.transformCase&&(-1<a.transformCase.indexOf("lower")?c=c.toLowerCase():-1<a.transformCase.indexOf("upper")&&(c=c.toUpperCase()));b.resolve(c)},failure:function(a,d){b.reject(a)},scope:this});return b.promise},getPlainText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.apply(a,{template:"docTokens2plainText"});return this.getText(a)},
getWords:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.applyIf(a,{template:"docTokens2words"});return this.getText(a)},getWordsArray:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);this.getWords(a).then(function(a){b.resolve(a.split(" "))});return b.promise},getLemmasArray:function(a){a=
a||{};if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);Ext.applyIf(a,{template:"docTokens2lemmas",withPosLemmas:!0,noOthers:!0});this.getWords(a).then(function(a){a=a.split(" ").map(function(a){return a.substring(0,a.indexOf("/"))});b.resolve(a)});return b.promise},getString:function(a){var b=this.getDocumentsCount(),c=this.localize("thisCorpus");if(0==b)c+=" "+this.localize("isEmpty")+".";else{c+=" ";c=1<b?c+(new Ext.XTemplate(this.localize("hasNdocuments"))).apply({count:Ext.util.Format.number(b,
"0,000")}):c+this.localize("has1document");c+=" "+(new Ext.XTemplate(this.localize("widthNwordsAndNTypes"))).apply({words:Ext.util.Format.number(this.getWordTokensCount(),"0,000"),types:Ext.util.Format.number(this.getWordTypesCount(),"0,000")})+".";c+=" "+this.localize("created")+" ";var d=this.get("createdDate"),e=new Date;!0===Ext.Array.each([["year",Ext.Date.YEAR],["month",Ext.Date.MONTH],["day",Ext.Date.DAY],["hour",Ext.Date.HOUR],["minute",Ext.Date.MINUTE],["second",Ext.Date.SECOND]],function(a){if(Ext.Date.diff(d,
e,a[1])>("second"==a[0]?1:0)){var b=Ext.Date.diff(d,e,a[1]);c+="\x3cspan class\x3d'info-tip' data-qtip\x3d'"+Ext.Date.format(d,"Y-m-d, H:i:s")+"'\x3e";c=1==b?c+(new Ext.XTemplate(this.localize(a[0]+"Ago"))).apply({count:b,date:d}):c+(new Ext.XTemplate(this.localize(a[0]+"sAgo"))).apply({count:b,date:d});c+="\x3c/span\x3e";return!1}},this)&&(c+=this.localize("now"));c+=".";c+=""}!0===a&&(c+=" ("+this.getId()+")");return c}});Ext.define("Voyant.widget.CodeEditor",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.codeeditor",statics:{i18n:{},api:{tableJson:void 0,content:"",mode:"ace/mode/text",width:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.buildFromParams();Ext.apply(this,{items:{xtype:"notebookcodeeditor",content:a.content?a.content:this.getApiParam("content"),mode:a.mode?a.mode:
this.getApiParam("mode")}});this.callParent(arguments)},initComponent:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},buildFromParams:function(){var a=this.getApiParam("tableJson");a&&(a=Ext.decode(a),a=a.headers.join("\t")+"\n"+a.rows.map(function(a){return a.join("\t")}).join("\n"),this.setApiParam("content",a))}});Ext.define("Voyant.widget.CorpusSelector",{extend:"Ext.form.field.ComboBox",mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.corpusselector",statics:{i18n:{},api:{openMenu:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var b=[["shakespeare","Shakespeare's Plays"],["austen","Austen's Novels"]];this.getApiParam("openMenu")?b=this.getStoreItemsFromDefinition(this.getApiParam("openMenu")):Voyant.application&&Voyant.application.getOpenMenu&&
Voyant.application.getOpenMenu()&&(b=Voyant.application.getOpenMenu(),b=decodeURIComponent(b),b=b.replace(/\+/g," "),'"'==b.charAt(0)&&'"'==b.charAt(b.length-1)&&(b=b.substring(1,b.length-1)),b=this.getStoreItemsFromDefinition(b));Ext.applyIf(a,{fieldLabel:this.localize("chooseCorpus"),labelWidth:125,labelAlign:"right",name:"corpus",queryMode:"local",store:b});this.callParent([a])},initComponent:function(a){a=a||{};this.callParent([a])},getStoreItemsFromDefinition:function(a){var b=[];a=a.split(";");
for(var c=0;c<a.length;c++){var d=a[c].split(":");d[0]&&b.push([d[0],d[1]?d[1]:d[0]])}return b}});Ext.define("Voyant.widget.ListEditor",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.listeditor",layout:"hbox",statics:{i18n:{}},initComponent:function(a){var b=this.up("window").panel.getApiParam(this.name),c=b?[{name:b,value:b}]:[];c.splice(0,0,{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize(this.name+"Label"),
labelAlign:"right",name:this.name,displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this}]});this.callParent(arguments)},editList:function(){var a=this.up("window").panel,b=this.down("combo").getValue();Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.KeywordsManager",list:b},success:function(b){b=Ext.util.JSON.decode(b.responseText).keywords.keywords.sort().join("\n");
Ext.Msg.show({title:this.localize("editListTitle"),message:this.localize("editListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:b,original:b,fn:function(b,c,f){"ok"==b&&f.original!=c&&(b=this.down("combo"),0==Ext.String.trim(c).length?b.setValue("empty"):Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:c},combo:b,success:function(a,b){var c=Ext.util.JSON.decode(a.responseText);
a=b.combo.getStore();c="keywords-"+c.storedResource.id;a.add({name:c,value:c});b.combo.setValue(c);b.combo.updateLayout()},scope:this}))},scope:this})},scope:this})}});Ext.define("Voyant.widget.StopListOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.stoplistoption",layout:"hbox",statics:{stoplists:{ar:"stop.ar.arabic-lucene.txt",bg:"stop.bu.bulgarian-lucene.txt",br:"stop.br.breton-lucene.txt",ca:"stop.ca.catalan-lucene.txt",ckb:"stop.ckb-turkish-lucene.txt",cn:"stop.cn.chinese-lawrence.txt",cz:"stop.cz.czech-lucene.txt",de:"stop.de.german.txt",el:"stop.el.greek-lucene.txt",en:"stop.en.taporware.txt",es:"stop.es.spanish.txt",
eu:"stop.eu.basque-lucene.txt",fa:"stop.fa.farsi-lucene.txt",fr:"stop.fr.veronis.txt",ga:"stop.ga-irish-lucene.txt",gl:"stop.ga.galician-lucene.txt",grc:"stop.grc.ancient-greek.txt",hi:"stop.hi.hindi-lucene.txt",hu:"stop.hu.hungarian.txt",hy:"stop.hy.armenian-lucene.txt",id:"stop.id.indonesian-lucene.txt",it:"stop.it.italian.txt",ja:"stop.ja.japanese-lucene.txt",la:"stop.la.latin.txt",lv:"stop.lv.latvian-lucene.txt",lt:"stop.lt.lithuanian-lucene.txt",mu:"stop.mu.multi.txt",nl:"stop.nl.dutch.txt",
no:"stop.no.norwegian.txt",pt:"stop.pt.brazilian.txt",ro:"stop.ro.romanian-lucene.txt",ru:"stop.ru.russian.txt",se:"stop.se.swedish-long.txt",th:"stop.th.thai-lucene.txt",tr:"stop.tr.turkish-lucene.txt"},i18n:{}},initComponent:function(a){var b=this.up("window").panel.getApiParam("stopList"),c=[];for(id in Voyant.widget.StopListOption.stoplists)c.push({name:this.localize(id),value:Voyant.widget.StopListOption.stoplists[id]});c.sort(function(a,b){return a.name<b.name?-1:1});c.splice(0,0,{name:this.localize("auto"),
value:"auto"},{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("label"),labelAlign:"right",name:"stopList",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this},{width:10},{xtype:"checkbox",name:"stopListGlobal",
checked:!0,boxLabel:this.localize("applyGlobally")}]});this.callParent(arguments)},editList:function(){var a=this.up("window").panel,b=this.down("combo").getValue(),c=a.getApplication&&a.getApplication().getCorpus?a.getApplication().getCorpus().getId():void 0;"auto"!=b||c?Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:b,corpus:c},success:function(b){b=Ext.util.JSON.decode(b.responseText).keywords.keywords.sort().join("\n");Ext.Msg.show({title:this.localize("editStopListTitle"),
message:this.localize("editStopListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:b,original:b,fn:function(b,d,g){d=d.toLowerCase();"ok"==b&&g.original!=d&&(b=this.down("combo"),0==Ext.String.trim(d).length?b.setValue("empty"):Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:d,corpus:c},combo:b,success:function(a,b){var c=Ext.util.JSON.decode(a.responseText);
a=b.combo.getStore();c="keywords-"+c.storedResource.id;a.add({name:c,value:c});b.combo.setValue(c);b.combo.updateLayout()},scope:this}))},scope:this})},scope:this}):Ext.Msg.show({title:this.localize("noEditAutoTitle"),message:this.localize("noEditAutoMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}});Ext.define("Voyant.widget.QuerySearchField",{extend:"Ext.form.field.Tag",mixins:["Voyant.util.Localization"],alias:"widget.querysearchfield",statics:{i18n:{}},config:{corpus:void 0,tokenType:"lexical",isDocsMode:!1,inDocumentsCountOnly:void 0,stopList:void 0,showAggregateInDocumentsCount:!1,clearOnQuery:!1,parentPanel:void 0,currentOriginalRawQueryPlan:void 0},hasCorpusLoadedListener:!1,isClearing:!1,constructor:function(a){a=a||{};Ext.applyIf(a,{minWidth:100,maxWidth:200,matchFieldWidth:!1,minChars:2,
displayField:"term",valueField:"term",filterPickList:!0,createNewOnEnter:!0,createNewOnBlur:!1,autoSelect:!1,tpl:['\x3cul class\x3d"x-list-plain"\x3e\x3ctpl for\x3d"."\x3e','\x3cli role\x3d"option" class\x3d"x-boundlist-item" style\x3d"white-space: nowrap;"\x3e'+(a.itemTpl?a.itemTpl:a.inDocumentsCountOnly?"\x3ctpl\x3e\x3ctpl if\x3d\"term.charAt(0)\x3d\x3d'@'\"\x3e{term}\x3c/tpl\x3e\x3ctpl if\x3d\"term.charAt(0)!\x3d'@'\"\x3e{term} ({inDocumentsCount})\x3c/tpl\x3e\x3c/tpl\x3e":"\x3ctpl\x3e\x3ctpl if\x3d\"term.charAt(0)\x3d\x3d'@'\"\x3e{term}\x3c/tpl\x3e\x3ctpl if\x3d\"term.charAt(0)!\x3d'@'\"\x3e{term} ({rawFreq})\x3c/tpl\x3e\x3c/tpl\x3e")+
"\x3c/li\x3e","\x3c/tpl\x3e\x3c/ul\x3e"],triggers:{help:{weight:2,cls:"fa-trigger form-fa-help-trigger",handler:function(){Ext.Msg.show({title:this.localize("querySearch"),message:this.getIsDocsMode()?this.localize("querySearchDocsModeTip"):this.localize("querySearchTip"),buttons:Ext.OK,icon:Ext.Msg.INFO})},scope:"this"}}});a.showAggregateInDocumentsCount&&(a.triggers.count={cls:"fa-trigger",handler:"onHelpClick",scope:"this",hidden:!0});a.clearOnQuery&&this.setClearOnQuery(a.clearOnQuery);this.callParent(arguments)},
initComponent:function(a){var b=this;b.on("beforequery",function(a){if(a.query){a.query=a.query.trim();var c=a.query.toLowerCase();this.setCurrentOriginalRawQueryPlan(a.query);if("@"!=a.query.charAt(0)){"^"==a.query.charAt(0)&&(a.query=a.query.substring(1),a.cancel=0==a.query.length);"*"==a.query.charAt(0)&&(a.query="."+a.query);if("*"==a.query.charAt(a.query.length-1)||"|"==a.query.charAt(a.query.length-1))a.query=a.query.substring(0,a.query.length-1),a.cancel=0==a.query.length;"."==a.query.charAt(0)&&
(a.cancel=a.query.length<(/\W/.test(a.query.charAt(1))?5:4));try{new RegExp(a.query)}catch(h){a.cancel=!0}-1<a.query.indexOf('"')&&(-1==a.query.indexOf(" ")&&(a.cancel=!0),2!=(a.query.match(/"/)||[]).length&&(a.cancel=!0));-1<a.query.indexOf("*")?-1==a.query.indexOf(" ")&&-1==a.query.indexOf("|")&&(a.query+=",^"+a.query):a.query=a.query+"*"+(-1==a.query.indexOf(" ")&&-1==a.query.indexOf("|")?",^"+a.query+"*":"")}else"@"==a.query&&(a.cancel=!0);var d=b.getParentPanel();if(0==a.cancel&&d){var g="@"==
c.charAt(0)?c.substring(1):c,k;for(k in d.getApplication().getCategories())-1<k.toLowerCase().indexOf(g)&&(a.query="@"+k+("@"==c.charAt(0)?"":","+a.query))}}},this);b.on("change",function(a,c){b.isClearing?b.isClearing=!1:(c=c.map(function(a){return a.replace(/^(\^?)\*/,"$1.*")}),b.up("panel").fireEvent("query",b,c),b.getClearOnQuery()&&(b.isClearing=!0,b.removeValue(b.getValueRecords())),b.triggers.count&&(b.triggers.count.show(),b.triggers.count.getEl().setHtml("0"),0<c.length?b.getCorpus().getCorpusTerms().load({params:{query:c.map(function(a){return"("+
a+")"}).join("|"),tokenType:b.getTokenType(),stopList:b.getStopList(),inDocumentsCountOnly:!0},callback:function(a,c,d){d&&a&&1==a.length&&b.triggers.count.getEl().setHtml(a[0].getInDocumentsCount())}}):b.triggers.count.hide()))});var c=b.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});if(null!=c){this.setParentPanel(c);if(c.getCorpus&&c.getCorpus())b.on("afterrender",function(a){this.doSetCorpus(c.getCorpus())});else c.on("loadedCorpus",function(a,c){b.doSetCorpus(c)},b);b.hasCorpusLoadedListener=
!0}b.on("afterrender",function(a){!1!==b.hasCorpusLoadedListener||b.getCorpus()||(c=b.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]}),null==c&&(c=b.up("window").panel),a=c.getApplication().getCorpus(),void 0!==a?b.doSetCorpus(a):(c.on("loadedCorpus",function(a,c){b.doSetCorpus(c)},b),b.hasCorpusLoadedListener=!0));b.triggers&&b.triggers.help&&Ext.tip.QuickTipManager.register({target:b.triggers.help.getEl(),text:b.getIsDocsMode()?b.localize("querySearchDocsModeTip"):b.localize("querySearchTip")});
b.triggers&&b.triggers.count&&Ext.tip.QuickTipManager.register({target:b.triggers.count.getEl(),text:b.localize("aggregateInDocumentsCount")})});b.on("beforedestroy",function(a){b.triggers&&b.triggers.help&&Ext.tip.QuickTipManager.unregister(b.triggers.help.getEl());b.triggers&&b.triggers.count&&Ext.tip.QuickTipManager.unregister(b.triggers.count.getEl())});b.callParent(arguments)},doSetCorpus:function(a){if(null!=a){this.setCorpus(a);if(void 0==this.getStopList())if(this.getApiParam)this.setStopList(this.getApiParam("stopList"));
else for(var b=this.up("panel");b;){if(b&&b.getApiParam){this.setStopList(b.getApiParam("stopList"));break}b=b.up("panel")}var c=this.getApiParam?this.getApiParam("categories"):void 0;if(!c)for(b=this.up("panel");b;){if(b&&b.getApiParam){c=b.getApiParam("categories");break}b=b.up("panel")}a=a.getCorpusTerms({corpus:a.getAliasOrId(),proxy:{extraParams:{limit:10,tokenType:this.tokenType,stopList:this.getStopList(),inDocumentsCountOnly:this.getInDocumentsCountOnly(),categories:c}}});this.setStore(a)}}});Ext.define("Voyant.widget.TotalPropertyStatus",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.totalpropertystatus",statics:{i18n:{}},initComponent:function(){Ext.applyIf(this,{tpl:this.localize("totalPropertyStatus"),itemId:"totalpropertystatus",style:"margin-right:5px",listeners:{afterrender:function(a){var b=a.up("grid");if(b){var c=b.getStore();a.updateStatus(c.getTotalCount());b.getStore().on("totalcountchange",a.updateStatus,a)}}}});this.callParent(arguments)},updateStatus:function(a){this.update({count:a})}});Ext.define("Voyant.widget.DocumentSelector",{mixins:["Voyant.util.Localization"],alias:"widget.documentselector",glyph:"xf10c@FontAwesome",statics:{i18n:{}},config:{docs:void 0,corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("documents"),menu:{width:250,fbar:[{xtype:"checkbox",hidden:this.getSingleSelect(),boxLabel:this.localize("all"),listeners:{change:{fn:function(a,
b){this.getMenu().items.each(function(a){a.setChecked(b)})},scope:this}}},{xtype:"tbfill"},{xtype:"button",text:this.localize("ok"),hidden:this.getSingleSelect(),scale:"small",handler:function(a,b){var c=[];this.getMenu().items.each(function(a){a.checked&&c.push(a.docId)},this);(b=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]}))&&b.fireEvent("documentsSelected",a,c);a.findParentBy(function(a){return a.isXType("button")&&a.hasVisibleMenu()?(a.hideMenu(),!0):!1})},scope:this},{xtype:"button",
text:this.localize("cancel"),scale:"small",handler:function(a,b){this.findParentBy(function(a){return a.isXType("button")&&a.hasVisibleMenu()?(a.hideMenu(),!0):!1},this);this.hideMenu()},scope:this}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(b,d){this.setCorpus(d);1==d.getDocumentsCount()?this.hide():a.populate(d.getDocumentsStore().getRange(),!0)},a);var b=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",function(b,d){a.fireEvent("loadedCorpus",
b,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}})},populate:function(a,b){this.setDocs(a);var c=this.getMenu();b&&c.removeAll();var d=this.getSingleSelect(),e="docGroup"+Ext.id();a.forEach(function(a,b){c.add({xtype:"menucheckitem",text:a.getShortTitle(),docId:a.get("id"),checked:d&&0==b||!d,group:d?e:void 0,checkHandler:function(b,c){this.getSingleSelect()&&
c&&(b=this.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]}))&&b.fireEvent("documentSelected",this,a)},scope:this})},this)}});Ext.define("Voyant.widget.DocumentSelectorButton",{extend:"Ext.button.Button",alias:"widget.documentselectorbutton",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});
Ext.define("Voyant.widget.DocumentSelectorMenuItem",{extend:"Ext.menu.Item",alias:"widget.documentselectormenuitem",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});Ext.define("Voyant.widget.CorpusDocumentSelector",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.corpusdocumentselector",statics:{i18n:{}},config:{corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("scale"),glyph:"xf059@FontAwesome",menu:{items:[{text:this.localize("corpus"),glyph:"xf111@FontAwesome",handler:function(a){var b=
this.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(a.nextSibling().menu.items.each(function(a){a.setChecked(!1,!0)}),b.fireEvent("corpusSelected",this,this.getCorpus()))},scope:this},{xtype:"documentselectormenuitem",singleSelect:this.getSingleSelect()}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(a,b){this.setCorpus(b);1==b.getDocumentsCount()&&this.hide()},a);var b=a.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",
function(b,d){a.fireEvent("loadedCorpus",b,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}});this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadFilenameBuilder",{extend:"Ext.form.FieldContainer",mixins:["Voyant.util.Localization","Ext.form.field.Field"],alias:"widget.downloadfilenamebuilder",statics:{i18n:{}},config:{name:"documentFilename",itemId:"documentFilename",fields:["pubDate","title","author"],value:["pubDate","title"],width:400},initComponent:function(a){a=a||{};this.initField();this.on("afterrender",function(){this.items.eachKey(function(a){new Ext.dd.DropZone(this.items.get(a).getTargetEl(),{ddGroup:"downloadfilename",
getTargetFromEvent:function(a){a=a.getTarget();return a.className&&-1<a.className.indexOf("dragsource")?a.parentNode:a},onNodeDrop:function(a,b,e,f){a.appendChild(b.el.dom);return!0}})},this);this.getFields().map(function(a){a=Ext.isString(a)?{tag:"span",html:this.localize(a+"Label"),value:a}:a;var b=this.queryById(Ext.Array.contains(this.getValue(),a.value)?"enabled":"available");a=Ext.dom.Helper.append(b.getTargetEl(),Ext.apply(a,{cls:"dragsource"}));Ext.create("Ext.dd.DragSource",a,{ddGroup:"downloadfilename"})},
this)},this);this.callParent(arguments)},defaults:{xtype:"container",width:"100%"},items:[{itemId:"enabled",cls:"dropzone dropzone-enabled"},{itemId:"available",cls:"dropzone dropzone-disabled"}],getValue:function(){return this.rendered?this.getTargetEl().query(".dropzone-enabled .dragsource").map(function(a){return a.getAttribute("value")}):this.value},setValue:function(a){this.rendered?this.getTargetEl().query(".dragsource",!1).forEach(function(a){var b=Ext.Array.contains(this.value,a.getAttribute("value"));
b&&a.parent().hasCls("dropzone-disabled")?this.queryById("enabled").getTargetEl().appendChild(a.dom):!b&&a.parent().hasCls("dropzone-enabled")&&this.queryById("available").getTargetEl().appendChild(a.dom)},this):this.value=a}});Ext.define("Voyant.widget.DownloadFileFormat",{extend:"Ext.form.CheckboxGroup",mixins:["Voyant.util.Localization"],alias:"widget.downloadfileformat",statics:{i18n:{}},initComponent:function(a){a=a||{};Ext.apply(this,{labelAlign:a.labelAlign?a.labelAlign:"right"});Ext.applyIf(this,{fieldLabel:this.localize("fieldLabel"),items:[{boxLabel:this.localize("original"),name:"documentFormat",inputValue:"SOURCE"},{boxLabel:this.localize("voyantXml"),name:"documentFormat",inputValue:"VOYANT"},{boxLabel:this.localize("plainText"),
name:"documentFormat",inputValue:"TXT"}],width:450});this.on("afterrender",function(){this.query("checkbox").forEach(function(a){var b=this.localize(a.inputValue+"Tip");-1==b.indexOf(a.inputValue+"Tip")&&Ext.tip.QuickTipManager.register({target:a.getEl(),text:b})},this)},this);this.on("beforedestroy",function(){this.query("checkbox").forEach(function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},this)},this);this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadOptions",{extend:"Ext.form.FieldSet",mixins:["Voyant.util.Localization"],requires:["Voyant.widget.DownloadFileFormat","Voyant.widget.DownloadFilenameBuilder"],alias:"widget.downloadoptions",statics:{i18n:{}},config:{items:[{xtype:"downloadfileformat"},{xtype:"downloadfilenamebuilder"}]},initComponent:function(a){a=a||{};Ext.apply(this,{title:a.title?a.title:this.localize("title")});this.callParent(arguments)}});Ext.define("Voyant.widget.FontFamilyOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.fontfamilyoption",statics:{i18n:{},fonts:[{name:"Georgia",value:"Georgia, serif"},{name:"Palatino",value:'"Palatino Linotype", "Book Antiqua", Palatino, serif'},{name:"Times New Roman",value:'"Times New Roman", Times, serif'},{name:"Arial",value:"Arial, Helvetica, sans-serif"},{name:"Arial Black",value:'"Arial Black", Gadget, sans-serif'},{name:"Comic Sans MS",value:'"Comic Sans MS", cursive, sans-serif'},
{name:"Impact",value:"Impact, Charcoal, sans-serif"},{name:"Lato",value:"LatoWeb"},{name:"Lucida",value:'"Lucida Sans Unicode", "Lucida Grande", sans-serif'},{name:"Tahoma/Geneva",value:"Tahoma, Geneva, sans-serif"},{name:"Trebuchet MS/Helvetica",value:'"Trebuchet MS", Helvetica, sans-serif'},{name:"Verdana/Geneva",value:"Verdana, Geneva, sans-serif"},{name:"Courrier New",value:'"Courier New", Courier, monospace'},{name:"Lucida/Monaco",value:'"Lucida Console", Monaco, monospace'}]},name:"fontFamily",
initComponent:function(a){a=a||{};var b=this.up("window").panel.getApiParam("fontFamily"),c=Ext.ClassManager.getClass(this).fonts;Ext.Array.contains(c.map(function(a){return a.value}),b)||c.splice(0,0,{name:b,value:b});Ext.apply(this,{items:{xtype:"combo",queryMode:"local",name:"fontFamily",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("label"),labelAlign:"right",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c},width:400}});this.callParent(arguments)}});Ext.define("Voyant.widget.ColorPaletteOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.colorpaletteoption",layout:"hbox",statics:{i18n:{}},paletteTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"color" style\x3d"background-color: rgb({color});"\x3e\x3c/div\x3e',"\x3c/tpl\x3e"),paletteStore:new Ext.data.ArrayStore({fields:["id","color"],listeners:{update:function(a,b,c,d,e){},scope:this}}),editPaletteWin:null,spectrum:null,initComponent:function(a){var b=
this.up("window").panel.getApplication(),c=[],d;for(d in b.getPalettes())c.push({name:d,value:d});b=b.getApiParam("palette");Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("palette"),labelAlign:"right",name:"palette",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editPalette,scope:this}]});
this.callParent(arguments)},editPalette:function(){var a=this.down("combo").getValue();this.loadPalette(a);this.editPaletteWin=Ext.create("Ext.window.Window",{title:this.localize("paletteEditor"),modal:!0,height:300,width:425,padding:5,layout:{type:"hbox",align:"stretch"},items:[{flex:1,layout:{type:"vbox",align:"stretch"},items:[{height:24,margin:"0 0 5 0",items:[{xtype:"button",text:this.localize("add"),margin:"0 5 0 0",handler:function(a){a=this.spectrum.spectrum("get").toRgb();var b=this.editPaletteWin.down("dataview");
this.paletteStore.add([[Ext.id(),[a.r,a.g,a.b]]]);b.refresh()},scope:this},{xtype:"button",text:this.localize("remove"),margin:"0 5 0 0",handler:function(a){a=this.editPaletteWin.down("dataview");var b=a.getSelectionModel().getSelection()[0];null!=b&&this.paletteStore.remove(b);a.refresh()},scope:this},{xtype:"button",text:this.localize("clear"),handler:function(a){this.paletteStore.removeAll()},scope:this}]},{xtype:"dataview",flex:1,scrollable:"y",store:this.paletteStore,tpl:this.paletteTpl,itemSelector:"div.color",
overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SINGLE"},listeners:{selectionchange:function(a,c,d){null!=c[0]&&(a=c[0].get("color"),a=this.up("window").panel.getApplication().rgbToHex(a),this.spectrum.spectrum("set",a))},scope:this}}]},{itemId:"colorEditor",width:200,margin:"0 0 0 5",html:'\x3cinput type\x3d"text" style\x3d"display: none;" /\x3e'}],buttons:[{text:this.localize("saveNewPalette"),handler:function(a){this.savePalette();a.up("window").close()},scope:this},{text:this.localize("cancel"),
handler:function(a){a.up("window").close()},scope:this}],listeners:{close:function(a){this.spectrum&&(this.spectrum.spectrum("destroy"),this.spectrum=null)},scope:this}}).show();this.initSpectrum()},setColorForSelected:function(a){if(null!==this.spectrum){a=a.toRgb();a=[a.r,a.g,a.b];var b=this.editPaletteWin.down("dataview").getSelectionModel().getSelection()[0];null!=b&&b.set("color",a)}},initSpectrum:function(){if(null===this.spectrum){var a=this.editPaletteWin.down("#colorEditor").el.down("input");
this.spectrum=$(a.dom).spectrum({flat:!0,showInput:!0,showButtons:!1,preferredFormat:"hex",change:this.setColorForSelected.bind(this),move:this.setColorForSelected.bind(this)})}},loadPalette:function(a){var b=[];this.up("window").panel.getApplication().getColorPalette(a).forEach(function(a){b.push([Ext.id(),a])},this);this.paletteStore.loadData(b)},savePalette:function(){var a=[];this.paletteStore.each(function(b){a.push(b.get("color"))});var b=Ext.encode(a),c=this.up("window").panel,d=c.getCorpus().getId();
Ext.Ajax.request({url:c.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:b,corpus:d},success:function(b,d){b=Ext.util.JSON.decode(b.responseText).storedResource.id;d=this.down("combo");d.getStore().add({name:b,value:b});d.setValue(b);d.updateLayout();c.getApplication().addColorPalette(b,a)},scope:this})}});Ext.define("Voyant.widget.VoyantChart",{extend:"Ext.chart.CartesianChart",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyantchart",statics:{i18n:{},api:{tableJson:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},initComponent:function(a){a=a||{};this.on("afterrender",function(){if(a&&"tableJson"in a)Ext.apply(this,this.getConfigFromTableJson(a.tableJson));else if(this.getApiParam("tableJson")){var b=
this.getConfigFromTableJson();this.setAxes(b.axes);this.setSeries(b.series);this.setLegend(b.legend);this.setStore(b.store);this.redraw()}},this);this.callParent(arguments)},getConfigFromTableJson:function(a){a=a||this.getApiParam("tableJson");if(!a)return{};var b=JSON.parse(a);b.headers=b.headers.map(function(a){return a});1==b.headers.length&&(b.headers.push(1),b.rowKey=1,b.rows.forEach(function(a,b){a&&a.push(b)}));var c=[];b.rowKey||(b.rowKey=b.headers[0]);b.rows.forEach(function(a,d){if(a){var e=
{};e[b.rowKey]=d;a=a.forEach(function(a,c){e[b.headers[c]]=a});c.push(e)}});b.config||(b.config={});a={store:{fields:Object.keys(c[0]),data:c},axes:Ext.isArray(b.config.axes)?b.config.axes:[{},{}],series:[],legend:b.config.noLegend||3>Object.keys(c[0]).length?void 0:{docked:"top"}};b.config.axes||(b.config.axes=[{},{}]);a.axes.forEach(function(a,c){Ext.isObject(b.config.axes)?Ext.apply(a,b.config.axes):Ext.isArray(b.config.axes)&&Ext.apply(a,b.config.axes[c]);Ext.applyIf(a,{type:0==c?"numeric":"category",
position:0==c?"left":"bottom",label:0==c?{}:{rotation:{degrees:-30}}})});for(var d=0,e=b.headers.length;d<e;d++)if(b.headers[d]!=b.rowKey){var f={};b.config.series&&(Ext.isObject(b.config.series)?Ext.apply(f,b.config.series):Ext.isArray(b.config.series)&&Ext.apply(f,b.config.series[a.series.length]));Ext.applyIf(f,{type:"line",xField:b.rowKey,yField:b.headers[d],marker:{radius:2},highlightCfg:{scaling:2},tooltip:{trackMouse:!0,renderer:function(a,b,c){a.setHtml(b.get(c.series.getYField())+": "+b.get(c.series.getYField()))}}});
a.series.push(f)}return a}});Ext.define("Voyant.widget.LiveSearchGrid",{extend:"Ext.grid.Panel",searchValue:null,matches:[],currentIndex:null,searchRegExp:null,caseSensitive:!1,regExpMode:!1,matchCls:"keyword",initComponent:function(){this.callParent(arguments)},tagsRe:/<[^>]*>/gm,tagsProtect:"\u000f",onTextFieldChange:function(a,b){var c=this,d=0,e=c.view,f=c.visibleColumnManager.getColumns();e.refresh();c.searchValue=b;c.matches=[];c.currentIndex=null;null!==c.searchValue&&(c.searchRegExp=new RegExp(b,"g"+(c.caseSensitive?
"":"i")),c.store.each(function(a,b){var g=e.getNode(a);g&&Ext.Array.forEach(f,function(b){var e=Ext.fly(g).down(b.getCellInnerSelector(),!0),f;if(e&&0==b.isXType("widgetcolumn")){var k=e.innerHTML.match(c.tagsRe);var h=e.innerHTML.replace(c.tagsRe,c.tagsProtect);h=h.replace(c.searchRegExp,function(e){++d;f||(c.matches.push({record:a,column:b}),f=!0);return'\x3cspan class\x3d"'+c.matchCls+'"\x3e'+e+"\x3c/span\x3e"},c);Ext.each(k,function(a){h=h.replace(c.tagsProtect,a)});e.innerHTML=h}})},c),d&&(c.currentIndex=
0,c.gotoCurrent()));null===c.currentIndex&&c.getSelectionModel().deselectAll();a.focus()},privates:{gotoCurrent:function(){var a=this.matches[this.currentIndex];this.getNavigationModel().setPosition(a.record,a.column);this.getSelectionModel().select(a.record)}}});Ext.define("Voyant.widget.ProgressMonitor",{extend:"Ext.Base",mixins:["Voyant.util.Localization"],msgbox:void 0,statics:{i18n:{}},config:{progress:void 0,scope:void 0,success:void 0,failure:void 0,args:void 0,tool:void 0,delay:1E3,maxMillisSinceStart:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);if(!a||!a.progress||!a.progress.id)return Voyant.application.showError(this.localize("noProgress"));this.initConfig(a);this.callParent(arguments);
this.update()},update:function(){var a=this.getProgress(),b=this.getScope();b=b.localize?b.localize(a.code):this.localize(a.code);b=="["+a.code+"]"&&(b=a.message);b+=" ("+parseInt(100*a.completion)+"%)";var c=this.localize(a.status.toLowerCase());this.msgbox&&this.msgbox.msg.html==b&&this.msgbox.progressBar&&this.msgbox.progressBar.getText()==c||(this.msgbox=Ext.Msg.wait(b,this.localize("progress"),{text:c}));if("LAUNCH"==a.status||"RUNNING"==a.status){var d=this;Ext.defer(function(){Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:{tool:"progress.ProgressMonitor",id:a.id,maxMillisSinceStart:d.getMaxMillisSinceStart()}}).then(function(a,b){(a=Ext.decode(a.responseText))&&a.progress.progress?(d.setProgress(a.progress.progress),d.update()):d.finish(!1,d.localize("badProgress"))},function(a,b){d.finish(!1,a)})},this.getDelay(),this)}else this.finish("FINISHED"==a.status,b);5E3>this.getDelay()&&this.setDelay(this.getDelay()+500)},finish:function(a,b){var c=a?this.getSuccess():this.getFailure(),d=this.getArgs(),e=this.getProgress(),
f=this.getScope();this.close();c&&c.apply?c.apply(f,[a?d:b||e]):Voyant.application.showError(b)},close:function(){this.msgbox&&this.msgbox.close();this.destroy()}});Ext.define("Voyant.widget.VoyantTableTransform",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyanttabletransform",statics:{i18n:{},api:{tableHtml:void 0,tableJson:void 0,width:void 0,api:void 0}},html:"",config:{hiddenColumns:void 0},constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(a){var b=this;a=a||{};b.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.config.api&&this.config.api.tableJson&&
this.setApiParam("tableJson",this.config.api.tableJson);b.on("afterrender",function(){b.buildFromParams();var a=this.getTargetEl().down("table");if(a){var d=a.parent(),e=new Ext.ux.grid.TransformGrid(a,{width:this.getApiParam("width")||d.getWidth(),height:this.getApiParam("height")||20+24*a.query("tr").length});e.render(d);if(this.getHiddenColumns()){var f={};Ext.Array.from(this.getHiddenColumns()).forEach(function(a){f[a]=!0});e.getColumns().forEach(function(a){a.text in f&&a.hide()});Ext.defer(function(){e.setWidth(e.getEl().dom.parentNode.offsetWidth)},
10)}}},b);b.callParent(arguments)},buildFromParams:function(){var a=this.getApiParam("tableHtml"),b=this.getApiParam("tableJson");if(a)this.setHtml(a);else if(b){var c="\x3ctable\x3e\x3cthead\x3e\x3ctr\x3e";a=JSON.parse(b);a.headers?a.headers.forEach(function(a){c+="\x3cth\x3e"+a+"\x3c/th\x3e"}):a.rows[0].forEach(function(a,b){c+="\x3cth\x3e"+(b+1)+"\x3c/th\x3e"});c+="\x3c/tr\x3e\x3c/thead\x3e\x3ctbody\x3e";a.rows.forEach(function(a){c+="\x3ctr\x3e";a.forEach(function(a){c+="\x3ctd\x3e"+a+"\x3c/td\x3e"});
c+="\x3c/tr\x3e"});c+="\x3c/tbody\x3e\x3c/table\x3e";this.setHtml(c);a.config&&a.config.hidden&&this.setHiddenColumns(a.config.hidden)}}});
Ext.define("Ext.ux.grid.TransformGrid",{extend:"Ext.grid.Panel",constructor:function(a,b){b=Ext.apply({},b);this.table=Ext.get(a);for(var c=b.fields||[],d=b.columns||[],e=[],f=[],g=a.query("thead th"),k=0,h=g.length,l=a.dom,m,n,p,r;k<h;++k)n=g[k],p=n.innerHTML,r="tcol-"+k,e.push(Ext.applyIf(c[k]||{},{name:r,mapping:"td:nth("+(k+1)+")/@innerHTML"})),f.push(Ext.applyIf(d[k]||{},{text:p,dataIndex:r,flex:1,tooltip:n.title,sortable:!0}));a=b.width?b.width:a.getWidth()+1;b.height&&(m=b.height);Ext.applyIf(b,
{store:{data:l,fields:e,proxy:{type:"memory",reader:{record:"tbody tr",type:"xml"}}},columns:f,width:a,height:m});this.callParent([b]);!1!==b.remove&&l.parentNode.removeChild(l)},doDestroy:function(){this.table.remove();this.tabl=null;this.callParent()}});Ext.define("Voyant.widget.CategoriesOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.categoriesoption",statics:{i18n:{}},config:{builderWin:void 0},initComponent:function(){var a=this.up("window").panel.getApiParam("categories"),b=a?[{name:a,value:a}]:[];Ext.apply(this,{layout:"hbox",items:[{xtype:"combo",queryMode:"local",triggerAction:"all",fieldLabel:this.localize("categories"),labelAlign:"right",displayField:"name",valueField:"value",store:{fields:["name",
"value"],data:b},name:"categories",value:a},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("edit"),ui:"default-toolbar",handler:function(){if(void 0===this.getBuilderWin()){var a=this.up("window").panel;a=Ext.create("Voyant.widget.CategoriesBuilder",{panel:a,height:.75*a.getApplication().getViewport().getHeight(),width:.75*a.getApplication().getViewport().getWidth()});a.on("close",function(a){a=a.getCategoriesId();if(void 0!==a){var b=this.down("combo");b.getStore().add({name:a,
value:a});b.setValue(a);this.up("window").panel.setApiParam("categories",a)}},this);this.setBuilderWin(a)}a=this.down("combo").getValue();this.getBuilderWin().setCategoriesId(a);this.getBuilderWin().show()},scope:this}]});this.callParent(arguments)}});
Ext.define("Voyant.widget.CategoriesBuilder",{extend:"Ext.window.Window",requires:["Voyant.widget.FontFamilyOption"],mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.categoriesbuilder",statics:{i18n:{title:"Categories Builder",terms:"Terms",term:"Term",rawFreq:"Count",relativeFreq:"Relative",categories:"Categories",addCategory:"Add Category",removeCategory:"Remove Category",removeTerms:"Remove Selected Terms",categoryName:"Category Name",add:"Add",cancel:"Cancel",exists:"Category already exists",
confirmRemove:"Are you sure you want to remove the category?",save:"Save",features:"Features",category:"Category",color:"Color",font:"Font",orientation:"Orientation"},api:{stopList:"auto",query:void 0},features:{color:{xtype:"colorfield",format:"#hex6"},font:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:Voyant.widget.FontFamilyOption.fonts}},orientation:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name",
"value"],data:[{name:"Horizontal",value:0},{name:"Vertical",value:90}]}}}},config:{corpus:void 0,categoriesManager:void 0,builderWin:void 0,addCategoryWin:void 0,categoriesId:void 0},closeAction:"hide",modal:!0,height:250,width:500,constructor:function(a){a=a||{};a.panel?(this.panel=a.panel,this.app=this.panel.getApplication()):window.console&&console.warn("can't find panel!");this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},initComponent:function(){Ext.apply(this,
{header:!1,layout:"fit",onEsc:Ext.emptyFn,items:{xtype:"tabpanel",title:this.localize("title"),tabBarHeaderPosition:1,items:[{layout:"border",title:this.localize("categories"),items:[{title:this.localize("terms"),split:!0,width:250,region:"west",layout:"fit",items:{itemId:"terms",xtype:"grid",store:Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this}),viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:"terms",copy:!0,enableDrop:!1,dragZone:{getDragText:function(){var a="";this.dragData.records.forEach(function(b){a+=
b.get("term")+", "});a=a.substr(0,a.length-2);20<a.length&&(a=a.substr(0,20)+"...");return a}}}},selModel:{mode:"MULTI"},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),dataIndex:"rawFreq",width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),dataIndex:"relativeFreq",renderer:function(a){return Ext.util.Format.number(1E6*a,"0,000")},width:"autoSize",hidden:!0,sortable:!0}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"}]}],listeners:{query:function(a,b){this.setApiParam("query",b);a=this.queryById("terms").getStore();a.removeAll();a.load()},scope:this}}},{title:this.localize("categories"),itemId:"categories",region:"center",xtype:"panel",layout:{type:"hbox",align:"stretch"},scrollable:"x",dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{text:this.localize("addCategory"),handler:function(){this.getAddCategoryWin().show()},scope:this},{text:this.localize("removeTerms"),
handler:function(){this.queryById("categories").query("grid").forEach(function(a){a.getStore().remove(a.getSelection())},this)},scope:this}]}],items:[]}]},{layout:"fit",itemId:"features",title:this.localize("features"),xtype:"grid",scrollable:"y",store:Ext.create("Ext.data.JsonStore",{fields:["category"]}),columns:[{text:this.localize("category"),dataIndex:"category",sortable:!1,hideable:!1,flex:1}]}]},buttons:[{text:this.localize("cancel"),handler:function(a){this.setCategoriesId(void 0);a.up("window").close()},
scope:this},{text:this.localize("save"),handler:function(a){this.processFeatures();this.setColorTermsFromCategoryFeatures();this.app.saveCategoryData().then(function(b){this.setCategoriesId(b);a.up("window").close()},function(){this.setCategoriesId(void 0);a.up("window").close()},null,this)},scope:this}],listeners:{show:function(){this.getCategoriesId()&&this.getCategoriesId()!=this.getApiParam("categories")?this.app.loadCategoryData(this.getCategoriesId()).then(function(a){this.setColorTermsFromCategoryFeatures();
this.buildCategories();this.buildFeatures()},null,null,this):(this.buildCategories(),this.buildFeatures());this.down("tabpanel").setActiveTab(0)},afterrender:function(a){a.on("loadedCorpus",function(a,c){this.setCorpus(c);this.queryById("terms").getStore().load()},a);this.panel.on("loadedCorpus",function(b,c){a.fireEvent("loadedCorpus",b,c)},a);this.panel.getCorpus&&this.panel.getCorpus()?a.fireEvent("loadedCorpus",a,this.panel.getCorpus()):this.panel.getStore&&this.panel.getStore()&&this.panel.getStore().getCorpus&&
this.panel.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,this.panel.getStore().getCorpus())},scope:this}});this.setAddCategoryWin(Ext.create("Ext.window.Window",{title:this.localize("addCategory"),modal:!0,closeAction:"hide",layout:"fit",items:{xtype:"form",width:300,defaults:{labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:this.localize("categoryName"),name:"categoryName",allowBlank:!1,validator:function(a){return void 0===this.app.getCategoryTerms(a)?!0:this.localize("exists")}.bind(this),
enableKeyEvents:!0,listeners:{keypress:function(a,b){b.getKey()===Ext.event.Event.ENTER&&a.up("form").queryById("addCategoryButton").click()},scope:this}}],buttons:[{text:this.localize("cancel"),handler:function(a){a.up("window").close()}},{itemId:"addCategoryButton",text:this.localize("add"),handler:function(a){var b=a.up("form");b.isValid()&&(b=b.getValues().categoryName,this.addCategory(b),a.up("window").close())},scope:this}]},listeners:{show:function(a){a=a.down("form").getForm();a.reset();a.clearInvalid()}}}));
this.callParent(arguments)},addCategory:function(a){this.app.addCategory(a);this.queryById("features").getStore().add({category:a});var b=[],c=this.app.getCategoryTerms(a);if(void 0!==c)for(var d=0;d<c.length;d++)b.push({term:c[d]});var e=this.queryById("categories").add({xtype:"grid",category:a,title:a,frame:!0,width:150,margin:"10 0 10 10",layout:"fit",tools:[{type:"close",tooltip:this.localize("removeCategory"),callback:function(b){Ext.Msg.confirm(this.localize("removeCategory"),this.localize("confirmRemove"),
function(b){"yes"===b&&this.removeCategory(a)},this)},scope:this}],store:Ext.create("Ext.data.JsonStore",{data:b,fields:["term"]}),viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:"terms",dragZone:{getDragText:function(){var a="";this.dragData.records.forEach(function(b){a+=b.get("term")+", "});return a.substr(0,a.length-2)}}}},selModel:{mode:"MULTI"},columns:[{dataIndex:"term",flex:1,sortable:!0}],listeners:{beforedrop:function(a,b){a=this.up("categoriesbuilder").app;for(var c=b.records.length-
1;0<=c;c--){var d=b.records[c].get("term");void 0!==a.getCategoryForTerm(d)&&b.records.splice(c,1)}},drop:function(b,c){c.view.getSelectionModel().deselectAll();this.getSelectionModel().deselectAll();b=this.up("categoriesbuilder").app;for(var d=[],e=0;e<c.records.length;e++){var f=c.records[e].get("term");void 0===b.getCategoryForTerm(f)&&d.push(f)}b.addTerms(a,d);c=c.view.up("grid");c.category&&b.removeTerms(c.category,d)}}}),f=new Ext.Editor({updateEl:!0,alignment:"l-l",autoSize:{width:"boundEl"},
field:{xtype:"textfield",allowBlank:!1,validator:function(a){return void 0===this.app.getCategoryTerms(a)||a===e.getTitle()?!0:this.localize("exists")}.bind(this)},listeners:{complete:function(a,b,c){this.app.renameCategory(c,b);this.buildFeatures()},scope:this}});e.header.getTitle().textEl.on("dblclick",function(a,b){f.startEdit(b)})},removeCategory:function(a){var b=this.queryById("categories"),c=b.queryBy(function(b){return b.category&&b.category==a?!0:!1});b.remove(c[0]);b=this.queryById("features").getStore();
b.removeAt(b.findExact("category",a));this.app.removeCategory(a)},addFeature:function(a){this.app.addFeature(a);this.buildFeatures()},buildFeatures:function(){this.queryById("features").getStore().removeAll();var a=["category"],b=[{sortable:!1,text:this.localize("category"),dataIndex:"category",flex:1}],c=[],d;for(d in this.app.getCategories())c.push({category:d});var e=this.app.getFeatures(),f=Ext.ClassManager.getClass(this).features,g;for(g in e){a.push(g);e=f[g];var k=Ext.applyIf({feature:g,listeners:{change:function(a,
b){if(a.rendered){var c=a.up("gridview").indexOf(a.el.up("table")),d=a.up("grid").getStore().getAt(c);d?d.set(a.feature,b):window.console&&console.warn("no record for",c,a)}},scope:this}},e);e.listeners&&Ext.applyIf(k.listeners,e.listeners);b.push({sortable:!1,hideable:!1,text:this.localize(g),dataIndex:g,flex:.5,xtype:"widgetcolumn",widget:k});for(d in this.app.getCategories())for(e=this.app.getCategoryFeature(d,g),k=0;k<c.length;k++)if(c[k].category==d){c[k][g]=e;break}}a=Ext.create("Ext.data.JsonStore",
{fields:a,data:c});this.queryById("features").reconfigure(a,b)},processFeatures:function(){var a=this.queryById("features").getStore(),b=Object.keys(this.app.getFeatures());a.each(function(a){var c=a.get("category");b.forEach(function(b){var d=a.get(b);void 0!==d&&this.app.setCategoryFeature(c,b,d)},this)},this)},setColorTermsFromCategoryFeatures:function(){for(var a in this.app.getCategories()){var b=this.app.getCategoryFeature(a,"color");if(void 0!==b){b=this.app.hexToRgb(b);for(var c=this.app.getCategoryTerms(a),
d=0;d<c.length;d++)this.app.setColorForTerm(c[d],b)}}},buildCategories:function(){this.queryById("categories").removeAll();var a=this.app.getCategories(),b;for(b in a)this.addCategory(b)}});Ext.define("Voyant.widget.VoyantNetworkGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],embeddable:["Voyant.widget.VoyantNetworkGraph"],alias:"widget.voyantnetworkgraph",statics:{i18n:{},api:{jsonData:void 0,docId:void 0,docIndex:void 0,json:void 0,api:void 0}},config:{vis:void 0,visLayout:void 0,nodeData:void 0,edgeData:void 0,nodeSelection:void 0,edgeSelection:void 0,currentNode:void 0,currentEdge:void 0,zoom:void 0,zoomExtent:[.25,
8],fixOnDrag:!0,nodeScaling:{minSize:8,maxSize:36,scalingFunction:void 0},edgeScaling:{minSize:1,maxSize:10,scalingFunction:void 0},graphStyle:{node:{normal:{fill:"#c6dbef",fillOpacity:1,stroke:"#6baed6",strokeOpacity:1,strokeWidth:1},highlight:{fill:"#9ecae1",fillOpacity:1,stroke:"#3182bd",strokeOpacity:1,strokeWidth:3}},edge:{normal:{stroke:"#000000",strokeOpacity:.25,strokeWidth:1},highlight:{stroke:"#000000",strokeOpacity:.5,strokeWidth:3}}},graphPhysics:{damping:.4,centralGravity:.1,nodeGravity:-50,
springLength:100,springStrength:.25,collisionScale:1.25}},constructor:function(a){a=a||{};this.setNodeData([]);this.setEdgeData([]);this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);var b={};this.getApiParam("jsonData")?b=Ext.decode(this.getApiParam("jsonData")):this.getApiParam("json")?b=this.getApiParam("json"):a.json?b=a.json:a.edges?(b.edges=a.edges,a.nodes&&(b.nodes=a.nodes)):a&&a.jsonData&&(b=JSON.parse(a.jsonData));this.loadJson(b)},initComponent:function(a){this.on("boxready",
function(a,c){this.initGraph();this.refreshGraph()},this);this.on("resize",function(a,c,d){if(a=this.body.down("svg"))d=this.body,c=d.getHeight(),d=d.getWidth(),a.dom.setAttribute("width",d),a.dom.setAttribute("height",c),this.getVisLayout().force("x",d3.forceX(d/2)).force("y",d3.forceY(c/2)),.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)},this);this.callParent(arguments)},processJson:function(a){a&&a.edges||(a&&a.links&&(a.edges=a.links,delete a.links),a&&a.edges||(a=a||{},a.edges=
[]));a.nodes||(a.nodes=[]);if(0===a.nodes.length){var b={};a.edges.forEach(function(c){["source","target"].forEach(function(d){d=c[d];0==d in b?(b[d]=1,a.nodes.push({term:d})):b[d]++;c.value=1})},this);a.nodes.forEach(function(a){Ext.applyIf(a,{value:void 0===b[a.term]?1:b[a.term]})})}else a.nodes.forEach(function(a){Ext.applyIf(a,{value:1})});return a},loadJson:function(a){this.processJson(a);var b={};this.getNodeData().forEach(function(a){b[a.term]=!0},this);var c=[],d=[];a.nodes.forEach(function(a){void 0===
b[a.term]&&(a.id=this.idGet(a.term),c.push(a))},this);a.edges.forEach(function(a){for(var b=this.idGet(a.source),c=this.idGet(a.target),e=this.getEdgeData(),h=!1,l=0;l<e.length;l++){var m=e[l];if(m.source.id==b&&m.target.id==c||m.target.id==b&&m.source.id==c){h=!0;break}}h||(a.source=b,a.target=c,a.id=b+"-"+c,d.push(a))},this);this.setNodeData(this.getNodeData().concat(c));this.setEdgeData(this.getEdgeData().concat(d));this.refreshGraph()},idGet:function(a){return a.replace(/\W/g,"_")},updateDataForNode:function(a,
b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===a){Ext.apply(c[d],b);break}},updateDataForEdge:function(a,b){for(var c=this.getEdgeData(),d=0;d<c.length;d++)if(c[d].id===a){Ext.apply(c[d],b);break}},addNode:function(a){Ext.isString(a)&&(a={term:a});a.term&&this.loadJson({nodes:[a]})},removeNode:function(a,b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===a){c.splice(d,1);break}var e={};c=this.getEdgeData();for(d=c.length-1;0<=d;d--){var f=!1;c[d].source.id===a&&(f=!0,
e[c[d].target.id]=!0);c[d].target.id===a&&(f=!0,e[c[d].source.id]=!0);f&&c.splice(d,1)}if(b){for(d=0;d<c.length;d++)e[c[d].source.id]&&delete e[c[d].source.id],e[c[d].target.id]&&delete e[c[d].target.id];for(var g in e)this.removeNode(g,!0)}this.refreshGraph()},addEdge:function(a){Ext.isObject(a)&&a.source&&a.target&&this.loadJson({edges:[a]})},removeEdge:function(a,b){for(var c=this.getEdgeData(),d=c.length-1;0<=d;d--)c[d].id===a&&c.splice(d,1);if(b){a={};c=this.getNodeData();for(d=0;d<c.length;d++)a[c[d].id]=
!0;c=this.getEdgeData();for(d=0;d<c.length;d++)a[c[d].source.id]&&delete a[c[d].source.id],a[c[d].target.id]&&delete a[c[d].target.id];for(var e in a)this.removeNode(e,!0)}this.refreshGraph()},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");var b=a.getWidth(),c=a.getHeight(),d=this.getGraphPhysics();this.setVisLayout(d3.forceSimulation().velocityDecay(d.damping).force("x",d3.forceX(b/2).strength(d.centralGravity)).force("y",d3.forceY(c/2).strength(d.centralGravity)).force("link",
d3.forceLink().id(function(a){return a.id}).distance(d.springLength).strength(d.springStrength)).force("charge",d3.forceManyBody().strength(d.nodeGravity)).force("collide",d3.forceCollide().radius(function(a){return Math.sqrt(a.bbox.width*a.bbox.height)*d.collisionScale})).on("tick",function(){this.getEdgeSelection().attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});this.getNodeSelection().attr("transform",
function(a){return"translate("+(a.x-.5*a.bbox.width)+","+(a.y-.5*a.bbox.height)+")"});.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){this.zoomToFit()}.bind(this)));a=d3.select(a.dom).append("svg").attr("width",b).attr("height",c);var e=a.append("g");b=d3.zoom().scaleExtent(this.getZoomExtent()).on("zoom",function(){e.attr("transform",d3.event.transform)});this.setZoom(b);a.call(b);this.setEdgeSelection(e.append("g").attr("class","edges").selectAll(".edge"));
this.setNodeSelection(e.append("g").attr("class","nodes").selectAll(".node"));this.setVis(e)},resetGraph:function(){this.setNodeData([]);this.setEdgeData([]);this.refreshGraph()},refreshGraph:function(){if(void 0!==this.getVisLayout()){var a=this.getEdgeData(),b=this.getNodeData(),c=d3.extent(b,function(a){return a.value});d3.sum(b,function(a){return a.value});var d=d3.extent(a,function(a){return a.value});d3.sum(a,function(a){return a.value});var e=this.getEdgeScaling();void 0===e.scalingFunction&&
(e.scalingFunction=d3.scaleLinear().domain(d).range([e.minSize,e.maxSize]));var f=this.getNodeScaling();void 0===f.scalingFunction&&(f.scalingFunction=d3.scaleLog().domain(c).range([f.minSize,f.maxSize]));c=this.getEdgeSelection().data(a,function(a){return a.id});c.exit().remove();d=c.enter().append("line").attr("class","edge").attr("id",function(a){return a.id}).style("cursor","pointer").style("stroke-width",function(a){return e.scalingFunction(a.value)}).on("mouseover",this.edgeMouseOver.bind(this)).on("mouseout",
this.edgeMouseOut.bind(this)).on("click",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentEdge(a);this.fireEvent("edgeclicked",this,a)}.bind(this));this.setEdgeSelection(d.merge(c));c=this.getNodeSelection().data(b,function(a){return a.id});c.exit().remove();d=c.enter().append("g").attr("class","node").attr("id",function(a){return a.id}).style("cursor","pointer").on("mouseover",this.nodeMouseOver.bind(this)).on("mouseout",this.nodeMouseOut.bind(this)).on("click",
function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentNode(a);this.fireEvent("nodeclicked",this,a)}.bind(this)).on("dblclick",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodedblclicked",this,a)}.bind(this)).on("contextmenu",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodecontextclicked",this,a)}.bind(this)).call(d3.drag().on("start",function(a){d3.event.active||this.getVisLayout().alphaTarget(.3).restart();
this.getFixOnDrag()&&(a.fx=a.x,a.fy=a.y);this.fireEvent("nodedragstart",this,a)}.bind(this)).on("drag",function(a){this.getFixOnDrag()?(a.fx=d3.event.x,a.fy=d3.event.y):(a.x=d3.event.x,a.y=d3.event.y);this.fireEvent("nodedrag",this,a)}.bind(this)).on("end",function(a){d3.event.active||this.getVisLayout().alphaTarget(0);this.fireEvent("nodedragend",this,a)}.bind(this)));d.append("rect");d.append("text").text(function(a){return a.term}).attr("font-size",function(a){return f.scalingFunction(a.value)+
"px"}).attr("dominant-baseline","middle").style("user-select","none").each(function(a){a.bbox=this.getBBox()});this.setNodeSelection(d.merge(c));this.getNodeSelection().selectAll("rect").attr("width",function(a){return a.bbox.width+16}).attr("height",function(a){return a.bbox.height+8}).attr("rx",function(a){return Math.max(2,.2*a.bbox.height)}).attr("ry",function(a){return Math.max(2,.2*a.bbox.height)});this.getNodeSelection().selectAll("text").attr("dx",8).attr("dy",function(a){return.5*a.bbox.height+
4});this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getVisLayout().nodes(b);this.getVisLayout().force("link").links(a);this.getVisLayout().alpha(1).restart()}},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;var k=c.getBoundingClientRect(),h=k.width;k=k.height;a=(a||.8)/Math.max(d/h,e/k);f=[h/2-a*f,k/2-a*g];d3.select(c).transition().duration(b||
500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},nodeScaling:function(a,b,c,d){return a===b?.5:Math.max(0,1/(b-a)*(d-a))},applyNodeStyle:function(a,b){b=void 0===b?"normal":b;var c=this.getGraphStyle().node[b];a.selectAll(":not(text)").style("fill",function(a){return c.fill}.bind(this)).style("fill-opacity",function(a){return c.fillOpacity}.bind(this)).style("stroke",function(a){return c.stroke}.bind(this)).style("stroke-opacity",function(a){return c.strokeOpacity}.bind(this)).style("stroke-width",
function(a){return c.strokeWidth}.bind(this))},applyEdgeStyle:function(a,b){b=void 0===b?"normal":b;var c=this.getGraphStyle().edge[b];a.style("stroke",function(a){return c.stroke}.bind(this)).style("stroke-opacity",function(a){return c.strokeOpacity}.bind(this))},edgeMouseOver:function(a){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getVis().select("#"+a.id).call(this.applyEdgeStyle.bind(this),"highlight")},edgeMouseOut:function(a){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))},
nodeMouseOver:function(a){this.setCurrentNode(a);this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getEdgeSelection().each(function(b){if(b.source.id==a.id)var c=b.target.id;else b.target.id==a.id&&(c=b.source.id);void 0!==c&&(this.getVis().select("#"+c).call(this.applyNodeStyle.bind(this),"highlight"),this.getVis().select("#"+b.id).call(this.applyEdgeStyle.bind(this),"highlight"))}.bind(this));this.getVis().select("#"+a.id).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(a){this.getNodeSelection().call(this.applyNodeStyle.bind(this));
this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))}});Ext.define("Voyant.widget.ReaderGraph",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.readergraph",statics:{i18n:{}},config:{parentPanel:void 0,corpus:void 0,documentsStore:void 0,documentTermsStore:void 0,locationMarker:void 0,isDetailedGraph:!0},locationMarkerColor:"#157fcc",DETAILED_GRAPH_DOC_LIMIT:25,LOCATION_UPDATE_FREQ:100,SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,constructor:function(a){this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"hbox"},
items:[]});this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:!0,withPositions:!0,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{load:function(a,c,d,e){a.sort("docIndex","ASC");var b={},g=0;a.each(function(a){var c=
[],d=a.get("distributions"),e=a.get("docId"),f=a.get("docIndex");a=a.get("term");for(var k=0;k<d.length;k++){var r=k,q=d[k];q>g&&(g=q);c.push([e,f,r,q,a])}b[f]=c},this);if(this.getIsDetailedGraph())for(a=this.query("cartesian"),c=0;c<a.length;c++)d=a[c],e=b[c],void 0!==e?(d.getAxes()[0].setMaximum(g),d.getStore().loadData(e)):d.getStore().removeAll()},scope:this}}));this.callParent(arguments);var a=this.findParentBy(function(a){return a.mixins["Voyant.panel.Panel"]});if(null!=a)if(this.setParentPanel(a),
a.getCorpus&&a.getCorpus())this.on("afterrender",function(b){this.setCorpus(a.getCorpus())},this);else a.on("loadedCorpus",function(a,c){this.setCorpus(c)},this),this.hasCorpusLoadedListener=!0;this.on("boxready",function(){void 0==this.getLocationMarker()&&this.setLocationMarker(Ext.DomHelper.append(this.getEl(),{tag:"div",style:"background-color: "+this.locationMarkerColor+"; height: 100%; width: 2px; position: absolute; top: 0; left: 0;"}))})},updateCorpus:function(a){var b=a.getDocuments();this.setDocumentsStore(b);
this.getDocumentTermsStore().getProxy().setExtraParam("corpus",a.getId());this.setIsDetailedGraph(b.getTotalCount()<this.DETAILED_GRAPH_DOC_LIMIT);this.generateChart(a,this)},loadQueryTerms:function(a){a&&0<a.length&&this.getDocumentTermsStore().load({params:{query:a}})},generateChart:function(a,b){function c(a,b){a=this.getParentPanel().getApplication().getColor(a);return"rgba("+a[0]+","+a[1]+","+a[2]+","+b+")"}function d(d){var e=d.index,f=d.fraction;d=d.relativeHeight;var g=c.call(this,e,.3);e=
c.call(this,e,1);b.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},flex:f,height:"100%",insetPadding:0,background:{type:"linear",degrees:90,stops:[{offset:0,color:g},{offset:d,color:g},{offset:d,color:"white"},{offset:1,color:"white"}]},axes:[{type:"numeric",position:"left",fields:"distribution",hidden:!0},{type:"category",position:"bottom",fields:"bin",hidden:!0}],series:[{type:"line",xField:"bin",yField:"distribution",style:{lineWidth:2,strokeStyle:e},tooltip:{corpus:a,trackMouse:!0,style:"background: #fff",
showDelay:0,dismissDelay:500,hideDelay:5,renderer:function(b,c,d){b.setHtml(a.getDocument(c.get("docIndex")).getTitle()+"\x3cbr\x3e"+c.get("term")+": "+c.get("distribution"))}}}],store:Ext.create("Ext.data.ArrayStore",{fields:["docId","docIndex","bin","distribution","term"],data:[]}),listeners:{itemclick:function(a,b,c){},scope:this}}).body.on("click",function(a,b){b=Ext.get(b);a=a.getX();var c=b.getBox();a=(a-c.x)/c.width;b=b.parent(".x-panel");c=b.parent();b=Ext.toArray(c.dom.children).indexOf(b.dom);
this.fireEvent("documentRelativePositionSelected",this,{docIndex:b,fraction:a})},this)}b.removeAll();for(var e=a.getDocuments(),f=a.getWordTokensCount(),g=[],k=Number.MAX_VALUE,h=-1,l=0;l<e.getCount();l++){var m=e.getAt(l),n=m.get("index");m=m.get("tokensCount-lexical");m<k&&(k=m);m>h&&(h=m);g.push({index:n,count:m,fraction:m/f})}if(this.getIsDetailedGraph())for(l=0;l<g.length;l++)m=g[l],m.relativeHeight=m.count==h?1:.25+(m.count-k)/(h-k)*.75,d.call(this,m);else b.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},
flex:1,height:"100%",insetPadding:0,axes:[{type:"numeric",position:"left",fields:"count",hidden:!0},{type:"category",position:"bottom",fields:"index",hidden:!0}],series:[{type:"bar",xField:"index",yField:"count",style:{minGapWidth:0,minBarWidth:1,lineWidth:0,strokeStyle:"none"},renderer:function(a,b,d,e){return{fillStyle:c.call(this,e,.3)}}.bind(this)}],store:Ext.create("Ext.data.JsonStore",{fields:[{name:"index",type:"int"},{name:"count",type:"int"},{name:"fraction",type:"float"}],data:g}),listeners:{itemclick:function(a,
b,c){a=Ext.get(c.getTarget());c=c.getX();a=a.getBox();var d=a.width/this.getCorpus().getDocuments().getCount();c=(c-a.x)%d/d;b=b.record.data;b=this.getDocumentsStore().getAt(b.index).getIndex();this.fireEvent("documentRelativePositionSelected",this,{docIndex:b,fraction:c})},scope:this}})},moveLocationMarker:function(a,b,c){var d=Ext.get(this.getLocationMarker()),e=d.getX();if(this.getIsDetailedGraph()){var f=this.query("cartesian")[a];f&&(e=f.getX()+f.getWidth()*b)}else f=this.down("cartesian"),e=
f.getWidth()/this.getCorpus().getDocuments().getCount(),e=f.getX()+e*a+e*b;null!=c&&(a=d.getX(),c==this.SCROLL_DOWN&&a>e||c==this.SCROLL_UP&&a<e)&&(e=a);d.setX(e)}});Ext.define("Voyant.panel.Panel",{mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.util.Toolable","Voyant.util.DetailedError"],requires:["Voyant.widget.QuerySearchField","Voyant.widget.StopListOption","Voyant.widget.CategoriesOption","Voyant.widget.TotalPropertyStatus"],alias:"widget.voyantpanel",statics:{i18n:{},config:{corpusValidated:!1},api:{corpus:void 0,input:void 0,inputFormat:void 0,subtitle:void 0}},config:{corpus:void 0},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);this.mixins["Voyant.util.Toolable"].constructor.apply(this,arguments);this.glyph||(this.glyph=Ext.ClassManager.getClass(this).glyph);this.on("afterrender",function(){"facet"!=this.getXType()&&this.getApiParam("subtitle")&&this.getTitle()&&this.setTitle(this.getTitle()+" \x3ci style\x3d'font-size: smaller;'\x3e"+this.getApiParam("subtitle")+"\x3c/i\x3e");this.isXType("grid")&&(this.getSelectionModel().on("selectionchange",function(a,c){},this),this.getStore().on("beforeload",function(){this.selectedRecordsToRemember=
this.getSelection()},this),this.getStore().on("load",function(a,c){if(0<Ext.Array.from(this.selectedRecordsToRemember).length){var b={};c=Ext.Array.merge(this.selectedRecordsToRemember,c).filter(function(a){return a.getId()in b?!1:b[a.getId()]=!0});a.isBufferedStore?1==a.currentPage&&(a.data.addAll(c),a.totalCount=c.length,a.fireEvent("refresh",a)):(a.loadRecords(c),this.getSelectionModel().select(this.selectedRecordsToRemember),a.fireEvent("refresh",a),this.selectedRecordsToRemember=[])}},this))},
this);this.on({loadedCorpus:{fn:function(a,c){this.setApiParam("corpus",c.getAliasOrId());this.setCorpus(c)},priority:999,scope:this}})},getApplication:function(){return Voyant.application},getBaseUrl:function(){return this.getApplication().getBaseUrl()},openUrl:function(a){this.getApplication().openUrl.apply(this,arguments)},getTromboneUrl:function(){return this.getApplication().getTromboneUrl()},dispatchEvent:function(){var a=this.getApplication();a.dispatchEvent.apply(a,arguments)},showError:function(a,
b){Ext.isString(a)&&(a={message:a});Ext.applyIf(a,{title:this.localize("error")+" ("+this.localize("title")+")"});this.getApplication().showError(a,b)},showResponseError:function(a,b){this.getApplication().showResponseError(a,b)},toastError:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf071@FontAwesome",title:this.localize("error")});this.toast(a)},toastInfo:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf05a@FontAwesome",title:this.localize("info")});this.toast(a)},
toast:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{slideInDuration:500,shadow:!0,align:"b",anchor:this.getTargetEl()});Ext.toast(a)},hasCorpusAccess:function(a){var b=this.getApplication();if(b){var c=b.getCorpusAccess();if("ADMIN"==c||"ACCESS"==c)return!0}a||(this.getCorpus&&(a=this.getCorpus()),!a&&b.getCorpus&&(a=b.getCorpus()));return a?"NONCONSUMPTIVE"!=a.getNoPasswordAccess()&&"NONE"!=a.getNoPasswordAccess():!1}});Ext.define("Voyant.panel.VoyantTabPanel",{extend:"Ext.tab.Panel",alias:"widget.voyanttabpanel",mixins:["Voyant.panel.Panel"],statics:{i18n:{}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.callParent(arguments)},listeners:{tabchange:function(a,b){this.tools=[];this.getHeader().tools=[];this.query("toolmenu").forEach(function(a){a.destroy()});this.addTool(b.tools);this.getApplication().dispatchEvent("panelChange",
this)},afterrender:function(a){this.fireEvent("tabchange",this,this.getActiveTab())}},showOptionsClick:function(a){var b=a.getActiveTab();b.showOptionsClick&&b.showOptionsClick.apply(b,arguments)}});Ext.define("Voyant.widget.Facet",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.facet",statics:{i18n:{},api:{stopList:"auto",query:void 0}},constructor:function(a){this.callParent(arguments);Ext.applyIf(a||{},{includeTools:[],rowLines:!1,columnLines:!1,subtitle:void 0});this.mixins["Voyant.panel.Panel"].constructor.apply(this,[a])},rowLines:!1,initComponent:function(){var a=this;this.store||(this.store=new Ext.create("Voyant.data.store.CorpusFacets",{proxy:{extraParams:{facet:this.facet}},
parentPanel:this}),this.store.getProxy().on("exception",function(b,c,d,e){a.showResponseError("Unable to fetch facet: "+a.facet,response)}));Ext.applyIf(this,{emptyText:this.localize("emptyText"),hideHeaders:!0,selType:"checkboxmodel",columns:[{renderer:function(a,c,d){return"("+d.getInDocumentsCount()+") "+d.getLabel()},flex:1}]});this.callParent();this.corpus&&this.setStoreCorpus(this.corpus);this.on("loadedCorpus",function(a,c){this.setStoreCorpus(c)},this);this.on("query",function(a,c){this.setApiParam("query",
c);this.store.load({params:this.getApiParams()})})},setStoreCorpus:function(a){this.getStore()&&(this.getStore().setCorpus(a),this.getStore().load())}});Ext.define("Voyant.panel.Bubbles",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubbles",statics:{i18n:{},api:{stopList:"auto",docIndex:0,limit:100,audio:!1,speed:30},glyph:"xf06e@FontAwesome"},config:{options:{xtype:"stoplistoption"},audio:!1},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3ccanvas style\x3d"width: 100%; height: 100%"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.bubbles&&this.bubbles.frameRate(a.getValue());this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},
changecomplete:function(a,b){this.setApiParam("speed",b);this.bubbles&&this.bubbles.frameRate(b)},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.setApiParam("audio",
b);this.setAudio(b)},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.getTargetEl().dom.querySelector("canvas");var c=this;Ext.Ajax.request({url:this.getBaseUrl()+"resources/voyant/current/bubbles/bubbles.pjs"}).then(function(a){var b=c.getTargetEl().dom.querySelector("canvas");c.bubbles=new Processing(b,a.responseText);c.bubbles.size(c.getTargetEl().getWidth(),
c.getTargetEl().getHeight());c.bubbles.frameRate(c.getApiParam("speed"));c.bubbles.bindJavascript(c);c.bubbles.noLoop();c.loadDocument()})},this);this.on("resize",function(){this.bubbles&&this.bubbles.size(this.body.getWidth(),this.body.getHeight())});this.on("documentselected",function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocument()})},setAudio:function(a){this.gainNode&&(this.gainNode.gain.value=a?1:0);this.callParent(arguments)},handleCurrentTerm:function(a){this.oscillator&&
(this.oscillator.frequency.value=this.terms[a]?parseInt(2E3*(this.terms[a]-this.minFreq)/(this.maxFreq-this.minFreq)):0)},handleDocFinished:function(){this.gainNode&&(this.gainNode.gain.value=0);var a=parseInt(this.getApiParam("docIndex"));a+1<this.getCorpus().getDocumentsCount()&&(this.setApiParam("docIndex",a+1),this.loadDocument())},loadDocument:function(){var a=this,b=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));this.up("tabpanel")||this.setTitle(this.localize("title")+
" \x3cspan class\x3d'subtitle'\x3e"+b.getFullLabel()+"\x3c/span\x3e");b.loadDocumentTerms(Ext.apply(this.getApiParams(["stopList"]),{limit:100})).then(function(c){a.terms={};c.each(function(b){a.terms[b.getTerm()]=b.getRawFreq()});c=Object.keys(a.terms).map(function(b){return a.terms[b]});a.minFreq=Ext.Array.min(c);a.maxFreq=Ext.Array.max(c);a.getCorpus().loadTokens({whitelist:Object.keys(a.terms),noOthers:!0,limit:0,docIndex:a.getApiParam("docIndex")}).then(function(c){var d=[];c.each(function(a){d.push(a.getTerm().toLowerCase())});
a.bubbles.setLines([b.getTitle(),d.join(" ")]);a.bubbles.loop();a.oscillator.frequency.value=150;a.gainNode.gain.value=a.getAudio()?1:0})})},initComponent:function(){Ext.Loader.loadScript(this.getBaseUrl()+"resources/processingjs/processing.min.js");var a=new (window.AudioContext||window.webkitAudioContext);this.oscillator=a.createOscillator();this.gainNode=a.createGain();this.oscillator.connect(this.gainNode);this.gainNode.connect(a.destination);this.oscillator.frequency.value=0;this.oscillator.start();
this.gainNode.gain.value=0;this.callParent(arguments)}});Ext.define("Voyant.panel.Bubblelines",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubblelines",statics:{i18n:{},api:{bins:50,query:null,stopList:"auto",docId:void 0,docIndex:void 0,maxDocs:50},glyph:"xf06e@FontAwesome"},config:{bubblelines:void 0,termStore:void 0,docTermStore:void 0,selectedDocs:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}]},termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',
"\x3c/tpl\x3e"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.setDocTermStore(b.getDocumentTerms({proxy:{extraParams:{withDistributions:"raw",withPositions:!0}},listeners:{load:function(a,b,e,f){b.forEach(function(a){var b=this.processTerms(a),c=a.get("docId");a=a.get("term");var d={};d[a]=b;this.getBubblelines().addTermsToDoc(d,c)},this);this.getBubblelines().doBubblelinesLayout()},scope:this}}));
this.isVisible()&&this.getBubblelines()&&this.initLoad()},this);this.on("activate",function(){this.getCorpus()&&Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.getDocTermsFromQuery(b)},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",b);this.getBubblelines().cache.each(function(a){a.hidden=-1===b.indexOf(a.id)});this.getBubblelines().drawGraph()},this);this.on("termsClicked",function(a,b){if(a!==this){var c=[];b.forEach(function(a){Ext.isString(a)?
c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});this.getDocTermsFromQuery(c)}},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.getDocTermsFromQuery(c)},this);this.down("#granularity").setValue(parseInt(this.getApiParam("bins")))},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"],listeners:{load:function(a,b,c,d){a=this.down("#termsView");for(c=0;c<b.length;c++)a.select(b[c],
!0)},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.getTermStore().removeAll();this.setApiParams({query:null});this.getBubblelines().removeAllTerms();this.getBubblelines().drawGraph()},scope:this},{xtype:"documentselectorbutton"},{xtype:"slider",
itemId:"granularity",fieldLabel:this.localize("granularity"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{changecomplete:function(a,b){this.setApiParams({bins:b});this.getBubblelines().bubbleSpacing=b;this.reloadTermsData()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("separateLines"),boxLabelAlign:"before",checked:!1,handler:function(a,b){this.getBubblelines().SEPARATE_LINES_FOR_TERMS=b;this.getBubblelines().lastClickedBubbles={};this.getBubblelines().setCanvasHeight();
this.getBubblelines().drawGraph()},scope:this}]}],border:!1,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,b,c,d,e,f){e.preventDefault();e.stopPropagation();a.fireEvent("itemcontextmenu",a,b,c,d,e,f);return!1},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return!1},selectionchange:function(a,b){var c=this.down("#termsView"),d=[];c.getStore().each(function(a){-1!==b.indexOf(a)?(d.push(a.get("term")),Ext.fly(c.getNodeByRecord(a)).removeCls("unselected").addCls("selected")):Ext.fly(c.getNodeByRecord(a)).removeCls("selected").addCls("unselected")});for(var e in this.getBubblelines().lastClickedBubbles){a=this.getBubblelines().lastClickedBubbles[e];for(var f in a)-1==d.indexOf(f)&&delete this.getBubblelines().lastClickedBubbles[e][f]}this.getBubblelines().termsFilter=
d;this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},itemcontextmenu:function(a,b,c,d,e){e.preventDefault();e.stopPropagation();var f=a.isSelected(c);(new Ext.menu.Menu({floating:!0,items:[{text:f?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){f?a.deselect(d):a.select(d,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(d);var b=this.getTermStore().getAt(d).get("term");this.getTermStore().removeAt(d);a.refresh();this.getBubblelines().removeTerm(b);
this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},scope:this}]})).showAt(e.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(a){a=this.down("#canvasParent");this.setBubblelines(new Bubblelines({container:a,clickHandler:this.bubbleClickHandler.bind(this)}));this.getBubblelines().bubbleSpacing=parseInt(this.getApiParam("bins"))},afterlayout:function(a){!1===this.getBubblelines().initialized&&
this.getBubblelines().initializeCanvas()},resize:function(a,b,c){this.getBubblelines().doBubblelinesLayout()},scope:this}}});this.callParent(arguments)},initLoad:function(){var a=[];this.getCorpus().getDocuments().each(function(b,c,d){c=c<this.getApiParam("maxDocs");this.getBubblelines().addDocToCache({id:b.getId(),index:b.getIndex(),title:b.getShortTitle(),totalTokens:b.get("tokensCount-lexical"),terms:{},hidden:!c});c&&a.push(b.getId())},this);this.setApiParam("docId",a);this.getCorpus().getCorpusTerms({autoload:!1}).load({callback:function(a,
c,d){var b=[];a.forEach(function(a,c){b.push(a.get("term"))},this);this.getDocTermsFromQuery(b)},scope:this,params:{limit:this.getApiParam("query")?void 0:5,stopList:this.getApiParams("stopList"),query:this.getApiParam("query")}})},getDocTermsFromQuery:function(a){a&&this.setApiParam("query",a);this.getCorpus()&&this.isVisible()&&this.getDocTermStore().load({params:this.getApiParams()})},reloadTermsData:function(){var a=[],b;for(b in this.getBubblelines().currentTerms)a.push(b);this.getDocTermsFromQuery(a)},
filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(b,c){a.push(b.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.setSelectedDocs(this.getCorpus().getDocuments().clone());var b=this.getSelectedDocs().getCount();if(10<b)for(var c=10;c<b;c++)this.getSelectedDocs().removeAt(10);a=[];this.getSelectedDocs().eachKey(function(b,c){a.push(b)},this);this.setApiParams({docId:a})}else this.setSelectedDocs(this.getCorpus().getDocuments().filterBy(function(b,
c){return-1!=a.indexOf(c)},this))},processTerms:function(a){var b=a.get("term");var c=a.get("rawFreq");var d=a.get("positions");if(0<c){var e=this.getApplication().getColorForTerm(b);-1===this.getTermStore().find("term",b)&&(this.getTermStore().loadData([[b,e]],!0),b=this.getTermStore().find("term",b),this.down("#termsView").select(b,!0));a=a.get("distributions");c={positions:d,distributions:a,rawFreq:c,color:e}}else c=!1;return c},bubbleClickHandler:function(a){this.getApplication().dispatchEvent("termsClicked",
this,a)}});Ext.define("Voyant.panel.Catalogue",{extend:"Ext.panel.Panel",requires:["Voyant.widget.Facet"],mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.catalogue",statics:{i18n:{},api:{config:void 0,stopList:"auto",facet:["facet.title","facet.author","facet.language"],title:void 0,splash:void 0,reader:"reader"},glyph:"xf1ea@FontAwesome"},config:{facets:{},matchingDocIds:[],customResultsHtml:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);Ext.apply(this,{title:this.localize("title"),layout:"hbox",items:[{layout:"vbox",height:"100%",align:"stretch",itemId:"facets",defaults:{width:250,flex:1,xtype:"facet",margin:5,border:!0,frame:!0,includeTools:{close:{type:"close",tooltip:this.localize("closeFacetTip"),callback:function(a){delete this.facets[a.facet];a.destroy();this.updateResults()},scope:this},add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}}},items:[]},{xtype:"panel",
html:a.customResultsHtml||"",flex:1,itemId:"results",height:"100%",align:"stretch",scrollable:!0,margin:5,getCorpus:function(){return this.findParentByType("panel").getCorpus()},listeners:{query:function(a,c){this.findParentByType("panel").updateResults(Ext.isString(c)?[c]:c)}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{itemId:"sendToVoyant",text:this.localize("sendToVoyantButton"),disabled:!0,handler:function(){this.mask(this.localize("exportInProgress"));var a=
this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:!0,docId:this.getMatchingDocIds()},success:function(b,d){a.unmask();b=Ext.JSON.decode(b.responseText);b=a.getBaseUrl()+"?corpus\x3d"+b.corpus.id;a.openUrl(b)},failure:function(b,d){a.unmask();me.showResponseError("Unable to export corpus: "+a.getCorpus().getId(),b)}})},scope:this},{itemId:"export",text:this.localize("downloadButton"),disabled:!0,handler:function(){this.mask(this.localize("exportInProgress"));
var a=this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:!0,docId:this.getMatchingDocIds()},success:function(b,d){a.unmask();b=Ext.JSON.decode(b.responseText);a.downloadFromCorpusId(b.corpus.id)},failure:function(b,d){a.unmask();me.showResponseError("Unable to export corpus: "+a.getCorpus().getId(),b)}})},scope:this},{xtype:"querysearchfield",width:200,flex:1},{itemId:"status",xtype:"tbtext"}]}]},{xtype:this.getApiParam("reader"),
flex:1,height:"100%",align:"stretch",header:!1}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()]));this.getCustomResultsHtml()||(this.getApiParam("splash")?(this.setCustomResultsHtml(this.getApiParam("splash")),this.updateResults()):(this.setCustomResultsHtml((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()])),
this.updateResults(),Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:"customhtml-"+c.getAliasOrId()},success:function(a,b){(a=Ext.util.JSON.decode(a.responseText))&&a.storedResource&&a.storedResource.id&&Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:"customhtml-"+c.getAliasOrId()},success:function(a,b){(a=Ext.util.JSON.decode(a.responseText))&&a.storedResource&&a.storedResource.resource&&(this.setCustomResultsHtml(a.storedResource.resource),
this.updateResults())},scope:this})},scope:this})))});this.on("afterrender",function(a){var b=this.queryById("facets");this.addFacet({facet:"lexical",includeTools:{add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}},store:new Voyant.data.store.CorpusTerms({parentPanel:this,proxy:{extraParams:{stopList:this.getApiParam("stopList")}}})},b);a=this.getApiParam("facet");Ext.isString(a)&&(a=a.split(","));a.forEach(function(a){this.addFacet({facet:a},
b)},this);(a=this.getApiParam("title"))&&this.setTitle(a)})},addFacet:function(a,b){if(!a)return this.selectFacet(function(a){this.addFacet({facet:a})});b=b||this.queryById("facets");var c=a.facet,d='\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e{inDocumentsCount}\x3c/span\x3e)\x3c/span\x3e {term}\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("rawFreqs")+'"\x3e{rawFreq}\x3c/span\x3e)\x3c/span\x3e',
e=this.localize(c+"Title");e=="["+c+"Title]"&&(e=c.replace(/^facet\./,"").replace(/^extra./,""));this.localize("matchingDocuments");Ext.applyIf(a,{title:e,collapsible:!0,facet:c,columns:[{renderer:function(a,b,c){return'\x3cspan style\x3d"font-size: smaller;"\x3e(\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("matchingDocuments")+'"\x3e'+c.getInDocumentsCount()+"\x3c/span\x3e) \x3c/span\x3e"+(c.getLabel?c.getLabel():c.getTerm()+'\x3cspan style\x3d"font-size: smaller;"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"'+
this.localize("rawFreqs")+'"\x3e'+c.getRawFreq()+"\x3c/span\x3e)\x3c/span\x3e")},flex:1}],bbar:[{xtype:"querysearchfield",width:"100%",tokenType:c.replace("facet.",""),itemTpl:d}],corpus:this.getCorpus()});var f=b.add(a);f.getSelectionModel().on("selectionchange",function(a,b){var d=[];b.forEach(function(a){d.push({facet:f.facet,label:a.getLabel?a.getLabel():a.getTerm()})});this.getFacets()[c]=d;this.updateResults()},this);f.on("query",function(a,b){this.getFacets()[f.facet]=[];this.updateResults()},
this);return f},updateResults:function(a){var b=this.getFacets();if(!a){a=[];for(facet in b)b[facet].forEach(function(b){a.push(b.facet+":"+b.label)});if(a)return this.updateResults(a)}var c=this.queryById("results").getTargetEl();c.update(this.getCustomResultsHtml()?this.getCustomResultsHtml():(new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));
this.queryById("sendToVoyant").setDisabled(!0);this.queryById("export").setDisabled(!0);if(a&&0<a.length){this.mask(this.localize("loading"));var d=this.getCorpus().getDocumentQueryMatches();d.load({params:{query:a,includeDocIds:!0},callback:function(a,f,g){this.unmask();if(a&&0<a.length){this.queryById("status").setHtml(a.length);var e="\x3cul\x3e",h=[];a.forEach(function(a){a.getDocIds().forEach(function(a){h.push(a);var f=d.getCorpus().getDocument(a),g="\x3cli id\x3d'"+c.getId()+"_"+a+"' class\x3d'cataloguedoc'\x3e";
g+="\x3ca href\x3d'#' class\x3d'cataloguedoctitle' data\x3d'"+a+"'\x3e"+f.getTitle()+"\x3c/a\x3e";for(facet in b)if(0!=b[facet].length){var k="";if("facet.title"!=facet){var l=facet.replace(/^.+?\./,"");if(a=f.get(l)){var m=Ext.isArray(a);m?k+="\x3cli\x3e"+l+"\x3cul\x3e":a=[a];a.forEach(function(a){var c=!1;b[facet].forEach(function(b){b.label==a?c=!0:-1==b.facet.indexOf("facet")&&b.label.split(/\W+/).forEach(function(b){0<b.trim().length&&-1<a.toLowerCase().indexOf(b.toLowerCase())&&(c=!0)})});k+=
"\x3cli\x3e"+(m?"":l.replace("extra.","")+": ")+(c?'\x3cspan class\x3d"keyword"\x3e'+a+"\x3c/span\x3e":a)+"\x3c/li\x3e"});m&&(k+="\x3c/ul\x3e\x3c/li\x3e")}}k&&(g+="\x3cul\x3e"+k+"\x3c/ul\x3e")}e+=g+"\x3c/li\x3e"})});e+="\x3c/ul\x3e";c.update(e);var l=this;a=c.query(".cataloguedoctitle");a.forEach(function(a){Ext.get(a).on("click",function(a,b){this.dispatchEvent("documentSelected",l,b.getAttribute("data"))},l)});1==a.length&&this.dispatchEvent("documentSelected",l,a[0].getAttribute("data"));this.queryById("status").update((new Ext.XTemplate(this.localize("queryMatches"))).apply([h.length,
this.getCorpus().getDocumentsCount()]));this.setMatchingDocIds(Ext.Array.clone(h));0<h.length&&(this.queryById("export").setDisabled(!1),this.queryById("sendToVoyant").setDisabled(!1));b.lexical&&(a=h.splice(0,5),this.loadSnippets(a,c.first().first()),h&&0<h.length&&this.loadSnippets(h))}},scope:this})}},loadSnippets:function(a,b){var c=this.queryById("results").getTargetEl(),d=this.getFacets();if(d.lexical){d=d.lexical.map(function(a){return a.facet+":"+a.label});var e=this.getCorpus().getContexts({buffered:!1});
b&&b.mask(this.localize("loadingSnippets"));e.load({method:"POST",params:{stripTags:"all",query:d,docId:a,perDocLimit:3,limit:100,accurateTotalNotNeeded:!0},scope:this,callback:function(a,d,e){b&&b.unmask();if(e&&Ext.isArray(a)&&0<a.length){var f={};a.forEach(function(a){f[a.getDocIndex()]||(f[a.getDocIndex()]=[]);f[a.getDocIndex()].push(a)});for(docIndex in f)d=this.getCorpus().getDocument(docIndex).getId(),a='\x3cli style\x3d"list-style-type: none; font-size: smaller;"\x3e'+f[docIndex].map(function(a){return a.getHighlightedContext()}).join(" \u2026 ")+
"\x3c/li\x3e",d=c.down("#"+c.getId()+"_"+d),d.query("ul")&&(a="\x3cul\x3e"+a+"\x3c/ul\x3e"),d.insertHtml("beforeEnd",a)}}})}},selectFacet:function(a){if(!this.facetsSelectionStore){var b={};this.getCorpus().getDocuments().each(function(a){for(var c in a.getData())"corpus"!=c&&0!==c.indexOf("parent")&&"-1"==c.indexOf("-lexical")&&(b[c]=!0)});b=Object.keys(b);b.sort();this.facetsSelectionStore=Ext.create("Ext.data.ArrayStore",{fields:["text"],data:b.map(function(a){return[a]})})}var c={};this.queryById("facets").items.each(function(a){c[a.facet]=
!0});this.facetsSelectionStore.filterBy(function(a){return!("facet."+a.get("text")in c)});Ext.create("Ext.window.Window",{title:this.localize("selectFacet"),modal:!0,items:{xtype:"form",width:300,items:{xtype:"combo",store:this.facetsSelectionStore,forceSelection:!0,width:300},buttons:[{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:this.localize("select"),glyph:"xf00c@FontAwesome",flex:1,handler:function(b){var c=
b.up("window").down("combo").getValue();if(c)a.call(this,"facet."+c),b.up("window").close();else return this.showError(this.localize("selectValidFacet"))},scope:this}]},bodyPadding:5}).show()}});Ext.define("Voyant.panel.Cirrus",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.cirrus",statics:{i18n:{},api:{stopList:"auto",categories:void 0,whiteList:void 0,limit:500,visible:50,terms:void 0,docId:void 0,docIndex:void 0,inlineData:void 0,fontFamily:'"Palatino Linotype", "Book Antiqua", Palatino, serif',cirrusForceFlash:!1,background:"0xffffff",fade:!0,smoothness:2,diagonals:"none"},glyph:"xf06e@FontAwesome"},config:{mode:void 0,options:[{xtype:"stoplistoption"},{xtype:"listeditor",
name:"whiteList"},{xtype:"categoriesoption"},{xtype:"fontfamilyoption"},{xtype:"colorpaletteoption"}],records:void 0,terms:void 0,cirrusId:void 0,visLayout:void 0,vis:void 0,tip:void 0,sizeAdjustment:100,minFontSize:12,largestWordSize:0,smallestWordSize:1E6},MODE_CORPUS:"corpus",MODE_DOCUMENT:"mode_document",layout:"fit",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.getApplication().addFeature("orientation",function(){return 90*
~~(2*Math.random())});this.setCirrusId(Ext.id(null,"cirrus_"))},initComponent:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:!0},{fieldLabel:this.localize("visibleTerms"),labelWidth:40,width:120,xtype:"slider",increment:25,minValue:25,maxValue:500,listeners:{afterrender:function(a){a.maxValue=this.getApiParam("limit");a.increment=parseInt(a.maxValue/50);a.setValue(this.getApiParam("visible"))},
changecomplete:function(a,c){this.setApiParams({visible:c});this.loadFromTermsRecords()},scope:this}}]}]});this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout();var a=this.getApiParam("inlineData");if(void 0!==a){if("["==a.charAt(0))var b=Ext.decode(a,!0);else if(-1<a.indexOf(":"))b=[],a.split(",").forEach(function(a){parts=a.split(":");b.push({text:parts[0],rawFreq:parseInt(parts[1])})});else{var c={};b=[];a.split(",").forEach(function(a){a in c?c[a]++:c[a]=1});for(term in c)b.push({text:term,
rawFreq:c[term]})}null!==b&&0<b.length&&(this.setApiParam("inlineData",b),this.setTerms(b),this.buildFromTerms())}},resize:function(a,b,c){this.getVisLayout()&&this.getCorpus()&&(this.setAdjustedSizes(),a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),a.down("svg").set({width:b,height:c}),this.getTerms()&&this.getVisLayout().size([b,c]).stop().words(this.getTerms()).start())},loadedCorpus:function(a,b){this.getApplication().addFeature("font",this.getApiParam("fontFamily"));this.initVisLayout();
this.getApiParam("docIndex")?this.fireEvent("documentSelected",this,b.getDocument(this.getApiParam("docIndex"))):this.getApiParam("docId")?this.fireEvent("documentSelected",this,b.getDocument(this.getApiParam("docId"))):this.loadFromCorpus(b)},corpusSelected:function(a,b){this.loadFromCorpus(b)},documentSelected:function(a,b){b&&(a=this.getCorpus(),b=a.getDocument(b),this.setApiParam("docId",b.getId()),b=b.getDocumentTerms({autoload:!1,corpus:a,pageSize:this.getApiParam("maxVisible"),parentPanel:this}),
this.loadFromDocumentTerms(b))},ensureCorpusView:function(a,b){this.getMode()!=this.MODE_CORPUS&&this.loadFromCorpus(b)}},loadFromCorpus:function(a){void 0===this.getApiParam("inlineData")&&(this.setApiParams({docId:void 0,docIndex:void 0}),this.loadFromCorpusTerms(a.getCorpusTerms({autoload:!1,pageSize:this.getApiParam("maxVisible"),parentPanel:this})))},loadFromDocumentTerms:function(a){a.load({callback:function(a,c,d){this.setMode(this.MODE_DOCUMENT);this.setRecords(c.getRecords());this.loadFromTermsRecords()},
scope:this,params:this.getApiParams()})},loadFromCorpusTerms:function(a){a.load({callback:function(a,c,d){this.setMode(this.MODE_CORPUS);this.setRecords(c.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromTermsRecords:function(){var a=this.getRecords(),b=this.getApiParam("visible");b>a.length&&(b=a.length);for(var c=[],d=0;d<b;d++)0<a[d].get("rawFreq")&&c.push({text:a[d].get("term").replace(/"/g,""),rawFreq:a[d].get("rawFreq")});this.setTerms(c);this.buildFromTerms()},
initVisLayout:function(a){if(a||void 0==this.getVisLayout())if(a=this.getApiParam("cirrusForceFlash"),"true"==a||!0===a){this.setApiParam("cirrusForceFlash",!0);a=this.getCirrusId();for(var b={id:a},c=["background","fade","smoothness","diagonals"],d=0;d<c.length;d++)b[c[d]]=this.getApiParam(c[d]);c='\x3cscript type\x3d"text/javascript" src\x3d"'+this.getApplication().getBaseUrl()+'resources/swfobject/swfobject.js"\x3e\x3c/script\x3e';this.update(c+('\x3cscript type\x3d"text/javascript"\x3ecirrusClickHandler'+
a+' \x3d function(word, value) {\n\tif (window.console \x26\x26 console.info) console.info(word, value);\n\tvar cirrusTool \x3d Ext.getCmp("'+this.id+'");\n\tcirrusTool.dispatchEvent("termsClicked", cirrusTool, [word]);\n}\ncirrusLoaded'+a+' \x3d function() {\n\tif (window.console \x26\x26 console.info) console.info("cirrus flash loaded");\n}\ncirrusPNGHandler'+a+' \x3d function(base64String) {\n\tvar cirrusTool \x3d Ext.getCmp("'+this.id+'");\n\tcirrusTool.cirrusPNGHandler(base64String);\n}\x3c/script\x3e'),
!0,function(){function a(c){if("undefined"!==typeof swfobject){var d=c.getLayout().getRenderTarget(),e=d.getWidth();d=d.getHeight();var f=c.getApplication().getBaseUrl()+"resources/cirrus/flash/Cirrus.swf";c.add({xtype:"flash",id:b.id,url:f,width:e,height:d,flashVars:b,flashParams:{menu:"false",scale:"showall",allowScriptAccess:"always",bgcolor:"#222222",wmode:"opaque"}});c.cirrusFlashApp=Ext.get(b.id).first().dom}else setTimeout(a,50,c)}a(this)},this)}else d=this.getLayout().getRenderTarget(),d.update(""),
a=d.getWidth(),c=d.getHeight(),this.setVisLayout(d3.layoutCloud().size([a,c]).overflow(!0).padding(1).rotate(function(a){return this.getApplication().getFeatureForTerm("orientation",a.text)}.bind(this)).spiral("archimedean").font(function(a){return this.getApplication().getFeatureForTerm("font",a.text)}.bind(this)).fontSize(function(a){return a.fontSize}.bind(this)).text(function(a){return a.text}).on("end",this.draw.bind(this))),d=d3.select(d.dom).append("svg").attr("id",this.getCirrusId()).attr("class",
"cirrusGraph").attr("width",a).attr("height",c),this.setVis(d.append("g").attr("transform","translate("+a/2+","+c/2+")")),void 0===this.getTip()&&this.setTip(Ext.create("Ext.tip.Tip",{}))},buildFromTerms:function(){var a=this.getTerms();if(this.rendered&&a)if(!0===this.getApiParam("cirrusForceFlash"))if(void 0!==this.cirrusFlashApp&&void 0!==this.cirrusFlashApp.clearAll){for(var b=[],c=0;c<a.length;c++){var d=a[c];!d.text&&d.term&&(d.text=d.term);b.push({word:d.text,size:d.rawFreq,label:d.rawFreq})}this.cirrusFlashApp.clearAll();
this.cirrusFlashApp.addWords(b);this.cirrusFlashApp.arrangeWords()}else Ext.defer(this.buildFromTerms,50,this);else{b=1E3;d=-1;for(c=0;c<a.length;c++){var e=a[c].rawFreq;e<b&&(b=e);e>d&&(d=e)}this.setSmallestWordSize(b);this.setLargestWordSize(d);this.setRelativeSizes();this.setAdjustedSizes();this.getVisLayout().words(a).start()}else Ext.defer(this.buildFromTerms,50,this)},draw:function(a,b){var c=this;this.getLayout().getRenderTarget();var d=this.getVisLayout().size()[0],e=this.getVisLayout().size()[1];
b=b?Math.min(d/Math.abs(b[1].x-d/2),d/Math.abs(b[0].x-d/2),e/Math.abs(b[1].y-e/2),e/Math.abs(b[0].y-e/2))/2:1;var f=d3.transition().duration(1E3);a=this.getVis().selectAll("text").data(a,function(a){return a.text});a.exit().transition(f).style("font-size","1px").remove();var g=a.enter().append("text").text(function(a){return a.text}).attr("text-anchor","middle").attr("data-freq",function(a){return a.rawFreq}).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-family",
function(a){return c.getApplication().getFeatureForTerm("font",a.text)}).style("fill",function(a){return c.getApplication().getColorForTerm(a.text,!0)}).style("font-size","1px").on("click",function(a){c.dispatchEvent("termsClicked",c,[a.text])}).on("mouseover",function(a){this.getTip().show()}.bind(this)).on("mousemove",function(a){var b=this.getTip();b.update(a.text+": "+a.rawFreq);a=Ext.get(this.getCirrusId()).dom;a=d3.mouse(a);a[1]+=30;b.setPosition(a)}.bind(this)).on("mouseout",function(a){this.getTip().hide()}.bind(this));
a.merge(g).transition(f).style("font-family",function(a){return c.getApplication().getFeatureForTerm("font",a.text)}).style("fill",function(a){return c.getApplication().getColorForTerm(a.text,!0)}).attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).style("font-size",function(a){return a.fontSize+"px"});this.getVis().transition(f).attr("transform","translate("+d/2+","+e/2+")scale("+b+")")},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)},calculateSizeAdjustment:function(){var a=
this.getTerms();if(void 0!==a){var b=this.getLayout().getRenderTarget();b=b.getWidth()*b.getHeight();1E5>b?this.setMinFontSize(8):this.setMinFontSize(12);for(var c=0,d=0;d<a.length;d++){var e=this.calculateWordArea(a[d]);c+=e}this.setSizeAdjustment(b/c)}},calculateWordArea:function(a){for(var b=Math.log(10*a.relativeSize)*Math.LOG10E,c=(b+a.relativeSize)/2,d=0,e=0;e<a.text.length;e++){var f=a.text.charAt(e);d="f"==f||"i"==f||"j"==f||"l"==f||"r"==f||"t"==f?d+b/3:"m"==f||"w"==f?d+b/(4/3):d+b/1.9}return c*
d},setAdjustedSizes:function(){this.calculateSizeAdjustment();var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b],d=this.findNewRelativeSize(c);c.fontSize=d>this.getMinFontSize()?d:this.getMinFontSize()}},setRelativeSizes:function(){var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b];c.relativeSize=this.map(c.rawFreq,this.getSmallestWordSize(),this.getLargestWordSize(),.1,1)}},findNewRelativeSize:function(a){var b=this.getSizeAdjustment();b*=this.calculateWordArea(a);
return(Math.sqrt(6)*Math.sqrt(6*Math.pow(a.text.length,2)+b*a.text.length)-6*a.text.length)/(2*a.text.length)}});Ext.define("Voyant.panel.CollocatesGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.collocatesgraph",statics:{i18n:{},api:{query:void 0,mode:void 0,limit:5,stopList:"auto",terms:void 0,context:5,centralize:void 0},glyph:"xf1e0@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],nodeData:void 0,linkData:void 0,visId:void 0,vis:void 0,visLayout:void 0,nodes:void 0,links:void 0,zoom:void 0,dragging:!1,contextMenu:void 0,currentNode:void 0,networkMode:void 0,
graphStyle:{keywordNode:{normal:{fill:"#c6dbef",stroke:"#6baed6"},highlight:{fill:"#9ecae1",stroke:"#3182bd"}},contextNode:{normal:{fill:"#fdd0a2",stroke:"#fdae6b"},highlight:{fill:"#fd9a53",stroke:"#e6550d"}},link:{normal:{stroke:"#000000",strokeOpacity:.1},highlight:{stroke:"#000000",strokeOpacity:.5}}},graphPhysics:{defaultMode:{damping:.4,centralGravity:.1,nodeGravity:-50,springLength:100,springStrength:.25,collisionScale:1.25},centralizedMode:{damping:.4,centralGravity:.1,nodeGravity:-1,springLength:200,
springStrength:1,collisionScale:1}}},DEFAULT_MODE:0,CENTRALIZED_MODE:1,constructor:function(a){this.setNodeData([]);this.setLinkData([]);this.setVisId(Ext.id(null,"links_"));this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",
handler:this.resetGraph,scope:this},this.localize("context"),{xtype:"slider",itemId:"contextSlider",minValue:3,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParam("context",a.getValue());this.getNetworkMode()===this.DEFAULT_MODE&&(a=this.getNodeData().map(function(a){return a.term}),0<a.length&&(this.setNodeData([]),this.setLinkData([]),this.refresh(),this.loadFromQuery(a)))},scope:this}}]}]});
this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"menucheckitem",text:"Fixed",itemId:"fixed",listeners:{checkchange:function(a,b,c){a=this.getCurrentNode();void 0!==a&&(c={fixed:b},b?(c.fx=a.x,c.fy=a.y):(c.fx=null,c.fy=null),this.updateDataForNode(a.id,c))},scope:this}},{xtype:"button",text:"Fetch Collocates",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==
a&&(this.getNetworkMode()===this.CENTRALIZED_MODE&&(this.resetGraph(),this.setNetworkMode(this.DEFAULT_MODE),this.setApiParam("centralize",void 0),a.start=0,a.limit=this.getApiParam("limit")),this.fetchCollocatesForNode(a))},scope:this},{xtype:"button",text:"Centralize",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==a&&this.doCentralize(a.term);this.getContextMenu().hide()},scope:this},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(a,b){b=this.getCurrentNode();
void 0!==b&&this.removeNode(b.id);a.up("menu").hide()},scope:this}]}));this.on("loadedCorpus",function(a,b){this.isVisible()&&this.initLoad()},this);this.on("activate",function(){this.getCorpus()&&0===this.getNodeData().length&&Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(a,b){this.loadFromQuery(b)},this);this.on("resize",function(a,b,c){if(a=Ext.get(this.getVisId()))c=this.body,b=c.getHeight(),c=c.getWidth(),a.el.dom.setAttribute("width",c),a.el.dom.setAttribute("height",
b),this.getVisLayout().force("x",d3.forceX(c/2)).force("y",d3.forceY(b/2)),Ext.Function.defer(this.zoomToFit,100,this)},this);this.callParent(arguments)},initLoad:function(){this.initGraph();this.setNetworkMode(this.DEFAULT_MODE);if(this.getApiParam("centralize")){this.setNetworkMode(this.CENTRALIZED_MODE);var a=this.getApiParam("centralize");this.doCentralize(a)}else{a=3;var b=this.getApiParam("query");void 0!==b&&(a=Ext.isArray(b)?b.length:b.split(",").length);this.getCorpus().getCorpusTerms({autoLoad:!1}).load({params:{limit:a,
query:b,stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")},callback:function(a,b,e){e&&this.loadFromCorpusTermRecords(a)},scope:this})}},loadFromQuery:function(a){if(Ext.isArray(a)&&0==a.length)this.setApiParam("query",void 0),this.resetGraph();else{this.setApiParams({mode:"corpus",query:a});var b=this.getApiParams();b.noCache=!0;(Ext.isString(a)?[a]:a).forEach(function(a){this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(Ext.clone(b),{query:a}),
callback:function(a,b,c){c&&this.loadFromCorpusCollocateRecords(a)},scope:this})},this)}},loadFromCorpusTermRecords:function(a){if(Ext.isArray(a)&&0<a.length){var b=[];a.forEach(function(a){b.push(a.getTerm())});this.loadFromQuery(b)}},loadFromCorpusCollocateRecords:function(a,b){if(Ext.isArray(a)){var c=this.getApiParam("limit"),d=this.getLayout().getRenderTarget(),e=d.getWidth()/2,f=d.getHeight()/2,g={};this.getNodeData().forEach(function(a){g[a.id]=!0},this);var k=[],h=[];a.forEach(function(a,
d){var l=a.getTerm(),m=a.getContextTerm(),r=a.getKeywordRawFreq(),q=a.getContextTermRawFreq(),u=r,v=q;this.getNetworkMode()===this.CENTRALIZED_MODE&&(u=0,v=Math.log(q));0==d&&(void 0===b&&(b=this.idGet(l)),void 0!==g[b]?this.updateDataForNode(b,{title:l+" ("+r+")",type:"keyword",value:u}):(g[b]=!0,d={id:b,term:l,title:l+" ("+r+")",type:"keyword",value:u,start:c,fixed:!1,x:e,y:f},k.push(d)));if(l!=m){l=this.idGet(m);void 0===g[l]&&(g[l]=!0,m={id:l,term:m,title:m+" ("+q+")",type:"context",value:v,start:0,
fixed:!1,x:e,y:f},k.push(m));m=null;q=this.getLinkData();for(v=0;v<q.length;v++)if(d=q[v],d.source.id==b&&d.target.id==l||d.source.id==l&&d.target.id==b){m=d;break}a=a.getContextTermRawFreq();null===m&&h.push({source:b,target:l,value:a,id:b+"-"+l})}},this);this.setNodeData(this.getNodeData().concat(k));this.setLinkData(this.getLinkData().concat(h));this.refresh()}},idGet:function(a){return a.replace(/\W/g,"_")},updateDataForNode:function(a,b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===
a){Ext.apply(c[d],b);break}},removeNode:function(a,b){b=this.getNodeData();for(var c=0;c<b.length;c++)if(b[c].id===a){b.splice(c,1);break}b=this.getLinkData();for(c=b.length-1;0<=c;c--)b[c].source.id!==a&&b[c].target.id!==a||b.splice(c,1);this.setApiParam("query",Ext.Array.remove(Ext.Array.from(this.getApiParam("query")),a));this.refresh()},doCentralize:function(a){this.setApiParam("centralize",a);this.resetGraph();this.setNetworkMode(this.CENTRALIZED_MODE);a={id:this.idGet(a),term:a,title:a+" (1)",
type:"keyword",value:1E3,start:0};this.setNodeData([a]);this.refresh();var b=this.getApiParam("limit");this.setApiParam("limit",150);this.fetchCollocatesForNode(a);this.setApiParam("limit",b)},applyNetworkMode:function(a){if(this.getVisLayout()){if(a===this.DEFAULT_MODE){var b=this.getGraphPhysics().defaultMode;this.getVisLayout().velocityDecay(b.damping).force("link",d3.forceLink().id(function(a){return a.id}).distance(b.springLength).strength(b.springStrength)).force("charge",d3.forceManyBody().strength(b.nodeGravity)).force("collide",
d3.forceCollide(function(a){return Math.sqrt(a.bbox.width*a.bbox.height)*b.collisionScale}))}else b=this.getGraphPhysics().centralizedMode,this.getVisLayout().velocityDecay(b.damping).force("link",d3.forceLink().id(function(a){return a.id}).distance(b.springLength).strength(b.springStrength)).force("charge",d3.forceManyBody().strength(function(a){return"keyword"===a.type?-1E4:0})).force("collide",d3.forceCollide(function(a){return"keyword"===a.type?a.value:Math.sqrt(a.bbox.width*a.bbox.height)*b.collisionScale}));
this.getVisLayout().force("x").strength(b.centralGravity);this.getVisLayout().force("y").strength(b.centralGravity)}return a},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");var b=a.getWidth(),c=a.getHeight();this.setVisLayout(d3.forceSimulation().force("x",d3.forceX(b/2)).force("y",d3.forceY(c/2)).on("tick",function(){this.getLinks().attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y});
this.getNodes().attr("transform",function(a){var b=a.x,c=a.y;if(this.getNetworkMode()===this.DEFAULT_MODE||"keyword"!==a.type)b-=.5*a.bbox.width,c-=.5*a.bbox.height;return"translate("+b+","+c+")"}.bind(this));!this.getDragging()&&.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){Ext.Function.defer(this.zoomToFit,100,this)}.bind(this)));a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("class","linksGraph").attr("width",b).attr("height",
c);var d=a.append("g");b=d3.zoom().scaleExtent([.25,4]).on("zoom",function(){d.attr("transform",d3.event.transform)});this.setZoom(b);a.call(b);a.on("click",function(){this.getContextMenu().hide()}.bind(this));this.setLinks(d.append("g").attr("class","links").selectAll(".link"));this.setNodes(d.append("g").attr("class","nodes").selectAll(".node"));this.setVis(d)},resetGraph:function(){this.setNodeData([]);this.setLinkData([]);this.setNetworkMode(this.DEFAULT_MODE);this.refresh()},refresh:function(){var a=
this,b=this.getNodeData(),c=this.getLinkData(),d=this.getLinks().data(c,function(a){return a.id});d.exit().remove();var e=d.enter().append("line").attr("class","link").attr("id",function(a){return a.id}).on("mouseover",a.linkMouseOver.bind(a)).on("mouseout",a.linkMouseOut.bind(a)).on("click",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.dispatchEvent("termsClicked",this,['"'+a.source.term+" "+a.target.term+'"~'+this.getApiParam("context")])}.bind(a)).style("cursor",
"pointer").style("stroke-width",function(b){return a.getNetworkMode()===a.DEFAULT_MODE?Math.max(1,Math.min(15,Math.sqrt(b.value))):1});this.setLinks(e.merge(d));d=this.getNodes().data(b,function(a){return a.id});d.exit().remove();e=d.enter().append("g").attr("class",function(a){return"node "+a.type}).attr("id",function(a){return a.id}).on("mouseover",a.nodeMouseOver.bind(a)).on("mouseout",a.nodeMouseOut.bind(a)).on("click",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();
this.dispatchEvent("termsClicked",this,[a.term])}.bind(a)).on("dblclick",function(a){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fetchCollocatesForNode(a)}.bind(a)).on("contextmenu",function(b,c){d3.event.preventDefault();c=a.getContextMenu();c.queryById("label").setHtml(b.term);c.queryById("fixed").setChecked(b.fixed);c.showAt(d3.event.pageX+10,d3.event.pageY-50)}).call(d3.drag().on("start",function(b){a.setDragging(!0);d3.event.active||a.getVisLayout().alpha(.3).restart();
b.fx=b.x;b.fy=b.y;b.fixed=!0}).on("drag",function(b){a.getVisLayout().alpha(.3);b.fx=d3.event.x;b.fy=d3.event.y;a.isMasked()?a.isOffCanvas(d3.event.x,d3.event.y)||a.unmask():a.isOffCanvas(d3.event.x,d3.event.y)&&a.mask(a.localize("releaseToRemove"))}).on("end",function(b){a.setDragging(!1);1!=b.fixed&&(b.fx=null,b.fy=null);a.isOffCanvas(d3.event.x,d3.event.y)&&(a.unmask(),a.mask(a.localize("cleaning")),a.removeNode(b.id),a.unmask())}));e.append("title").text(function(a){return a.title});this.getNetworkMode()===
this.DEFAULT_MODE?e.append("rect").style("stroke-width",1).style("stroke-opacity",1):e.filter(function(a){return"keyword"===a.type}).append("circle").style("stroke-width",1).style("stroke-opacity",1);e.append("text").attr("font-family",function(b){return a.getApplication().getFeatureForTerm("font",b.term)}).attr("font-size",function(a){return Math.max(10,Math.sqrt(a.value))}).text(function(a){return a.term}).each(function(a){a.bbox=this.getBBox()}).style("cursor","pointer").style("user-select","none").attr("dominant-baseline",
"middle");this.setNodes(e.merge(d));this.getNetworkMode()===this.DEFAULT_MODE?(this.getVis().selectAll("rect").attr("width",function(a){return a.bbox.width+16}).attr("height",function(a){return a.bbox.height+8}).attr("rx",function(a){return Math.max(2,.2*a.bbox.height)}).attr("ry",function(a){return Math.max(2,.2*a.bbox.height)}).call(this.applyNodeStyle.bind(this)),this.getVis().selectAll("text").attr("dx",8).attr("dy",function(a){return.5*a.bbox.height+4})):(this.getVis().selectAll("circle").attr("r",
function(a){return Math.min(150,a.bbox.width)}).call(this.applyNodeStyle.bind(this)),this.getVis().selectAll("text").attr("dx",function(a){return"keyword"===a.type?.5*-a.bbox.width:8}).attr("dy",function(a){return"keyword"===a.type?0:.5*a.bbox.height+4}));this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVisLayout().nodes(b);this.getVisLayout().force("link").links(c);this.getVisLayout().alpha(1).restart()},isOffCanvas:function(a,b){var c=Ext.get(this.getVisId());return 0>
a||0>b||a>c.getWidth()||b>c.getHeight()},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;var k=c.getBoundingClientRect(),h=k.width;k=k.height;a=(a||.8)/Math.max(d/h,e/k);f=[h/2-a*f,k/2-a*g];1>d||d3.select(c).transition().duration(b||500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},applyNodeStyle:function(a,b){var c=void 0===b?"normal":b;a.style("fill",function(a){a=a.type+"Node";
return this.getGraphStyle()[a][c].fill}.bind(this));a.style("stroke",function(a){a=a.type+"Node";return this.getGraphStyle()[a][c].stroke}.bind(this))},applyLinkStyle:function(a,b){var c=void 0===b?"normal":b;a.style("stroke",function(a){return this.getGraphStyle().link[c].stroke}.bind(this));a.style("stroke-opacity",function(a){return this.getGraphStyle().link[c].strokeOpacity}.bind(this))},linkMouseOver:function(a){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVis().select("#"+
a.id).call(this.applyLinkStyle.bind(this),"highlight")},linkMouseOut:function(a){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},nodeMouseOver:function(a){this.setCurrentNode(a);this.getVis().selectAll("rect").call(this.applyNodeStyle.bind(this));this.getLinks().each(function(b){if(b.source.id==a.id)var c=b.target.id;else b.target.id==a.id&&(c=b.source.id);void 0!==c&&(this.getVis().select("#"+c+" rect").call(this.applyNodeStyle.bind(this),"highlight"),this.getVis().select("#"+
b.id).call(this.applyLinkStyle.bind(this),"highlight"))}.bind(this));this.getVis().select("#"+a.id+" rect").style("stroke-width",3).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(a){this.getContextMenu().isVisible()||this.setCurrentNode(void 0);this.getVis().selectAll("rect").style("stroke-width",1).call(this.applyNodeStyle.bind(this));this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},fetchCollocatesForNode:function(a){var b=this.getApiParam("limit"),c=
this.getApiParam("query");c=Ext.Array.from(this.getApiParam("query"));Ext.Array.include(c,a.term);this.setApiParam("query",c);this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(this.getApiParams(),{query:a.term,start:a.start,limit:b}),callback:function(c,e,f){f&&(this.updateDataForNode(a.id,{start:a.start+b}),this.loadFromCorpusCollocateRecords(c,a.id))},scope:this})}});Ext.define("Voyant.panel.Contexts",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Contexts"],alias:"widget.contexts",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:5,expand:50},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=
this;Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.ContextsBuffered",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}}}),selModel:{type:"rowmodel",listeners:{selectionchange:{fn:function(a,c){this.getApplication().dispatchEvent("termLocationClicked",this,c)},scope:this}}},plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},
{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:5,value:5,maxValue:50,increment:5,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},changecomplete:function(b,c){a.setApiParam("context",b.getValue());a.getStore().clearAndLoad({params:a.getApiParams()})}}},this.localize("expand"),{xtype:"slider",minValue:5,value:5,maxValue:500,increment:10,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("expand"))},changecomplete:function(b,
c){a.setApiParam("expand",c);b=a.getView();c=a.plugins[0].recordsExpanded;var d=b.getStore(),e;for(e in c){var f=d.getByInternalId(e),g=b.getRow(f),k=g.parentNode.childNodes[1];c[e]?b.fireEvent("expandbody",g,f,k,{force:!0}):Ext.fly(k).down(".x-grid-rowbody").setHtml("")}}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("document"),toolTip:this.localize("documentTip"),width:"autoSize",dataIndex:"docIndex",sortable:!0,renderer:function(a,c,d,e,f,g){return g.getCorpus().getDocument(a).getTinyLabel()}},
{text:this.localize("left"),tooltip:this.localize("leftTip"),align:"right",dataIndex:"left",sortable:!0,flex:1},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",sortable:!0,width:"autoSize"},{text:this.localize("right"),tooltip:this.localize("rightTip"),dataIndex:"right",sortable:!0,flex:1},{text:this.localize("position"),tooltip:this.localize("positionTip"),dataIndex:"position",sortable:!0,hidden:!0,flex:1}],listeners:{scope:this,corpusSelected:function(){this.getStore().getCorpus()&&
(this.setApiParams({docId:void 0,docIndex:void 0}),this.getStore().clearAndLoad())},documentsSelected:function(a,c){var b=[],e=this.getStore().getCorpus();c.forEach(function(a){b.push(e.getDocument(a).getId())},this);this.setApiParams({docId:b,docIndex:void 0});this.getStore().clearAndLoad()},documentSegmentTermClicked:{fn:function(a,c){c.term&&(params={query:c.term},c.docId?params.docId=c.docId:params.docIndex=c.docIndex?c.docIndex:0,this.setApiParams(params),this.isVisible()&&this.getStore().clearAndLoad())},
scope:this},documentIndexTermsClicked:{fn:function(a,c){var b={},e=[],f={},g=[];c.forEach(function(a){b[a.term]||(e.push(a.term),b[a.term]=!0);f[a.docIndex]||(g.push(a.docIndex),f[a.docIndex]=!0)});this.setApiParams({docId:void 0,docIndex:g,query:e});this.isVisible()&&this.getStore().clearAndLoad({params:this.getApiParams()})},scope:this},afterrender:function(a){a.getView().on("expandbody",function(b,d,e,f){if(""===e.textContent||f&&f.force){b=Ext.create("Voyant.data.store.Contexts",{stripTags:"all",
corpus:a.getStore().getCorpus()});var c=d.getData();b.load({params:{query:c.query,docIndex:c.docIndex,position:c.position,limit:1,context:a.getApiParam("expand")},callback:function(a,b,d){d&&1==a.length&&(c=a[0].getData(),Ext.fly(b.expandRow).down(".x-grid-rowbody").setHtml(c.left+" \x3cspan class\x3d'word keyword'\x3e"+c.middle+"\x3c/span\x3e "+c.right))},expandRow:e})}})}}});a.on("loadedCorpus",function(b,c){0==this.hasCorpusAccess(c)?this.mask(this.localize("limitedAccess"),"mask-no-spinner"):
c.getCorpusTerms({autoLoad:!1}).load({callback:function(a,b,c){c&&0<a.length&&(this.setApiParam("query",[a[0].getTerm()]),this.getStore().clearAndLoad({params:this.getApiParams()}))},scope:a,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList"),forTool:"contexts"}})});a.on("query",function(a,c){this.setApiParam("query",c);this.getStore().clearAndLoad({params:this.getApiParams()})},a);a.on("documentTermsClicked",function(a,c){var b=[];c.forEach(function(a){b.push({term:a.getTerm(),
docIndex:a.getDocIndex()})});this.fireEvent("documentIndexTermsClicked",this,b)});a.on("termsClicked",function(a,c){var b=[];Ext.isString(c)&&(c=[c]);c.forEach(function(a){void 0!==a.docIndex&&b.push({term:a.term,docIndex:a.docIndex})});0<b.length&&this.fireEvent("documentIndexTermsClicked",this,b)});a.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCollocates",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpuscollocates",statics:{i18n:{},api:{stopList:"auto",context:5,query:void 0,docId:void 0,docIndex:void 0,sort:"contextTermRawFreq"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){this.isVisible()&&
this.loadFromApis()});a.embedded||a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(a,c){if(this.getStore().getCorpus()){var b=[];c.forEach(function(a){b.push(a.get("term"))});this.setApiParams({query:b,docId:void 0,docIndex:void 0});this.isVisible()&&this.loadFromApis()}});this.on("documentsClicked",function(a,c){var b=[];c.forEach(function(a){b.push(a.get("id"))});this.setApiParams({docId:b,docid:void 0,query:void 0});this.isVisible()&&this.loadFromApis()});
this.on("activate",function(){this.getStore().getCorpus()&&this.loadFromApis()},this);this.on("query",function(a,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&(this.getApiParam("query")?this.getStore().clearAndLoad({params:this.getApiParams()}):this.getStore().getCorpus().getCorpusTerms({leadingBufferZone:0,autoLoad:!1}).load({callback:function(a,b,c){if(c){var d=[];a.forEach(function(a){d.push(a.getTerm())});
this.getStore().getProxy().setExtraParam("query",d);this.setApiParam("query",d);this.loadFromApis()}},scope:this,params:{limit:10,stopList:this.getApiParam("stopList")}}))},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusCollocatesBuffered",{parentPanel:this});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(a,b){var c=[],d=this.getApiParam("context");
b.forEach(function(a){c.push('"'+a.getKeyword()+" "+a.getContextTerm()+'"~'+d)});this.getApplication().dispatchEvent("termsClicked",this,c)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:1,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},changecomplete:function(b,d){a.setApiParam("context",
b.getValue());a.loadFromApis()}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize",hidden:!0},{text:this.localize("contextTerm"),dataIndex:"contextTerm",tooltip:this.localize("contextTermTip"),flex:1,sortable:!0},{text:this.localize("contextTermRawFreq"),tooltip:this.localize("contextTermRawFreqTip"),
dataIndex:"contextTermRawFreq",width:"autoSize",sortable:!0}],listeners:{scope:this,termsClicked:function(a,b){if(this.getStore().getCorpus()){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});0<c.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:c}),this.isVisible()&&this.loadFromApis())}},corpusSelected:function(){this.getStore().getCorpus()&&(this.setApiParams({docId:void 0,docIndex:void 0}),this.loadFromApis())},documentsSelected:function(a,
b){var c=[],d=this.getStore().getCorpus();b.forEach(function(a){c.push(d.getDocument(a).getId())},this);this.setApiParams({docId:c,docIndex:void 0});this.loadFromApis()}}});a.callParent(arguments);a.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.widget.CorpusTermSummary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpustermsummary",statics:{i18n:{},api:{stopList:"auto",query:void 0,limit:5}},config:{corpus:void 0,record:void 0,collocatesStore:void 0,correlationsStore:void 0,phrasesStore:void 0,documentTermsStore:void 0},cls:"corpus-term-summary",constructor:function(a){if(void 0===a.record)return console.warn("CorpusTermSummary: no config.record!"),!1;Ext.apply(this,{items:{itemId:"main",minHeight:200,
scrollable:!0,margin:5},dockedItems:{dock:"bottom",xtype:"toolbar",items:{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{boxready:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,b){this.setApiParam("limit",b);this.loadStuff()},scope:this}}},listeners:{boxready:function(){this.body.on("click",function(a){(a=a.getTarget(null,null,!0))&&"A"==a.dom.tagName&&a.hasCls("corpus-type")&&this.dispatchEvent("termsClicked",
this,[a.getHtml()])},this,{stopPropagation:!0});this.getDockedItems().forEach(function(a){a.getEl().on("click",null,this,{stopPropagation:!0})});this.loadStuff()},scope:this}});Ext.applyIf(a,{title:this.localize("title")+a.record.getTerm()});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var b=this.getRecord().store.getCorpus();this.setCorpus(b);this.setApiParam("query",this.getRecord().getTerm());this.setCollocatesStore(Ext.create("Voyant.data.store.CorpusCollocates",
{corpus:b}));this.setCorrelationsStore(Ext.create("Voyant.data.store.TermCorrelations",{corpus:b}));this.setPhrasesStore(Ext.create("Voyant.data.store.CorpusNgrams",{corpus:b}));this.setDocumentTermsStore(Ext.create("Voyant.data.store.DocumentTerms",{corpus:b}))},loadStuff:function(){this.getComponent("main").removeAll();for(var a=[],b=0;b<this.getCorpus().getDocumentsCount();b++)a[b]=b;this.getComponent("main").add({xtype:"container",cls:"section",layout:"hbox",align:"bottom",items:[{xtype:"container",
html:'\x3cdiv class\x3d"header"\x3e'+this.localize("distribution")+"\x3c/div\x3e"},{itemId:"distLine",xtype:"sparklineline",values:[],height:20,width:200}],listeners:{afterrender:function(b){b.mask(this.localize("loading"));this.getDocumentTermsStore().load({params:{query:this.getApiParam("query"),docIndex:a,withDistributions:!0,bins:2*parseInt(this.getApiParam("limit"))},callback:function(a,c,f){f&&a&&0<a.length&&(a=a.map(function(a){return a.getDistributions()}).reduce(function(a,b){return a.concat(b)}),
this.down("#distLine").setValues(a),b.unmask())},scope:this})},scope:this}});this.addSection(this.localize("collocates"),this.getCollocatesStore(),this.getApiParams(),'\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{term}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e',function(a){return{term:a.getContextTerm(),val:a.getContextTermRawFreq()}});this.addSection(this.localize("correlations"),
this.getCorrelationsStore(),this.getApiParams(),'\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{term}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e',function(a){return{term:a.get("source-term"),val:a.get("source").rawFreq}});this.addSection(this.localize("phrases"),this.getPhrasesStore(),Ext.apply({minLength:3,sort:"length"},this.getApiParams()),'\x3ctpl for\x3d"."\x3e\x3cdiv\x3e\x26ldquo;{phrase}\x26rdquo;\x3c/div\x3e\x3c/tpl\x3e',
function(a){return{phrase:a.getTerm()}})},addSection:function(a,b,c,d,e){return this.getComponent("main").add({xtype:"container",html:'\x3cdiv class\x3d"header"\x3e'+a+"\x3c/div\x3e",cls:"section",listeners:{afterrender:function(a){a.mask(this.localize("loading"));b.load({params:c,callback:function(b,c,f){f&&b&&0<b.length&&(a.unmask(),Ext.dom.Helper.append(a.getTargetEl().first().first(),(new Ext.XTemplate('\x3cdiv class\x3d"contents"\x3e'+d+"\x3c/div\x3e")).apply(b.map(e))))}})},scope:this}})}});Ext.define("Voyant.panel.Correlations",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.correlations",statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",minInDocumentsCountRatio:100},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),
emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.TermCorrelationsBuffered",{parentPanel:this}),columns:[{text:this.localize("source"),tooltip:this.localize("sourceTip"),dataIndex:"source-term",sortable:!1},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"source-distributions",widget:{xtype:"sparklineline"},text:"\u2190"},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"target-distributions",widget:{xtype:"sparklineline"},
text:"\u2192",align:"right"},{text:this.localize("target"),tooltip:this.localize("targetTip"),dataIndex:"target-term",sortable:!1},{text:this.localize("correlation"),tooltip:this.localize("correlationTip"),dataIndex:"correlation"},{text:this.localize("significance"),tooltip:this.localize("significanceTip"),dataIndex:"significance"}],listeners:{scope:this,corpusSelected:function(){this.setApiParams({docIndex:void 0,docId:void 0});this.getStore().getProxy().setExtraParam("tool","corpus.CorpusTermCorrelations");
this.getStore().load()},documentsSelected:function(a,c){var b=[],e=this.getStore().getCorpus();c.forEach(function(a){b.push(e.getDocument(a).getId())},this);this.setApiParams({docId:b,docIndex:void 0});this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");this.getStore().load()}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},{xtype:"tbspacer"},{xtype:"tbtext",itemId:"minInDocumentsCountRatioLabel",
text:a.localize("minInDocumentsCountRatioLabel")},{xtype:"slider",increment:5,minValue:0,maxValue:100,width:75,listeners:{afterrender:function(b){b.setValue(this.getApiParam("minInDocumentsCountRatio"));b.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(a.localize("minInDocumentsCountRatioLabel"))).apply([this.getApiParam("minInDocumentsCountRatio")]))},changecomplete:function(b,c){this.setApiParams({minInDocumentsCountRatio:c});b.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(a.localize("minInDocumentsCountRatioLabel"))).apply([c]));
this.getStore().load()},scope:this}},{xtype:"corpusdocumentselector"}]}]});a.on("loadedCorpus",function(a,c){1==c.getDocumentsCount()&&this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");this.isVisible()&&this.getStore().load()});a.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load()},this);a.on("query",function(a,c){this.setApiParam("query",c);this.getStore().load()},a);a.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCreator",{extend:"Ext.form.Panel",requires:["Ext.form.field.File"],mixins:["Voyant.panel.Panel"],alias:"widget.corpuscreator",isConsumptive:!0,statics:{i18n:{},api:{inputFormat:void 0,language:void 0,xmlDocumentsXpath:void 0,xmlGroupByXpath:void 0,xmlContentXpath:void 0,xmlTitleXpath:void 0,xmlAuthorXpath:void 0,xmlPubDateXpath:void 0,xmlPublisherXpath:void 0,xmlPubPlaceXpath:void 0,xmlKeywordsXpath:void 0,xmlCollectionXpath:void 0,xmlExtraMetadataXpath:void 0,htmlGroupByQuery:void 0,
htmlDocumentsQuery:void 0,htmlContentQuery:void 0,htmlTitleQuery:void 0,htmlAuthorQuery:void 0,htmlPubDateQuery:void 0,htmlPublisherQuery:void 0,htmlPubPlaceQuery:void 0,htmlKeywordsQuery:void 0,htmlCollectionQuery:void 0,htmlExtraMetadataQuery:void 0,jsonDocumentsPointer:void 0,jsonContentPointer:void 0,jsonTitlePointer:void 0,jsonAuthorPointer:void 0,jsonPubDatePointer:void 0,jsonPublisherPointer:void 0,jsonPubPlacePointer:void 0,jsonKeywordsPointer:void 0,jsonCollectionPointer:void 0,jsonExtraMetadataPointer:void 0,
tokenization:void 0,adminPassword:void 0,accessPassword:void 0,noPasswordAccess:void 0,tableDocuments:void 0,tableContent:void 0,tableTitle:void 0,tableAuthor:void 0,title:void 0,subTitle:void 0,inputRemoveFrom:void 0,inputRemoveFromAfter:void 0,inputRemoveUntil:void 0,inputRemoveUntilAfter:void 0,sort:void 0}},constructor:function(a){this.callParent(arguments);a=a||{};this.mixins["Voyant.panel.Panel"].constructor.call(this,Ext.apply(a,{includeTools:{gear:!0,help:!0,language:this.getLanguageToolMenu()}}))},
initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),width:800,frame:!0,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},frameHeader:!0,layout:{type:"vbox",align:"stretch"},dockedItems:[{xtype:"toolbar",overflowHandler:"scroller",dock:"bottom",buttonAlign:"right",items:[{text:a.localize("Open"),glyph:"xf115@FontAwesome",tooltip:a.localize("SelectExisting"),hidden:void 0!=this.getCorpus(),handler:function(){Ext.create("Ext.window.Window",{title:a.localize("Open"),
layout:"fit",modal:!0,items:{xtype:"form",submitEmptyText:!1,margin:"5,5,5,5",items:{xtype:"corpusselector"},buttons:[{text:a.localize("Open"),glyph:"xf00c@FontAwesome",handler:function(b){b.up("form").getForm();var c=b.up("form").getForm().getValues().corpus;""!=c?(a.loadCorpus({corpus:c}),b.up("window").close()):Ext.Msg.show({title:a.localize("SelectExisting"),message:a.localize("PleaseSelectExisting"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},flex:1},{text:a.localize("cancel"),glyph:"xf00d@FontAwesome",
flex:1,handler:function(a){a.up("window").close()}}]}}).show()}},{xtype:"fileuploadfield",glyph:"xf093@FontAwesome",name:"upload",buttonOnly:!0,hideLabel:!0,ui:"default-toolbar",buttonText:a.localize("Upload"),listeners:{render:function(b){b.fileInputEl.dom.setAttribute("multiple",!0);Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("UploadLocal")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(b,c){if(c){var d=b.up("form").getForm();if(d.isValid()){c=
b.fileInputEl.dom.files;for(var e=/\.(png|gif|jpe?g|xls|mp[234a]|mpeg|exe|wmv|avi|ppt|mpg|tif|wav|mov|psd|wma|ai|bmp|pps|aif|pub|dwg|indd|swf|asf|mbd|dmg|flv)$/i,f=/\.(txt|pdf|html?|xml|docx?|rtf|pages|epub|odt|zip|jar|tar|gz|ar|cpio|bzip2|bz2|gzip|xlsx?)$/i,g=[],k=[],h=0,l=c.length;h<l;h++){var m=c[h].name;e.test(m)?g.push(m.split("/").pop()):f.test(m)||k.push(m.split("/").pop())}0<g.length||0<k.length?Ext.Msg.show({title:a.localize("fileTypesWarning"),icon:Ext.MessageBox.ERROR,message:a.localize("fileTypesMessage")+
"\x3cul\x3e"+(0<g.length?"\x3cli\x3e"+a.localize("badFiles")+g.slice(0,5).join(", ")+(5<g.length?"\u2026":"")+"\x3c/li\x3e":"")+(0<k.length?"\x3cli\x3e"+a.localize("unknownFiles")+k.slice(0,5).join(", ")+(5<k.length?"\u2026":"")+"\x3c/li\x3e":"")+"\x3c/ul\x3e"+a.localize("sureContinue"),buttons:Ext.Msg.YESNO,fn:function(c){"yes"===c?a.loadForm(d):(b.reset(),b.fileInputEl.dom.setAttribute("multiple",!0))},scope:d}):a.loadForm(d)}}}}},"-\x3e",{xtype:"button",scale:"large",glyph:"xf00d@FontAwesome",
text:this.localize("cancel"),hidden:void 0==this.getCorpus(),handler:function(a){(a=this.up("window"))&&a.isFloating()&&a.close()}},{xtype:"button",scale:"large",glyph:"xf00c@FontAwesome",text:this.localize("reveal"),ui:"default",width:200,handler:function(b){var c=b.up("form").down("#input").getValue();if(""!==c){var d=a.getApiParams();delete d.view;delete d.stopList;d.inputFormat&&0!==c.trim().indexOf("\x3c")?Ext.Msg.confirm(a.localize("error"),a.localize("errorNotXmlContinue"),function(b){"yes"==
b&&a.loadCorpus(Ext.apply(d,{input:c}))},a):a.loadCorpus(Ext.apply(d,{input:c}))}else Ext.Msg.show({title:a.localize("noTextProvided"),message:a.localize("pleaseProvideText"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}]}],items:[{html:this.getInitialConfig().addTextLabel,hidden:void 0==this.getInitialConfig().addTextLabel},{height:100,xtype:"textareafield",itemId:"input",emptyText:this.localize("emptyInput")}]});a.on("boxready",function(a){var b=this.getApplication();b.getAllowInput&&"false"==b.getAllowInput()&&
(b.getNoAllowInputText&&0<b.getNoAllowInputText().trim().length?Ext.defer(function(){var c=a.up("container");c.removeAll();c.add({frame:!1,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},html:b.getNoAllowInputText()})},100):(a.hide(),Ext.create("Ext.window.Window",{layout:"fit",header:!1,modal:!0,bodyPadding:10,items:{html:"\x3cp style\x3d'color: red;'\x3e"+a.localize("noAllowInputMessage")+"\x3c/p\x3e"}}).show()))});a.callParent(arguments)},loadForm:function(a){var b={tool:this.getCorpus()?
"corpus.CorpusMetadata":"corpus.CorpusCreator"};this.getCorpus()&&Ext.apply(b,{corpus:this.getCorpus().getId(),addDocuments:!0});var c=this.getApiParams();delete c.view;delete c.stopList;Ext.apply(b,c);var d=this.getApplication().getViewport();d.mask(this.localize("uploadingCorpus"));a.submit({url:this.getTromboneUrl(),params:b,failure:function(a,b){d.unmask();b.result&&(b.result.corpus||b.result.stepEnabledCorpusCreator)?(a={corpus:b.result.corpus?b.result.corpus.metadata.id:b.result.stepEnabledCorpusCreator.storedId},
Ext.applyIf(a,c),this.setCorpus(void 0),this.loadCorpus(a)):this.showResponseError("Unable to load corpus.",b.response)},scope:this})},loadCorpus:function(a){this.getCorpus()&&Ext.apply(a,{corpus:this.getCorpus().getId(),addDocuments:!0});var b=this.up("window");b&&b.isFloating()&&b.close();this.getApplication().loadCorpusFromParams(a)},showOptionsClick:function(a){void 0===a.optionsWin&&(a.optionsWin=Ext.create("Ext.window.Window",{title:a.localize("gearWinTitle"),closeAction:"hide",layout:"fit",
bodyPadding:10,anchor:"100% 100%",items:[{xtype:"form",defaultType:"textfield",maxHeight:a.getApplication().getViewport().getHeight()-120,scrollable:!0,fieldDefaults:{labelAlign:"right",labelWidth:110,width:350},items:[{xtype:"combo",fieldLabel:a.localize("inputFormat"),labelWidth:90,name:"inputFormat",queryMode:"local",store:[["",a.localize("inputFormatAuto")],["dtoc","DToC: Dynamic Table of Contexts"],["TEI","TEI: Text Encoding Initative"],["TEI","TEI Corpus"],["RSS","Really Simple Syndication: RSS"]],
value:"",listeners:{afterrender:{fn:function(a){var b=this.getApiParam("inputFormat");b&&a.setValue(b)},scope:a}}},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("advancedOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-titles' target\x3d'voyantdocs'\x3e"+a.localize("corpusOptions")+"\x3c/a\x3e",collapsible:!0,
collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("corpusTitle"),name:"title"},{fieldLabel:a.localize("corpusSubTitle"),name:"subTitle"},{fieldLabel:a.localize("corpusSort"),name:"sort",xtype:"combo",queryMode:"local",store:[["",a.localize("corpusSortAuto")],["TITLEASC",a.localize("corpusSortTitle")],["AUTHORASC",a.localize("corpusSortAuthor")],["PUBDATEASC",a.localize("corpusSortPubDate")]],value:"",listeners:{afterrender:{fn:function(a){var b=
this.getApiParam("sort");b&&a.setValue(b)},scope:a}}}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-text' target\x3d'voyantdocs'\x3e"+a.localize("textOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("textOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("inputRemoveUntil"),name:"inputRemoveUntil"},{fieldLabel:a.localize("inputRemoveUntilAfter"),
name:"inputRemoveUntilAfter"},{fieldLabel:a.localize("inputRemoveFrom"),name:"inputRemoveFrom"},{fieldLabel:a.localize("inputRemoveFromAfter"),name:"inputRemoveFromAfter"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml' target\x3d'voyantdocs'\x3e"+a.localize("xmlOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("xmlOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},
{fieldLabel:a.localize("xpathContent"),name:"xmlContentXpath"},{fieldLabel:a.localize("xpathTitle"),name:"xmlTitleXpath"},{fieldLabel:a.localize("xpathAuthor"),name:"xmlAuthorXpath"},{fieldLabel:a.localize("xpathDocuments"),name:"xmlDocumentsXpath"},{fieldLabel:a.localize("xpathGroupBy"),name:"xmlGroupByXpath"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"xmlPubDateXpath"},{fieldLabel:a.localize("xpathPublisher"),
name:"xmlPublisherXpath"},{fieldLabel:a.localize("xpathPubPlace"),name:"xmlPubPlaceXpath"},{fieldLabel:a.localize("xpathKeywords"),name:"xmlKeywordsXpath"},{fieldLabel:a.localize("xpathCollection"),name:"xmlCollectionXpath"},{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"xmlExtraMetadataXpath"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html' target\x3d'voyantdocs'\x3e"+a.localize("htmlOptions")+"\x3c/a\x3e",collapsible:!0,
collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("htmlOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("xpathContent"),name:"htmlContentQuery"},{fieldLabel:a.localize("xpathTitle"),name:"htmlTitleQuery"},{fieldLabel:a.localize("xpathAuthor"),name:"htmlAuthorQuery"},{fieldLabel:a.localize("xpathDocuments"),name:"htmlDocumentsQuery"},
{fieldLabel:a.localize("xpathGroupBy"),name:"htmlGroupByQuery"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"htmlPubDateQuery"},{fieldLabel:a.localize("xpathPublisher"),name:"htmlPublisherQuery"},{fieldLabel:a.localize("xpathPubPlace"),name:"htmlPubPlaceQuery"},{fieldLabel:a.localize("xpathKeywords"),name:"htmlKeywordsQuery"},{fieldLabel:a.localize("xpathCollection"),name:"htmlCollectionQuery"},
{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"htmlExtraMetadataQuery"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json' target\x3d'voyantdocs'\x3e"+a.localize("jsonOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("jsonOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json"])+"\x3c/i\x3e\x3c/p\x3e",
width:375},{fieldLabel:a.localize("xpathContent"),name:"jsonContentPointer"},{fieldLabel:a.localize("xpathTitle"),name:"jsonTitlePointer"},{fieldLabel:a.localize("xpathAuthor"),name:"jsonAuthorPointer"},{fieldLabel:a.localize("xpathDocuments"),name:"jsonDocumentsPointer"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"jsonPubDatePointer"},{fieldLabel:a.localize("xpathPublisher"),name:"jsonPublisherPointer"},
{fieldLabel:a.localize("xpathPubPlace"),name:"jsonPubPlacePointer"},{fieldLabel:a.localize("xpathKeywords"),name:"jsonKeywordsPointer"},{fieldLabel:a.localize("xpathCollection"),name:"jsonCollectionPointer"},{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"jsonExtraMetadataPointer"}]}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables' target\x3d'voyantdocs'\x3e"+a.localize("tableOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,
defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+(new Ext.Template(a.localize("tableOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables"])+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:a.localize("tableDocuments"),name:"tableDocuments",queryMode:"local",store:[["",a.localize("tableDocumentsTable")],["rows",a.localize("tableDocumentsRows")],["columns",a.localize("tableDocumentsColumns")]],forceSelection:!0,value:""},{xtype:"container",
html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableNoHeadersRowText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableNoHeadersRow"),xtype:"checkboxfield",name:"tableNoHeadersRow",inputValue:"true"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableContentText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableContent"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableContent"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("tableMetadataText")+
"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("tableAuthor"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableAuthor"},{fieldLabel:a.localize("tableTitle"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableTitle"}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-processing' target\x3d'voyantdocs'\x3e"+a.localize("processingOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,items:[{xtype:"combo",
fieldLabel:a.localize("language"),name:"language",queryMode:"local",store:[["",a._localizeClass(Voyant.widget.StopListOption,"auto")],["cn",a._localizeClass(Voyant.widget.StopListOption,"cn")],["bo",a._localizeClass(Voyant.widget.StopListOption,"bo")],["grc",a._localizeClass(Voyant.widget.StopListOption,"grc")]],forceSelection:!0,value:""},{xtype:"combo",fieldLabel:a.localize("tokenization"),name:"tokenization",queryMode:"local",store:[["",a.localize("tokenizationAuto")],["wordBoundaries",a.localize("tokenizationWordBoundaries")],
["whitespace",a.localize("tokenizationWhitespace")]],forceSelection:!0,value:""}]},{xtype:"fieldset",title:"\x3ca href\x3d'"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-access-management' target\x3d'voyantdocs'\x3e"+a.localize("accessOptions")+"\x3c/a\x3e",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("accessOptionsText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{fieldLabel:a.localize("adminPassword"),name:"adminPassword"},{fieldLabel:a.localize("accessPassword"),
name:"accessPassword"},{xtype:"container",html:"\x3cp\x3e\x3ci\x3e"+a.localize("accessModeWithoutPasswordText")+"\x3c/i\x3e\x3c/p\x3e",width:375},{xtype:"combo",fieldLabel:a.localize("accessModeWithoutPassword"),name:"noPasswordAccess",queryMode:"local",store:[["",a.localize("accessModeNonConsumptive")],["none",a.localize("accessModeNone")]],forceSelection:!0,value:""}]}]}],buttons:[{text:a.localize("ok"),handler:function(b,c){b=b.findParentByType("window");c=b.down("form");c.isValid()?(c=c.getValues(),
a.setApiParams(c),b.hide()):a.showError({message:a.localize("invalidForm")})}},{text:a.localize("cancel"),handler:function(a,c){a.findParentByType("window").hide()}}]}));a.optionsWin.showAt(a.getApplication().getViewport().getWidth()/2-200,10)},validatePositiveNumbersCsv:function(a){a=a.trim();if(0<a.length){if(/[^\d,+ ]/.test(a))return this.localize("numbersCommasOnly");if(/\d\s+\d/.test(a))return this.localize("numbersNeedCommas");a=a.split(/\s*[,+]\s*/);for(var b,c=0,d=a.length;c<d;c++){b=a[c];
if(0==b.length)return this.localize("numberEmpty");if(0==parseInt(b))return this.localize("numberZero")}}return!0}});Ext.define("Voyant.panel.DreamScape",{extend:"Ext.Panel",xtype:"dreamscape",mixins:["Voyant.panel.Panel"],statics:{i18n:{},api:{stopList:"auto",hide:[],author:void 0,title:void 0,keyword:void 0,pubDate:void 0,citiesMaxCount:500,minPopulation:1E4,citiesMinFreq:1,connectionsMaxCount:2500,connectionsMinFreq:1,millisPerAnimation:2E3,annotationsId:void 0,source:void 0,overridesId:void 0,filterHasLowerCaseForm:!0,filterIsPersonName:!0,preferredCoordinates:void 0},glyph:"xf124@FontAwesome"},config:{map:void 0,
overlay:void 0,contentEl:void 0,isOpenLayersLoaded:!1,isArcLoaded:!1,animationDelay:25,isProj4Loaded:!1,projection:void 0,filterWidgets:new Ext.util.MixedCollection,drawInteraction:void 0,drawMode:!1,baseLayers:{},annotations:void 0,annotationsLoadedIfAvailable:!1,overrides:{}},html:'\x3cdiv class\x3d"map"\x3e\x3c/div\x3e\x3cdiv class\x3d"ticker"\x3e\x3c/div\x3e',cls:"dreamscape",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);
Ext.Loader.loadScript({url:this.getBaseUrl()+"resources/openlayers/ol.js",onLoad:function(){void 0===ol.Map.prototype.getLayer&&(ol.Map.prototype.getLayer=function(a){var b=void 0;this.getLayers().forEach(function(c){a===c.get("id")&&(b=c)});return b});this.setIsOpenLayersLoaded(!0)},scope:this});Ext.Loader.loadScript({url:this.getBaseUrl()+"resources/dreamscape/arc.js",onLoad:function(){this.setIsArcLoaded(!0)},scope:this});Ext.Loader.loadScript({url:"https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js",
onLoad:function(){this.setIsProj4Loaded(!0)},scope:this});var b=this.getApiParam("annotationsId");if(b){var c=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:b},scope:this}).then(function(a){a=Ext.JSON.decode(a.responseText);a.storedResource.resource&&(a=Ext.JSON.decode(a.storedResource.resource),Ext.isString(a)&&(a=Ext.JSON.decode(a),c.setAnnotations(a)));c.getAnnotations()||c.showError(c.localize("annotationsLoadFailed"));c.setAnnotationsLoadedIfAvailable(!0)},
function(a){c.showResponseError(c.localize("annotationsLoadFailed"),a);c.setAnnotationsLoadedIfAvailable(!0)})}else this.setAnnotationsLoadedIfAvailable(!0)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var a=this.getApiParam("hide");Ext.isString(a)&&(a=a.split(","),this.setApiParam("hide"));this.getApplication().getBaseUrl();Ext.apply(this,{title:this.localize("title"),bodyBorder:!0,dockedItems:[{dock:"bottom",xtype:"toolbar",itemId:"bottomToolbar",overflowHandler:"scroller",
items:[{text:this.localize("display"),tooltip:this.localize("displayTip"),glyph:"xf013@FontAwesome",menu:{defaults:{xtype:"menucheckitem",checkHandler:function(a,c){var b=this.getMap(),e=a.getItemId();this.getFilterWidgets().each(function(a){b.getLayer(a.getId()+"-"+e).setVisible(c)});var f=Ext.Array.from(this.getApiParam("hide"));c?f=Ext.Array.remove(f,e):(f.push(e),f=Ext.Array.unique(f));this.setApiParam("hide",f);a.getMenu().setDisabled(0==c)},scope:this,checked:!0},items:[{xtype:"menuitem",text:this.localize("baseLayer"),
tooltip:this.localize("baseLayerTip"),glyph:"xf279@FontAwesome",menu:{items:[{xtype:"radiogroup",columns:1,vertical:!0,defaults:{cls:"map-menu-item",handler:function(a,c){if(c){id=a.getItemId();if(a=this.getBaseLayers()[id])a.setOpacity(1),this.getMap().getLayers().setAt(0,a);"osm"==id||"arcGIS"==id?this.getMap().getLayer("overlayLayer").setVisible(!1):this.getMap().getLayer("overlayLayer").setVisible(!0)}},listeners:{afterrender:function(a){Ext.create("Ext.tip.ToolTip",{target:a,html:'\x3cdiv class\x3d"map-menu-item-tooltip '+
a.getItemId()+'"\x3e\x3c/div\x3e',anchor:"right"})}},scope:this},items:[{boxLabel:this.localize("watercolor"),itemId:"watercolor",cls:["map-menu-item","watercolor"],checked:!0},{boxLabel:this.localize("wms4326"),cls:["map-menu-item","wms4326"],itemId:"wms4326"},{boxLabel:this.localize("osm"),cls:["map-menu-item","osm"],itemId:"osm"},{boxLabel:this.localize("arcGIS"),cls:["map-menu-item","arcGIS"],itemId:"arcGIS"}]}]}},{xtype:"menuitem",text:this.localize("projection"),tooltip:this.localize("projectionTip"),
glyph:"xf0ac@FontAwesome",menu:{items:[{xtype:"radiogroup",columns:1,vertical:!0,defaults:{handler:function(a,c){if(c){var b=this;id=a.getItemId();"webMercatorProjection"===id?this.setProjection(ol.proj.get("EPSG:3857")):"mercatorProjection"===id?this.setProjection(ol.proj.get("EPSG:4326")):"gallPetersProjection"===id?(proj4.defs("cea","+proj\x3dcea +lon_0\x3d0 +lat_ts\x3d45 +x_0\x3d0 +y_0\x3d0 +ellps\x3dWGS84 +units\x3dm +no_defs"),a=ol.proj.get("cea"),this.setProjection(a)):"sphereMollweideProjection"===
id&&(proj4.defs("ESRI:54009","+proj\x3dmoll +lon_0\x3d0 +x_0\x3d0 +y_0\x3d0 +datum\x3dWGS84 +units\x3dm +no_defs"),a=ol.proj.get("ESRI:54009"),a.setExtent([-18E6,-9E6,18E6,9E6]),this.setProjection(a));a=this.getProjection().getExtent();c=this.getProjection()==ol.proj.get("EPSG:4326")?360:4.007501668557849E7;a=new ol.View({projection:this.getProjection(),center:ol.extent.getCenter(a||[0,0,0,0]),maxResolution:c/b.body.dom.offsetWidth,zoom:0});var e=this.getMap();e.getLayers().forEach(function(a){a.getSource().getFeatures&&
a.getSource().getFeatures().forEach(function(a){var c=a.getGeometry().transform(e.getView().getProjection(),b.getProjection());a.setGeometry(c)})});e.setView(a)}},listeners:{afterrender:function(a){Ext.create("Ext.tip.ToolTip",{target:a,html:'\x3cdiv class\x3d"map-menu-item-tooltip '+a.getItemId()+'"\x3e\x3c/div\x3e',anchor:"right"})}},scope:this},items:[{boxLabel:this.localize("webMercatorProjection"),itemId:"webMercatorProjection",cls:["map-menu-item","webMercatorProjection"],checked:!0},{boxLabel:this.localize("mercatorProjection"),
cls:["map-menu-item","mercatorProjection"],itemId:"mercatorProjection"},{boxLabel:this.localize("gallPetersProjection"),cls:["map-menu-item","gallPetersProjection"],itemId:"gallPetersProjection"},{boxLabel:this.localize("sphereMollweideProjection"),cls:["map-menu-item","sphereMollweideProjection"],itemId:"sphereMollweideProjection"}]}]}},"-",{text:this.localize("cities"),checked:0==Ext.Array.contains(a,"cities"),itemId:"cities",menu:{defaults:{labelAlign:"right",labelWidth:140},items:[{xtype:"numberfield",
fieldLabel:this.localize("citiesMaxCount"),minValue:1,value:parseInt(this.getApiParam("citiesMaxCount")),listeners:{change:function(a,c,d){this.getFilterWidgets().each(function(b){this.setApiParam("citiesMaxCount",c);var e=b.getGeonames().getCitiesCount();c<d||c<=e?this.filterUpdate(b):b.getGeonames().hasMoreCities()?b.loadGeonames():(a.setValue(e),this.toastInfo((new Ext.XTemplate(this.localize("allNCitiesShown"))).apply([e])))},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinPopulation"),
minValue:1,value:parseInt(this.getApiParam("minPopulation")),listeners:{change:function(a,c,d){this.setApiParam("minPopulation",c);this.getFilterWidgets().each(function(a){c>d?this.filterUpdate(a):a.loadGeonames()},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinFreq"),minValue:1,value:parseInt(this.getApiParam("citiesMinFreq")),listeners:{change:function(a,c,d){this.getFilterWidgets().each(function(a){this.setApiParam("citiesMinFreq",c);c>d?this.filterUpdate(a):a.loadGeonames()},
this)},scope:this}}]}},{text:this.localize("connections"),checked:0==Ext.Array.contains(a,"connections"),itemId:"connections",menu:{defaults:{labelWidth:140,labelAlign:"right"},items:[{xtype:"numberfield",fieldLabel:this.localize("connectionsMaxCount"),minValue:1,value:parseInt(this.getApiParam("connectionsMaxCount")),listeners:{change:function(a,c,d){this.getFilterWidgets().each(function(a){this.setApiParam("connectionsMaxCount",c);c>d?this.filterUpdate(a):a.loadGeonames()},this)},scope:this}},{xtype:"numberfield",
fieldLabel:this.localize("connectionsMinFreq"),minValue:1,value:parseInt(this.getApiParam("connectionsMinFreq")),listeners:{change:function(a,c,d){this.getFilterWidgets().each(function(a){this.setApiParam("connectionsMinFreq",c);c>d?this.filterUpdate(a):a.loadGeonames()},this)},scope:this}}]}},{xtype:"menucheckitem",checked:0==Ext.Array.contains(a,"animation"),text:this.localize("animations"),itemId:"animation",menu:{defaults:{labelWidth:170,labelAlign:"right",width:280},items:[{xtype:"sliderfield",
fieldLabel:this.localize("millisPerAnimation"),value:parseInt(this.getApiParam("millisPerAnimation")),minValue:this.getAnimationDelay(),maxValue:1E4,listeners:{change:function(a,c,d){this.getFilterWidgets().each(function(a){a.setMillisPerAnimation(c);a.animate()},this)},scope:this}}]}}]}},"-",{text:this.localize("add"),itemId:"addFilter",glyph:"xf067@FontAwesome",handler:function(a){for(var b=this.getApplication().getColorPalette(this.getApiParam("palette"),!0),d=b[0],e=0,f=b.length;e<f;e++){var g=
!1;this.getFilterWidgets().each(function(a){if(a.getColor()==b[e])return g=!0,!1});if(0==g){d=b[e];break}}d=a.ownerCt.add({xtype:"geonamesfilter",corpus:this.getCorpus(),color:d,listeners:{removeFilterWidget:function(a){var b=this.getMap(),c=a.getItemId(),d=this.getFilterWidgets();["connections","cities","animation"].forEach(function(a){b.removeLayer(b.getLayer(c+"-"+a))});d.remove(a);0==d.getCount()&&this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()},filterUpdate:this.filterUpdate,
scope:this}});this.getFilterWidgets().add(d.getId(),d);a=this.getMap();f=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!0}),id:d.getId()+"-connections",visible:!0,opacity:.2,style:this.travelStyleFunction.bind(this),updateWhileAnimating:!0,updateWhileInteracting:!0});a.addLayer(f);f=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!0}),id:d.getId()+"-cities",opacity:.5,style:this.cityStyleFunction.bind(this)});a.addLayer(f);d=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,
useSpatialIndex:!0}),id:d.getId()+"-animation",style:this.animationStyleFunction.bind(this)});a.addLayer(d)},scope:this}]}]});this.on("loadedCorpus",function(a,c){this.tryInit()},this);this.callParent()},tryInit:function(){if(this.getIsOpenLayersLoaded()&&this.getIsArcLoaded()&&this.getIsProj4Loaded()&&this.getAnnotationsLoadedIfAvailable()){var a=this.body.down(".map").setId(Ext.id()),b=this,c=this.getBaseLayers();c.wms4326=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileWMS({url:"https://ahocevar.com/geoserver/wms",
crossOrigin:"",params:{LAYERS:"ne:NE1_HR_LC_SR_W_DR",TILED:!0},projection:"EPSG:4326"})});c.watercolor=new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({layer:"watercolor",projection:"EPSG:3857"})});c.osm=new ol.layer.Tile({preload:Infinity,source:new ol.source.OSM({projection:"EPSG:3857"})});c.arcGIS=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileArcGISRest({url:"https://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",projection:"EPSG:3857"})});
var d=new ol.Map({layers:[c.watercolor,new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({cacheize:2048,layer:"toner-hybrid",projection:"EPSG:3857"}),id:"overlayLayer"})],target:a.getId(),loadTilesWhileInteracting:!0,view:new ol.View({center:[0,0],maxResolution:4.007501668557849E7/b.body.dom.offsetWidth,zoom:0})});d.on("singleclick",this.handleSingleClick,this);d.on("singleclicking",function(a){var c=d.getFeaturesAtPixel(a.pixel);if(c){for(var e=0;e<c.length;e++){var f=c[e];"city"==
f.get("type")&&this.handleLocationClick(f)}f=c[0];debugger}if(c){var g=!1;c.forEach(function(c){"city"===c.get("type")&&c.get("selected")?(b.dispatchEvent("termsClicked",b,[c.get("forms").join("|")]),g=!0):"connection"===c.get("type")&&c.get("selected")&&!g&&(b.getFilterWidgets().each(function(d){d=d.getGeonames();if(null!=d){var e="\x3cul\x3e",f=-1;d.getAllConnectionOccurrences(c.get("source"),c.get("target")).forEach(function(a){a.docIndex!=f&&(f=a.docIndex,e+="\x3ch4\x3e"+b.getCorpus().getDocument(f).getFullLabel()+
":\x3c/h4\x3e");e+="\x3cli\x3e"+a.source.left+'\x3ca href\x3d"http://www.geonames.org/'+a.source.id+'" target\x3d"_blank" docIndex\x3d'+a.docIndex+" offset\x3d"+a.source.position+" location\x3d"+a.source.form+" cityId\x3d"+a.source.id+" coordinates\x3d"+JSON.stringify(sourceCoordinates)+' class\x3d"termLocationLink"\x3e'+a.source.form+"\x3c/a\x3e "+a.source.right+" [...] "+a.target.left+'\x3ca href\x3d"http://www.geonames.org/'+a.target.id+'" target\x3d"_blank" docIndex\x3d'+a.docIndex+" offset\x3d"+
a.target.position+" location\x3d"+a.target.form+" cityId\x3d"+a.target.id+" coordinates\x3d"+JSON.stringify(targetCoordinates)+' class\x3d"termLocationLink"\x3e'+a.target.form+"\x3c/a\x3e "+a.target.right+"\x3c/li\x3e"});d=c.get("text");e+="\x3c/ul\x3e";b.getContentEl().setHtml("\x3ch3\x3e"+d+"\x3c/h3\x3e"+e);b.getOverlay().setPosition(a.coordinate);Ext.select(".termLocationLink").elements.forEach(function(a){a.onmouseover=function(){b.showTermInCorpus(a.getAttribute("docIndex"),a.getAttribute("offset"),
a.getAttribute("location"))}})}}),g=!0)},this)}});var e=new ol.layer.Vector({map:d,source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!1}),zIndex:10,selected:!0,style:function(a){if("city"===a.get("type"))return b.cityStyleFunction(a,d.getView().getResolution());if("connection"===a.get("type"))return b.travelStyleFunction(a,d.getView().getResolution())},updateWhileAnimating:!0,updateWhileInteracting:!0});a=new ol.layer.Vector({map:d,source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!1}),preview:!0,
zIndex:15,id:"preview",style:function(a){if("city"===a.get("type"))return b.cityStyleFunction(a,d.getView().getResolution());if("connection"===a.get("type"))return b.travelStyleFunction(a,d.getView().getResolution())},updateWhileAnimating:!0,updateWhileInteracting:!0});d.addLayer(a);d.on("pointermove",function(a){var c=d.getEventPixel(a.originalEvent);c=d.hasFeatureAtPixel(c);d.getViewport().style.cursor=c?"pointer":"";if(!b.getDrawMode()&&(e.getSource().clear(),c=a.pixel,c=d.getFeaturesAtPixel(c))){for(var f=
0;c[f].get("selected")&&(f++,f!==c.length););if(f<c.length){var g=c[f];c={font:"12px Calibri,sans-serif",textAlign:"center",offsetY:-15,fill:new ol.style.Fill({color:[0,0,0,1]}),stroke:new ol.style.Stroke({color:[255,255,255,.5],width:4})};c.text=g.get("text");c=new ol.style.Style({text:new ol.style.Text(c),zIndex:1});"annotation"!==g.get("type")&&(f=new ol.Feature({text:g.get("text"),geometry:g.getGeometry(),forms:g.get("forms"),selected:!0,coordinates:g.get("coordinates"),width:g.get("width"),visible:g.get("visible"),
color:g.get("color"),type:g.get("type"),confidence:g.get("confidence"),source:g.get("source"),target:g.get("target"),cityId:g.get("cityId")}),e.getSource().addFeature(f));g.getGeometry();a=new ol.Feature({geometry:new ol.geom.Point(a.coordinate),selected:!0});a.setStyle(c);e.getSource().addFeature(a);"city"===g.get("type")&&b.getMap().getLayers().forEach(function(a){var b=a.get("id");b&&-1!==b.indexOf("connections")&&(connections=a.getSource().getFeatures(),connections.forEach(function(a){a.get("target")!==
g.get("cityId")&&a.get("source")!==g.get("cityId")||e.getSource().addFeature(new ol.Feature({geometry:a.getGeometry(),selected:!0,coordinates:a.get("coordinates"),width:a.get("width"),visible:a.get("visible"),color:a.get("color"),type:a.get("type")}))}))})}}});a=new ol.source.Vector({wrapX:!1});c=new ol.layer.Vector({source:a,id:"annotations"});var f=this.getAnnotations();f&&(f=(new ol.format.GeoJSON).readFeatures(f),a.addFeatures(f));d.addLayer(c);this.setDrawInteraction(new ol.interaction.Draw({source:a,
type:"Polygon",freehand:!0,alias:"draw"}));this.getDrawInteraction().on("drawend",function(a){a.feature.set("type","annotation");b.editAnnotation(a.feature)});this.setMap(d);this.getTargetEl().down(".ol-zoom");Ext.create("Ext.Button",{glyph:"xf075@FontAwesome",cls:"annotate",renderTo:this.getTargetEl().down(".ticker").parent(),tooltip:this.localize("annotateTip"),enableToggle:!0,toggleHandler:function(a,b){b?this.getMap().addInteraction(this.getDrawInteraction()):this.getMap().removeInteraction(this.getDrawInteraction())},
scope:this});this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()}else Ext.defer(this.tryInit,500,this)},editAnnotation:function(a){var b=a.get("text");Ext.Msg.show({title:this.localize("editAnnotation"),message:this.localize("editAnnotationMessage"),buttons:Ext.Msg.OKCANCEL,multiline:!0,value:b,scope:this,callback:function(b,d){if("ok"==b){""==d?this.getMap().getLayer("annotations").getSource().removeFeature(a):a.set("text",d);b=new ol.format.GeoJSON;d=this.getMap().getLayer("annotations").getSource().getFeatures();
var c=[],f=this.getProjection();d.forEach(function(a){transformedFeature=a.clone();transformedFeature.getGeometry().transform(f?f:"EPSG:3857","EPSG:3857");c.push(transformedFeature)});b=b.writeFeatures(c);this.storeAnnotations(b)}}})},storeAnnotations:function(a){this.mask("storingAnnotations");var b=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:JSON.stringify(a)},scope:this}).then(function(a){b.unmask();a=Ext.JSON.decode(a.responseText);b.setApiParam("annotationsId",
a.storedResource.id);b.toastInfo(b.localize("annotationsUpdated"))},function(a){b.unmask();b.showResponseError(b.localize("annotationsUpdateFailed"),a)})},travelStyleFunction:function(a,b){var c=new ol.style.Stroke({color:a.get("color"),width:a.get("width")}),d=[new ol.style.Style({stroke:c})],e=a.getGeometry();a=e.getLastCoordinate();e=e.getCoordinateAt(.9);e=Math.atan2(a[1]-e[1],a[0]-e[0]);var f=new ol.geom.LineString([a,[a[0]-10*b,a[1]+10*b]]);f.rotate(e,a);b=new ol.geom.LineString([a,[a[0]-10*
b,a[1]-10*b]]);b.rotate(e,a);d.push(new ol.style.Style({geometry:f,stroke:c}));d.push(new ol.style.Style({geometry:b,stroke:c}));return d},cityStyleFunction:function(a,b){if(a.get("visible")){b=2*Math.PI*a.get("width");var c=a.get("confidence")?b*a.get("confidence"):b;return new ol.style.Style({image:new ol.style.Circle({radius:a.get("width"),fill:new ol.style.Fill({color:a.get("color")}),stroke:new ol.style.Stroke({lineDash:[c,b-c],color:"rgb(255, 255, 255)",width:2})})})}return!1},animationStyleFunction:function(a){return[new ol.style.Style({stroke:new ol.style.Stroke({color:a.get("color"),
width:5})}),new ol.style.Style({geometry:new ol.geom.Circle(a.getGeometry().getFirstCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})}),new ol.style.Style({geometry:new ol.geom.Circle(a.getGeometry().getLastCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})})]},showTermInCorpus:function(a,b,c){a=Ext.create("Voyant.data.model.Context",{docIndex:a,position:b,term:c});this.getApplication().dispatchEvent("termLocationClicked",this,[a])},reloadFilters:function(){this.getFilterWidgets().each(function(a){a.loadGeonames()},
this)},filterUpdate:function(a){var b=this;a.clearAnimation();var c=this.getMap(),d=a.getColor(),e=parseInt(this.getApiParam("citiesMaxCount")),f=0;a.getGeonames().eachCity(function(a){a.rawFreq>f&&(f=a.rawFreq)},this,e);var g=c.getLayer(a.getId()+"-cities").getSource(),k=Ext.Array.from(this.getApiParam("hide"));g.clear();var h=parseInt(this.getApiParam("minPopulation")),l=parseInt(this.getApiParam("citiesMinFreq")),m={};a.getGeonames().eachCity(function(a){if((!h||a.population>=h)&&(!l||a.rawFreq>=
l)){m[a.id]=!0;var c=[parseFloat(a.lng),parseFloat(a.lat)];a=new ol.Feature({geometry:(new ol.geom.Point(c)).transform(ol.proj.get("EPSG:4326"),b.getProjection()?b.getProjection():ol.proj.get("EPSG:3857")),text:a.label+" ("+a.rawFreq+")",description:a.label,color:d,selected:!1,width:3+20*Math.sqrt(a.rawFreq/f),visible:!0,coordinates:c,forms:a.forms,cityId:a.id,type:"city",confidence:a.confidence?100*a.confidence:void 0});g.addFeature(a)}},this,e);0<g.getFeatures().length&&c.getView().fit(g.getExtent());
c.getLayer(a.getId()+"-cities").setVisible(0==Ext.Array.contains(k,"cities"));g=c.getLayer(a.getId()+"-connections").getSource();g.clear();0==Object.keys(m).length&&this.toastInfo("No cities available for current criteria.");f=0;a.getGeonames().eachConnection(function(a){a.rawFreq>f&&(f=a.rawFreq)},this);var n=0,p=parseInt(this.getApiParam("connectionsMaxCount")),r=parseInt(this.getApiParam("connectionsMinFreq"));a.getGeonames().eachConnection(function(a){if((!r||a.rawFreq>=r)&&(!p||n<p)&&a.source.id in
m&&a.target.id in m&&(!h||a.source.population>=h&&a.target.population>=h)){var c=(new arc.GreatCircle({x:a.source.lng,y:a.source.lat},{x:a.target.lng,y:a.target.lat})).Arc(100,{offset:100}),e=a.source.label+" -\x3e "+a.target.label+" ("+a.rawFreq+")";c.geometries.forEach(function(c){c=new ol.geom.LineString(c.coords);c.transform(ol.proj.get("EPSG:4326"),b.getProjection()?b.getProjection():ol.proj.get("EPSG:3857"));c=new ol.Feature({geometry:c,text:e,color:d,width:3+10*Math.sqrt(a.rawFreq/f),source:a.source.id,
target:a.target.id,type:"connection"});g.addFeature(c)},this);n++}},this);c.getLayer(a.getId()+"-connections").setVisible(0==Ext.Array.contains(k,"connections"));a.animate()},handleSingleClick:function(a){var b=this.getMap().getFeaturesAtPixel(a.pixel);if(b)for(var c=0;c<b.length;c++){var d=b[c],e=d.get("type");if("city"==e){this.handleLocationClick(a,d);break}else if("connection"==e){this.handleConnectionClick(d,a.pixel[0],a.pixel[1]);break}else if("annotation"==e){this.editAnnotation(d);break}}},
handleConnectionClick:function(a,b,c){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewConnections"),tooltip:this.localize("viewConnectionsTip"),glyph:"xf02d@FontAwesome",handler:function(){this.mask("loadingConnections");var b=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:!0,suppressConnections:!0,sourceId:a.get("source"),targetId:a.get("target"),context:2,limit:25},scope:this}).then(function(a){b.unmask();
if((a=Ext.JSON.decode(a.responseText))&&a.dreamscape&&a.dreamscape.connectionOccurrences){var c="\x3ctable style\x3d'font-size:smaller'\x3e";a.dreamscape.connectionOccurrences.connectionOccurrences.forEach(function(a){c+="\x3ctr\x3e\x3ctd style\x3d'text-align: right'\x3e"+a.source.left+"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+a.source.term+"\x3c/td\x3e\x3ctd\x3e"+a.source.right+"\x3c/td\x3e\x3ctd\x3e\u2026\x3c/td\x3e\x3ctd style\x3d'text-align: right'\x3e"+a.target.left+
"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+a.target.term+"\x3c/td\x3e\x3ctd\x3e"+a.target.right+"\x3c/td\x3e\x3c/tr\x3e"});c+="\x3c/table\x3e";Ext.Msg.alert(b.localize("occurrences"),c)}},function(a){b.unmask();return b.showError(b.localize("occurrencesNotLoaded"))})},scope:this}]}).showAt(b,c)},handleLocationClick:function(a,b){var c=b.get("cityId");Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewOccurrences"),tooltip:this.localize("viewOccurrencesTip"),
glyph:"xf02d@FontAwesome",handler:function(){this.mask("loadingOccurrences");var a=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:!0,suppressConnections:!0,suppressConnectionOccurrences:!0,locationId:c,limit:25},scope:this}).then(function(b){a.unmask();if((b=Ext.JSON.decode(b.responseText))&&b.dreamscape&&b.dreamscape.occurrences){var c="\x3ctable style\x3d'font-size:smaller'\x3e";b.dreamscape.occurrences.occurrences.forEach(function(a){c+=
"\x3ctr\x3e\x3ctd style\x3d'text-align: right'\x3e"+a.left+"\x3c/td\x3e\x3ctd class\x3d'keyword' style\x3d'text-align: center'\x3e"+a.term+"\x3c/td\x3e\x3ctd\x3e"+a.right+"\x3c/td\x3e\x3c/tr\x3e"});c+="\x3c/table\x3e";Ext.Msg.alert(a.localize("occurrences"),c)}},function(b){a.unmask();return a.showError(a.localize("occurrencesNotLoaded"))})},scope:this},{text:this.localize("openInVoyant"),tooltip:this.localize("openInVoyantTip"),glyph:"xf08e@FontAwesome",handler:function(){this.dispatchEvent("termsClicked",
this,b.get("forms"))},scope:this},{text:this.localize("editLocation"),tooltip:this.localize("editLocationTip"),glyph:"xf124@FontAwesome",handler:function(){this.mask("loadingAlternatives");var a=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"util.Geonames",query:b.get("forms")},scope:this}).then(function(b){a.unmask();if((b=Ext.JSON.decode(b.responseText))&&b.geonames&&b.geonames.locations){var d=[];Object.values(b.geonames.locations.locations).forEach(function(a){d.push({boxLabel:a.label+
" ("+a.population+")",name:"id",inputValue:a.id,checked:a.id==c})});if(0==d.length)return a.showError(a.localize("editLocationNoLocationsFound"));if(1==d.length&&d[0].inputValue==c)return a.showError(a.localize("editLocationNoAlternativesFound"));Ext.create("Ext.window.Window",{title:a.localize("editLocation"),modal:!0,items:{xtype:"form",items:[{xtype:"radiogroup",columns:1,vertical:!0,items:d}],listeners:{afterrender:function(a){},scope:this},buttons:[{text:a.localize("cancel"),ui:"default-toolbar",
glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").destroy()}},{text:a.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(b){var d=b.up("form").getValues().id;if(d&&d!=c){var e={};e[c]=d;a.appendOverrides(e)}b.up("window").destroy()}}]}}).show()}},function(b){a.unmask();a.showResponseError(a.localize("editLocationServerError"),b)})},scope:this},{text:this.localize("removeLocation"),tooltip:this.localize("removeLocationTip"),glyph:"xf00d@FontAwesome",handler:function(){Ext.Msg.confirm(this.localize("removeLocationConfirmTitle"),
this.localize("removeLocationConfirm"),function(a){"yes"==a&&(a={},a[c]="",this.appendOverrides(a))},this)},scope:this}],listeners:{focusleave:function(a){a.destroy()}}}).showAt(a.pixel[0],a.pixel[1])},appendOverrides:function(a,b){if(this.getApiParam("overridesId")&&!b){var c=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("overridesId")},scope:this}).then(function(b){var d=Ext.JSON.decode(b.responseText);d&&d.storedResource&&
d.storedResource.resource?(b=Ext.decode(d.storedResource.resource),Ext.apply(b,a),c.appendOverrides(b,!0)):c.showResponseError(c.localize("overidesRetrieveError"),b)},function(a){c.showResponseError(c.localize("overidesRetrieveError"),a)})}else c=this,Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:Ext.encode(a)},scope:this}).then(function(a){var b=Ext.JSON.decode(a.responseText);b&&b.storedResource&&b.storedResource.id?(c.setApiParam("overridesId",
b.storedResource.id),c.reloadFilters()):c.showResponseError(c.localize("overidesRetrieveError"),a)},function(a){c.showResponseError(c.localize("overidesStorageError"),a)})}});
Ext.define("Voyant.widget.GeonamesFilter",{extend:"Ext.Button",xtype:"geonamesfilter",mixins:["Voyant.util.Localization"],statics:{i18n:{filter:"Filter",authorLabel:"authors",titleLabel:"titles",keywordLabel:"full text",pubDateLabel:"dates",loading:"Loading geographical information\u2026",disclaimer:"This is an experimental tool and the accuracy of the data is variable (\x3ca href\x3d'{url}' target\x3d'_blank'\x3esee help\x3c/a\x3e).",noDataForField:"No data seems to be available for this field so it will be disabled.",
close:"Close"}},config:{corpus:void 0,geonames:void 0,color:"#f00",timeout:void 0,currentConnectionOccurrence:void 0,animationLayer:void 0,millisPerAnimation:2E3,stepByStepMode:!1,keepAnimationInFrame:!1},constructor:function(a){a=a||{};var b=new Voyant.data.util.Geonames({corpus:a.corpus});this.setGeonames(b);var c=this;Ext.applyIf(a,{tooltip:this.localize("filterTip"),style:"background-color: white; color: "+a.color,glyph:"xf0b0@FontAwesome",menu:{defaults:{xtype:"querysearchfield",labelWidth:60,
labelAlign:"right",width:250,maxWidth:250,padding:2,listeners:{change:function(a,b){c.loadGeonames()},load:function(a,b,f,g){0==b.length&&""==g.getParams().query&&(Ext.Msg.show({buttonText:{ok:c.localize("close")},icon:Ext.MessageBox.INFO,message:c.localize("noDataForField"),buttons:Ext.Msg.OK}),this.disable())}}},items:[{fieldLabel:this.localize("authorLabel"),tokenType:"author",itemId:"author"},{fieldLabel:this.localize("titleLabel"),itemId:"title",tokenType:"title"},{fieldLabel:this.localize("keywordLabel")},
{xtype:"multislider",fieldLabel:this.localize("pubDateLabel"),itemId:"pubDate",tokenType:"pubDate",values:[0,1],hidden:!0,listeners:{afterrender:function(a){this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMASC"},callback:function(b){if(0==b.length){var c=[];this.getCorpus().each(function(a){var b=parseInt(a.getTitle());0==isNaN(b)&&c.push(parseInt(a.getTitle()))},this);1<c.length&&(a.setMinValue(c[0]),a.setMaxValue(c[c.length-1]),a.tokenType="title",a.suspendEvent("changecomplete"),
a.setValue([c[0],c[c.length-1]]),a.resumeEvent("changecomplete"),a.setVisible(!0))}else a.setMinValue(parseInt(b[0].getTerm())),this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMDESC"},callback:function(b){a.setMaxValue(parseInt(b[0].getTerm()));a.setVisible(!0)},scope:this})},scope:this})},changecomplete:function(a,b){this.loadGeonames()},scope:this}},{xtype:"fieldset",title:"Animation",items:[{xtype:"container",layout:"hbox",defaults:{xtype:"button",text:"",ui:"default-toolbar"},
items:[{glyph:"xf048@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();var a=this.getCurrentConnectionOccurrence();a=this.getGeonames().getConnectionOccurrence(a?a.index-1:0);this.setCurrentConnectionOccurrence(a);this.animate()},scope:this},{glyph:"xf04c@FontAwesome",handler:function(a){"xf04b@FontAwesome"==a.getGlyph().glyphConfig?(this.clearAnimation(),a.setGlyph(new Ext.Glyph("xf04c@FontAwesome")),this.setStepByStepMode(!1),this.animate()):(a.setGlyph(new Ext.Glyph("xf04b@FontAwesome")),
this.setStepByStepMode(!0))},scope:this},{glyph:"xf051@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();var a=this.getCurrentConnectionOccurrence();a=this.getGeonames().getConnectionOccurrence(a?a.index+1:0);this.setCurrentConnectionOccurrence(a);this.animate()},scope:this},{xtype:"tbtext",text:"\x26nbsp;\x26nbsp;"},{glyph:"xf01e@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();this.setCurrentConnectionOccurrence(this.getGeonames().getConnectionOccurrence(0));
this.animate()},scope:this}]},{xtype:"checkbox",checked:!1,handler:function(a,b){c.setKeepAnimationInFrame(b)},boxLabel:"Keep animation in frame"}]},{xtype:"container",text:"\x26nbsp;"},{xtype:"button",text:"remove",scope:this,handler:function(a){this.fireEvent("removeFilterWidget",this);a.ownerCt.ownerCmp.destroy()}}]}});this.callParent([a]);this.on("afterrender",function(a){a.getTargetEl().down(".x-btn-glyph").setStyle("color",this.getColor());var b=a.up("panel");b.mask(a.localize("loading"));a.loadGeonames().then(function(c){b.unmask();
if(1==b.getFilterWidgets().getCount()){var d=c.getCitiesCount(),e=c.getTotalCitiesCount(),f=c.getConnectionsCount();c=c.getTotalConnectionsCount();message=a.localize(d==e&&f==c?"loadedAll":"loadedSome")+"\x3cbr\x3e\x3cbr\x3e"+a.localize("disclaimer");b.toastInfo({autoCloseDelay:5E3,closable:!0,maxWidth:"90%",html:(new Ext.Template(a.localize("disclaimer"))).apply({currentCitiesCount:d,totalCitiesCount:e,currentConnectionsCount:f,totalConnectionsCount:c,url:b.getBaseUrl()+"docs/#!/guide/dreamscape"})})}})},
this)},loadGeonames:function(a){var b=this;a=a||{};var c=[];this.query("querysearchfield").forEach(function(a){var b=a.getItemId();a.getValue().forEach(function(a){c.push(b+":"+a)})});var d=this.down("multislider");if(d&&d.isVisible()){var e=d.getValue();c.push(d.tokenType+":["+e[0]+"-"+e[1]+"]")}0<c.length&&!("query"in a)&&(a.query=c);(d=this.up("panel"))&&d.getApiParams&&Ext.applyIf(a,d.getApiParams("minPopulation connectionsMaxCount connectionsMinFreq source overridesId filterHasLowerCaseForm filterIsPersonName preferredCoordinates".split(" ")));
this.mask("\u2026");var f=this.getGeonames();return f.load(a).then(function(){b.unmask();b.fireEvent("filterUpdate",b,f);return f})},clearAnimation:function(){this.getTimeout()&&clearTimeout(this.getTimeout())},animate:function(){var a=this.up("panel");if(a){this.clearAnimation();var b=this.getCurrentConnectionOccurrence();if(b){var c=this.getAnimationLayer();c||(c=this.up("panel").getMap().getLayer(this.getId()+"-animation"),this.setAnimationLayer(c));if(c){var d=c.getSource().getFeatures();if(0==
d.length){if(!a)return;var e=a.getMap().getLayer(this.getId()+"-connections").getSource().getFeatures();d=!1;for(var f=0,g=e.length;f<g;f++)if(b.source.id==e[f].get("source")&&b.target.id==e[f].get("target")){d=e[f];break}if(d){this.getKeepAnimationInFrame()&&(g=a.getMap(),e=a.getMap().getView().calculateExtent(g.getSize()),ol.extent.containsExtent(e,d.getGeometry().getExtent())||(newExtent=ol.extent.extend(e,d.getGeometry().getExtent()),g.getView().fit(newExtent)));d=(new arc.GreatCircle({x:b.source.lng,
y:b.source.lat},{x:b.target.lng,y:b.target.lat})).Arc(100,{offset:100});var k=b.source.label+" -\x3e "+b.target.label;d.geometries.forEach(function(b){var d=new ol.geom.LineString([]);d.transform(ol.proj.get("EPSG:4326"),a.getProjection()?a.getProjection():ol.proj.get("EPSG:3857"));b=new ol.Feature({geometry:d,allcoords:b.coords,text:k,color:this.getColor(),width:5,start:(new Date).getTime()});c.getSource().addFeature(b)},this);a.body.down(".ticker");a.body.down(".ticker").setHtml(b.source.left+" \x3cspan class\x3d'keyword'\x3e"+
b.source.term+"\x3c/span\x3e "+b.source.right+" \u2026 "+b.target.left+" \x3cspan class\x3d'keyword'\x3e"+b.target.term+"\x3c/span\x3e "+b.target.right)}else{if(!this.getGeonames())return;b=this.getGeonames().getConnectionOccurrence(b.index+1);this.setCurrentConnectionOccurrence(b);c.getSource().clear()}return this.setTimeout(setTimeout(this.animate.bind(this),1))}if(0<d.length){g=d[0].getGeometry().getCoordinates();e=d[0].get("allcoords");if(g.length<e.length)return g=((new Date).getTime()-d[0].get("start"))*
e.length/this.getMillisPerAnimation(),line=new ol.geom.LineString(e.slice(0,g)),line.transform(ol.proj.get("EPSG:4326"),a.getProjection()?a.getProjection():ol.proj.get("EPSG:3857")),d[0].set("geometry",line),this.setTimeout(setTimeout(this.animate.bind(this),25));b=this.getGeonames().getConnectionOccurrence(b.index+1);if(!this.getStepByStepMode())return this.setCurrentConnectionOccurrence(b),c.getSource().clear(),this.setTimeout(setTimeout(this.animate.bind(this),1))}}}else if(this.getGeonames()&&
(b=this.getGeonames().getConnectionOccurrence(0)))return this.setCurrentConnectionOccurrence(b),this.setTimeout(setTimeout(this.animate.bind(this),1))}}});Ext.define("Voyant.panel.Knots",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.knots",statics:{i18n:{},api:{query:null,stopList:"auto",docId:void 0,audio:!1},glyph:"xf06e@FontAwesome"},config:{knots:void 0,termStore:void 0,docTermStore:void 0,tokensStore:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}],refreshInterval:100,startAngle:315,angleIncrement:15,currentTerm:void 0},termTpl:new Ext.XTemplate('\x3ctpl for\x3d"."\x3e','\x3cdiv class\x3d"term" style\x3d"color: rgb({color});float: left;padding: 3px;margin: 2px;"\x3e{term}\x3c/div\x3e',
"\x3c/tpl\x3e"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){a=b.getDocument(0);var c=this.processDocument(a);this.getKnots().setCurrentDoc(c);this.setApiParams({docId:a.getId()});this.getDocTermStore().getProxy().setExtraParam("corpus",b.getId());this.getTokensStore().setCorpus(b);this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},this);this.on("activate",
function(){this.getCorpus()&&Ext.Function.defer(function(){this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},100,this)},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.getDocTermsFromQuery(b)},this);this.on("documentSelected",function(a,b){a=this.getCorpus().getDocument(b);this.setApiParam("docId",a.getId());var c=this.getKnots().currentDoc.terms;b=[];for(var d in c)b.push(d);this.setApiParams({query:b});d=b.length;0===d&&(d=5);this.getKnots().setCurrentDoc(this.processDocument(a));
this.getDocTermStore().load({params:{query:b,limit:d,stopList:this.getApiParams("stopList")}})},this);this.on("termsClicked",function(a,b){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});0<c.length&&this.getDocTermsFromQuery(c)},this);this.on("corpusTermsClicked",function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.getDocTermsFromQuery(c)},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&
c.push(a.getTerm())});this.getDocTermsFromQuery(c)},this)},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"]}));this.setDocTermStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:"raw",withPositions:!0},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},
simpleSortMode:!0},listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(a,b,c,d){var e={};b&&0<b.length?(b.forEach(function(a){var b=this.processTerms(a);a.get("docId");a=a.get("term");e[a]=b},this),this.getKnots().addTerms(e),this.getKnots().buildGraph()):this.toastInfo({html:this.localize("noTermsFound"),align:"bl"})},scope:this}}));this.setTokensStore(Ext.create("Voyant.data.store.Tokens",{stripTags:"all",listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",
this.getApiParam("docId"))},load:function(a,b,c,d){var e="",f=this.getCurrentTerm();b.forEach(function(a){e=a.getPosition()==f.tokenId?e+("\x3cstrong\x3e"+a.getTerm()+"\x3c/strong\x3e"):e+a.getTerm()});Ext.Msg.show({title:this.localize("context"),message:e,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf00d@FontAwesome",
handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.getTermStore().removeAll();this.setApiParams({query:null});this.getKnots().removeAllTerms();this.getKnots().drawGraph()},scope:this},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",itemId:"speed",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:50,width:100,increment:50,minValue:0,maxValue:500,value:500-this.getRefreshInterval(),listeners:{changecomplete:function(a,b){this.setRefreshInterval(500-
b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"startAngle",fieldLabel:this.localize("startAngle"),labelAlign:"right",labelWidth:35,width:85,increment:15,minValue:0,maxValue:360,value:this.getStartAngle(),listeners:{changecomplete:function(a,b){this.setStartAngle(b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"tangles",fieldLabel:this.localize("tangles"),labelAlign:"right",labelWidth:30,width:80,increment:5,minValue:5,maxValue:90,
value:this.getAngleIncrement(),listeners:{changecomplete:function(a,b){this.setAngleIncrement(b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.getKnots()&&
this.getKnots().setAudio(b)},scope:this}}]}],border:!1,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,b,c,d,e,f){e.preventDefault();e.stopPropagation();a.fireEvent("itemcontextmenu",a,b,c,d,e,f);return!1},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return!1},selectionchange:function(a,b){var c=this.down("#termsView"),d=[];c.getStore().each(function(a){-1!==b.indexOf(a)?(d.push(a.get("term")),Ext.fly(c.getNodeByRecord(a)).removeCls("unselected").addCls("selected")):Ext.fly(c.getNodeByRecord(a)).removeCls("selected").addCls("unselected")});this.getKnots().termsFilter=d;this.getKnots().drawGraph()},itemcontextmenu:function(a,b,c,d,e){e.preventDefault();e.stopPropagation();var f=a.isSelected(c);(new Ext.menu.Menu({floating:!0,
items:[{text:f?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){f?a.deselect(d):a.select(d,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(d);var b=this.getTermStore().getAt(d).get("term");this.getTermStore().removeAt(d);a.refresh();this.getKnots().removeTerm(b);this.getKnots().drawGraph()},scope:this}]})).showAt(e.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],
listeners:{render:function(a){a=this.down("#canvasParent");this.setKnots(new Knots({container:a,clickHandler:this.knotClickHandler.bind(this),audio:!0===this.getApiParam("audio")||"true"==this.getApiParam("audio")}))},afterlayout:function(a){!1===this.getKnots().initialized&&this.getKnots().initializeCanvas()},resize:function(a,b,c){this.getKnots().doLayout()},scope:this}}});this.callParent(arguments)},updateRefreshInterval:function(a){this.getKnots()&&(50>a?(a=50,this.getKnots().progressiveDraw=
!1):this.getKnots().progressiveDraw=!0,this.getKnots().refreshInterval=a,this.getKnots().buildGraph(this.getKnots().drawStep))},updateStartAngle:function(a){this.getKnots()&&(this.getKnots().startAngle=a,this.getKnots().recache(),this.getKnots().buildGraph())},updateAngleIncrement:function(a){this.getKnots()&&(this.getKnots().angleIncrement=a,this.getKnots().recache(),this.getKnots().buildGraph())},loadFromCorpusTerms:function(a){this.getKnots()&&(this.getKnots().removeAllTerms(),this.getTermStore().removeAll(!0));
a.load({callback:function(a,c,d){var b=[];"string"==typeof b&&(b=[b]);a.forEach(function(a,c){b.push(a.get("term"))},this);this.getDocTermsFromQuery(b)},scope:this,params:{limit:5,stopList:this.getApiParams("stopList")}})},getDocTermsFromQuery:function(a){a&&this.setApiParam("query",a);this.getCorpus()&&this.isVisible()&&(this.setApiParams({query:a}),this.getDocTermStore().load({params:this.getApiParams()}))},reloadTermsData:function(){var a=[],b;for(b in this.bubblelines.currentTerms)a.push(b);this.getDocTermsFromQuery(a)},
filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(b,c){a.push(b.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.selectedDocs=this.getCorpus().getDocuments().clone();var b=this.selectedDocs.getCount();if(10<b)for(var c=10;c<b;c++)this.selectedDocs.removeAt(10);a=[];this.selectedDocs.eachKey(function(b,c){a.push(b)},this);this.setApiParams({docId:a})}else this.selectedDocs=this.getCorpus().getDocuments().filterBy(function(b,
c){return-1!=a.indexOf(c)},this)},processDocument:function(a){var b=a.getShortTitle();b=b.replace("\x26hellip;","...");return{id:a.getId(),index:a.get("index"),title:b,totalTokens:a.get("tokensCount-lexical"),terms:{},lineLength:void 0}},processTerms:function(a){var b=a.get("term");var c=a.get("rawFreq"),d=a.get("positions");if(0<c){var e=this.getApplication().getColorForTerm(b);if(-1===this.getTermStore().find("term",b)){this.getTermStore().loadData([[b,e]],!0);var f=this.getTermStore().find("term",
b);this.down("#termsView").select(f,!0)}a=a.get("distributions");b={term:b,positions:d,distributions:a,rawFreq:c,color:e}}else b=!1;return b},knotClickHandler:function(a){this.setCurrentTerm(a);var b=a.tokenId-10;0>b&&(b=0);this.getTokensStore().load({start:b,limit:21});a=[a].map(function(a){return a.term});this.getApplication().dispatchEvent("termsClicked",this,a)}});Ext.define("Voyant.panel.Phrases",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.phrases",isConsumptive:!0,statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,sort:"length",dir:"desc",minLength:2,maxLength:50,overlapFilter:"length"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",
function(a,c){this.isVisible()&&(0==this.hasCorpusAccess(c)?this.mask(this.localize("limitedAccess"),"mask-no-spinner"):this.loadFromApis())});a.embedded||a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(a,c){if(this.getStore().getCorpus()){var b=[];c.forEach(function(a){b.push(a.get("term"))});this.setApiParams({query:b,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("activate",function(){this.getStore().getCorpus()&&
this.loadFromApis()},this);this.on("query",function(a,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusNgramsBuffered",{parentPanel:a});b.on("beforeload",function(b){return a.hasCorpusAccess(b.getCorpus())});a.on("sortchange",function(a,b,e,f){this.setApiParam("sort",
b.dataIndex);this.setApiParam("dir",e);a=this.getApiParams("stopList query docId docIndex sort dir minLength maxLength overlapFilter".split(" "));b=this.getStore().getProxy();for(var c in a)b.setExtraParam(c,a[c])},a);Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(a,b){var c=[];this.getApiParam("context");b.forEach(function(a){c.push('"'+a.getTerm()+'"')});this.getApplication().dispatchEvent("termsClicked",
this,c)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},"-",{text:a.localize("length"),tooltip:"test",xtype:"label"},{xtype:"slider",minValue:2,values:[2,30],maxValue:30,increment:1,width:75,tooltip:this.localize("lengthTip"),listeners:{render:{fn:function(a){var b=a.getValues();a.setValue(0,parseInt(this.getApiParam("minLength",b[0])));a.setValue(1,parseInt(this.getApiParam("maxLength",b[1])))},
scope:a},changecomplete:{fn:function(a,b){a=a.getValues();this.setApiParam("minLength",parseInt(a[0]));this.setApiParam("maxLength",parseInt(a[1]));this.getStore().load({params:this.getApiParams()})},scope:a}}},{xtype:"corpusdocumentselector"},"-",{xtype:"button",text:this.localize("overlap"),tooltip:this.localize("overlapTip"),menu:{items:[{xtype:"menucheckitem",text:this.localize("overlapNone"),group:"overlap",inputValue:"none",checkHandler:function(){this.setApiParam("overlapFilter","none");this.getStore().load({params:this.getApiParams()})},
scope:this},{xtype:"menucheckitem",text:this.localize("overlapLength"),group:"overlap",inputValue:"length",checkHandler:function(){this.setApiParam("overlapFilter","length");this.getStore().load({params:this.getApiParams()})},scope:this},{xtype:"menucheckitem",text:this.localize("overlapFreq"),group:"overlap",inputValue:"rawFreq",checkHandler:function(){this.setApiParam("overlapFilter","rawfreq");this.getStore().load({params:this.getApiParams()})},scope:this}],listeners:{afterrender:{fn:function(a){var b=
this.getApiParam("overlapFilter");a.items.each(function(a){a.group&&a.setChecked(a.inputValue==b)},this)},scope:this}}}}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize"},{text:this.localize("length"),dataIndex:"length",tooltip:this.localize("lengthTip"),sortable:!0,width:"autoSize"},{xtype:"widgetcolumn",text:this.localize("trend"),
tooltip:this.localize("trendTip"),width:120,dataIndex:"distributions",widget:{xtype:"sparklineline"}}],listeners:{corpusSelected:function(){this.setApiParams({docIndex:void 0,docId:void 0});this.loadFromApis()},documentsSelected:function(a,b){var c=[],d=this.getStore().getCorpus();b.forEach(function(a){c.push(d.getDocument(a).getId())},this);this.setApiParams({docId:c,docIndex:void 0});this.loadFromApis()},termsClicked:{fn:function(a,b){if(this.getStore().getCorpus()){var c=[];b.forEach(function(a){Ext.isString(a)?
c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});0<c.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:c}),this.isVisible()&&this.isVisible()&&this.getStore().clearAndLoad({params:this.getApiParams()}))}},scope:this}}});a.callParent(arguments);a.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.CorpusTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpusterms",statics:{i18n:{},api:{stopList:"auto",query:void 0,maxBins:100,comparisonCorpus:void 0},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"corpusselector",name:"comparisonCorpus",fieldLabel:"comparison corpus"}]},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this,proxy:{extraParams:{withDistributions:"relative",forTool:"corpusterms"}}});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{pruneRemoved:!1,listeners:{selectionchange:{fn:function(a,b){b&&0<b.length&&this.getApplication().dispatchEvent("corpusTermsClicked",
this,b)},scope:this}},mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}]}],plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],viewConfig:{listeners:{expandbody:function(a,b,e,f){(""===e.textContent||f&&f.force)&&Ext.create("Voyant.widget.CorpusTermSummary",{record:b,header:!1,renderTo:e.querySelector("div")})},scope:this}},columns:[{xtype:"rownumberer",width:"autoSize",sortable:!1},{text:this.localize("term"),
tooltip:this.localize("termTip"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),tooltip:this.localize("rawFreqTip"),dataIndex:"rawFreq",width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",renderer:function(a){return Ext.util.Format.number(1E6*a,"0,000")},width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativePeakedness"),tooltip:this.localize("relativePeakednessTip"),dataIndex:"relativePeakedness",
renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativeSkewness"),tooltip:this.localize("relativeSkewnessTip"),dataIndex:"relativeSkewness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("corpusComparisonDifference"),tooltip:this.localize("corpusComparisonDifferenceTip"),dataIndex:"comparisonRelativeFreqDifference",renderer:Ext.util.Format.numberRenderer("0,000.00000"),
width:"autoSize",hidden:!this.getApiParam("comparisonCorpus"),sortable:!0,listeners:{show:function(b,d,e){a.getApiParam("comparisonCorpus")||a.showError(a.localize("noCorpusComparison"))}}},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline",tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,b){return this.panel.store.getCorpus().getDocument(a).getTitle()+
"\x3cbr\x3e"+this.panel.localize("relativeFreqLabel")+" "+Ext.util.Format.number(1E6*b,"0,000")},panel:a})}}]});a.on("loadedCorpus",function(a,b){100<b.getDocumentsCount()&&this.getStore().getProxy().setExtraParam("bins",this.getApiParam("maxBins"));this.isVisible()&&this.getStore().load()},a);a.on("activate",function(){a.getStore().getCorpus()&&a.getStore().load({params:this.getApiParams()})},a);a.on("query",function(a,b){this.setApiParam("query",b);this.getStore().removeAll();this.getStore().load()},
a);a.callParent(arguments)}});Ext.define("Voyant.panel.DocumentTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.DocumentTerms"],alias:"widget.documentterms",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,bins:10},glyph:"xf0ce@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,
b){a=this.getStore();a.setCorpus(b);this.isVisible()&&a.load()});if(a.embedded){window.console&&console.warn(a.embedded.then);var b=Ext.getClass(a.embedded).getName();"Voyant.data.store.DocumentTerms"!=b&&"Voyant.data.model.Document"!=b||this.fireEvent("loadedCorpus",this,a.embedded.getCorpus())}else a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("query",function(a,b){this.fireEvent("corpusTermsClicked",a,b)},this);this.on("corpusTermsClicked",function(a,b){if(this.getStore().getCorpus()){var c=
[];b.forEach(function(a){c.push(Ext.isString(a)?a:a.get("term"))});this.setApiParams({query:c,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("documentsClicked",function(a,b){var c=[];b.forEach(function(a){c.push(a.get("id"))});this.setApiParams({docId:c,query:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})});this.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},
this)},initComponent:function(){var a=Ext.create("Voyant.data.store.DocumentTermsBuffered",{parentPanel:this});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:a,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(a,c){this.getApplication().dispatchEvent("documentTermsClicked",this,c)},scope:this}},pruneRemoved:!1,mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},
{xtype:"totalpropertystatus"},{xtype:"corpusdocumentselector"}]}],columns:[{text:"#",width:30,dataIndex:"docIndex",sortable:!0,renderer:function(a){return a+1}},{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("rawFreqTip"),width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",width:"autoSize",sortable:!0,
renderer:Ext.util.Format.numberRenderer("0,000")},{text:this.localize("tfidf"),tooltip:this.localize("tfidfTip"),dataIndex:"tfidf",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{text:this.localize("zscore"),tooltip:this.localize("zscoreTip"),dataIndex:"zscore",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",
widget:{xtype:"sparklineline"}}],listeners:{termsClicked:{fn:function(a,c){if(this.getStore().getCorpus()){var b=[];c.forEach(function(a){Ext.isString(a)?b.push(a):a.term?b.push(a.term):a.getTerm&&b.push(a.getTerm())});0<b.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:b}),this.isVisible()&&this.isVisible()&&this.getStore().load({params:this.getApiParams()}))}},scope:this}}});this.callParent(arguments);this.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.Documents",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.documents",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docIndex:void 0,docId:void 0},glyph:"xf0ce@FontAwesome"},MODE_EDITING:"editing",MODE_NORMAL:"normal",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:this.MODE_NORMAL},constructor:function(a){var b=Ext.create("Voyant.data.store.Documents",{selModel:{pruneRemoved:!1},proxy:{extraParams:{forTool:"documents"}}}),
c=[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}],d=this;a&&a.mode==this.MODE_EDITING||c.push({text:this.localize("modify"),tooltip:this.localize("modifyTip"),glyph:"xf044@FontAwesome",scope:this,itemId:"modifyButton",handler:function(a){Ext.create("Ext.window.Window",{title:this.localize("title"),modal:!0,width:"80%",minWidth:300,minHeight:200,height:"80%",layout:"fit",frame:!0,border:!0,items:{xtype:"documents",mode:this.MODE_EDITING,corpus:this.getStore().getCorpus(),header:!1,viewConfig:{plugins:{ptype:"gridviewdragdrop"},
listeners:{beforedrop:function(a,b,c,d,e){return this.getStore().getCount()<this.getStore().getCorpus().getDocumentsCount()?(a=this.up("panel"),Ext.Msg.show({title:a.localize("error"),message:a.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),!1):!0}}}},buttons:[{text:this.localize("add"),tooltip:this.localize("addTip"),glyph:"xf067@FontAwesome",handler:function(a){a.up("window").close();Ext.create("Ext.window.Window",{header:!1,modal:!0,layout:"fit",items:{xtype:"corpuscreator",
corpus:this.getStore().getCorpus()}}).show()},scope:this},{text:this.localize("remove"),tooltip:this.localize("removeTip"),glyph:"xf05e@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"remove",scope:this},{text:this.localize("keep"),tooltip:this.localize("keepTip"),glyph:"xf00c@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"keep",scope:this},{text:this.localize("reorder"),
tooltip:this.localize("reorderTip"),glyph:"xf0dc@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"reorder",scope:this},{text:"Cancel",glyph:"xf00d@FontAwesome",handler:function(a){a.up("window").close()}}]}).show()}},{text:this.localize("downloadButton"),glyph:"xf019@FontAwesome",itemId:"downloadButton",handler:function(){d.downloadFromCorpusId(d.getStore().getCorpus().getId())}});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),
columns:[{xtype:"rownumberer",renderer:function(a,b,c){return c.getIndex()+1},sortable:!1},{text:this.localize("documentTitle"),dataIndex:"title",sortable:!0,renderer:function(a,b,c){return c.getTitle()},flex:3},{text:this.localize("documentAuthor"),dataIndex:"author",sortable:!0,hidden:!0,renderer:function(a,b,c){return c.getAuthor()},flex:2},{text:this.localize("documentPubDate"),dataIndex:"pubDate",sortable:!0,hidden:!0,renderer:function(a,b,c){return c.getPubDate()},flex:2},{text:this.localize("documentPublisher"),
dataIndex:"publisher",sortable:!1,hidden:!0,renderer:function(a,b,c){return c.getPublisher()},flex:2},{text:this.localize("documentPubPlace"),dataIndex:"pubPlace",sortable:!1,hidden:!0,renderer:function(a,b,c){return c.getPubPlace()},flex:2},{text:this.localize("documentKeyword"),dataIndex:"keyword",sortable:!1,hidden:!0,renderer:function(a,b,c){return c.getKeyword()},flex:2},{text:this.localize("documentCollection"),dataIndex:"collection",sortable:!1,hidden:!0,renderer:function(a,b,c){return c.getCollection()},
flex:2},{text:this.localize("tokensCountLexical"),dataIndex:"tokensCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),sortable:!0,width:"autoSize"},{text:this.localize("typesCountLexical"),dataIndex:"typesCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),width:"autoSize"},{text:this.localize("typeTokenRatioLexical"),dataIndex:"typeTokenRatio-lexical",renderer:function(a){return Ext.util.Format.percent(a)},width:"autoSize"},{text:this.localize("averageWordsPerSentence"),
dataIndex:"averageWordsPerSentence",renderer:Ext.util.Format.numberRenderer("0,000.0"),tooltip:this.localize("averageWordsPerSentenceTip"),width:"autoSize"},{text:this.localize("language"),dataIndex:"language",hidden:!0,renderer:function(a,b,c,d,h,l,m){return m.ownerCt.getLanguage(a)},width:"autoSize"}],store:b,selModel:{type:"rowmodel",mode:"MULTI",listeners:{selectionchange:{fn:function(a,b){this.getApplication().dispatchEvent("documentsClicked",this,b,this.getStore().getCorpus())},scope:this}}},
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:c}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.store.setCorpus(b);if(this.isVisible())this.store.load({params:this.getApiParams()});else this.on("afterrender",function(){this.store.load({params:this.getApiParams()})},this);0==this.hasCorpusAccess(b)&&(this.queryById("modifyButton").hide(),this.queryById("downloadButton").hide())});
this.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},this);this.on("query",function(a,b){this.setApiParam("query",b);this.store.load({params:this.getApiParams()})});a.embedded&&("Voyant.data.model.Corpus"==Ext.getClass(a.embedded).getName()?a.corpus=a.embedded:"Voyant.data.store.Documents"==Ext.getClass(a.embedded).getName()&&(this.store.setRecords(a.embedded.getData()),a.corpus=a.embedded.getCorpus()));a.corpus&&this.fireEvent("loadedCorpus",
this,a.corpus)},keepRemoveReorderHandler:function(a){var b=a.up("window").down("documents"),c=b.getSelection(),d=b.getStore().getCorpus().getDocumentsCount(),e=a.getItemId();if("reorder"==e){if(b.getStore().getCount()<d)return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});docIndex=[];b.getStore().each(function(a){docIndex.push(a.getIndex())},this);for(a=1;a<docIndex.length;a++)if(docIndex[a-1]>docIndex[a])return Ext.Msg.confirm(b.localize("newCorpus"),
(new Ext.Template(b.localize(e+"Documents"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],this.getStore().each(function(a){docIndex.push(a.getIndex())},this),a={docIndex:docIndex},a[e+"Documents"]=!0,this.editCorpus(a))},b);return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderOriginalError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}return 0<c.length?c.length==d?1==d?Ext.Msg.show({title:this.localize("error"),message:this.localize("onlyOneError"),buttons:Ext.Msg.OK,
icon:Ext.Msg.ERROR}):Ext.Msg.show({title:this.localize("error"),message:this.localize("allSelectedError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}):Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(e+"SelectedDocuments"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],c.forEach(function(a){docIndex.push(a.getIndex())}),a={docIndex:docIndex},a[e+"Documents"]=!0,this.editCorpus(a))},b):b.getApiParam("query")&&b.getStore().getCount()<d?Ext.Msg.confirm(this.localize("newCorpus"),
(new Ext.Template(this.localize(e+"FilteredDocuments"))).applyTemplate([c.length]),function(a){"yes"===a&&(docIndex=[],this.getStore().each(function(a){docIndex.push(a.getIndex())},this),a={docIndex:docIndex},a[e+"Documents"]=!0,this.editCorpus(a))},b):Ext.Msg.show({title:this.localize("error"),message:this.localize("selectOrFilterError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},editCorpus:function(a){Ext.apply(a,{tool:"corpus.CorpusManager",corpus:this.getStore().getCorpus().getId()});var b=this.getApplication(),
c=b.getViewport();c.mask(this.localize("Creating new corpus\u2026"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:a,success:function(a){c.unmask();a=Ext.decode(a.responseText);b.openUrl(b.getBaseUrl()+"?corpus\x3d"+a.corpus.id)}});(a=this.up("window"))&&a.isFloating()&&a.close()}});Ext.define("Voyant.panel.DocumentsFinder",{extend:"Ext.grid.Panel",require:["Voyant.data.store.DocumentQueryMatches","Ext.grid.plugin.CellEditing"],mixins:["Voyant.panel.Panel"],alias:"widget.documentsfinder",statics:{i18n:{}},config:{exportGridAll:!1},constructor:function(a){this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.cellEditing.on("edit",this.onEditComplete,this);var b=this;Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),plugins:[this.cellEditing],
bbar:[{text:this.localize("addRow"),glyph:"xf055@FontAwesome",handler:this.addRow,scope:this},{text:this.localize("exportNewCorpus"),disabled:!0,glyph:"xf08e@FontAwesome",tooltip:this.localize("exportNewCorpusTip"),handler:function(){var a=this.getQueryFromStore();a?(this.setLoading(!0),this.getCorpus().getDocumentQueryMatches().load({params:{query:a,createNewCorpus:!0},callback:function(a,b,c){this.setLoading(!1);c?(a=b.getProxy().getReader().rawData.documentsFinder.corpus,a=this.getBaseUrl()+"?corpus\x3d"+
a,Ext.Msg.alert({title:this.localize("title"),message:"\x3ca href\x3d'"+a+"' target\x3d'_blank'\x3eNew Corpus\x3c/a\x3e"})):Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:b.getError().response}).show()},scope:this})):Ext.Msg.alert({title:this.localize("title"),message:this.localize("noMatches")})},scope:this,cls:"exportBtn"},{xtype:"tbtext",name:"status",cls:"status"}],columns:[{text:this.localize("query"),dataIndex:"query",renderer:function(a){return Ext.isEmpty(a)?
'\x3cspan class\x3d"placeholder"\x3e'+b.localize("emptyQuery")+"\x3c/span\x3e":a},editor:!0,minWidth:150,maxWidth:300},{text:this.localize("field"),dataIndex:"field",editor:{xtype:"combo",typeAhead:!0,triggerAction:"all",forceSelection:!0,value:"",valueField:"value",listeners:{change:function(){Ext.isEmpty(this.getValue())&&this.reset()}},store:new Ext.data.Store({fields:["text","value"],data:[[this.localize("textField"),"text"],[this.localize("advancedField"),"advanced"]]})},width:150,renderer:function(a){return Ext.isEmpty(a)?
"":b.localize(a+"Field")}},{text:this.localize("operator"),dataIndex:"operator",editor:{xtype:"combo",forceSelection:!0,store:new Ext.data.Store({autoDestroy:!0,fields:["text","value"],displayField:"text",valueField:"value",data:[{text:"AND",value:"+"},{text:"OR",value:""}]})},minWidth:75,maxWidth:75},{text:this.localize("count"),dataIndex:"count",renderer:function(a,b,e){return Ext.isEmpty(e.get("query"))?"":Ext.util.Format.number(a,"0,000")},minWidth:100,maxWidth:100},{xtype:"actioncolumn",width:25,
getGlyph:"xf014@FontAwesome",tooltip:this.localize("deleteQueryTip"),menuDisabled:!0,sortable:!1,handler:this.removeRow,scope:this}],store:new Ext.data.Store({autoDestroy:!0,fields:["id","operator","field","query","count"],data:[["","","","",0]]})});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){if((a=b.getDocuments())&&0<a.getCount()){var c=a.getDocument(0),d=[];["title","author","pubDate","publisher","pubPlace"].forEach(function(a){Ext.isEmpty(c.get(a))||
d.push([this.localize(a+"Field"),a])},this);d&&(a=this.getColumnManager().getHeaderByDataIndex("field").getEditor(),a.getStore().each(function(a){d.push([a.get("text"),a.get("value")])},this),a.setStore(Ext.create("Ext.data.Store",{fields:["text","value"],data:d})));this.updateStatus(0);this.setLoading(!1)}})},removeRow:function(a,b){this.getStore().removeAt(b);0==this.getStore().getCount()&&this.addRow();this.updateAggregate()},addRow:function(){this.store.loadData([["","","","",0]],!0)},onEditComplete:function(a,
b){a=this.getQueryFromRecord(b.record);if(Ext.isEmpty(a))b.record.set("count",""),this.updateAggregate();else{var c=b.view.getCell(b.record,this.getColumnManager().getHeaderByDataIndex("count"));c.mask("loading");this.getCorpus().getDocumentQueryMatches().load({params:{query:a},callback:function(a,e,f){c.unmask();f?b.record.set("count",0==a.length?0:a[0].get("count")):(Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:e.getError().response}).show(),b.record.set("count",
0));this.updateAggregate()},scope:this})}},getQueryFromRecord:function(a){if(Ext.isEmpty(a)||Ext.isEmpty(a.get("query")))return"";var b=a.get("query").trim();if(Ext.isEmpty(b))return"";a=a.get("field");return Ext.isEmpty(a?a.trim():a)?b:a+":"+b},getQueryFromStore:function(){var a="";this.getStore().each(function(b){var c=this.getQueryFromRecord(b);Ext.isEmpty(c)||(Ext.isEmpty(a)||(b=b.get("operator"),a+="AND"==b?" + ":" | "),a+=c)},this);console.warn(a);return a},updateAggregate:function(){var a=
this.getStore().sum("count");a&&"string"!=typeof a?1==a?(a=this.getStore().getAt(0).get("count"),this.updateStatus(this.getStore().getAt(0).get("count"))):(a=this.getQueryFromStore(),Ext.isEmpty(a)||(this.status||(this.status=this.down("[cls~\x3dstatus]")),this.status.mask(this.localize("loading")),this.getCorpus().getDocumentQueryMatches().load({params:{query:a},callback:function(a,c,d){this.status.unmask();d?this.updateStatus(a[0].get("count")):(Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),
response:c.getError().response}).show(),this.updateStatus(0))},scope:this}))):this.updateStatus(0)},updateStatus:function(a){this.status||(this.status=this.down("[cls~\x3dstatus]"));this.exportBtn||(this.exportBtn=this.down("[cls~\x3dexportBtn]"));0==a?this.status.update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()])):this.status.update((new Ext.XTemplate(this.localize("queryMatches"))).apply([a,this.getCorpus().getDocumentsCount()]));this.exportBtn.setDisabled(0==
a)}});Ext.define("Voyant.panel.Dummy",{extend:"Ext.Panel",xtype:"dummy",autoScroll:!0,initComponent:function(){Ext.apply(this,{xtype:"tabpanel",items:[{title:"Tab 1",icon:null,glyph:42,html:"one"},{title:"Tab 2",icon:null,glyph:70,html:"two"}]});this.callParent()}});Ext.define("Voyant.panel.Fountain",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.fountain",statics:{i18n:{title:"FountainMeter"},api:{stopList:"auto",docIndex:0,speed:30,groups:void 0},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],audio:!1,words:[],groups:{},moveWordsTimeout:void 0},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),
layout:{type:"hbox",align:"stretch"},items:[{html:"\x3csvg\x3e\x3c/svg\x3e",itemId:"fountain",flex:2},{flex:1,layout:"vbox",items:[{xtype:"polar",itemId:"gauge",width:300,flex:1,store:{fields:["mph","fuel","temp","rpm"],data:[{val:10}]},series:{type:"gauge",colors:this.getApplication().getColorPalette(this.getApplication().getApiParam("palette"),!0),angleField:"val",donut:20}},{width:300,height:16,items:{xtype:"sparklineline",itemId:"gaugsparkline",values:[0,1,2,34],height:16,width:300},listeners:{afterrender:function(a){a.getTargetEl().setStyle("cursor",
"pointer");a.getTargetEl().on("click",function(a,c,d){clearTimeout(this.getMoveWordsTimeout());this.getWords().forEach(function(a){a.svg&&(a.svg.remove(),delete a.svg);a.direction=-1});a=Math.floor(a.event.offsetX*this.getWords().length/c.offsetWidth);this.moveWords(a)},this)},scope:this}}]}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,
width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.bubbles&&this.bubbles.frameRate(a.getValue());this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},changecomplete:function(a,b){this.setApiParam("speed",b);this.bubbles&&this.bubbles.frameRate(b)},scope:this}}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.loadDocument()},this)},loadDocument:function(){var a=this,b=parseInt(this.getApiParam("docIndex"))||0;this.getCorpus().getWordsArray({docIndex:b,stopList:"auto"}).then(function(b){var c=b.map(function(a){return a.toLowerCase()});if(void 0==a.getApiParam("groups")){var e={};c.forEach(function(a){5<a.length&&!(a in e)&&(e[a]=a.length)});c=Math.max.apply(this,Object.values(e));c=d3.scaleLinear().domain([4,
c]).range([.5,1]);for(var f in e)e[f]=c(e[f]);a.setGroups({length:{color:a.getApplication().getColorForTerm("length"),terms:e}})}f=a.getComponent("fountain").getTargetEl();c=f.down("svg");c.set({width:f.getWidth(),height:f.getHeight()});var g=c.dom;d3.select(g).selectAll("*").remove();var k={},h=a.getGroups();a.setWords(b.slice(0,1E3).map(function(b){b=new a.FountainWord(b.toLowerCase());b.word in k?k[b.word]++:k[b.word]=1;b.min=parseInt(Math.random()*g.clientHeight*.05);var c=Math.sqrt(10*Math.random());
b.yshift=1>2*Math.random()?-c:c;b.jump=g.clientHeight/10;b.groupVals={};for(var d in h)b.word in h[d].terms&&(b.groupVals[d]=h[d].terms[b.word]);return b}));Math.max.apply(this,Object.values(k));var l=d3.scaleLog().domain([1,Math.max.apply(this,Object.values(k))]).range([4,12]);a.getWords().forEach(function(a){a.fontSize=l(k[a.word])});a.moveWords()})},FountainWord:function(a){this.word=a;this.direction=-1},moveWords:function(a){var b=this.getWords(),c=this.getComponent("fountain").getTargetEl().down("svg").dom,
d=c.clientHeight,e=c.clientWidth;this.getGroups();for(var f=d3.scaleLinear().domain([0,d]).range([1,0]),g=[],k=0,h=0;h<b.length;h++)if(k++,0==Object.keys(b[h].groupVals).length?g.push(0):Object.values(b[h].groupVals).forEach(function(a){g.push(a)}),0>b[h].direction)if(b[h].svg){var l=parseInt(b[h].svg.attr("y"));b[h].svg.attr("y",l-(l-b[h].min)/5);b[h].svg.attr("x",parseInt(b[h].svg.attr("x"))+b[h].yshift);l=parseInt(b[h].svg.attr("y"));b[h].ys.push(l);l<=b[h].min&&(b[h].direction=1)}else{if(l=d3.select(c).append("text").text(b[h].word).attr("font-size",
b[h].fontSize).attr("text-anchor","middle").attr("x",e/2).attr("y",d-Math.random()*d/5).attr("fill",0==Object.keys(b[h].groupVals).length?"black":this.getApplication().getColorForTerm(Object.keys(b[h].groupVals).shift(),!0)),b[h].ys=[d],b[h].svg=l,!a||h>a)break}else 0<b[h].direction?b[h].svg&&0<b[h].ys.length?(b[h].svg.attr("y",b[h].ys.pop()),b[h].svg.attr("x",parseInt(b[h].svg.attr("x"))+b[h].yshift),b[h].svg.attr("opacity",f(parseInt(b[h].svg.attr("y"))))):b[h].direction=0:"svg"in b[h]&&(b[h].svg.remove(),
delete b[h].svg);a=0==g.length?0:100*Ext.mean(g);c=this.down("polar");c.getStore().getAt(0).set("val",a);c.setSprites({type:"text",text:Ext.util.Format.number(a,"%0.0"),x:145,y:240});a=this.down("sparklineline");a.setValues(100<g.length?this.chunkify(g,100,!0).map(function(a){return Ext.mean(a)}):g);a.setWidth(k*a.ownerCt.getWidth()/b.length);this.setMoveWordsTimeout(Ext.defer(this.moveWords,100,this))},chunkify:function(a,b,c){if(2>b)return[a];var d=a.length,e=[],f=0;if(0===d%b)for(c=Math.floor(d/
b);f<d;)e.push(a.slice(f,f+=c));else if(c)for(;f<d;)c=Math.ceil((d-f)/b--),e.push(a.slice(f,f+=c));else{b--;c=Math.floor(d/b);for(0===d%c&&c--;f<c*b;)e.push(a.slice(f,f+=c));e.push(a.slice(c*b))}return e},initComponent:function(){this.callParent(arguments)}});Ext.define("Voyant.panel.RezoViz",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.rezoviz",statics:{i18n:{},api:{query:void 0,limit:25,stopList:"auto",type:["organization","location","person"],minEdgeCount:2},glyph:"xf1cb@FontAwesome"},config:{network:void 0,nodesStore:void 0,nodesDataSet:void 0,edgesDataSet:void 0,isNetworkBounded:!0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},categorizedNodeOptions:{location:{font:{color:"green"}},person:{font:{color:"maroon"}},
organization:{font:{color:"purple"}}},nodeOptions:{shape:"box",color:{border:"rgba(0,0,0,0.1)",background:"rgba(255,255,255,1)"},scaling:{label:{min:8,max:20}}},edgeOptions:{color:{color:"rgba(0,0,0,0.1)",highlight:"black",hover:"red"},labelHighlightBold:!1},highlightOptions:{font:{color:"white"},color:{background:"black"}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.setNodesStore(Ext.create("Ext.data.Store",
{fields:["id","term","type","rawFreq"],sortOnLoad:!0,sorters:"term"}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",queryMode:"local",valueField:"term",displayField:"term",store:this.getNodesStore(),listeners:{select:function(a,b){this.getNetwork().selectNodes([b.get("id")])},scope:this}},{xtype:"button",text:this.localize("categories"),menu:{items:[{xtype:"menucheckitem",text:this.localize("people"),itemId:"person",
checked:!0},{xtype:"menucheckitem",text:this.localize("locations"),itemId:"location",checked:!0},{xtype:"menucheckitem",text:this.localize("organizations"),itemId:"organization",checked:!0},{xtype:"button",text:this.localize("reload"),style:"margin: 5px;",handler:this.categoriesHandler,scope:this}]}},{xtype:"numberfield",itemId:"minEdgeCount",fieldLabel:this.localize("minEdgeCount"),labelAlign:"right",labelWidth:120,width:170,maxValue:10,minValue:1,allowDecimals:!1,allowExponential:!1,allowOnlyWhitespace:!1,
listeners:{render:function(a){a.setRawValue(this.getApiParam("minEdgeCount"))},change:function(a,b){a.isValid()&&(this.setApiParam("minEdgeCount",b),this.getEntities())},scope:this}},{xtype:"tbseparator"},{xtype:"slider",fieldLabel:this.localize("repulsion"),labelAlign:"right",labelWidth:70,width:150,value:100,increment:10,minValue:0,maxValue:500,listeners:{changecomplete:function(a,b){this.getNetwork().physics.options.repulsion.nodeDistance=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",
fieldLabel:this.localize("stiffness"),labelAlign:"right",labelWidth:70,width:150,value:4,increment:1,minValue:0,maxValue:10,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.springConstant=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("friction"),labelAlign:"right",labelWidth:55,width:150,value:9,increment:10,minValue:0,maxValue:100,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.damping=
b;this.getNetwork().startSimulation()},scope:this}}]}]});this.on("loadedCorpus",function(a,b){debugger;1==b.getDocumentsCount()&&this.setApiParam("minEdgeCount",1);this.getEntities()},this);this.on("resize",function(a,b,c){},this);this.callParent(arguments)},getEntities:function(){var a=this.getCorpus().getId(),b=this.getLayout().getRenderTarget();b.mask(this.localize("loadingEntities"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:{tool:"corpus.EntityCollocationsGraph",
type:this.getApiParam("type"),limit:this.getApiParam("limit"),minEdgeCount:this.getApiParam("minEdgeCount"),corpus:a},success:function(a){b.unmask();a=Ext.decode(a.responseText);0==a.entityCollocationsGraph.edges.length?(this.showError({msg:this.localize("noEntities")}),Ext.Msg.confirm(this.localize("error"),this.localize("noEntitiesForEdgeCount"),function(a){"yes"===a&&(a=Math.max(1,this.getApiParam("minEdgeCount")-1),this.queryById("minEdgeCount").setRawValue(a),this.setApiParam("minEdgeCount",
a),this.getEntities())},this)):(this.processEntities(a.entityCollocationsGraph),this.initGraph())},scope:this})},processEntities:function(a){var b=a.nodes;a=a.edges;var c=d3.extent(b,function(a){return a.rawFreq}),d=c[0];c=c[1];var e=d3.scale.linear().domain([d,c]).range([10,24]);d=[];for(c=0;c<b.length;c++){var f=b[c];f.id=c;d.push({id:c,label:f.term,value:b[c].rawFreq,font:{size:e(f.rawFreq),color:this.categorizedNodeOptions[f.type].font.color},type:f.type,rawFreq:f.rawFreq,title:f.term+(f.rawFreq?
" ("+f.rawFreq+")":"")})}this.getNodesStore().loadData(b);b=[];for(c=0;c<a.length;c++)e=a[c].nodes,b.push({from:e[0],to:e[1],title:a[c].count,value:200*a[c].count});this.setNodesDataSet(new vis.DataSet(d));this.setEdgesDataSet(new vis.DataSet(b))},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");a.setWidth(a.getWidth());a.setHeight(a.getHeight());var b={interaction:{hover:!0,hoverConnectedEdges:!0,multiselect:!1},physics:{solver:"repulsion",repulsion:{centralGravity:.1}},
nodes:this.nodeOptions,edges:this.edgeOptions},c=new vis.Network(a.dom,{nodes:this.getNodesDataSet(),edges:this.getEdgesDataSet()},b);if(this.getIsNetworkBounded())c.on("beforeDrawing",function(a){var b=this.getLayout().getRenderTarget();a=b.getWidth();b=b.getHeight();var d=c.getPositions(),g;for(g in d){var k=c.canvasToDOM(d[g]);k=c.DOMtoCanvas({x:Math.max(0,Math.min(a,k.x)),y:Math.max(0,Math.min(b,k.y))});c.body.nodes[g].x=k.x;c.body.nodes[g].y=k.y}}.bind(this));c.on("selectNode",function(a){this.doNodeSelect(a.nodes[0])}.bind(this));
c.on("deselectNode",function(a){c.unselectAll();a=a.nodes[0];void 0!==a&&setTimeout(this.doNodeSelect.bind(this),5,a)}.bind(this));c.on("selectEdge",function(a){c.unselectAll()});this.setNetwork(c)},doNodeSelect:function(a){var b=this.getNodesDataSet().get(a).label;this.dispatchEvent("termsClicked",this,[b]);b=this.getNetwork();var c=b.getConnectedNodes(a);c.push(a);a=b.getConnectedEdges(a);b.unselectAll();for(var d=0;d<c.length;d++)b.selectionHandler.selectObject(b.body.nodes[c[d]],!1);for(d=0;d<
a.length;d++)b.selectionHandler.selectObject(b.body.edges[a[d]],!1);b.redraw()},categoriesHandler:function(a){var b=[];a.up("menu").items.each(function(a){a.checked&&b.push(a.itemId)});this.setApiParam("type",b);this.getEntities()},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)}});Ext.define("Voyant.panel.Loom",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.loom",statics:{i18n:{title:"Loom",controls:"Controls",frequenciesGroup:"Frequencies",coverageGroup:"Coverage",distributionsGroup:"Distribution",termsGroup:"Terms",inDocumentsLabel:"in documents",inDocumentsLabelTip:"each term must be present in the number of documents defined by this range",spanSomeLabel:"some documents",spanSomeLabelTip:"each term must be present in at least one document defined by this range",
spanAllLabel:"all documents",spanAllLabelTip:"each term must be present in all documents defined by this range",spanOnlyLabel:"only documents",spanOnlyLabelTip:"each term must be present in only the documents defined by this range",rawFreqLabel:"raw frequency",rawFreqLabelTip:"raw term frequencies for the term must be between these values (inclusively)",rawFreqPercentileLabel:"raw frequency percentile",rawFreqPercentileLabelTip:"raw term frequencies for the term must be between these percentile values (inclusively), this is useful for saying something like terms in the top 90th percentile which will provide 10% of words regardless of the variation in values.",
distributionsStdDevLabel:"standard deviation of distributions",distributionsStdDevLabelTip:"the standard deviation of term distribution scores must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",distributionsStdDevPercentileLabel:"percentile of standard deviations of distributions",distributionsStdDevPercentileLabelTip:"the percentile of standard deviations of distributions must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",
termsLengthLabel:"term length",termsLengthLabelTip:"the length (number of characters) of the term (word)",termsLengthPercentileLabel:"term length percentile",termsLengthPercentileLabelTip:"the percentile of the length (number of characters) of the term (word)",distributionIncreasesLabel:"increases in distribution values",distributionIncreasesLabelTip:"the number of increases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveIncreasesLabel:"consecutive decreases in distribution values",
distributionConsecutiveIncreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",distributionDecreasesLabel:"decreases in distribution values",distributionDecreasesLabelTip:"the number of decreases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveDecreasesLabel:"consecutive decreases in distribution values",distributionConsecutiveDecreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",
distributionMaxLabel:"distribution maximum",distributionMaxLabelTip:"the maximum of the distribution values must be between the defined range (inclusively)",distributionMinLabel:"distribution minimum",distributionMinLabelTip:"the minimum of the distribution values must be between the defined range (inclusively)",presetsGroup:"pre-sets",presetHighFreq:"terms that are high frequency",presetHighFreqLonger:"terms that are longer and high frequency",presetSingleDoc:"higher frequency terms that only occur once",
presetIncreaseDistributions:"terms that generally increase in frequency",presetDecreaseDistributions:"terms that generally decrease in frequency ",presetNearStartDistributions:"terms that peak in distribution toward the beginning ",presetNearEndDistributions:"terms that peak in distribution toward the end ",presetSporadicDistributions:"terms whose distributions vary the most",visibleTerms:"max terms",scaling:"scaling",scaleLinear:"linear",scaleLog:"logarithmic",scaleSqrt:"square root"},api:{limit:500,
stopList:"auto",inDocuments:void 0,spanSome:void 0,spanAll:void 0,spanOnly:void 0,termLength:void 0,termsLengthPercentile:void 0,rawFreq:void 0,rawFreqPercentile:void 0,distributionsStdDev:void 0,distributionsStdDevPercentile:void 0,distributionIncreases:void 0,distributionDecreases:void 0,distributionConsecutiveIncreases:void 0,distributionConsecutiveDecreases:void 0,distributionMax:void 0,distributionMin:void 0,scaling:"linear"},glyph:"xf1e0@FontAwesome"},config:{store:void 0,terms:void 0,options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}],controls:void 0},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var a=new Ext.util.MixedCollection({allowFunctions:!0});a.addAll({inDocuments:new Voyant.util.LoomControl({group:"coverage",name:"inDocuments",initControl:function(a){this.setMin(1);this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){a=
a.getDistributions().filter(function(a){return 0<a}).length;return a>=this.getLow()&&a<=this.getHigh()}}),spanSome:new Voyant.util.LoomControl({group:"coverage",name:"spanSome",offsetTipText:!0,initControl:function(a){this.setMax(a.getAt(0).getDistributions().length-1)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();for(a=a.getDistributions();b<c+1;b++)if(0<a[b])return!0;return!1}}),spanAll:new Voyant.util.LoomControl({group:"coverage",name:"spanAll",offsetTipText:!0,initControl:function(a){this.setMax(a.getAt(0).getDistributions().length-
1)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();for(a=a.getDistributions();b<c+1;b++)if(0==a[b])return!1;return!0}}),spanOnly:new Voyant.util.LoomControl({group:"coverage",name:"spanOnly",offsetTipText:!0,initControl:function(a){this.setMax(a.getAt(0).getDistributions().length-1)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=0;d<a.length;d++)if(d<b||d>c){if(0<a[d])return!1}else if(0==a[d])return!1;return!0}}),rawFreq:new Voyant.util.LoomControl({group:"frequencies",
name:"rawFreq",offsetTipText:!0,initControl:function(a){a=a.getRange().map(function(a){return a.get("rawFreq")});this.setMin(Ext.Array.min(a));this.setMax(Ext.Array.max(a))},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.get("rawFreq");return a>=b&&a<=c}}),rawFreqPercentile:new Voyant.util.LoomControl({group:"frequencies",name:"rawFreqPercentile",min:0,max:100,initControl:function(a){this.vals=a.getRange().map(function(a){return a.get("rawFreq")});this.vals.sort(function(a,b){return a-
b})},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=Ext.Array.indexOf(this.vals,a.get("rawFreq"));a=Math.round(100*a/this.vals.length);return a>=b&&a<=c}}),distributionsStdDev:new Voyant.util.LoomControl({group:"frequencies",name:"distributionsStdDev",initControl:function(a){var b=Ext.Array.flatten(a.getRange().map(function(a){return a.getDistributions()})),c=d3.scaleLinear().domain([d3.min(b),d3.max(b)]).range([0,100]);a.each(function(a){if(void 0===a.get("distributionsStdDev")){var b=
a.getDistributions(),d=b.map(function(a){return c(a)}),e=Ext.Array.mean(d);b=b.map(function(a){a-=e;return a*a});b=Ext.Array.mean(b);a.set("distributionsStdDev",Math.sqrt(b))}});a=a.getRange().map(function(a){return a.get("distributionsStdDev")});this.setMin(Ext.Array.min(a));this.setMax(Ext.Array.max(a))},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.get("distributionsStdDev");return a>=b&&a<=c}}),distributionsStdDevPercentile:new Voyant.util.LoomControl({group:"frequencies",
name:"distributionsStdDevPercentile",min:0,max:100,initControl:function(a){this.vals=a.getRange().map(function(a){return a.get("distributionsStdDev")});this.vals.sort(function(a,b){return a-b})},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=Ext.Array.indexOf(this.vals,a.get("distributionsStdDev"));a=Math.round(100*a/this.vals.length);return a>=b&&a<=c}}),termsLength:new Voyant.util.LoomControl({group:"terms",name:"termsLength",offsetTipText:!0,initControl:function(a){a=a.getRange().map(function(a){return a.get("term").length});
this.setMin(Ext.Array.min(a));this.setMax(Ext.Array.max(a))},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.get("term").length;return a>=b&&a<=c}}),termsLengthPercentile:new Voyant.util.LoomControl({group:"terms",name:"termsLengthPercentile",min:0,max:100,initControl:function(a){this.vals=a.getRange().map(function(a){return a.get("term").length});this.vals.sort(function(a,b){return a-b})},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=Ext.Array.indexOf(this.vals,
a.get("term").length);a=Math.round(100*a/this.vals.length);return a>=b&&a<=c}}),distributionIncreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionIncreases",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=0,e=1;e<a.length;e++)if(a[e]>a[e-1]&&(d++,d>c))return!1;return d>=b}}),distributionConsecutiveIncreases:new Voyant.util.LoomControl({group:"distributions",
name:"distributionConsecutiveIncreases",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=0,e=1;e<a.length;e++)if(a[e]>a[e-1]){if(d++,d>c)return!1}else d=0;return d>=b}}),distributionDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionDecreases",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=
this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=0,e=1;e<a.length;e++)if(a[e]<a[e-1]&&(d++,d>c))return!1;return d>=b}}),distributionConsecutiveDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionConsecutiveDecreases",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=0,e=1;e<a.length;e++)if(a[e]<a[e-1]){if(d++,d>c)return!1}else d=0;return d>=
b}}),distributionMax:new Voyant.util.LoomControl({group:"distributions",name:"distributionMax",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=Ext.Array.max(a);b<c;b++)if(a[b]==d)return!0;return!1}}),distributionMin:new Voyant.util.LoomControl({group:"distributions",name:"distributionMin",initControl:function(a){this.setMax(a.getAt(0).getDistributions().length)},validateRecord:function(a){var b=
this.getLow(),c=this.getHigh();a=a.getDistributions();for(var d=Ext.Array.min(a);b<c;b++)if(a[b]==d)return!0;return!1}})});a.each(function(a){var b=this.getApiParam(a.getName()),c=(b||"").split(",");a.setEnabled(void 0!==b);2==c.length&&(a.setLow(parseInt(c[0])),a.setHigh(parseInt(c[1])));a.on("change",function(a){a.getEnabled()?this.setApiParam(a.getName(),a.getLow()+","+a.getHigh()):this.setApiParam(a.getName(),void 0);this.filterRecords()},this)},this);this.setControls(a);var b=this,c=function(){var a=
b.getApiParams();b.controls.each(function(c){c.setEnabled(!1,!0);c=c.getName();c in a&&b.setApiParam(c,void 0)})},d=[{text:this.localize("presetsGroup"),menu:{items:[{text:this.localize("presetHighFreq"),handler:function(){c();this.filterRecords()},scope:this},{text:this.localize("presetHighFreqLonger"),handler:function(){c();this.controls.getByKey("termsLengthPercentile").setEnabled(!0,!0).setValues(50,100,!0);this.controls.getByKey("rawFreqPercentile").setEnabled(!0,!0).setValues(50,100)},scope:this},
{text:this.localize("presetSingleDoc"),handler:function(){c();this.controls.getByKey("inDocuments").setEnabled(!0,!0).setValues(1,1)},scope:this},{text:this.localize("presetIncreaseDistributions"),handler:function(){c();var a=this.controls.getByKey("distributionIncreases"),b=a.getMax();a.setEnabled(!0,!0).setValues(Math.round(.75*b),b)},scope:this},{text:this.localize("presetDecreaseDistributions"),handler:function(){c();var a=this.controls.getByKey("distributionDecreases"),b=a.getMax();a.setEnabled(!0,
!0).setValues(Math.round(.75*b),b)},scope:this},{text:this.localize("presetNearStartDistributions"),handler:function(){c();var a=this.controls.getByKey("distributionMax"),b=a.getMax();a.setEnabled(!0,!0).setValues(0,Math.round(.2*b))},scope:this},{text:this.localize("presetNearEndDistributions"),handler:function(){c();var a=this.controls.getByKey("distributionMax"),b=a.getMax();a.setEnabled(!0,!0).setValues(Math.round(.8*b),b)},scope:this},{text:this.localize("presetSporadicDistributions"),handler:function(){c();
this.controls.getByKey("distributionsStdDevPercentile").setEnabled(!0,!0).setValues(80,100)},scope:this}]}},{xtype:"tbspacer"}];["frequencies","coverage","distributions","terms"].map(function(b){d.push({text:this.localize(b+"Group"),menu:{items:a.filterBy(function(a){return a.getGroup()==b}).getRange().map(function(a){return{xtype:"menucheckitem",checked:a.getEnabled(),text:this.localize(a.getName()+"Label"),tooltip:this.localize(a.getName()+"LabelTip"),listeners:{beforerender:function(b){b.setChecked(a.getEnabled());
a.on("change",function(){b.setChecked(a.getEnabled())})},click:function(b){a.setEnabled(b.checked);b.getMenu().setDisabled(!b.checked);b.checked?b.getMenu().show():b.getMenu().hide()}},menu:{disabled:!a.getEnabled(),items:{xtype:"multislider",width:100,minValue:a.getMin()||0,maxValue:a.getMax()||0,values:[a.getLow()||0,a.getHigh()||0],tipText:function(b){return a.getOffsetTipText()?b.value+1:b.value},listeners:{beforerender:function(b){b.updateFromControl(a);a.on("change",function(){b.updateFromControl(a)})},
changecomplete:function(b){a.setValues(b.getValues())}},updateFromControl:function(a){this.setMinValue(a.getMin()||0);this.setMaxValue(a.getMax());this.setValue(0,a.getLow()||0);this.setValue(1,void 0===a.getHigh()?a.getMax()||0:a.getHigh())}}}}},this)}})},this);Ext.apply(this,{title:this.localize("title"),layout:{type:"hbox",align:"stretch"},listeners:{afterrender:function(){var a=this.getComponent("terms"),b=this.getComponent("threads");a.on("termHovered",function(a,c){if(a=b.getTargetEl().dom.querySelector("path[term\x3d"+
c+"]")){var d=function(a,b){opacity=a.getAttribute("opacity");0<opacity&&(opacity-=.01,a.setAttribute("opacity",opacity),b/=2,Ext.defer(d,b,this,[a,b]))};a.setAttribute("opacity",1);d(a,1E3)}})}},items:[{itemId:"terms",width:100,layout:"fit",listeners:{filterchange:function(a){var b=this.getTargetEl(),c=b.getWidth(),d=b.getHeight(),e=a.getCount();b.setHtml(" ");terms=a.getRange().map(function(a,b){return{term:a.getTerm(),col:Voyant.application.getColorForTerm(a.getTerm(),!0),x:c/2,y:b*d/e}});terms.sort(function(a,
b){return a.term.localeCompare(b.term)});a=d3.select(b.dom).append("svg").attr("width",c).attr("height",d).append("g").attr("transform","translate(-.5,-.5)");var l=Math.ceil(d/terms.length),m=a.selectAll("ytext").data(terms).enter().append("text").text(function(a,b){return a.term}).attr("class","ytext").attr("text-anchor","middle").attr("x",c/2).attr("y",function(a,b){return l*b}).attr("fill",function(a){return Voyant.application.getColorForTerm(a.term,!0)});l=Math.ceil(d/terms.length);var n=d3.fisheye.circular().radius(50).distortion(2);
yFisheye=d3.fisheye.scale(d3.scaleIdentity).domain([0,d]);var p=this;a.on("mousemove",function(){var a=d3.mouse(this);currentItem=Math.round(a[1]*terms.length/d);currentItem=Math.min(currentItem,terms.length-1);n.focus(a[1]);yFisheye.focus(a[1]);var b=m.nodes();b[currentItem]&&p.fireEvent("termHovered",p,b[currentItem].textContent);var c=14,e=Math.max(a[1],c),f=1;d3.select(b[currentItem]).attr("y",function(a){return e}).attr("font-size",c).attr("fill-opacity",f);for(var g=void 0,k=currentItem-1;-1<
k;k--)8<=c?(e-=c,c-=.5):(void 0==g&&(g=e/k),e-=g),.1<f&&(f-=.05),d3.select(b[k]).attr("y",function(a){return e}).attr("font-size",c).attr("fill-opacity",f);c=14;e=Math.max(a[1],c);f=1;g=void 0;k=currentItem+1;for(a=terms.length;k<a;k++)8<=c?(e+=c,c-=.5):(void 0==g&&(g=(d-e)/(a-k)),e+=g),.1<f&&(f-=.05),d3.select(b[k]).attr("y",function(a){return e}).attr("font-size",c).attr("fill-opacity",f)})}}},{itemId:"threads",layout:"fit",flex:1,listeners:{filterchange:function(a){var b=this.getTargetEl(),c=b.getWidth(),
d=b.getHeight();b.setHtml(" ");terms=a.getRange().map(function(a){return{term:a.getTerm(),vals:a.getDistributions()}});var e=d3.select(b.dom).append("svg").attr("width",b.getWidth()).attr("height",b.getHeight());if(0==terms.length)return this.up("panel").toastInfo("No hits");var l=c/terms[0].vals.length;a=this.up("loom").getApiParam("scaling");var m=("sqrt"==a?d3.scaleSqrt():"log"==a?d3.scaleLog():d3.scaleLinear()).domain([Math.max(1E-6,Ext.Array.min(terms.map(function(a){return Ext.Array.min(a.vals)}))),
Math.max(1E-6,Ext.Array.max(terms.map(function(a){return Ext.Array.max(a.vals)})))]).range([1E-6,d-2]),n=d3.line().curve(d3.curveCardinal).x(function(a,b){return l/2+l*b}).y(function(a){return d-1-m(a)}),p=e.append("g").attr("opacity",0),r=p.append("rect").attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("stroke","rgba(0,0,0,.05)").attr("class","rect").attr("x",100).attr("y",100).attr("width",70).attr("height",16).attr("opacity",1),q=p.append("text").attr("text-anchor",
"middle").attr("alignment-baseline","middle").attr("x",100).attr("y",100).text("testing");terms.forEach(function(a){var b=Voyant.application.getColorForTerm(a.term,!0);e.append("path").datum(a.vals).attr("fill","none").attr("stroke",b).attr("opacity",.5).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1).attr("class","line").attr("d",n);e.append("path").datum(a.vals).attr("fill","none").attr("stroke",b).attr("opacity",0).attr("stroke-width",3).attr("class","line").attr("term",
a.term).attr("d",n).on("mouseover",function(){d3.select(this).attr("opacity",1);var c=d3.mouse(this);p.attr("opacity",1);r.attr("x",c[0]-35).attr("y",c[1]-8+(c[1]>d/2?-18:18));q.text(a.term).attr("fill",b).attr("x",c[0]).attr("y",c[1]+(c[1]>d/2?-18:18))}).on("mouseout",function(){d3.select(this).attr("opacity",0);p.attr("opacity",0)});p.raise()},this)}}}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[d[0],d[2],d[3],d[4],d[5],{fieldLabel:this.localize("visibleTerms"),
labelWidth:70,width:120,xtype:"slider",increment:25,minValue:25,maxValue:5E3,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(a,b){this.setApiParams({limit:b});this.fireEvent("loadedCorpus",this,this.getCorpus())},scope:this}},{text:this.localize("scaling"),menu:{defaults:{xtype:"menucheckitem",handler:function(a){this.setApiParam("scaling",a.getItemId());this.getComponent("threads").fireEventArgs("filterchange",[this.getStore()])},scope:this,
listeners:{afterrender:function(a){a.setChecked(a.getItemId()==this.getApiParam("scaling"))},scope:this},group:"scaling"},items:[{text:this.localize("scaleLinear"),itemId:"linear"},{text:this.localize("scaleLog"),itemId:"log"},{text:this.localize("scaleSqrt"),itemId:"sqrt"}]}}]}]});this.on("loadedCorpus",function(a,b){a=1==b.getDocumentsCount()?b.getDocumentTerms():b.getCorpusTerms();a.on("load",function(){this.updateControlsFromStore();this.filterRecords()},this);a.on("filterchange",function(){this.getComponent("terms").fireEventArgs("filterchange",
arguments);this.getComponent("threads").fireEventArgs("filterchange",arguments)},this);this.setStore(a);params=this.getApiParams();Ext.apply(params,{withDistributions:!0});a.load({callback:function(a,b,c){this.filterRecords()},scope:this,params:params})},this);this.callParent(arguments)},filterRecords:function(){var a=this.getStore();a.clearFilter();var b=parseInt(this.getApiParam("limit")),c=0;a.filterBy(function(a){return Ext.Array.every(this.getControls().getRange(),function(b){return 0==b.getEnabled()||
b.getValidateRecord().call(b,a)},this)&&c++<b},this)},updateControlsFromStore:function(){var a=this.getStore();this.getControls().each(function(b){b.suspendEvent("change");b.initControl.call(this,a);void 0===b.getMin()&&b.setMin(0);void 0==b.getLow()&&b.setLow(b.getMin());void 0===b.getMax()&&b.setMax(1);void 0==b.getHigh()&&b.setHigh(b.getMax());b.resumeEvent("change")})},revalidate:function(){var a=this.body.down("canvas").dom,b=a.getContext("2d");b.clearRect(0,0,a.width,a.height);var c=this.query("loomcontrol"),
d=new Voyant.panel.LoomTermRecords;this.getStore().each(function(a){var b=a.getDistributions().map(function(a){return!0});Ext.Array.each(c,function(c){if(c.getChecked()&&c.validateRecord){c=c.validateRecord.call(this,c.getField(),a,a.getDistributions());if(Ext.isBoolean(c)&&!c)return b=!1;if(Ext.isArray(c)){for(var d=0;d<b.length;d++)b[d]=b[d]&&c[d];return Ext.Array.some(b,function(a){return a})}}});Ext.isArray(b)&&Ext.Array.some(b,function(a){return a})&&d.add(a)});d.update(a,b)}});
Ext.define("Voyant.panel.LoomTermRecords",{config:{termRecords:[]},constructor:function(a){this.setTermRecords([]);this.callParent(arguments)},add:function(a){this.getTermRecords().push(new Voyant.panel.LoomTermRecord(a))},update:function(a,b){var c=Ext.Array.min(this.getTermRecords().map(function(a){return Ext.Array.min(a.getValues())})),d=Ext.Array.max(this.getTermRecords().map(function(a){return Ext.Array.max(a.getValues())}));this.getTermRecords().forEach(function(e){e.update(a,b,c,d)})}});
Ext.define("Voyant.panel.LoomTermRecord",{config:{record:void 0,values:void 0,term:void 0,texts:void 0},constructor:function(a){this.setRecord(a);this.setValues(a.getDistributions());var b=a.getTerm();this.setTerm(b);this.setTexts(a.getDistributions().map(function(a){return new Ext.draw.sprite.Text({type:"text",text:b})}));this.callParent(arguments)},update:function(a,b,c,d){var e=this.getValues(),f=a.offsetWidth/e.length,g=a.offsetHeight,k=this.getTerm();this.getTexts().forEach(function(a,c){b.fillText(k,
f/2+c*f,g-e[c]*g/d)})}});
Ext.define("Voyant.util.LoomControl",{extend:"Ext.Base",mixins:["Ext.mixin.Observable"],constructor:function(a){this.mixins.observable.constructor.call(this,a);this.callParent(arguments)},config:{group:void 0,name:void 0,enabled:!1,min:void 0,max:void 0,low:void 0,high:void 0,initControls:Ext.emptyFn,validateRecord:Ext.emptyFn,offsetTipText:!1},setMin:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setMax:function(){this.callParent(arguments);this.fireEvent("change",
this);return this},setLow:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setHigh:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setValues:function(a,b){this.suspendEvent("change");Ext.isArray(a)?(this.setLow(a[0]),this.setHigh(a[1])):(this.setLow(a),this.setHigh(b));this.resumeEvent("change");(3>arguments.length||!arguments[2])&&this.fireEvent("change",this);return this},setEnabled:function(){this.callParent(arguments);(2>arguments.length||
!arguments[1])&&this.fireEvent("change",this);return this}});Ext.define("Voyant.panel.MicroSearch",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microsearch",statics:{i18n:{},api:{stopList:"auto",query:void 0},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],maxTokens:0,tokensPerSegment:0,maxVerticalLines:0,maxSegments:0},constructor:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"}]}]});
this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,c){if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(a,c){this.setApiParam("query",c);this.updateSearchResults()})},initialize:function(){var a=this.getTargetEl(),b=this.getCorpus();this.setMaxVerticalLines(Math.floor((a.getHeight()-10)/5));var c=b.getDocumentsCount(),d=10*c,e=Math.floor((a.getWidth()-
d-10)/c);200<e&&(e=200);d=Math.floor(e/3);1>d&&(d=1);this.setMaxSegments(d*this.getMaxVerticalLines());b=b.getDocuments();this.setMaxTokens(b.max("tokensCount-lexical"));this.setTokensPerSegment(this.getMaxTokens()<this.getMaxSegments()?1:Math.ceil(this.getMaxTokens()/this.getMaxSegments()));var f="\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' style\x3d'height: 100%'\x3e\x3ctr\x3e";this.segments=[];b.each(function(b){docIndex=b.getIndex();f+='\x3ctd style\x3d"overflow: hidden; vertical-align: top; width: '+
e+'px;"\x3e\x3cdiv class\x3d"docLabel" style\x3d"white-space: nowrap; width: '+e+'px;" data-qtip\x3d"'+b.getFullLabel()+'"\x3e'+b.getFullLabel()+'\x3c/div\x3e\x3ccanvas style\x3d"display: block;" width\x3d"'+e+'" height\x3d"'+a.getHeight()+'" id\x3d"'+this.body.id+"-"+docIndex+'"\x3e\x3c/td\x3e';docIndex+1<c&&(f+='\x3ctd style\x3d"width: 10px;"\x3e\x26nbsp;\x3c/td\x3e')},this);f+="\x3c/tr\x3e\x3c/table\x3e";a.update(f);this.updateSearchResults();if(!this.getApiParam("query")){var g=this;return this.getCorpus().loadCorpusTerms({limit:1,
stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")}).then(function(a){a=a.getAt(0).getTerm();g.down("querysearchfield").addValue(new Voyant.data.model.CorpusTerm({term:a}));g.fireEvent("query",g,[a])})}},updateSearchResults:function(){query=this.getApiParam("query");0==Ext.Array.from(query).length?this.getCorpus().getDocuments().each(function(a){var b=this.redistributeDistributions(a,Array(this.getMaxSegments()));this.drawDocumentDistributions(a,b)},this):(this.mask(this.localize("loading")),
this.getCorpus().getDocumentTerms().load({params:{query:Ext.Array.from(query).join("|"),withDistributions:"relative",bins:this.getMaxSegments(),categories:this.getApiParam("categories")},callback:function(a,b,c){this.unmask();var d=0,e=Number.MAX_VALUE,f=[],g;a.forEach(function(a){var b=this.getCorpus().getDocument(a.getDocIndex()),c=this.redistributeDistributions(b,a.getDistributions());g=Ext.Array.max(c);g>d&&(d=g);c.forEach(function(a){a&&a<e&&(e=a)});f[a.getDocIndex()]=this.redistributeDistributions(b,
a.getDistributions())},this);f.forEach(function(a,b){this.drawDocumentDistributions(this.getCorpus().getDocument(b),a,e||Ext.Array.min(a),d||Ext.Array.max(a))},this)},scope:this}))},redistributeDistributions:function(a,b){a=Math.ceil(a.getLexicalTokensCount()/this.getTokensPerSegment());if(b.length>a){for(var c=[],d=0;d<b.length;d++){var e=parseInt(d*a/b.length);c[e]?c[e].push(b[d]):c[e]=[b[d]]}b=c;for(d=0;d<b.length;d++)b[d]=Ext.Array.mean(b[d])}return b},drawDocumentDistributions:function(a,b,c,
d){var e=this.getTargetEl().dom.querySelector("#"+this.body.id+"-"+a.getIndex());a=e.getContext("2d");var f=0;e=e.clientWidth;for(var g=0,k=0;k<b.length;k++)a.fillStyle=b[k]?"rgba(250,0,0,"+(.8*(b[k]-c)/(d-c)+.2)+")":"rgb(230,230,230)",a.fillRect(f,g,3,3),f+=3,f>=e&&(f=0,g+=5)}});Ext.define("Voyant.panel.Mandala",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.mandala",statics:{i18n:{},api:{stopList:"auto",query:void 0,labels:!0},glyph:"xf1db@FontAwesome"},gutter:5,textFont:"12px sans-serif",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'\x3cdiv style\x3d"text-align: center"\x3e\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e\x3c/div\x3e',
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{text:this.localize("add"),glyph:"xf067@FontAwesome",handler:function(){this.editMagnet()},scope:this},{text:this.localize("clear"),glyph:"xf014@FontAwesome",handler:function(){this.setApiParam("query",void 0);this.updateFromQueries(!0);this.editMagnet()},scope:this},{xtype:"checkbox",boxLabel:this.localize("labels"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("labels"));Ext.tip.QuickTipManager.register({target:a.getEl(),
text:this.localize("labelsTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.setApiParam("labels",b);this.draw()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().dom.querySelector("canvas"),c=this;b.addEventListener("mousemove",function(a){var d=b.getBoundingClientRect(),f=a.clientX-d.left,g=a.clientY-d.top,k=!1,h=parseInt(c.textFont)/
2;c.documents&&c.documents.forEach(function(a){var b=f>a.x-h&&f<a.x+h&&g>a.y-h&&g<a.y+h;b!=a.isHovering&&(k=!0);a.isHovering=b});radius=parseInt(c.textFont)/2;for(term in c.magnets)a=f>c.magnets[term].x-radius&&f<c.magnets[term].x+radius&&g>c.magnets[term].y-radius&&g<c.magnets[term].y+radius,a!=c.magnets[term].isHovering&&(k=!0),c.magnets[term].isHovering=a;k&&c.draw()},!1);b.addEventListener("click",function(a){var d=b.getBoundingClientRect(),f=a.clientX-d.left;a=a.clientY-d.top;parseInt(c.textFont);
for(term in c.magnets)f>c.magnets[term].x-radius&&f<c.magnets[term].x+radius&&a>c.magnets[term].y-radius&&a<c.magnets[term].y+radius&&c.editMagnet(term)},!1)});this.on("loadedCorpus",function(a,b){this.documents=[];a=this.getTargetEl().dom.querySelector("canvas");var c=a.getContext("2d"),d=a.width/2;c.font=this.textFont;b.getDocuments().each(function(a){var b=a.getTinyTitle();this.documents.push({doc:a,label:b,width:c.measureText(b).width,x:d,y:d,matches:[],isHovering:!1})},this);this.updateDocs(a);
this.draw();this.updateFromQueries()},this);this.on("resize",function(){var a=this.getTargetEl().dom.querySelector("canvas"),b=Math.min(this.getTargetEl().getWidth(),this.getTargetEl().getHeight());a.width=b;a.height=b;this.updateMagnets();this.updateDocs();this.draw(a)})},editMagnet:function(a){var b=this,c=Ext.Array.from(b.getApiParam("query"));Ext.create("Ext.window.Window",{title:this.localize("EditMagnet"),modal:!0,items:{xtype:"form",width:300,items:[{xtype:"querysearchfield",corpus:this.getCorpus(),
store:this.getCorpus().getCorpusTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList")}}}),stopList:this.getApiParam("stopList"),listeners:{afterrender:function(b){if(a){var c=new Ext.create("Voyant.data.model.CorpusTerm",{term:a});b.getStore().loadData(c,!0);b.setValue(c)}}}},{xtype:"numberfield",fieldLabel:b.localize("rotateClockwise"),minValue:0,maxValue:c.length-1,value:0,stepValue:1,width:200,name:"rotate"}],buttons:[{text:this.localize("remove"),glyph:"xf0e2@FontAwesome",flex:1,ui:"default-toolbar",
handler:function(c){var d=Ext.Array.filter(Ext.Array.from(b.getApiParam("query")),function(b){return b!=a});b.setApiParam("query",d);b.updateFromQueries(0==d.length);c.up("window").close()},scope:this},{xtype:"tbfill"},{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(a){a.up("window").close()}},{text:this.localize("update"),glyph:"xf00c@FontAwesome",flex:1,handler:function(d){var e=d.up("window").down("querysearchfield").getValue().join("|");if(e){for(var f=
-1,g=0;g<c.length;g++)if(a==c[g]){f=g;c[g]=e;var k=d.up("window").down("numberfield").getValue();k&&(c.splice(g,1),g+=k,g>c.length&&(g-=c.length+1),c.splice(g,0,e));break}-1==f&&c.push(e)}b.setApiParam("query",c);b.updateFromQueries(0==c.length);d.up("window").close()},scope:this}]},bodyPadding:5}).show()},updateFromQueries:function(a){this.magnets=void 0;this.documents.forEach(function(a){a.matches=[]});this.updateDocs();this.draw();if(this.documents){var b=this.getApiParams();b.query||(b.limit=
10);var c=Ext.Array.from(this.getApiParam("query"));(!a||0<c.length)&&this.getCorpus().getCorpusTerms().load({params:Ext.apply(b,{withDistributions:!0}),callback:function(a){var b=this.getTargetEl().dom.querySelector("canvas"),d=b.getContext("2d");diam=b.width;rad=diam/2;d.font=this.textFont;var g={};b=0;for(var k=a.length;b<k;b++){var h=a[b].getTerm();a[b].getDistributions().forEach(function(a,b){0<a&&this.documents[b].matches.push(h)},this);g[h]={record:a[b],colour:this.getApplication().getColor(b),
width:d.measureText(h).width,isHovering:!1}}this.magnets={};c.forEach(function(a){g[a]&&(this.magnets[a]=g[a],delete g[a])},this);for(h in g)this.magnets[h]=g[h];this.setApiParam("query",Object.keys(this.magnets));this.updateMagnets();this.updateDocs();this.draw()},scope:this})}},updateMagnets:function(a){a=this.getTargetEl().dom.querySelector("canvas");a=a.width/2;var b=Object.keys(this.magnets||{}).length,c=0,d;for(d in this.magnets)Ext.apply(this.magnets[d],{x:a+(a-this.gutter-50)*Math.cos(2*Math.PI*
c/b),y:a+(a-this.gutter-50)*Math.sin(2*Math.PI*c/b)}),c++},updateDocs:function(a){a=a||this.getTargetEl().dom.querySelector("canvas");diam=a.width;rad=diam/2;var b=[];if(this.documents){this.documents.forEach(function(a,c){if(0==Ext.Array.from(a.matches).length)b.push(c);else if(1==Ext.Array.from(a.matches).length){var d=15*Math.random()+15,e=15*Math.random()+15;a.targetX=this.magnets[a.matches[0]].x+(0==Math.round(Math.random())?d:-d);a.targetY=this.magnets[a.matches[0]].y+(0==Math.round(Math.random())?
e:-e)}else{e=d=0;var k=a.matches.map(function(a){return this.magnets[a].record.getDistributions()[c]},this),h=Ext.Array.min(k),l=Ext.Array.max(k),m=0;a.matches.forEach(function(a,b){weight=l==h?1:(k[b]-h+h)/(l-h+h);m+=weight;d+=this.magnets[a].x*weight;e+=this.magnets[a].y*weight},this);a.targetX=d/m;a.targetY=e/m}},this);a=0;for(var c=b.length;a<c;a++)Ext.apply(this.documents[a],{targetX:rad+(rad-this.gutter)*Math.cos(2*Math.PI*a/c),targetY:rad+(rad-this.gutter)*Math.sin(2*Math.PI*a/c)})}},draw:function(a,
b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.font=this.textFont;var c=a.width/2;b.clearRect(0,0,a.width,a.height);var d=this.getApiParam("labels");b.beginPath();b.strokeStyle="rgba(0,0,0,.1)";b.fillStyle="rgba(0,0,0,.02)";b.arc(c,c,c-this.gutter,0,2*Math.PI,!1);b.fill();b.lineWidth=2;b.stroke();var e=!1;if(this.documents&&0<this.documents.length){var f=Ext.Array.each(this.documents,function(a){return!a.isHovering},this);!0===f&&(f=Ext.Array.each(Object.keys(this.magnets||
{}),function(a){return!this.magnets[a].isHovering},this));var g={};hoveringDocs=[];this.documents.forEach(function(a,c){a.matches.forEach(function(d,e){b.beginPath();b.moveTo(a.x,a.y);b.lineTo(this.magnets[d].x,this.magnets[d].y);!0===f?b.strokeStyle="rgba("+this.magnets[d].colour.join(",")+",.1)":a.isHovering||this.magnets[d].isHovering?(hoveringDocs[c]=!0,g[d]=!0,b.strokeStyle="rgba("+this.magnets[d].colour.join(",")+",.5)"):b.strokeStyle="rgba(0,0,0,.02)";b.stroke()},this)},this);var k=parseInt(this.textFont)/
2,h=parseInt(this.textFont)+4;this.documents.forEach(function(a,c){if(d||a.isHovering||1==hoveringDocs[c]){var g=a.width+4;b.fillStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"white":"rgba(255,255,255,.05)";b.fillRect(a.x-g/2,a.y-h/2,g,h);b.strokeStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"rgba(0,0,0,.2)":"rgba(0,0,0,.05)";b.strokeRect(a.x-g/2,a.y-h/2,g,h);b.textAlign="center";b.fillStyle=a.isHovering||1==hoveringDocs[c]||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)";b.fillText(a.label,a.x,a.y)}else b.beginPath(),
b.fillStyle="rgba(0,0,0,.8)",b.arc(a.x,a.y,k,0,2*Math.PI),b.fill(),b.stroke();c=Math.abs(a.x-a.targetX);g=Math.abs(a.y-a.targetY);if(0!=c||0!=g)1>c?a.x=a.targetX:(c/=2,a.x=a.x>a.targetX?a.x-c:a.x+c),1>g?a.y=a.targetY:(g/=2,a.y=a.y>a.targetY?a.y-g:a.y+g),e=!0},this);a=0;h=parseInt(this.textFont)+4;b.textAlign="center";b.textBaseline="middle";for(var l in this.magnets)d||l in g||this.magnets[l].isHovering?(a=this.magnets[l].width+4,b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"white":"rgba(255,255,255,.05)",
b.fillRect(this.magnets[l].x-a/2,this.magnets[l].y-h/2,a,h),b.strokeStyle=l in g||this.magnets[l].isHovering||!0===f?"rgb("+this.magnets[l].colour.join(",")+")":"rgba(0,0,0,.05)",b.strokeRect(this.magnets[l].x-a/2,this.magnets[l].y-h/2,a,h),b.textAlign="center",b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)",b.fillText(l,this.magnets[l].x,this.magnets[l].y)):(b.beginPath(),b.fillStyle="rgb("+this.magnets[l].colour.join(",")+")",b.strokeStyle="rgb("+this.magnets[l].colour.join(",")+
")",b.arc(this.magnets[l].x,this.magnets[l].y,12,0,2*Math.PI),b.fill(),b.stroke())}if(e){var m=this;setTimeout(function(){m.draw()},100)}else if(this.documents){c=Math.max(c/this.documents.length,50);a=0;for(l=this.documents.length;a<l;a++)for(var n=0;n<l;n++)if(a<n){var p=this.documents[a].x-this.documents[n].x,r=this.documents[a].y-this.documents[n].y;Math.sqrt(p*p+r*r)<c&&(p*=.1,r*=.1,this.documents[a].targetX+=p,this.documents[n].targetX-=p,this.documents[a].targetY+=r,this.documents[n].targetY-=
r,e=!0)}e&&(m=this,setTimeout(function(){m.draw()},100))}}});Ext.define("Voyant.panel.MicroOcp",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microocp",statics:{i18n:{title:"MicroOCP"},api:{config:void 0,stopList:"auto",uri:void 0},glyph:"xf1ea@FontAwesome"},config:{editor:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var b=Ext.create("Ext.data.Store",{fields:[{name:"cocoa",type:"string"}]}),c=this;Ext.apply(this,{title:this.localize("title"),layout:"border",dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",groupId:"tbar",items:[{text:"Create New Voyant Corpus",handler:function(){var a=this.down("grid").getSelectionModel().getSelection().map(function(a){return a.get("cocoa")});if(0==a.length)return this.showError({title:"Error",msg:"No items are selected in the grid (on the right)."});itemsMap={};a.forEach(function(a){itemsMap[a]=!0});var b=this.getEditor().getValue();a=/<(\/)?(\w+)(\s(\w+))?>/g;for(var c,g={};null!=(c=a.exec(b));){var k="/"==c[1],h=c[2],l=
c[4],m=c[4]?c[2]+" "+c[4]:c[2];k||m in itemsMap?(h in g&&(g[h][g[h].length-1].end=c.index),k||(h in g||(g[h]=[]),g[h].push({start:c.index+c[0].length,tag:h,attr:l}))):m in itemsMap&&h in g&&(g[h][g[h].length-1].end=c.index)}isGroupItems=this.getDockedComponent(1).down("checkbox").checked;var n=[];if(isGroupItems){var p={};for(h in g)g[h].forEach(function(a,c){if(c=b.substring(a.start,a.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim())a=a.tag+(a.attr?" "+a.attr:""),p[a]=a in p?p[a]+c:c});for(m in p)n.push({title:m,
text:p[m]})}else for(h in g)g[h].forEach(function(a,c){var d=b.substring(a.start,a.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim();d&&n.push({title:a.tag+(a.attr?" "+a.attr:"")+" "+(c+1),text:d})});if(0==n.length)return this.showError({title:"Error",msg:"No documents found."});this.mask();var r=Ext.Msg.progress("Creating","Creating new corpus."),q=this;(new Corpus({inputFormat:"json",input:Ext.JSON.encode({documents:n}),jsonDocumentsPointer:"/documents",jsonTitlePointer:"/title",jsonContentPointer:"/text"})).then(function(a){r.close();
q.unmask();var b=q.getApplication();q.openUrl(b.getBaseUrl()+"?corpus\x3d"+a.getAliasOrId())})},scope:this},{xtype:"checkbox",boxLabel:"Combine documents with the same tag attribute.",checked:!0}]}],items:[{xtype:"panel",autoScroll:!0,flex:1,height:"100%",align:"stretch",header:!1,region:"center",listeners:{boxready:function(){var a=this,b=ace.edit(Ext.getDom(this.getEl()));c.setEditor(b);b.getSession().setMode("ace/mode/xml");b.renderer.setShowPrintMargin(!1);b.renderer.setShowGutter(!1);b.$blockScrolling=
Infinity;b.setOptions({autoScrollEditorIntoView:!0});b.setBehavioursEnabled(!1);b.on("change",function(c){reparse=!1;if("insert"==c.action)0==c.lines[0].indexOf("\x3e")&&(reparse=!0);else if("remove"==c.action)for(var d=0;d<c.lines.length;d++)if(-1<c.lines[d].indexOf("\x3e")){reparse=!0;break}reparse&&Ext.defer(function(){for(var a=b.getValue(),c=/<(\w+)(\s(\w+))?>/g,d,e={};null!=(d=c.exec(a));)d[3]?e[d[1]+" "+d[3]]=!0:e[d[1]]=!0;a=this.up("panel").down("grid").getStore();var f={};a.getRange().forEach(function(a){f[a.get("cocoa")]=
!0});for(item in e)item in f||a.add({cocoa:item});for(inStoreItem in f)inStoreItem in e||(c=a.findRecord("cocoa",inStoreItem),a.remove(c))},100,a)});c.getApiParam("uri")&&Notebook.loadDataFromUrl(c.getApiParam("uri")).then(function(a){c.getEditor().setValue(a)})}}},{xtype:"grid",region:"east",height:"100%",align:"stretch",scrollable:!0,header:!1,width:200,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"}),store:b,columns:[{text:"COCOA",flex:1,dataIndex:"cocoa"}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){if(!this.getApiParam("uri")){var c=this;b.getPlainText().then(function(a){a=a.replace(/(\r\n|\r|\n)(\r\n|\r|\n)(\r\n|\r|\n)+/g,"\n\n");var b=c.getEditor();b.setValue(a).trim();b.scrollToLine(1,!0,!0,function(){})})}},this);this.on("afterrender",function(a){Ext.Msg.alert("MicroOCP","MicroOCP is an experimental prototype that is intended to give a taste of working with the COCOA markup format (COunt and COncordance on the Atlas). Cocoa tags are like switches, you can place one and that tag remains in effect until the next instance of the tag, which can have an optional attribute (single word). As an enhancement to COCOA, you can also close a tag.\x3cpre\x3e\x26lt;speaker jack\x26gt;I'm falling \x26lt;speaker jill\x26gt;down the hill.\x26lt;/speaker\x26gt;\x3c/pre\x3e")})}});Ext.define("Voyant.panel.Reader",{extend:"Ext.panel.Panel",requires:["Voyant.data.store.Tokens"],mixins:["Voyant.panel.Panel"],alias:"widget.reader",isConsumptive:!0,statics:{i18n:{},api:{start:0,limit:1E3,skipToDocId:void 0,query:void 0},glyph:"xf0f6@FontAwesome"},config:{innerContainer:void 0,tokensStore:void 0,documentsStore:void 0,documentTermsStore:void 0,exportVisualization:!1,lastScrollTop:0,scrollIntoView:!1,insertWhere:"beforeEnd",lastLocationUpdate:new Date,options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}]},SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,LOCATION_UPDATE_FREQ:100,INITIAL_LIMIT:1E3,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){var b=Ext.create("Voyant.data.store.Tokens",{parentTool:this,proxy:{extraParams:{forTool:"reader"}}}),c=this;b.on("beforeload",function(a){return c.hasCorpusAccess(a.getCorpus())});b.on("load",function(a,b,c){if(c){var d="",e=this.localize("documentFrequency"),
f=!1,l=-1,m=!1;b.forEach(function(a){0==a.getPosition()&&(d+="\x3ch3\x3e"+this.getDocumentsStore().getById(a.getDocId()).getFullLabel()+"\x3c/h3\x3e");a.getDocIndex()!=l&&(f=this.getDocumentsStore().getById(a.getDocId()).isPlainText(),l=a.getDocIndex());if(a.isWord())m=!1,d+="\x3cspan class\x3d'word' id\x3d'"+a.getId()+"' data-qtip\x3d'"+e+" "+a.getDocumentRawFreq()+"'\x3e"+a.getTerm()+"\x3c/span\x3e";else{a=a.getTermWithLineSpacing(f);var b=0==a.indexOf("\x3cbr /\x3e");if(!m||!b&&0!=a.trim().length)d+=
a,m=b}},this);this.updateText(d);this.down("querysearchfield").getValue()}},this);this.setTokensStore(b);this.on("query",function(a,b){this.loadQueryTerms(b)},this);this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:!0,withPositions:!0,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",
totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{load:function(a,b,c,g){a.sort("docIndex","ASC");var d;a.each(function(a){d=a.get("term")},this);this.highlightKeywords(d)},scope:this}}));this.on("afterrender",function(){var a=this.down('panel[region\x3d"center"]');this.setInnerContainer(a.getLayout().getRenderTarget());a.body.on("scroll",function(a,b){a=this.getLastScrollTop()<b.scrollTop?this.SCROLL_DOWN:this.getLastScrollTop()>b.scrollTop?this.SCROLL_UP:this.SCROLL_EQ;if(a==this.SCROLL_UP&&
1>b.scrollTop)this.fetchPrevious(!0);else if(a==this.SCROLL_DOWN&&b.scrollHeight-b.scrollTop<1.5*b.offsetHeight)this.fetchNext(!1);else{var c=0==b.scrollTop?0:b.scrollHeight-b.scrollTop==b.clientHeight?1:(b.scrollTop+.5*b.clientHeight)/b.scrollHeight;(new Date-this.getLastLocationUpdate()>this.LOCATION_UPDATE_FREQ||0==c||1==c)&&this.updateLocationMarker(c,a)}this.setLastScrollTop(b.scrollTop)},this);a.body.on("click",function(a,b){b=Ext.get(b);b.hasCls("word")&&(a=Voyant.data.model.Token.getInfoFromElement(b),
b=b.getHtml(),a=[{term:b,docIndex:a.docIndex}],this.loadQueryTerms([b]),this.getApplication().dispatchEvent("termsClicked",this,a))},this);this.getCorpus()&&(this.load(),(a=this.getApiParam("query"))&&this.loadQueryTerms(Ext.isString(a)?[a]:a));this.on("loadedCorpus",function(){this.load(!0);var a=this.getApiParam("query");a&&this.loadQueryTerms(Ext.isString(a)?[a]:a)},this)},this);Ext.apply(this,{title:this.localize("title"),cls:"voyant-reader",layout:"fit",items:{layout:"border",items:[{bodyPadding:10,
region:"center",border:!1,autoScroll:!0,html:'\x3cdiv class\x3d"readerContainer"\x3e\x3c/div\x3e'},{xtype:"readergraph",region:"south",height:40,split:{size:2},splitterResize:!0,border:!1,listeners:{documentRelativePositionSelected:function(a,b){a=this.getDocumentsStore().getAt(b.docIndex);var c=a.get("tokensCount-lexical");b=Math.floor(c*b.fraction)-this.getApiParam("limit")/2;this.setApiParams({skipToDocId:a.getId(),start:0>b?0:b});this.load(!0)},scope:this}}]},dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[{glyph:"xf060@FontAwesome",handler:function(){this.fetchPrevious(!0)},scope:this},{glyph:"xf061@FontAwesome",handler:function(){this.fetchNext(!0)},scope:this},{xtype:"tbseparator"},{xtype:"querysearchfield"}]}],listeners:{loadedCorpus:function(a,b){this.getTokensStore().setCorpus(b);this.getDocumentTermsStore().getProxy().setExtraParam("corpus",b.getId());a=b.getDocuments();this.setDocumentsStore(a);this.rendered&&(this.load(),0==this.hasCorpusAccess(b)&&this.mask(this.localize("limitedAccess"),
"mask-no-spinner"),(b=this.getApiParam("query"))&&this.loadQueryTerms(Ext.isString(b)?[b]:b))},termsClicked:function(a,b){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});0<c.length&&this.loadQueryTerms(c)},corpusTermsClicked:function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.loadQueryTerms(c)},documentTermsClicked:function(a,b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.loadQueryTerms(c)},
documentSelected:function(a,b){a=this.getTokensStore().getCorpus().getDocument(b);this.setApiParams({skipToDocId:a.getId(),start:0});this.load(!0)},documentsClicked:function(a,b,c){0<b.length&&(this.setApiParams({skipToDocId:b[0].getId(),start:0}),this.load(!0))},termLocationClicked:function(a,b){if(void 0!==b[0]){var c=b[0],d=c.get("docIndex"),e=c.get("position");a=e-this.getApiParam("limit")/2;b=this.getCorpus().getDocument(d);this.setApiParams({skipToDocId:b.getId(),start:0>a?0:a});this.load(!0,
{callback:function(){var a=this.body.dom.querySelector("#_"+d+"_"+e);a&&a.scrollIntoView();this.highlightKeywords(c.get("term"),!1)},scope:this})}},documentIndexTermsClicked:function(a,b){void 0!==b[0]&&(a=Ext.create("Voyant.data.model.Token",b[0]),this.fireEvent("termLocationClicked",this,[a]))},scope:this}});this.callParent(arguments)},loadQueryTerms:function(a){a&&0<a.length&&(this.getDocumentTermsStore().load({params:{query:a}}),this.down("readergraph").loadQueryTerms(a))},highlightKeywords:function(a,
b){Ext.isArray(a)||(a=[a]);this.getInnerContainer().first().select("span[class*\x3dkeyword]").removeCls("keyword");var c=[],d=new RegExp("^"+a[0]+"$","i");this.getInnerContainer().first().select("span.word").each(function(a,b,g){a.dom.firstChild&&a.dom.firstChild.nodeValue.match(d)&&(a.addCls("keyword"),c.push(a.dom))})},fetchPrevious:function(a){var b=this.getInnerContainer().first(),c=b.first(".word");if(null!=c&&!1===c.hasCls("loading"))for(;c;){if(c.hasCls("word")){b=Voyant.data.model.Token.getInfoFromElement(c);
var d=b.docIndex;b=b.position;var e=this.getDocumentsStore().getAt(d),f=this.getApiParam("limit"),g=!1;if(0===d&&0===b){a=this.down('panel[region\x3d"center"]').body;0!=c.getScrollIntoViewXY(a,a.dom.scrollTop,a.dom.scrollLeft).y&&c.dom.scrollIntoView();c.frame("red");break}0<d&&0===b?(g=!0,d--,e=this.getDocumentsStore().getAt(d),d=e.get("tokensCount-lexical"),b=d-f,0>b&&(b=0,this.setApiParam("limit",d))):(f--,b-=f);0>b&&(b=0);c.insertSibling("\x3cdiv class\x3d'loading'\x3e"+this.localize("loading")+
"\x3c/div\x3e","before",!1).mask();g||c.destroy();c=e.getId();this.setApiParams({skipToDocId:c,start:b});this.setInsertWhere("afterBegin");this.setScrollIntoView(a);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.first()}},fetchNext:function(a){var b=this.getInnerContainer().first(),c=b.last();if(!1===c.hasCls("loading"))for(;c;){if(c.hasCls("word")){b=Voyant.data.model.Token.getInfoFromElement(c);var d=b.docIndex,e=b.position,f=this.getDocumentsStore().getAt(b.docIndex),
g=f.getId();f=f.get("tokensCount-lexical");if(e+this.getApiParam("limit")>=f&&d==this.getCorpus().getDocumentsCount()-1)if(d=f-e,1>=d){c.dom.scrollIntoView();c.frame("red");break}else this.setApiParam("limit",d);for(d=c.dom.nextSibling;d;)e=d,d=d.nextSibling,e.parentNode.removeChild(e);c.insertSibling("\x3cdiv class\x3d'loading'\x3e"+this.localize("loading")+"\x3c/div\x3e","after",!1).mask();c.destroy();this.setApiParams({skipToDocId:g,start:b.position});this.setInsertWhere("beforeEnd");this.setScrollIntoView(a);
this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.last()}},load:function(a,b){a&&(this.getInnerContainer().first().destroy(),this.getInnerContainer().setHtml('\x3cdiv class\x3d"readerContainer"\x3e\x3cdiv class\x3d"loading"\x3e'+this.localize("loading")+"\x3c/div\x3e\x3c/div\x3e"),this.getInnerContainer().first().first().mask());this.getTokensStore().load(Ext.apply(b||{},{params:Ext.apply(this.getApiParams(),{stripTags:"blocksOnly",stopList:""})}))},updateText:function(a){var b=
this.getInnerContainer().down(".loading");b&&b.destroy();var c=this.getInnerContainer().first().insertHtml(this.getInsertWhere(),a,!0);c&&this.getScrollIntoView()&&(c.dom.scrollIntoView(),Ext.Function.defer(function(){var a=Ext.get(c.id);a&&a.frame("red")},100));a=this.down('panel[region\x3d"center"]').body.dom;this.updateLocationMarker(0==a.scrollTop?0:a.scrollHeight-a.scrollTop==a.clientHeight?1:(a.scrollTop+.5*a.clientHeight)/a.scrollHeight)},updateLocationMarker:function(a,b){var c=Ext.DomQuery.select(".word",
this.getInnerContainer().down(".readerContainer",!0)),d=c[0],e=c[c.length-1];if(void 0!==d&&void 0!==e){c=this.getCorpus();var f=!1;d=Voyant.data.model.Token.getInfoFromElement(Ext.get(d));e=Voyant.data.model.Token.getInfoFromElement(Ext.get(e));0!==d.position&&(f=!0);for(var g={},k=0,h=d.docIndex;h<=e.docIndex;){var l=c.getDocument(h).get("tokensCount-lexical");h===e.docIndex&&(l=e.position);h===d.docIndex&&(l-=d.position);k+=l;g[h]=l;h++}k=Math.round(k*a);h=a=0;for(l=d.docIndex;l<=e.docIndex&&!(a=
l,h+=g[l],h>=k);l++);e=g[a]-(h-k);f&&a===d.docIndex&&(e+=d.position);c=e/c.getDocument(a).get("tokensCount-lexical");this.down("readergraph").moveLocationMarker(a,c,b)}},updateChart:function(){}});Ext.define("Voyant.panel.SimpleDocReader",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.simpledocreader",isConsumptive:!0,statics:{i18n:{},api:{docIndex:void 0,docId:void 0},glyph:"xf0f6@FontAwesome"},config:{},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){Ext.apply(this,{html:'\x3ciframe style\x3d"width: 100%; height: 100%; border: none;"\x3e\x3c/iframe\x3e',dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:[{glyph:"xf060@FontAwesome",handler:this.fetchPrevious,scope:this},{glyph:"xf061@FontAwesome",handler:this.fetchNext,scope:this}]}],listeners:{loadedCorpus:function(a,c){"true"!==this.getApiParam("autoLoadOnLoadedCorpus","false")&&this.fireEvent("documentSelected",this,0)},documentSelected:function(a,c){this.setApiParams({docIndex:this.getCorpus().getDocument(c).getIndex(),docId:void 0});this.fetch()},scope:this}});this.callParent(arguments)},fetchPrevious:function(){var a=
void 0!==this.getApiParam("docIndex")?this.getCorpus().getDocument(this.getApiParam("docIndex")):void 0!==this.getApiParam("docId")?this.getCorpus().getDocument(this.getApiParam("docId")):this.getCorpus().getDocument(1);0<a.getIndex()?(this.setApiParams({docIndex:a.getIndex()-1,docId:void 0}),this.fetch()):this.toastInfo(this.localize("noPrevious"))},fetchNext:function(){if(void 0!==this.getApiParam("docIndex"))var a=this.getCorpus().getDocument(this.getApiParam("docIndex"));else if(void 0!==this.getApiParam("docId"))a=
this.getCorpus().getDocument(this.getApiParam("docId"));else return this.setApiParams({docIndex:0,docId:void 0}),this.fetch();a.getIndex()<this.getCorpus().getDocumentsCount()-1?(this.setApiParams({docIndex:a.getIndex()+1,docId:void 0}),this.fetch()):this.toastInfo(this.localize("noNext"))},fetch:function(){var a=void 0!==this.getApiParam("docIndex")?this.getCorpus().getDocument(this.getApiParam("docIndex")):void 0!==this.getApiParam("docId")?this.getCorpus().getDocument(this.getApiParam("docId")):
this.getCorpus().getDocument(0);var b=this.getTargetEl().down("iframe",!0);b.setAttribute("src","about:blank");if(this.getApiParam("originalUrlMetadataKey")){var c=a.get(this.getApiParam("originalUrlMetadataKey"));if(c){b.setAttribute("src",c);return}}a={corpus:this.getCorpus().getId(),docIndex:a.getIndex(),tool:"corpus.DocumentTokens",template:"docTokensPlusStructure2html",outputFormat:"html",limit:0};c=this.getTromboneUrl()+"?"+Ext.Object.toQueryString(a);b.setAttribute("src",c)}});Ext.define("Voyant.panel.ScatterPlot",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Ext.chart.CartesianChart"],alias:"widget.scatterplot",statics:{i18n:{},api:{docId:void 0,analysis:"ca",limit:50,dimensions:3,bins:10,clusters:3,perplexity:15,iterations:1500,comparisonType:"relative",stopList:"auto",target:void 0,term:void 0,query:void 0,whitelist:void 0,label:["summary","docs","terms"],storeJson:void 0},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],
caStore:null,pcaStore:null,tsneStore:null,docSimStore:null,termStore:null,chartMenu:null,newTerm:null,termsTimeout:null,highlightData:{x:0,y:0,r:0},highlightTask:null},tokenFreqTipTemplate:null,docFreqTipTemplate:null,constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);if("storeJson"in a){var b=JSON.parse(a.storeJson);Ext.apply(a,b)}this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.setCaStore(Ext.create("Voyant.data.store.CAAnalysis",
{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setPcaStore(Ext.create("Voyant.data.store.PCAAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setTsneStore(Ext.create("Voyant.data.store.TSNEAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setDocSimStore(Ext.create("Voyant.data.store.DocSimAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setTermStore(Ext.create("Ext.data.JsonStore",{fields:[{name:"term"},{name:"rawFreq",type:"int"},
{name:"relativeFreq",type:"number"},{name:"coordinates",mapping:"vector"},{name:"category"}],sorters:[{property:"rawFreq",direction:"DESC"}],groupField:"category"}));this.setChartMenu(Ext.create("Ext.menu.Menu",{items:[{text:this.localize("remove"),itemId:"remove",glyph:"xf068@FontAwesome"},{text:this.localize("nearby"),itemId:"nearby",glyph:"xf0b2@FontAwesome"}],listeners:{hide:function(){var a=this.down("#chart").getSeries();a[0].enableToolTips();a[1].enableToolTips()},scope:this}}));this.tokenFreqTipTemplate=
new Ext.Template(this.localize("tokenFreqTip"));this.docFreqTipTemplate=new Ext.Template(this.localize("docFreqTip"));Ext.apply(this,{title:this.localize("title"),layout:"border",autoDestroy:!0,items:[{itemId:"chartParent",region:"center",layout:"fit",tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"filterTerms",width:150},{text:this.localize("labels"),itemId:"labels",glyph:"xf02b@FontAwesome",menu:{items:[{text:this.localize("summaryLabel"),itemId:"summary",xtype:"menucheckitem"},
{text:this.localize("docsLabel"),itemId:"docs",xtype:"menucheckitem"},{text:this.localize("termsLabel"),itemId:"terms",xtype:"menucheckitem"}],listeners:{afterrender:function(a){var b=this.getApiParam("label");a.items.each(function(a){a.setChecked(-1<b.indexOf(a.getItemId()))})},click:function(a,b){a=this.getApiParam("label");var c=b.getItemId();Ext.isString(a)&&(a=[a]);b.checked&&-1==a.indexOf(c)?a.push(c):!b.checked&&-1<a.indexOf(c)&&(a=a.filter(function(a){return a!=c}));this.setApiParam("label",
a);this.doLabels();this.queryById("chart").redraw()},scope:this}}}]},listeners:{query:function(a,b){this.getTermStore().filter([{property:"term",value:b,anyMatch:!0}]);this.filterChart(b)},scope:this}},{itemId:"optionsPanel",title:this.localize("options"),region:"west",split:!0,collapsible:!0,collapseMode:"header",width:135,scrollable:"y",layout:{type:"vbox",align:"stretch"},defaults:{xtype:"button",margin:"5",labelAlign:"top"},items:[{xtype:"label",text:this.localize("input")},{xtype:"documentselectorbutton"},
{text:this.localize("freqsMode"),itemId:"comparisonType",glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("rawFrequencies"),itemId:"comparisonType_raw",group:"freqsMode",xtype:"menucheckitem"},{text:this.localize("relativeFrequencies"),itemId:"comparisonType_relative",group:"freqsMode",xtype:"menucheckitem"},{text:this.localize("tfidf"),itemId:"comparisonType_tfidf",group:"freqsMode",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&
(a=b.getItemId().split("_")[1],a!==this.getApiParam("comparisonType")&&(this.setApiParam("comparisonType",a),this.loadFromApis(!0)))},scope:this}}},{fieldLabel:this.localize("numTerms"),itemId:"limit",xtype:"numberfield",minValue:5,listeners:{change:function(a,b,c){function d(){this.setApiParam("limit",b);this.loadFromApis()}null!==c&&(null!==this.getTermsTimeout()&&clearTimeout(this.getTermsTimeout()),a.isValid()&&this.setTermsTimeout(setTimeout(d.bind(this),500)))},scope:this}},{xtype:"container",
html:'\x3chr style\x3d"border: none; border-top: 1px solid #cfcfcf;"/\x3e'},{xtype:"label",text:this.localize("output")},{text:this.localize("analysis"),itemId:"analysis",glyph:"xf1ec@FontAwesome",overflowHandler:"scroller",menu:{items:[{text:this.localize("pca"),itemId:"analysis_pca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("ca"),itemId:"analysis_ca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("tsne"),itemId:"analysis_tsne",group:"analysis",xtype:"menucheckitem"},
{text:this.localize("docSim"),itemId:"analysis_docSim",group:"analysis",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(a=b.getItemId().split("_")[1],a!==this.getApiParam("analysis")&&(this.doAnalysisChange(a),this.loadFromApis(!0)))},scope:this}}},{fieldLabel:this.localize("perplexity"),itemId:"perplexity",xtype:"slider",minValue:5,maxValue:100,increment:1,listeners:{changecomplete:function(a,b){this.setApiParam("perplexity",b);this.loadFromApis(!0)},scope:this}},{fieldLabel:this.localize("iterations"),
itemId:"iterations",xtype:"slider",minValue:100,maxValue:5E3,increment:100,listeners:{changecomplete:function(a,b){this.setApiParam("iterations",b);this.loadFromApis(!0)},scope:this}},{text:this.localize("clusters"),itemId:"clusters",glyph:"xf192@FontAwesome",menu:{items:[{text:"1",itemId:"clusters_1",group:"clusters",xtype:"menucheckitem"},{text:"2",itemId:"clusters_2",group:"clusters",xtype:"menucheckitem"},{text:"3",itemId:"clusters_3",group:"clusters",xtype:"menucheckitem"},{text:"4",itemId:"clusters_4",
group:"clusters",xtype:"menucheckitem"},{text:"5",itemId:"clusters_5",group:"clusters",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(a=parseInt(b.getItemId().split("_")[1]),a!==this.getApiParam("clusters")&&(this.setApiParam("clusters",a),this.loadFromApis(!0)))},scope:this}}},{text:this.localize("dimensions"),itemId:"dimensions",glyph:"xf1b2@FontAwesome",menu:{items:[{text:"2",itemId:"dimensions_2",group:"dimensions",xtype:"menucheckitem"},{text:"3",itemId:"dimensions_3",group:"dimensions",
xtype:"menucheckitem"}],listeners:{click:function(a,b){if(void 0!==b&&(a=parseInt(b.getItemId().split("_")[1]),a!==this.getApiParam("dimensions"))){if(3==a&&"ca"==this.getApiParam("analysis")&&3==this.getCorpus().getDocumentsCount())return!1;this.setApiParam("dimensions",a);this.loadFromApis(!0)}},scope:this}}},{itemId:"reloadButton",text:this.localize("reload"),glyph:"xf021@FontAwesome",handler:function(){this.loadFromApis()},scope:this}]},{itemId:"termsGrid",xtype:"grid",title:this.localize("terms"),
region:"east",width:250,split:!0,collapsible:!0,collapseMode:"header",forceFit:!0,features:[{ftype:"grouping",hideGroupedHeader:!0,enableGroupingMenu:!1}],bbar:{overflowHandler:"scroller",items:[{itemId:"nearbyButton",xtype:"button",text:this.localize("nearby"),glyph:"xf0b2@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):(a=b.get("term"),this.getNearbyForTerm(a))},scope:this},
{itemId:"removeButton",xtype:"button",text:this.localize("remove"),glyph:"xf068@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):(a=b.get("term"),this.removeTerm(a))},scope:this}]},tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"addTerms",flex:1}]},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),
dataIndex:"rawFreq",flex:.75,minWidth:70,sortable:!0},{text:this.localize("relFreq"),dataIndex:"relativeFreq",flex:.75,minWidth:70,sortable:!0,hidden:!0}],selModel:{type:"rowmodel",mode:"SINGLE",allowDeselect:!0,toggleOnClick:!0,listeners:{selectionchange:{fn:function(a,b){b=b[0];void 0!==b?(a=b.get("term"),b="document"===b.get("category"),this.selectTerm(a,b),b?(this.queryById("nearbyButton").disable(),this.queryById("removeButton").disable()):(this.queryById("nearbyButton").enable(),this.queryById("removeButton").enable())):
this.selectTerm()},scope:this}}},store:this.getTermStore(),listeners:{expand:function(a){a.getView().refresh()},query:function(a,b){0<b.length&&-1===this.getTermStore().findExact("term",b[0])?(this.setNewTerm(b),this.loadFromApis()):this.setNewTerm(null)},scope:this}}]});this.on("boxready",function(a,b,c){400>b&&(this.queryById("optionsPanel").collapse(),this.queryById("termsGrid").collapse());this.config.storeClass&&this.config.storeData&&this.loadStoreFromJson(this.config.storeClass,this.config.storeData)},
this);this.on("beforedestroy",function(a){a=this.queryById("chart");null!==a&&this.queryById("chartParent").remove(a)},this);this.on("loadedCorpus",function(a,b){a=function(a){var b=this.getApiParam(a);this.queryById(a).down("#"+a+"_"+b).setChecked(!0)}.bind(this);a("analysis");this.doAnalysisChange(this.getApiParam("analysis"));a("comparisonType");a("clusters");this.queryById("perplexity").setValue(this.getApiParam("perplexity"));this.queryById("iterations").setValue(this.getApiParam("iterations"));
3==b.getDocumentsCount()&&this.setApiParam("dimensions",2);a("dimensions");this.getCaStore().setCorpus(b);this.getPcaStore().setCorpus(b);this.getDocSimStore().setCorpus(b);this.loadFromApis()},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",b);this.loadFromApis()},this);this.callParent(arguments)},doAnalysisChange:function(a){this.setApiParam("analysis",a);this.queryById("nearbyButton").setDisabled("tsne"===a);this.queryById("reloadButton").setVisible("tsne"===a);this.queryById("perplexity").setVisible("tsne"===
a);this.queryById("iterations").setVisible("tsne"===a);"ca"===a&&3==this.getCorpus().getDocumentsCount()&&(this.setApiParam("dimensions",2),this.queryById("dimensions").menu.items.get(0).setChecked(!0))},loadStoreFromJson:function(a,b){"Voyant.data.store.CAAnalysis"==a?(this.getCaStore().loadRawData(b),this.doAnalysisChange("ca"),this.maskAndBuildChart.call(this,this.getCaStore())):"Voyant.data.store.PCAAnalysis"==a?(this.getPcaStore().loadRawData(b),this.doAnalysisChange("pca"),this.maskAndBuildChart.call(this,
this.getPcaStore())):"Voyant.data.store.TSNEAnalysis"==a?(this.getTsneStore().loadRawData(b),this.doAnalysisChange("tsne"),this.maskAndBuildChart.call(this,this.getTsneStore())):"Voyant.data.store.DocSimAnalysis"==a&&(this.getDocSimStore().loadRawData(b),this.doAnalysisChange("docSim"),this.maskAndBuildChart.call(this,this.getDocSimStore()))},maskAndBuildChart:function(a){this.queryById("chartParent").mask(this.localize("plotting"));Ext.defer(this.buildChart,50,this,[a])},buildChart:function(a){var b=
this,c=this.queryById("chart");null!==c&&this.queryById("chartParent").remove(c);this.queryById("termsGrid").getSelectionModel().deselectAll();c=a.getAt(0);var d=this.getApiParam("dimensions");a="";if("pca"===this.getApiParam("analysis")){for(var e=c.getPrincipalComponents(),f=0,g=0;g<e.length;g++)f+=parseFloat(e[g].get("eigenValue"));if(0!=f){a=this.localize("pcTitle")+"\n";var k=["xAxis","yAxis","fill"];for(g=0;g<e.length&&!(g>=d);g++){var h=e[g].get("eigenValue")/f*100;a+=this.localize("pc")+" "+
(g+1)+" ("+this.localize(k[g])+"): "+Math.round(100*h)/100+"%\n"}}}else if("tsne"!==this.getApiParam("analysis"))for(a=this.localize("caTitle")+"\n",k=["xAxis","yAxis","fill"],e=c.getDimensions(),g=0;g<e.length&&!(g>=d);g++)h=e[g].get("percentage"),a+=this.localize("dimension")+" "+(g+1)+" ("+this.localize(k[g])+"): "+Math.round(100*h)/100+"%\n";var l=0,m=Number.MAX_VALUE,n=0,p=Number.MAX_VALUE;"docSim"!==this.getApiParam("analysis")&&this.getTermStore().removeAll();var r=[],q=[];c.getTokens().forEach(function(a){var b=
a.get("rawFreq"),c=a.get("category");void 0===c&&(c="term",a.set("category","term"));var e="term"===c;e&&(b>l&&(l=b),b<m&&(m=b));this.getTermStore().findExact("term",-1===a.get("term"))&&this.getTermStore().addSorted(a);if(3===d){var f=a.get("vector")[2];void 0!==f&&(f<p&&(p=f),f>n&&(n=f))}b={x:a.get("vector")[0],y:a.get("vector")[1],z:a.get("vector")[2],term:a.get("term"),rawFreq:b,relativeFreq:a.get("relativeFreq"),cluster:a.get("cluster"),category:c,disabled:!1};e?r.push(b):("bin"===a.get("category")?
b.term=b.title="Bin "+a.get("docIndex"):(b.docIndex=a.get("docIndex"),a=this.getCorpus().getDocument(b.docIndex),null!==a&&(b.term=a.getShortTitle(),b.title=a.getTitle())),q.push(b))},this);c=this.getTermStore().getCount();this.queryById("limit").setRawValue(c);this.setApiParam("limit",c);c=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex disabled".split(" "),data:r});g=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex disabled".split(" "),
data:q});a={itemId:"chart",xtype:"cartesian",interactions:["crosszoom","panzoom","itemhighlight"],plugins:{ptype:"chartitemevents"},axes:[{type:"numeric",position:"bottom",fields:["x"],label:{rotate:{degrees:-30}}},{type:"numeric",position:"left",fields:["y"]}],sprites:[{type:"text",text:a,x:70,y:70}],innerPadding:{top:25,right:25,bottom:25,left:25},series:[{type:"customScatter",xField:"x",yField:"y",store:c,label:{font:"14px Helvetica",field:"term",display:"over"},tooltip:{trackMouse:!0,style:"background: #fff",
renderer:function(a,c,d){a.setHtml(b.tokenFreqTipTemplate.apply([c.get("term"),c.get("rawFreq"),c.get("relativeFreq")]))}},marker:{type:"circle"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(a,c,e,f){a=e.store.getAt(f);if(null!==a){var g=a.get("cluster");-1===g&&(g=0);e=.65;f=1;!0===a.get("disabled")?f=e=.1:3===d&&a.get("z")&&(e=b.interpolate(a.get("z"),p,n,0,1));g=b.getApplication().getColor(g);c.fillStyle="rgba("+g.join(",")+","+e+")";c.strokeStyle="rgba("+g.join(",")+","+
f+")";a=a.get("rawFreq");a=b.interpolate(a,m,l,2,20);c.radius=a}},scope:this},{type:"customScatter",xField:"x",yField:"y",store:g,label:{font:"14px Helvetica",field:"term",display:"over",color:this.getDefaultDocColor(!0)},tooltip:{trackMouse:!0,style:"background: #fff",renderer:function(a,c,d){a.setHtml(b.docFreqTipTemplate.apply([c.get("title"),c.get("rawFreq")]))}},marker:{type:"diamond"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(a,c,e,f){a=e.store.getAt(f);null!==a&&
(e=a.get("cluster"),e=-1===e||"docSim"!==b.getApiParam("analysis")?b.getDefaultDocColor():b.getApplication().getColor(e),f=.65,3===d&&a.get("z")&&(f=b.interpolate(a.get("z"),p,n,0,1)),c.fillStyle="rgba("+e.join(",")+","+f+")",c.strokeStyle="rgba("+e.join(",")+",1)",c.radius=5)},scope:this}],listeners:{itemclick:function(a,b,c){a=b.record.data;"doc"===a.category?(a=this.getCorpus().getDocument(a.docIndex),this.getApplication().dispatchEvent("documentsClicked",this,[a])):"term"===a.category&&(a=Ext.create("Voyant.data.model.CorpusTerm",
a),this.getApplication().dispatchEvent("corpusTermsClicked",this,[a]))},render:function(a){a.body.on("contextmenu",function(a,b){a.preventDefault();a=a.getXY();var c=Ext.fly(b).getXY();b=a[0]-c[0];c=a[1]-c[1];var d=this.down("#chart").getItemForPoint(b,c);null!=d&&"term"===d.record.get("category")&&(b=this.down("#chart").getSeries(),b[0].disableToolTips(),b[1].disableToolTips(),c=d.record.get("term"),b=(new Ext.Template(this.localize("removeTerm"))).apply([c]),this.getChartMenu().queryById("remove").setText(b),
b=(new Ext.Template(this.localize("nearbyTerm"))).apply([c]),c=this.getChartMenu().queryById("nearby"),c.setText(b),c.setDisabled("tsne"===this.getApiParam("analysis")),this.getChartMenu().on("click",function(a,b){void 0!==b&&(a=d.record.get("term"),"nearby"===b.getItemId()?this.getNearbyForTerm(a):this.removeTerm(a))},this,{single:!0}),this.getChartMenu().showAt(a))},this)},scope:this}};a=Ext.create("Ext.chart.CartesianChart",a);this.queryById("chartParent").insert(0,a);this.queryById("chartParent").unmask();
this.doLabels();null!==this.getNewTerm()&&(this.selectTerm(this.getNewTerm()[0]),this.setNewTerm(null))},getDefaultDocColor:function(a){return this.getApplication().getColor(6,a)},doLabels:function(){var a=this.queryById("chart"),b=a.getSeries();a=a.getSurface("chart").getItems()[0];var c=this.getApiParam("label");-1<c.indexOf("summary")?a.show():a.hide();-1<c.indexOf("terms")?b[0].getLabel().show():b[0].getLabel().hide();-1<c.indexOf("docs")?b[1].getLabel().show():b[1].getLabel().hide()},selectTerm:function(a,
b){var c=this.down("#chart");if(null!==c)if(void 0===a)c.getSeries()[0].setHighlightItem(null),c.getSeries()[1].setHighlightItem(null);else{if(!0===b){var d=c.getSeries()[1];a=d.getStore().findExact("title",a)}else d=c.getSeries()[0],a=d.getStore().findExact("term",a);if(-1!==a){var e=d.getStore().getAt(a),f=d.getSprites()[0];e={series:d,category:d.getItemInstancing()?"items":"markers",index:a,record:e,field:d.getYField(),sprite:f};d.setHighlightItem(e);b?c.getSeries()[0].setHighlightItem(null):c.getSeries()[1].setHighlightItem(null);
b=this.getPointFromIndex(d,a);this.setHighlightData({x:b[0],y:b[1],r:50});null==this.getHighlightTask()&&this.setHighlightTask(Ext.TaskManager.newTask({run:this.doHighlight,scope:this,interval:25,repeat:this.getHighlightData().r}));this.getHighlightTask().restart()}}},getPointFromIndex:function(a,b){a=a.getSprites()[0];return null!==a.surfaceMatrix?a.attr.matrix.clone().prependMatrix(a.surfaceMatrix).transformPoint([a.attr.dataX[b],a.attr.dataY[b]]):[0,0]},doHighlight:function(){var a=this.down("#chart");
if(0<this.getHighlightData().r){for(var b=a.getSurface(),c=null,d=b.getItems(),e=0;e<d.length;e++){var f=d[e];if("customHighlight"==f.id){c=f;break}}null==c?b.add({id:"customHighlight",type:"circle",strokeStyle:"red",fillStyle:"none",radius:this.getHighlightData().r,x:this.getHighlightData().x,y:this.getHighlightData().y}):(c.setAttributes({x:this.getHighlightData().x,y:this.getHighlightData().y,radius:this.getHighlightData().r}),this.getHighlightData().r-=1.5,0>=this.getHighlightData().r&&(this.getHighlightData().r=
0,b.remove(c,!0)));a.redraw()}},filterChart:function(a){Ext.isString(a)&&(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(new RegExp(a[c]));a=this.queryById("chart");c=a.getSeries()[0];var d=c.getLabel();c.getStore().each(function(a){var c=!1;if(0==b.length)c=!0;else for(var e=0;e<b.length&&!(c=c||b[e].test(a.get("term")));e++);a.set("disabled",!c);a=a.store.indexOf(a);d.setAttributesFor(a,{hidden:!c})},this);a.redraw()},getCurrentTerms:function(){var a=[];this.getTermStore().each(function(b){"term"===
b.get("category")&&a.push(b.get("term"))});return a},getNearbyForTerm:function(a){var b=Math.max(2E3,Math.round(this.getCorpus().getWordTokensCount()/100));this.setApiParams({limit:b,target:a});this.loadFromApis();this.setApiParam("target",void 0)},removeTerm:function(a){var b=this.down("#chart").getSeries()[0],c=b.getStore().findExact("term",a);b.getStore().removeAt(c);c=this.getTermStore().findExact("term",a);this.getTermStore().removeAt(c);a=this.getTermStore().getCount();this.queryById("limit").setRawValue(a)},
loadFromApis:function(a){this.queryById("chartParent").mask(this.localize("analyzing"));var b={},c=this.getCurrentTerms();null!==this.getNewTerm()&&(c=c.concat(this.getNewTerm()),this.setApiParam("limit",c.length));0<c.length&&(null!==this.getNewTerm()||a)&&(b.query=c.join(","));Ext.apply(b,this.getApiParams());null!=b.target&&(b.term=c);"pca"===b.analysis?this.getPcaStore().load({params:b}):"tsne"===b.analysis?this.getTsneStore().load({params:b}):"docSim"===b.analysis?this.getDocSimStore().load({params:b}):
this.getCaStore().load({params:b})},interpolate:function(a,b,c,d,e){return d+(e-d)*Math.max(0,Math.min(1,(a-b)/(c-b)))}});Ext.define("Ext.chart.series.CustomScatter",{extend:"Ext.chart.series.Scatter",alias:"series.customScatter",type:"customScatter",seriesType:"scatterSeries",tipsDisabled:!1,enableToolTips:function(){this.tipsDisabled=!1},disableToolTips:function(){this.tipsDisabled=!0},showTip:function(a,b){this.tipsDisabled||this.callParent(arguments)}});Ext.define("Voyant.panel.StreamGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.streamgraph",statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,withDistributions:"relative",bins:50,docIndex:void 0,docId:void 0},glyph:"xf1fe@FontAwesome"},config:{visLayout:void 0,vis:void 0,mode:"corpus",layerData:void 0,graphId:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},graphMargin:{top:20,right:60,bottom:110,left:80},MODE_CORPUS:"corpus",MODE_DOCUMENT:"document",
constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setGraphId(Ext.id(null,"streamgraph_"))},initComponent:function(){Ext.apply(this,{title:this.localize("title"),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:["-\x3e",{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark","active"]}),listeners:{itemclick:function(a,b,c,d){a=Ext.fly(c.firstElementChild).hasCls("x-legend-inactive");b.set("active",a);b=this.getCurrentTerms();
this.setApiParams({query:b,limit:b.length,stopList:void 0,categories:this.getApiParam("categories")});this.loadFromCorpus()},scope:this}},"-\x3e"]}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"button",text:this.localize("clearTerms"),handler:function(){this.setApiParams({query:void 0});this.loadFromRecords([])},scope:this},{xtype:"corpusdocumentselector",singleSelect:!0},{text:this.localize("freqsMode"),glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),
menu:{items:[{text:this.localize("relativeFrequencies"),checked:!0,itemId:"relative",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","relative"),this.loadFromCorpus())},scope:this},{text:this.localize("rawFrequencies"),checked:!1,itemId:"raw",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","raw"),this.loadFromCorpus())},scope:this}]}},{xtype:"slider",itemId:"segmentsSlider",fieldLabel:this.localize("segments"),labelAlign:"right",
labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{afterrender:function(a){a.setValue(this.getApiParam("bins"))},changecomplete:function(a,b){this.setApiParams({bins:b});this.loadFromCorpus()},scope:this}}]}});this.on("loadedCorpus",function(a,b){1==this.getCorpus().getDocumentsCount()&&this.getMode()!=this.MODE_DOCUMENT&&this.setMode(this.MODE_DOCUMENT);"bins"in this.getModifiedApiParams()||this.getMode()!=this.MODE_CORPUS||(a=b.getDocumentsCount(),this.setApiParam("bins",100<
a?100:a));this.isVisible()&&this.loadFromCorpus()},this);this.on("corpusSelected",function(a,b){a.isXType("corpusdocumentselector")&&(this.setMode(this.MODE_CORPUS),this.setApiParams({docId:void 0,docIndex:void 0}),this.setCorpus(b),this.loadFromCorpus())});this.on("documentSelected",function(a,b){a=b.getId();this.setApiParam("docId",a);this.loadFromDocumentTerms()},this);this.on("query",function(a,b){a=this.getCurrentTerms();a.push(b);this.setApiParams({query:a,limit:a.length,stopList:void 0});this.getMode()===
this.MODE_DOCUMENT?this.loadFromDocumentTerms():this.loadFromCorpusTerms(this.getCorpus().getCorpusTerms())},this);this.on("resize",this.resizeGraph,this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},loadFromCorpus:function(){var a=this.getCorpus();this.getApiParam("docId")||this.getApiParam("docIndex")?this.loadFromDocumentTerms():1==a.getDocumentsCount()?this.loadFromDocument(a.getDocument(0)):this.loadFromCorpusTerms(a.getCorpusTerms())},loadFromCorpusTerms:function(a){var b=
this.getApiParams("limit stopList query withDistributions bins categories".split(" "));b.bins&&b.bins>this.getCorpus().getDocumentsCount()&&(b.bins=this.getCorpus().getDocumentsCount());a.load({callback:function(a,b,e){e?(this.setMode(this.MODE_CORPUS),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetCorpusTerms"),b)},scope:this,params:b})},loadFromDocument:function(a){if(a.then){var b=this;a.then(function(a){b.loadFromDocument(a)})}else"Voyant.data.model.Document"==
Ext.getClassName(a)&&(this.setApiParams({docIndex:void 0,query:void 0,docId:a.getId()}),this.isVisible()&&this.loadFromDocumentTerms())},loadFromDocumentTerms:function(a){this.getCorpus()&&(a=a||this.getCorpus().getDocumentTerms({autoLoad:!1}),a.load({callback:function(a,c,d){d?(this.setMode(this.MODE_DOCUMENT),this.loadFromRecords(a)):Voyant.application.showResponseError(this.localize("failedGetDocumentTerms"),c)},scope:this,params:this.getApiParams("docId docIndex limit stopList query withDistributions bins categories".split(" "))}))},
loadFromRecords:function(a){var b=[],c=[];a.forEach(function(a,e){e=a.getTerm();a=a.get("distributions");for(var d=0;d<a.length;d++)void 0===c[d]&&(c[d]={}),c[d][e]=a[d];b.push({id:e,name:e,mark:this.getApplication().getColorForTerm(e,!0),active:!0})},this);this.setLayerData(c);this.down("[xtype\x3dlegend]").getStore().loadData(b);this.doLayout()},doLayout:function(a){a=this.getLayerData();if(void 0!==a){var b=this,c=[];this.down("[xtype\x3dlegend]").getStore().each(function(a){c.push(a.getId())});
if(this.getMode()===this.MODE_DOCUMENT)var d=this.getApiParam("bins");else{d=this.getApiParam("bins");var e=this.getCorpus().getDocumentsCount();d=d<e?d:e}this.getVisLayout().keys(c);e=this.getVisLayout()(a);a=this.body.down("svg").getWidth()-this.graphMargin.left-this.graphMargin.right;var f=d3.scaleLinear().domain([0,d-1]).range([0,a]),g=d3.min(e,function(a){return d3.min(a,function(a){return a[0]})}),k=d3.max(e,function(a){return d3.max(a,function(a){return a[1]})});d=this.body.down("svg").getHeight()-
this.graphMargin.top-this.graphMargin.bottom;var h=d3.scaleLinear().domain([g,k]).range([d,0]),l=d3.area().x(function(a,b){return f(b)}).y0(function(a){return h(a[0])}).y1(function(a){return h(a[1])}).curve(d3.curveCatmullRom);if(this.getMode()===this.MODE_CORPUS){var m=[];this.getCorpus().getDocuments().each(function(a){m.push(a.getTinyLabel())});g=d3.scalePoint().domain(m).range([0,a]);k=d3.axisBottom(g)}else k=d3.axisBottom(f);g=d3.axisLeft(h);e=this.getVis().selectAll("path").data(e,function(a){return a});
e.attr("d",function(a){return l(a)}).style("fill",function(a){return b.getApplication().getColorForTerm(a.key,!0)}).select("title").text(function(a){return a.key});e.enter().append("path").attr("d",function(a){return l(a)}).style("fill",function(a){return b.getApplication().getColorForTerm(a.key,!0)}).append("title").text(function(a){return a.key});e.exit().remove();this.getVis().selectAll("g.axis").remove();this.getVis().append("g").attr("class","axis x").attr("transform","translate(0,"+d+")").call(k);
this.getMode()===this.MODE_CORPUS?(this.getVis().select("g.axis.x").selectAll("text").each(function(){d3.select(this).attr("text-anchor","end").attr("transform","rotate(-45)")}),e=this.localize("documents")):e=this.localize("documentSegments");this.getVis().select("g.axis.x").append("text").attr("text-anchor","middle").attr("transform","translate("+a/2+", "+(this.graphMargin.bottom-30)+")").attr("fill","#000").text(e);this.getVis().append("g").attr("class","axis y").attr("transform","translate(0,0)").call(g);
a="raw"===this.getApiParam("withDistributions")?this.localize("rawFrequencies"):this.localize("relativeFrequencies");this.getVis().select("g.axis.y").append("text").attr("text-anchor","middle").attr("transform","translate(-"+(this.graphMargin.left-20)+", "+d/2+") rotate(-90)").attr("fill","#000").text(a)}},getCurrentTerms:function(){var a=[];this.down("[xtype\x3dlegend]").getStore().each(function(b){b.get("active")&&a.push(b.get("name"))},this);return a},initGraph:function(){if(void 0===this.getVisLayout()){var a=
this.getLayout().getRenderTarget();this.setVisLayout(d3.stack().offset(d3.stackOffsetWiggle).order(d3.stackOrderInsideOut));this.setVis(d3.select(a.dom).append("svg").attr("id",this.getGraphId()).append("g").attr("transform","translate("+this.graphMargin.left+","+this.graphMargin.top+")"));this.resizeGraph()}},resizeGraph:function(){var a=this.body,b=a.getWidth(),c=a.getHeight();d3.select(a.dom).select("svg").attr("width",b).attr("height",c);this.doLayout()}});Ext.define("Voyant.panel.Summary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.summary",statics:{i18n:{},api:{stopList:"auto",start:0,limit:5,numberOfDocumentsForDistinctiveWords:10},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},autoScroll:!0,cls:"corpus-summary",constructor:function(a){Ext.apply(this,{title:this.localize("title"),items:{itemId:"main",cls:"main",margin:10},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{afterrender:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,c){this.setApiParams({limit:c});this.loadSummary()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("afterrender",function(){this.body.addListener("click",function(a){(a=a.getTarget(null,null,!0))&&"A"==a.dom.tagName&&
(a.hasCls("document-id")?(a=a.getAttribute("val","voyant"),a=this.getCorpus().getDocuments().getById(a),this.dispatchEvent("documentsClicked",this,[a])):a.hasCls("corpus-type")?this.dispatchEvent("termsClicked",this,[a.getHtml()]):a.hasCls("document-type")&&this.dispatchEvent("documentIndexTermsClicked",this,[{term:a.getHtml(),docIndex:a.getAttribute("docIndex","voyant")}]))},this)});this.on("loadedCorpus",function(a,c){if(this.rendered)this.loadSummary();else this.on("afterrender",function(){this.loadSummary()},
this)});a&&a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("resize",function(){var a=this.getWidth()-200;this.query("sparklineline").forEach(function(b){b.getWidth()>a&&b.setWidth(a)})},this)},loadSummary:function(){var a=this,b=this.queryById("main");b.removeAll();b.add({html:this.getCorpus().getString()});var c=this.getCorpus().getDocuments().getRange(),d=this.getApiParam("limit");if(1<c.length){c.sort(function(a,b){return b.getLexicalTokensCount()-a.getLexicalTokensCount()});var e=
new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id" voyant:val\x3d"{id}" data-qtip\x3d"{title}"\x3e{shortTitle}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e (\x3cspan class\x3d"info-tip" data-qtip\x3d"{valTip}"\x3e{val}\x3c/span\x3e)\x3c/span\x3e\x3c/a\x3e\x3c/tpl\x3e');if(25>c.length)var f=4*c.length;else 50>c.length?f=2*c.length:100<c.length&&(f=b.getWidth()-200,f=f<c.length?c.length:f);var g=this.localize("numberOfTerms");
b.add({cls:"section",items:[{layout:"hbox",align:"bottom",items:[{html:this.localize("docsLength"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(a){return a.getLexicalTokensCount()}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,b){return"("+b+") "+this.panel.getCorpus().getDocument(a).getTitle()},panel:a}),height:16,width:f}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("longest")+" "+e.apply(c.slice(0,
c.length>d?d:parseInt(c.length/2)).map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:a.getLexicalTokensCount(),valTip:g}}))+"\x3c/li\x3e\x3cli\x3e"+this.localize("shortest")+" "+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:a.getLexicalTokensCount(),valTip:g}}))+"\x3c/li\x3e"}]});c.sort(function(a,b){return b.getLexicalTypeTokenRatio()-a.getLexicalTypeTokenRatio()});
b.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("docsDensity"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(a){return Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,b){return"("+b+") "+this.panel.getCorpus().getDocument(a).getTitle()},panel:a}),height:16,width:f}]},{html:"\x3cul\x3e\x3cli\x3e"+
this.localize("highest")+e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000"),valTip:g}}))+"\x3c/li\x3e\x3cli\x3e"+this.localize("lowest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getLexicalTypeTokenRatio(),"0.000"),
valTip:g}}))+"\x3c/li\x3e"}]});c.sort(function(a,b){return b.getAverageWordsPerSentence()-a.getAverageWordsPerSentence()});b.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("averageWordsPerSentence"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(a){return Ext.util.Format.number(a.getAverageWordsPerSentence(),"0.0")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,
b){return"("+b+") "+this.panel.getCorpus().getDocument(a).getTitle()},panel:a}),height:16,width:f}]},{html:"\x3cul\x3e\x3cli\x3e"+this.localize("highest")+e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(a){return{id:a.getId(),shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getAverageWordsPerSentence(),"0.0"),valTip:g}}))+"\x3c/li\x3e\x3cli\x3e"+this.localize("lowest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(a){return{id:a.getId(),
shortTitle:a.getShortTitle(),title:a.getTitle(),val:Ext.util.Format.number(a.getAverageWordsPerSentence(),"0.0"),valTip:g}}))+"\x3c/li\x3e"}]})}else if(d=c[0])b.add({cls:"section",html:"\x3cb\x3e"+this.localize("docsDensity")+"\x3c/b\x3e "+Ext.util.Format.number(d.getLexicalTypeTokenRatio(),"0.000")}),b.add({cls:"section",html:"\x3cb\x3e"+this.localize("averageWordsPerSentence")+"\x3c/b\x3e "+Ext.util.Format.number(d.getAverageWordsPerSentence(),"0.0")});b.add({html:this.localize("mostFrequentWords"),
cls:"section",listeners:{afterrender:function(b){b.mask(a.localize("loading"));a.getCorpus().getCorpusTerms().load({params:{limit:a.getApiParam("limit"),stopList:a.getApiParam("stopList"),forTool:"summary"},callback:function(a,c,d){d&&a&&0<a.length&&(b.unmask(),Ext.dom.Helper.append(b.getTargetEl().first().first(),(new Ext.XTemplate('\x3ctpl for\x3d"." between\x3d"; "\x3e\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"corpus-type keyword" voyant:recordId\x3d"{id}"\x3e{term}\x3c/a\x3e\x3cspan style\x3d"font-size: smaller"\x3e ({val})\x3c/span\x3e\x3c/tpl\x3e')).apply(a.map(function(a){return{id:a.getId(),
term:a.getTerm(),val:a.getRawFreq()}}))))}})}},scope:this});1<c.length&&b.add({html:this.localize("distinctiveWords")+"\x3col\x3e\x3c/ol\x3e",cls:"section",itemId:"distinctiveWords",listeners:{afterrender:function(b){a.showMoreDistinctiveWords()}},scope:this})},showMoreDistinctiveWords:function(){var a=this.queryById("distinctiveWords"),b=a.getTargetEl().selectNode("ol"),c=Ext.dom.Query.select("li:not(.more)",b).length,d=parseInt(this.getApiParam("numberOfDocumentsForDistinctiveWords")),e=this.getCorpus().getDocuments().getRange(c,
c+d-1);if(e&&Ext.isArray(e)){var f=[];e.forEach(function(a){f.push(a.getIndex())});0<f.length&&this.getCorpus().getDocumentTerms().load({addRecords:!0,params:{docIndex:f,perDocLimit:parseInt(this.getApiParam("limit")),limit:d*parseInt(this.getApiParam("limit")),stopList:this.getApiParam("stopList"),sort:"TFIDF",dir:"DESC",forTool:"summary"},scope:this,callback:function(e,k,h){var g={};if(h&&e&&Ext.isArray(e)){e.forEach(function(a,b,c){b=a.getDocIndex();b in g||(g[b]=[]);g[b].push({id:a.getId(),docIndex:a.getDocIndex(),
type:a.getTerm(),val:Ext.util.Format.number(a.get("rawFreq"),"0,000"),docId:a.get("docId")})});f.forEach(function(a){if(g[a]){var c=this.getCorpus().getDocument(a);m=g[a].length;Ext.dom.Helper.append(b,{tag:"li","voyant:index":String(a),html:'\x3ca href\x3d"#" onclick\x3d"return false" class\x3d"document-id document-id-distinctive" voyant:val\x3d"'+c.get("id")+'"\x3e'+c.getShortTitle()+"\x3c/a\x3e"+this.localize("colon")+" "+(new Ext.XTemplate(this.localize("documentType"))).apply({types:g[a]})+"."})}},
this);a.updateLayout();var m=d;remaining=this.getCorpus().getDocuments().getTotalCount()-c-f.length;if(0<remaining){e=new Ext.Template(this.localize("moreDistinctiveWords"));var n=Ext.dom.Helper.append(b,{tag:"li",cls:"more",html:e.apply([m>remaining?remaining:m,remaining])},!0);n.on("click",function(){n.remove();this.showMoreDistinctiveWords()},this)}}}})}}});Ext.define("Voyant.panel.TextualArc",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.textualarc",statics:{i18n:{},api:{stopList:"auto",docIndex:0,speed:50,minRawFreq:2},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"container",items:{xtype:"numberfield",name:"minRawFreq",minValue:1,maxValue:10,value:2,labelWidth:150,labelAlign:"right",initComponent:function(){var a=this.up("window").panel;this.fieldLabel=a.localize(this.fieldLabel);this.on("afterrender",
function(b){Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("minRawFreqTip")})});this.on("beforedestroy",function(a){Ext.tip.QuickTipManager.unregister(a.getEl())});this.callParent(arguments)},fieldLabel:"minRawFreq"}}],perim:[],diam:void 0},tokensFetch:500,constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);this.config.options[1].fieldLabel=this.localize(this.config.options[1].fieldLabel);Ext.apply(this,{title:this.localize("title"),
html:'\x3ccanvas width\x3d"800" height\x3d"600"\x3e\x3c/canvas\x3e',dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",itemId:"search",queryMode:"local",displayField:"term",valueField:"term",width:90,emptyText:this.localize("search"),forceSelection:!0,disabled:!0},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:0,maxValue:100,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));
Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},changecomplete:function(a,b){this.setApiParam("speed",b);this.isReading=0!==b;this.draw()},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().dom.querySelector("canvas");
this.draw(b);b.addEventListener("mousemove",function(c){if(a.documentTerms){var d=b.getBoundingClientRect(),e=c.clientX-d.left,f=c.clientY-d.top,g={};a.documentTerms.each(function(a){var b=a.get("x"),c=a.get("y");if(b>e-15&&b<e+15&&c>f-15&&c<f+15)return g[a.getTerm()]=!0,!1});if(0!=Object.keys(a.currentTerms||{}).length||0!=Object.keys(g).length)a.currentTerms=g,a.draw(b)}},!1)});this.on("loadedCorpus",function(a,b){this.loadDocument()},this);this.on("documentselected",function(a,b){this.setApiParam("docIndex",
this.getCorpus().getDocument(b).getIndex());this.loadDocument()});this.on("resize",function(){var a=this.getTargetEl().getWidth()-20-20,b=this.getTargetEl().getHeight()-20-20,c=Math.max(a,b),d=c/2,e=Math.min(a,b)/c,f=this.getTargetEl().dom.querySelector("canvas");f.width=this.getTargetEl().getWidth();f.height=this.getTargetEl().getHeight();this.setDiam(c);this.setPerim([]);for(f=parseInt(.75*c);this.getPerim().length<c;)this.getPerim().push({x:20+a/2+d*(a>b?1:e)*Math.cos(2*Math.PI*f/c),y:20+b/2+d*
(b>a?1:e)*Math.sin(2*Math.PI*f/c)}),f++==c&&(f=0)})},draw:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.clearRect(0,0,a.width,a.height);b.fillStyle="rgba(0,0,0,.1)";this.getPerim().forEach(function(a,c){0==c%3&&b.fillRect(a.x-5,a.y,10,1)});if(this.documentTerms&&(this.drawTerms(a,b),this.drawReading(a,b),this.isReading)){var c=this;setTimeout(function(){c.draw()},10)}},drawReading:function(a,b){b=b||this.getTargetEl().dom.querySelector("canvas").getContext("2d");
var c=2E3-1999*parseInt(this.getApiParam("speed"))/100;if(this.isReading&&this.documentTerms){var d=parseInt(this.readingIndex*this.getPerim().length/this.lastToken);b.fillStyle="purple";b.fillRect(this.getPerim()[d].x,this.getPerim()[d].y,5,5);var e=void 0==this.readingStartTime;this.readingStartTime=this.readingStartTime||(new Date).getTime();d=this.readingStartTime+c-(new Date).getTime();if(this.sourceTerm&&this.targetTerm){if(e||0>=d){this.previousBeziers=this.previousBeziers||[];e=this.sourceTerm.get("x");
var f=this.sourceTerm.get("y"),g=this.targetTerm.get("x"),k=this.targetTerm.get("y");this.previousTerm&&this.previousTerm.get("x");this.previousTerm&&this.previousTerm.get("y");var h=Math.max(100,.5*Math.abs(e-g)),l=Math.max(100,.5*Math.abs(f-k));this.previousBeziers.unshift([e,f,e>g?e-h:e+h,k>f?f+l:f-l,g,k]);10<this.previousBeziers.length&&this.previousBeziers.pop()}for(e=0;e<this.previousBeziers.length;e++)b.strokeStyle="rgba(0,0,255,"+(1-.1*e)+")",this.drawBezierSplit.apply(this,Ext.Array.merge([b],
this.previousBeziers[e],[e+1==this.previousBeziers.length?1-d/c:0],[0==e?1-d/c:1]));0>=d&&(this.readingStartTime=void 0,this.read())}e=this.readingIndex+1;for(f=this.tokens.getCount();e<f&&this.tokens.getAt(e).getTerm().toLowerCase()!=this.targetTerm.getTerm();e++);c=e-parseInt(d*(e-this.readingIndex)/c);for(d=this.tokens.getCount();c<e&&!(c<d&&this.tokens.getAt(c).isWord());c++);c=this.tokens.getRange(c,f=Math.min(this.readingIndex+50,this.tokens.getCount())).map(function(a){return a.getTerm()});
b.font="14px sans-serif";b.fillStyle="rgba(0,0,0,.5)";b.textAlign="left";b.fillText(c.join(""),a.width/4,a.height-5);b.clearRect(.75*a.width,a.height-20,a.width,30)}else this.documentTerms&&this.documentTerms.getCount()<this.documentTerms.getTotalCount()&&(c=a.width/4,b.strokeStyle="rgba(0,0,0,.5)",b.fillStyle="rgba(0,0,0,.2)",b.strokeRect(c,a.height-12,2*c,10),b.fillRect(c,a.height-12,this.documentTerms.getCount()*c*2/this.documentTerms.getTotalCount(),10))},drawTerms:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");
b=b||a.getContext("2d");b.textAlign="center";this.documentTerms&&0<this.getPerim().length&&this.documentTerms.each(function(c){var d=c.getRawFreq(),e=c.getTerm(),f=c.get("x"),g=c.get("y");isCurrentTerm=this.currentTerms&&e in this.currentTerms;isReadingTerm=this.sourceTerm&&this.sourceTerm.getTerm()==e;b.font=10*a.width/800*Math.log(d)/Math.log(this.maxRawFreq)+(isCurrentTerm||isReadingTerm?10:5)+"px sans-serif";b.fillStyle=isCurrentTerm?"red":isReadingTerm?"blue":"rgba(0,0,0,"+(.9*d/this.maxRawFreq+
.1)+")";if(isCurrentTerm||isReadingTerm)b.strokeStyle=isCurrentTerm?"rgba(255,0,0,.2)":"rgba(0,255,0,.4)",c.getDistributions().forEach(function(a,c){0<a&&this.getPerim()[c]&&(b.beginPath(),b.moveTo(f,g),b.lineTo(this.getPerim()[c].x,this.getPerim()[c].y),b.stroke())},this);b.fillText(e,f,g)},this)},read:function(a){Ext.isNumber(a)?this.readingIndex=a:this.readingIndex++;this.sourceTerm&&(this.previousTerm=this.sourceTerm);a=this.readingIndex;for(var b=this.tokens.getCount();a<b;a++){var c=this.tokens.getAt(a);
c=c.getTerm().toLowerCase();if(c in this.termsMap&&(this.sourceTerm=this.termsMap[c],1<=this.sourceTerm.getRawFreq())){this.readingIndex=a;break}}a=this.readingIndex+1;for(b=this.tokens.getCount();a<b&&!(c=this.tokens.getAt(a),c=c.getTerm().toLowerCase(),c in this.termsMap&&(this.targetTerm=this.termsMap[c],1<=this.targetTerm.getRawFreq()));a++);!this.tokensLoading&&this.tokens.getCount()-this.readingIndex<this.tokensFetch&&this.fetchMoreTokens();this.draw()},loadDocument:function(){this.documentTerms&&
(this.documentTerms.destroy(),this.documentTerms=void 0);this.termsMap={};this.draw();var a=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));this.up("tabpanel")||this.setTitle(this.localize("title")+" \x3cspan class\x3d'subtitle'\x3e"+a.getFullLabel()+"\x3c/span\x3e");this.lastToken=parseInt(a.get("lastTokenStartOffset-lexical"));this.documentTerms=a.getDocumentTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList"),bins:this.getDiam(),withDistributions:"raw",minRawFreq:parseInt(this.getApiParam("minRawFreq"))}}});
a=this.queryById("search");a.setDisabled(!0);a.setStore(this.documentTerms);this.fetchMoreDocumentTerms()},fetchMoreDocumentTerms:function(){this.documentTerms?this.documentTerms.load({params:{start:this.documentTerms.getCount(),limit:0==this.documentTerms.getCount()?10:250},callback:function(a){0<a.length?(this.maxRawFreq=this.documentTerms.max("rawFreq"),a.forEach(function(a){var b=y=0;a.get("distributions").forEach(function(a,c){b+=this.getPerim()[c].x*a;y+=this.getPerim()[c].y*a},this);a.set("x",
b/a.getRawFreq());a.set("y",y/a.getRawFreq())},this),Ext.Function.defer(this.fetchMoreDocumentTerms,0,this),this.draw()):(this.queryById("search").setDisabled(!1),this.termsMap={},this.documentTerms.each(function(a){this.termsMap[a.getTerm()]=a},this),this.tokens&&this.tokens.removeAll(!0),this.fetchMoreTokens())},addRecords:!0,scope:this}):this.loadDocument()},fetchMoreTokens:function(){if(!this.tokens)this.tokens=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex"))).getTokens({proxy:{extraParams:{stripTags:"all"}}}),
this.noMoreTokens=!1;else if(this.noMoreTokens)return;var a=0==this.tokens.getCount();this.tokensLoading=!0;var b=parseInt(this.getApiParam("speed"));this.tokens.load({params:{start:this.tokens.getCount(),limit:50==b&&a?200:Math.pow(110-b,2)},callback:function(b){this.tokensLoading=!1;0<b.length?(b.forEach(function(a){"other"==a.getTokenType()&&a.set("term",a.getTerm().replace(/\s+/g," "))}),a&&(this.previousBeziers=[],this.isReading=!0,this.read(0))):this.noMoreTokens=!0},addRecords:!0,scope:this})},
animatePathDrawing:function(a,b,c,d,e,f,g,k){var h=null,l=function(m){null===h&&(h=m);m=Math.min((m-h)/k,1);a.clearRect(0,0,a.canvas.width,a.canvas.height);drawBezierSplit(a,b,c,d,e,f,g,0,m);1>m&&window.requestAnimationFrame(l)};window.requestAnimationFrame(l)},drawBezierSplit:function(a,b,c,d,e,f,g,k,h){a.beginPath();if(0==k&&1==h)a.moveTo(b,c),a.quadraticCurveTo(d,e,f,g);else if(k!=h){var l=k*k,m=1-k,n=m*m,p=2*k*m,r=n*b+p*d+l*f,q=n*c+p*e+l*g;l=h*h;m=1-h;n=m*m;p=2*h*m;m=n*b+p*d+l*f;l=n*c+p*e+l*g;
b=this.lerp(this.lerp(b,d,k),this.lerp(d,f,k),h);c=this.lerp(this.lerp(c,e,k),this.lerp(e,g,k),h);a.moveTo(r,q);a.quadraticCurveTo(b,c,m,l)}a.stroke();a.closePath()},lerp:function(a,b,c){return(1-c)*a+c*b}});Ext.define("Voyant.panel.TopicContexts",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.topiccontexts",statics:{i18n:{},api:{},glyph:"xf06e@FontAwesome"},constructor:function(a){Ext.apply(this,{title:this.localize("title"),cls:"twic_body"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{loadedCorpus:function(a,b){this.loadFromCorpus(b)}},loadFromCorpus:function(a){a=Ext.Loader.getPath("resources")+"/twic/current/data/input/json";
var b=TWiC.Level.prototype.Instance();b.LoadJSON(a+"/twic_corpusinfo.json",a+"/twic_corpusmap.json");var c=this;b.m_queue.await(function(){var a=[],e=[],f=new TWiC.TopicBar({x:0,y:635},{width:1280,height:165},"dickinson",b,[]);e.push(f);var g=new TWiC.DocumentBar({x:1055,y:0},{width:225,height:635},"dickinson",b,[]);e.push(g);g=new TWiC.CorpusClusterView({x:0,y:0},{width:1055,height:635},"dickinson",b,[f,g]);a.push(g);f.m_linkedViews.push(g);f=c.getLayout().getRenderTarget();b.Initialize([0,0],{width:f.getWidth(),
height:f.getHeight()},"dickinson",a,e,"#"+f.getId());b.Start()}.bind(b))}});Ext.define("Voyant.panel.TermsBerry",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsberry",statics:{i18n:{},api:{stopList:"auto",context:2,numInitialTerms:75,query:void 0,docIndex:void 0,docId:void 0,categories:void 0},glyph:"xf1db@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:void 0,scalingFactor:3,minRawFreq:void 0,maxRawFreq:void 0,maxCollocateValue:void 0,minFillValue:void 0,maxFillValue:void 0,currentData:{},blacklist:{},
visLayout:void 0,vis:void 0,visInfo:void 0,visId:void 0,currentNode:void 0,tip:void 0,contextMenu:void 0},MODE_TOP:"top",MODE_DISTINCT:"distinct",MIN_TERMS:5,MAX_TERMS:500,COLLOCATES_LIMIT:1E6,MIN_SCALING:1,MAX_SCALING:5,MIN_STROKE_OPACITY:.1,MAX_STROKE_OPACITY:.3,layout:"fit",constructor:function(a){this.setMode(this.MODE_TOP);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,"termspack_"))},initComponent:function(){Ext.apply(this,
{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield",clearOnQuery:!0},{xtype:"button",text:this.localize("strategy"),menu:{items:[{xtype:"menucheckitem",group:"strategy",checked:this.getMode()===this.MODE_TOP,text:this.localize("topTerms"),checkHandler:function(a,b){b&&(this.setMode(this.MODE_TOP),this.doLoad())},scope:this},{xtype:"menucheckitem",group:"strategy",checked:this.getMode()===this.MODE_DISTINCT,text:this.localize("distinctTerms"),
checkHandler:function(a,b){b&&(this.setMode(this.MODE_DISTINCT),this.doLoad())},scope:this}]}},{fieldLabel:this.localize("numTerms"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("numInitialTerms")))},changecomplete:function(a,b){this.setApiParam("numInitialTerms",b);this.doLoad()},scope:this}},{fieldLabel:this.localize("context"),labelWidth:50,labelAlign:"right",
width:120,xtype:"slider",increment:1,minValue:1,maxValue:30,listeners:{afterrender:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParams({context:b});this.doLoad()},scope:this}},{fieldLabel:this.localize("scaling"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_SCALING,maxValue:this.MAX_SCALING,listeners:{afterrender:function(a){a.setValue(this.getScalingFactor())},changecomplete:function(a,b){this.setScalingFactor(Math.abs(b-
(this.MAX_SCALING+1)));this.reload()},scope:this}}]}]});this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==a&&(delete this.getCurrentData()[a.data.term],this.getBlacklist()[a.data.term]=!0,this.setCurrentNode(void 0));this.getContextMenu().hide();this.reload()},scope:this}]}));this.on("query",
function(a,b){0<b.length&&this.doLoad(b)},this);this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout()},resize:function(a,b,c){this.getVisLayout()&&this.getCorpus()&&(a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),a.down("svg").set({width:b,height:c}),this.getVisLayout().size([b,c]),this.reload())},loadedCorpus:function(a,b){this.isVisible()&&this.doLoad()},activate:function(){this.getCorpus()&&this.doLoad()}},doLoad:function(a){this.resetVis();void 0===
a&&(this.resetMinMax(),this.setCurrentData({}));this.getMode()===this.MODE_DISTINCT?this.getDistinctTerms(a):this.getTopTerms(a)},reload:function(){var a=this.processCollocates([]);0<a.length&&(this.resetVis(),this.buildVisFromData(a))},resetMinMax:function(){this.setMinRawFreq(void 0);this.setMaxRawFreq(void 0);this.setMaxCollocateValue(void 0);this.setMinFillValue(void 0);this.setMaxFillValue(void 0)},resetVis:function(){var a=this.getVis();a&&a.selectAll(".node").remove()},getTopTerms:function(a){var b=
parseInt(this.getApiParam("numInitialTerms")),c=this.getApiParam("stopList");void 0!==a&&(c=b=void 0);this.getCorpus().getCorpusTerms().load({params:{query:a,limit:b,stopList:c},callback:function(a,b,c){c&&this.loadFromRecords(a)},scope:this})},getDistinctTerms:function(a){var b=parseInt(this.getApiParam("numInitialTerms")),c=this.getApiParam("stopList");void 0!==a&&(c=b=void 0);var d=Math.ceil(parseInt(this.getApiParam("numInitialTerms"))/this.getCorpus().getDocumentsCount());this.getCorpus().getDocumentTerms().load({params:{query:a,
limit:b,perDocLimit:d,stopList:c,sort:"TFIDF",dir:"DESC"},callback:function(a,b,c){c&&this.loadFromRecords(a)},scope:this})},loadFromQuery:function(a){this.getCorpus().getCorpusTerms().load({params:{query:a},callback:function(a,c,d){d&&this.loadFromRecords(a)},scope:this})},loadFromRecords:function(a){if(Ext.isArray(a)&&0<a.length){var b=this.getMaxRawFreq(),c=this.getMinRawFreq(),d=this.getMinFillValue(),e=this.getMaxFillValue(),f=[];a.forEach(function(a){var g=a.getTerm();if(!this.getBlacklist()[g]){var h=
a.getRawFreq(),l=this.getMode()===this.MODE_DISTINCT?a.get("tfidf"):a.getInDocumentsCount();if(void 0===b||h>b)b=h;if(void 0===c||h<c)c=h;if(void 0===e||l>e)e=l;if(void 0===d||l<d)d=l;this.getCurrentData()[g]={term:g,rawFreq:h,relativeFreq:a.get("relativeFreq"),fillValue:l,collocates:[]};f.push(g)}},this);this.setMaxRawFreq(b);this.setMinRawFreq(c);this.setMinFillValue(d);this.setMaxFillValue(e);this.getCollocatesForQuery(f)}},getCollocatesForQuery:function(a){var b=[];for(c in this.getCurrentData())b.push(c);
this.setApiParams({mode:"corpus"});var c=this.getApiParams();this.getCorpus().getCorpusCollocates().load({params:Ext.apply(Ext.clone(c),{query:a,collocatesWhitelist:b,limit:this.COLLOCATES_LIMIT}),callback:function(a,b,c){c&&this.buildVisFromData(this.processCollocates(a))},scope:this})},processCollocates:function(a){for(var b=this.getCurrentData(),c=this.getMaxCollocateValue(),d=0;d<a.length;d++){var e=a[d],f=e.getTerm(),g=e.getContextTerm();e=e.getContextTermRawFreq();if(void 0===c||e>c)c=e;void 0!==
b[f]&&f!=g&&b[f].collocates.push({term:g,value:e})}this.setMaxCollocateValue(c);a=[];for(f in b)a.push(b[f]);return a},buildVisFromData:function(a){var b=this;if(this.getVis()){a.push({term:"$$$root$$$",collocates:[],rawFreq:1});var c=d3.stratify().id(function(a){return a.term}).parentId(function(a){return"$$$root$$$"!==a.term?"$$$root$$$":""})(a).sort(function(a,b){return a.rawFreq<b.rawFreq?1:a.rawFreq>b.rawFreq?-1:0}).sum(function(a){return Math.pow(a.rawFreq,1/b.getScalingFactor())});this.getVisLayout()(c);
c=this.getVis().selectAll(".node").data(c.descendants());c.attr("transform",function(a){return"translate("+a.x+","+a.y+")"});c.selectAll("circle").attr("r",function(a){return a.r});var d=d3.scalePow().exponent(1/3).domain([0,this.getMaxCollocateValue()]).range(["#fff","#bd3163"]);var e=this.getMode()===this.MODE_DISTINCT?d3.scalePow().exponent(.2).domain([this.getMinFillValue(),this.getMaxFillValue()]).range(["#dedede","#fff"]):d3.scaleLinear().domain([this.getMaxFillValue(),this.getMinFillValue()]).range(["#dedede",
"#fff"]);var f=this.getVisLayout().size();f=Math.min(f[0],f[1])/2;a=Math.sqrt(Math.PI*f*f/a.length/Math.PI)/3;f=Math.abs(this.getScalingFactor()-(this.MAX_SCALING+1));f=Math.max(1,f-1);f*=a;var g=d3.scaleLinear().domain([this.getMinRawFreq(),this.getMaxRawFreq()]).range([a,f]);a=c.enter().append("g").attr("class","node").style("visibility",function(a){return 0<a.depth?"visible":"hidden"}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).on("click",function(a){b.dispatchEvent("termsClicked",
b,[a.data.term])}).on("mouseover",function(a,c){b.setCurrentNode(a);b.getVis().selectAll("circle").style("stroke-width",1).style("stroke","#111").style("fill",function(a){return e(a.data.fillValue)});d3.select(this).select("circle").style("fill","#89e1c2").style("stroke","#26926c").style("stroke-opacity",b.MAX_STROKE_OPACITY);c=b.getMode()===b.MODE_DISTINCT?b.localize("tfidf"):b.localize("inDocs");if(!b.getContextMenu().isVisible()){c="\x3cb\x3e"+a.data.term+"\x3c/b\x3e ("+a.data.rawFreq+")\x3cbr/\x3e"+
c+": "+a.data.fillValue;var f=b.getTip();f.update(c);f.show()}for(c=0;c<a.data.collocates.length;c++){var g=a.data.collocates[c];f=b.getVis().selectAll(".node").filter(function(a){return a.data.term===g.term});f.select("circle").style("fill",function(a){return d(g.value)}).style("stroke","#bd3163").style("stroke-opacity",b.MAX_STROKE_OPACITY);f.select("tspan.value").text(function(a){return g.value})}}).on("mousemove",function(){b.getTip().setPosition(d3.event.pageX+5,d3.event.pageY-50)}).on("mouseout",
function(){b.getContextMenu().isVisible()||b.setCurrentNode(void 0);b.getVis().selectAll("circle").style("stroke-opacity",b.MIN_STROKE_OPACITY).style("stroke","#111").style("fill",function(a){return e(a.data.fillValue)});b.getVis().selectAll("tspan.value").text("");b.getTip().hide()}).on("contextmenu",function(a,c){d3.event.preventDefault();b.getTip().hide();c=b.getContextMenu();c.queryById("label").setHtml(a.data.term);c.showAt(d3.event.pageX+5,d3.event.pageY-50)});a.append("circle").attr("id",function(a){return a.data.term.replace(/\W/g,
"_")}).attr("r",function(a){return a.r}).style("fill",function(a){return e(a.data.fillValue)}).style("stroke","#111").style("stroke-opacity",b.MIN_STROKE_OPACITY).style("stroke-width",1);a.append("clipPath").attr("id",function(a){return"clip-"+a.data.term.replace(/\W/g,"_")}).append("use").attr("xlink:href",function(a){return"#"+a.data.term.replace(/\W/g,"_")});a=a.append("text").attr("clip-path",function(a){return"url(#clip-"+a.data.term.replace(/\W/g,"_")+")"}).style("font-family",function(a){return b.getApplication().getFeatureForTerm("font",
a.data.term)}).style("text-anchor","middle").style("cursor","default");a.append("tspan").attr("class","term").attr("font-size",function(a){return g(a.data.rawFreq)}).attr("x",0).attr("y",function(a){return g(a.data.rawFreq)/4}).text(function(a){return a.data.term});a.append("tspan").attr("class","value").attr("font-size",function(a){return.75*g(a.data.rawFreq)}).attr("x",0).attr("y",function(a){return g(a.data.rawFreq)+1});c.exit().remove()}},initVisLayout:function(){var a=this.getLayout().getRenderTarget();
a.update("");var b=a.getWidth(),c=a.getHeight();this.setVisLayout(d3.pack().size([b,c]).padding(1.5));a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("width",b).attr("height",c);this.setVis(a.append("g"));this.setVisInfo(a.append("text").attr("x",10).attr("y",10));void 0===this.getTip()&&this.setTip(Ext.create("Ext.tip.Tip",{}))}});Ext.define("Voyant.panel.TermsRadio",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsradio",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],speed:50,termsRadio:void 0},statics:{i18n:{},api:{withDistributions:!0,bins:5,visibleBins:5,docIdType:null,limit:50,mode:null,position:0,selectedWords:[],stopList:"auto",query:null,yAxisScale:"log",speed:50,slider:void 0},glyph:"xf201@FontAwesome"},constructor:function(a){var b=function(a,b,e,f,g){this.setApiParams({mode:a});
this.getTermsRadio().loadRecords(e);(a=this.getApiParam("query"))&&(0==e.length||1==e.length&&0==e[0].getRawFreq()?this.toastInfo({html:this.localize("termNotFound"),align:"bl"}):this.getTermsRadio().highlightQuery(a,!0))};this.corpusStore=Ext.create("Voyant.data.store.CorpusTerms",{listeners:{load:{fn:b.bind(this,"corpus"),scope:this}}});this.documentStore=Ext.create("Voyant.data.store.DocumentTerms",{listeners:{load:{fn:b.bind(this,"document"),scope:this}}});Ext.apply(a,{title:this.localize("title"),
legendMenu:Ext.create("Ext.menu.Menu",{items:[{text:"",itemId:"remove",glyph:"xf068@FontAwesome"}]}),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark"]}),listeners:{itemclick:function(a,b,e,f){a=b.get("name");this.getTermsRadio().isTermSelected(a)?this.getTermsRadio().doTermDeselect(a):this.getTermsRadio().doTermSelect(a)},itemcontextmenu:function(a,b,e,f,g){g.preventDefault();a=g.getXY();var c=b.get("name");b=(new Ext.Template(this.localize("removeTerm"))).apply([c]);
this.legendMenu.queryById("remove").setText(b);this.legendMenu.on("click",function(a,b){void 0!==b&&this.doTermDeselect(c,!0)},this,{single:!0});this.legendMenu.showAt(a)},scope:this}}}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{glyph:"xf04b@FontAwesome",itemId:"play",handler:function(a){"xf04c@FontAwesome"==a.glyph?(this.getTermsRadio().continueTransition=!1,this.mask(this.localize("completingTransition")),a.setPlaying(!1)):(this.getTermsRadio().toggleRightCheck(),a.setPlaying(!0))},
scope:this,setPlaying:function(a){this.setGlyph(a?"xf04c@FontAwesome":"xf04b@FontAwesome")}},{glyph:"xf0e2@FontAwesome",tooltip:this.localize("resetTip"),listeners:{click:{fn:function(){this.queryById("play").setPlaying(!1);this.getTermsRadio().shiftCount=0;this.getTermsRadio().prepareData();this.getTermsRadio().redraw()},scope:this}}},{xtype:"label",forId:"terms",text:this.localize("terms")},{xtype:"slider",itemId:"terms",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("limit")))},
changecomplete:function(a,b){this.setApiParams({limit:b});this.loadStore()},scope:this}},{xtype:"label",forId:"speed",text:this.localize("speed")},{xtype:"slider",itemId:"speed",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.setSpeed(a.getValue())},changecomplete:function(a,b){this.setApiParams({speed:b});this.setSpeed(b)},scope:this}},{xtype:"label",itemId:"visibleSegmentsLabel",forId:"visibleBins",
text:this.localize("visibleSegments")},{xtype:"slider",itemId:"visibleBins",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("visibleBins")))},changecomplete:function(a,b){this.setApiParams({visibleBins:b});this.numVisPoints=b;this.loadStore();this.numVisPoints==this.getCorpus().getDocumentsCount()?this.getTermsRadio().hideSlider():"false"!=this.getApiParam("slider")&&this.getTermsRadio().showSlider()},scope:this}},{xtype:"label",
itemId:"segmentsLabel",forId:"segments",text:this.localize("segments")},{xtype:"slider",itemId:"segments",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("bins")))},changecomplete:function(a,b){this.setApiParams({bins:b});this.numDataPoints=b;this.loadStore();this.queryById("visibleBins").setMaxValue(b)},scope:this}}]}});this.config.options.push({xtype:"combo",queryMode:"local",triggerAction:"all",forceSelection:!0,
editable:!1,fieldLabel:this.localize("yScale"),labelAlign:"right",name:"yAxisScale",valueField:"value",displayField:"name",store:new Ext.data.JsonStore({fields:["name","value"],data:[{name:this.localize("linear"),value:"linear"},{name:this.localize("log"),value:"log"}]}),listeners:{afterrender:function(a){a.setValue(this.getApiParam("yAxisScale"))},scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){a=this.getApiParam("slider");
this.setTermsRadio(new TermsRadio({parent:this,container:this.body,showSlider:void 0===a?!0:"true"===a}))},this);this.addListener("corpusTermsClicked",function(a,b){1<this.getCorpus().getDocumentsCount()&&b.forEach(function(a){a=a.getTerm();this.setApiParams({query:a});this.loadStore()})});this.addListener("documentTermsClicked",function(a,b){if(a&&a.xtype==this.xtype)return!1;b.forEach(function(a){a=a.getTerm();this.setApiParams({query:a});this.loadStore()})});this.on("query",function(a,b){this.fireEvent("termsClicked",
a,b)});this.on("termsClicked",function(a,b){b.forEach(function(a){var b;Ext.isString(a)?b=a:a.term?b=a.term:a.getTerm&&(b=a.getTerm());this.setApiParams({query:b});this.loadStore()},this)});this.on("loadedCorpus",function(a,b){this.documentStore.setCorpus(b);this.corpusStore.setCorpus(b);a=this.getApiParams();a.type&&delete a.limit;var c=this.getCorpus().getDocumentsCount(),d=this.queryById("segments"),g=this.queryById("visibleBins");"document"==a.mode||1==c?(this.setApiParam("mode","document"),b=
this.documentStore,g.setMaxValue(d.getValue())):(this.setApiParam("mode","corpus"),delete a.bins,b=this.corpusStore,d.hide(),this.queryById("segmentsLabel").hide(),g=this.queryById("visibleBins"),g.setMaxValue(c),parseInt(this.getApiParam("visibleBins")>c)&&g.setValue(c));b.on("load",function(a,b){for(a=0;3>a;a++){var c=b[a];c&&this.getTermsRadio().highlightRecord(c,!0)}},this,{single:!0});b.load({params:a})},this)},loadStore:function(){this.queryById("play").setPlaying(!1);var a=this.getApiParams();
"document"===this.getApiParam("mode")&&this.documentStore.load({params:a});"corpus"===this.getApiParam("mode")&&(delete a.bins,this.corpusStore.load({params:a}))}});Ext.define("Voyant.panel.Trends",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Documents"],alias:"widget.trends",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{name:"bins",xtype:"slider",labelAlign:"right",width:200,minValue:2,maxValue:100,listeners:{afterrender:function(a){var b=a.up("window").panel;a.setFieldLabel(b.localize("segmentsSlider"))}}},{xtype:"radiogroup",labelAlign:"right",columns:3,vertical:!0,name:"withDistributions",items:[{boxLabel:"raw",
name:"withDistributions",inputValue:"raw"},{boxLabel:"relative",name:"withDistributions",inputValue:"relative",style:"margin-left: 1em;"}],listeners:{afterrender:function(a){var b=this.up("window").panel;this.setFieldLabel("frequencies");var c=b.getApiParam("withDistributions");a.getBoxes().forEach(function(a){a.setBoxLabel(b.localize(a.inputValue));a.checked=a.inputValue==c});this.setValue({withDistributions:c})}}},{xtype:"colorpaletteoption"}]},statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,
withDistributions:"relative",bins:10,docIndex:void 0,docId:void 0,mode:"corpus",chartType:"barline",labels:!1},glyph:"xf201@FontAwesome"},layout:"fit",documentTermsStore:void 0,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"},{itemId:"reset",text:this.localize("reset"),tooltip:this.localize("resetTip"),handler:function(a){this.setApiParams({docIndex:void 0,mode:void 0,query:void 0});this.loadCorpusTerms()},scope:this},{text:this.localize("display"),tooltip:this.localize("displayTip"),glyph:"xf013@FontAwesome",menu:{listeners:{afterrender:function(a){var b=this.getApiParam("chartType");a.items.each(function(a){a.getItemId()==b&&a.addCls(a.activeCls)})},scope:this},defaults:{xtype:"menuitem",
handler:function(a,b){"menucheckitem"==a.xtype?this.setApiParam("labels",a.checked):this.setApiParam("chartType",a.getItemId());this.loadCorpusTerms()},scope:this},items:[{xtype:"menucheckitem",text:this.localize("labels"),tooltip:this.localize("labelsTip"),checked:!0===this.getApiParam("labels")||"true"==this.getApiParam("labels")},"-",{itemId:"area",text:this.localize("area"),tooltip:this.localize("areaTip"),glyph:"xe76b@Sencha-Examples"},{itemId:"bar",text:this.localize("bar"),tooltip:this.localize("barTip"),
glyph:"xe768@Sencha-Examples"},{itemId:"line",text:this.localize("line"),tooltip:this.localize("lineTip"),glyph:"xe773@Sencha-Examples"},{itemId:"stacked",text:this.localize("stacked"),tooltip:this.localize("stackedTip"),glyph:"xe6c8@Sencha-Examples"},{itemId:"barline",text:this.localize("barline"),tooltip:this.localize("barlineTip"),glyph:"xe779@Sencha-Examples"}]}}]}]});this.callParent(arguments)},listeners:{loadedCorpus:function(a,b){this.loadCorpusTerms()},termsClicked:function(a,b){var c=[];
b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});this.setApiParam("query",c&&0<c.length?c:void 0);this.loadCorpusTerms()},corpusTermsClicked:function(a,b){this.setApiParam("query",b.map(function(a){return a.getTerm()}));this.loadCorpusTerms()},documentSelected:function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocumentTerms()},documentsClicked:function(a,b){1==b.length&&this.fireEvent("documentSelected",
this,b[0])},query:function(a,b){this.fireEvent("termsClicked",this,b)}},loadCorpusTerms:function(a){if(2>this.getCorpus().getDocumentsCount()||"document"==this.getApiParam("mode")||0<Array.from(this.getApiParam("docIndex")||"").length)return this.loadDocumentTerms();if(this.getApiParam("query")){a=a||{};var b=this.getApiParam("withDistributions");Ext.applyIf(a,{bins:this.getCorpus().getDocumentsCount(),limit:100,stopList:""});var c=this.getCorpus().map(function(a){return a.getTinyTitle()});Ext.Array.unique(c).length<
c.length&&(c=c.map(function(a,b){return b+1+")"+a}));Ext.applyIf(a,this.getApiParams());this.getCorpus().getCorpusTerms().load({params:a,callback:function(a,e,f){var d=[],k=[],h=this.getApiParam("chartType");a.forEach(function(a,e){var f=a.get("term");a.get("docIndex");var g=this.getApplication().getColorForTerm(f,!0);a.get("distributions").forEach(function(a,g){d[g]||(d[g]={index:c[g]});d[g]["_"+e]="relative"==b?a.toFixed(7):a;d[g]["term"+e]=f},this);"bar"!=h&&("barline"==h?["bar","line"]:[h]).forEach(function(a){k.push({type:"stacked"==
a?"bar":a,title:f,xField:"index",yField:"_"+e,term:f,colors:[g],label:"barline"==h&&"bar"==a?{display:"none"}:{field:"term"+e}})},this)},this);e=a.map(function(a){return a.getTerm()});f=e.map(function(a){return this.getApplication().getColorForTerm(a,!0)},this);"bar"==h&&k.push({type:"bar",title:e,colors:f,xField:"index",yField:0<d.length?Object.keys(d[0]).filter(function(a){return"_"==a.charAt(0)}):void 0,label:{field:a.map(function(a,b){return"term"+b})}});a=Ext.create("Ext.data.JsonStore",{fields:0<
d.length?Object.keys(d[0]):void 0,data:d});this.buildChart({store:a,series:k,axes:[{type:"numeric",position:"left",increment:1,title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("corpusTitle")}}]})},scope:this})}else this.getCorpus().getCorpusTerms().load({params:{limit:5,stopList:this.getApiParam("stopList")},callback:function(a,b,c){0==a.length?b&&b.error?this.showError(this.localize("noResults")+"\x3cp style\x3d'color: red'\x3e"+
b.error+"\x3c/p\x3e"):this.showError(this.localize("noResults")):(this.setApiParam("query",a.map(function(a){return a.getTerm()})),this.loadCorpusTerms())},scope:this})},getItemToolTip:function(a,b,c){var d=c.field.split("_"),e=2==d.length?c.index:d[2];d=parseInt(d[1]);var f=c.series.getTitle();f=Ext.isArray(f)?f[d]:f;var g=c.series.getColors();b="\x3cspan class\x3d'x-legend-item-marker' style\x3d'background:"+(1==g.length?g[0]:g[d])+"; left: 2px;'\x3e\x3c/span\x3e \x3cspan style\x3d'padding-left: 1.2em; font-weight: bold;'\x3e"+
f+"\x3c/span\x3e: "+b.get(c.field)+"\x3cbr/\x3e\x3ci\x3e"+this.getCorpus().getDocument(e).getShortTitle()+"\x3c/i\x3e";b="corpus"==this.getApiParam("mode")?b+("\x3cdiv style\x3d'font-size: smaller'\x3e"+this.localize("dblClickItem")):b+("\x3cbr/\x3e"+this.localize("segment")+" "+(c.index+1));a.setHtml(b)},loadDocumentTerms:function(a){if(this.getApiParam("query")){this.setApiParam("mode","document");a=a||{};var b=this.getApiParam("withDistributions");Ext.applyIf(a,{limit:0,sort:"termasc",stopList:void 0});
this.getCorpus().map(function(a){return a.getTinyTitle()});var c=1==this.getCorpus().getDocumentsCount()?this.getCorpus().getDocument(0):this.getCorpus().getDocument(this.getApiParam("docIndex"));Ext.applyIf(a,this.getApiParams());this.getCorpus().getDocumentTerms().load({params:a,callback:function(a,e,f){var d=[],k=[],h=this.getApiParam("chartType");c||a.sort(function(a,b){return a.getTerm()==b.getTerm()?a.getDocIndex()-b.getDocIndex():a.getTerm().localeCompare(b.getTerm())});a.forEach(function(a,
e){var f=a.get("term"),g=a.get("docIndex"),l=c?this.getApplication().getColorForTerm(f,!0):this.getApplication().getColor(g,!0);g=a.get("docIndex");a.get("distributions").forEach(function(a,c){d[c]||(d[c]={docIndex:g,index:c+1});d[c]["_"+e+"_"+g]="relative"==b?a.toFixed(7):a;d[c]["term"+e]=f},this);"bar"!=h&&("barline"==h?["bar","line"]:[h]).forEach(function(a){k.push({type:"stacked"==a?"bar":a,title:c?f:g+1+") "+f,xField:"index",yField:"_"+e+"_"+g,term:f,colors:[l],label:"barline"==h&&"bar"==a?{display:"none"}:
{field:"term"+e}})},this)},this);if("bar"==h){var l=Ext.Array.unique(a.map(function(a){return a.getTerm()})).length;e=a.map(function(a){return 1+a.get("docIndex")+") "+a.getTerm()});a=a.map(function(a){return l?this.getApplication().getColor(a.get("docIndex"),!0):this.getApplication().getColorForTerm(a.getTerm(),!0)},this);k.push({type:"bar",title:0<e.length?e:this.localize("noResults"),colors:a,xField:"index",yField:0<d.length?Object.keys(d[0]).filter(function(a){return"_"==a.charAt(0)}):void 0,
label:{field:e}})}a=Ext.create("Ext.data.JsonStore",{fields:0<d.length?Object.keys(d[0]):void 0,data:d});this.buildChart({store:a,series:k,axes:[{type:"numeric",position:"left",title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("segmentsTitle")+(c?" ("+c.getShortTitle()+")":"")}}]})},scope:this})}else this.getCorpus().getCorpusTerms().load({params:{limit:2>this.getCorpus().getDocumentsCount()?5:2,stopList:this.getApiParam("stopList")},
callback:function(a,b,c){this.setApiParam("query",a.map(function(a){return a.getTerm()}));this.loadDocumentTerms()},scope:this})},buildChart:function(a){var b=this.getApiParam("chartType"),c=!1;if(!0===this.getApiParam("labels")||"true"==this.getApiParam("labels"))c=!0;Ext.applyIf(a,{cls:this.getApiParam("mode")});a.series.forEach(function(a){Ext.applyIf(a,{stacked:"bar"==a.type?!1:!0,showInLegend:"barline"==b&&"line"==a.type?!1:!0,smooth:!0,showMarkers:"bar"==a.type?!1:!0,marker:"barline"==b&&"line"==
a.type?null:{type:"circle",radius:2},style:{lineWidth:1,fillOpacity:"barline"==b&&"bar"==a.type?.01:1,strokeOpacity:"barline"==b&&"bar"==a.type?.1:1},highlight:!0,highlightCfg:{scaling:"bar"==a.type?1.1:2},label:{},tooltip:{trackMouse:!0,renderer:this.getItemToolTip,scope:this},listeners:{itemclick:function(a,b,c,d){this.clickTimer&&clearTimeout(this.clickTimer);if(!this.blockClick)if(this.blockClick=!0,Ext.defer(function(){this.blockClick=!1},1E3,this),"document"==this.getApiParam("mode"))a=b.field.split("_"),
c=a[2],c=this.getCorpus().getDocument(c).get("tokensCount-lexical"),c=parseInt(b.index*c/parseInt(this.getApiParam("bins"))),this.dispatchEvent("documentIndexTermsClicked",this,[{term:b.series.term,docIndex:a[2],position:c}]);else{this.clickTimer&&clearTimeout(this.clickTimer);var e=this;this.clickTimer=setTimeout(function(){e.dispatchEvent("documentIndexTermsClicked",e,[{term:b.series.term,docIndex:b.index}])},300)}},itemdblclick:function(a,b,c,d){this.clickTimer&&clearTimeout(this.clickTimer);this.blockClick=
!0;Ext.defer(function(){this.blockClick=!1},1E3,this);"document"!=this.getApiParam("mode")&&Ext.create("Ext.menu.Menu",{items:[{text:this.localize("drillTerm"),tooltip:this.localize("drillTermTip"),handler:function(){this.setApiParams({mode:"document",query:b.series.term});this.loadDocumentTerms()},scope:this},{text:this.localize("drillDocument"),tooltip:this.localize("drillDocumentTip"),handler:function(){this.setApiParams({mode:"document",docIndex:b.index});this.loadDocumentTerms()},scope:this}],
listeners:{hide:function(a){Ext.defer(function(){this.destroy()},200,a)},scope:this}}).showAt(c.pageX,c.pageY)},scope:this}});Ext.applyIf(a.label,{display:"over",field:"index",fontSize:11,translateY:"line"==b?9:void 0});c||(a.label.display="none")},this);Ext.applyIf(a,{animation:!0,plugins:{ptype:"chartitemevents",moveEvents:!0},legend:{docked:"top",listeners:{itemclick:function(a,b,c,d){if(a.getStore().getCount()<a.chart.series.length&&"barline"==this.getApiParam("chartType")){var e=b.get("name"),
f=b.get("disabled");a.chart.series.forEach(function(a){a.getTitle()==e&&a.setHidden(f)});a.chart.redraw()}},scope:this}},interactions:["itemhighlight","crosszoom"],listeners:{}});Ext.applyIf(a.listeners,{itemhighlightchange:function(a,b){a.el.dom.style.cursor=b?"pointer":""},afterrender:function(){},scope:this});a.axes.forEach(function(b){Ext.applyIf(b,{title:{},label:{}});Ext.applyIf(b.title,{scaling:.75});Ext.applyIf(b.label,{scaling:.75});if("category"==b.type){var c="";a.store.each(function(a){c+=
a.get("index")});c.length>this.getTargetEl().getWidth()/9&&Ext.applyIf(b.label,{rotate:{degrees:-30}});Ext.applyIf(b,{labelInSpan:!0})}},this);this.query("chart").forEach(function(a){this.remove(a,!0)},this);var d=Ext.create("Ext.chart.CartesianChart",a);this.add(d)},reloadFromChart:function(){var a=this.down("chart");if(a){var b=[];a.series.forEach(function(a){b.push(a.getTitle())});this.fireEvent("termsClicked",this,b)}}});Ext.define("Voyant.panel.NoTool",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.notool",statics:{i18n:{},api:{tool:void 0}},config:{html:void 0,notYetImplemented:"Centroid DocumentInputAdd DocumentTypeCollocateFrequenciesGrid EntitiesBrowser Equalizer FeatureClusters Flowerbed KwicsTagger Lava Mandala MicroSearch NetVizApplet PaperDrill RezoViz Sunburst Termometer Ticker TokensViz ToolBrowser ToolBrowserLarge VoyeurTagline WordCloud VoyeurTagline WordCountFountain".split(" ")},
constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{boxready:function(a,b,c){var d=this.getApiParam("notool");if(d){Ext.isArray(d)&&(d=d[0]);a=this.getNotYetImplemented();b=0;for(c=a.length;b<c;b++)if(d==a[b])return Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("notImplemented"))).applyTemplate([d]),buttons:Ext.Msg.YESNO,buttonText:{yes:this.localize("currentButton"),
no:this.localize("oldButton")},icon:Ext.Msg.ERROR,scope:this,fn:function(a){if("yes"==a)a=this.getNewUrl();else{a="http://voyant-tools.org/tool/"+d+"/";var b=Ext.Object.fromQueryString(document.location.search);delete b.tool;(queryString=Ext.Object.toQueryString(b))&&(a+="?"+queryString)}window.location.replace(a)}});Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("badToolSpecified"))).applyTemplate([d]),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(a){window.location.replace(this.getNewUrl())}})}else this.config.html||
Ext.Msg.show({title:this.localize("error"),message:this.localize("noToolSpecified"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(a){window.location.replace(this.getNewUrl())}})}},getNewUrl:function(){var a=Ext.Object.fromQueryString(document.location.search);delete a.tool;queryString=Ext.Object.toQueryString(a);return this.getApplication().getBaseUrl()+(queryString?"?"+queryString:"")}});Ext.define("Voyant.panel.VoyantFooter",{extend:"Ext.container.Container",mixins:["Voyant.panel.Panel"],alias:"widget.voyantfooter",statics:{i18n:{}},height:18,cls:"x-tab-bar-default voyant-footer",listeners:{boxready:function(a,b,c){c=["\x3ca href\x3d'"+a.getBaseUrl()+"docs/' target\x3d'voyantdocs'\x3e"+a.localize("voyantTools")+"\x3c/a\x3e ",", \x3ca href\x3d'http://stefansinclair.name/'\x3eSt\x26eacute;fan Sinclair\x3c/a\x3e \x26amp; \x3ca href\x3d'http://geoffreyrockwell.com'\x3eGeoffrey Rockwell\x3c/a\x3e",
" (\x3ca href\x3d'http://creativecommons.org/licenses/by/4.0/' target\x3d'_blank'\x3e\x3cspan class\x3d'cc'\x3ec\x3c/span\x3e\x3c/a\x3e "+(new Date).getFullYear()+")"," \x3ca class\x3d'privacy' href\x3d'"+this.getBaseUrl()+"docs/#!/guide/about-section-privacy-statement' target\x3d'top'\x3e"+a.localize("privacy")+"\x3c/a\x3e"," v. "+Voyant.application.getVersion()+(Voyant.application.getBuild()?" ("+Voyant.application.getBuild()+")":"")];for(var d="",e=0,f,g=a.getEl(),k=0;k<c.length;k++)f=g.getTextWidth(c[k].replace(/data-qtip.+?--\x3e/,
"\x3e").replace(/<.+?>/g,"")),e+f<b&&(d+=c[k],e+=f);a.update(d);Ext.tip.QuickTipManager.register({target:a.getTargetEl().dom.querySelector(".privacy"),text:this.localize("privacyMsg")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getTargetEl().dom.querySelector(".privacy"))}}});Ext.define("Voyant.panel.VoyantHeader",{extend:"Ext.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.voyantheader",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{id:"voyantheader",title:"",layout:"fit",html:'\x3cdiv id\x3d"logo-container"\x3e\x3c/div\x3e',collapseMode:void 0,collapsible:!0,animCollapse:!1,titleCollapse:!1,floatable:!1,header:!0,hideCollapseTool:!0,listeners:{collapse:this.onCollapse},titleAlign:"center"});this.callParent(arguments);Ext.applyIf(a,{moreTools:["corpusset",
"scatterplot","termsradio"],includeTools:{save:!0,plus:!0,help:!0,language:this.getLanguageToolMenu(),home:{type:"home",tooltip:this.localize("homeTip"),xtype:"toolmenu",glyph:"xf015@FontAwesome",handler:function(a){var b=this.up("panel");Ext.Msg.confirm(b.localize("home"),b.localize("homeConfirm"),function(a){"yes"==a&&(document.location.href=b.getBaseUrl())},this)}}}});this.mixins["Voyant.panel.Panel"].constructor.call(this,a)},onCollapse:function(a){Ext.defer(function(){this.setTitle("\x3cimg src\x3d'"+
this.getBaseUrl()+"resources/images/voyant-logo-tiny.png' style\x3d'vertical-align: middle' alt\x3d'Voyant Tools' /\x3e "+this.localize("title"))},10,a)}});Ext.define("Voyant.panel.CorpusSet",{extend:"Ext.panel.Panel",requires:"Voyant.panel.VoyantTabPanel Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.Phrases Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.StreamGraph Voyant.panel.TermsBerry".split(" "),mixins:["Voyant.panel.Panel"],alias:"widget.corpusset",isConsumptive:!0,statics:{i18n:{},
api:{panels:void 0},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"border",header:!1,items:[{region:"west",flex:3,layout:"fit",moreTools:["cirrus","corpusterms"],xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,items:[{xtype:"cirrus"},{xtype:"corpusterms"},{xtype:"collocatesgraph"}]},{region:"center",flex:3,layout:"fit",xtype:"voyanttabpanel",tabBarHeaderPosition:0,items:[{xtype:"reader"},
{xtype:"termsberry"}]},{region:"east",flex:3,layout:"fit",xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["trends","collocatesgraph","corpuscollocates"],items:[{xtype:"trends"},{xtype:"documentterms"}]},{region:"south",flex:2,split:{width:5},layout:"border",items:[{layout:"fit",region:"center",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["summary","documents","phrases"],items:[{xtype:"summary"},{xtype:"documents"},{xtype:"phrases"}]},{layout:"fit",
region:"east",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["contexts","documentterms"],items:[{xtype:"contexts"},{xtype:"bubblelines"},{xtype:"correlations"}]}]}],listeners:{boxready:function(){var a=this.getApiParam("panels");if(a){a=a.toLowerCase().split(",");for(var b=this.query("voyanttabpanel"),c=0,d=a.length;c<d;c++){var e=a[c];if(e&&Ext.ClassManager.getByAlias("widget."+e)&&b[c]){var f=b[c];f.getActiveTab().isXType(e)||(f.items.each(function(a,b){if(a.isXType(e))return this.setActiveTab(b),
!1},f),f.getActiveTab().isXType(e)||f.getActiveTab().replacePanel(e))}}}a=this.down("cirrus");var g=this;a&&(a=a.down("toolbar"),a.add({xtype:"tbfill"}),a.add({text:" ",listeners:{click:{fn:function(){g.add({region:"north",width:"100%",html:'\x3cdiv align\x3d"center"\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cimg src\x3d"http://stefansinclair.name/wordpress/wp-content/uploads/2011/07/Sinclair_Stefan_small.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3ctd style\x3d"text-align: center; padding-left: 2em; padding-right: 2em;"\x3eBy Athena, you found us hidden\x3cbr\x3eup here between the panels!\x3c/td\x3e\x3ctd\x3e\x3cimg src\x3d"http://geoffreyrockwell.com/images/home_09.jpg" style\x3d"height: 60px"\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e'})},
single:!0},render:function(a){a.getTargetEl().dom.className=""}}}))},loadedCorpus:function(a,b){if(0==this.hasCorpusAccess(b)&&!this.getApiParam("panels")){var c=this.query("voyanttabpanel");c[1].setActiveTab(1);c[1].getActiveTab().fireEvent("loadedCorpus",a,b);c[4].setActiveTab(1)}30<b.getDocumentsCount()&&(a=this.down("bubblelines"))&&a.up("voyanttabpanel").remove(a)},panelChange:function(a){var b=[];this.query("voyanttabpanel").forEach(function(a){b.push(a.getActiveTab().xtype)});this.getApplication().setApiParam("panels",
b.join(","))}}});Ext.define("Voyant.panel.ScatterSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.scatterset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"hbox",header:!1,items:[{flex:3,height:"100%",xtype:"scatterplot"},{split:{width:5},flex:1,height:"100%",
layout:"vbox",defaults:{width:"100%",flex:1},items:[{xtype:"documents",collapsible:!0},{xtype:"trends",collapsible:!0},{xtype:"contexts",collapsible:!0}]}]});Ext.define("Voyant.panel.Subset",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.subset",isConsumptive:!0,statics:{i18n:{},api:{stopList:"auto",documentFilename:["pubDate","title"],documentFormat:"SOURCE"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],inDocumentsCountOnly:!1,stopList:"auto",store:void 0},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(a){var b=this;Ext.applyIf(b,{introHtml:"",fieldItems:[{xtype:"querysearchfield",fieldLabel:this.localize("titleLabel"),tokenType:"title"},{xtype:"querysearchfield",fieldLabel:this.localize("authorLabel"),tokenType:"author"},{xtype:"querysearchfield",fieldLabel:this.localize("lexicalLabel")}],fieldColumns:2});Ext.applyIf(b,{intro:{margin:"5 0 5 0",layout:"center",items:{itemId:"intro",html:b.introHtml}},fields:{xtype:"container",layout:"center",items:{xtype:"container",
maxWidth:1200,layout:{type:"table",columns:b.fieldColumns},items:b.fieldItems.map(function(a){return{xtype:"container",defaults:{margin:"5 10 5 10",inDocumentsCountOnly:b.getInDocumentsCountOnly(),stopList:b.getStopList(),showAggregateInDocumentsCount:!0,isDocsMode:!0,flex:1,maxWidth:800,labelAlign:"right"},items:Ext.applyIf(a,{fieldLabel:b.localize((a.tokenType?a.tokenType:"lexical")+"Label")})}},this)}},foot:{layout:"center",margin:"20 0 0 0",items:{xtype:"container",layout:{type:"hbox",align:"middle"},
defaults:{margin:"0 5 0 5",width:200},items:[{xtype:"button",itemId:"export",glyph:"xf08e@FontAwesome",text:this.localize("sendToVoyantButton"),handler:b.handleSendToVoyant,scope:b},{xtype:"button",glyph:"xf019@FontAwesome",itemId:"download",text:this.localize("downloadButton"),handler:b.handleExport,scope:b},{xtype:"container",hidden:!0,itemId:"statuscontainer",layout:"vbox",items:[{itemId:"status",bodyStyle:"text-align: center",width:200},{xtype:"container",width:200,items:{xtype:"sparklineline",
chartRangeMin:0,itemId:"sparkline",margin:"0 0 0 10",values:[1,1],height:20,width:200}}]}]}}});Ext.applyIf(b,{items:[b.intro,b.fields,b.foot]});b.on("loadedCorpus",function(a,d){b.getStore().setCorpus(d);void 0==b.getInitialConfig("introHtml")&&void 0==b.getInitialConfig("intro")&&b.queryById("intro").setHtml(d.getString())},b);b.on("query",function(a,b){this.performAggregateQuery(this.getAggregateQuery())});b.setStore(Ext.create("Voyant.data.store.DocumentQueryMatches"));b.callParent([a])},handleSendToVoyant:function(){if(this.getStore().lastOptions&&
this.getStore().lastOptions.params.query){var a=this;this.mask("Creating corpus\u2026");this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0},callback:function(b,c,d){a.unmask();d&&b&&1==b.length&&(b=c.getProxy().getReader().metaData,b=a.getBaseUrl()+"?corpus\x3d"+b,a.openUrl(b))}})}else Ext.Msg.alert(this.localize("sendToVoyantButton"),(new Ext.XTemplate(this.localize("sendToVoyantNoQuery"))).apply([this.getBaseUrl()+"?corpus\x3d"+this.getStore().getCorpus().getId()]))},
handleExport:function(){if(this.getStore().lastOptions&&this.getStore().lastOptions.params.query){var a=this.getStore().getAt(0);this.getStore().lastOptions.params.query&&a&&0==a.getCount()?this.showMsg({message:this.localize("noMatches")}):this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0,temporaryCorpus:!0},callback:function(a,c,d){d&&a&&1==a.length&&this.downloadFromCorpusId(c.getProxy().getReader().metaData)},scope:this})}else this.downloadFromCorpusId(this.getStore().getCorpus().getId())},
openDownloadCorpus:function(a){a=this.getTromboneUrl()+"?corpus\x3d"+a+"\x26tool\x3dcorpus.CorpusExporter\x26outputFormat\x3dzip\x26zipFilename\x3dDownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?"\x26documentFormat\x3d"+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"\x26documentFilename\x3d"+this.getApiParam("documentFilename"):"");this.openUrl(a)},performAggregateQuery:function(a){var b=this,c=b.queryById("statuscontainer"),d=b.queryById("status"),
e=b.queryById("sparkline");c&&c.show();d&&d.setHtml((new Ext.XTemplate('{0:plural("documents")} matching.')).apply([0]));e&&e.setValues([0,0]);a?(c=this.getStore().getCorpus().getDocumentsCount(),this.getStore().load({params:{query:a,withDistributions:!0,bins:100<c?100:c},callback:function(a,c,e){b.queryById("export");c=b.queryById("sparkline");e&&a&&1==a.length&&(d&&d.setHtml((new Ext.XTemplate('{0:plural("document")} matching.')).apply([a[0].getCount()])),c&&c.setValues(a[0].getDistributions()))}})):
this.getStore().lastOptions&&(this.getStore().lastOptions.params.query=void 0)},getAggregateQuery:function(){var a=[];Ext.ComponentQuery.query("field",this).forEach(function(b){if(b.getTokenType&&b.getValue){var c=b.getTokenType();b=Ext.Array.from(b.getValue());0<b.length&&0<b.length&&a.push("+("+b.map(function(a){return c+":"+a}).join("|")+")")}});return a.join(" ")}});Ext.define("Voyant.panel.CollocatesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.collocatesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{layout:"hbox",align:"stretch",width:"100%",height:"100%",flex:2,defaults:{width:"100%",
height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"corpusterms"},{xtype:"documentterms"},{xtype:"corpuscollocates"}]},{width:"100%",height:"100%",split:{width:5},layout:"hbox",flex:3,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"collocatesgraph"}]}]});Ext.define("Voyant.panel.BubblelinesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.Bubblelines","Voyant.panel.Contexts","Voyant.panel.Reader"],mixins:["Voyant.panel.Panel"],alias:"widget.bubblelinesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{width:"100%",height:"100%",xtype:"bubblelines",flex:5},{width:"100%",height:"100%",split:{width:5},
layout:"hbox",flex:4,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"reader"}]}]});Ext.define("Voyant.panel.CustomSet",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.customset",statics:{i18n:{},api:{layout:void 0,tableLayout:void 0},glyph:"xf17a@FontAwesome"},header:!1,height:"100%",width:"100%",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.getApiParam("layout")?Ext.apply(this,{layout:"border",
items:[]}):this.getApiParam("tableLayout")&&this.initTableLayout();this.callParent()},listeners:{loadedCorpus:function(a,b){this.getApiParam("layout")&&this.query("panel").forEach(function(c){c.fireEvent("loadedCorpus",a,b)})},boxready:function(a){this.getApiParam("layout")?this.initBorderLayoutComponents():this.getApiParam("tableLayout")?(this.doTableSizing(),this.on("resize",function(a,c,d,e,f){void 0!==e&&void 0!==f&&this.doTableSizing(c/e,d/f)},this)):this.showError(this.localize("noLayoutSpecified"))}},
initBorderLayoutComponents:function(){var a=decodeURI(this.getApiParam("layout")).replace(/r1/g,"region").replace(/i1/g,"items").replace(/s1/g,"split").replace(/c1/g,"collapsible").replace(/c2/g,"collapsed").replace(/w1/g,"width").replace(/h1/g,"height").replace(/p1/g,"%").replace(/"x1":"/g,'"xtype":"').replace(/c3/g,"center").replace(/n1/g,"north").replace(/e1/g,"east").replace(/s2/g,"south").replace(/w2/g,"west").replace(/"xtype":"(\w+)"/g,function(a,b){Ext.ClassManager.getByAlias("widget."+b.toLowerCase())||
(b="Links"==b?"CollocatesGraph":"CorpusGrid"==b?"Documents":"CorpusSummary"==b?"Summary":"CorpusTypeFrequenciesGrid"==b?"CorpusTerms":"DocumentInputAdd"==b?"CorpusTerms":"DocumentTypeCollocateFrequenciesGrid"==b?"CorpusTerms":"DocumentTypeFrequenciesGrid"==b?"DocumentTerms":"DocumentTypeKwicsGrid"==b?"Contexts":"TypeFrequenciesChart"==b?"Trends":"VisualCollocator"==b?"CollocatesGraph":"NoTool");return'"xtype":"'+b.toLowerCase()+'"'+("NoTool"==b?',"html":"'+(new Ext.Template(panel.localize("noSuchTool"))).applyTemplate([b])+
'"':"")});try{var b=Ext.decode(a)}catch(c){b={region:"center",html:"\x3cdiv\x3eError constructing layout:"+c+"\x3c/div\x3e"}}null==b&&(b={region:"center",html:"\x3cdiv\x3eError: no layout information found.\x3c/div\x3e"});this.addBorderLayouts(b);this.on("add",function(a,b){b.on("boxready",function(a){})});this.add(b)},addBorderLayouts:function(a){for(var b=Ext.getBody().getSize(),c=0;c<a.length;c++){var d=a[c];Ext.isString(d.width)?d.width=Math.round(b.width*parseInt(d.width)/100):Ext.isString(d.height)&&
(d.height=Math.round(b.height*parseInt(d.height)/100));d.items&&1<d.items.length?(d.layout="border",this.addBorderLayouts(d.items)):d.layout="fit"}},initTableLayout:function(){Ext.suspendLayouts();var a=decodeURI(this.getApiParam("tableLayout"));if(a&&"{"!=a.charAt(0)&&"["!=a.charAt(0)){var b=[];a.replace(/;/g,",").split(/,\s*/).forEach(function(a){b.push(/^"'/.test(a)?a:'"'+a+'"')});a="["+b.join(",")+"]"}a=Ext.decode(a);Ext.isArray(a)&&(a={cells:a});!a.numCols&&a.cells&&Ext.isArray(a.cells)&&(a.numCols=
3>a.cells.length?a.cells.length:5>a.cells.length?Math.ceil(a.cells.length/2):Math.ceil(a.cells.length/3));if(null!=a.numCols&&a.cells&&Ext.isArray(a.cells)){for(var c=[],d=0;d<a.cells.length;d++){var e=a.cells[d];if(Ext.isObject(e))e.cellWidth=parseFloat(e.width)||void 0,e.cellHeight=parseFloat(e.height)||void 0,delete e.width,delete e.height,c.push(e);else if(Ext.isArray(e)){var f=1,g=1;xtype=void 0;e[0]&&Ext.isNumber(e[0])&&(f=e[0],e.shift());e[0]&&Ext.isString(e[0])&&(xtype=e[0],e.shift());e[0]&&
Ext.isNumber(e[0])&&(g=e[0]);xtype&&c.push({colspan:f,rowspan:g,xtype:xtype})}else Ext.isString(e)&&c.push({xtype:e,colspan:1,rowspan:1})}Ext.apply(this,{layout:{type:"table",width:"100%",height:"100%",columns:a.numCols,tableAttrs:{style:{width:"100%",height:"100%"}},tdAttrs:{style:{padding:"0px",verticalAlign:"top"}}},defaults:{width:10,height:10,border:!0},items:c})}else this.showError("badTableLayoutDefinition");Ext.resumeLayouts()},doTableSizing:function(a,b){var c={},d=this.getTargetEl().down(".x-table-layout"),
e=d.getSize(!1);d=d.dom.rows;for(var f=0;f<d.length;f++)for(var g=d[f].cells,k=0;k<g.length;k++){var h=Ext.get(g[k]),l=h.down(".x-panel"),m=l.id;if(void 0!==a&&void 0!==b)h=l.getSize(!1),h.width*=a,h.height*=b;else{l=h.getSize(!1);var n=Ext.getCmp(m),p=n.initialConfig.cellWidth;n=n.initialConfig.cellHeight;void 0!==p&&(l.width=p/100*e.width,h.setWidth(l.width));void 0!==n&&(l.height=n/100*e.height,h.setHeight(l.height));h=l}c[m]=h}for(var r in c)h=c[r],Ext.getCmp(r).setSize(h);this.updateLayout()}});Ext.define("Voyant.panel.Veliza",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],xtype:"veliza",autoScroll:!0,statics:{i18n:{},api:{script:"",message:void 0},glyph:"xf0e6@FontAwesome"},config:{previous:[]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var a=this;Ext.apply(this,{title:this.localize("title"),glyph:"xf0e6@FontAwesome",layout:{type:"border",align:"stretch"},items:[{itemId:"chat",html:"\x3cform class\x3d'chat'\x3e\x3c/form\x3e",
region:"center",flex:2,autoScroll:!0},{itemId:"script",xtype:"form",region:"east",split:!0,title:this.localize("scriptEditor"),layout:{type:"vbox",align:"stretch"},items:[{html:(new Ext.XTemplate(this.localize("scriptIntro"))).apply([a.getBaseUrl()+"docs/#!/guide/veliza"])},{xtype:"textarea",name:"editor",fieldStyle:"white-space: pre",value:a.getApiParam("script"),flex:1,listeners:{afterrender:function(b){var c=a.getApiParam("corpus");c&&(b.mask(a.localize("loadingScript")),Ext.Ajax.request({url:a.getTromboneUrl(),
params:{tool:"corpus.Veliza",script:a.getApiParam("script"),corpus:c}}).then(function(c){(c=Ext.decode(c.responseText))&&c.veliza&&c.veliza.script?(b.setValue(c.veliza.script),b.resetOriginalValue()):c&&c.veliza&&c.veliza.id?a.setApiParam("script",c.veliza.id):a.showError(a.localize("unableFetchScript"));b.unmask()},function(b){a.showError(b)}))},scope:this}}],collapsed:!0,collapsible:!0,flex:1}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"textfield",itemId:"chatfield",
emptyText:this.localize("typeAndEnter"),flex:1,listeners:{specialkey:function(b,c){c.getKey()==c.ENTER&&(a.handleUserSentence(b.getValue()),b.setValue(""))}}},{xtype:"button",text:this.localize("send"),handler:function(){var b=this.up("toolbar").down("textfield");a.handleUserSentence(b.getValue(),!1);b.setValue("")}},{xtype:"button",text:this.localize("fromCorpus"),handler:function(){a.handleUserSentence("",!0)}}]}]});this.callParent();this.on("boxready",function(a){a.addSentence("fromThem","Hello, I'm Veliza, and I'm here to talk to you about your texts (you may know my sister \x3ca href\x3d'https://en.wikipedia.org/wiki/ELIZA' target\x3d'_blank'\x3eEliza\x3c/a\x3e she's a famous psychotherapist). I'm just learning to talk about text documents, but please, let me know about any anxieties you're feeling about your texts. Type a message in the box below and hit enter. Or, if you're feeling playful, hit the \x3ci\x3efrom text\x3c/i\x3e bottom in the lower right-hand corner to fetch a sentence from the corpus.");
this.sendApiParamMessage()})},sendApiParamMessage:function(){if(this.getApiParam("message"))if(this.getCorpus()){var a=Ext.Array.from(this.getApiParam("message")),b=a.shift();b&&(a&&this.setApiParam("message",a),this.handleUserSentence(b,void 0,!0))}else Ext.defer(this.sendApiParamMessage,100,this,[!0])},handleUserSentence:function(a,b,c){if((a=a.trim())||b){a&&this.addSentence("myMessage",a);this.mask();var d=this,e=this.getComponent("script").down("textarea");Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),
params:{corpus:d.getCorpus()?d.getCorpus().getId():void 0,tool:"corpus.Veliza",sentence:a,fromCorpus:b?!0:!1,script:e.isDirty()?e.getValue():this.getApiParam("script"),noCache:Ext.id()},success:function(a,g){d.unmask();a=Ext.decode(a.responseText);a.veliza.id&&(d.setApiParam("script",a.veliza.id),e.resetOriginalValue());var f=a.veliza.response;if(g=f.match(/\x3c!-- (.+?) --\x3e/)){g=Ext.decode(g[1]);for(key in g.params)g.params[key]=g.params[key].trim();f+="\x3cbr/\x3e\x3ciframe width\x3d'"+(g.width?
g.width:"100%")+"' height\x3d'"+(g.height?g.height:"250px")+"' src\x3d'"+d.getApplication().getBaseUrl()+"tool/"+g.tool+"/?corpus\x3d"+d.getCorpus().getId()+"\x26minimal\x3dtrue\x26"+Ext.Object.toQueryString(g.params)+"'\x3e\x3c/iframe\x3e"}g=a.veliza.sentence;d.setPrevious(a.veliza.previous);b?(meta=-1<a.veliza.docIndex?d.getCorpus().getDocument(a.veliza.docIndex).getShortLabel():void 0,d.addSentence("myMessage",g,meta),Ext.Function.defer(function(){this.addSentence("fromThem",f);c||this.body.scroll("b",
Infinity)},500,d)):(d.addSentence("fromThem",f),c||d.body.scroll("b",Infinity));d.getApiParam("message")&&d.sendApiParamMessage()},failure:function(a,b){d.showResponseError("Unable to get response from Veliza.",a)}})}},addSentence:function(a,b,c){var d=this.getComponent("chat").body;d.down("form").insertHtml("beforeEnd",'\x3cdiv class\x3d"message"\x3e\x3cdiv class\x3d"'+a+'"\x3e\x3cp\x3e'+b+"\x3c/p\x3e"+(c?"\x3cdate\x3e"+c+"\x3c/date\x3e":"")+"\x3c/div\x3e\x3c/div\x3e",!0);d.scroll("b",Infinity)}});Ext.define("Voyant.panel.WordTree",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.wordtree",statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:10,limit:100},glyph:"xf0e8@FontAwesome"},config:{tree:void 0,kwicStore:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],numBranches:5,lastClick:1},doubleClickDelay:300,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},
initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},'\x3cspan data-qtip\x3d"'+this.localize("poolTip")+'" class\x3d"info-tip"\x3e'+this.localize("pool")+"\x3c/span\x3e",{xtype:"slider",itemId:"poolSlider",minValue:10,value:100,maxValue:1E3,increment:5,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,b){this.setApiParam("limit",
a.getValue());this.reload()},scope:this}},'\x3cspan data-qtip\x3d"'+this.localize("branchesTip")+'" class\x3d"info-tip"\x3e'+this.localize("branches")+"\x3c/span\x3e",{xtype:"slider",itemId:"branchesSlider",minValue:2,value:5,maxValue:15,increment:1,width:50,listeners:{render:function(a){a.setValue(this.getNumBranches())},changecomplete:function(a,b){this.setNumBranches(a.getValue());this.reload()},scope:this}},'\x3cspan data-qtip\x3d"'+this.localize("contextTip")+'" class\x3d"info-tip"\x3e'+this.localize("context")+
"\x3c/span\x3e",{xtype:"slider",itemId:"contextSlider",minValue:3,value:10,maxValue:20,increment:2,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParam("context",a.getValue());this.reload()},scope:this}}]}]});this.setKwicStore(Ext.create("Voyant.data.store.Contexts",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}},listeners:{load:function(a,b,c,d){c&&this.parseRecords(b)},scope:this}}));this.on("loadedCorpus",function(a,
b){b.getCorpusTerms({autoLoad:!1}).load({callback:function(a,b,e){e&&0<a.length&&(a=a[0].getTerm(),this.setRoot(a))},scope:this,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList")}})},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.setRoot(b)},this);this.on("termsClicked",function(a,b){var c=[];b.forEach(function(a){Ext.isString(a)?c.push(a):a.term?c.push(a.term):a.getTerm&&c.push(a.getTerm())});this.setRoot(c)},this);this.on("documentTermsClicked",function(a,
b){var c=[];b.forEach(function(a){a.getTerm()&&c.push(a.getTerm())});this.setRoot(c)},this);this.on("resize",function(a,b,c){a=this.getTree();void 0!==a&&(a.visWidth(b).visHeight(c),a.redraw())},this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},parseRecords:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d={id:c,prefix:d.getLeft().trim().split(/\s+/),hit:d.getMiddle(),suffix:d.getRight().trim().split(/\s+/)};b.push(d)}var e={},f={};for(c=0;c<b.length;c++){d=b[c];var g=
d.prefix[d.prefix.length-1];d=d.suffix[0];e[g]?e[g]++:e[g]=1;f[d]?f[d]++:f[d]=1}a=[];for(c=0;c<b.length;c++)d=b[c],g=d.prefix[d.prefix.length-1],d=d.suffix[0],a.push({suffix:d,suffixCount:f[d],prefix:g,prefixCount:e[g]});a.sort(function(a,b){var c=a.suffixCount,d=b.suffixCount;a=a.prefixCount;b=b.prefixCount;return a>b?-1:a<b?1:c>d?-1:c<d?1:0});f=Math.min(this.getNumBranches(),a.length);d=[];e=[];for(c=0;c<f;c++)d.push(a[c].suffix),e.push(a[c].prefix);a=[];f=[];g=[];var k=[];for(c=0;c<b.length;c++){var h=
b[c];if(-1!=d.indexOf(h.suffix[0])||-1!=e.indexOf(h.suffix[0]))a.push(h.prefix),f.push(h.hit),g.push(h.suffix),k.push(h.id)}this.getTree().setupFromArrays(a,f,g,k,!1,["token","POS"],"/",["token","POS"]);this.getTree().succeeded()||this.toastInfo({html:this.localize("emptyText"),align:"bl"})},initGraph:function(){var a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),d=new doubletree.DoubleTree;d.init("#"+a.getId()).visWidth(b).visHeight(c).handlers({click:this.clickHandler.bind(this)});
this.setTree(d)},clickHandler:function(a){var b=(new Date).getTime();if(this.getLastClick()&&b-this.getLastClick()<this.doubleClickDelay){this.setLastClick(1);for(b=[];null!=a;)b.push(a.name),a=a.parent;this.getApplication().dispatchEvent("termsClicked",this,[b.reverse().join(" ")])}else this.setLastClick(b)},setRoot:function(a){this.setApiParam("query",this.stripPunctuation(a));this.getKwicStore().load({params:this.getApiParams()})},reload:function(){var a=this.getApiParam("query");void 0!==a&&this.setRoot(a)},
stripPunctuation:function(a){if(Ext.isString(a))return a.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");var b=[];a.forEach(function(a){b.push(a.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""))});return b}});Ext.define("Voyant.panel.WordWall",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.DiacriticsRemover"],alias:"widget.wordwall",statics:{i18n:{},api:{limit:500,stopList:"auto"},glyph:"xf1e0@FontAwesome"},config:{visId:void 0,vis:void 0,simulation:void 0,nodes:void 0,tempNodes:void 0,zoom:void 0,terms:void 0,segments:void 0,filterOutUniqueTerms:!0,currentSegment:void 0,segmentTerms:void 0,segmentTermsQueue:[],segmentDelay:5E3,segmentDelayTimer:void 0,webWorker:void 0,isSimulating:!1,
transitionTime:2E3,isTransitioning:!1,minFreq:void 0,maxFreq:void 0,letterDistribution:void 0,frequencyScale:void 0,xForceStrength:.2,yForceStrength:.1,chargeStrength:-75,chargeDistance:100,minFontSize:7,maxFontSize:60},count:0,MIN_TERMS:10,MAX_TERMS:2E3,MIN_SCALING:1,MAX_SCALING:20,debugMsg:!1,constructor:function(a){this.mixins["Voyant.util.DiacriticsRemover"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,"wordwall_"));this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[this.localize("terms"),{width:50,xtype:"slider",minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,increment:10,listeners:{render:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,b){this.setApiParam("limit",a.getValue());this.initLoad()},scope:this}},this.localize("delay"),{width:50,xtype:"slider",minValue:1,maxValue:60,
increment:1,listeners:{render:function(a){a.setValue(this.getSegmentDelay()/1E3)},changecomplete:function(a,b){this.setSegmentDelay(1E3*a.getValue());this.restartSegmentTimer()},scope:this}},this.localize("transition"),{width:50,xtype:"slider",minValue:100,maxValue:5E3,increment:1,listeners:{render:function(a){a.setValue(this.getTransitionTime())},changecomplete:function(a,b){this.setTransitionTime(a.getValue())},scope:this}},this.localize("xStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,
increment:10,listeners:{render:function(a){a.setValue(1E3*this.getXForceStrength())},changecomplete:function(a,b){this.setXForceStrength(a.getValue()/1E3)},scope:this}},this.localize("yStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(a){a.setValue(1E3*this.getYForceStrength())},changecomplete:function(a,b){this.setYForceStrength(a.getValue()/1E3)},scope:this}},this.localize("chargeStrength"),{width:50,xtype:"slider",minValue:-1E3,maxValue:0,increment:10,
listeners:{render:function(a){a.setValue(this.getChargeStrength())},changecomplete:function(a,b){this.setChargeStrength(a.getValue())},scope:this}},this.localize("chargeDistance"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(a){a.setValue(this.getChargeDistance())},changecomplete:function(a,b){this.setChargeDistance(a.getValue())},scope:this}},{xtype:"button",text:this.localize("stop"),handler:function(a){a.getText()===this.localize("stop")?(clearInterval(this.getSegmentDelayTimer()),
a.setText(this.localize("start"))):(this.restartSegmentTimer(),a.setText(this.localize("stop")))},scope:this},{itemId:"status",xtype:"tbtext",text:""}]}]});this.on("loadedCorpus",function(a,b){this.isVisible()&&this.initLoad()},this);this.on("resize",function(a,b,c){if(a=Ext.get(this.getVisId()))c=this.body,b=c.getHeight(),c=c.getWidth(),a.el.dom.setAttribute("width",c),a.el.dom.setAttribute("height",b)},this);this.callParent(arguments)},initVis:function(){var a=this.getLayout().getRenderTarget();
a.update("");var b=a.getWidth(),c=a.getHeight();a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("class","wordWall").attr("width",b).attr("height",c).append("g");this.setVis(a);this.setNodes(a.append("g").attr("class","nodes").selectAll(".node"));this.setTempNodes(a.append("g").attr("class","tempNodes").selectAll("text"));void 0===this.getWebWorker()&&(this.setWebWorker(new Worker(this.getBaseUrl()+"resources/d3/WordWallWorker.js")),this.getWebWorker().onmessage=this.handleWebWorkerMessage.bind(this))},
initLoad:function(){this.initVis();this.count=0;var a=this.getApiParams();a.tool="corpus.CorpusSegmentTerms";Ext.Ajax.request({url:this.getTromboneUrl(),params:a,success:function(a){a=Ext.decode(a.responseText);this.setSegments(a.corpusSegmentTerms.segments);a=a.corpusSegmentTerms.terms;this.getFilterOutUniqueTerms()&&(a=a.filter(function(a,b){return-1==a.rawFreqs.indexOf(0)}));this.setTerms(a);this.setCurrentSegment(this.getSegments().length);this.getNextSegment();this.restartSegmentTimer()},failure:function(a){this.debugMsg&&
console.log("failed",a)},scope:this})},restartSegmentTimer:function(){clearInterval(this.getSegmentDelayTimer());this.setSegmentDelayTimer(setInterval(function(){this.updateNodePositions()}.bind(this),this.getSegmentDelay()))},getNextSegment:function(){var a=this.getCurrentSegment();a++;a>=this.getSegments().length&&(a=0);this.setCurrentSegment(a);this.debugMsg&&console.log("getNextSegment",a);this.processTermsForSegment(this.getCurrentSegment())},processTermsForSegment:function(a){var b=Number.MAX_VALUE,
c=Number.MIN_VALUE,d={a:0,b:0,c:0,d:0,e:0,f:0,g:0,h:0,i:0,j:0,k:0,l:0,m:0,n:0,o:0,p:0,q:0,r:0,s:0,t:0,u:0,v:0,w:0,x:0,y:0,z:0};this.getTerms().forEach(function(e){e.id=this.idGet(e.term);e.value=e.rawFreqs[a];if(0<e.value){e.value<b&&(b=e.value);e.value>c&&(c=e.value);e.title=e.term+" ("+e.value+")";var f=this.removeDiacritics(e.term.charAt(0)).toLowerCase();e.letter=f;void 0===d[f]&&(d[f]=0);d[f]++}},this);this.setSegmentTerms(this.getTerms().filter(function(a){return 0<a.value}));this.setMinFreq(b);
this.setMaxFreq(c);var e=[],f;for(f in d){var g=d[f]/this.getTerms().length;e.push({letter:f,percent:g})}e.sort(function(a,b){return a.letter<b.letter?-1:a.letter>b.letter?1:0});this.setLetterDistribution(e);this.calculateNodeSizes(this.getSegmentTerms());this.runSimulation(this.getSegmentTerms())},calculateNodeSizes:function(a){var b=this.getTempNodes().data(a,function(a){return a.id}),c=function(b){var c=2*Math.min(1,a.length/this.MAX_TERMS)+1;b=this.getFrequencyScale()(b);return d3.scalePow().exponent(c).domain([0,
1]).range([this.getMinFontSize(),this.getMaxFontSize()])(b)}.bind(this),d=0;b.enter().append("text").attr("fill-opacity",0).attr("font-family",function(a){return"Arial"}).attr("font-size",function(a){var b=c(a.value);return a.fontSize=b}).text(function(a){return a.term}).each(function(a){var b=this.getBBox();a.bbox={};a.bbox.x=b.x;a.bbox.y=b.y;a.bbox.width=b.width;a.bbox.height=b.height;d+=b.width*b.height}).remove();var e=this.getLayout().getRenderTarget();b=e.getWidth();e=e.getHeight();b*=e;d>.6*
b?(this.setMaxFontSize(.9*this.getMaxFontSize()),this.setMinFontSize(.9*this.getMinFontSize()),this.calculateNodeSizes(a)):d<.5*b&&(this.setMaxFontSize(1.1*this.getMaxFontSize()),this.setMinFontSize(1.1*this.getMinFontSize()),this.calculateNodeSizes(a))},runSimulation:function(a){this.setIsSimulating(!0);var b=this.getLayout().getRenderTarget(),c=b.getWidth();b=b.getHeight();this.debugMsg&&console.time("runSim");this.getWebWorker().postMessage({terms:a,width:c,height:b,minFreq:this.getMinFreq(),maxFreq:this.getMaxFreq(),
xForceStrength:this.getXForceStrength(),yForceStrength:this.getYForceStrength(),chargeDistance:this.getChargeDistance(),chargeStrength:this.getChargeStrength(),letterDistribution:this.getLetterDistribution()})},handleWebWorkerMessage:function(a){switch(a.data.type){case "progress":a=parseInt(100*a.data.progress);this.getDockedItems()[1].getComponent("status").update(a+"%");break;case "msg":this.debugMsg&&console.log(a.data.msg);break;case "end":this.debugMsg&&console.timeEnd("runSim"),this.getDockedItems()[1].getComponent("status").update(""),
this.setIsSimulating(!1),this.getSegmentTermsQueue().push(a.data.nodes)}},updateNodePositions:function(){if(this.getIsTransitioning())Ext.Function.defer(this.updateNodePositions,100,this);else{this.count++;var a=this.getSegmentTermsQueue().shift();this.debugMsg&&console.log("queue length",this.getSegmentTermsQueue().length);if(void 0===a)this.debugMsg&&console.log("no nodes",this.count),!1===this.getIsSimulating()&&this.getNextSegment();else{this.setIsTransitioning(!0);0==this.getSegmentTermsQueue().length&&
this.getNextSegment();a=this.getNodes().data(a,function(a){return a.id});a.transition().duration(this.getTransitionTime()).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});var b=a.enter().append("g").attr("class","node").attr("id",function(a){return a.id}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).attr("fill-opacity",0);b.append("title").text(function(a){return a.title});b.append("text").attr("font-family",function(a){return"Arial"}).attr("font-size",function(a){return a.fontSize}).attr("fill",
function(a){return this.getApplication().getFeatureForTerm("color",a.term)}.bind(this)).style("cursor","pointer").style("user-select","none").attr("alignment-baseline","middle").text(function(a){return a.term});b.transition().duration(this.getTransitionTime()).attr("fill-opacity",1);b=b.merge(a);b.select("text").transition().duration(this.getTransitionTime()).attr("font-size",function(a){return a.fontSize});a.exit().transition().duration(this.getTransitionTime()).attr("fill-opacity",0).remove();setTimeout(function(){this.setIsTransitioning(!1)}.bind(this),
this.getTransitionTime());this.setNodes(b)}}},updateMinFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},updateMaxFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;var k=c.clientWidth,h=c.clientHeight;a=(a||.8)/Math.max(d/k,e/h);f=[k/
2-a*f,h/2-a*g];d3.select(c).transition().duration(b||500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},idGet:function(a){return a.replace(/\W/g,"_")}});Ext.define("Voyant.panel.Topics",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.widget.LiveSearchGrid"],alias:"widget.topics",statics:{i18n:{},api:{stopList:"auto",numTopics:25,limit:10,iterations:100,perDocLimit:1E3,query:void 0},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"numberfield",name:"perDocLimit",fieldLabel:"maximum words per document",labelAlign:"right",value:1E3,minValue:1,step:100,listeners:{afterrender:function(a){var b=a.up("window");b&&
b.panel&&(a.setValue(parseInt(b.panel.getApiParam("perDocLimit"))),a.setFieldLabel(b.panel.localize("perDocLimit")))},change:function(a,b){a=a.up("window");5E3<b&&a&&a.panel&&a.panel.toastInfo({html:a.panel.localize("perDocLimitHigh"),anchor:a.getTargetEl(),align:"tr",maxWidth:400})}}},{xtype:"numberfield",name:"iterations",fieldLabel:"iterations per run",labelAlign:"right",value:100,minValue:1,maxValue:1E4,step:50,listeners:{afterrender:function(a){var b=a.up("window");b&&b.panel&&(a.setValue(parseInt(b.panel.getApiParam("iterations"))),
a.setFieldLabel(b.panel.localize("iterations")))}}}],corpus:void 0,documentTopicSmoothing:.1,topicWordSmoothing:.01,vocabularySize:0,vocabularyCounts:{},stopwords:{},docSortSmoothing:10,sumDocSortSmoothing:250,requestedSweeps:0,wordTopicCounts:{},topicWordCounts:[],tokensPerTopic:[],topicWeights:Array(25),documents:[],progress:void 0,totalIterations:0,exportGridAll:!1},zeros:function(a,b){b=b||0;for(var c=Array(a),d=0;d<a;d++)c[d]=b;return c},constructor:function(a){Ext.apply(this,{title:this.localize("title"),
layout:{type:"hbox",pack:"start",align:"stretch"},store:{fields:["topic","scores"],data:[]},columns:[{text:this.localize("topic"),tooltip:this.localize("topicTip"),flex:3,dataIndex:"topic",sortable:!1},{xtype:"widgetcolumn",text:this.localize("scores"),tooltip:this.localize("scoresTip"),flex:1,dataIndex:"scores",widget:{xtype:"sparklineline",tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(a,c){return this.panel.getCorpus().getDocument(a).getTitle()+
"\x3cbr\x3ecoverage: "+Ext.util.Format.number(100*c,"0,000.0")+"%"},panel:this})}}],dockedItems:{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:['\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("searchTip")+'"\x3e'+this.localize("search")+"\x3c/span\x3e",{xtype:"textfield",name:"searchField",hideLabel:!0,width:80,listeners:{change:{fn:this.onTextFieldChange,scope:this,buffer:500}}},'\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("limitTermsTip")+'"\x3e'+this.localize("limitTerms")+
"\x3c/span\x3e",{width:80,hideLabel:!0,xtype:"slider",increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(a,c){this.setApiParams({limit:c});this.postSweep()},scope:this}},'\x3cspan class\x3d"info-tip" data-qtip\x3d"'+this.localize("numTopicsTip")+'"\x3e'+this.localize("numTopics")+"\x3c/span\x3e",{width:80,hideLabel:!0,xtype:"slider",increment:1,minValue:1,maxValue:200,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("numTopics")))},
changecomplete:function(a,c){this.setApiParams({numTopics:c});this.loadFromExistingDocuments()},scope:this}},{text:(new Ext.Template(this.localize("runIterations"))).apply([100]),itemId:"iterations",glyph:"xf04b@FontAwesome",tooltip:this.localize("runIterationsTip"),handler:this.runIterations,scope:this},{xtype:"tbtext",itemId:"done"},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);
this.resetData();this.on("loadedCorpus",function(a,c){this.setCorpus(c);if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(a,c){this.setApiParam("query",c);this.updateSearchResults()})},loadStopwords:function(){this.mask(this.localize("loadingStopWords"));Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:this.getApiParam("stopList"),corpus:this.getCorpus()?this.getCorpus().getAliasOrId():
void 0},success:function(a,b){this.unmask();var c={};Ext.util.JSON.decode(a.responseText).keywords.keywords.forEach(function(a){c[a]=1});this.setStopwords(c);this.loadDocuments()},scope:this})},loadDocuments:function(){this.mask(this.localize("loadingDocuments"));var a=this.getCorpus();a&&Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.DocumentTokens",corpus:a.getAliasOrId(),outputFormat:"text",template:"docTokens2idsAndText",limit:0,noOthers:!0,perDocLimit:1==a.getDocumentsCount()?
void 0:parseInt(this.getApiParam("perDocLimit"))},success:function(b,c){this.unmask();this.mask(this.localize("parsingDocuments"));b=b.responseText.trim().split(/(\r\n|\r|\n)/);if(1==b.length){if(b=b[0].split(": "),1<b.length){var d=a.getDocument(b[0]);c=b[1].split(" ");d=d.getLexicalTokensCount();d=10>d?d:1E3>d?10:100;d=10;for(var e=Math.floor(c.length/d),f=0;f<d;f++){var g=c.slice(f*e,f*e+e).join(" ");this.parseLine(b[0]+"-"+f+"\t"+b[0]+"-"+f+"\t"+g)}}}else b.forEach(function(b){b=b.split(": ");
if(1<b.length){var c=a.getDocument(b[0]);this.parseLine(b[0]+"\t"+c.getTinyLabel()+"\t"+b[1])}},this);this.unmask();this.runIterations()},scope:this})},resetData:function(){var a=parseInt(this.getApiParam("numTopics"));this.setVocabularyCounts({});this.setSumDocSortSmoothing(this.getDocSortSmoothing()*a);this.setRequestedSweeps(0);this.setWordTopicCounts({});this.setTopicWordCounts([]);this.setTokensPerTopic(this.zeros(a));this.setTopicWeights(this.zeros(a));this.setDocuments([]);this.setTotalIterations(0)},
loadFromExistingDocuments:function(){var a=this.getDocuments().map(function(a){return a.id+"\t"+a.date+"\t"+a.originalText});this.resetData();a.forEach(function(a){this.parseLine(a)},this);this.runIterations()},runIterations:function(){var a=this.getRequestedSweeps(),b=parseInt(this.getApiParam("iterations"));a+=parseInt(b);this.setTotalIterations(this.getTotalIterations()+b);this.setRequestedSweeps(a);this.getProgress()||(b=Ext.MessageBox.show({title:this.localize("runningIterations"),message:(new Ext.Template(this.localize("runningIterationsCount"))).apply([a]),
progress:!0,progressText:"",target:a,customUpdateProgress:function(a){this.updateProgress((this.config.target-a)*this.config.target," iterations")}}),this.setProgress(b),this.updateProgress(a));this.sweep()},updateProgress:function(a){var b=this.getProgress();a=this.getRequestedSweeps();if(b){var c=b.cfg.target;a=(c-a)/c;b.updateProgress(a,100*parseInt(a)+"% done")}},sweep:function(){Date.now();for(var a=parseInt(this.getApiParam("numTopics")),b=this.getVocabularySize(),c=this.getTopicWordSmoothing(),
d=this.getTokensPerTopic(),e=this.getDocuments(),f=this.getWordTopicCounts(),g=this.getTopicWeights(),k=this.getDocumentTopicSmoothing(),h=this.zeros(a),l=0;l<a;l++)h[l]=1/(b*c+d[l]);for(var m=0;m<e.length;m++)for(var n=e[m],p=n.topicCounts,r=0;r<n.tokens.length;r++){var q=n.tokens[r];if(!q.isStopword){d[q.topic]--;var u=f[q.word];u[q.topic]--;p[q.topic]--;h[q.topic]=1/(b*c+d[q.topic]);var v=0;for(l=0;l<a;l++)g[l]=u[l]?(k+p[l])*(c+u[l])*h[l]:(k+p[l])*c*h[l],v+=g[l];l=v*Math.random();v=0;for(l-=g[v];0<
l;)v++,l-=g[v];q.topic=v;d[q.topic]++;u[q.topic]=u[q.topic]?u[q.topic]+1:1;p[q.topic]++;h[q.topic]=1/(b*c+d[q.topic])}}a=this.getRequestedSweeps()-1;this.setRequestedSweeps(a);b=this.getProgress();0<a?(this.updateProgress(a),Ext.defer(this.sweep,0,this)):(b.close(),this.setProgress(void 0),this.postSweep())},postSweep:function(){this.sortTopicWords();var a=this.getStore(),b=(new Ext.Template(this.localize("totalDone"))).apply([Ext.util.Format.number(parseInt(this.getTotalIterations()),"0,000")]);
this.down("#done").setHtml(b);b=parseInt(this.getApiParam("numTopics"));for(var c=this.getTopicWordCounts(),d=[],e=this.getDocuments(),f=this.getDocSortSmoothing(),g=this.getSumDocSortSmoothing(),k=parseInt(this.getApiParam("limit")),h=0;h<b;h++){var l=e.map(function(a,b){return(a.topicCounts[h]+f)/(a.tokens.length+g)});d.push({topic:this.topNWords(c[h],k),scores:l})}a.loadData(d)},topNWords:function(a,b){return a.slice(0,b).map(function(a){return a.word}).join(" ")},sortTopicWords:function(){this.getTopicWordCounts();
var a=parseInt(this.getApiParam("numTopics")),b=this.getWordTopicCounts();var c=[];for(var d=0;d<a;d++)c[d]=[];for(var e in b)for(d in b[e])c[d].push({word:e,count:b[e][d]});for(d=0;d<a;d++)c[d].sort(this.byCountDescending);this.setTopicWordCounts(c)},byCountDescending:function(a,b){return b.count-a.count},initialize:function(){var a=(new Ext.Template(this.localize("runIterations"))).apply([Ext.util.Format.number(parseInt(this.getApiParam("iterations")),"0,000")]);this.down("#iterations").setText(a);
this.loadStopwords()},parseLine:function(a){var b=this.getStopwords(),c=this.getVocabularyCounts(),d=this.getTokensPerTopic(),e=this.getVocabularySize();c=this.getVocabularyCounts();var f=this.getDocuments(),g=parseInt(this.getApiParam("numTopics")),k=this.getWordTopicCounts();if(""!=a){var h=f.length,l="",m=a.split("\t");a=m[0];3==m.length&&(h=m[0],l=m[1],a=m[2]);var n=[];m=a.toLowerCase().split(" ");if(null!=m){var p=this.zeros(g);m.forEach(function(a){if(""!==a){var f=Math.floor(Math.random()*
g);2>=a.length&&(b[a]=1);var h=b[a];h?c[a]=c[a]?c[a]+1:1:(d[f]++,k[a]||(k[a]={},e++,c[a]=0),k[a][f]||(k[a][f]=0),k[a][f]+=1,c[a]+=1,p[f]+=1);n.push({word:a,topic:f,isStopword:h})}});this.setVocabularySize(e);f.push({originalOrder:f.length,id:h,date:l,originalText:a,tokens:n,topicCounts:p})}}}});Ext.define("Voyant.panel.Via",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.via",statics:{i18n:{},api:{stopList:"auto",limit:100,docIndex:void 0},glyph:"xf06e@FontAwesome"},config:{mode:void 0,options:[{xtype:"stoplistoption"},{xtype:"listeditor",name:"whiteList"},{xtype:"categoriesoption"}]},layout:"fit",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){Ext.apply(this,{title:this.localize("title"),
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:!0},{fieldLabel:this.localize("visible"),labelWidth:40,width:120,xtype:"slider",increment:10,minValue:10,maxValue:1E3,listeners:{afterrender:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,c){this.setApiParams({limit:c});this.loadFromCorpus(this.getCorpus())},scope:this}}]}]});this.callParent(arguments)},listeners:{resize:function(a,b,c){},loadedCorpus:function(a,
b){a=b.get("languageCodes");Ext.Array.each(a,function(a){if("en"!=a)return this.showError(this.localize("englishOnly")),!1},this);1E5<b.getWordTokensCount()&&!this.getApiParam("docIndex")&&this.setApiParam("docIndex",0);this.loadFromCorpus(b)},corpusSelected:function(a,b){this.setApiParam("docIndex","");this.loadFromCorpus(b)},documentSelected:function(a,b){this.setApiParam("docIndex",b.getIndex());this.loadFromCorpus(this.getCorpus())}},loadFromCorpus:function(a){var b=this;this.mask(this.localize("loading"));
var c=this.getApiParams();a.loadRelatedWords(c).then(function(a){b.unmask();a=a.map(function(a){return{source:a.getSource(),target:a.getTarget()}});var c=b.down("voyantnetworkgraph");c?c.loadJson({edges:a}):(c=Ext.create("Voyant.widget.VoyantNetworkGraph",{edges:a,listeners:{nodeclicked:function(a,c){b.dispatchEvent("termsClicked",b,[c.term])}}}),b.add(c))},function(a){b.unmask();a.timedout?b.showError(b.localize("timedout")):b.showError(a)})}});Ext.define("Voyant.notebook.editor.button.Add",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperadd",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf067@FontAwesome",textAlign:"left",listeners:{click:function(a,b){this.findParentByType("notebook").fireEvent("notebookWrapperAdd",this.findParentByType("notebookeditorwrapper"),b)}}});Ext.define("Voyant.notebook.editor.button.Edit",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperedit",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},glyph:"xf040@FontAwesome",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperEdit",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Counter",{extend:"Ext.toolbar.TextItem",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappercounter",statics:{i18n:{}},config:{order:0,name:void 0},cls:"notebookwrappercounter",constructor:function(a){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},setOrder:function(a){this.callParent(arguments);this.updateHtml()},updateHtml:function(){var a=this.getOrder()+1,b=this.getName();this.setHtml('\x3ca name\x3d"'+b+'" href\x3d"#'+
b+'"\x3e'+a+"\x3c/a\x3e")}});Ext.define("Voyant.notebook.editor.button.MoveDown",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermovedown",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf063@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveDown",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.MoveUp",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermoveup",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf062@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveUp",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Remove",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperremove",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf014@FontAwesome",textAlign:"left",listeners:{click:function(){Ext.Msg.show({buttons:Ext.Msg.OKCANCEL,icon:Ext.MessageBox.QUESTION,msg:this.localize("confirmRemove"),title:this.localize("confirmRemoveTitle"),fn:function(a){"ok"==
a&&this.findParentByType("notebook").fireEvent("notebookWrapperRemove",this.findParentByType("notebookeditorwrapper"))},scope:this})}}});Ext.define("Voyant.notebook.editor.button.Metadata",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermetadata",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf02c@FontAwesome",textAlign:"left",listeners:{click:function(a,b){this.findParentByType("notebook").fireEvent("notebookWrapperMetadata",this.findParentByType("notebookeditorwrapper"),b)}}});Ext.define("Voyant.notebook.editor.button.Movement",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.MoveUp","Voyant.notebook.editor.button.MoveDown","Voyant.notebook.editor.button.Remove"],alias:"widget.notebookwrappermovement",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf07d@FontAwesome",menu:[{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"},{xtype:"notebookwrapperremove"}]});Ext.define("Voyant.notebook.editor.button.Run",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrun",statics:{i18n:{}},glyph:"xf04b@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunAll",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrunall",statics:{i18n:{}},glyph:"xf04e@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunUntil",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrununtil",statics:{i18n:{}},glyph:"xf050@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.EditorWrapper",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.Movement","Voyant.notebook.editor.button.Add"],alias:"widget.notebookeditorwrapper",cls:"notebook-editor-wrapper",config:{cellId:void 0,content:"",isEditing:!1},border:!1,bodyBorder:!1,initComponent:function(){this.setCellId(this.config.cellId);this.on("afterrender",function(){this.getDockedItems().forEach(function(a){a.getTargetEl().setVisibilityMode(Ext.dom.Element.VISIBILITY)});
this.setActiveMode(!1);this.body.on("click",function(){this.removeCls("notebook-editor-wrapper-hover");this.setActiveMode(!0)},this);this.mon(this.getEl(),"mouseover",function(){this.setActiveMode(!0)},this);this.mon(this.getEl(),"mouseout",function(){this.setActiveMode(!1)},this)},this);this.callParent(arguments)},setActiveMode:function(a){this.getDockedItems().forEach(function(b){"right"==b.dock?b.items.each(function(b){0==b.hasCls("notebookwrappercounter")&&b.getTargetEl().setVisibility(a)}):b.getTargetEl().setVisibility(a)},
this);this.getIsEditing()||(a?this.body.addCls("notebook-editor-wrapper-hover"):this.body.removeCls("notebook-editor-wrapper-hover"))}});Ext.define("Voyant.notebook.editor.CodeEditor",{extend:"Ext.Component",alias:"widget.notebookcodeeditor",mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],embeddable:["Voyant.notebook.editor.CodeEditor"],cls:"notebook-code-editor",config:{theme:"ace/theme/chrome",mode:"ace/mode/javascript",content:"",docs:void 0,isChangeRegistered:!1,editor:void 0,editedTimeout:void 0,lines:0},statics:{i18n:{},api:{content:void 0}},constructor:function(a){this.callParent(arguments)},listeners:{boxready:function(){var a=
this,b=ace.edit(Ext.getDom(this.getEl()));b.$blockScrolling=Infinity;b.getSession().setUseWorker(!0);b.setTheme(this.getTheme());b.getSession().setMode(this.getMode());b.setOptions({minLines:6,maxLines:-1<this.getMode().indexOf("javascript")?Infinity:10,autoScrollEditorIntoView:!0,scrollPastEnd:!0});b.setHighlightActiveLine(!1);b.setHighlightGutterLine(!1);b.renderer.setShowPrintMargin(!1);b.setValue(this.getContent()?this.getContent():this.localize("emptyText"));b.clearSelection();b.on("focus",function(){setTimeout(function(){a.getEditor().setHighlightGutterLine(!0)},
100)},this);b.on("change",function(b,d){b=d.getSession().getScreenLength();b!=a.getLines()&&(a.up("notebookcodeeditorwrapper").setSize({height:b*d.renderer.lineHeight+d.renderer.scrollBar.getWidth()}),a.setLines(b));if(0==a.getIsChangeRegistered()){if(a.setIsChangeRegistered(!0),d=a.up("notebookcodeeditorwrapper"))d.setIsRun(!1),(d=d.up("notebook"))&&d.setIsEdited(!0)}else a.getEditedTimeout()||a.setEditedTimeout(setTimeout(function(){a.setIsChangeRegistered(!1)},3E4))},this);b.on("blur",function(){a.getEditor().setHighlightGutterLine(!1)});
b.commands.addCommand({name:"run",bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},exec:function(b){(b=a.up("notebookcodeeditorwrapper"))&&b.run()}});this.setEditor(b);ace.config.loadModule("ace/ext/tern",function(b){a.getEditor().setOptions({enableTern:{defs:a.docs?["browser","ecma5",a.docs]:["ecma5","browser"],plugins:{doc_comment:{fullDocs:!0}},useWorker:!0},enableSnippets:!1,enableBasicAutocompletion:!1})})},removed:function(a,b){a.getEditor()&&a.getEditor().destroy()}},switchModes:function(a){this.setMode("ace/mode/"+
a);this.getEditor().getSession().setMode(this.getMode());this.getEditor().setOptions({maxLines:-1<this.getMode().indexOf("javascript")?Infinity:10})},getValue:function(){return this.getEditor().getValue()}});Ext.define("Voyant.notebook.editor.CodeEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.CodeEditor","Voyant.notebook.editor.button.Run","Voyant.notebook.editor.button.RunAll"],alias:"widget.notebookcodeeditorwrapper",cls:"notebook-code-wrapper",statics:{i18n:{runUntil:"Run up to here",runUntilTip:"Run previous code blocks and this one.",runFrom:"Run from here onwards",runFromTip:"Run this and following code blocks."}},config:{isRun:!1},layout:{type:"vbox",
align:"stretch"},height:130,border:!1,EMPTY_RESULTS_TEXT:" ",constructor:function(a){this.results=Ext.create("Ext.Component",{align:"stretch",cls:"notebook-code-results",html:Ext.Array.from(a.output).join("")});this.editor=Ext.create("Voyant.notebook.editor.CodeEditor",{content:Ext.Array.from(a.input).join("\n"),docs:a.docs,mode:"ace/mode/"+(a.mode?a.mode:"javascript")});Ext.apply(this,{dockedItems:[{xtype:"toolbar",dock:"left",defaults:{textAlign:"left"},items:[{xtype:"notebookwrapperadd"},{xtype:"notebookwrapperrun",
listeners:{click:{fn:this.run,scope:this}}},{xtype:"notebookwrapperrununtil",listeners:{click:{fn:function(a,c){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("runUntil"),tooltip:this.localize("runUntilTip"),glyph:"xf049@FontAwesome",handler:function(){this.up("notebook").runUntil(this)},scope:this},{text:this.localize("runFrom"),tooltip:this.localize("runFromTip"),glyph:"xf050@FontAwesome",handler:function(){this.up("notebook").runFrom(this)},scope:this}]}).showAt(c.pageX,c.pageY)},scope:this}}},
{xtype:"button",glyph:"xf1c9@FontAwesome",tooltip:this.localize("codeModeTip"),listeners:{click:function(){var a=this,c=this.editor.getMode().split("/").pop();(new Ext.Window({title:"Resize Me",layout:"fit",width:200,items:[{xtype:"form",layout:{type:"vbox",align:"stretch"},bodyPadding:10,items:[{xtype:"fieldset",title:this.localize("modeCode"),items:{xtype:"radiofield",boxLabel:this.localize("modeJavascript"),name:"codeMode",inputValue:"javascript",flex:1,checked:"javascript"==c}},{xtype:"fieldset",
title:this.localize("modeData"),items:[{items:{xtype:"radiofield",boxLabel:this.localize("modeJson"),name:"codeMode",inputValue:"json",flex:1,checked:"json"==c}},{items:{xtype:"radiofield",boxLabel:this.localize("modeText"),name:"codeMode",inputValue:"text",flex:1,checked:"text"==c}},{items:{xtype:"radiofield",boxLabel:this.localize("modeHtml"),name:"codeMode",inputValue:"html",flex:1,checked:"html"==c}},{items:{xtype:"radiofield",boxLabel:this.localize("modeXml"),name:"codeMode",inputValue:"xml",
flex:1,checked:"xml"==c}}]}]}],buttons:[{text:this.localize("ok"),handler:function(){var b=this.up("window");values=b.down("form").getForm().getValues();a.switchModes(values.codeMode);b.close()}},{text:this.localize("cancel"),handler:function(){this.up("window").close()}}]})).show()},scope:this}}]},{xtype:"toolbar",dock:"right",items:[{xtype:"notebookwrappercounter",order:a.order,name:a.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}],items:[this.editor,
this.results]});this.callParent(arguments)},initComponent:function(a){var b=this;b.on("afterrender",function(){this.editor&&"ace/mode/javavscript"!=this.editor.getMode()&&this.switchModes(this.editor.getMode(),!0);this.getTargetEl().on("resize",function(a){var c=20;b.items.each(function(a){c+=a.getHeight()});b.setSize({height:c})})},this);b.callParent(arguments)},switchModes:function(a,b){var c=-1<a.indexOf("javascript");this.down("notebookwrapperrun").setVisible(c);this.down("notebookwrapperrununtil").setVisible(c);
this.results.setVisible(c);b||this.editor.switchModes(a)},run:function(a){if("ace/mode/javascript"==this.editor.getMode()){if(!0===a)return this._run();var b=this.up("notebook");Ext.Array.each(b.query("notebookcodeeditorwrapper"),function(a){if(a==this)return this._run(),!1;a.editor&&"ace/mode/javascript"==a.editor.getMode()&&0==a.getIsRun()&&Ext.Msg.confirm(this.localize("previousNotRunTitle"),this.localize("previousNotRun"),function(a){"yes"==a&&b.runAll()},this)},this)}},_run:function(){this.results.show();
this.results.update(this.EMPTY_RESULTS_TEXT);this.results.mask("working\u2026");var a=this.editor.getValue();Voyant.notebook.util.Show.TARGET=this.results.getEl();Voyant.notebook.Notebook.currentBlock=this;Voyant.notebook.Notebook.currentNotebook.setCurrentBlock(this);try{var b=eval.call(window,a)}catch(d){return this.results.unmask(),Voyant.notebook.util.Show.showError(d),this.getTargetEl().fireEvent("resize"),d}this.setIsRun(!0);if(void 0!==b)if(b.then&&b.catch&&b.finally){var c=this;b.then(function(a){c.results.unmask();
void 0!==a&&c._showResult(a)}).catch(function(a){c.results.unmask();Voyant.notebook.util.Show.showError(a)}).finally(function(){Ext.defer(function(){this.getTargetEl().fireEvent("resize")},50,c)})}else this.results.unmask(),this._showResult(b),this.getTargetEl().fireEvent("resize");else this.results.unmask(),this.getTargetEl().fireEvent("resize");return b},_showResult:function(a){this.results.getEl().dom.innerHTML===this.EMPTY_RESULTS_TEXT&&this.results.update(a)},clearResults:function(){this.results.show();
var a=this.results.el.down(".x-panel");if(a){var b=Ext.getCmp(a.id);b?b.destroy():a.destroy()}else this.results.update(" ");this.getTargetEl().fireEvent("resize")},tryToUnmask:function(){Spyral&&Spyral.promises&&Ext.defer(this.tryToUnmask,20,this);if(0==Voyant.application.getDeferredCount()){for(var a in window)"object"==typeof window[a]&&window[a]&&"opener"!=a&&window[a].isFulfilled&&window[a].isFulfilled()&&(window[a]=window[a].valueOf());this.results.unmask();0==this.results.getTargetEl().getHtml().trim().length&&
this.results.hide();this.getTargetEl().fireEvent("resize")}else Ext.defer(this.tryToUnmask,20,this)},getContent:function(){var a={input:this.editor.getValue(),mode:this.editor.getMode().split("/").pop()};if("javascript"==a.mode){var b=this.results.getTargetEl(),c=b.dom.cloneNode(!0);a.output=c.innerHTML;c.style.height||(a.output="\x3cdiv style\x3d'height: "+b.getHeight()+"px'\x3e"+a.output+"\x3c/div\x3e")}return a}});Ext.define("Voyant.notebook.editor.TextEditor",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.notebooktexteditor",cls:"notebook-text-editor",config:{ckeditorConfig:{toolbar:[{name:"basicstyles",items:["Bold","Italic","-","RemoveFormat"]},{name:"paragraph",items:"NumberedList BulletedList - Justify Outdent Indent Blockquote JustifyLeft JustifyCenter JustifyRight".split(" ")},{name:"colors",items:["TextColor","BGColor"]},{name:"styles",items:["Styles","Format"]},{name:"links",
items:["Link","Unlink","Anchor"]},{name:"insert",items:["Image","Table"]},{name:"document",items:["inserthtml4x","Sourcedialog","Stopediting"]}],extraPlugins:"stopediting,sourcedialog,justify,colorbutton,inserthtml4x",allowedContent:!0,toolbarCanCollapse:!0,startupFocus:!0},editor:void 0,isEditRegistered:!1,currentHeight:0},statics:{i18n:{}},border:!1,constructor:function(a){Ext.apply(this,{html:a.content?a.content:this.localize("emptyText")});this.callParent(arguments)},listeners:{boxready:function(a){this.getTargetEl().on("click",
function(b,c){"A"!=c.tagName&&this.handleClick(a)},this)},removed:function(a,b){a.getEditor()&&(a.getEditor().focusManager.blur(!0),a.getEditor().destroy())}},handleClick:function(a){if(!a.getEditor()||a.getEditor()&&a.getEditor().readOnly){var b=this.getTargetEl();b.set({contenteditable:!0});this.findParentByType("notebookeditorwrapper").setIsEditing(!0);if(a.getEditor())a.getEditor().setReadOnly(!1);else{var c=CKEDITOR.inline(b.dom,this.getCkeditorConfig());c.on("blur",function(b){a.findParentByType("notebookeditorwrapper").setIsEditing(!1).getEl().fireEvent("mouseout");
c.setReadOnly(!0)});c.on("change",function(){var a=c.container.$.clientHeight;a!=this.getCurrentHeight()&&(this.findParentByType("notebookeditorwrapper").setHeight(a),this.setCurrentHeight(c.container.$.clientHeight));if(this.getIsEditRegistered()){var b=this;setTimeout(function(){b.setIsEditRegistered(!1)},3E4)}else this.findParentByType("notebook").setIsEdited(!0),this.setIsEditRegistered(!0)},this);this.setEditor(c)}}},getContent:function(){return this.getTargetEl().dom.innerHTML}});Ext.define("Voyant.notebook.editor.TextEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.TextEditor","Voyant.notebook.editor.button.Edit"],alias:"widget.notebooktexteditorwrapper",cls:"notebook-text-wrapper",config:{content:""},minHeight:85,constructor:function(a){Ext.apply(this,{items:[{xtype:"notebooktexteditor",content:Ext.Array.from(a.input).join("")}],dockedItems:[{xtype:"toolbar",dock:"left",items:[{xtype:"notebookwrapperadd"}]},{xtype:"toolbar",
dock:"right",items:[{xtype:"notebookwrappercounter",order:a.order,name:a.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}]});this.callParent(arguments)},getContent:function(){return this.items.get(0).getContent()}});Ext.define("Voyant.notebook.github.OctokitWrapper",{extend:"Ext.Base",alias:"octokitwrapper",octokit:void 0,constructor:function(a){this.octokit=new Octokit({auth:a.authToken,userAgent:"https://github.com/sgsinclair/Voyant"})},getInfoForAuthenticatedUser:function(){return this.octokit.users.getAuthenticated()},getReposForAuthenticatedUser:function(a,b,c){return this.octokit.repos.listForAuthenticatedUser({affiliation:void 0===a?"owner":a,page:void 0===b?0:b,per_page:void 0===c?10:c})},getReposForUser:function(a,
b,c){return this.octokit.search.repos({q:"user:"+a,page:void 0===b?0:b,per_page:void 0===c?10:c})},searchWithinRepositories:function(a,b,c){console.log(a)},getRepoContents:function(a){a=this.parseFullName(a);return this.getBranchSHAs({owner:a.owner,repo:a.repo,branch:"master"}).then(function(a){return this.getTreeContentsRecursively(a)}.bind(this))},getTreeContentsRecursively:function(a){return this.octokit.git.getTree({owner:a.owner,repo:a.repo,tree_sha:a.baseTreeSHA,recursive:1,headers:{"If-None-Match":""}}).then(function(b){return Object.assign({},
a,{contents:this.unflattenContents(b.data.tree),truncated:b.data.truncated})}.bind(this))},loadFile:function(a,b){a=this.parseFullName(a);var c=a.owner,d=a.repo;return this.octokit.repos.getContents({owner:c,repo:d,ref:"master",path:b}).then(function(a){return{owner:c,repo:d,ref:"master",path:b,sha:a.data.sha,file:atob(a.data.content)}}.bind(this))},doesRepoExist:function(a,b){return this.getRepoContents(a+"/"+b).then(function(a){return!0}.bind(this),function(a){console.log(a);return!1}.bind(this))},
getPermissionsForUser:function(a,b,c){return this.octokit.repos.getCollaboratorPermissionLevel({owner:a,repo:b,username:c}).then(function(a){return a.data.permission}.bind(this),function(a){return"none"}.bind(this))},saveFile:function(a,b,c,d,e,f,g){var k=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(h){if(1==h.nextAddress)return void 0!==g?h.jumpTo(2):h.yield(k.getLatestFileSHA({owner:a,repo:b,branch:e,path:c}),3);2!=h.nextAddress&&(g=h.yieldResult);return h.return(k.octokit.repos.createOrUpdateFile({owner:a,
repo:b,path:c,content:btoa(d),branch:e,message:f,sha:g}))})},parseFullName:function(a){var b=$jscomp.makeIterator(a.split("/"));a=b.next().value;b=b.next().value;return{owner:a,repo:b}},getBranchSHAs:function(a){return this.octokit.repos.getBranch({owner:a.owner,repo:a.repo,branch:a.branch,headers:{"If-None-Match":""}}).then(function(b){return Object.assign({},a,{baseTreeSHA:b.data.commit.commit.tree.sha,parentCommitSHA:b.data.commit.sha})})},getLatestFileSHA:function(a){var b=this,c,d,e,f,g,k,h,
l,m,n,p;return $jscomp.asyncExecutePromiseGeneratorProgram(function(r){if(1==r.nextAddress)return c=a,d=c.owner,e=c.repo,f=c.branch,g=c.path,r.yield(b.octokit.request({method:"POST",url:"/graphql",query:'{\n\t\t\t\trepository(owner: "'+d+'", name: "'+e+'") {\n\t\t\t\t\tobject(expression: "'+f+":"+g+'") {\n\t\t\t\t\t\t... on Blob {\n\t\t\t\t\t\t\toid\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}'}).catch(function(a){console.log(a)}),2);k=r.yieldResult;h=k.data;l=h.data;m=l.repository;p=(n=m.object)?
n.oid:void 0;return r.return(p)})},unflattenContents:function(a){var b={type:"folder",name:"",path:"",contents:[]},c=function(a,b){return a.contents.find(function(a){return"folder"===a.type&&a.name===b})};a.filter(function(a){return"blob"===a.type}).forEach(function(a){var d=a.path.split("/");d.reduce(function(a,b,e){var f=c(a,b);if(f)return f;if(d.length-1==e)a.contents.push({type:"file",name:b,path:a.path+"/"+b});else return b={type:"folder",name:b,path:a.path+"/"+b,contents:[]},a.contents.push(b),
b},b)});return b}});Ext.define("Voyant.notebook.github.ReposBrowser",{extend:"Ext.container.Container",xtype:"githubreposbrowser",config:{repoType:"owner",selectedNode:void 0,repoId:void 0,path:void 0},octokit:void 0,constructor:function(a){a=a||{};this.octokit=a.octokit;this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"hbox",align:"stretch",pack:"start"},items:[{layout:{type:"vbox",align:"stretch",pack:"start"},flex:1,items:[{layout:{type:"accordion"},items:[{title:"My Repositories",
frame:!0,items:{xtype:"radiogroup",fieldLabel:"Show repositories for which I am",labelAlign:"top",layout:"vbox",items:[{boxLabel:"Owner",name:"repoType",inputValue:"owner",checked:!0},{boxLabel:"Collaborator",name:"repoType",inputValue:"collaborator"},{boxLabel:"Organization Member",name:"repoType",inputValue:"organization_member"}],listeners:{change:function(a,b,c){var d=this;this.setRepoType(b.repoType);this.clearTree(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(a){d.addReposToTree(a.data)},
function(a){console.log(a)})},scope:this}},listeners:{expand:function(){var a=this;this.clearTree(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(b){a.addReposToTree(b.data)},function(a){console.log(a)})},scope:this}},{title:"Public Repositories",frame:!0,layout:"vbox",items:[{fieldLabel:"Limit to user or organization",labelAlign:"top",xtype:"textfield"},{text:"Search",xtype:"button",handler:function(a){var b=this;a=a.prev("textfield").getValue();""!==a&&(this.clearTree(!0),
this.octokit.getReposForUser(a,0,100).then(function(a){b.addReposToTree(a.data.items)},function(a){console.log(a)}))},scope:this}],listeners:{expand:function(){this.clearTree()},scope:this}}]}]},{flex:2,layout:"fit",xtype:"treepanel",itemId:"repoTree",title:"Repositories",scrollable:!0,rootVisible:!1,viewConfig:{emptyText:"No results",listeners:{afteritemexpand:function(a,b,c){if(!1===a.hasChildNodes())switch(a.data.type){case "repo":var d=c.querySelector("tr");Ext.fly(d).addCls("x-grid-tree-loading");
this.octokit.getRepoContents(a.getId()).then(function(b){Ext.fly(d).removeCls("x-grid-tree-loading");this.addRepoContentsToNode(a,b)}.bind(this))}},itemclick:function(a,b,c){this.setSelectedNode(b);this.fireEvent("nodeSelected",this,b.data.type,b)},scope:this}},store:{root:{name:"Root",children:[]}}}],listeners:{boxready:function(){var a=this;this.down("#repoTree").setLoading(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(b){a.addReposToTree(b.data)},function(a){console.log(a)})}}});
this.callParent(arguments)},updateSelectedNode:function(a,b){if(void 0!==a){for(b=a;null!==b&&"repo"!==b.data.type;)b=b.parentNode;this.setRepoId(b.getId());this.setPath(a.getId())}else this.setRepoId(void 0),this.setPath(void 0)},clearTree:function(a){var b=this.down("#repoTree");b.getRootNode().removeAll();b.getView().refresh();a&&b.setLoading(!0);this.setSelectedNode(void 0);this.fireEvent("nodeDeselected",this)},addReposToTree:function(a){var b=this.down("#repoTree");b.setLoading(!1);b=b.getRootNode();
a=a.map(function(a){return{id:a.full_name,text:a.full_name,description:a.description,leaf:!1,type:"repo"}});b.appendChild(a)},addRepoContentsToNode:function(a,b){function c(a){var b={id:a.path,text:a.name,type:a.type,leaf:"file"===a.type};!1===b.leaf&&(b.children=[],a.contents.forEach(function(a){b.children.push(c(a))}));return b}b=c(b.contents);a.appendChild(b.children)}});Ext.define("Voyant.notebook.github.FileSaver",{extend:"Ext.container.Container",xtype:"githubfilesaver",config:{currentFile:void 0,username:void 0},octokit:void 0,saveData:void 0,constructor:function(a){a=a||{};this.octokit=a.octokit;this.saveData=a.saveData;this.setCurrentFile(a.currentFile);this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"vbox",pack:"start",align:"stretch"},items:[{xtype:"githubreposbrowser",octokit:this.octokit,itemId:"repoBrowser",flex:1,listeners:{nodeSelected:function(a,
b,c){c=this.queryById("saveForm").getForm();var d=$jscomp.makeIterator(a.getRepoId().split("/")),e=d.next().value;d=d.next().value;c.setValues({owner:e,repo:d});"file"===b?(a=this.getPathComponents(a.getPath()),c.setValues(Object.assign({},a))):"folder"===b?(a=a.getPath().replace(/^\//,""),c.setValues({folder:a,file:""})):"repo"===b&&c.setValues({folder:"",file:""})},nodeDeselected:function(a){},scope:this}},{bodyPadding:"10",height:200,layout:{type:"vbox",pack:"start"},xtype:"form",itemId:"saveForm",
items:[{html:'\x3cspan class\x3d"x-panel-header-title-default"\x3eRepository Path\x3c/span\x3e'},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"GitHub User",name:"owner",allowBlank:!1,margin:"0 10 0 0"},{fieldLabel:"Repository Name",allowBlank:!1,name:"repo"}]},{html:'\x3cspan class\x3d"x-panel-header-title-default"\x3eFile Path\x3c/span\x3e',margin:"10 0 0 0"},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"Folder(s)",
name:"folder",allowBlank:!0,margin:"0 10 0 0"},{fieldLabel:"File Name",allowBlank:!1,name:"file"}]},{itemId:"status",html:"",margin:"15 0 0 0"}],listeners:{validitychange:function(a,b){this.fireEvent("formValidityChange",this,b)},scope:this}}],listeners:{boxready:function(){this.initForm()},scope:this}});this.callParent(arguments)},initForm:function(){this.octokit.getInfoForAuthenticatedUser().then(function(a){var b=a.data.login;this.setUsername(b);a=this.queryById("saveForm").getForm();var c=this.getCurrentFile();
void 0!==c?(b=this.getPathComponents(c.path),a.setValues(Object.assign({},{owner:c.owner,repo:c.repo},b))):a.setValues({owner:b})}.bind(this))},getPathComponents:function(a){a=a.split("/");var b=a[a.length-1],c="";2<a.length&&(c=a.slice(0,-1).join("/"));return{folder:c,file:b}},doSave:function(a){var b=this,c,d,e,f,g,k,h,l,m,n,p,r,q;return $jscomp.asyncExecutePromiseGeneratorProgram(function(a){switch(a.nextAddress){case 1:c=b.queryById("saveForm").getForm();if(!c.isValid()){b.setStatus("Form is not valid",
"error");a.jumpTo(0);break}d=c.getValues();e=d.owner;f=d.repo;g=d.folder;h=k=d.file;""!==g&&(h=g+"/"+k);b.setStatus("Checking repository");return a.yield(b.octokit.doesRepoExist(e,f),3);case 3:l=a.yieldResult;if(!l){b.setStatus("The specified repository does not exist","error");a.jumpTo(0);break}b.setStatus("Checking permissions");return a.yield(b.octokit.getPermissionsForUser(e,f,b.getUsername()),5);case 5:m=a.yieldResult;if("none"===m||"read"===m){b.setStatus("You don't have permission to write to this repository",
"error");a.jumpTo(0);break}b.setStatus("Checking file");n="master";p=b.saveData;r={owner:e,repo:f,branch:n,path:h};return a.yield(b.octokit.getLatestFileSHA(r),7);case 7:q=a.yieldResult,void 0!==q?b.octokit.saveFile(e,f,h,p,n,"File updated by Spyral",q).then(function(a){this.setStatus("File updated");setTimeout(function(){this.fireEvent("fileSaved",this,r)}.bind(this),500)}.bind(b),function(a){this.setStatus("Error: "+a.message,"error")}):b.octokit.saveFile(e,f,h,p,n,"File created by Spyral").then(function(a){this.setStatus("File created");
setTimeout(function(){this.fireEvent("fileSaved",this,r)}.bind(this),500)}.bind(b),function(a){this.setStatus("Error: "+a.message,"error")}),a.jumpToEnd()}})},setStatus:function(a,b){var c="";b&&"error"===b&&(c="x-form-invalid-under-default");this.queryById("status").setHtml('\x3cspan class\x3d"'+c+'"\x3e'+a+"\x3c/span\x3e")}});Ext.define("Voyant.notebook.github.GitHubDialogs",{extend:"Ext.Component",requires:["Voyant.notebook.github.OctokitWrapper","Voyant.notebook.github.ReposBrowser","Voyant.notebook.github.FileSaver"],alias:"widget.githubdialogs",config:{repoType:"owner",currentFile:void 0},authToken:void 0,octokitWrapper:void 0,currentWindow:void 0,constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},close:function(){void 0!==this.currentWindow&&(this.currentWindow.close(),
this.currentWindow=void 0)},showAuthenticate:function(a){var b=this,c=void 0;c=Ext.create("Ext.window.Window",{title:"Authenticate with GitHub",width:750,height:550,closable:!1,layout:{type:"vbox",align:"middle",pack:"center"},items:[{html:'\x3cdiv style\x3d"margin-bottom: 10px;"\x3eYou must authorize Spyral to use GitHub on your behalf.\x3c/div\x3e'},{xtype:"button",text:"Authorize with GitHub",handler:function(c){function d(e){e.origin===window.location.origin&&"oauth_cookie_set"===e.data&&(window.removeEventListener("message",
d,!1),e.source.close(),b.initOctokitWrapper(),c.up("window").close(),a.call(b))}window.open(Voyant.application.getBaseUrlFull()+"spyral/oauth","_blank");window.addEventListener("message",d,!1)}}],buttons:[{text:"Cancel",handler:function(){b.close()}}]});c.show();this.currentWindow=c},showLoad:function(){var a=this;this.authToken=this.getCookieValue("access-token");if(""===this.authToken)this.showAuthenticate(this.showLoad);else{void 0===this.octokitWrapper&&this.initOctokitWrapper();var b=void 0;
b=Ext.create("Ext.window.Window",{title:"Load from GitHub",width:750,height:550,closable:!1,maximizable:!0,layout:"fit",items:{xtype:"githubreposbrowser",octokit:this.octokitWrapper,itemId:"repoBrowser",listeners:{nodeSelected:function(a,d,e){"file"===d?b.queryById("load").setDisabled(!1):b.queryById("load").setDisabled(!0)},nodeDeselected:function(a){b.queryById("load").setDisabled(!0)}}},buttons:[{text:"Load Selected",itemId:"load",disabled:!0,handler:function(){var a=b.queryById("repoBrowser");
this.loadFile(a.getRepoId(),a.getPath())},scope:this},{text:"Cancel",handler:function(){a.close()}}]});b.show();this.currentWindow=b}},showSave:function(a){var b=this;this.authToken=this.getCookieValue("access-token");if(""===this.authToken)this.showAuthenticate();else{void 0===this.octokitWrapper&&this.initOctokitWrapper();var c=void 0;c=Ext.create("Ext.window.Window",{title:"Save to GitHub",width:750,height:650,closable:!1,maximizable:!0,layout:"fit",items:{xtype:"githubfilesaver",octokit:this.octokitWrapper,
currentFile:this.getCurrentFile(),saveData:a,itemId:"fileSaver",listeners:{formValidityChange:function(a,b){c.queryById("save").setDisabled(!b)},fileSaved:function(a,c){b.fireEvent("fileSaved",b,c)}}},buttons:[{text:"Save",itemId:"save",disabled:!0,handler:function(){c.queryById("fileSaver").doSave()},scope:this},{text:"Cancel",handler:function(){b.close();b.fireEvent("saveCancelled",b)}}]});c.show();this.currentWindow=c}},getCookieValue:function(a){var b=(" "+document.cookie).match(new RegExp("[; ]"+
a+"\x3d([^\\s;]*)"));return a&&b?unescape(b[1]):""},initOctokitWrapper:function(){this.authToken=this.getCookieValue("access-token");this.octokitWrapper=new Voyant.notebook.github.OctokitWrapper({authToken:this.authToken})},loadFileFromId:function(a){var b=decodeURIComponent(a).split("/");3<=b.length&&(a=b[0]+"/"+b[1],b=b.slice(2).join("/"),this.loadFile(a,b))},loadFile:function(a,b){var c=this;this.authToken=this.getCookieValue("access-token");""===this.authToken?this.showAuthenticate(this.loadFile.bind(this,
a,b)):(void 0===this.octokitWrapper&&this.initOctokitWrapper(),this.octokitWrapper.loadFile(a,b).then(function(a){c.setCurrentFile(a);c.fireEvent("fileLoaded",c,a)}))}});Ext.define("Voyant.notebook.StorageDialogs",{extend:"Ext.Component",requires:[],alias:"",config:{accessCode:void 0},constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},showSave:function(a,b){b=void 0===b?"":b;var c=this,d=""===b;Ext.create("Ext.window.Window",{title:d?"Save New Notebook":"Overwrite Existing Notebook",items:[{xtype:"form",width:450,bodyPadding:5,plugins:["datatip"],listeners:{beforeshowtip:function(a,b,c){return!b.currentTarget.el.hasCls("x-form-invalid")}},
layout:"anchor",defaults:{labelAlign:"right",labelWidth:160,width:360,inputAttrTpl:'spellcheck\x3d"false"',xtype:"textfield"},items:[{fieldLabel:"Notebook ID"+(d?" (optional)":""),name:"notebookId",value:b,allowBlank:!0,readOnly:!d,tooltip:"An ID used to identify this notebook. If left blank, one will be generated for you.",validator:function(a){return""==a?!0:null===a.match(/^[\w-]{4,16}$/)?"The ID must be between 4 and 16 alphanumeric characters.":!0}},{fieldLabel:"Access Code",name:"accessCode",
allowBlank:!1,value:d?this.generateAccessCode():this.getAccessCode(),tooltip:"The Access Code is required to overwrite this notebook.",validator:function(a){return null===a.match(/^[\w-]{4,16}$/)?"The access code must be between 4 and 16 alphanumeric characters.":!0}},{fieldLabel:"Email (optional)",name:"email",allowBlank:!0,vtype:"email",hidden:!d,tooltip:"An email will be sent to this address with the Notebook URL and Access Code."}]}],buttons:[{text:"Cancel",ui:"default-toolbar",handler:function(){this.up("window").close();
c.fireEvent("saveCancelled",c)}}," ",{text:"Save",handler:function(b){var e=b.up("window"),g=e.down("form").getForm();if(g.isValid()){var k=g.getValues();k.data=a;d&&""!==k.notebookId?c.doesNotebookIdExist(k.notebookId).then(function(a){a?g.findField("notebookId").markInvalid("That Notebook ID already exists."):(c.doSave(k),e.close())}):(b.setDisabled(!0),c.doSave(k).then(function(a){b.setDisabled(!1);a?e.close():g.findField("accessCode").markInvalid("Invalid access code.")}))}}}],listeners:{close:function(){c.fireEvent("close",
c)}}}).show()},doesNotebookIdExist:function(a){var b=new Ext.Deferred;Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"exists",id:a,noCache:1}).then(function(a){b.resolve("true"===a.notebook.data)}).catch(function(a){console.log(a)});return b.promise},doSave:function(a){var b=a.accessCode,c=this;return Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"save",id:a.notebookId,accessCode:b,email:a.email,data:a.data}).then(function(a){if("true"!==a.notebook.data)return!1;c.setAccessCode(b);
c.fireEvent("fileSaved",c,a.notebook.id);return!0}).catch(function(a){c.fireEvent("fileSaved",c,null);return!1})},generateAccessCode:function(){for(var a="abcdefghijklmnopqrstuvwxyz".split(""),b="";6>b.length;)if(.3>Math.random())b+=Math.floor(9*Math.random());else{var c=a[Math.floor(Math.random()*a.length)];.5>Math.random()&&(c=c.toUpperCase());b+=c}return b}});Ext.define("Voyant.notebook.Notebook",{alternateClassName:["Notebook"],extend:"Ext.panel.Panel",requires:"Voyant.notebook.editor.CodeEditorWrapper Voyant.notebook.editor.TextEditorWrapper Voyant.notebook.util.Show Voyant.panel.Cirrus Voyant.panel.Summary Voyant.notebook.StorageDialogs Voyant.notebook.github.GitHubDialogs".split(" "),mixins:["Voyant.panel.Panel"],alias:"widget.notebook",statics:{i18n:{title:"Spyral",metadataEditor:"Edit Metadata",metadataTitle:"Title",metadataTip:"Edit notebook metadata.",
metadataAuthor:"Author(s)",metadataKeywords:"Keywords",metadataDescription:"Description",metadataLicense:"Licence",metadataLanguage:"Language",metadataReset:"Reset",metadataSave:"Save",metadataCancel:"Cancel",created:"Created",modified:"Modified",clickToEdit:"Click to edit",cantLoadNotebook:"Unable to load Spyral notebook:",cannotLoadJson:"Unable to parse JSON input.",cannotLoadJsonUnrecognized:"Unable to recognize JSON input.",cannotLoadUnrecognized:"Unable to recognize input.",openTitle:"Open",
openMsg:"Paste in Notebook ID, a URL or a Spyral data file (in HTML).",exportHtmlDownload:"HTML (download)"},api:{input:void 0,inputEncodedBase64Json:void 0,run:void 0},currentNotebook:void 0},config:{notebookId:void 0,metadata:void 0,isEdited:!1,version:"3.0",currentBlock:void 0,storageSolution:"voyant"},voyantStorageDialogs:void 0,githubDialogs:void 0,spyralTernDocs:void 0,constructor:function(a){Voyant.notebook.Notebook.currentNotebook=this;Ext.apply(a,{title:this.localize("title"),autoScroll:!0,
includeTools:{help:!0,gear:!0,save:!0,saveIt:{tooltip:this.localize("saveItTip"),itemId:"saveItTool",xtype:"toolmenu",glyph:"xf0c2@FontAwesome",disabled:!0,scope:this,items:[{text:"Save",xtype:"menuitem",glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,!1),scope:this},{text:"Save As...",xtype:"menuitem",glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,!0),scope:this}]},"new":{tooltip:this.localize("newTip"),callback:function(){var a=this.getBaseUrl()+"spyral/";this.getApplication().openUrl(a)},
xtype:"toolmenu",glyph:"xf067@FontAwesome",scope:this},open:{tooltip:this.localize("openTip"),xtype:"toolmenu",glyph:"xf115@FontAwesome",callback:function(a,c){a=this.getStorageSolution();void 0!==a&&(setTimeout(function(){c.toolMenu.hide()}),"github"===a?this.githubDialogs.showLoad():Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(a,b){b=b.trim();"ok"==a&&(this.clear(),this.loadFromString(b))},this,!0))},scope:this,items:[{text:"Load",xtype:"menuitem",glyph:"xf115@FontAwesome",
handler:function(){Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(a,c){c=c.trim();"ok"==a&&(this.clear(),this.loadFromString(c))},this,!0)},scope:this},{text:"Load from GitHub",xtype:"menuitem",glyph:"xf115@FontAwesome",handler:function(){this.githubDialogs.showLoad()},scope:this}]},runall:{tooltip:this.localize("runallTip"),callback:this.runAll,xtype:"toolmenu",glyph:"xf04e@FontAwesome",scope:this},metadata:{tooltip:this.localize("metadataTip"),callback:this.showMetadataEditor,
xtype:"toolmenu",glyph:"xf02c@FontAwesome",scope:this}},items:[{itemId:"spyralHeader",cls:"spyral-header",listeners:{afterrender:function(a){Ext.tip.QuickTipManager.register({target:a.getId(),text:this.localize("clickToEdit")});a.getTargetEl().on("click",function(b){this.showMetadataEditor();a.removeCls("editable")},this);a.mon(a.getEl(),"mouseover",function(){a.addCls("editable")});a.mon(a.getEl(),"mouseout",function(){a.removeCls("editable")})},scope:this}},{xtype:"container",itemId:"cells"},{itemId:"spyralFooter",
cls:"spyral-footer",listeners:{afterrender:function(a){Ext.tip.QuickTipManager.register({target:a.getId(),text:this.localize("clickToEdit")});a.getTargetEl().on("click",function(b){this.showMetadataEditor();a.removeCls("editable")},this);a.mon(a.getEl(),"mouseover",function(){a.addCls("editable")});a.mon(a.getEl(),"mouseout",function(){a.removeCls("editable")})},scope:this}}],listeners:{afterrender:this.init,notebookWrapperMoveUp:this.notebookWrapperMoveUp,notebookWrapperMoveDown:this.notebookWrapperMoveDown,
notebookWrapperRemove:this.notebookWrapperRemove,notebookWrapperAdd:this.notebookWrapperAdd,scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.voyantStorageDialogs=new Voyant.notebook.StorageDialogs({listeners:{fileLoaded:function(a){},fileSaved:function(a,c){this.unmask();null!==c&&((a=this.getNotebookId())&&c==a||this.setNotebookId(c),this.toastInfo({html:this.localize("saved"),anchor:"tr"}),this.setIsEdited(!1))},saveCancelled:function(){},
close:function(){this.unmask()},scope:this}});this.githubDialogs=new Voyant.notebook.github.GitHubDialogs({listeners:{fileLoaded:function(a,c){a=c.owner;var b=c.repo,e=c.path;c=c.file;this.githubDialogs.close();this.clear();this.loadFromString(c);c=encodeURIComponent(a+"/"+b+"/"+e);-1===location.search.indexOf(c)&&(a=this.getBaseUrl()+"spyral/?githubId\x3d"+c,window.history.pushState({url:a},"Spyral Notebook: "+c,a))},fileSaved:function(a,c){a=c.owner;var b=c.repo;c=c.path;this.githubDialogs.close();
this.unmask();this.toastInfo({html:this.localize("saved"),anchor:"tr"});this.setIsEdited(!1);c=encodeURIComponent(a+"/"+b+"/"+c);-1===location.search.indexOf(c)&&(a=this.getBaseUrl()+"spyral/?githubId\x3d"+c,window.history.pushState({url:a},"Spyral Notebook: "+c,a))},saveCancelled:function(a){this.unmask()},scope:this}})},init:function(){window.Corpus=Spyral.Corpus;window.Table=Spyral.Table;window.loadCorpus=function(){return Spyral.Corpus.load.apply(Spyral.Corpus.load,arguments)};window.createTable=
function(){return Spyral.Table.create(arguments)};Ext.Ajax.request({url:this.getApplication().getBaseUrlFull()+"resources/spyral/docs/spyral.json",callback:function(a,b,c){b&&(this.spyralTernDocs=Ext.JSON.decode(c.responseText),this.spyralTernDocs.Corpus=this.spyralTernDocs.Spyral.Corpus,this.spyralTernDocs.Table=this.spyralTernDocs.Spyral.Table,this.spyralTernDocs.loadCorpus=this.spyralTernDocs.Spyral.Corpus.load,this.spyralTernDocs.createTable=this.spyralTernDocs.Spyral.Table.create);a=Ext.Object.fromQueryString(document.location.search,
!0);b=Ext.isDefined(a.run);c=/\/spyral\/([\w-]+)\/?$/.exec(location.pathname);var d=Ext.isDefined(a.githubId);"inputJsonArrayOfEncodedBase64"in a?Ext.decode(a.inputJsonArrayOfEncodedBase64).forEach(function(a){a=decodeURIComponent(atob(a));0==a.trim().indexOf("\x3c")?this.addText(a):this.addCode(a)},this):a.input?0===a.input.indexOf("http")&&this.loadFromUrl(a.input,b):c?(this.loadFromId(c[1]),this.setStorageSolution("voyant")):d?(this.githubDialogs.loadFileFromId(a.githubId),this.setStorageSolution("github")):
this.addNew();if(b){var e=this;Ext.defer(function(){e.runAll()},100)}},scope:this})},getBlock:function(a){a=a||0;var b=this.query("notebookcodeeditorwrapper"),c=this.getCurrentBlock().id,d=b.findIndex(function(a){return a.id==c});if(0>d+a||d+a>b.length-1)Ext.Msg.show({title:this.localize("error"),msg:this.localize("blockDoesNotExist"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});else return content=b[d+a].getContent(),content.input},addNew:function(){this.setMetadata(new Spyral.Metadata({title:"\x3ch1\x3eSpyral Notebook\x3c/h1\x3e"}));
this.addText("\x3cp\x3eThis is a Spyral Notebook, a dynamic document that combines writing, code and data in service of reading, analyzing and interpreting digital texts.\x3c/p\x3e\x3cp\x3eSpyral Notebooks are composed of text blocks (like this one) and code blocks (like the one below). You can \x3cspan class\x3d'marker'\x3eclick on the blocks to edit\x3c/span\x3e them and add new blocks by clicking add icon that appears in the left column when hovering over a block.\x3c/p\x3e");var a=this.addCode("");
Ext.defer(function(){a.run()},100,this)},clear:function(){this.setMetadata(new Spyral.Metadata);this.getComponent("cells").removeAll()},showSaveDialog:function(a){this.mask(this.localize("saving"));this.getMetadata().setDateNow("modified");var b=this.generateExportHtml(),c=this.getStorageSolution();"voyant"===c&&void 0!==this.getNotebookId()&&void 0!==this.voyantStorageDialogs.getAccessCode()?this.voyantStorageDialogs.doSave({notebookId:this.getNotebookId(),data:b,accessCode:this.voyantStorageDialogs.getAccessCode()}):
"github"===c?this.githubDialogs.showSave(b):this.voyantStorageDialogs.showSave(b,a?void 0:this.getNotebookId())},loadFromString:function(a){a=a.trim();if(0==a.indexOf("http"))this.loadFromUrl(a);else if(0==a.indexOf("{")){try{var b=JSON.parse(a)}catch(c){return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadJson")+"\x3cbr\x3e\x3cpre style\x3d'color: red'\x3e"+c+"\x3c/pre\x3e",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}if(!b.metadata||!b.blocks)return Ext.Msg.show({title:this.localize("error"),
msg:this.localize("cannotLoadJsonUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});b.blocks.forEach(function(a){Ext.isString(a)&&""!=a?this.addCode({input:a}):a.input&&("text"==a.type?this.addText(a):this.addCode(a))},this)}else if(/^[\w-_]+$/.test(a))this.loadFromId(a);else{if(0!==a.indexOf("\x3c")||-1==a.indexOf("spyral"))return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});this.loadFromHtmlString(a)}return!0},
loadFromId:function(a){this.mask(this.localize("loading"));var b=this;Spyral.Load.trombone({tool:"notebook.NotebookManager",action:"load",id:a,noCache:1}).then(function(a){b.unmask();b.loadFromString(a.notebook.data);a.notebook.id&&a.notebook.id!=b.getNotebookId()&&b.setNotebookId(a.notebook.id);b.setIsEdited(!1)}).catch(function(a){b.unmask()})},loadFromHtmlString:function(a){a=(new DOMParser).parseFromString(a,"text/html");this.loadFromDom(a)},loadFromDom:function(a){this.setMetadata(new Spyral.Metadata(a));
a.querySelectorAll("section.notebook-editor-wrapper").forEach(function(a){var b=a.classList;if(b.contains("notebooktexteditorwrapper"))b=a.querySelector(".notebook-text-editor").innerHTML,this.addText(b,void 0,a.id);else if(b.contains("notebookcodeeditorwrapper")){var d=a.querySelector(".notebook-code-editor-raw");b=/\beditor-mode-(\w+)\b/.exec(d.className)[1];d="javascript"==b?d.innerText:d.innerHTML;var e=a.querySelector(".notebook-code-results").innerHTML;this.addCode({input:d,output:e,mode:b},
void 0,a.id)}},this)},runUntil:function(a){var b=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(c){b.push(c);c.clearResults();if(a&&a==c)return!1},this);this._run(b)},runFrom:function(a){var b=[],c=!1;Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(d){a&&a==d&&(c=!0);c&&(b.push(d),d.clearResults())},this);this._run(b)},runAll:function(){var a=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(b){a.push(b);b.clearResults()},this);this._run(a)},_run:function(a){if(0<
a.length){var b=a.shift().run(!0);if(void 0!==b&&b.then&&b.catch&&b.finally){var c=this;b.then(function(){Ext.defer(c._run,100,c,[a])})}else Ext.defer(this._run,100,this,[a])}},loadFromUrl:function(a,b){var c=this;Spyral.Load.text(a).then(function(a){c.loadFromString(a)})},addText:function(a,b,c){return this._add(a,b,"notebooktexteditorwrapper",c)},addCode:function(a,b,c){return this._add(a,b,"notebookcodeeditorwrapper",c,{docs:this.spyralTernDocs})},_add:function(a,b,c,d,e){Ext.isString(a)&&(a={input:a});
var f=this.getComponent("cells");b="undefined"===typeof b?f.items.length:b;d="undefined"===typeof d?Spyral.Util.id():d;return f.insert(b,Ext.apply(a,{xtype:c,order:b,cellId:d},e))},updateMetadata:function(){this.getMetadata();this.getComponent("spyralHeader").update(this.getInnerHeaderHtml());this.getComponent("spyralFooter").update(this.getInnerFooterHtml())},notebookWrapperMoveUp:function(a){var b=this.getComponent("cells");a=b.items.findIndex("id",a.id);0==a?Ext.Msg.show({title:this.localize("error"),
msg:this.localize("cannotMoveHigher"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING}):(b.move(a,a-1),this.redoOrder())},notebookWrapperMoveDown:function(a){var b=this.getComponent("cells");a=b.items.findIndex("id",a.id);a==b.items.getCount()-1?Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotMoveLower"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING}):(b.move(a,a+1),this.redoOrder())},notebookWrapperRemove:function(a){var b=this.getComponent("cells");b.remove(a);
0==b.items.length&&this.addText("(Click to edit).");this.redoOrder()},notebookWrapperAdd:function(a,b){var c=this.getComponent("cells").items.findIndex("id",a.id);a=a.getXType(a);("notebooktexteditorwrapper"==a&&!b.hasModifier()||"notebookcodeeditorwrapper"==a&&b.hasModifier()?this.addCode("",c+1):this.addText("",c+1)).getTargetEl().scrollIntoView(this.getTargetEl(),null,!0,!0);this.redoOrder()},redoOrder:function(){this.query("notebookwrappercounter").forEach(function(a,b){a.setOrder(b)});this.setIsEdited(!0)},
setIsEdited:function(a){this.getHeader()&&(this.getHeader().down("#saveItTool").setDisabled(0==a),a||(this.query("notebookcodeeditor").forEach(function(a){a.setIsChangeRegistered(!1)}),this.query("notebooktexteditor").forEach(function(a){a.setIsEditRegistered(!1)})));this.callParent(arguments)},setNotebookId:function(a){if(a&&-1===location.pathname.indexOf("/spyral/"+a)){var b=this.getBaseUrl()+"spyral/"+a+"/";window.history.pushState({url:b},"Spyral Notebook: "+a,b)}this.callParent(arguments)},generateExportHtml:function(){var a=
"\x3c!DOCTYPE HTML\x3e\n\x3chtml\x3e\n\x3chead\x3e\n\t\x3cmeta charset\x3d'UTF-8'\x3e\n"+this.getMetadata().getHeaders(),b=document.getElementById("ace-chrome");b&&(a+=b.outerHTML+"\n");a+=document.getElementById("voyant-notebooks-styles").outerHTML+"\n\x3cscript\x3e // this script checks to see if embedded tools seem to be available\nwindow.addEventListener('load', function() {\nvar hostnames \x3d {}, warned \x3d false;\ndocument.querySelectorAll('iframe').forEach(function(iframeEl) {\nlet url \x3d new URL(iframeEl.src);\nif (!(url.hostname in hostnames) \x26\x26 !warned) {\nhostnames[url.hostname] \x3d true; // mark as fetched\nfetch(url).catch(response \x3d\x3e {\nwarned \x3d true;\nalert('This notebook seems to contain one ore more tools that may not be able to load. Possible reasons include a server no longer being accessible (especially if the notebook was generated from a local server), or because of security restrictions.'+url)\n})\n}\n})\n})\n\x3c/script\x3e\n\x3c/head\x3e\n\x3cbody class\x3d'exported-notebook'\x3e"+
this.getHeaderHtml()+"\x3carticle class\x3d'spyralArticle'\x3e";this.getComponent("cells").items.each(function(b,d){type=b.isXType("notebookcodeeditorwrapper")?"code":"text";content=b.getContent();d=b.down("notebookwrappercounter");a+="\x3csection id\x3d'"+d.name+"' class\x3d'notebook-editor-wrapper "+b.xtype+"'\x3e\n\x3cdiv class\x3d'notebookwrappercounter'\x3e"+d.getTargetEl().dom.innerHTML+"\x3c/div\x3e";"code"==type?(d=b.down("notebookcodeeditor").getMode(),d=d.substring(d.lastIndexOf("/")+1),
a+="\x3cdiv class\x3d'notebook-code-editor ace-chrome'\x3e\n"+b.getTargetEl().query(".ace_text-layer")[0].outerHTML+"\n\x3c/div\x3e\n\x3cpre class\x3d'notebook-code-editor-raw editor-mode-"+d+"'\x3e\n"+content.input+"\x3c/pre\x3e\n\x3cdiv class\x3d'notebook-code-results'\x3e\n"+content.output+"\n\x3c/div\x3e\n"):a+="\x3cdiv class\x3d'notebook-text-editor'\x3e"+content+"\x3c/div\x3e\n";a+="\x3c/section\x3e\n"});return a+="\x3c/article\x3e\n\x3cfooter class\x3d'spyral-footer'\x3e"+this.getInnerFooterHtml()+
"\x3c/footer\x3e\x3c/body\x3e\n\x3c/html\x3e"},getHeaderHtml:function(){return"\x3cheader class\x3d'spyral-header'\x3e"+this.getInnerHeaderHtml()+"\x3c/header\x3e\n"},getInnerHeaderHtml:function(){var a="";this.getMetadata().title&&(a+="\x3cdiv class\x3d'title'\x3e"+this.getMetadata().title+"\x3c/div\x3e");this.getMetadata().author&&(a+="\x3cdiv class\x3d'author'\x3e"+this.getMetadata().author+"\x3c/div\x3e");return a},getInnerFooterHtml:function(){var a="",b=this.getMetadata();if(b.author||b.license)a=
"\x26copy;",b.author&&(a+=" "+b.author),b.license&&(a+=" ("+b.license+")"),a+=". ";if(b.created||b.modified){var c=b.shortDate("created");b=b.shortDate("modified");c&&(a+=this.localize("created")+" "+c+".");b&&c!=b&&(a+=this.localize("modified")+" "+b+".")}return a},getExtraExportItems:function(){return[{inputValue:"html",boxLabel:this.localize("exportHtml")},{inputValue:"htmlDownload",boxLabel:'\x3ca href\x3d"#"\x3e'+this.localize("exportHtmlDownload")+"\x3c/a\x3e",listeners:{afterrender:function(a){var b=
(this.getNotebookId()||"spyral")+".html",c=this.generateExportHtml(),d={type:"text/html"};try{var e=new File([c],b,d)}catch(f){e=new Blob([c],d)}e=URL.createObjectURL(e);a=a.boxLabelEl.dom.querySelector("a");a.setAttribute("download",b);a.setAttribute("href",e)},scope:this},handler:function(a){a.boxLabelEl.dom.querySelector("a").click();a.up("window").close()}}]},exportHtml:function(){var a=this.generateExportHtml(),b=window.open();b.document.write(a);b.document.close();b.focus()},exportHtmlDownload:function(){var a=
this.generateExportHtml(),b={type:"text/plain"};try{var c=new File([a],"files.txt",b)}catch(d){c=new Blob([a],b)}c=URL.createObjectURL(c);this.getApplication().openUrl(c)},getExportUrl:function(a){return location.href},showMetadataEditor:function(){var a=this,b=this.getMetadata();Ext.create("Ext.window.Window",{title:this.localize("metadataEditor"),autoScroll:!0,items:[{xtype:"form",items:{bodyPadding:5,width:600,layout:"anchor",defaults:{anchor:"100%",labelAlign:"right"},defaultType:"textfield",
items:[{fieldLabel:this.localize("metadataTitle"),xtype:"htmleditor",name:"title",value:b.title,height:100,enableAlignments:!1,enableColors:!1,enableFont:!1,enableFontSize:!1,enableLinks:!1,enableLists:!1},{fieldLabel:this.localize("metadataAuthor"),name:"author",value:b.author},{fieldLabel:this.localize("metadataKeywords"),name:"keywords",value:b.keywords},{xtype:"htmleditor",fieldLabel:this.localize("metadataDescription"),name:"description",height:100,value:b.description,enableAlignments:!1,enableColors:!1,
enableFont:!1},{xtype:"combo",fieldLabel:this.localize("metadataLicense"),name:"license",value:b.license||"Creative Commons Attribution (CC BY)",store:{fields:["text"],data:[{text:"Apache License 2.0"},{text:'BSD 3-Clause "New" or "Revised" license'},{text:'BSD 2-Clause "Simplified" or "FreeBSD" license'},{text:"Creative Commons Attribution (CC BY)"},{text:"Creative Commons Attribution-ShareAlike (CC BY-SA)"},{text:"Creative Commons Zero (CC0)"},{text:"GNU General Public License (GPL)"},{text:'GNU Library or "Lesser" General Public License (LGPL)'},
{text:"MIT license"},{text:"Mozilla Public License 2.0"},{text:"Common Development and Distribution License"},{text:"Eclipse Public License"}]}},{xtype:"combo",name:"language",value:b.language||"English",fieldLabel:this.localize("metadataLanguage"),store:{fields:["text"],data:[{text:"Bengali"},{text:"Bhojpuri"},{text:"Egyptian Arabic"},{text:"English"},{text:"French"},{text:"German"},{text:"Gujarati"},{text:"Hausa"},{text:"Hindi"},{text:"Indonesian"},{text:"Italian"},{text:"Japanese"},{text:"Javanese"},
{text:"Kannada"},{text:"Korean"},{text:"Mandarin"},{text:"Marathi"},{text:"Persian"},{text:"Portuguese"},{text:"Russian"},{text:"Southern Min"},{text:"Spanish"},{text:"Standard Arabic"},{text:"Swahili"},{text:"Tamil"},{text:"Telugu"},{text:"Thai"},{text:"Turkish"},{text:"Urdu"},{text:"Vietnamese"},{text:"Western Punjabi"},{text:"Wu Chinese"},{text:"Yue Chinese"}]}}]}}],buttons:[{text:this.localize("metadataCancel"),ui:"default-toolbar",handler:function(){this.up("window").close()}},{text:this.localize("metadataReset"),
ui:"default-toolbar",handler:function(){this.up("window").down("form").getForm().reset()}}," ",{text:this.localize("metadataSave"),handler:function(){var c=this.up("window").down("form").getForm();b.set(c.getValues());a.updateMetadata();this.up("window").close()}}]}).show()},showOptionsClick:function(a){void 0===a.optionsWin&&(a.optionsWin=Ext.create("Ext.window.Window",{title:a.localize("gearWinTitle"),closeAction:"hide",layout:"fit",width:400,height:300,bodyPadding:10,items:{xtype:"form",items:[{xtype:"radiogroup",
fieldLabel:"Storage Solution",labelAlign:"left",layout:"vbox",items:[{boxLabel:"Voyant",name:"storageSolution",inputValue:"voyant",checked:"voyant"===a.getStorageSolution()},{boxLabel:"GitHub",name:"storageSolution",inputValue:"github",checked:"github"===a.getStorageSolution()}]}]},buttons:[{text:a.localize("ok"),handler:function(b,c){b=b.findParentByType("window");c=b.down("form");c.isValid()?(c=c.getValues(),a.setStorageSolution(c.storageSolution),b.hide()):a.showError({message:a.localize("invalidForm")})}},
{text:a.localize("cancel"),handler:function(a,c){a.findParentByType("window").hide()}}]}));a.optionsWin.show()}});Ext.define("Voyant.VoyantApp",{extend:"Ext.app.Application",mixins:["Voyant.util.Deferrable","Voyant.util.Localization","Voyant.util.Api","Voyant.util.Colors"],requires:["Voyant.util.ResponseError"],name:"VoyantApp",statics:{i18n:{},api:{palette:"default",categories:"auto",lang:void 0,debug:void 0}},config:{baseUrl:void 0,tromboneUrl:void 0},constructor:function(a){this.setBaseUrl(this.config.baseUrl);this.setTromboneUrl(this.config.baseUrl+"trombone");Voyant.application=this;this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);this.mixins["Voyant.util.Colors"].constructor.apply(this,arguments);Object.assign(this,Spyral.CategoriesManager);this.addFeature("color");this.addFeature("font",'"Palatino Linotype", "Book Antiqua", Palatino, serif');this.callParent(arguments);var b=this.getColor;this.getColor=function(a,c){return b.apply(this,[this.getApiParam("palette"),a,c])};var c=this.getColorForTerm;this.getColorForTerm=function(a,b){return c.apply(this,[this.getApiParam("palette"),a,b])}},getBaseUrl:function(){var a=
this.callParent();return 0==a.indexOf("//")?location.protocol+a:a},getBaseUrlFull:function(){return window.location.origin+this.getBaseUrl()},getRelativeUrl:function(){for(var a="",b=0,c=window.location.pathname.substring(this.getBaseUrl().length).split("/").length-1;b<c;b++)a+="../";return a},getTools:function(){return[{type:"maximize"},{type:"help"}]},launch:function(){Ext.tip.QuickTipManager.init();Ext.apply(Ext.tip.QuickTipManager.getQuickTip(),{showDelay:50});this.callParent(arguments)},tromboneCall:function(a){a=
a?a:{};Ext.applyIf(a,{url:this.getTromboneUrl()});a.success||a.failure||a.callback||Ext.applyIf(a,{url:this.getTromboneUrl(),scope:this,callback:function(b,c,d){this.dispatchEvent(a.tool+"Loaded",b,c,d)}});Ext.Ajax.request(a)},getViewport:function(){return Ext.ComponentQuery.query("viewport")[0]},dispatchEvent:function(a,b){var c=this.getViewport().query("panel,chart"),d=!1;this.hasListener&&this.hasListener(a)&&(this.fireEvent.apply(this,arguments),d=!0);for(var e=0;e<c.length;e++)!c[e].hasListener||
!c[e].hasListener(a)||b&&b.getId&&c[e].getId&&b.getId()==c[e].getId()||(d=!0,c[e].fireEvent.apply(c[e],arguments));if(!d){c=["unhandledEvent",b,a];for(e=2;e<arguments.length;e++)c.push(arguments[e]);this.fireEvent.apply(this,c)}},showResponseError:function(a,b){this.showError(Ext.create("Voyant.util.ResponseError",{msg:Ext.isString(a)?a:a.msg,response:b}))},showError:function(a,b){if(a instanceof Voyant.util.ResponseError)a={message:a.getMsg()+"\x3cp class\x3d'error'\x3e\n"+a.getError()+" \u2026 \x3ca href\x3d'#' onclick\x3d\"window.open('').document.write(unescape('\x3cpre\x3e"+
escape(a.getDetails())+"\x3c/pre\x3e')); return false;\"\x3emore\x3c/a\x3e\x3c/p\x3e"};else if(Ext.isString(a))a={message:a};else if(Ext.isObject(a)&&(a.responseText||a.statusText))return this.showResponseError(a.statusText,a);Ext.applyIf(a,{title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)},getToolConfigFromToolXtype:function(a){cls=Ext.ClassManager.getByAlias("widget."+a);return{xtype:a,title:this._localizeClass(cls,"title"),tooltip:{text:this._localizeClass(cls,
"helpTip")},glyph:cls&&cls.glyph?cls.glyph:"xf12e@FontAwesome"}},openUrl:function(a){window.open(a)||Ext.Msg.show({title:"Popup Blocked",buttonText:{ok:"Close"},icon:Ext.MessageBox.INFO,message:"A popup window was blocked. \x3ca href\x3d'"+a+"' target\x3d'_blank' class\x3d'link'\x3eClick here\x3c/a\x3e to open the new window.",buttons:Ext.Msg.OK})}});Ext.define("Voyant.VoyantCorpusApp",{extend:"Voyant.VoyantApp",name:"VoyantCorpusApp",requires:"Voyant.panel.CorpusSet Voyant.data.model.Corpus Voyant.panel.VoyantHeader Voyant.panel.VoyantFooter Voyant.panel.CorpusCreator Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.DreamScape Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.Phrases Voyant.panel.ScatterPlot Voyant.panel.TopicContexts Voyant.panel.TermsRadio Voyant.panel.TermsBerry".split(" "),
statics:{i18n:{},api:{toolFlow:void 0}},constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},config:{corpus:void 0,corpusAccess:void 0,moreTools:[{i18n:"moreToolsScaleCorpus",glyph:"xf065@FontAwesome",items:"cirrus corpusterms bubblelines correlations corpuscollocates dreamscape loom mandala microsearch streamgraph phrases documents summary trends scatterplot termsradio topics veliza wordtree".split(" ")},{i18n:"moreToolsScaleDocument",
glyph:"xf066@FontAwesome",items:"bubbles cirrus contexts documentterms reader textualarc trends knots topics".split(" ")},{i18n:"moreToolsTypeViz",glyph:"xf06e@FontAwesome",items:"cirrus bubblelines bubbles collocatesgraph dreamscape loom knots mandala microsearch streamgraph scatterplot textualarc trends termsberry termsradio wordtree".split(" ")},{i18n:"moreToolsTypeGrid",glyph:"xf0ce@FontAwesome",items:"corpusterms corpuscollocates correlations phrases contexts documentterms documents topics".split(" ")},
{i18n:"moreToolsTypeOther",glyph:"xf035@FontAwesome",items:["reader","summary","veliza"]}]},launch:function(a){this.callParent(arguments);if(this.hasQueryToLoad()){var b=Ext.Object.fromQueryString(document.location.search);!b.corpus&&this.getCorpusId&&this.getCorpusId()&&(b.corpus=this.getCorpusId());a&&a.useCache&&(b.useCache=a.useCache);this.loadCorpusFromParams(b);if(b.palette)if(-1<b.palette.indexOf(",")){var c=Ext.decode(b.palette);this.addColorPalette(b.palette,c)}else this.loadColorPaletteForCorpus(b.corpus,
b.palette)}else(b=this.getViewport())&&(b=b.down("corpuscreator"))&&b.toastInfo({html:this.localize("didYouKnowText"),title:this.localize("didYouKnow"),anchor:b.down("textareafield"),align:"tr",listeners:{beforeclose:{fn:function(){this.getHeader().getTools().forEach(function(a){"gear"!=a.type&&"help"!=a.type||a.getEl().frame("#ff0000",1,{duration:3E3})})},scope:b}}})},loadCorpusFromParams:function(a){var b=this,c=b.getViewport();c.mask(this.localize("fetchingCorpus"));a.archive&&(Ext.isString(a.archive)&&
(a.archive=[a.archive]),a.archive=a.archive.map(function(a){return a.replace("/blogs.sub.uni-hamburg.de/hup/lhn/","/wikis.sub.uni-hamburg.de/lhn/index.php/").replace("/hup.sub.uni-hamburg.de/","/wikis.sub.uni-hamburg.de/")}));this.validateCorpusLoadParams(a);(new Voyant.data.model.Corpus(a)).then(function(a){c.unmask();b.setCorpus(a);b.validateCorpusAccess()&&b.dispatchEvent("loadedCorpus",this,a)}).otherwise(function(){c.unmask()})},validateCorpusLoadParams:function(a){},validateCorpusAccess:function(){var a=
this,b=a.getViewport(),c=this.getCorpus();if(c&&c.requiresPassword()&&!a.getViewport().query("panel").every(function(a){return!a.isConsumptive})){var d=c.getNoPasswordAccess(),e=Ext.create("Ext.window.Window",{title:a.localize("passwordRequiredTitle"),layout:"fit",items:{padding:10,flex:1,width:300,layout:{type:"vbox",align:"stretch"},items:[{html:"\x3cp\x3e"+a.localize("passwordRequiredMessage")+"\x3c/p\x3e"+("NONCONSUMPTIVE"==d?"\x3cp\x3e"+a.localize("nonConsumptiveMessage")+"\x3c/p\x3e":"")+"\x3c/p\x3e"},
{xtype:"textfield",fieldLabel:a.localize("password")}],bbar:{layout:{pack:"center"},items:[{text:a.localize("passwordValidateButton"),ui:"default",handler:function(){var d=e.query("textfield")[0].getValue().trim();0==d.length?a.showError({message:a.localize("noPasswordGiven")}):(e.mask(),Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSession:d},method:"POST",success:function(d,f){e.unmask();d=d.responseText;"ADMIN"==d||"ACCESS"==d?(e.close(),b.unmask(),a.setCorpusAccess(d),
a.dispatchEvent("loadedCorpus",this,c)):a.showError({message:a.localize("badPassword")})},failure:function(b,c){e.unmask();a.showError({message:a.localize("passwordValidationError")})}}))}},{text:a.localize("nonConsumptiveButton"),hidden:"NONE"==c.getNoPasswordAccess(),handler:function(){e.mask();Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSessionRemove:!0},method:"POST",callback:function(d,g){e.unmask();e.close();b.unmask();a.dispatchEvent("loadedCorpus",a,c)}})}}]}}}).show();
return!1}return!0},hasQueryToLoad:function(a){a||(a=Ext.Object.fromQueryString(document.location.search));return a.corpus||a.input||this.getCorpusId&&this.getCorpusId()},loadColorPaletteForCorpus:function(a,b){Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:b,corpus:a},success:function(a,d){a=Ext.util.JSON.decode(a.responseText).storedResource.resource;a=Ext.decode(a);this.addColorPalette(b,a)},failure:function(a){this.setApiParam("palette",void 0)},
scope:this})},listeners:{loadedCorpus:function(a,b){this.setCorpus(b);this.getApiParam("categories")&&this.loadCategoryData(this.getApiParam("categories")).then(function(a,b,e){for(var c in this.getCategories())if(a=this.getCategoryFeature(c,"color"),void 0!==a)for(a=this.hexToRgb(a),b=this.getCategoryTerms(c),e=0;e<b.length;e++)this.setColorForTerm(b[e],a)},null,null,this);this.on("unhandledEvent",function(a,d,e){a=this.getBaseUrl()+"?corpus\x3d"+b.getAliasOrId();var c=this.getModifiedApiParams()||
{};delete c.view;if("termsClicked"==d)if(Ext.isArray(e)&&"term"in e[0]&&"docIndex"in e[0]){var g={},k={};e.forEach(function(a){g[a.term]=!0;k[a.docIndex]=!0});c.query=Object.keys(g);c.docIndex=Object.keys(k)}else c.query=e;else if("documentsClicked"==d){var h=[];e.forEach&&e.forEach(function(a){h.push(a.getIndex())});c.docIndex=h}else if("corpusTermsClicked"==d)e.map&&(c.query=e.map(function(a){return a.getTerm()}));else if("documentTermsClicked"==d)e.map&&(c.query=e.map(function(a){return a.getTerm()}),
c.docIndex=e.map(function(a){return a.getDocIndex()}));else{console&&console.warn("Unhandled event: "+d,e);return}c.toolFlow&&(d=Ext.Array.from(c.toolFlow.split(",")),c.view=d.shift(),0<d.length?c.toolFlow=d.join(","):delete c.toolFlow);a+="\x26"+Ext.Object.toQueryString(c);this.openUrl(a)})}}});Ext.define("Voyant.panel.DocumentClusters",{extend:"Ext.panel.Panel",alias:"widget.documentclusters",title:"Document Clusters"});
Ext.define("Voyant.VoyantCorpusToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantCorpusToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:!0,items:[{xtype:"cirrus",collapsible:!0},{xtype:"corpusterms",collapsible:!0},{xtype:"documents",collapsible:!0},{xtype:"rezoviz",collapsible:!0},{xtype:"trends",
collapsible:!0},{xtype:"documentclusters",collapsible:!0}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantDefaultApp",{extend:"Voyant.VoyantCorpusApp",mixins:["Voyant.util.Api"],name:"VoyantDefaultApp",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},statics:{i18n:{},api:{view:"corpusset",stopList:"auto",panels:void 0,rtl:void 0}},listeners:{loadedCorpus:function(a,b){this.viewport.down("voyantheader").collapse();this.viewport.down("#toolsContainer").setActiveItem(1);a=this.getCorpusId&&this.getCorpusId()?this.getCorpusId():
void 0;if(window.history.pushState&&!a){a=b.getAliasOrId();b=Ext.Object.fromQueryString(document.location.search);var c=this.getBaseUrl()+"?corpus\x3d"+a,d;for(d in b)if("corpus"!==d){var e=Ext.isString(b[d])?[b[d]]:b[d];Ext.isArray(e)&&e.forEach(function(a){c+="\x26"+d+"\x3d"+a})}window.history.pushState({corpus:a},"Corpus: "+a,c)}}},getViewComponent:function(){return this.viewport.down("#toolsContainer-main")},launch:function(){var a=Ext.Object.fromQueryString(document.location.search)||{},b=this.getApiParam("view",
"CorpusSet"),c=b.toLowerCase();if(!Ext.ClassManager.getByAlias("widget."+c)||a.noskin)Ext.Msg.show({title:this.localize("noViewErrorTitle"),message:(new Ext.Template(this.localize(a.noskin?"noViewKnownErrorTpl":"noViewErrorTpl"))).apply({view:a.noskin?a.noskin:b,additional:a.noskin&&"convert"==a.noskin?this.localize(a.noskin+"SkinMsg"):""}),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),c="corpusset";this.viewport=Ext.create("Ext.container.Viewport",{layout:"border",rtl:void 0!==this.getApiParam("rtl")||
"ar"==Voyant.util.Localization.LANGUAGE||"he"==Voyant.util.Localization.LANGUAGE,items:[{xtype:"voyantheader",region:"north"},{region:"south",xtype:"voyantfooter"},{region:"center",layout:"card",itemId:"toolsContainer",activeItem:0,items:[{xtype:"container",layout:{type:"vbox",pack:"center",align:"center"},items:[{xtype:"corpuscreator"},{xtype:"container",width:800,html:"\x3cdiv id\x3d'voyantIs' style\x3d'font-style: italic; text-align: center; margin-top: 10px;'\x3e\x3cdiv\x3e"+this.localize("voyantIs")+
"\x3c/div\x3e"+(-1==this.localize("translatedBy").indexOf("English")?"\x3cdiv\x3e"+this.localize("translatedBy")+"\x3c/div\x3e":"")+(this.getCorpusCreatorText&&0<this.getCorpusCreatorText().trim().length?"\x3cdiv id\x3d'corpusCreatorText'\x3e"+this.getCorpusCreatorText()+"\x3c/div\x3e":"")}]},{layout:"fit",itemId:"toolsContainer-main",items:{xtype:c}}]}]});this.callParent(arguments)}});Ext.define("Voyant.panel.MoreLikeThis",{extend:"Ext.panel.Panel",alias:"widget.morelikethis",title:"More Like this"});
Ext.define("Voyant.VoyantDocumentToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantDocumentToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:!0,items:[{xtype:"cirrus",collapsible:!0},{xtype:"documentterms",collapsible:!0},{xtype:"contexts",collapsible:!0},{xtype:"collocatesgraph",collapsible:!0},
{xtype:"trends",collapsible:!0},{xtype:"morelikethis",collapsible:!0}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantNotebookApp",{extend:"Voyant.VoyantApp",requires:["Voyant.panel.VoyantFooter","Voyant.notebook.Notebook","Voyant.data.model.Corpus","Voyant.notebook.util.Show"],name:"VoyantNotebookApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{xtype:"notebook",region:"center"},{xtype:"voyantfooter",region:"south"}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantToolApp",{extend:"Voyant.VoyantCorpusApp",name:"VoyantToolApp",statics:{api:{minimal:void 0,embeddedApiId:void 0}},launch:function(){var a=[],b=this;this.getApiParam("minimal")||a.push({region:"south",xtype:"voyantfooter"});a.push({region:"center",layout:"fit",itemId:"toolcontainer",items:{xtype:this.getApiParam("embeddedApiId")?"container":this.getTool()},listeners:{afterrender:function(a){if(b.getApiParam("embeddedApiId")){var c=b.getDeferred(this);a.mask(this.localize("loadingConfiguration"));
Ext.Ajax.request({url:b.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("embeddedApiId")}}).then(function(d){c.resolve();d=Ext.util.JSON.decode(d.responseText);d=decodeURIComponent(d.storedResource.resource);d=Ext.decode(d);var e=Ext.create({xtype:b.getTool()});e.setApiParams(d);a.unmask();a.remove(a.down("container"));a.add(e);d.corpus&&b.loadCorpusFromParams(d)}).otherwise(function(a){b.getTargetEl&&(Voyant.notebook.util.Show.TARGET=b.getTargetEl(),showError(a));
Voyant.application.showError(a);c.reject()})}},scope:this}});Ext.create("Ext.container.Viewport",{layout:"border",items:a});this.callParent(arguments)}});
//# sourceMappingURL=voyant.min.map.js