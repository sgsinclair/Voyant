/* generated: Mon, 08 Feb 2021 19:58:02 GMT */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(a){return a.raw=a};$jscomp.createTemplateTagFirstArgWithRaw=function(a,b){a.raw=b;return a};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
$jscomp.getGlobal=function(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(a,b){var c=$jscomp.propertyToPolyfillSymbol[b];if(null==c)return a[b];c=a[c];return void 0!==c?c:a[b]};$jscomp.polyfill=function(a,b,c,d){b&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(a,b,c,d):$jscomp.polyfillUnisolated(a,b,c,d))};
$jscomp.polyfillUnisolated=function(a,b,c,d){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))return;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})};
$jscomp.polyfillIsolated=function(a,b,c,d){var e=a.split(".");a=1===e.length;d=e[0];d=!a&&d in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var f=0;f<e.length-1;f++){var g=e[f];if(!(g in d))return;d=d[g]}e=e[e.length-1];c=$jscomp.IS_SYMBOL_NATIVE&&"es6"===c?d[e]:null;b=b(c);null!=b&&(a?$jscomp.defineProperty($jscomp.polyfills,e,{configurable:!0,writable:!0,value:b}):b!==c&&(void 0===$jscomp.propertyToPolyfillSymbol[e]&&($jscomp.propertyToPolyfillSymbol[e]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(e):
$jscomp.POLYFILL_PREFIX+e),e=$jscomp.propertyToPolyfillSymbol[e],$jscomp.defineProperty(d,e,{configurable:!0,writable:!0,value:b})))};$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.generator={};$jscomp.generator.ensureIteratorResultIsObject_=function(a){if(!(a instanceof Object))throw new TypeError("Iterator result "+a+" is not an object");};$jscomp.generator.Context=function(){this.isRunning_=!1;this.yieldAllIterator_=null;this.yieldResult=void 0;this.nextAddress=1;this.finallyAddress_=this.catchAddress_=0;this.finallyContexts_=this.abruptCompletion_=null};
$jscomp.generator.Context.prototype.start_=function(){if(this.isRunning_)throw new TypeError("Generator is already running");this.isRunning_=!0};$jscomp.generator.Context.prototype.stop_=function(){this.isRunning_=!1};$jscomp.generator.Context.prototype.jumpToErrorHandler_=function(){this.nextAddress=this.catchAddress_||this.finallyAddress_};$jscomp.generator.Context.prototype.next_=function(a){this.yieldResult=a};
$jscomp.generator.Context.prototype.throw_=function(a){this.abruptCompletion_={exception:a,isException:!0};this.jumpToErrorHandler_()};$jscomp.generator.Context.prototype.return=function(a){this.abruptCompletion_={return:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.jumpThroughFinallyBlocks=function(a){this.abruptCompletion_={jumpTo:a};this.nextAddress=this.finallyAddress_};$jscomp.generator.Context.prototype.yield=function(a,b){this.nextAddress=b;return{value:a}};
$jscomp.generator.Context.prototype.yieldAll=function(a,b){a=$jscomp.makeIterator(a);var c=a.next();$jscomp.generator.ensureIteratorResultIsObject_(c);if(c.done)this.yieldResult=c.value,this.nextAddress=b;else return this.yieldAllIterator_=a,this.yield(c.value,b)};$jscomp.generator.Context.prototype.jumpTo=function(a){this.nextAddress=a};$jscomp.generator.Context.prototype.jumpToEnd=function(){this.nextAddress=0};
$jscomp.generator.Context.prototype.setCatchFinallyBlocks=function(a,b){this.catchAddress_=a;void 0!=b&&(this.finallyAddress_=b)};$jscomp.generator.Context.prototype.setFinallyBlock=function(a){this.catchAddress_=0;this.finallyAddress_=a||0};$jscomp.generator.Context.prototype.leaveTryBlock=function(a,b){this.nextAddress=a;this.catchAddress_=b||0};
$jscomp.generator.Context.prototype.enterCatchBlock=function(a){this.catchAddress_=a||0;a=this.abruptCompletion_.exception;this.abruptCompletion_=null;return a};$jscomp.generator.Context.prototype.enterFinallyBlock=function(a,b,c){c?this.finallyContexts_[c]=this.abruptCompletion_:this.finallyContexts_=[this.abruptCompletion_];this.catchAddress_=a||0;this.finallyAddress_=b||0};
$jscomp.generator.Context.prototype.leaveFinallyBlock=function(a,b){b=this.finallyContexts_.splice(b||0)[0];if(b=this.abruptCompletion_=this.abruptCompletion_||b){if(b.isException)return this.jumpToErrorHandler_();void 0!=b.jumpTo&&this.finallyAddress_<b.jumpTo?(this.nextAddress=b.jumpTo,this.abruptCompletion_=null):this.nextAddress=this.finallyAddress_}else this.nextAddress=a};$jscomp.generator.Context.prototype.forIn=function(a){return new $jscomp.generator.Context.PropertyIterator(a)};
$jscomp.generator.Context.PropertyIterator=function(a){this.object_=a;this.properties_=[];for(var b in a)this.properties_.push(b);this.properties_.reverse()};$jscomp.generator.Context.PropertyIterator.prototype.getNext=function(){for(;0<this.properties_.length;){var a=this.properties_.pop();if(a in this.object_)return a}return null};$jscomp.generator.Engine_=function(a){this.context_=new $jscomp.generator.Context;this.program_=a};
$jscomp.generator.Engine_.prototype.next_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_.next,a,this.context_.next_);this.context_.next_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.return_=function(a){this.context_.start_();var b=this.context_.yieldAllIterator_;if(b)return this.yieldAllStep_("return"in b?b["return"]:function(c){return{value:c,done:!0}},a,this.context_.return);this.context_.return(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.throw_=function(a){this.context_.start_();if(this.context_.yieldAllIterator_)return this.yieldAllStep_(this.context_.yieldAllIterator_["throw"],a,this.context_.next_);this.context_.throw_(a);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.yieldAllStep_=function(a,b,c){try{var d=a.call(this.context_.yieldAllIterator_,b);$jscomp.generator.ensureIteratorResultIsObject_(d);if(!d.done)return this.context_.stop_(),d;var e=d.value}catch(f){return this.context_.yieldAllIterator_=null,this.context_.throw_(f),this.nextStep_()}this.context_.yieldAllIterator_=null;c.call(this.context_,e);return this.nextStep_()};
$jscomp.generator.Engine_.prototype.nextStep_=function(){for(;this.context_.nextAddress;)try{var a=this.program_(this.context_);if(a)return this.context_.stop_(),{value:a.value,done:!1}}catch(b){this.context_.yieldResult=void 0,this.context_.throw_(b)}this.context_.stop_();if(this.context_.abruptCompletion_){a=this.context_.abruptCompletion_;this.context_.abruptCompletion_=null;if(a.isException)throw a.exception;return{value:a.return,done:!0}}return{value:void 0,done:!0}};
$jscomp.generator.Generator_=function(a){this.next=function(b){return a.next_(b)};this.throw=function(b){return a.throw_(b)};this.return=function(b){return a.return_(b)};this[Symbol.iterator]=function(){return this}};$jscomp.generator.createGenerator=function(a,b){b=new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(b));$jscomp.setPrototypeOf&&a.prototype&&$jscomp.setPrototypeOf(b,a.prototype);return b};
$jscomp.asyncExecutePromiseGenerator=function(a){function b(d){return a.next(d)}function c(d){return a.throw(d)}return new Promise(function(d,e){function f(g){g.done?d(g.value):Promise.resolve(g.value).then(b,c).then(f,e)}f(a.next())})};$jscomp.asyncExecutePromiseGeneratorFunction=function(a){return $jscomp.asyncExecutePromiseGenerator(a())};$jscomp.asyncExecutePromiseGeneratorProgram=function(a){return $jscomp.asyncExecutePromiseGenerator(new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(a)))};
$jscomp.initSymbol=function(){};$jscomp.polyfill("Symbol",function(a){if(a)return a;var b=function(e,f){this.$jscomp$symbol$id_=e;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:f})};b.prototype.toString=function(){return this.$jscomp$symbol$id_};var c=0,d=function(e){if(this instanceof d)throw new TypeError("Symbol is not a constructor");return new b("jscomp_symbol_"+(e||"")+"_"+c++,e)};return d},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(a){if(a)return a;a=Symbol("Symbol.iterator");for(var b="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),c=0;c<b.length;c++){var d=$jscomp.global[b[c]];"function"===typeof d&&"function"!=typeof d.prototype[a]&&$jscomp.defineProperty(d.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return a},"es6",
"es3");$jscomp.iteratorPrototype=function(a){a={next:a};a[Symbol.iterator]=function(){return this};return a};
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(g){return g instanceof e?g:new e(function(h,k){h(g)})}if(a&&(!($jscomp.FORCE_POLYFILL_PROMISE||$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION&&"undefined"===typeof $jscomp.global.PromiseRejectionEvent)||!$jscomp.global.Promise||-1===$jscomp.global.Promise.toString().indexOf("[native code]")))return a;b.prototype.asyncExecute=function(g){if(null==this.batch_){this.batch_=[];var h=this;this.asyncExecuteFunction(function(){h.executeBatch_()})}this.batch_.push(g)};
var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(g){d(g,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var g=this.batch_;this.batch_=[];for(var h=0;h<g.length;++h){var k=g[h];g[h]=null;try{k()}catch(l){this.asyncThrow_(l)}}}this.batch_=null};b.prototype.asyncThrow_=function(g){this.asyncExecuteFunction(function(){throw g;})};var e=function(g){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];this.isRejectionHandled_=!1;var h=this.createResolveAndReject_();
try{g(h.resolve,h.reject)}catch(k){h.reject(k)}};e.prototype.createResolveAndReject_=function(){function g(l){return function(m){k||(k=!0,l.call(h,m))}}var h=this,k=!1;return{resolve:g(this.resolveTo_),reject:g(this.reject_)}};e.prototype.resolveTo_=function(g){if(g===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(g instanceof e)this.settleSameAsPromise_(g);else{a:switch(typeof g){case "object":var h=null!=g;break a;case "function":h=!0;break a;default:h=!1}h?this.resolveToNonPromiseObj_(g):
this.fulfill_(g)}};e.prototype.resolveToNonPromiseObj_=function(g){var h=void 0;try{h=g.then}catch(k){this.reject_(k);return}"function"==typeof h?this.settleSameAsThenable_(h,g):this.fulfill_(g)};e.prototype.reject_=function(g){this.settle_(2,g)};e.prototype.fulfill_=function(g){this.settle_(1,g)};e.prototype.settle_=function(g,h){if(0!=this.state_)throw Error("Cannot settle("+g+", "+h+"): Promise already settled in state"+this.state_);this.state_=g;this.result_=h;2===this.state_&&this.scheduleUnhandledRejectionCheck_();
this.executeOnSettledCallbacks_()};e.prototype.scheduleUnhandledRejectionCheck_=function(){var g=this;d(function(){if(g.notifyUnhandledRejection_()){var h=$jscomp.global.console;"undefined"!==typeof h&&h.error(g.result_)}},1)};e.prototype.notifyUnhandledRejection_=function(){if(this.isRejectionHandled_)return!1;var g=$jscomp.global.CustomEvent,h=$jscomp.global.Event,k=$jscomp.global.dispatchEvent;if("undefined"===typeof k)return!0;"function"===typeof g?g=new g("unhandledrejection",{cancelable:!0}):
"function"===typeof h?g=new h("unhandledrejection",{cancelable:!0}):(g=$jscomp.global.document.createEvent("CustomEvent"),g.initCustomEvent("unhandledrejection",!1,!0,g));g.promise=this;g.reason=this.result_;return k(g)};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var g=0;g<this.onSettledCallbacks_.length;++g)f.asyncExecute(this.onSettledCallbacks_[g]);this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(g){var h=this.createResolveAndReject_();
g.callWhenSettled_(h.resolve,h.reject)};e.prototype.settleSameAsThenable_=function(g,h){var k=this.createResolveAndReject_();try{g.call(h,k.resolve,k.reject)}catch(l){k.reject(l)}};e.prototype.then=function(g,h){function k(r,u){return"function"==typeof r?function(q){try{l(r(q))}catch(p){m(p)}}:u}var l,m,n=new e(function(r,u){l=r;m=u});this.callWhenSettled_(k(g,l),k(h,m));return n};e.prototype.catch=function(g){return this.then(void 0,g)};e.prototype.callWhenSettled_=function(g,h){function k(){switch(l.state_){case 1:g(l.result_);
break;case 2:h(l.result_);break;default:throw Error("Unexpected state: "+l.state_);}}var l=this;null==this.onSettledCallbacks_?f.asyncExecute(k):this.onSettledCallbacks_.push(k);this.isRejectionHandled_=!0};e.resolve=c;e.reject=function(g){return new e(function(h,k){k(g)})};e.race=function(g){return new e(function(h,k){for(var l=$jscomp.makeIterator(g),m=l.next();!m.done;m=l.next())c(m.value).callWhenSettled_(h,k)})};e.all=function(g){var h=$jscomp.makeIterator(g),k=h.next();return k.done?c([]):new e(function(l,
m){function n(q){return function(p){r[q]=p;u--;0==u&&l(r)}}var r=[],u=0;do r.push(void 0),u++,c(k.value).callWhenSettled_(n(r.length-1),m),k=h.next();while(!k.done)})};return e},"es6","es3");$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(b,c,d){var e=this.length||0;0>c&&(c=Math.max(0,e+c));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(c=Number(c||0);c<d;c++)this[c]=b;return this}},"es6","es3");$jscomp.typedArrayFill=function(a){return a?a:Array.prototype.fill};
$jscomp.polyfill("Int8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint8Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint8ClampedArray.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Uint16Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Int32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");
$jscomp.polyfill("Uint32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Float32Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.polyfill("Float64Array.prototype.fill",$jscomp.typedArrayFill,"es6","es5");$jscomp.iteratorFromArray=function(a,b){a instanceof String&&(a+="");var c=0,d=!1,e={next:function(){if(!d&&c<a.length){var f=c++;return{value:b(f,a[f]),done:!1}}d=!0;return{done:!0,value:void 0}}};e[Symbol.iterator]=function(){return e};return e};
$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(b){return b})}},"es6","es3");$jscomp.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).v}},"es6","es3");
$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};$jscomp.polyfill("Object.values",function(a){return a?a:function(b){var c=[],d;for(d in b)$jscomp.owns(b,d)&&c.push(b[d]);return c}},"es8","es3");
$jscomp.polyfill("Array.from",function(a){return a?a:function(b,c,d){c=null!=c?c:function(h){return h};var e=[],f="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];if("function"==typeof f){b=f.call(b);for(var g=0;!(f=b.next()).done;)e.push(c.call(d,f.value,g++))}else for(f=b.length,g=0;g<f;g++)e.push(c.call(d,b[g],g));return e}},"es6","es3");$jscomp.polyfill("Array.prototype.findIndex",function(a){return a?a:function(b,c){return $jscomp.findInternal(this,b,c).i}},"es6","es3");
$jscomp.assign=$jscomp.TRUST_ES6_POLYFILLS&&"function"==typeof Object.assign?Object.assign:function(a,b){for(var c=1;c<arguments.length;c++){var d=arguments[c];if(d)for(var e in d)$jscomp.owns(d,e)&&(a[e]=d[e])}return a};$jscomp.polyfill("Object.assign",function(a){return a||$jscomp.assign},"es6","es3");
function Bubblelines(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.INTERVAL=50;this.DISMISS_DELAY=2500;this.UNIFORM_LINE_LENGTH=!0;this.SEPARATE_LINES_FOR_TERMS=!1;this.MAX_LINE_WIDTH=this.MAX_LABEL_WIDTH=0;this.DRAW_TITLES=!0;this.DRAW_SHORT_TITLES=!1;this.graphSeparation=this.MIN_GRAPH_SEPARATION=50;this.yIndex=0;this.mouseOver=!1;this.clearToolTipId=this.intervalId=null;this.overBubbles=[];this.lastClickedBubbles={};this.ctx=this.canvas=this.dragInfo=null;this.maxDocLength=
2;this.maxFreq={term:null,value:0};this.maxRadius=0;this.cache=new Ext.util.MixedCollection;this.currentTerms={};this.termsFilter=[];this.bubbleSpacing=50;this.initialized=!1}
Bubblelines.prototype={constructor:Bubblelines,initializeCanvas:function(){var a=this.container,b=a.getHeight(),c=a.getWidth();this.DRAW_SHORT_TITLES=500>c;var d=Ext.id("bubblelines");a.add({xtype:"container",width:c,height:b,html:'<canvas id="'+d+'" width="'+c+'" height="'+b+'"></canvas>',border:!1,listeners:{afterrender:{fn:function(e){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),!1);this.canvas.addEventListener("mousedown",
this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1);this.canvas.addEventListener("mouseenter",this.mouseEnterHandler.bind(this),!1);this.canvas.addEventListener("mouseleave",this.mouseLeaveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doBubblelinesLayout:function(){if(this.initialized){var a=this.container.getWidth();this.DRAW_SHORT_TITLES=
500>a;this.setTitleWidthsAndMaxTitleWidth();for(var b=Ext.DomQuery.jsSelect("div:not(div[class*=term])",this.container.el.dom),c=0;c<b.length;c++)Ext.fly(b[c]).setWidth(a);this.canvas.width=a;b=75;this.DRAW_SHORT_TITLES&&(b=50);this.setMaxLineWidth(a-this.MAX_LABEL_WIDTH-b);this.setLineLengths();this.recache();this.setCanvasHeight();this.drawGraph()}},addDocToCache:function(a){this.cacheBubbles(a);this.calculateBubbleRadii(a);a.lineLength=600;a.freqCounts={};!1===this.cache.containsKey(a.id)?this.cache.add(a):
this.cache.replace(a.id,a);this.cache.sort("index","ASC")},addTermsToDoc:function(a,b){var c;for(c in a)var d=c;this.currentTerms[d]=!0;b=this.cache.get(b);Ext.apply(b.terms,a);this.cacheBubbles(b)?this.recache():this.calculateBubbleRadii(b)},cacheBubbles:function(a){var b=!1,c;for(c in a.terms){for(var d=a.terms[c],e=d.distributions.length,f=a.lineLength/e,g=[],h=0,k=0,l=0,m=0;m<e;m++){var n=d.distributions[m];n>k&&(k=n);g.push({id:Ext.id(null,"bub"),x:l,freq:n,radius:0,bin:m,tokenPositions:d.positions.slice(h,
h+=n)});l+=f}a.terms[c].maxDistribution=k;a.terms[c].pos=g;k>this.maxFreq.value&&(b=!0,this.setMaxFreq({term:c,value:k}))}return b},calculateBubbleRadii:function(a,b){var c=Math.log(this.maxFreq.value),d=Math.log(2)/2,e;for(e in a.terms){var f=a.terms[e];if(f&&(null==b||e==b))for(var g=0;g<f.pos.length;g++){var h=f.pos[g];h.radius=0<h.freq?Math.max(Math.log(h.freq),d)/c*this.maxRadius:0}}},recache:function(){this.cache.each(function(a){this.cacheBubbles(a);this.calculateBubbleRadii(a)},this)},getTotalHeight:function(){var a=
this.maxRadius;this.cache.each(function(b,c,d){a+=b.height},this);return a},setCanvasHeight:function(){this.calculateGraphHeights();var a=this.getTotalHeight(),b=this.container.dom;if(void 0!==b){b=Ext.DomQuery.jsSelect("div",b);for(var c=0;c<b.length;c++)Ext.fly(b[c]).setHeight(a)}this.canvas&&(this.canvas.height=a)},setMaxLineWidth:function(a){this.maxRadius=a/30;this.MAX_LINE_WIDTH=a-this.maxRadius/2},calculateGraphHeights:function(){var a=.5*this.maxRadius;if(this.SEPARATE_LINES_FOR_TERMS){var b=
this.termsFilter;this.cache.each(function(d,e,f){e=this.maxRadius*b.length;for(f=0;f<b.length;f++)d.terms[b[f]]||(e-=this.maxRadius);0==e&&(e=this.maxRadius);d.height=e+a},this)}else{var c=Math.max(this.maxRadius,this.MIN_GRAPH_SEPARATION);this.cache.each(function(d,e,f){d.height=c+a},this)}},findLongestDocument:function(a){a=a.getTotalWordTokens();a>this.maxDocLength&&(this.maxDocLength=a)},getTitleWidth:function(a){var b=a.title;this.DRAW_SHORT_TITLES&&(b=this.cache.indexOf(a)+1+")");this.ctx.textBaseline=
"top";this.ctx.font="bold 12px Verdana";return this.ctx.measureText(b).width},setTitleWidthsAndMaxTitleWidth:function(){this.cache.each(function(a,b){b=this.getTitleWidth(a);a.titleWidth=b;b>this.MAX_LABEL_WIDTH&&(this.MAX_LABEL_WIDTH=b)},this)},setLineLengths:function(){this.cache.each(function(a,b){b=this.UNIFORM_LINE_LENGTH?this.MAX_LINE_WIDTH:Math.log(a.getTotalWordTokens())/Math.log(this.maxDocLength)*this.MAX_LINE_WIDTH;a.lineLength=b},this)},drawGraph:function(a){null!=this.intervalId&&clearInterval(this.intervalId);
this.mouseOver?this.intervalId=setInterval(this.doDraw.bind(this,[a]),this.INTERVAL):setTimeout(this.doDraw.bind(this,[a]),5)},doDraw:function(a){this.clearCanvas();this.yIndex=this.maxRadius;!0===a&&(this.yIndex+=30);this.cache.each(this.drawDocument,this);!0===a?this.drawLegend():this.drawToolTip();this.doDrag()},drawDocument:function(a,b,c){if(!a.hidden){var d=a.lineLength,e=this.MAX_LABEL_WIDTH-a.titleWidth,f=5;this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";if(null!=this.dragInfo&&
this.dragInfo.oldIndex==b)this.ctx.fillStyle="rgba(128, 128, 128, 0.5)",f+=e,this.ctx.fillText(a.title,f,this.yIndex),this.SEPARATE_LINES_FOR_TERMS&&(this.yIndex+=a.height);else{c=function(){f=g.MAX_LABEL_WIDTH+g.maxRadius;g.ctx.strokeStyle="rgba(128, 128, 128, 1.0)";g.ctx.fillStyle="rgba(128, 128, 128, 1.0)";g.ctx.lineWidth=.25;g.ctx.beginPath();g.ctx.moveTo(f,g.yIndex-6);g.ctx.lineTo(f,g.yIndex+6);g.ctx.stroke();g.ctx.beginPath();g.ctx.moveTo(f,g.yIndex);g.ctx.lineTo(f+d,g.yIndex);g.ctx.stroke();
g.ctx.beginPath();g.ctx.moveTo(f+d,g.yIndex-6);g.ctx.lineTo(f+d,g.yIndex+6);g.ctx.stroke()};this.DRAW_TITLES&&(f+=e,this.ctx.fillStyle="rgba(128, 128, 128, 1.0)",e=a.title,this.DRAW_SHORT_TITLES&&(e=b+1+")"),this.ctx.fillText(e,f,this.yIndex));this.yIndex+=4;var g=this;this.SEPARATE_LINES_FOR_TERMS?null!=this.termsFilter&&0!==this.termsFilter.length||c():c();e=2*Math.PI;var h=0;a.freqCounts={};var k=a.terms,l=null!=this.lastClickedBubbles[b],m=0,n;for(n in k)if(-1!==this.termsFilter.indexOf(n)){var r=
k[n];if(r){m++;this.SEPARATE_LINES_FOR_TERMS&&c();var u=0,q=r.color.join(",");this.ctx.strokeStyle="rgba("+q+", 1)";this.ctx.fillStyle="rgba("+q+", 0.35)";this.ctx.lineWidth=.25;h+=r.rawFreq;u+=r.rawFreq;for(var p=l&&this.lastClickedBubbles[b][n],v=0;v<r.pos.length;v++){var w=r.pos[v];if(0<w.radius){var B=!1;p&&this.lastClickedBubbles[b][n]==w.id&&(this.ctx.strokeStyle="rgba(0, 0, 0, 0.75)",this.ctx.fillStyle="rgba("+q+", 0.5)",this.ctx.lineWidth=1,B=!0);this.ctx.beginPath();this.ctx.arc(w.x+f,this.yIndex,
w.radius,0,e,!0);this.ctx.closePath();this.ctx.fill();this.ctx.stroke();B&&(this.ctx.strokeStyle="rgba("+q+", 1)",this.ctx.fillStyle="rgba("+q+", 0.35)",this.ctx.lineWidth=.25)}}a.freqCounts[n]=u;this.SEPARATE_LINES_FOR_TERMS&&(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(u,f+d+5,this.yIndex-4),this.yIndex+=this.maxRadius)}}this.SEPARATE_LINES_FOR_TERMS&&0==m&&(c(),this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(0,f+
d+5,this.yIndex-4),this.yIndex+=this.maxRadius);f+=d;this.SEPARATE_LINES_FOR_TERMS||(this.ctx.fillStyle="rgba(0, 0, 0, 1.0)",this.ctx.font="10px Verdana",this.ctx.fillText(h,f+5,this.yIndex-4))}this.yIndex=this.SEPARATE_LINES_FOR_TERMS?this.yIndex+.5*this.maxRadius:this.yIndex+a.height;this.yIndex-=4}},drawLegend:function(){var a=this.MAX_LABEL_WIDTH+this.maxRadius;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.typeStore&&this.typeStore.each(function(b){var c=b.get("color").join(",");
this.ctx.fillStyle="rgb("+c+")";b=b.get("type");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},this)},drawToolTip:function(){if(0<this.overBubbles.length){this.ctx.lineWidth=.5;this.ctx.fillStyle="rgba(224, 224, 224, 0.8)";this.ctx.strokeStyle="rgba(0, 0, 0, 0.8)";var a=this.overBubbles[0].x,b=this.overBubbles[0].y;a+110>this.canvas.width&&(a-=110);if(null==this.overBubbles[0].label){var c=this.cache.get(this.overBubbles[0].docIndex);var d=1;for(var e in c.freqCounts)d++;d*=16;b+
d>this.canvas.height&&(b-=d);this.ctx.fillRect(a,b,110,d);this.ctx.strokeRect(a,b,110,d);a+=10;b+=10;this.ctx.fillStyle="rgba(0, 0, 0, 0.8)";this.ctx.font="10px Verdana";for(e in c.freqCounts)this.ctx.fillText(e+": "+c.freqCounts[e],a,b,90),b+=16}else for(d=16*this.overBubbles.length+10,b+d>this.canvas.height&&(b-=d),this.ctx.fillRect(a,b,110,d),this.ctx.strokeRect(a,b,110,d),a+=10,b+=10,this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.font="10px Verdana",c=0;c<this.overBubbles.length;c++)e=this.overBubbles[c],
this.ctx.fillText(e.label+": "+e.freq,a,b,90),b+=16;null==this.clearToolTipId&&(this.clearToolTipId=setTimeout(this.clearToolTip.bind(this),this.DISMISS_DELAY))}},clearToolTip:function(){this.overBubbles=[];clearTimeout(this.clearToolTipId);this.clearToolTipId=null},mouseEnterHandler:function(a){this.mouseOver=!0;this.drawGraph()},mouseLeaveHandler:function(a){this.mouseOver=!1;null!=this.intervalId&&clearInterval(this.intervalId);this.overBubbles=[];this.drawGraph()},moveHandler:function(a){this.clearToolTip();
this.overBubbles=[];var b=a.layerX-this.MAX_LABEL_WIDTH,c=a.layerY,d=.25*this.maxRadius,e=-1;this.cache.each(function(n,r,u){if(c<d)return!1;d+=n.height;if(c<d)return e=r,!1},this);if(null!=this.dragInfo)this.dragInfo.x=a.layerX,this.dragInfo.y=c,e>=this.cache.getCount()?e=this.cache.getCount()-1:0>e&&(e=c+this.maxRadius>this.canvas.height?this.cache.getCount()-1:0),this.dragInfo.newIndex=e,document.body.style.cursor="move";else if(0<=e&&e<this.cache.getCount())if(0<=b){var f=!1;b-=this.maxRadius;
var g=this.cache.get(e);if(b>=g.lineLength)this.overBubbles=[{docIndex:e,x:a.layerX+10,y:a.layerY+10}];else{b=Math.round(b/(g.lineLength/this.bubbleSpacing));var h=this.maxRadius;0<e&&(h=d-(this.cache.get(e).height-.75*this.maxRadius));h=Math.round((c-h)/this.maxRadius);var k=0,l;for(l in g.terms)if(-1!==this.termsFilter.indexOf(l)){var m=g.terms[l];m?(this.SEPARATE_LINES_FOR_TERMS&&k==h||!this.SEPARATE_LINES_FOR_TERMS)&&m.pos[b]&&0<m.pos[b].radius&&(f=!0,this.overBubbles.push({label:l,type:m,docId:g.id,
docIndex:e,xIndex:b,yIndex:h,freq:m.pos[b].freq,id:m.pos[b].id,tokenPositions:m.pos[b].tokenPositions,x:a.layerX+10,y:a.layerY+10})):this.SEPARATE_LINES_FOR_TERMS&&k--;k++}}document.body.style.cursor=f?"pointer":"auto"}else document.body.style.cursor="move";else document.body.style.cursor="auto"},mouseDownHandler:function(a){var b=a.layerX,c=a.layerY;if(b<this.MAX_LABEL_WIDTH){var d=.25*this.maxRadius,e=-1;this.cache.each(function(f,g,h){if(c<d)return!1;d+=f.height;if(c<d)return e=g,!1},this);0<=
e&&e<this.cache.getCount()&&(this.dragInfo={oldIndex:e,newIndex:e,xOffset:b-5,yOffset:5,x:b,y:c})}},mouseUpHandler:function(a){this.dragInfo=null},doDrag:function(){if(null!=this.dragInfo){for(var a={},b=0;b<this.cache.getCount();b++)b<this.dragInfo.oldIndex&&b<this.dragInfo.newIndex?a[b]=b:b<this.dragInfo.oldIndex&&b>=this.dragInfo.newIndex?a[b]=b+1:b==this.dragInfo.oldIndex?a[b]=this.dragInfo.newIndex:b>this.dragInfo.oldIndex&&b>this.dragInfo.newIndex?a[b]=b:b>this.dragInfo.oldIndex&&b<=this.dragInfo.newIndex&&
(a[b]=b-1);this.dragInfo.oldIndex=this.dragInfo.newIndex;this.cache.reorder(a);a=this.cache.get(this.dragInfo.oldIndex);this.ctx.fillStyle="rgba(128, 128, 128, 1)";this.ctx.textBaseline="top";this.ctx.font="bold 12px Verdana";this.ctx.fillText(a.title,this.dragInfo.x-this.dragInfo.xOffset,this.dragInfo.y-this.dragInfo.yOffset)}},clickHandler:function(a){this.lastClickedBubbles={};if(0<this.overBubbles.length&&this.overBubbles[0].label){a=[];for(var b=[],c=[],d=0;d<this.overBubbles.length;d++){var e=
this.overBubbles[d];c.push({term:e.label,docIndex:e.docIndex,docId:e.docId,tokenPositions:e.tokenPositions});null==this.lastClickedBubbles[e.docIndex]&&(this.lastClickedBubbles[e.docIndex]={});this.lastClickedBubbles[e.docIndex][e.label]=e.id;a.push(e.docId+":"+e.label);b.push(e.tokenPositions)}b=Ext.flatten(b);b.sort();void 0!==this.externalClickHandler&&this.externalClickHandler(c)}this.overBubbles=[]},setMaxFreq:function(a){null==a&&(a=this.findMaxFreq());this.maxFreq=a},findMaxFreq:function(){var a=
{term:"",value:0};this.cache.each(function(b){for(var c in b.terms){var d=b.terms[c].maxDistribution;d>a.value&&(a={term:c,value:d})}},this);return a},getNewColor:function(){for(var a=null,b=0;b<this.colors.length&&(a=this.colors[b],-1!=this.typeStore.findExact("color",a));b++)a=null;null==a&&(a=[128,128,128]);return a},removeAllTerms:function(){this.cache.each(function(a){a.terms={}},this);this.currentTerms={};this.termsFilter=[]},removeTerm:function(a){delete this.currentTerms[a];var b=!1;this.cache.each(function(f){for(var g in f.terms)g==
a&&(this.maxFreq.term==a&&(this.maxFreq={term:null,value:0},b=!0),delete f.terms[g])},this);for(var c in this.lastClickedBubbles){var d=this.lastClickedBubbles[c],e;for(e in d)e==a&&delete this.lastClickedBubbles[c][e]}b&&(this.setMaxFreq(),this.calculateBubbleRadii(),this.drawGraph())},clearCanvas:function(){this.canvas.width=this.canvas.width}};function Knots(a){this.container=a.container;this.externalClickHandler=a.clickHandler;this.MAX_LINE_LENGTH=0;this.LINE_SIZE=2.5;this.progressiveDraw=!0;this.progDrawDone=!1;this.drawStep=0;this.mouseOver=!1;this.refreshInterval=100;this.forceRedraw=!1;this.lastDrawTime=(new Date).getTime();this.intervalId=null;this.startAngle=315;this.angleIncrement=15;this.ctx=this.canvas=null;this.currentDoc={terms:{},lineLength:void 0};this.maxDocLength=0;this.offset={x:0,y:0};this.termsFilter=[];this.initialized=
!1;this.audio=a.audio;this.audioCtx=null}
Knots.prototype={constructor:Knots,initializeCanvas:function(){var a=this.container,b=a.getHeight()-5,c=a.getWidth();this.MAX_LINE_LENGTH=Math.sqrt(c*c+b*b);var d=Ext.id("knots");a.add({xtype:"container",width:c,height:b,html:'<canvas id="'+d+'" width="'+c+'" height="'+b+'"></canvas>',border:!1,listeners:{afterrender:{fn:function(e){this.canvas=document.getElementById(d);this.ctx=this.canvas.getContext("2d");this.canvas.addEventListener("click",this.clickHandler.bind(this),!1);this.canvas.addEventListener("mousedown",
this.mouseDownHandler.bind(this),!1);this.canvas.addEventListener("mouseup",this.mouseUpHandler.bind(this),!1);this.canvas.addEventListener("mousemove",this.moveHandler.bind(this),!1)},single:!0,scope:this}}});a.updateLayout();this.initialized=!0},doLayout:function(){if(this.initialized){var a=this.container.getWidth(),b=this.container.getHeight()-5;this.canvas.width=a;this.canvas.height=b;this.recache();this.buildGraph()}},buildGraph:function(a){null!=this.intervalId&&(this.progDrawDone=!1,clearInterval(this.intervalId));
this.forceRedraw=!0;this.drawStep=a||0;for(var b in this.currentDoc.terms)this.currentDoc.terms[b].done=!1;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50):this.doDraw(!1)},drawGraph:function(a){null!=this.intervalId&&(this.progDrawDone=!1,clearInterval(this.intervalId));this.forceRedraw=!0;this.progressiveDraw?this.intervalId=setInterval(this.doDraw.createDelegate(this,[a]),50):this.doDraw(!1,a)},doDraw:function(a){var b=(new Date).getTime();if(this.forceRedraw||
b-this.lastDrawTime>=this.refreshInterval)if(this.forceRedraw=!1,this.clearCanvas(),this.ctx.save(),this.ctx.translate(this.offset.x,this.offset.y),this.drawDocument(this.currentDoc),this.originOpacity=.5,this.originColor="128,128,128",this.ctx.lineWidth=15*Math.abs(this.originOpacity-1),this.ctx.fillStyle="rgba("+this.originColor+",1.0)",this.ctx.strokeStyle="rgba("+this.originColor+","+this.originOpacity+")",this.ctx.beginPath(),this.ctx.arc(0,0,2*this.LINE_SIZE,0,2*Math.PI,!0),this.ctx.closePath(),
this.ctx.fill(),a||this.ctx.stroke(),this.ctx.restore(),this.ctx.lineWidth=1,!0===a&&this.drawLegend(),this.lastDrawTime=(new Date).getTime(),this.progressiveDraw){a=!0;for(var c in this.currentDoc.terms)a=a&&this.currentDoc.terms[c].done;(this.progDrawDone=a)?(clearInterval(this.intervalId),this.intervalId=null,this.muteTerms()):this.drawStep++}},setAudio:function(a){(this.audio=a)||this.muteTerms()},muteTerms:function(){for(t in this.currentDoc.terms)this.currentDoc.terms[t].audio&&(this.currentDoc.terms[t].audio.gainNode.gain.value=
0)},drawDocument:function(a){a=a.terms;for(var b in a)if(-1!=this.termsFilter.indexOf(b)){var c=a[b];if(c&&c.pos){var d=[[0,0],[0,0]];if(this.progressiveDraw){var e=this.drawStep+1;c.pos.length<=this.drawStep?(c.done=!0,e=c.pos.length,c.audio&&(c.audio.gainNode.gain.value=0)):(this.audio&&c.audio&&(c.audio.gainNode.gain.value=.1,setTimeout(function(){c.audio.gainNode.gain.value=0},.75*this.refreshInterval)),c.done=!1);for(var f=0;f<e;f++){var g=c.pos[f];this.drawPolygon(g,d,c.color);d=[[g.polygon[0][3],
g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}}else for(f=0;f<c.pos.length;f++)g=c.pos[f],this.drawPolygon(g,d,c.color),d=[[g.polygon[0][3],g.polygon[1][3]],[g.polygon[0][2],g.polygon[1][2]]]}}},drawPolygon:function(a,b,c){var d=a.polygon[0],e=a.polygon[1];this.ctx.beginPath();this.ctx.moveTo(b[0][0],b[0][1]);this.ctx.lineTo(d[0],e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(b[1][0],b[1][1]);this.ctx.closePath();this.ctx.fillStyle="rgba("+c+", 0.6)";this.ctx.fill();this.ctx.beginPath();this.ctx.moveTo(d[0],
e[0]);this.ctx.lineTo(d[1],e[1]);this.ctx.lineTo(d[2],e[2]);this.ctx.lineTo(d[3],e[3]);this.ctx.closePath();a.over&&(this.ctx.fillStyle="rgba("+c+", 1.0)");this.ctx.fill()},drawLegend:function(){var a=5;this.ctx.textBaseline="top";this.ctx.font="16px serif";this.termStore.each(function(b){var c=b.get("color");this.ctx.fillStyle="rgb("+c+")";b=b.get("term");this.ctx.fillText(b,a,5);b=this.ctx.measureText(b).width;a+=b+8},this)},setCurrentDoc:function(a){this.currentDoc=a;this.cacheCurrentDocument()},
addTerms:function(a){Ext.apply(this.currentDoc.terms,a);this.recache()},removeTerm:function(a){this.currentDoc.terms[a].audio&&this.currentDoc.terms[a].audio.oscillator.stop();delete this.currentDoc.terms[a];this.recache()},removeAllTerms:function(){for(term in this.currentDoc.terms)this.currentDoc.terms[term].audio&&this.currentDoc.terms[term].audio.oscillator.stop();this.currentDoc.terms={};this.recache()},recache:function(){this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*this.canvas.width+this.canvas.height*
this.canvas.height);this.cacheCurrentDocument();this.determineGraphSizeAndPosition()},cacheCurrentDocument:function(){var a=this.MAX_LINE_LENGTH;this.currentDoc.lineLength=a;if(this.audio&&null==this.audioCtx)try{this.audioCtx=new (window.AudioContext||window.webkitAudioContext)}catch(e){}for(var b in this.currentDoc.terms){if(this.audio&&this.audioCtx&&!this.currentDoc.terms[b].audio){var c=this.audioCtx.createOscillator(),d=this.audioCtx.createGain();c.connect(d);d.connect(this.audioCtx.destination);
c.frequency.value=500*Math.random()+150;c.start();d.gain.value=0;this.currentDoc.terms[b].audio={oscillator:c,gainNode:d}}this.cacheTurns(this.currentDoc.terms[b],a)}},cacheTurns:function(a,b){if(0<a.rawFreq){var c=this.currentDoc,d=a.term,e=[];a=a.positions;for(var f=a[a.length-1],g=this.startAngle,h=this.angleIncrement,k,l,m=0,n=0,r=k=0;r<a.length;r++){var u=a[r],q=u/f*b,p=q-k;k=m;l=n;n=this.findEndPoint([m,n],p,g);m=n[0];n=n[1];k=this.getPolygonFromLine([k,l],[m,n],g,this.LINE_SIZE);e.push({tokenId:u,
polygon:k,over:!1});k=q;g+=h}c.terms[d].pos=e;c.terms[d].done=!1}},findEndPoint:function(a,b,c){c=this.degreesToRadians(c);return[a[0]+b*Math.cos(c),a[1]+b*Math.sin(c)]},determineGraphSizeAndPosition:function(){var a=this.findBoundingBoxForGraph(),b=a.maxX-a.minX,c=a.maxY-a.minY,d=Math.min(this.canvas.width/b,this.canvas.height/c);d-=.05;this.offset.x=Math.abs(a.minX*d-(this.canvas.width/2-b*d/2));this.offset.y=Math.abs(a.minY*d-(this.canvas.height/2-c*d/2));this.MAX_LINE_LENGTH=Math.sqrt(this.canvas.width*
this.canvas.width+this.canvas.height*this.canvas.height)*d;this.cacheCurrentDocument()},findBoundingBoxForGraph:function(){var a=null,b=null,c=null,d=null,e;for(e in this.currentDoc.terms)for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var h=f[g].polygon;h=this.getBoundingBox(h[0],h[1]);if(null==a||h[0]<a)a=h[0];if(null==b||h[2]>b)b=h[2];if(null==c||h[1]<c)c=h[1];if(null==d||h[3]>d)d=h[3]}return{minX:a,minY:c,maxX:b,maxY:d}},getBoundingBox:function(a,b){return[Math.min(a[0],a[2]),Math.min(b[0],
b[2]),Math.max(a[0],a[2]),Math.max(b[0],b[2])]},degreesToRadians:function(a){return Math.PI/180*a},clickHandler:function(a){var b=a.layerX-this.offset.x;a=a.layerY-this.offset.y;var c=null,d=0,e;for(e in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(e))for(var f=this.currentDoc.terms[e].pos,g=0;g<f.length;g++){var h=f[g].polygon;if(this.isPointInPolygon(h[0],h[1],b,a)){c=e;d=f[g].tokenId;break}}c&&void 0!==this.externalClickHandler&&this.externalClickHandler({term:c,tokenId:d})},moveHandler:function(a){var b=
a.layerX-this.offset.x,c=a.layerY-this.offset.y;if(null!=this.dragInfo)document.body.style.cursor="move",this.dragInfo.lastX=this.dragInfo.x,this.dragInfo.lastY=this.dragInfo.y,this.dragInfo.x=a.layerX,this.dragInfo.y=a.layerY,b=this.dragInfo.y-this.dragInfo.lastY,this.offset.x+=this.dragInfo.x-this.dragInfo.lastX,this.offset.y+=b;else{this.mouseOver=!1;for(var d in this.currentDoc.terms)if(-1!=this.termsFilter.indexOf(d)){a=this.currentDoc.terms[d].pos;for(var e=0;e<a.length;e++)if(this.mouseOver)this.currentDoc.terms[d].pos[e].over=
!1;else{var f=a[e].polygon;this.isPointInPolygon(f[0],f[1],b,c)?this.mouseOver=this.currentDoc.terms[d].pos[e].over=!0:this.currentDoc.terms[d].pos[e].over=!1}}if(this.mouseOver){if(document.body.style.cursor="pointer",!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),this.intervalId=setInterval(this.doDraw.createDelegate(this,[!1]),50)}else if(document.body.style.cursor="auto",!this.progressiveDraw||this.progressiveDraw&&this.progDrawDone)clearInterval(this.intervalId),
this.doDraw(!1)}},mouseDownHandler:function(a){var b=a.layerX;a=a.layerY;this.dragInfo={lastX:b,lastY:a,x:b,y:a}},mouseUpHandler:function(a){this.dragInfo=null},getPolygonFromLine:function(a,b,c,d){var e=c+90,f=c-90;c=this.findEndPoint(a,d,e);a=this.findEndPoint(a,d,f);f=this.findEndPoint(b,d,f);b=this.findEndPoint(b,d,e);return[[c[0],a[0],f[0],b[0]],[c[1],a[1],f[1],b[1]]]},isPointInPolygon:function(a,b,c,d){var e,f=3,g=!1;for(e=0;4>e;e++)(b[e]<d&&b[f]>=d||b[f]<d&&b[e]>=d)&&a[e]+(d-b[e])/(b[f]-b[e])*
(a[f]-a[e])<c&&(g=!g),f=e;return g},clearCanvas:function(){this.canvas.width=this.canvas.width}};var doubletree={};
(function(){function a(e,f,g){if(e.children){g&&(e.info.origIDs?(e.info.ids={},c(e.info.ids,e.info.origIDs),e.info.count=Object.keys(e.info.ids).length):(e.info.origIDs={},c(e.info.origIDs,e.info.ids),e.info.origCount=Object.keys(e.info.origIDs).length));var h=Object.keys(f);g=0;for(var k=h.length;g<k;g++)delete e.info.ids[h[g]];e.info.count=Object.keys(e.info.ids).length;k=e.children.length;for(g=0;g<k;g++)h=e.children[g],b(h.info.ids,f)?e.children[g]=null:a(h,f,!1);e.children=e.children.filter(function(l){return null!=
l});e.info.continuations=e.children.length;f=d3.max(e.children.map(function(l){return l.maxChildren}));e.maxChildren=Math.max(e.children.length,f)}}function b(e,f){if(!e||!f)return!1;for(var g in e)if(!(g in f))return!1;return!0}function c(e,f){for(var g in f)e[g]=f[g]}function d(){}doubletree.DoubleTree=function(){function e(z){z.each(function(J,G){f.push(this.node())})}var f=[],g=600,h=400,k=!1,l={left:[],right:[]},m={alt:d,shift:d,click:d},n=!0,r=!0,u=doubletree.sortByStrFld("token"),q=doubletree.tokenText,
p=function(z){return doubletree.fieldText(z,"POS")},v=function(z){return"rgba(255,255,255,1)"},w=function(z){return"rgba(255,255,255,1)"},B=function(z){return"red"},C={node:{fill:"white",stroke:"steelblue","stroke-width":"1.5px"},branch:{stroke:"#aaa","stroke-width":"1.5px"}},N=!1,P=d3.dispatch("idsUpdated");P.on("idsUpdated",function(){this==H?(D.setIds(H.continuationIDs),D.updateContinuations()):this==D&&(H.setIds(D.continuationIDs),H.updateContinuations())});var I,O,H,D,L,K;e.init=function(z){d3.select(d3.selectAll(z)).call(this);
return e};e.redraw=function(){void 0!==I&&void 0!==O&&e.setupFromTries(I,O);return e};e.setupFromTries=function(z,J){I=z.getUniqRoot();O=J.getUniqRoot();var G=I.toTree(l.left),x=O.toTree(l.right);z=!0;0<Object.keys(x.pruned).length&&(a(x,x.pruned,z),a(G,x.pruned,z),z=!1);0<Object.keys(G.pruned).length&&(a(G,G.pruned,z),a(x,G.pruned,z));z={};for(var E in x.info)"continuations"!=E&&"ids"!=E&&"count"!=E&&(z[E]=x.info[E]);z["right continuations"]=x.info.continuations;z["left continuations"]=G.info.continuations;
z.ids={};c(z.ids,x.info.ids);c(z.ids,G.info.ids);z.count=Object.keys(z.ids).length;L=Object.keys(z.ids);if(x.info.origIDs||G.info.origIDs)z.origIDs={},c(z.origIDs,x.info.origIDs),c(z.origIDs,G.info.origIDs),z.origCount=Object.keys(z.origIDs).length;x.info=z;G.info=z;E=Math.max(G.maxChildren,x.maxChildren);if(isNaN(E)||0==E)return N=!1,e;r?K=d3.scaleLog().range([8,14]):(K=function(){return 14},K.domain=function(){});K.domain([Math.min(G.minCount,x.minCount),G.info.count]);var F=g-20-20,M=h-20-20;f.forEach(function(Q,
A){A=d3.select(Q).select("svg");null==A.node()?(A=d3.select(Q).append("svg").attr("width",F+20+20).attr("height",M+20+20).attr("cursor","move").call(d3.zoom().scaleExtent([1,1]).on("zoom",function(){var R=d3.event.transform.x+F/2,S=d3.event.transform.y+M/2;d3.select(Q).select("svg > g").attr("transform","translate("+R+","+S+")")})),A.append("g").attr("transform","translate("+F/2+","+M/2+")")):(A.attr("width",F+20+20).attr("height",M+20+20),A.selectAll("g *").remove());H=new doubletree.Tree(A.select("g"),
g,h,G,!0,u,P,K,n,q,p,v,w,B,C);D=new doubletree.Tree(A.select("g"),g,h,x,!1,u,P,K,n,q,p,v,w,B,C)});H.handleAltPress=m.alt;D.handleAltPress=m.alt;H.handleShiftPress=m.shift;D.handleShiftPress=m.shift;H.handleClick=m.click;D.handleClick=m.click;N=!0;return e};e.setupFromArrays=function(z,J,G,x,E,F,M,Q){void 0==E&&I&&(E=I.caseSensitive());void 0==F&&I&&(F=I.fieldNames());void 0==M&&I&&(M=I.fieldDelim());void 0==Q&&I&&(Q=I.distinguishingFieldsArray());I=new doubletree.Trie(E,F,M,Q);O=new doubletree.Trie(E,
F,M,Q);E=J.length;for(F=0;F<E;F++){M=x?x[F]:F;Q=J[F];var A=z[F].slice(),R=G[F].slice();A.push(Q);A.reverse();R.unshift(Q);k?(O.addNgram(A,M),I.addNgram(R,M)):(I.addNgram(A,M),O.addNgram(R,M))}e.setupFromTries(I,O);return e};e.filteredIDs=function(){return L};e.search=function(z){H.search(z);D.search(z);z=d3.select(f[0]);var J=z.selectAll("text.foundText");if(J.empty())return 0;J=J[0].length;null!=z.selectAll("text.rtNdText.foundText").node()&&J--;return J};e.clearSearch=function(){H.clearSearch();
D.clearSearch();return e};e.updateTokenExtras=function(){H.showTokenExtras(n);D.showTokenExtras(n);var z=d3.select(f[0]).select('.tokenExtra[display="inline"]');z.empty()||"0px"==z.style("height")&&e.redraw();return e};e.visWidth=function(z){if(!arguments.length)return g;g=z;return e};e.visHeight=function(z){if(!arguments.length)return h;h=z;return e};e.prefixesOnRight=function(z){if(!arguments.length)return k;k=z;return e};e.filters=function(z){if(!arguments.length)return l;l=z;return e};e.handlers=
function(z){if(!arguments.length)return m;m=z;return e};e.showTokenExtra=function(z){if(!arguments.length)return n;n=z;return e};e.scaleLabels=function(z){if(!arguments.length)return r;r=z;return e};e.succeeded=function(){return N};e.sortFun=function(z){if(!arguments.length)return u;u=z;return e};e.nodeText=function(z){if(!arguments.length)return q;q=z;return e};e.tokenExtraText=function(z){if(!arguments.length)return p;p=z;return e};e.rectColor=function(z){if(!arguments.length)return v;v=z;return e};
e.rectBorderColor=function(z){if(!arguments.length)return w;w=z;return e};e.continuationColor=function(z){if(!arguments.length)return B;B=z;return e};e.basicStyles=function(z){if(!arguments.length)return C;Object.keys(C).forEach(function(J){J in z&&Object.keys(C[J]).forEach(function(G){G in z[J]&&(C[J][G]=z[J][G])})});return e};return e};doubletree.Tree=function(e,f,g,h,k,l,m,n,r,u,q,p,v,w,B){function C(x){x.children&&(x._children=x.children,x._children.forEach(C),x.children=null)}function N(x){x.parent&&
x.parent.children.forEach(function(E){E!=x&&C(E)})}function P(x,E){d3.event.altKey?G.handleAltPress(x,E):d3.event.shiftKey?G.handleShiftPress(x,E):(G.handleClick(x,E),x.parent&&(G.continuationIDs!=x.data.info.ids&&(G.setIds(x.data.info.ids),G.clickedNode=x.id,m.call("idsUpdated",G)),N(x),I(x,!0)))}function I(x,E){x.children?(x.children&&1==x.children.length&&I(x.children[0],!0),x._children=x.children,x.children=null):(x.children=x._children,x._children=null,x.children&&1==x.children.length&&I(x.children[0],
!1));E&&G.update(x)}function O(x){return k?-x:x}var H=r,D=p;f=f-20-20;g=g-20-20;var L=0,K;l||(l=doubletree.sortByStrFld("token"));L=0;var z=d3.tree().size([g,f]).nodeSize([40,40]),J=d3.linkHorizontal().x(function(x){return O(x.y)}).y(function(x){return x.x});e=e.append("g").attr("transform","translate(20,20)");this.readJSONTree=function(x){K=d3.hierarchy(x);K.x0=0;K.y0=0;K.children.forEach(C);this.update(K)};this.update=function(x){var E=z(K).descendants();E.forEach(function(A){var R=A.textSize;if(void 0==
R){R=0;for(var S=A.parent;null!=S;){var T=Ext.draw.TextMeasurer.measureText(S.data.name,"arial").width;R+=T;S=S.parent}A.textSize=R}A.y=25*A.depth+R});var F=e.selectAll("g.node_"+k).data(E,function(A){return A.id||(A.id=++L)}),M=F.enter().append("g").attr("class","node node_"+k).attr("cursor","pointer").attr("transform",function(A){return"translate("+O(x.y0)+","+x.x0+")"}).on("click",P);M.append("title").text(function(A){return doubletree.infoToText(A.data.info)});M.append("circle").attr("r",1E-6).style("fill",
function(A){return A._children?"#fff":B.node.fill}).style("stroke",function(A){return B.node.stroke});var Q=M.append("text").attr("class",function(A){return 0==A.depth?"rtNdText":""}).attr("x",function(A){return A.children||A._children?0:k?10:-10}).attr("text-anchor",function(A){return A.parent?A.children||A._children?k?"end":"start":k?"start":"end":"middle"}).style("font-size",function(A){return n(A.data.info.count)+"pt"});Q.append("tspan").attr("dy",".35em").attr("class","tokenText").text(function(A){return u(A.data.info,
1>A.depth)}).style("fill-opacity",1E-6);Q.append("tspan").attr("dx",".35em").attr("class","tokenExtra").text(function(A){return q(A.data.info,1>A.depth)}).style("fill-opacity",1E-6);this.drawRects();M=M.merge(F);M.transition().duration(200).attr("transform",function(A){return"translate("+O(A.y)+","+A.x+")"});M.select("circle").attr("r",function(A){return A.children||A._children?1E-6:4.5}).style("fill",function(A){return A._children?"#fff":B.node.fill}).style("stroke-width",B.node["stroke-width"]);
M.selectAll("tspan").style("fill-opacity",1);F=F.exit().transition().duration(200).attr("transform",function(A){return"translate("+O(x.y)+","+x.x+")"}).remove();F.select("circle").attr("r",1E-6);F.selectAll("tspan").style("fill-opacity",1E-6);F=e.selectAll("path.link_"+k).data(K.links(),function(A){return A.source.id+"-"+A.target.id});F.enter().insert("path","g").attr("class","link link_"+k).attr("d",function(A){A={x:x.x0,y:x.y0};return J({source:A,target:A})}).style("fill","none").style("stroke",
B.branch.stroke).style("stroke-width",B.branch["stroke-width"]).merge(F).transition().duration(200).attr("d",J);F.exit().transition().duration(200).attr("d",function(A){A={x:x.x0,y:x.y0};return J({source:A,target:A})}).remove();E.forEach(function(A){A.x0=A.x;A.y0=A.y});this.updateContinuations()};this.drawRects=function(){var x=H?"inline":"none";e.selectAll(".tokenExtra").attr("display",x);x=e.selectAll("g.node_"+k);x.selectAll("rect").remove();x.insert("rect","text").attr("class","nodeRect").attr("height",
function(){var E=this.parentElement.getBBox().height;6>E&&(E=6.1);return E-6}).attr("y",function(E){return E.parent?-.5*this.parentElement.getBBox().height/2:-.5*this.parentElement.getBBox().height/2-2}).attr("width",function(){return this.parentElement.getBBox().width}).attr("x",function(E){var F=this.parentElement.getBBox().width;return E.parent?k?-.5*F:0:-.33333*F}).style("stroke-opacity",1).style("stroke-width",1).style("stroke",function(E){return v(E.data.info)}).style("fill",function(E){return D(E.data.info)}).style("fill-opacity",
function(E){return 1})};var G=this;this.setIds=function(x){G.continuationIDs=x};this.updateContinuations=function(){e.selectAll("g.node_"+k+" text").classed("continuation",function(x){a:{var E=G.continuationIDs||{},F;for(F in x.data.info.ids)if(F in E){x=!0;break a}x=!1}return x}).style("fill",function(x){return d3.select(this).classed("continuation")?w(x.data.info):"#444"})};this.search=function(x){e.selectAll("g.node text").classed("foundText",function(E){return x.test(u(E.data.info))})};this.clearSearch=
function(){e.selectAll("g.node text").classed("foundText",!1)};this.showTokenExtras=function(x){if(0==arguments.length)return H;H=x;this.drawRects();return this};this.setRectColor=function(x){if(0==arguments.length)return D;D=x;this.drawRects();return this};this.handleAltPress=function(){};this.handleShifttPress=function(){};this.handleClick=function(){};this.readJSONTree(h);return this};doubletree.sortByStrFld=function(e){return function(f,g){var h=void 0==f.data.info[e],k=void 0==g.data.info[e];
if(h&&k)return 0;if(h)return-1;if(k)return 1;f=f.data.info[e].join(" ").toLowerCase();g=g.data.info[e].join(" ").toLowerCase();return f<g?-1:f>g?1:0}};doubletree.sortByCount=function(){return function(e,f){return f.data.info.count-e.data.info.count}};doubletree.sortByContinuations=function(){return function(e,f){return f.data.info.continuations-e.data.info.continuations}};doubletree.filterByMinCount=function(e){return function(f){return f.count>=e}};doubletree.filterByMaxCount=function(e){return function(f){return f.count<=
e}};doubletree.filterByPOS=function(e){var f=new RegExp(e);return function(g){return g.POS&&0<g.POS.filter(function(h){return-1<h.search(f)}).length}};doubletree.fieldText=function(e,f){return e[f]};doubletree.tokenText=function(e){var f="";void 0!==e.token&&(f=e.token);return f};doubletree.infoToText=function(e){var f="",g;for(g in e)f="ids"==g||"origIDs"==g?f+(g+"\t:\t"+Object.keys(e[g]).join(",")+"\n"):f+(g+"\t:\t"+e[g]+"\n");return f}})();doubletree=doubletree||{};
(function(){doubletree.Trie=function(a,b,c,d,e){function f(p,v,w){this.id=v;this.count=w;this.info={count:w,ids:{}};if(null==p)this.item=k;else{this.item=p;this.info.ids={};this.info.ids[v]=!0;p=p.split(n);for(var B in p)this.info[m[B]]=[p[B]]}this.nodes={};this.addNgram=function(C,N,P){P||(P=1);if(0<C.length){var I=C.shift();var O=I.split(n);var H=u&&this.item==k?"":O.filter(function(K,z){return-1<r.indexOf(m[z])}).map(function(K){return l?K.toLocaleLowerCase():K}).join(n)}else H=I=h;if(H in this.nodes&&
this.nodes[H]instanceof f){var D=this.nodes[H];D.info.count+=P;D.info.ids[N]=!0;for(var L in O)H=O[L],-1==D.info[m[L]].indexOf(H)&&D.info[m[L]].push(H)}else D=new f(I,N,P),this.nodes[H]=D;I!=h&&D.addNgram(C,N,P)};this.getUniqRoot=function(){if(this.item==k){var C=Object.keys(this.nodes);if(1==C.length)return this.nodes[C[0]]}return this};this.toTree=function(C){function N(I,O,H){var D={children:[]};D.name=H.item;D.info={};for(var L in H.info)if("Object"===typeof H.info[L]){D.info[L]={};for(var K in H.info[L])D.info[L][K]=
this.info[L][K]}else D.info[L]=H.info[L];D.pruned={};for(var z in H.nodes)L=H.nodes[z],K=I[O],!K||K&&K(L.info)?(D.children.push(N(I,O+1,L)),L.pruned!={}&&g(D.pruned,L.pruned)):g(D.pruned,L.info.ids);D.info.continuations=D.children.length;0==D.children.length?(D.children=null,D.maxChildren=0,D.maxLen=D.name?D.name.length:0,D.minCount=D.info.count):(I=d3.max(D.children.map(function(J){return J.maxChildren})),D.maxChildren=Math.max(D.children.length,I),I=d3.max(D.children.map(function(J){return J.maxLen})),
D.maxLen=Math.max(I,D.name.length),D.minCount=d3.min(D.children.map(function(J){return J.minCount})));return D}C||(C=[]);var P=JSON.parse(JSON.stringify(this));return N(C,0,P)}}function g(p,v){for(var w in v)p[w]=v[w]}var h=" ",k="_root_",l=!a&&!0;b||(b=["item"]);var m=b;n||(n="\t");var n=c;r||(r=[m[0]]);var r=d,u=e;void 0==u&&(u=!0);var q=new f(k,-1,0);this.addNgram=function(p,v,w){q.addNgram(p,v,w)};this.getUniqRoot=function(){var p=new doubletree.Trie(!l,m,n,r);p.trie(q.getUniqRoot());return p};
this.toTree=function(p,v){return q.toTree(p,v)};this.serialize=function(){return JSON.stringify(this)};this.deserialize=function(p){p=JSON.parse(p);h=p.endNG();k=p.rootName();l=p.caseSensitive();m=p.fieldNames();n=p.fieldDelim();r=p.distinguishingFieldsArray();q=p.trie()};this.endNG=function(){return h};this.rootName=function(){return k};this.trie=function(p){0<arguments.length&&(q=p);return q};this.caseSensitive=function(){return!l};this.fieldNames=function(){return m};this.fieldDelim=function(){return n};
this.distinguishingFieldsArray=function(){return r}}})();function TermsRadio(a){this.parent=a.parent;this.container=a.container;this.isSliderVisible=void 0==a.showSlider?!0:a.showSlider;this.chart=null;this.absMinFreq=this.absMaxFreq=0;this.allData=[];this.continueTransition=!0;this.counterSeries=[];this.displayData=[];this.isTransitioning=this.dragged=!1;this.lastSticky=this.lastSlippery=null;this.maxFont=30;this.numDataPoints=this.minFreq=0;this.numVisPoints=5;this.overlayQueue=[];this.recordsLength=this.records=0;this.reselectTop=!1;this.sliderDragSum=
this.shiftCount=0;this.titlesArray=[];this.transitionCall="draw";this.valFraction=1;this.win=0;this.bPadding=25;this.lPadding=40;this.rPadding=20;this.tPadding=10;this.sliderHeightRatio=.1;this.sliderHeight=0;this.sliderBPadding=10;this.largestH=this.largestW=0;this.xAxisEl=void 0;this.xAxis=d3.axisBottom();this.xScale=d3.scaleLinear();this.xSliderScale=d3.scaleLinear();this.yAxisEl=void 0;this.yAxis=d3.axisLeft();this.yScale=d3.scaleLinear();this.ySliderScale=d3.scaleLinear();this.fontScale=d3.scaleLinear();
this.opacityScale=d3.scaleLinear();this.container.on("resize",this.doResize,this)}
TermsRadio.prototype={constructor:TermsRadio,loadRecords:function(a){this.initData(a);this.prepareData();for(a=this.shiftCount;0<a--;)this.displayData.shift();null!=this.chart?this.redraw():this.initializeChart()},highlightQuery:function(a,b){var c=null;"document"===this.parent.getApiParam("mode")&&(c=this.parent.getCorpus().getDocument(0).getId());a=this.buildParamsBundle({wordString:a,docId:c});b?this.manageOverlaySticky(a):this.manageOverlaySlippery(a)},highlightRecord:function(a,b){a={wordString:a.get("term"),
docId:a.get("docId")};a=this.buildParamsBundle(a);b?this.manageOverlaySticky(a):this.manageOverlaySlippery(a)},initData:function(a){this.records=a;this.recordsLength=this.records.length;this.numVisPoints=parseInt(this.parent.getApiParam("visibleBins"));this.shiftCount=parseInt(this.parent.getApiParam("position"));"document"===this.parent.getApiParam("mode")?(this.numDataPoints=this.records[0].get("distributions").length,a=parseInt(this.parent.getApiParam("bins")),this.numDataPoints!==a&&(this.numDataPoints=
a,this.loadStore())):this.numDataPoints=this.records[0].get("distributions").length;this.counterSeries=[];a=[];for(var b=this.absMaxFreq=0;b<this.numDataPoints;b++)for(var c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]>this.absMaxFreq&&(this.absMaxFreq=this.records[c].get("distributions")[b]);this.absMinFreq=this.absMaxFreq;for(b=0;b<this.numDataPoints;b++)for(c=0;c<this.recordsLength;c++)this.records[c].get("distributions")[b]<=this.absMinFreq&&0!==this.records[c].get("distributions")[b]&&
(this.absMinFreq=this.records[c].get("distributions")[b]);0>this.absMinFreq&&(this.absMinFreq=0);this.minFreq=1.01*this.absMinFreq;for(b=0;b<this.numDataPoints;b++){for(c=0;c<this.recordsLength;c++){var d=this.records[c],e=d.get("distributions")[b];0<e&&a.push({freq:e,wordString:d.get("term"),counter:b,posInSeries:0,numInSeries:0,docId:d.get("docId")})}this.counterSeries.push(a);a=[]}},prepareData:function(){var a=[],b=[],c=[],d=[];this.allData=[];this.displayData=[];this.numDataPoints<this.numVisPoints&&
(this.numVisPoints=this.numDataPoints);this.shiftCount+this.numVisPoints>this.numDataPoints&&(this.shiftCount=this.numDataPoints-this.numVisPoints);for(var e=0;e<this.numDataPoints;e++){for(var f=0,g=0;g<this.counterSeries[e].length;g++){var h=0;0===f&&(b.push(this.counterSeries[e][g]),c.push({freq:this.counterSeries[e][g].freq,frequencyArray:b,numInSeries:0}),a.push(c),b=[],c=[],h=f=1);for(var k=0;k<a[e].length&&0===h;k++)this.counterSeries[e][g].freq===a[e][k].freq&&(h=a[e][k].numInSeries,this.counterSeries[e][g].posInSeries=
++h,a[e][k].numInSeries=h,a[e][k].frequencyArray.push(this.counterSeries[e][g]),h=1);0===h&&(d.push(this.counterSeries[e][g]),a[e].push({freq:this.counterSeries[e][g].freq,frequencyArray:d,numInSeries:0}),d=[])}(1>this.counterSeries[e].length||0===f)&&a.push([])}for(e=0;e<this.numDataPoints;e++)for(g=0;g<a[e].length;g++)for(++a[e][g].numInSeries,k=0;k<a[e][g].frequencyArray.length;k++)a[e][g].frequencyArray[k].numInSeries=a[e][g].numInSeries;for(e=0;e<this.numDataPoints;e++)this.allData.push({allDataInternal:a[e],
outerCounter:e});a=[];b=[];for(e=0;e<this.numVisPoints+this.shiftCount;e++){for(g=0;g<this.recordsLength;g++)this.allData[e].allDataInternal[g]&&b.push({freq:this.allData[e].allDataInternal[g].freq,inSeries:this.allData[e].allDataInternal[g].numInSeries,frequencyArray:this.allData[e].allDataInternal[g].frequencyArray,dotObject:[{counter:e,freq:this.allData[e].allDataInternal[g].freq}]});a.push(b);b=[]}for(e=0;e<this.numVisPoints+this.shiftCount;e++)this.displayData.push({displayInternal:a[e],outerCounter:e})},
manageMvtButtons:function(){this.parent.queryById("play").setPlaying(this.isTransitioning)},nextR:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.numVisPoints+
this.shiftCount,freq:this.allData[this.numVisPoints+this.shiftCount].allDataInternal[b].freq}]});this.displayData.push({displayInternal:a,outerCounter:this.numVisPoints+this.shiftCount})},toggleRightCheck:function(){this.numVisPoints+this.shiftCount<this.numDataPoints?(this.continueTransition=this.isTransitioning=!0,this.manageMvtButtons(),this.nextR(),this.shiftCount=++this.shiftCount,this.manageXScale(),this.parent.setApiParams({position:this.shiftCount}),this.transitionCall="right",this.animateVis(),
this.displayData.shift()):(this.continueTransition=this.isTransitioning=!1,this.manageMvtButtons())},nextL:function(){for(var a=[],b=0;b<this.recordsLength;b++)this.allData[this.shiftCount].allDataInternal[b]&&a.push({freq:this.allData[this.shiftCount].allDataInternal[b].freq,inSeries:this.allData[this.shiftCount].allDataInternal[b].numInSeries,frequencyArray:this.allData[this.shiftCount].allDataInternal[b].frequencyArray,dotObject:[{counter:this.shiftCount,freq:this.allData[this.shiftCount].allDataInternal[b].freq}]});
this.displayData.unshift({displayInternal:a,outerCounter:this.shiftCount})},startScroll:function(){var a=this;a.numDataPoints>a.numVisPoints&&0===a.shiftCount&&(a.isTransitioning=!0,this.manageMvtButtons(),setTimeout(function(){a.toggleRightCheck()},3E3))},initializeChart:function(){this.initChart();this.drawXAxis();this.drawYAxis();this.drawChart();this.isSliderVisible&&(this.drawSlider(),this.drawVerticalSlider(),this.redrawSliderOverlay());this.transitionCall="draw"},redraw:function(){this.transitionCall=
"redraw";this.updateFullPath();this.redrawXAxis();this.redrawYAxis();this.redrawChart();this.isSliderVisible&&(this.redrawSlider(),this.redrawVerticalSlider(),this.redrawSliderOverlay());this.redrawChartOverlay()},initChart:function(){var a=this.container.getHeight(),b=this.container.getWidth(),c=Ext.DomHelper.append(this.container.down("div[class$=innerCt]"),'<svg class="chart" width="'+b+'" height="'+a+'"></svg>');this.chart=d3.select(c);this.setSliderHeight();this.largestW=b;this.largestH=a-this.getSliderHeight();
a=this.tPadding+this.getSliderHeight();this.chart.append("clipPath").attr("id","clip1").append("rect").attr("class","clipping-rectangle").attr("x",0).attr("y",a).attr("width",b).attr("height",this.largestH);this.chart.append("g").attr("class","overlay").attr("clip-path","url(#clip1)");this.setTitleLength()},doResize:function(){if(this.chart){var a=this.container.getHeight(),b=this.container.getWidth();this.setSliderHeight();this.largestH=a-this.getSliderHeight();this.largestW=b;this.chart.attr("height",
a).attr("width",b);this.setTitleLength();this.chart.select("rect[class=clipping-rectangle]").attr("x",0).attr("y",this.tPadding+this.getSliderHeight()).attr("width",b).attr("height",this.largestH);this.redraw()}},drawXAxis:function(){var a=this,b=this.container.getHeight();this.container.getWidth();this.manageAllXScales();this.xAxis=d3.axisBottom(a.xScale).ticks(Math.round(a.numVisPoints)).tickFormat(function(c){var d;"document"===a.parent.getApiParam("mode")&&(d="Segment "+(parseInt(c)+1));"corpus"===
a.parent.getApiParam("mode")&&(d=c+1+". "+a.titlesArray[c]);return d});this.xAxisEl=this.chart.append("g").attr("class","axisX").attr("transform","translate(0,"+(b-this.bPadding)+")").call(this.xAxis);this.styleXAxis()},styleXAxis:function(){this.xAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.xAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges");this.xAxisEl.selectAll("path").style("fill","none").style("stroke",
"black").style("shape-rendering","crispEdges")},redrawXAxis:function(){this.chart.selectAll("g[class=axisX]").remove();this.drawXAxis()},drawYAxis:function(){var a=this.container.getHeight(),b=this.container.getWidth();this.manageAllYScales();var c=d3.scaleLinear().domain([200,700]).range([5,15]),d=d3.format(".2r");this.yAxis=d3.axisLeft(this.yScale).ticks(c(a)).tickFormat(function(e){var f=Math.log(e)/Math.log(10)+1E-6;return.7>Math.abs(f-Math.floor(f))?d(e):""}).tickSize(-b+this.rPadding+this.lPadding);
this.yAxisEl=this.chart.append("g").attr("class","axisY").attr("transform","translate("+this.lPadding+",0)").call(this.yAxis);this.yAxisEl.selectAll("text").style("font-family","sans-serif").style("font-size","11px");this.yAxisEl.selectAll("line").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges").style("stroke-opacity",.05);this.yAxisEl.selectAll("path").style("fill","none").style("stroke","black").style("shape-rendering","crispEdges")},redrawYAxis:function(){this.chart.selectAll("g[class=axisY]").remove();
this.drawYAxis()},drawChart:function(){var a=this;this.chart.selectAll("g[class=section]").data(a.displayData,function(b){return b.outerCounter}).enter().append("g").attr("class","section").attr("clip-path","url(#clip1)").selectAll("g").data(function(b){return b.displayInternal}).enter().append("g").attr("class","frequencies").on("mouseover",function(){d3.select(this).style("fill","red")}).on("mouseout",function(){d3.select(this).style("fill","black")}).selectAll("text").data(function(b){return b.frequencyArray}).enter().append("text").attr("class",
function(b){return a.removeFilteredCharacters(b.wordString)}).attr("x",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/b.numInSeries*.8;b=b.counter+a.callOffset()+c+d;return a.xScale(b)}).attr("y",function(b){return a.yScale(b.freq)}).attr("text-anchor","middle").attr("transform",function(b){var c=.5/b.numInSeries-.5,d=b.posInSeries/b.numInSeries*.8;c=b.counter+a.callOffset()+c+d;b=b.freq;return"translate(0, 0) rotate(-20 "+a.xScale(c)+" "+a.yScale(b)+")"}).style("font-size",function(b){return a.fontScale(b.freq)+
"px"}).style("fill-opacity",function(b){return a.opacityScale(b.freq)}).text(function(b){return b.wordString}).on("mouseover",function(b){d3.select(this).style("cursor","pointer").style("font-size",function(c){return a.fontScale(c.freq)*a.maxFont/a.fontScale(c.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("mouseout",function(b){d3.select(this).style("cursor","auto").style("font-size",function(c){return a.fontScale(c.freq)+"px"});b=a.buildParamsBundle(b);a.manageOverlaySlippery(b)}).on("click",
function(b){b=a.buildParamsBundle(b);a.manageOverlaySticky(b)}).append("title").text(function(b){return b.wordString})},redrawChart:function(){this.chart.selectAll("g[class=section]").remove();this.drawChart()},drawVerticalSlider:function(){},redrawVerticalSlider:function(){this.chart.selectAll("rect[class=minimap]").remove();this.drawVerticalSlider()},drawSlider:function(){this.container.getHeight();var a=this.container.getWidth()-(this.rPadding+this.lPadding),b=this.lPadding,c=this.lPadding+(this.numVisPoints-
1)/(this.numDataPoints-1)*a;this.chart.append("line").attr("class","slider axis").attr("x1",this.lPadding).attr("x2",this.container.getWidth()-this.rPadding).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding+this.sliderHeight).style("shape-rendering","crispEdges").style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider axis").attr("x1",this.lPadding).attr("x2",this.lPadding).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("shape-rendering",
"crispEdges").style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider").attr("id","before").attr("x1",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+b).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");this.chart.append("line").attr("class","slider").attr("id","after").attr("x1",a*(this.shiftCount-this.callOffset())/
(this.numDataPoints-1)+c).attr("x2",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y1",this.tPadding+this.sliderHeight).attr("y2",this.tPadding).style("stroke","black").style("stroke-width","1");b=this.chart.append("rect").attr("class","slider").attr("id","boxBefore").attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.sliderHeight).attr("width",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor",
"move");a=this.chart.append("rect").attr("class","slider").attr("id","boxAfter").attr("x",a*(this.shiftCount-this.callOffset())/(this.numDataPoints-1)+c).attr("y",this.tPadding).attr("height",this.sliderHeight).attr("width",a*(this.numDataPoints-this.numVisPoints-this.shiftCount+this.callOffset())/(this.numDataPoints-1)).style("fill","silver").style("fill-opacity",.25).style("cursor","move");var d=this;c=d3.drag().on("drag",function(e){if(!d.isTransitioning){this.drag=!0;e=d.parent.getWidth();var f=
parseInt(d3.event.dx),g,h;d.sliderDragSum+=d3.event.dx;d.chart.selectAll("#before").attr("x1",function(){g=parseInt(this.getAttribute("x1"));parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});d.chart.selectAll("#after").attr("x1",function(){h=parseInt(this.getAttribute("x1"));return parseInt(this.getAttribute("x1"))});if(g+f<d.lPadding||h+f>e-d.rPadding)f=0;d.chart.select("#boxBefore").attr("width",function(){return parseInt(this.getAttribute("width"))+f});d.chart.select("#boxAfter").attr("x",
function(){return parseInt(this.getAttribute("x"))+f}).attr("width",function(){return Math.max(0,parseInt(this.getAttribute("width"))-f)});d.chart.selectAll("#before").attr("x1",function(){return parseInt(this.getAttribute("x1"))+f}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+f});d.chart.selectAll("#after").attr("x1",function(){return parseInt(this.getAttribute("x1"))+f}).attr("x2",function(){return parseInt(this.getAttribute("x2"))+f})}}).on("end",function(e){if(this.drag){this.drag=
!1;e=d3.scaleLinear().domain([0,d.container.getWidth()-(d.lPadding+d.rPadding)]).range([0,d.numDataPoints])(d.sliderDragSum);var f,g=d.shiftCount;0<e&&(f=Math.floor(e));0>e&&(f=Math.ceil(e));d.shiftCount+=f;0>d.shiftCount&&(d.shiftCount=0);d.shiftCount>d.numDataPoints-1&&(d.shiftCount=d.numDataPoints-1);d.shiftCount!==g&&(d.sliderDragSum=0,d.parent.setApiParams({position:d.shiftCount}),d.prepareData(),d.redraw())}});b.call(c);a.call(c)},removeSlider:function(a){this.chart.selectAll("rect[class=slider]").remove();
this.chart.selectAll("line[class~=slider]").remove();a&&this.chart.selectAll("g[class=slider]").remove()},redrawSlider:function(){this.removeSlider();this.drawSlider()},animateVis:function(){var a=this;this.parent.getApiParam("mode");this.container.getHeight();var b=this.container.getWidth(),c=this.getDuration();if("left"===this.transitionCall||"right"===this.transitionCall){this.xAxisEl.transition().duration(c).ease(d3.easeLinear).call(this.xAxis);this.styleXAxis();this.drawChart();this.chart.selectAll(".frequencies").transition().duration(c).ease(d3.easeLinear).selectAll("text").attr("x",
function(f){return a.xScale(f.counter+(.5/f.numInSeries-.5)+f.posInSeries/f.numInSeries*.8)}).attr("transform",function(f){var g=f.freq;return"translate(0, 0) rotate(-20 "+a.xScale(f.counter+(.5/f.numInSeries-.5)+f.posInSeries/f.numInSeries*.8)+" "+a.yScale(g)+")"});b-=this.rPadding+this.lPadding;var d=this.lPadding,e=this.lPadding+(this.numVisPoints-1)/(this.numDataPoints-1)*b;this.chart.select("#before").transition().duration(c).ease(d3.easeLinear).attr("x1",b*this.shiftCount/(this.numDataPoints-
1)+d).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+d).attr("y1",this.tPadding+this.getSliderHeight()).attr("y2",this.tPadding).on("end",function(){a.parent.isMasked()&&a.parent.unmask();a.continueTransition?setTimeout(function(){a.callTransition()},50):(a.isTransitioning=!1,a.manageMvtButtons())});this.chart.select("#after").transition().duration(c).ease(d3.easeLinear).attr("x1",b*this.shiftCount/(this.numDataPoints-1)+e).attr("x2",b*this.shiftCount/(this.numDataPoints-1)+e).attr("y1",this.tPadding+
this.getSliderHeight()).attr("y2",this.tPadding);this.chart.select("#boxBefore").transition().duration(c).ease(d3.easeLinear).attr("x",this.lPadding).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",b*this.shiftCount/(this.numDataPoints-1));this.chart.select("#boxAfter").transition().duration(c).ease(d3.easeLinear).attr("x",b*this.shiftCount/(this.numDataPoints-1)+e).attr("y",this.tPadding).attr("height",this.getSliderHeight()).attr("width",b*(this.numDataPoints-this.numVisPoints-
this.shiftCount)/(this.numDataPoints-1))}this.redrawChartOverlay()},callTransition:function(){"left"===this.transitionCall&&this.toggleLeftCheck();"right"===this.transitionCall&&this.toggleRightCheck()},buildParamsBundle:function(a){var b=a.wordString,c={};if("document"===this.parent.getApiParam("mode")){a=a.docId;var d=this.parent.getCorpus().getDocument(a).get("totalTokens")-1;c.tokenIdStart=parseInt(this.category*d/this.numDataPoints);c.docIdType=a+":"+b}return{params:c,type:b}},manageOverlaySlippery:function(a){for(var b=
a.type,c=this.removeFilteredCharacters(a.type),d="on",e=this.overlayQueue.length;0<=--e;)c===this.overlayQueue[e].selector&&(d="off");c===this.lastSticky&&(d="off",this.lastSticky=null);"on"===d&&(c!==this.lastSlippery?(d=this.prepareFullPath(b),a={word:b,selector:c,params:a,fullPath:d.path,pathMin:d.min,pathMax:d.max,colour:"red"},null!==this.lastSlippery&&(this.chartOverlayOff(this.lastSlippery),this.isSliderVisible&&this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null),this.chartOverlayOn(a),
this.isSliderVisible&&this.sliderOverlayOn(a),this.lastSlippery=c):(this.chartOverlayOff(c),this.isSliderVisible&&this.sliderOverlayOff(this.lastSlippery),this.lastSlippery=null))},manageOverlaySticky:function(a){a=a.type;this.transitionCall="draw";this.isTermSelected(a)?this.doTermDeselect(a,!0):this.doTermSelect(a,!0)},getTermIndex:function(a){var b=-1;a=a=this.removeFilteredCharacters(a);for(var c=this.overlayQueue.length;0<=--c;)a===this.overlayQueue[c].selector&&(b=c);return b},isTermSelected:function(a){return-1!==
this.getTermIndex(a)},doTermSelect:function(a,b){var c=c=this.removeFilteredCharacters(a),d=this.parent.getApiParam("selectedWords");d.push(a);this.parent.setApiParams({selectedWords:d});d=this.parent.getApplication().getColorForTerm(a,!0);if(!0===b)b=this.parent.query("[xtype=legend]")[0],b.getStore().add({name:a,mark:d});else{b=this.parent.query("[xtype=legend]")[0];var e=b.getStore().findRecord("name",a);null!==e&&(e.set("mark",d),b.refresh())}b=this.prepareFullPath(a);a={word:a,selector:c,params:{params:{},
type:a},fullPath:b.path,pathMin:b.min,pathMax:b.max,colour:d};c===this.lastSlippery&&(this.isSliderVisible&&this.sliderOverlayOff(c),this.lastSlippery=null);this.chart.select("g[class=frequency-line-"+c.replace(/'/g,"\\'")+"]").remove();this.overlayQueue.push(a);this.chartOverlayOn(a);this.isSliderVisible&&this.sliderOverlayOn(a)},doTermDeselect:function(a,b){var c=this.removeFilteredCharacters(a),d=this.getTermIndex(a);!0===b&&(b=this.parent.query("[xtype=legend]")[0],d=b.getStore().findExact("name",
a),b.getStore().removeAt(d));a=this.parent.getApiParam("selectedWords");b=0;for(var e=a.length;b<e;b++)a[b]===c&&(a.splice(b,1),this.parent.setApiParams({selectedWords:a}));this.chartOverlayOff(c);this.overlayQueue.splice(d,1);this.isSliderVisible&&this.sliderOverlayOff(c);this.lastSticky=c},prepareFullPath:function(a){for(var b=[],c=this.absMaxFreq,d=this.absMinFreq,e=0,f=this.allData.length;e<f;e++){for(var g=foundB=0,h=this.allData[e].allDataInternal.length;g<h;g++)for(var k=0,l=this.allData[e].allDataInternal[g].frequencyArray.length;k<
l;k++)if(this.allData[e].allDataInternal[g].frequencyArray[k].wordString===a){var m=this.allData[e].allDataInternal[g].frequencyArray[k].freq;b.push({x:e,y:m});m<c&&(c=m);m>d&&(d=m);foundB=1}0===foundB&&(g=this.minFreq,b.push({x:e,y:g}),g<c&&(c=g),g>d&&(d=g))}return{path:b,min:c,max:d}},updateFullPath:function(){for(var a=this.overlayQueue.length;0<a--;){var b=this.prepareFullPath(this.overlayQueue[a].word);this.overlayQueue[a].fullPath=b.path;this.overlayQueue[a].pathMin=b.min;this.overlayQueue[a].pathMax=
b.max}},buildSliderPath:function(a){var b=this;return d3.line().x(function(c){return b.xSliderScale(c.x)}).y(function(c){return b.ySliderScale(c.y)}).curve(d3.curveNatural)(a)},sliderOverlayOn:function(a){this.transitionSliderOverlay(a);this.chart.append("g").attr("class","slider").attr("id","slider-line-"+a.word).append("path").attr("d",this.buildSliderPath(a.fullPath)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");this.redrawSlider()},sliderOverlayOff:function(a){this.chart.selectAll("g[id=slider-line-"+
a.replace(/'/g,"\\'")+"]").remove();this.transitionSliderOverlay()},redrawSliderOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.sliderOverlayOff(this.overlayQueue[a].selector),this.sliderOverlayOn(this.overlayQueue[a])},transitionSliderOverlay:function(a){this.updateYSliderScale(a||0);for(a=this.overlayQueue.length;0<a--;)this.chart.selectAll("g#slider-line-"+this.overlayQueue[a].selector.replace(/'/g,"\\'")).select("path").transition().duration(300).ease(d3.easeLinear).attr("d",
this.buildSliderPath(this.overlayQueue[a].fullPath))},preparePath:function(a){for(var b=[],c,d,e=0;3>e&&0<this.shiftCount-e;e++){for(var f=c=0;f<this.allData[this.shiftCount-(1+e)].allDataInternal.length;f++)for(var g=0;g<this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray.length;g++)this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray[g].wordString===a&&(c=this.yScale(this.allData[this.shiftCount-(1+e)].allDataInternal[f].frequencyArray[g].freq),b.unshift({x:this.shiftCount-
(1+e),y:c}),c=1);0===c&&(f=this.yScale(this.minFreq),b.unshift({x:this.shiftCount-(1+e),y:f}))}e=this.shiftCount;for(c=this.numVisPoints+this.shiftCount;e<c;e++){f=d=0;for(var h=this.allData[e].allDataInternal.length;f<h;f++){g=0;for(var k=this.allData[e].allDataInternal[f].frequencyArray.length;g<k;g++)this.allData[e].allDataInternal[f].frequencyArray[g].wordString===a&&(d=this.yScale(this.allData[e].allDataInternal[f].frequencyArray[g].freq),b.push({x:e,y:d}),d=1)}0===d&&(f=this.yScale(this.minFreq),
b.push({x:e,y:f}))}for(e=0;3>e&&this.numVisPoints+this.shiftCount+e<this.numDataPoints;e++){for(f=c=0;f<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal.length;f++)for(g=0;g<this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray.length;g++)this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].wordString===a&&(d=this.yScale(this.allData[this.numVisPoints+this.shiftCount+e].allDataInternal[f].frequencyArray[g].freq),b.push({x:this.numVisPoints+
this.shiftCount+e,y:d}),c=1);0===c&&(f=this.yScale(this.minFreq),b.push({x:this.numVisPoints+this.shiftCount+e,y:f}))}return b},chartOverlayOn:function(a){var b=this;this.chart.selectAll("g[class=section]").selectAll("g[class=frequencies]").selectAll("text[class="+a.selector.replace(/'/g,"\\'")+"]").style("fill",a.colour).style("fill-opacity",1);var c=this.preparePath(a.word),d,e=d3.line().x(function(f){d=f.x;return b.xScale(f.x+b.callOffset())}).y(function(f){return f.y}).curve(d3.curveNatural);
a=this.chart.select(".overlay").append("g").attr("class","frequency-line-"+a.selector).append("path").attr("d",e(c)).style("stroke",a.colour).style("stroke-width",2).style("fill","none");c=this.xScale(d)-this.xScale(d+this.callOffset());"left"!==this.transitionCall&&"right"!==this.transitionCall||a.transition().duration(b.getDuration()).ease(d3.easeLinear).attr("transform","translate("+c+")")},chartOverlayOff:function(a){var b=this;this.chart.selectAll("text."+a.replace(/'/g,"\\'")).style("fill",
"black").style("fill-opacity",function(c){return b.opacityScale(c.freq)});this.chart.select("g.frequency-line-"+a.replace(/'/g,"\\'")).remove()},redrawChartOverlay:function(){for(var a=0;a<this.overlayQueue.length;a++)this.chartOverlayOff(this.overlayQueue[a].selector),this.chartOverlayOn(this.overlayQueue[a])},manageAllYScales:function(){this.manageFontScale();this.manageOpacityScale();this.manageYScale();this.manageYSliderScale()},manageFontScale:function(){this.fontScale.domain([this.minFreq,this.absMaxFreq*
this.valFraction]).range([10,this.maxFont])},manageOpacityScale:function(){this.opacityScale.domain([0,this.absMaxFreq*this.valFraction]).range([.4,.8])},manageYScale:function(){"linear"==this.parent.getApiParam("yAxisScale")&&(this.yScale=d3.scaleLinear());"log"==this.parent.getApiParam("yAxisScale")&&(this.yScale=d3.scaleLog());this.yScale.domain([this.minFreq,this.absMaxFreq*this.valFraction*1.25]).rangeRound([this.container.getHeight()-this.bPadding,this.tPadding+this.getSliderHeight()])},manageYSliderScale:function(){var a=
this.tPadding,b=this.tPadding+this.getSliderHeight();"linear"==this.parent.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scaleLinear());"log"==this.parent.getApiParam("yAxisScale")&&(this.ySliderScale=d3.scaleLog());this.ySliderScale.domain([this.minFreq,this.absMaxFreq]).rangeRound([b,a])},updateYSliderScale:function(a){a=a||0;for(var b=this.minFreq,c=0,d=this.overlayQueue.length;0<d--;)this.overlayQueue[d].pathMin<b&&(b=this.overlayQueue[d].pathMin),this.overlayQueue[d].pathMax>c&&(c=this.overlayQueue[d].pathMax);
0!=a&&a.pathMin<b&&(b=a.pathMin);0!=a&&a.pathMax>c&&(c=a.pathMax);this.ySliderScale.domain([b,c])},manageAllXScales:function(){this.manageXScale();this.manageXSliderScale()},manageXScale:function(){this.xScale.domain([this.shiftCount-.5,this.numVisPoints+this.shiftCount-.5]).range([this.lPadding,this.container.getWidth()-this.rPadding])},manageXSliderScale:function(){this.xSliderScale.domain([0,this.numDataPoints-1]).range([this.lPadding,this.container.getWidth()-this.rPadding])},getSliderHeight:function(){return this.isSliderVisible?
this.sliderHeight+this.sliderBPadding:0},setSliderHeight:function(){this.sliderHeight=Math.max(10,this.container.getHeight()*this.sliderHeightRatio)},hideSlider:function(){this.isSliderVisible=!1;this.removeSlider(!0);this.doResize()},showSlider:function(){this.isSliderVisible=!0;this.doResize()},setTitleLength:function(){this.titlesArray=[];for(var a=d3.scaleLinear().domain([350,1250]).range([10,40]),b=this.parent.getCorpus(),c=0,d=b.getDocumentsCount();c<d;c++){var e=b.getDocument(c);e=e.getShortTitle();
e.length<=a(this.container.getWidth())?this.titlesArray.push(e):(e=e.substring(0,a(this.container.getWidth())-3),this.titlesArray.push(e+"..."))}},callOffset:function(){if("draw"===this.transitionCall||"redraw"===this.transitionCall)var a=0;"left"===this.transitionCall&&(a=-1);"right"===this.transitionCall&&(a=1);return a},removeFilteredCharacters:function(a){return a||""},getDuration:function(){return this.numDataPoints*(100-this.parent.getSpeed())}};Ext.define("Voyant.util.Assignable",{transferable:["assign"],assign:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);Ext.isString(a)?window[a]=this:Voyant.application.showError("The 'assign' method expects a string argument. ("+typeof a+") "+a);return this}});Ext.define("Voyant.util.Api",{constructor:function(a){var b=[];if(!this.isApplication){var c=this.getApplication?this.getApplication():Voyant.application;if(this.mixins)for(e in this.mixins){var d=Ext.ClassManager.get(e);d&&d.api&&b.splice(0,0,d.api)}this.addParentApi(b,Ext.ClassManager.getClass(c));c.getApiParams&&b.push(c.getApiParams())}this.addParentApi(b,Ext.ClassManager.getClass(this));this.api={};b.forEach(function(f){for(e in f)this.api[e]={initial:f[e],value:f[e]}},this);b=Ext.Object.fromQueryString(document.location.search);
c=this.getXType?this.getXType():void 0;for(var e in b)this.api[e]?this.setApiParam(e,b[e]):c&&0<e.indexOf(".")&&(d=e.substring(e.indexOf(".")+1))&&d in this.api&&this.setApiParam(d,b[e]);if(a&&Ext.isObject(a.api)){for(e in a.api)this.api[e]&&this.setApiParam(e,a.api[e]);delete a.api}b.type&&"query"in this.api&&!this.getApiParam("query")&&this.setApiParam("query",b.type)},addParentApi:function(a,b){b.api&&a.splice(0,0,b.api);b.superclass&&this.addParentApi(a,b.superclass.self)},getApiParam:function(a,
b){return void 0!==this.api[a]?this.api[a].value:b},getApiParams:function(a,b){a=a||Object.keys(this.api);var c={};Ext.isString(a)&&(a=[a]);a.forEach(function(d){var e=this.getApiParam(d);if(b||!Ext.isEmpty(e))c[d]=e},this);return c},getModifiedApiParams:function(){var a={},b;for(b in this.api)this.api[b].initial!=this.api[b].value&&(a[b]=this.api[b].value);return a},setApiParams:function(a){for(var b in a)this.setApiParam(b,a[b])},setApiParam:function(a,b){this.api&&this.api[a]&&(this.api[a].value=
b)}});Ext.define("Voyant.util.Localization",{statics:{DEFAULT_LANGUAGE:"en",LANGUAGE:"en",i18n:{}},languageStore:Ext.create("Ext.data.ArrayStore",{fields:["code","language"],data:[["en","English"]]}),getLanguage:function(a){var b=this.languageStore.findRecord(2==a.length?"code":"language",a);if(b)return b.get(2==a.length?"language":"code")},localize:function(a,b){return this._localizeObject(this,a,b)},_localizeObject:function(a,b,c){var d=this._localizeClass(Ext.ClassManager.getClass(a),b,c);if(d)return d;
if(a.mixins)for(mixin in a.mixins)if(d=this._localizeClass(Ext.ClassManager.getClass(a.mixins[mixin]),b,c))return d;return a.superclass&&(d=this._localizeObject(a.superclass,b,c))?d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"},_localizeClass:function(a,b,c){if(a&&a.i18n&&a.i18n[b]){var d=!1;a.i18n[b]&&(d=a.i18n[b]);return d?d.isTemplate?d.apply(c):d:c&&void 0!=c["default"]?c["default"]:"["+b+"]"}return!1},getLanguageToolMenu:function(){return{type:"language",tooltip:this.localize("languageTitle"),
xtype:"toolmenu",glyph:"xf1ab@FontAwesome",handler:this.showLanguageOptions,scope:this}},showLanguageOptions:function(){var a=this,b="ar bs cz de en es fr he hr it ja pt sr".split(" ").map(function(c){return{text:this.localize(c),value:c}},this);b.sort(function(c,d){return c.text.localeCompare(d.text)});b.splice(0,0,{text:this.localize("autoRecommended"),value:""});(new Ext.window.Window({title:this.localize("languageTitle"),modal:!0,items:{xtype:"form",items:[{xtype:"combo",name:"lang",value:this.getApiParam("lang")||
"",queryMode:"local",editable:!1,fieldLabel:this.localize("chooseLanguage"),width:450,labelAlign:"right",labelWidth:150,displayField:"text",valueField:"value",store:{fields:["text","value"],data:b}}],buttons:[{text:this.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(c){c.up("window").close()}},{text:this.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(c){var d=c.up("form");if(d.isDirty()){var e=a.getApplication(),f=e.getModifiedApiParams();
e.getCorpus()?f.corpus=e.getCorpus().getAliasOrId():delete f.panels;delete f.lang;d=d.getValues();d.lang&&(f.lang=d.lang);location.assign("./?"+Ext.Object.toQueryString(f))}c.up("window").close()},scope:a}]},bodyPadding:5})).show()}});Ext.define("Voyant.util.Colors",{config:{palettes:void 0,colorTermAssociations:void 0},constructor:function(a){this.setPalettes({"default":[[0,0,255],[51,197,51],[255,0,255],[121,51,255],[28,255,255],[255,174,0],[30,177,255],[182,242,58],[255,0,164],[51,102,153],[34,111,52],[155,20,104],[109,43,157],[128,130,33],[111,76,10],[119,115,165],[61,177,169],[202,135,115],[194,169,204],[181,212,228],[182,197,174],[255,197,197],[228,200,124],[197,179,159]]});this.resetColorTermAssociations();if(void 0!==d3){a=
d3.scaleOrdinal(d3.schemeCategory10).range().map(function(e){return this.hexToRgb(e)},this);var b=d3.scaleOrdinal(d3.schemeCategory20).range().map(function(e){return this.hexToRgb(e)},this),c=d3.scaleOrdinal(d3.schemeCategory20b).range().map(function(e){return this.hexToRgb(e)},this),d=d3.scaleOrdinal(d3.schemeCategory20c).range().map(function(e){return this.hexToRgb(e)},this);this.addColorPalette("d3_cat10",a);this.addColorPalette("d3_cat20a",b);this.addColorPalette("d3_cat20b",c);this.addColorPalette("d3_cat20c",
d)}a=Ext.create("Ext.chart.theme.Base").getColors().map(function(e){return this.hexToRgb(e)},this);this.addColorPalette("extjs",a)},resetColorTermAssociations:function(){this.setColorTermAssociations(new Ext.util.MixedCollection)},rgbToHex:function(a){return"#"+(16777216+(a[0]<<16)+(a[1]<<8)+a[2]).toString(16).slice(1)},hexToRgb:function(a){a=a.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(b,c,d,e){return c+c+d+d+e+e});return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?[parseInt(a[1],
16),parseInt(a[2],16),parseInt(a[3],16)]:null},addColorPalette:function(a,b){this.getPalettes()[a]=b},getColorPalette:function(a,b){a=a||"default";a=this.getPalettes()[a];void 0===a&&(a=[]);if(b){b=[];for(var c=0;c<a.length;c++)b.push(this.rgbToHex(a[c]));return b}return a},getColor:function(a,b,c){a=a||"default";a=this.getPalettes()[a];b>=a.length&&(b%=a.length);return c?this.rgbToHex(a[b]):a[b]},getColorForTerm:function(a,b,c){a=a||"default";a=this.getPalettes()[a];-1!=b.indexOf(":")&&(b=b.split(":")[1]);
var d=this.getColorTermAssociations().get(b);null==d&&(d=this.getColorTermAssociations().getCount()%a.length,d=a[d],this.getColorTermAssociations().add(b,d));c&&(d=this.rgbToHex(d));return d},setColorForTerm:function(a,b){!1===Array.isArray(b)&&(b=this.hexToRgb(b));this.getColorTermAssociations().replace(a,b)}});Ext.define("Voyant.util.Deferrable",{deferredStack:[],releaseAllDeferred:function(){this.deferredStack=[]},getDeferredCount:function(){return this.deferredStack.length},getDeferred:function(a){var b=new Ext.Deferred;a&&a.transfer&&a.transfer(a,b.promise);!b.promise.show&&window.show&&(b.promise.show=show);b.promise.assign||Ext.apply(b.promise,{assign:(new Voyant.util.Assignable).assign});this.deferredStack.push(b);var c=this;b.promise.always(function(){c.deferredStack.pop()});return b},getPromiseFromDeferred:function(a){return"object"===
typeof a.promise?a.promise:a.promise()},getDeferredNestedPromise:function(a,b,c){var d=arguments.callee.caller,e=Voyant.application.getDeferred(c);a.then(function(f){e.resolve(d.apply(f,b))});return e.promise}});Ext.define("Voyant.util.DetailedError",{extend:"Ext.Error",mixins:["Voyant.util.Localization"],config:{msg:void 0,error:void 0,details:void 0},statics:{i18n:{error:"Error"}},constructor:function(a){this.setMsg(a.msg);this.setError(a.error);this.setDetails(a.details);this.callParent(arguments)},show:function(a){window.showError?showError.call(this):this.showMsg(a)},showMsg:function(a){a=a||{};Ext.applyIf(a,{message:this.getMsg()+"<p class='error'>\n"+this.getError()+"\u2026 <a href='#' onclick=\"window.open('').document.write(unescape('<pre>"+
escape(this.getDetails())+"</pre>')); return false;\">more</a></p>",title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)}});Ext.define("Voyant.util.ResponseError",{extend:"Voyant.util.DetailedError",config:{response:void 0},constructor:function(a){this.setResponse(a.response);Ext.applyIf(a,{msg:a.response.statusText,error:"responseText"in a.response?a.response.responseText.split(/(\r\n|\r|\n)/).shift():"",details:"responseText"in a.response?a.response.responseText:""});this.callParent(arguments)}});Ext.define("Voyant.util.SparkLine",{getSparkLine:function(a,b){if(2>a.length)return"";var c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=!1;for(b=0;b<a.length;b++)a[b]<c&&(c=a[b]),a[b]>d&&(d=a[b]),!e&&-1<a[b].toString().indexOf(".")&&(e=!0);var f=(d-c).toString(),g=[];if(e){e=100;for(b=f.indexOf(".")+1;b<f.length;b++)if("0"==f.charAt(b))e*=10;else break;for(b=0;b<a.length;b++)g[b]=parseInt(a[b]*e);d=parseInt(d*e);c=parseInt(c*e)}else{e=1;for(b=f.length-1;-1<b;b--)if("0"==f.charAt(b))e*=10;else break;if(1!=
e){for(b=0;b<a.length;b++)g[b]=a[b]/e;d/=e;c/=e}else g=a}f=Math.floor(1800/((d.toString().length>c.toString().length?d.toString().length:c.toString().length)+1));c="http://chart.apis.google.com/chart?cht=ls&amp;chco=0077CC&amp;chls=1,0,0&amp;chds="+c+","+d;d=Math.ceil(a.length/f);e=0;var h="";a=5>a.length?5:10>a.length?4:20>a.length?3:50>a.length?2:1;for(b=0;b<d;b++){var k=g.slice(e,e+=f);h+="<img style='margin: 0; padding: 0;' border='0' src='"+c+"&amp;chs="+a*k.length+"x15&amp;chd=t:"+k.join(",")+
"' alt='' class='chart-";1==d?h+="full":0<b&&b+1<d?h+"middle":h=0==b?h+"left":h+"right";h+="' />"}return h}});Ext.define("Voyant.util.Toolable",{requires:["Voyant.util.Localization","Voyant.util.Api"],statics:{i18n:{},api:{suppressTools:!1}},constructor:function(a){a=a||{};if(!(this.getApiParam&&"true"==this.getApiParam("suppressTools")||"header"in a&&!1===a.header)){var b=void 0,c=this.up("component");a.moreTools?(b=[],a.moreTools.forEach(function(g){g&&g!=this.xtype&&b.push(this.getMenuItemFromXtype(g))},this)):c&&c.getInitialConfig("moreTools")&&(b=[],c.getInitialConfig("moreTools").forEach(function(g){g&&
g!=this.xtype&&b.push(this.getMenuItemFromXtype(g))},this));b&&this.getApplication().getMoreTools&&b.push({xtype:"menuseparator"});if(this.getApplication().getMoreTools){b=b||[];var d=this.getApplication();c=d.getMoreTools();c.forEach(function(g){var h=[];g.items.forEach(function(k){h.push(this.getMenuItemFromXtype(k))},this);b.push({text:d.localize(g.i18n),glyph:g.glyph,menu:{items:h}})},this)}var e={save:{glyph:"xf08e@FontAwesome",fn:this.exportToolClick,items:void 0},plus:b?{glyph:"xf17a@FontAwesome",
items:b}:void 0,gear:this.showOptionsClick||this.getOptions?{glyph:"xf205@FontAwesome",fn:this.showOptionsClick?this.showOptionsClick:function(g){g.isXType("voyanttabpanel")&&(g=g.getActiveTab());Ext.create("Ext.window.Window",{title:g.localize("optionsTitle"),modal:!0,panel:g,items:{xtype:"form",items:g.getOptions(),listeners:{afterrender:function(h){var k=g.getApiParams(h.getForm().getFields().collect("name"));h.getForm().setValues(k)}},buttons:[{text:g.localize("reset"),glyph:"xf0e2@FontAwesome",
flex:1,panel:g,ui:"default-toolbar",handler:function(h){this.mixins&&this.mixins["Voyant.util.Api"]&&(this.mixins["Voyant.util.Api"].constructor.apply(this),this.getCorpus&&this.getCorpus()&&this.fireEvent("loadedCorpus",this,this.getCorpus()));h.up("window").close()},scope:g},{xtype:"tbfill"},{text:g.localize("cancelTitle"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(h){h.up("window").close()}},{text:g.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,panel:g,handler:function(h){function k(u,
q){m.setApiParam&&m.setApiParam(u,q);for(var p=m.getViewport().query("panel,chart"),v=0;v<p.length;v++)p[v].setApiParam&&p[v].setApiParam(u,q);r=!0}var l=h.up("form").getValues();this.setApiParams(l);var m=this.getApplication(),n=m.getCorpus(),r=!1;void 0!=l.stopList&&void 0!=l.stopListGlobal&&l.stopListGlobal&&k("stopList",l.stopList);void 0!=l.palette&&(m.resetColorTermAssociations(),k("palette",l.palette));void 0!=l.categories&&k("categories",l.categories);r&&(n?m.dispatchEvent("loadedCorpus",
this,n):m.dispatchEvent("apiParamsUpdated",this,l));n?this.fireEvent("loadedCorpus",this,n):this.fireEvent("apiParamsUpdated",this,l);h.up("window").close()},scope:g}]},bodyPadding:5}).show()}}:void 0,help:{glyph:"xf128@FontAwesome",fn:this.helpToolClick}};c=[];if(a.includeTools)for(var f in a.includeTools)"object"==typeof a.includeTools[f]&&c.push(a.includeTools[f]);for(f in e)a.includeTools&&!a.includeTools[f]||!e[f]||c.push({type:f,tooltip:this.localize(f+"Tip"),callback:e[f].fn,xtype:"toolmenu",
glyph:e[f].glyph,items:e[f].items});Ext.apply(this,{tools:c});this.on("afterrender",function(){var g=this.getHeader();if(g&&"Desktop"==Ext.os.deviceType&&!this.isXType("corpuscreator")&&!this.isXType("notebook")){var h=g.getEl();h.on("mouseover",function(){this.getHeader().getTools().forEach(function(k){k.show()})},this);h.on("mouseout",function(){this.getHeader().getTools().forEach(function(k){var l=k.config.type||k.type;l&&"help"!=l&&-1==l.indexOf("collapse")&&k.hide()})},this);g.getTools().forEach(function(k,
l){"help"!=k.config.type&&k.hide()})}},this)}},getMenuItemFromXtype:function(a){var b=this.getApplication().getToolConfigFromToolXtype(a);b&&b.tooltip&&delete b.tooltip;return Ext.apply(Ext.clone(b),{xtype:"menuitem",text:b.title,textAlign:"left",handler:function(){this.replacePanel(b.xtype)},scope:this})},maximizeToolClick:function(a){var b=Ext.getClass(a).getName().split(".");url=a.getBaseUrl()+"tool/"+b[b.length-1]+"/";params=a.getModifiedApiParams();!params.corpus&&a.getCorpus&&a.getCorpus()&&
(params.corpus=a.getCorpus().getId());params&&(url+="?"+Ext.Object.toQueryString(params));a.openUrl(url)},exportToolClick:function(a){a.isXType("voyanttabpanel")&&(a=a.getActiveTab());var b="beta.voyant-tools.org"==window.location.hostname?[{html:"<p class='keyword' style='text-align: center; font-weight: bold; padding: 4px;'>Please note that this is the beta server and you should not count on corpora persisting (for bookmarks, embedding, etc.)."}]:[],c=[{xtype:"radio",name:"export",inputValue:"embed",
boxLabel:a.localize("exportViewHtmlEmbed")},{xtype:"radio",name:"export",inputValue:"biblio",boxLabel:a.localize("exportViewBiblio")},{xtype:"radio",name:"export",inputValue:"spyral",boxLabel:a.localize("exportViewSpyral")}];a.getExtraExportItems&&a.getExtraExportItems().forEach(function(e){Ext.applyIf(e,{xtype:"radio",name:"export"});c.push(e)});b.push({xtype:"radio",name:"export",inputValue:"url",boxLabel:"<a href='"+a.getExportUrl.call(a)+"' target='_blank'>"+a.localize("exportViewUrl")+"</a>",
checked:!0,listeners:{afterrender:function(){this.boxLabelEl.on("click",function(){this.up("window").close()},this)}}},{xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportViewFieldset"),items:c});if(a.isXType("grid")){var d=[{xtype:"radio",name:"export",inputValue:"gridCurrentHtml",boxLabel:a.localize("exportGridCurrentHtml")},{xtype:"radio",name:"export",inputValue:"gridCurrentTsv",boxLabel:a.localize("exportGridCurrentTsv")}];a.getExportGridAll&&0==a.getExportGridAll()||d.push({xtype:"radio",
name:"export",inputValue:"gridAllJson",boxLabel:a.localize("exportGridAllJson")},{xtype:"radio",name:"export",inputValue:"gridAllTsv",boxLabel:a.localize("exportGridAllTsv")});b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportGridCurrent"),items:d})}a.getExportVisualization&&!a.getExportVisualization()||0!=a.isXType("grid")||!(a.down("chart")||a.getTargetEl().dom.querySelector("canvas")||a.getTargetEl().dom.querySelector("svg"))||(d=[{xtype:"radio",name:"export",inputValue:"png",
boxLabel:a.localize("exportPng")},{xtype:"slider",width:200,value:1,minValue:.5,maxValue:10,increment:.5,labelAlign:"right",decimalPrecision:1,itemId:"scale",fieldLabel:(new Ext.Template(a.localize("scaleLabel"))).apply([1]),listeners:{change:function(e,f){this.setFieldLabel((new Ext.Template(a.localize("scaleLabel"))).apply([f]))},changecomplete:function(e){e.previousSibling().setValue(!0)}}}],a.getTargetEl().dom.querySelector("svg")&&d.push({xtype:"radio",name:"export",inputValue:"svg",boxLabel:a.localize("exportSvg")}),
b.push({xtype:"fieldset",collapsible:!0,collapsed:!0,title:a.localize("exportVizTitle"),items:d}));Ext.create("Ext.window.Window",{title:a.localize("exportTitle"),modal:!0,items:{xtype:"form",items:b,buttons:[{text:a.localize("exportTitle"),glyph:"xf08e@FontAwesome",flex:1,panel:a,handler:function(e){var f=e.up("form"),g="export"+Ext.String.capitalize(f.getValues()["export"]);Ext.isFunction(a[g])?a[g].call(a,a,f):Ext.Msg.show({title:a.localize("exportError"),message:a.localize("exportNoFunction"),
buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});e.up("window").close()},scope:a},{text:a.localize("cancelTitle"),glyph:"xf00d@FontAwesome",flex:1,handler:function(e){e.up("window").close()}}]},bodyPadding:5}).show()},exportSvg:function(a){if(a=this.getTargetEl().dom.querySelector("svg"))a=d3.select(a).attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,Ext.Msg.show({title:this.localize("exportSvgTitle"),message:'<img src="data:image/svg+xml;base64,'+btoa(unescape(encodeURIComponent(a)))+
'" style="float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/>'+this.localize("exportSvgMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:a})},exportPngData:function(a){Ext.Msg.show({title:this.localize("exportPngTitle"),message:'<img class="thumb" src="'+a+'" style="float: right; max-width: 200px; max-height: 200px; border: thin dotted #ccc;"/>'+this.localize("exportPngMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:'<img src="'+
a+'" />'})},exportPng:function(a,b){var c=1;b&&(b.mask(a.localize("loading")),(a=b.queryById("scale"))&&a.getValue&&(c=a.getValue()));var d=this.down("draw")||this.down("chart");if(d&&(d.isChart||d.isCanvas)){var e=d.innerElement.getSize();a=Array.prototype.slice.call(d.items.items);var f=d.surfaceZIndexes,g;for(g=1;g<a.length;g++){var h=a[g];var k=f[h.type];for(d=g-1;0<=d&&f[a[d].type]>k;)a[d+1]=a[d],d--;a[d+1]=h}var l=document.createElement("canvas");f=Ext.getClassName(a[0]);c*=a[0].devicePixelRatio;
var m=l.getContext("2d");l.width=Math.ceil(e.width*c);l.height=Math.ceil(e.height*c);for(d=0;d<a.length;d++)if(h=a[d],Ext.getClassName(h)===f)for(e=h.getRect(),surfaceSize=h.el.getSize(),g=0;g<h.canvases.length;g++){var n=h.canvases[g];k=n.getOffsetsTo(n.getParent());m.drawImage(n.dom,(e[0]+k[0])*c,(e[1]+k[1])*c,surfaceSize.width*c,surfaceSize.height*c)}b&&b.isVisible()&&b.unmask();return this.exportPngData(l.toDataURL())}d=this.getTargetEl().dom;if(n=d.querySelector("canvas")){if(1==c)return c=n.toDataURL("image/png"),
b&&b.isVisible()&&b.unmask(),this.exportPngData(c);l=document.createElement("canvas");m=l.getContext("2d");l.width=Math.ceil(n.width*c);l.height=Math.ceil(n.height*c);var r=new Image;r.src=n.toDataURL("image/png");r.panel=this;r.onload=function(){m.drawImage(r,0,0,l.width,l.height);q=l.toDataURL("image/png");b&&b.isVisible()&&b.unmask();this.panel.exportPngData.call(this.panel,q)}}else if(g=d.querySelector("svg")){a=d.offsetWidth*c;d=d.offsetHeight*c;g=g.cloneNode(!0);g.setAttribute("version",1.1);
g.setAttribute("xmlns","http://www.w3.org/2000/svg");g.setAttribute("width",a);g.setAttribute("height",d);for(h=[];0<g.children.length;)h.push(g.removeChild(g.children[0]));var u=document.createElement("g");u.setAttribute("style","transform-box: fill-box;");u.setAttribute("transform","scale("+c+")");g.appendChild(u);h.forEach(function(v){u.appendChild(v)});var q="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(g.outerHTML)));n=Ext.DomHelper.createDom({tag:"canvas",width:a,height:d});
var p=n.getContext("2d");r=new Image;r.src=q;r.panel=this;r.onload=function(){p.drawImage(r,0,0);q=n.toDataURL("image/png");b&&b.isVisible()&&b.unmask();return this.panel.exportPngData.call(this.panel,q)}}},exportUrl:function(){this.openUrl(this.getExportUrl())},exportEmbed:function(){var a=0==this.isXType("voyantheader");Ext.Msg.show({title:this.localize("exportViewEmbedTitle"),message:this.localize("exportViewEmbedMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:"\x3c!--\tExported from Voyant Tools (voyant-tools.org).\nThe iframe src attribute below uses a relative protocol to better function with both\nhttp and https sites, but if you're embedding this into a local web page (file protocol)\nyou should add an explicit protocol (https if you're using voyant-tools.org, otherwise\nit depends on this server.\nFeel free to change the height and width values or other styling below: --\x3e\n<iframe style='width: "+
(a?this.getWidth()+"px":"100%")+"; height: "+(a?this.getHeight()+"px":"800px")+";' src='"+this.getExportUrl(a)+"'></iframe>"})},exportBiblio:function(){var a=new Date,b=this.getExportUrl();Ext.Msg.show({title:this.localize("exportBiblioTitle"),message:'<fieldset><legend>MLA</legend><div class="x-selectable">Sinclair, St\u00e9fan and Geoffrey Rockwell. '+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'." ')+"<i>Voyant Tools</i>. "+Ext.Date.format(a,"Y")+". Web. "+Ext.Date.format(a,"j M Y")+
". &lt;"+b+'&gt;.</div></fieldset><br ><fieldset><legend>Chicago</legend><div class="x-selectable">St\u00e9fan Sinclair and Geoffrey Rockwell, '+(this.isXType("voyantheader")?"":'"'+this.localize("title")+'", ')+"<i>Voyant Tools</i>, accessed "+Ext.Date.format(a,"F j, Y")+", "+b+'.</div></fieldset><br ><fieldset><legend>APA</legend><div class="x-selectable">Sinclair, S. &amp; G. Rockwell. ('+Ext.Date.format(a,"Y")+"). "+(this.isXType("voyantheader")?"":this.localize("title")+". ")+"<i>Voyant Tools</i>. Retrieved "+
Ext.Date.format(a,"F j, Y")+", from "+b+"</div></fieldset>",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},exportSpyral:function(){var a=Ext.getClassName(this).split(".").pop(),b=this.getApplication().getModifiedApiParams();0==this.isXType("voyantheader")&&(delete b.panels,Ext.apply(b,this.getModifiedApiParams()),delete b.corpus);var c=b&&"debug"in b;delete b.view;delete b.debug;a='["'+btoa(encodeURIComponent("<h2>Spyral Notebook Imported from Voyant Tools</h2>")).replace(/=/g,"%3D")+'","'+btoa(encodeURIComponent('loadCorpus("'+
this.getApplication().getCorpus().getAliasOrId()+'").tool("'+("VoyantHeader"==a?"":a)+'"'+(0<Object.keys(b).length?","+Ext.encode(b):"")+");")).replace(/=/g,"%3D")+'"]';this.openUrl(this.getApplication().getBaseUrl()+"spyral/?run=true&"+(c?"debug=true&":"")+"inputJsonArrayOfEncodedBase64="+a)},exportGridCurrentJson:function(a,b){function c(e){var f={};d.forEach(function(g){f[g.text]=e.get(g.dataIndex)});values.push(f)}b=a.getStore();b.getFields();var d=a.getColumnManager().headerCt.getVisibleGridColumns();
values=[];b.buffered?b.data.forEach(c):b.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataJsonMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:Ext.encode(values)})},exportGridCurrentTsv:function(a,b){function c(g){cells=[];e.forEach(function(h){h=g.get(h.dataIndex);Ext.isString(h)&&(h=h.replace(/\s+/g," "));cells.push(h)});f+=cells.join("\t")+"\n"}b=a.getStore();var d=b.getFields(),e=a.getColumnManager().headerCt.getVisibleGridColumns();
d=[];e.forEach(function(g){d.push(g.text)});var f=d.join("\t")+"\n";b.buffered?b.data.forEach(c):b.each(c);Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataTsvMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:f})},exportGridCurrentHtml:function(a,b){function c(f){d+="\t\t<tr>\n";e.forEach(function(g){g=f.get(g.dataIndex);Ext.isString(g)&&(g=g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&lg;"));d+="\t\t\t<td>"+g+"</td>\n"});
d+="\t\t</tr>\n"}b=a.getStore();b.getFields();var d="<table>\n\t<thead>\n\t\t<tr>\n",e=a.getColumnManager().headerCt.getVisibleGridColumns();e.forEach(function(f){d+="\t\t\t<td>"+f.text+"</td>\n"});d+="\t\t</tr>\n\t</thead>\n\t<tbody>\n";b.buffered?b.data.forEach(c):b.each(c);d+="\t</tbody>\n</table>";Ext.Msg.show({title:this.localize("exportDataTitle"),message:this.localize("exportDataHtmlMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:d})},exportGridAllJson:function(a,
b){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllJsonWarning"),function(c){"yes"==c&&(c={limit:0,start:0},Ext.applyIf(c,a.getStore().getProxy().getExtraParams()),this.openUrl(this.getTromboneUrl()+"?"+Ext.Object.toQueryString(c)))},this)},exportGridAllTsv:function(a,b){Ext.Msg.confirm(this.localize("exportAllTitle"),this.localize("exportAllTsvWarning"),function(c){"yes"==c&&(c={limit:0,start:0,template:this.getXType()+"2tsv"},Ext.applyIf(c,a.getStore().getProxy().getExtraParams()),
this.openUrl(this.getTromboneUrl()+"?"+Ext.Object.toQueryString(c)))},this)},getExportUrl:function(a){var b=this.getApplication().getModifiedApiParams(),c=Ext.getClassName(this).split(".").pop();0==this.isXType("voyantheader")&&(delete b.panels,Ext.apply(b,this.getModifiedApiParams()),a||(b.view=c));b.corpus||(b.corpus=this.getApplication().getCorpus().getAliasOrId());return this.getApplication().getBaseUrl()+(a?"tool/"+c+"/":"")+"?"+Ext.Object.toQueryString(b)},helpToolClick:function(a){a.isXType("voyanttabpanel")&&
(a=a.getActiveTab());var b=a.localize("help",{"default":!1})||a.localize("helpTip");b==a._localizeClass(Ext.ClassManager.get("Voyant.util.Toolable"),"helpTip")?a.openUrl(a.getBaseUrl()+"docs/#!/guide/"+a.getXType()):Ext.Msg.alert(a.localize("title"),b+"<p><a href='"+a.getBaseUrl()+"docs/"+(a.isXType("voyantheader")?"":"#!/guide/"+a.getXType())+"' target='voyantdocs'>"+a.localize("moreHelp")+"</a></p>")},replacePanel:function(a){var b=this.getApplication().getCorpus();this.getInitialConfig();if(this.isXType("voyantheader")&&
this.getApplication().getViewComponent){var c=this.getApplication().getViewComponent();c.removeAll(!0);c.add({xtype:a});b&&this.getApplication().dispatchEvent("loadedCorpus",c,b);c=Ext.Object.fromQueryString(document.location.search);var d=this.getApplication().getBaseUrl();d+="?corpus="+b.getAliasOrId();d+="&view="+a;for(var e in c)"corpus"!==e&&"view"!==e&&(d+="&"+e+"="+c[e]);window.history.pushState({corpus:b.getAliasOrId(),view:a},"",d)}else c=this.isXType("voyantheader")&&this.getApplication().getViewComponent?
this.getApplication().getViewComponent():this.up("component"),c.remove(this,!0),a=c.add({xtype:a}),c.isXType("voyanttabpanel")&&c.setActiveTab(a),b&&a.fireEvent("loadedCorpus",a,b);this.getApplication().dispatchEvent("panelChange",this)}});
Ext.define("Voyant.util.ToolMenu",{extend:"Ext.panel.Tool",alias:"widget.toolmenu",renderTpl:['<div class="x-menu-tool-hover"></div><tpl if="glyph"><span id="{id}-toolEl" class="{baseCls}-glyph {childElCls}" role="presentation" style="font-family: {glyphFontFamily}; <tpl if="Ext.os.name==\'iOS\'">margin-right: 15px; </tpl>">&#{glyph}</span><tpl else><img id="{id}-toolEl" src="{blank}" class="{baseCls}-img {baseCls}-{type}{childElCls}" role="presentation"/></tpl>'],privates:{onClick:function(){var a=
this.callParent(arguments);a&&this.items&&(this.toolMenu||(this.toolMenu=new Ext.menu.Menu({items:this.items})),this.toolMenu.showAt(0,0),this.toolMenu.showAt(this.getX()+this.getWidth()-this.toolMenu.getWidth(),this.getY()+this.getHeight()+10));return a},onDestroy:function(){Ext.destroyMembers(this,"toolMenu");this.callParent()}},initComponent:function(){this.callParent(arguments);var a=this.glyph||"xf12e@FontAwesome";if("string"===typeof a){var b=a.split("@");a=b[0];b=b[1]}else"object"===typeof a&&
a.glyphConfig&&(b=a.glyphConfig.split("@"),a=b[0],b=b[1]);Ext.applyIf(this.renderData,{baseCls:this.baseCls,blank:Ext.BLANK_IMAGE_URL,type:this.type,glyph:a,glyphFontFamily:b})}});Ext.define("Voyant.util.Transferable",{transferable:["transfer"],transfer:function(a,b){if(a.transferable)for(var c=0;c<a.transferable.length;c++){var d=a.transferable[c];b[d]=Ext.bind(a[d],b)}if(a.mixins)for(mixin in a.mixins)this.transfer(a.mixins[mixin],b)}});Ext.define("Voyant.util.Variants",{extend:"Ext.Base",constructor:function(a){this.variants=a;this.map={};this.variants.forEach(function(b,c){b.forEach(function(d){this.map[d]=c},this)},this)},getVariants:function(a){var b=[];Ext.isString(a)&&(a=[a]);Ext.isArray(a)&&a.forEach(function(c){void 0!=this.map[c]&&b.push.apply(b,this.variants[this.map[c]])},this);return b}});Ext.define("Voyant.util.Downloadable",{mixins:["Voyant.util.Localization"],statics:{i18n:{},api:{documentFormat:void 0,documentFilename:void 0}},downloadFromCorpusId:function(a){var b=this;Ext.create("Ext.window.Window",{title:this.localize("exportTitle"),modal:!0,items:{xtype:"form",items:{xtype:"downloadoptions"},listeners:{afterrender:function(c){c.getForm().setValues(b.getApiParams(["documentFilename","documentFormat"]))}},buttons:[{text:this.localize("cancelButton"),glyph:"xf00d@FontAwesome",
flex:1,ui:"default-toolbar",handler:function(c){c.up("window").close()}},{text:this.localize("downloadButton"),glyph:"xf00c@FontAwesome",flex:1,handler:function(c){var d=c.up("form").getValues();b.setApiParams(d);b.openDownloadCorpus(a);c.up("window").close()},scope:this}]},bodyPadding:5}).show()},openDownloadCorpus:function(a){a=this.getTromboneUrl()+"?corpus="+a+"&tool=corpus.CorpusExporter&outputFormat=zip&zipFilename=DownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?"&documentFormat="+
this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"&documentFilename="+this.getApiParam("documentFilename"):"");this.openUrl(a)}});Ext.define("Voyant.util.Storage",{MAX_LENGTH:95E4,storeResource:function(a,b){var c=Ext.encode(b);if(c.length>this.MAX_LENGTH){var d=new Ext.Deferred,e=Math.ceil(c.length/this.MAX_LENGTH),f=[];for(b=0;b<e;b++)f.push(a+"-chunk"+b);this._doStore(a+"-hasChunks",Ext.encode(f)).then(function(){for(var g=0,h=0,k=0;k<e;k++){var l=c.substr(h,this.MAX_LENGTH);this._doStore(f[k],l).then(function(){g++;g==e&&d.resolve()},function(){d.reject()},null,this);h+=this.MAX_LENGTH}},function(){d.reject()},null,this);
return d.promise}return this._doStore(a,c)},_doStore:function(a,b){var c=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",resourceId:a,storeResource:b}}).then(function(d){c.resolve()},function(d){c.reject()});return c.promise},getStoredResource:function(a){var b=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:a+"-hasChunks"}}).then(function(c){(c=Ext.decode(c.responseText))&&c.storedResource&&
c.storedResource.id&&""!=c.storedResource.id?this._doGetStored(c.storedResource.id,!1).then(function(d){for(var e="",f={},g=0;g<d.length;g++)this._doGetStored(d[g],!0).then(function(h){f[h[0]]=h[1];h=!0;for(var k=d.length-1;0<=k;k--)if(void 0===f[d[k]]){h=!1;break}if(h){for(k=0;k<d.length;k++)e+=f[d[k]];b.resolve(Ext.decode(e))}},function(){b.reject()},null,this)},function(){b.reject()},null,this):this._doGetStored(a,!1).then(function(d){b.resolve(d)},function(){b.reject()},null,this)},function(){b.reject()},
null,this);return b.promise},_doGetStored:function(a,b){var c=new Ext.Deferred;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:a,failQuietly:!0}}).then(function(d){var e=Ext.decode(d.responseText);d=e.storedResource.id;e=e.storedResource.resource;0==e.length?c.reject():1!=b?(e=Ext.decode(e),c.resolve(e)):c.resolve([d,e])},function(){c.reject()},null,this);return c.promise}});Ext.define("Voyant.util.DiacriticsRemover",{diacriticsMap:{},constructor:function(){var a=[{base:"A",letters:"A\u24b6\uff21\u00c0\u00c1\u00c2\u1ea6\u1ea4\u1eaa\u1ea8\u00c3\u0100\u0102\u1eb0\u1eae\u1eb4\u1eb2\u0226\u01e0\u00c4\u01de\u1ea2\u00c5\u01fa\u01cd\u0200\u0202\u1ea0\u1eac\u1eb6\u1e00\u0104\u023a\u2c6f"},{base:"AA",letters:"\ua732"},{base:"AE",letters:"\u00c6\u01fc\u01e2"},{base:"AO",letters:"\ua734"},{base:"AU",letters:"\ua736"},{base:"AV",letters:"\ua738\ua73a"},{base:"AY",letters:"\ua73c"},
{base:"B",letters:"B\u24b7\uff22\u1e02\u1e04\u1e06\u0243\u0182\u0181"},{base:"C",letters:"C\u24b8\uff23\u0106\u0108\u010a\u010c\u00c7\u1e08\u0187\u023b\ua73e"},{base:"D",letters:"D\u24b9\uff24\u1e0a\u010e\u1e0c\u1e10\u1e12\u1e0e\u0110\u018b\u018a\u0189\ua779\u00d0"},{base:"DZ",letters:"\u01f1\u01c4"},{base:"Dz",letters:"\u01f2\u01c5"},{base:"E",letters:"E\u24ba\uff25\u00c8\u00c9\u00ca\u1ec0\u1ebe\u1ec4\u1ec2\u1ebc\u0112\u1e14\u1e16\u0114\u0116\u00cb\u1eba\u011a\u0204\u0206\u1eb8\u1ec6\u0228\u1e1c\u0118\u1e18\u1e1a\u0190\u018e"},
{base:"F",letters:"F\u24bb\uff26\u1e1e\u0191\ua77b"},{base:"G",letters:"G\u24bc\uff27\u01f4\u011c\u1e20\u011e\u0120\u01e6\u0122\u01e4\u0193\ua7a0\ua77d\ua77e"},{base:"H",letters:"H\u24bd\uff28\u0124\u1e22\u1e26\u021e\u1e24\u1e28\u1e2a\u0126\u2c67\u2c75\ua78d"},{base:"I",letters:"I\u24be\uff29\u00cc\u00cd\u00ce\u0128\u012a\u012c\u0130\u00cf\u1e2e\u1ec8\u01cf\u0208\u020a\u1eca\u012e\u1e2c\u0197"},{base:"J",letters:"J\u24bf\uff2a\u0134\u0248"},{base:"K",letters:"K\u24c0\uff2b\u1e30\u01e8\u1e32\u0136\u1e34\u0198\u2c69\ua740\ua742\ua744\ua7a2"},
{base:"L",letters:"L\u24c1\uff2c\u013f\u0139\u013d\u1e36\u1e38\u013b\u1e3c\u1e3a\u0141\u023d\u2c62\u2c60\ua748\ua746\ua780"},{base:"LJ",letters:"\u01c7"},{base:"Lj",letters:"\u01c8"},{base:"M",letters:"M\u24c2\uff2d\u1e3e\u1e40\u1e42\u2c6e\u019c"},{base:"N",letters:"N\u24c3\uff2e\u01f8\u0143\u00d1\u1e44\u0147\u1e46\u0145\u1e4a\u1e48\u0220\u019d\ua790\ua7a4"},{base:"NJ",letters:"\u01ca"},{base:"Nj",letters:"\u01cb"},{base:"O",letters:"O\u24c4\uff2f\u00d2\u00d3\u00d4\u1ed2\u1ed0\u1ed6\u1ed4\u00d5\u1e4c\u022c\u1e4e\u014c\u1e50\u1e52\u014e\u022e\u0230\u00d6\u022a\u1ece\u0150\u01d1\u020c\u020e\u01a0\u1edc\u1eda\u1ee0\u1ede\u1ee2\u1ecc\u1ed8\u01ea\u01ec\u00d8\u01fe\u0186\u019f\ua74a\ua74c"},
{base:"OI",letters:"\u01a2"},{base:"OO",letters:"\ua74e"},{base:"OU",letters:"\u0222"},{base:"OE",letters:"\u008c\u0152"},{base:"oe",letters:"\u009c\u0153"},{base:"P",letters:"P\u24c5\uff30\u1e54\u1e56\u01a4\u2c63\ua750\ua752\ua754"},{base:"Q",letters:"Q\u24c6\uff31\ua756\ua758\u024a"},{base:"R",letters:"R\u24c7\uff32\u0154\u1e58\u0158\u0210\u0212\u1e5a\u1e5c\u0156\u1e5e\u024c\u2c64\ua75a\ua7a6\ua782"},{base:"S",letters:"S\u24c8\uff33\u1e9e\u015a\u1e64\u015c\u1e60\u0160\u1e66\u1e62\u1e68\u0218\u015e\u2c7e\ua7a8\ua784"},
{base:"T",letters:"T\u24c9\uff34\u1e6a\u0164\u1e6c\u021a\u0162\u1e70\u1e6e\u0166\u01ac\u01ae\u023e\ua786"},{base:"TZ",letters:"\ua728"},{base:"U",letters:"U\u24ca\uff35\u00d9\u00da\u00db\u0168\u1e78\u016a\u1e7a\u016c\u00dc\u01db\u01d7\u01d5\u01d9\u1ee6\u016e\u0170\u01d3\u0214\u0216\u01af\u1eea\u1ee8\u1eee\u1eec\u1ef0\u1ee4\u1e72\u0172\u1e76\u1e74\u0244"},{base:"V",letters:"V\u24cb\uff36\u1e7c\u1e7e\u01b2\ua75e\u0245"},{base:"VY",letters:"\ua760"},{base:"W",letters:"W\u24cc\uff37\u1e80\u1e82\u0174\u1e86\u1e84\u1e88\u2c72"},
{base:"X",letters:"X\u24cd\uff38\u1e8a\u1e8c"},{base:"Y",letters:"Y\u24ce\uff39\u1ef2\u00dd\u0176\u1ef8\u0232\u1e8e\u0178\u1ef6\u1ef4\u01b3\u024e\u1efe"},{base:"Z",letters:"Z\u24cf\uff3a\u0179\u1e90\u017b\u017d\u1e92\u1e94\u01b5\u0224\u2c7f\u2c6b\ua762"},{base:"a",letters:"a\u24d0\uff41\u1e9a\u00e0\u00e1\u00e2\u1ea7\u1ea5\u1eab\u1ea9\u00e3\u0101\u0103\u1eb1\u1eaf\u1eb5\u1eb3\u0227\u01e1\u00e4\u01df\u1ea3\u00e5\u01fb\u01ce\u0201\u0203\u1ea1\u1ead\u1eb7\u1e01\u0105\u2c65\u0250"},{base:"aa",letters:"\ua733"},
{base:"ae",letters:"\u00e6\u01fd\u01e3"},{base:"ao",letters:"\ua735"},{base:"au",letters:"\ua737"},{base:"av",letters:"\ua739\ua73b"},{base:"ay",letters:"\ua73d"},{base:"b",letters:"b\u24d1\uff42\u1e03\u1e05\u1e07\u0180\u0183\u0253"},{base:"c",letters:"c\u24d2\uff43\u0107\u0109\u010b\u010d\u00e7\u1e09\u0188\u023c\ua73f\u2184"},{base:"d",letters:"d\u24d3\uff44\u1e0b\u010f\u1e0d\u1e11\u1e13\u1e0f\u0111\u018c\u0256\u0257\ua77a"},{base:"dz",letters:"\u01f3\u01c6"},{base:"e",letters:"e\u24d4\uff45\u00e8\u00e9\u00ea\u1ec1\u1ebf\u1ec5\u1ec3\u1ebd\u0113\u1e15\u1e17\u0115\u0117\u00eb\u1ebb\u011b\u0205\u0207\u1eb9\u1ec7\u0229\u1e1d\u0119\u1e19\u1e1b\u0247\u025b\u01dd"},
{base:"f",letters:"f\u24d5\uff46\u1e1f\u0192\ua77c"},{base:"g",letters:"g\u24d6\uff47\u01f5\u011d\u1e21\u011f\u0121\u01e7\u0123\u01e5\u0260\ua7a1\u1d79\ua77f"},{base:"h",letters:"h\u24d7\uff48\u0125\u1e23\u1e27\u021f\u1e25\u1e29\u1e2b\u1e96\u0127\u2c68\u2c76\u0265"},{base:"hv",letters:"\u0195"},{base:"i",letters:"i\u24d8\uff49\u00ec\u00ed\u00ee\u0129\u012b\u012d\u00ef\u1e2f\u1ec9\u01d0\u0209\u020b\u1ecb\u012f\u1e2d\u0268\u0131"},{base:"j",letters:"j\u24d9\uff4a\u0135\u01f0\u0249"},{base:"k",letters:"k\u24da\uff4b\u1e31\u01e9\u1e33\u0137\u1e35\u0199\u2c6a\ua741\ua743\ua745\ua7a3"},
{base:"l",letters:"l\u24db\uff4c\u0140\u013a\u013e\u1e37\u1e39\u013c\u1e3d\u1e3b\u017f\u0142\u019a\u026b\u2c61\ua749\ua781\ua747"},{base:"lj",letters:"\u01c9"},{base:"m",letters:"m\u24dc\uff4d\u1e3f\u1e41\u1e43\u0271\u026f"},{base:"n",letters:"n\u24dd\uff4e\u01f9\u0144\u00f1\u1e45\u0148\u1e47\u0146\u1e4b\u1e49\u019e\u0272\u0149\ua791\ua7a5"},{base:"nj",letters:"\u01cc"},{base:"o",letters:"o\u24de\uff4f\u00f2\u00f3\u00f4\u1ed3\u1ed1\u1ed7\u1ed5\u00f5\u1e4d\u022d\u1e4f\u014d\u1e51\u1e53\u014f\u022f\u0231\u00f6\u022b\u1ecf\u0151\u01d2\u020d\u020f\u01a1\u1edd\u1edb\u1ee1\u1edf\u1ee3\u1ecd\u1ed9\u01eb\u01ed\u00f8\u01ff\u0254\ua74b\ua74d\u0275"},
{base:"oi",letters:"\u01a3"},{base:"ou",letters:"\u0223"},{base:"oo",letters:"\ua74f"},{base:"p",letters:"p\u24df\uff50\u1e55\u1e57\u01a5\u1d7d\ua751\ua753\ua755"},{base:"q",letters:"q\u24e0\uff51\u024b\ua757\ua759"},{base:"r",letters:"r\u24e1\uff52\u0155\u1e59\u0159\u0211\u0213\u1e5b\u1e5d\u0157\u1e5f\u024d\u027d\ua75b\ua7a7\ua783"},{base:"s",letters:"s\u24e2\uff53\u00df\u015b\u1e65\u015d\u1e61\u0161\u1e67\u1e63\u1e69\u0219\u015f\u023f\ua7a9\ua785\u1e9b"},{base:"t",letters:"t\u24e3\uff54\u1e6b\u1e97\u0165\u1e6d\u021b\u0163\u1e71\u1e6f\u0167\u01ad\u0288\u2c66\ua787"},
{base:"tz",letters:"\ua729"},{base:"u",letters:"u\u24e4\uff55\u00f9\u00fa\u00fb\u0169\u1e79\u016b\u1e7b\u016d\u00fc\u01dc\u01d8\u01d6\u01da\u1ee7\u016f\u0171\u01d4\u0215\u0217\u01b0\u1eeb\u1ee9\u1eef\u1eed\u1ef1\u1ee5\u1e73\u0173\u1e77\u1e75\u0289"},{base:"v",letters:"v\u24e5\uff56\u1e7d\u1e7f\u028b\ua75f\u028c"},{base:"vy",letters:"\ua761"},{base:"w",letters:"w\u24e6\uff57\u1e81\u1e83\u0175\u1e87\u1e85\u1e98\u1e89\u2c73"},{base:"x",letters:"x\u24e7\uff58\u1e8b\u1e8d"},{base:"y",letters:"y\u24e8\uff59\u1ef3\u00fd\u0177\u1ef9\u0233\u1e8f\u00ff\u1ef7\u1e99\u1ef5\u01b4\u024f\u1eff"},
{base:"z",letters:"z\u24e9\uff5a\u017a\u1e91\u017c\u017e\u1e93\u1e95\u01b6\u0225\u0240\u2c6c\ua763"}];this.diacriticsMap={};for(var b=0;b<a.length;b++)for(var c=a[b].letters,d=0;d<c.length;d++)this.diacriticsMap[c[d]]=a[b].base},removeDiacritics:function(a){return a.replace(/[^\u0000-\u007E]/g,function(b){return this.diacriticsMap[b]||b}.bind(this))}});Ext.define("Voyant.notebook.util.Show",{transferable:["show"],show:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);show.call(this,this.getString?this.getString(a):this.toString(),!this.getString&&Ext.isNumber(a)?a:void 0)},statics:{show:function(a,b){if(this.then){var c=a;this.then(function(e){show.call(e,e,c)})}else if(void 0!==a){if(Ext.isArray(a)){var d="";a.forEach(function(e){d+=e.getString?e.getString():e.toString()});a=d}else if(Ext.isString(this)||
this instanceof String)Ext.isNumber(a)&&(b=a),a=this;if(a.then)return a.then(function(e){show(e,b)});a.toHtml?a=a.toHtml():a.getString?a=a.getString():a.toString&&(a=a.toString());a.then?a.then(function(e){show(e,b)}):(b&&Ext.isNumber(b)&&(a=a.substring(0,b)),0==Voyant.notebook.util.Show.SINGLE_LINE_MODE&&(a="<div class='"+Voyant.notebook.util.Show.MODE+"'>"+a+"</div>"),Voyant.notebook.util.Show.TARGET.insertHtml("beforeEnd",a))}},showError:function(a,b){var c=Voyant.notebook.util.Show.MODE;Voyant.notebook.util.Show.MODE=
"error";this instanceof Voyant.util.ResponseError&&(a=this);a instanceof Voyant.util.ResponseError?(console&&console.error(a.getResponse()),b=a.getResponse().responseText,a=a.getMsg()):(void 0!==a&&a.stack&&!b&&(b=a.stack),b&&!1===Ext.isString(b)&&(b=b.toString()));console&&console.error(a);b&&(console&&console.error(b),a="<h3>"+a.toString()+"</h3><pre>"+Ext.String.htmlEncode(b)+"</pre>");show(a);Voyant.notebook.util.Show.MODE=c},TARGET:null,MODE:"info",SINGLE_LINE_MODE:!1}});
var show=String.prototype.show=Voyant.notebook.util.Show.show,showError=Voyant.notebook.util.Show.showError;Ext.define("Voyant.notebook.util.Embed",{transferable:["embed"],embed:function(){embed.apply(this,arguments)},constructor:function(a){},statics:{i18n:{},api:{embeddedParameters:void 0,embeddedConfig:void 0},embed:function(a,b){if(this.then)this.then(function(e){embed.call(e,a,b)});else if(Ext.isArray(a))Voyant.notebook.util.Show.SINGLE_LINE_MODE=!0,show("<table><tr>"),a.forEach(function(e){show("<td>");Ext.isArray(e)?e[0].embeddable?e[0].embed.apply(e[0],e.slice(1)):embed.apply(this,e):embed.apply(this,
e);show("</td>")}),show("</tr></table>"),Voyant.notebook.util.Show.SINGLE_LINE_MODE=!1;else{!this.embeddable||a&&!Ext.isObject(a)||(Ext.isObject(a)&&(b=a),a=this.embeddable[0]);Ext.isString(a)&&(a=Ext.ClassManager.getByAlias("widget."+a.toLowerCase())||Ext.ClassManager.get(a));var c=!1;if(Ext.isFunction(a)){var d=a.getName();this.embeddable&&!0===Ext.Array.each(this.embeddable,function(e){if(e==d){b=b||{};e={};for(key in Ext.ClassManager.get(Ext.getClassName(a)).api)key in b&&(e[key]=b[key]);if(!e.corpus)if("Voyant.data.model.Corpus"==
Ext.getClassName(this))e.corpus=this.getId();else if(this.getCorpus){var f=this.getCorpus();f&&(e.corpus=this.getCorpus().getId())}Ext.applyIf(b,{style:"width: "+(b.width||"90%")+(Ext.isNumber(b.width)?"px":"")+"; height: "+(b.height||"400px")+(Ext.isNumber(b.height)?"px":"")});delete b.width;delete b.height;f=e.corpus;delete e.corpus;Ext.applyIf(e,Voyant.application.getModifiedApiParams());e=Ext.encode(e);e=encodeURIComponent(e);var g=Ext.id(),h=Voyant.application.getBaseUrlFull()+"tool/"+d.substring(d.lastIndexOf(".")+
1)+"/?";show('<iframe style="'+b.style+'" id="'+g+'" name="'+g+'"></iframe>');var k=Voyant.application.getDeferred(this);Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:e}}).then(function(l){l={minimal:!0,embeddedApiId:Ext.util.JSON.decode(l.responseText).storedResource.id};f&&(l.corpus=f);Ext.applyIf(l,Voyant.application.getModifiedApiParams());document.getElementById(g).setAttribute("src",h+Ext.Object.toQueryString(l));k.resolve()}).otherwise(function(l){showError(l);
k.reject()});c=!0;return!1}},this)&&Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this);c||(Ext.create(a,b).embed(b),c=!0)}c||Voyant.notebook.util.Embed.showWidgetNotRecognized.call(this)}},showWidgetNotRecognized:function(){var a=Voyant.notebook.util.Embed.i18n.widgetNotRecognized;this.embeddable&&(a+=Voyant.notebook.util.Embed.i18n.tryWidget+"<ul>"+this.embeddable.map(function(b){b=b.substring(b.lastIndexOf(".")+1).toLowerCase();return"\"<a href='../../docs/#!/guide/"+b+"' target='voyantdocs'>"+
b+'</a>"'}).join(", ")+"</ul>");showError(a)}}});embed=Voyant.notebook.util.Embed.embed;Ext.define("Voyant.data.model.AnalysisToken",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"number"},{name:"cluster",type:"int"},{name:"clusterCenter",type:"boolean"},{name:"vector"}]});Ext.define("Voyant.data.model.Context",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docIndex",type:"int"},{name:"position",type:"int"},{name:"docId"},{name:"left"},{name:"keyword"},{name:"term"},{name:"right"}],getDocIndex:function(){return this.get("docIndex")},getLeft:function(){return this.get("left")},getMiddle:function(){return this.get("middle")},getHighlightedMiddle:function(){return"<span class='keyword'>"+this.getMiddle()+"</span>"},getRight:function(){return this.get("right")},getPosition:function(){return this.get("position")},
getHighlightedContext:function(){return this.getLeft()+this.getHighlightedMiddle()+this.getRight()}});Ext.define("Voyant.data.model.CorpusFacet",{extend:"Ext.data.Model",idProperty:"label",fields:[{name:"facet"},{name:"label"},{name:"inDocumentsCount",type:"int"}],getLabel:function(){return this.get("label")},getFacet:function(){return this.get("facet")},getInDocumentsCount:function(){return this.get("inDocumentsCount")}});Ext.define("Voyant.data.model.CorpusCollocate",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"rawFreq",type:"int"},{name:"contextTerm"},{name:"contextTermRawFreq",type:"int"}],getTerm:function(){return this.getKeyword()},getRawFreq:function(){return this.getKeywordRawFreq()},getKeyword:function(){return this.get("term")},getKeywordRawFreq:function(){return this.get("rawFreq")},getContextTerm:function(){return this.get("contextTerm")},getContextTermRawFreq:function(){return this.get("contextTermRawFreq")}});Ext.define("Voyant.data.model.CorpusTerm",{extend:"Ext.data.Model",idProperty:"term",fields:[{name:"id"},{name:"rawFreq",type:"int"},{name:"inDocumentsCount",type:"int"},{name:"relativeFreq",type:"float"},{name:"relativePeakedness",type:"float"},{name:"relativeSkewness",type:"float"},{name:"comparisonRelativeFreqDifference",type:"float"},{name:"distributions"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}}],getTerm:function(){return this.get("term")},
getRawFreq:function(){return parseInt(this.get("rawFreq"))},getInDocumentsCount:function(){return parseInt(this.get("inDocumentsCount"))},getDistributions:function(){return this.get("distributions")},show:function(a){show(this.getString(a))},getString:function(){return this.getTerm()+": "+this.getRawFreq()}});Ext.define("Voyant.data.model.CorpusNgram",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"length",type:"int"},{name:"rawFreq",type:"int"},{name:"distributions"}],getTerm:function(){return this.get("term")}});Ext.define("Voyant.data.model.Dimension",{extend:"Ext.data.Model",fields:[{name:"percentage",type:"number"}]});Ext.define("Voyant.data.model.Document",{extend:"Ext.data.Model",fields:[{name:"corpus"},{name:"id"},{name:"author"},{name:"pubDate"},{name:"publisher"},{name:"pubPlace"},{name:"keyword"},{name:"collection"},{name:"index",type:"int"},{name:"tokensCount-lexical",type:"int"},{name:"typesCount-lexical",type:"int"},{name:"typeTokenRatio-lexical",type:"float",calculate:function(a){return a["typesCount-lexical"]/a["tokensCount-lexical"]}},{name:"lastTokenStartOffset-lexical",type:"int"},{name:"title"},
{name:"language",convert:function(a){return Ext.isEmpty(a)?"":a}},{name:"sentencesCount",type:"int"},{name:"averageWordsPerSentence",type:"float",calculate:function(a){return a.sentencesCount?a["tokensCount-lexical"]/a.sentencesCount:0}},{name:"css",type:"string"}],getLexicalTokensCount:function(){return this.get("tokensCount-lexical")},getLexicalTypeTokenRatio:function(){return this.get("typeTokenRatio-lexical")},loadDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getDocumentTerms();c.load({params:a,callback:function(d,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens({});c.load({params:a,callback:function(d,
e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});Ext.apply(a,{docId:this.get("id")});return this.get("corpus").getTokens(a)},getDocumentTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.applyIf(a,{proxy:{}});
Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});return a.corpus?a.corpus.getDocumentTerms(a):this.get("corpus").getDocumentTerms(a)},getIndex:function(){return this.get("index")},getId:function(){return this.get("id")},getFullLabel:function(){var a=this.getAuthor();return this.getTitle()+(a?"("+a+")":"")},getTitle:function(){var a=this.get("title");void 0===a&&(a="");a=Ext.isArray(a)?a.join("; "):a;return a=a.trim().replace(/\s+/g," ")},getTruncated:function(a,
b){if(a.length>b){var c=a.lastIndexOf("/");-1<c&&(a=a.substr(c+1));if(a.length>b){c=a.indexOf(" ",b-5);if(0>c||c>b)c=b;a=a.substring(0,c)+"\u2026"}}return a},getShortTitle:function(){var a=this.getTitle();a=a.replace(/\.(html?|txt|xml|docx?|pdf|rtf|\/)$/,"");a=a.replace(/^(the|a|le|l'|un|une)\s/,"");return this.getTruncated(a,25)},getTinyTitle:function(){return this.getTruncated(this.getShortTitle(),10)},getShortLabel:function(){var a=this.getAuthor(25);return parseInt(this.getIndex())+1+") <i>"+
this.getShortTitle()+"</i>"+(a?" ("+a+")":"")},getTinyLabel:function(){return parseInt(this.getIndex())+1+") "+this.getTinyTitle()},getPubDate:function(){return this.get("pubDate")},getPublisher:function(){return this.get("publisher")},getPubPlace:function(){return this.get("pubPlace")},getKeyword:function(){return this.getMultiple("keyword")},getCollection:function(){return this.getMultiple("collection")},getAuthor:function(a){this.getMultiple("author")},getMultiple:function(a,b){a=this.get(a)||
"";a=Ext.isArray(a)?a.join("; "):a;a=a.trim().replace(/\s+/g," ");return b?this.getTruncated(a,b):a},getCorpusId:function(){return this.get("corpus").getAliasOrId()},isPlainText:function(){return this.get("extra.Content-Type")&&/plain/i.test(this.get("extra.Content-Type"))?!0:!1},getAverageWordsPerSentence:function(){return this.get("averageWordsPerSentence")},show:function(){show(this.getFullLabel())},getCorpus:function(){return this.get("corpus")},getText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,
arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.apply(a,{tool:"corpus.DocumentTokens",corpus:this.getCorpusId()});this.getTokens(a).then(function(c){b.resolve(c)});return b.promise},getPlainText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.apply(a,{outputFormat:"text",template:"docTokens2text",noOthers:!0});return this.getText()},getLemmasArray:function(a){a=a||{};a.docId=this.getId();return this.getCorpus().getLemmasArray(a)},
getEntities:function(a){a=a||{};Ext.applyIf(a,{proxy:{}});Ext.applyIf(a.proxy,{extraParams:{}});Ext.applyIf(a.proxy.extraParams,{docIndex:this.get("index")});return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(a,{corpus:this.getCorpus(),docId:this.getId()}))},loadEntities:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);this.getEntities().load({params:a,callback:function(c,d,e){e?b.resolve(c):b.reject(d.error.response)}});
return b.promise},getCSS:function(){return this.get("css")||this.get("parent_css")}});Ext.define("Voyant.data.model.DocumentEntity",{extend:"Ext.data.Model",fields:[{name:"term"},{name:"docIndex",type:"int"},{name:"rawFreq",type:"int"},{name:"type"},{name:"positions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getPositions:function(){return this.get("positions")}});Ext.define("Voyant.data.model.DocumentQueryMatch",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"count",type:"int"},{name:"query"},{name:"distributions"}],getCount:function(){return this.get("count")},getDistributions:function(){return this.get("distributions")},getDocIds:function(){return this.get("docIds")}});Ext.define("Voyant.data.model.DocumentTerm",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"term"},{name:"docIndex",type:"int"},{name:"docId"},{name:"rawFreq",type:"int"},{name:"relativeFreq",type:"float"},{name:"tfidf",type:"float"},{name:"zscore",type:"float"},{name:"zscoreRatio",type:"float"},{name:"distributions"}],getTerm:function(){return this.get("term")},getDocIndex:function(){return this.get("docIndex")},getRawFreq:function(){return this.get("rawFreq")},getRelativeFreq:function(){return this.get("relativeFreq")},
getDistributions:function(){return this.get("distributions")}});Ext.define("Voyant.data.model.PrincipalComponent",{extend:"Ext.data.Model",fields:[{name:"eigenValue",type:"number"},{name:"eigenVectors"}]});Ext.define("Voyant.data.model.RelatedTerm",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"rawFreq",type:"int"}],getSource:function(){return this.get("source")},getTarget:function(){return this.get("target")},show:function(a){show(this.getString(a))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.model.StatisticalAnalysis",{extend:"Ext.data.Model",requires:["Voyant.data.model.PrincipalComponent","Voyant.data.model.Dimension","Voyant.data.model.AnalysisToken"],fields:[{name:"id"}],getPrincipalComponents:function(){var a=[];this.data.principalComponents.forEach(function(b){a.push(Ext.create("Voyant.data.model.PrincipalComponent",b))});return a},getDimensions:function(){var a=[];this.data.dimensions.forEach(function(b){a.push(Ext.create("Voyant.data.model.Dimension",{percentage:b}))});
return a},getTokens:function(){var a=[];this.data.tokens.forEach(function(b){a.push(Ext.create("Voyant.data.model.AnalysisToken",b))});return a}});Ext.define("Voyant.data.model.Token",{extend:"Ext.data.Model",fields:[{name:"id"},{name:"docId"},{name:"docIndex",type:"int"},{name:"token"},{name:"rawFreq"},{name:"tokenType"},{name:"position",type:"int"},{name:"startOffset",type:"int"},{name:"endOffset",type:"int"}],statics:{getInfoFromElement:function(a){if(a&&a.getId)return a=a.getId().split("_"),{docIndex:parseInt(a[1]),position:parseInt(a[2])}}},isWord:function(){return"lexical"==this.getTokenType()},isStopword:function(){return"true"==this.get("stopword")},
getTokenType:function(){return this.get("tokenType")},getId:function(){return["",this.getDocIndex(),this.getPosition()].join("_")},getDocIndex:function(){return this.get("docIndex")},getDocId:function(){return this.get("docId")},getTerm:function(){return this.get("term")},getTermWithLineSpacing:function(a){var b=this.getTerm().replace(/<\/?\w+\b.*?>/g,"<br /><br />").replace(/>\s+</g,"><").replace(/<br \/><br \/>(<br \/>)+/g,"<br /><br />");a&&(b=b.replace(/(\r\n|\r|\n)\s*/g,"<br />"));return b},
getPosition:function(){return this.get("position")},getDocumentRawFreq:function(){return this.get("rawFreq")}});Ext.define("Voyant.data.model.TermCorrelation",{extend:"Ext.data.Model",fields:[{name:"source"},{name:"target"},{name:"correlation",type:"float"},{name:"significance",type:"float"},{name:"source-term",calculate:function(a){return a.source.term}},{name:"target-term",calculate:function(a){return a.target.term}},{name:"source-distributions",calculate:function(a){return a.source.distributions}},{name:"target-distributions",calculate:function(a){return a.target.distributions}}],getSource:function(){return this.get("source")},
getTarget:function(){return this.get("target")},show:function(a){show(this.getString(a))},getString:function(){return this.getSource()+"-"+this.getTarget()}});Ext.define("Voyant.data.store.VoyantStore",{mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],config:{corpus:void 0,parentPanel:void 0},constructor:function(a,b){var c=this;a=a||{};Ext.applyIf(a,{remoteSort:!0,autoLoad:!1,pagePurgeCount:0,pageSize:100,leadingBufferZone:200});a.proxy=a.proxy||{};Ext.applyIf(a.proxy,{type:"ajax",timeout:12E4,url:Voyant.application.getTromboneUrl(),actionMethods:{read:"POST"},reader:{type:"json",rootProperty:b["proxy.reader.rootProperty"],totalProperty:b["proxy.reader.totalProperty"],
metaProperty:b["proxy.reader.metaProperty"]||"metaData"},simpleSortMode:!0,listeners:{exception:function(d,e,f){c.parentPanel&&c.parentPanel.showError&&c.parentPanel.showError(f)}}});a.proxy.extraParams=a.proxy.extraParams||{};Ext.applyIf(a.proxy.extraParams,{tool:b["proxy.extraParams.tool"]});void 0!==a.parentPanel&&(Ext.applyIf(a.proxy.extraParams,{forTool:a.parentPanel.xtype}),this.setParentPanel(a.parentPanel),a.parentPanel.on("loadedCorpus",function(d,e){this.setCorpus(e)},this),a.listeners=
a.listeners||{},a.listeners.beforeload={fn:function(d,e){var f=this.getParentPanel(),g=d.getProxy();if(void 0!==f){d=f.getApiParams();e=e?1===e?{}:e:{};e.params=e.params||{};g&&this.isBufferedStore&&(Ext.Array.from(this.previouslySetExtraParams).forEach(function(k){g.setExtraParam(k,void 0)}),this.previouslySetExtraParams=[]);for(var h in d)g&&this.isBufferedStore&&(this.previouslySetExtraParams.push(h),g.setExtraParam(h,d[h])),e.params[h]=d[h]}},scope:this});Ext.apply(this,a)},setCorpus:function(a){a&&
this.getProxy&&this.getProxy()&&this.getProxy().setExtraParam("corpus",Ext.isString(a)?a:a.getId());this.callParent(arguments)},getString:function(a){a=this.getCount();return"This store contains "+this.getCount()+" items"+(0<a?" with these fields: "+this.getAt(0).getFields().map(function(b){return b.getName()}).join(", "):"")+"."},embed:function(a,b){!b&&Ext.isObject(a)&&(b=a,a=this.embeddable[0]);b=b||{};var c=[];this.each(function(d){c.push(d.data)},this);Ext.apply(b,{storeJson:JSON.stringify({storeClass:Ext.getClassName(this),
storeData:c})});embed.call(this,a,b)}});Ext.define("Voyant.data.store.CAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CA","proxy.reader.rootProperty":"correspondenceAnalysis","proxy.reader.totalProperty":"correspondenceAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.CAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.ContextsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Context",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentContexts","proxy.reader.rootProperty":"documentContexts.contexts","proxy.reader.totalProperty":"documentContexts.total"}])}});
Ext.define("Voyant.data.store.Contexts",{extend:"Ext.data.Store",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.ContextsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.ContextsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.ContextsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusCollocatesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusCollocate",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusCollocates","proxy.reader.rootProperty":"corpusCollocates.collocates","proxy.reader.totalProperty":"corpusCollocates.total"}])}});
Ext.define("Voyant.data.store.CorpusCollocates",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.CorpusCollocatesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusCollocatesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusCollocatesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusFacet,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusFacets","proxy.reader.rootProperty":"corpusFacets.facets","proxy.reader.totalProperty":"corpusFacets.total"}])}});
Ext.define("Voyant.data.store.CorpusFacets",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusFacetsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusFacetsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusFacetsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:Voyant.data.model.CorpusTerm,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusTerms","proxy.reader.rootProperty":"corpusTerms.terms","proxy.reader.totalProperty":"corpusTerms.total"}])},show:function(a){show(this.getString(a))}});
Ext.define("Voyant.data.store.CorpusTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.CorpusTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusTermsMixin"],model:Voyant.data.model.CorpusTerm,constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentQueryMatchesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentQueryMatch",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsFinder","proxy.reader.rootProperty":"documentsFinder.queries","proxy.reader.totalProperty":void 0,"proxy.reader.metaProperty":"documentsFinder.corpus"}])}});
Ext.define("Voyant.data.store.DocumentQueryMatches",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentQueryMatchesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentQueryMatchesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentQueryMatchesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentTerm",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTerms","proxy.reader.rootProperty":"documentTerms.terms","proxy.reader.totalProperty":"documentTerms.total"}])}});
Ext.define("Voyant.data.store.DocumentTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentEntitiesMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.DocumentEntity",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentEntities","proxy.reader.rootProperty":"documentEntities.entities","proxy.reader.totalProperty":"documentEntities.total"}])}});
Ext.define("Voyant.data.store.DocumentEntities",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentEntitiesBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentEntitiesMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentEntitiesMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocumentsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Document",statics:{i18n:{}},sorters:{property:"index",direction:"ASC"},remoteSort:!0,constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentsMetadata","proxy.reader.rootProperty":"documentsMetadata.documents","proxy.reader.totalProperty":"documentsMetadata.total"}])},listeners:{load:function(a,b,c,d){if(c){var e=
a.getCorpus();b.forEach(function(f){f.set("corpus",e)})}}},getDocument:function(a){return Ext.isNumber(a)?this.getAt(a):this.getById(a)}});Ext.define("Voyant.data.store.Documents",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocumentsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocumentsMixin"],model:"Voyant.data.model.Document",constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocumentsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.PCA","proxy.reader.rootProperty":"pcaAnalysis","proxy.reader.totalProperty":"pcaAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.PCAAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.PCAAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.PCAAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.PCAAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.DocSimAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentSimilarity","proxy.reader.rootProperty":"documentSimilarity","proxy.reader.totalProperty":"documentSimilarity.total"}]);a.proxy.extraParams.withDistributions=!0}});
Ext.define("Voyant.data.store.DocSimAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.DocSimAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.DocSimAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.DocSimAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.CorpusNgram",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusNgrams","proxy.reader.rootProperty":"corpusNgrams.ngrams","proxy.reader.totalProperty":"corpusNgrams.total"}])}});
Ext.define("Voyant.data.store.CorpusNgrams",{extend:"Ext.data.Store",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.CorpusNgramsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.CorpusNgramsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.CorpusNgramsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.RelatedTermsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.RelatedTerm",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.SemanticGraph","proxy.reader.rootProperty":"semanticGraph.edges","proxy.reader.totalProperty":"semanticGraph.total"}])}});
Ext.define("Voyant.data.store.RelatedTerms",{extend:"Ext.data.Store",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.RelatedTermsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.RelatedTermsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.RelatedTermsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TermCorrelationsMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.TermCorrelation",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.CorpusTermCorrelations","proxy.extraParams.withDistributions":"true","proxy.reader.rootProperty":"termCorrelations.correlations","proxy.reader.totalProperty":"termCorrelations.total"}])}});
Ext.define("Voyant.data.store.TermCorrelations",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[a]);this.callParent([a])}});
Ext.define("Voyant.data.store.TermCorrelationsBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TermCorrelationsMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TermCorrelationsMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensMixin",{mixins:["Voyant.data.store.VoyantStore"],model:"Voyant.data.model.Token",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.DocumentTokens","proxy.reader.rootProperty":"documentTokens.tokens","proxy.reader.totalProperty":"documentTokens.total"}])}});
Ext.define("Voyant.data.store.Tokens",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TokensBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TokensMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TokensMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TSNEAnalysisMixin",{mixins:["Voyant.data.store.VoyantStore"],embeddable:["Voyant.panel.ScatterPlot"],model:"Voyant.data.model.StatisticalAnalysis",constructor:function(a){this.mixins["Voyant.data.store.VoyantStore"].constructor.apply(this,[a,{"proxy.extraParams.tool":"corpus.TSNE","proxy.reader.rootProperty":"tsneAnalysis","proxy.reader.totalProperty":"tsneAnalysis.totalTerms"}]);a.proxy.extraParams.withDistributions=!0;a.proxy.extraParams.noCache=1}});
Ext.define("Voyant.data.store.TSNEAnalysis",{extend:"Ext.data.Store",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.store.TSNEAnalysisBuffered",{extend:"Ext.data.BufferedStore",mixins:["Voyant.data.store.TSNEAnalysisMixin"],constructor:function(a){a=a||{};this.mixins["Voyant.data.store.TSNEAnalysisMixin"].constructor.apply(this,[a]);this.callParent([a])}});Ext.define("Voyant.data.util.NetworkGraph",{alternateClassName:["NetworkGraph"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show"],embeddable:["Voyant.widget.VoyantNetworkGraph"],config:{edges:[],nodes:[]},constructor:function(a,b){a=a||{};this.setEdges(Ext.Array.from(a.edges));this.setNodes(Ext.Array.from(a.nodes));this.callParent([a])},addEdge:function(a,b,c){this.getEdges().push(Ext.isObject(a)?a:{source:a,target:b,value:c})},getNode:function(a){return Ext.Array.binarySearch(this.getNodes(),
a,void 0,void 0,function(b,c){return b.term<c.term?-1:b.term>c.term?1:0})},embed:function(a,b){!b&&Ext.isObject(a)&&(b=a,a=this.embeddable[0]);b=b||{};var c={edges:this.getEdges(),nodes:this.getNodes(),config:b};if(b.limit&&c.edges.length>b.limit){c.edges=c.edges.slice(0,b.limit);var d={};c.edges.forEach(function(f){d["_"+f.source]=!0;d["_"+f.target]=!0});var e=[];c.nodes.forEach(function(f){"_"+f.term in d&&e.push(f)});c.nodes=e}Ext.apply(b,{jsonData:JSON.stringify(c)});embed.call(this,a,b)},getString:function(a){return this.getEdges().map(function(b){b.source+
"-"+b.target}).join("; ")}});Ext.define("Voyant.data.util.Geonames",{mixins:["Voyant.util.Localization"],statics:{i18n:{}},config:{data:{},queries:void 0,corpus:void 0,isIncrementalLoadingOccurrences:!1,previousParams:{}},constructor:function(a,b){a=a||{};this.callParent([a]);this.setCorpus(a.corpus)},load:function(a,b){this.setPreviousParams(a);b=b||Voyant.application.getDeferred(this);var c=this,d={corpus:this.getCorpus().getAliasOrId(),queries:this.getQueries(),tool:"corpus.Dreamscape",limit:200};Ext.apply(d,a||{});a.noOverwrite||
c.setData({});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:d,scope:this}).then(function(e){(e=Ext.JSON.decode(e.responseText))&&e.dreamscape&&e.dreamscape.progress&&new Voyant.widget.ProgressMonitor({progress:e.dreamscape.progress,maxMillisSinceStart:36E5,tool:"corpus.Dreamscape",success:function(){c.load.call(c,a,b)},failure:function(f){Voyant.application.showResponseError(c.localize("failedToFetchGeonames"),f)},scope:c});e&&e.dreamscape&&!e.dreamscape.progress&&(a.noOverwrite||
c.setData(e.dreamscape),b.resolve(e))},function(e){Voyant.application.showResponseError(c.localize("failedToFetchGeonames"),e)});return b.promise},getCitiesCount:function(){return Object.keys(this.getData().locations.locations).length},getTotalCitiesCount:function(){return this.getData().locations.total},hasMoreCities:function(){return this.getCitiesCount()<this.getTotalCitiesCount()},eachCity:function(a,b,c){var d=this.getData().locations.locations,e=[],f;for(f in d)e.push(Ext.apply(d[f],{id:f}));
e.sort(function(g,h){return g.rawFreq==h.rawFreq?g.label-h.label:h.rawFreq-g.rawFreq});c&&e.length>c&&(e=e.slice(0,c));e.forEach(function(g){a.call(b,g)})},getConnectionsCount:function(){return this.getData().connections.connections.length},getTotalConnectionsCount:function(){return this.getData().connections.total},eachConnection:function(a,b,c){var d=this.getData().connections.connections,e=this.getData().locations.locations;orderedConnections=[];for(var f=0,g=d.length;f<g&&!(a.call(b,{source:Ext.apply({id:d[f].source},
e[d[f].source]),target:Ext.apply({id:d[f].target},e[d[f].target]),rawFreq:d[f].rawFreq}),f>c);f++);},getConnectionOccurrence:function(a){if(this.getData().locations){var b=this.getData().connectionOccurrences,c=b.connectionOccurrences;locations=this.getData().locations.locations;if(!this.getIsIncrementalLoadingOccurrences()&&c.length<b.total&&a+100>c.length){this.setIsIncrementalLoadingOccurrences(!0);var d=this;b={};Ext.apply(b,this.getPreviousParams);Ext.apply(b,{start:c.length,noOverwrite:!0,suppressLocations:!0,
suppressConnections:!0});this.load(b).then(function(e){d.setIsIncrementalLoadingOccurrences(!1);d.getData().connectionOccurrences.connectionOccurrences=c.concat(e.dreamscape.connectionOccurrences.connectionOccurrences)})}return c&&c[a]?(b=c[a],b.index=a,Ext.apply(b.source,locations[b.source.location]),Ext.apply(b.target,locations[b.target.location]),b):null}},getAllConnectionOccurrences:function(a,b){debugger;for(var c=[],d=0;d<this.getTotalConnectionsCount();d++){var e=this.getConnectionOccurrence(d);
e&&e.target.id==b&&e.source.id==a&&c.push(e)}return c}});Ext.define("Voyant.data.model.Corpus",{alternateClassName:["Corpus"],mixins:["Voyant.notebook.util.Embed","Voyant.notebook.util.Show","Voyant.util.Transferable","Voyant.util.Localization","Voyant.util.Assignable"],transferable:"loadCorpusTerms loadTokens getPlainText getText getWords getString getLemmasArray".split(" "),embeddable:"Voyant.panel.Summary Voyant.panel.Cirrus Voyant.panel.Documents Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Trends Voyant.panel.TermsRadio Voyant.panel.DocumentTerms Voyant.panel.TermsBerry Voyant.panel.CollocatesGraph Voyant.panel.Contexts Voyant.panel.WordTree Voyant.panel.Veliza Voyant.panel.ScatterPlot Voyant.panel.Topics".split(" "),
requires:["Voyant.util.ResponseError","Voyant.data.store.CorpusTerms","Voyant.data.store.Documents"],extend:"Ext.data.Model",config:{documentsStore:void 0},statics:{i18n:{}},fields:[{name:"documentsCount",type:"int"},{name:"lexicalTokensCount",type:"int"},{name:"lexicalTypesCount",type:"int"},{name:"createdTime",type:"int"},{name:"createdDate",type:"date",dateFormat:"c"},{name:"title",type:"string"},{name:"subTitle",type:"string"},{name:"languagueCodes",type:"string"}],constructor:function(a,b){a=
a||{};b=b||{};this.callParent([]);var c=Voyant.application.getDeferred(this);if(Ext.isString(a))0==/\s/.test(a)&&-1==a.indexOf(":")?Ext.apply(b,{corpus:a}):Ext.apply(b,{input:a});else if(Ext.isArray(a))Ext.apply(b,{input:a});else if(Ext.isObject(a))Ext.apply(b,a);else return Voyant.application.showError(this.localize("badDataTypeCorpus")+": ("+typeof a+") "+a),Ext.defer(function(){c.reject(this.localize("badDataTypeCorpus")+": ("+typeof a+") "+a)},50,this),c.promise;if(Ext.isObject(b)){if(!b.corpus&&
!b.input&&!b.inlineData)return Voyant.application.showError(this.localize("noCorpusOrInput")+": "+b),Ext.defer(function(){c.reject(this.localize("noCorpusOrInput")+": "+b)},50,this),c.promise;Ext.apply(b,{tool:"corpus.CorpusMetadata"});var d=this;Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),params:b}).then(function(e){d.set(Ext.JSON.decode(e.responseText).corpus.metadata);if(b.title||b.subTitle)d.set("title",b.title),d.set("subTitle",b.subTitle);return d},function(e){Voyant.application.showResponseError(d.localize("failedCreateCorpus"),
e)}).then(function(e){0==e.getDocumentsCount()&&Voyant.application.showError(d.localize("thisCorpus")+" "+d.localize("isEmpty")+".");!("docsLimit"in b)||!1!==b.docsLimit&&0<b.docsLimit?d.getDocuments().load({params:{limit:"docsLimit"in b?b.docsLimit:d.getDocumentsCount()},callback:function(f,g,h){h?(d.setDocumentsStore(this),c.resolve(e)):c.reject(g)}}):c.resolve(e)})}else Voyant.application.showError(this.localize("badDataTypeCorpus")+": ("+typeof b+") "+b),Ext.defer(function(){c.reject(this.localize("badDataTypeCorpus")+
": ("+typeof b+") "+b)},50,this);return c.promise},getId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("id")},getAliasOrId:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("alias")||this.get("id")},loadCorpusTerms:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,
{limit:0});var c=this.getCorpusTerms();c.load({params:a,callback:function(d,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},loadTokens:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getTokens();c.load({params:a,callback:function(d,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getCorpusTerms:function(a){return Ext.create("Voyant.data.store.CorpusTerms",
Ext.apply(a||{},{corpus:this}))},getTokens:function(a){return Ext.create("Voyant.data.store.Tokens",Ext.apply(a||{},{corpus:this}))},each:function(a,b){this.getDocuments().each(function(c,d){a.call(b||c,c,d)})},map:function(a,b){return this.getDocuments().getRange().map(function(c,d){return a.call(b||c,c,d)},b||this)},getCorpusCollocates:function(a){return Ext.create("Voyant.data.store.CorpusCollocates",Ext.apply(a||{},{corpus:this}))},getDocumentQueryMatches:function(a){return Ext.create("Voyant.data.store.DocumentQueryMatches",
Ext.apply(a||{},{corpus:this}))},getDocumentTerms:function(a){return Ext.create("Voyant.data.store.DocumentTerms",Ext.apply(a||{},{corpus:this}))},getDocumentEntities:function(a){return Ext.create("Voyant.data.store.DocumentEntities",Ext.apply(a||{},{corpus:this}))},loadContexts:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});var c=this.getContexts();
c.load({params:a,callback:function(d,e,f){f?b.resolve(c):b.reject(e)}});return b.promise},getContexts:function(a){return Ext.create("Voyant.data.store.Contexts",Ext.apply(a||{},{corpus:this}))},getDocuments:function(a){return this.getDocumentsStore()?this.getDocumentsStore():Ext.create("Voyant.data.store.Documents",Ext.apply(a||{},{corpus:this}))},getDocument:function(a){if(this.getDocumentsStore()){if(a instanceof Voyant.data.model.Document)return a;if(Ext.isNumeric(a))return this.getDocumentsStore().getAt(parseInt(a));
if(Ext.isString(a))return this.getDocumentsStore().getById(a)}return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.getDocumentsStore().getDocument(a)},getDocumentsCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("documentsCount")},getWordTokensCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("lexicalTokensCount")},getWordTypesCount:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,
arguments):this.get("lexicalTypesCount")},getCreatedTime:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("createdTime")},requiresPassword:function(){var a=this.getNoPasswordAccess();return"NONE"==a||"NONCONSUMPTIVE"==a},getNoPasswordAccess:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("noPasswordAccess")},getTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):
this.get("title")},getSubTitle:function(){return this.then?Voyant.application.getDeferredNestedPromise(this,arguments):this.get("subTitle")},getRelatedWords:function(a){return Ext.create("Voyant.data.store.RelatedTerms",Ext.apply(a||{},{corpus:this}))},loadRelatedWords:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)&&(a={limit:a});Ext.applyIf(a,{limit:0});this.getRelatedWords().load({params:a,
callback:function(c,d,e){e?b.resolve(c):b.reject(d.error.response)}});return b.promise},getText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments,this);var b=Voyant.application.getDeferred(this);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.applyIf(a,{limit:0,outputFormat:"text",template:"docTokens2text"});Ext.apply(a,{tool:"corpus.DocumentTokens",corpus:this.getAliasOrId()});Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:a,success:function(c,d){c=c.responseText.trim();a.transformCase&&(-1<a.transformCase.indexOf("lower")?c=c.toLowerCase():-1<a.transformCase.indexOf("upper")&&(c=c.toUpperCase()));b.resolve(c)},failure:function(c,d){b.reject(c)},scope:this});return b.promise},getPlainText:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.apply(a,{template:"docTokens2plainText"});return this.getText(a)},
getWords:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);a=a||{};Ext.isNumber(a)?a={limit:a}:Ext.isString(a)&&(a={limit:parseInt(a)});Ext.applyIf(a,{template:"docTokens2words"});return this.getText(a)},getWordsArray:function(a){if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);this.getWords(a).then(function(c){b.resolve(c.split(" "))});return b.promise},getLemmasArray:function(a){a=
a||{};if(this.then)return Voyant.application.getDeferredNestedPromise(this,arguments);var b=Voyant.application.getDeferred(this);Ext.applyIf(a,{template:"docTokens2lemmas",withPosLemmas:!0,noOthers:!0});this.getWords(a).then(function(c){c=c.split(" ").map(function(d){return d.substring(0,d.indexOf("/"))});b.resolve(c)});return b.promise},getString:function(a){var b=this.getDocumentsCount(),c=this.localize("thisCorpus");if(0==b)c+=" "+this.localize("isEmpty")+".";else{c+=" ";c=1<b?c+(new Ext.XTemplate(this.localize("hasNdocuments"))).apply({count:Ext.util.Format.number(b,
"0,000")}):c+this.localize("has1document");c+=" "+(new Ext.XTemplate(this.localize("widthNwordsAndNTypes"))).apply({words:Ext.util.Format.number(this.getWordTokensCount(),"0,000"),types:Ext.util.Format.number(this.getWordTypesCount(),"0,000")})+".";c+=" "+this.localize("created")+" ";var d=this.get("createdDate"),e=new Date;!0===Ext.Array.each([["year",Ext.Date.YEAR],["month",Ext.Date.MONTH],["day",Ext.Date.DAY],["hour",Ext.Date.HOUR],["minute",Ext.Date.MINUTE],["second",Ext.Date.SECOND]],function(f){if(Ext.Date.diff(d,
e,f[1])>("second"==f[0]?1:0)){var g=Ext.Date.diff(d,e,f[1]);c+="<span class='info-tip' data-qtip='"+Ext.Date.format(d,"Y-m-d, H:i:s")+"'>";c=1==g?c+(new Ext.XTemplate(this.localize(f[0]+"Ago"))).apply({count:g,date:d}):c+(new Ext.XTemplate(this.localize(f[0]+"sAgo"))).apply({count:g,date:d});c+="</span>";return!1}},this)&&(c+=this.localize("now"));c+=".";c+=""}!0===a&&(c+=" ("+this.getId()+")");return c}});Ext.define("Voyant.widget.CorpusSelector",{extend:"Ext.form.field.ComboBox",mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.corpusselector",statics:{i18n:{},api:{openMenu:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var b=[["shakespeare","Shakespeare's Plays"],["austen","Austen's Novels"]];this.getApiParam("openMenu")?b=this.getStoreItemsFromDefinition(this.getApiParam("openMenu")):Voyant.application&&Voyant.application.getOpenMenu&&
Voyant.application.getOpenMenu()&&(b=Voyant.application.getOpenMenu(),b=decodeURIComponent(b),b=b.replace(/\+/g," "),'"'==b.charAt(0)&&'"'==b.charAt(b.length-1)&&(b=b.substring(1,b.length-1)),b=this.getStoreItemsFromDefinition(b));Ext.applyIf(a,{fieldLabel:this.localize("chooseCorpus"),labelWidth:125,labelAlign:"right",name:"corpus",queryMode:"local",store:b});this.callParent([a])},initComponent:function(a){a=a||{};this.callParent([a])},getStoreItemsFromDefinition:function(a){var b=[];a=a.split(";");
for(var c=0;c<a.length;c++){var d=a[c].split(":");d[0]&&b.push([d[0],d[1]?d[1]:d[0]])}return b}});Ext.define("Voyant.widget.ListEditor",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.listeditor",layout:"hbox",statics:{i18n:{}},initComponent:function(a){var b=this.up("window").panel.getApiParam(this.name),c=b?[{name:b,value:b}]:[];c.splice(0,0,{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize(this.name+"Label"),
labelAlign:"right",name:this.name,displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this}]});this.callParent(arguments)},editList:function(){var a=this.up("window").panel,b=this.down("combo").getValue();Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.KeywordsManager",list:b},success:function(c){c=Ext.util.JSON.decode(c.responseText).keywords.keywords.sort().join("\n");
Ext.Msg.show({title:this.localize("editListTitle"),message:this.localize("editListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:c,original:c,fn:function(d,e,f){"ok"==d&&f.original!=e&&(d=this.down("combo"),0==Ext.String.trim(e).length?d.setValue("empty"):Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:e},combo:d,success:function(g,h){var k=Ext.util.JSON.decode(g.responseText);
g=h.combo.getStore();k="keywords-"+k.storedResource.id;g.add({name:k,value:k});h.combo.setValue(k);h.combo.updateLayout()},scope:this}))},scope:this})},scope:this})}});Ext.define("Voyant.widget.StopListOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.stoplistoption",layout:"hbox",statics:{stoplists:{ar:"stop.ar.arabic-lucene.txt",bg:"stop.bu.bulgarian-lucene.txt",br:"stop.br.breton-lucene.txt",ca:"stop.ca.catalan-lucene.txt",ckb:"stop.ckb-turkish-lucene.txt",cn:"stop.cn.chinese-lawrence.txt",cz:"stop.cz.czech-lucene.txt",de:"stop.de.german.txt",el:"stop.el.greek-lucene.txt",en:"stop.en.taporware.txt",es:"stop.es.spanish.txt",
eu:"stop.eu.basque-lucene.txt",fa:"stop.fa.farsi-lucene.txt",fr:"stop.fr.veronis.txt",ga:"stop.ga-irish-lucene.txt",gl:"stop.ga.galician-lucene.txt",grc:"stop.grc.ancient-greek.txt",hi:"stop.hi.hindi-lucene.txt",hu:"stop.hu.hungarian.txt",hy:"stop.hy.armenian-lucene.txt",id:"stop.id.indonesian-lucene.txt",it:"stop.it.italian.txt",ja:"stop.ja.japanese-lucene.txt",la:"stop.la.latin.txt",lv:"stop.lv.latvian-lucene.txt",lt:"stop.lt.lithuanian-lucene.txt",mu:"stop.mu.multi.txt",nl:"stop.nl.dutch.txt",
no:"stop.no.norwegian.txt",pt:"stop.pt.brazilian.txt",ro:"stop.ro.romanian-lucene.txt",ru:"stop.ru.russian.txt",se:"stop.se.swedish-long.txt",th:"stop.th.thai-lucene.txt",tr:"stop.tr.turkish-lucene.txt"},i18n:{}},initComponent:function(a){var b=this.up("window").panel.getApiParam("stopList"),c=[];for(id in Voyant.widget.StopListOption.stoplists)c.push({name:this.localize(id),value:Voyant.widget.StopListOption.stoplists[id]});c.sort(function(d,e){return d.name<e.name?-1:1});c.splice(0,0,{name:this.localize("auto"),
value:"auto"},{name:this.localize("none"),value:""},{name:this.localize("new"),value:"new"});Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("label"),labelAlign:"right",name:"stopList",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editList,scope:this},{width:10},{xtype:"checkbox",name:"stopListGlobal",
checked:!0,boxLabel:this.localize("applyGlobally")}]});this.callParent(arguments)},editList:function(){var a=this.up("window").panel,b=this.down("combo").getValue(),c=a.getApplication&&a.getApplication().getCorpus?a.getApplication().getCorpus().getId():void 0;"auto"!=b||c?Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:b,corpus:c},success:function(d){d=Ext.util.JSON.decode(d.responseText).keywords.keywords.sort().join("\n");Ext.Msg.show({title:this.localize("editStopListTitle"),
message:this.localize("editStopListMessage"),buttons:Ext.Msg.OKCANCEL,buttonText:{ok:this.localize("ok"),cancel:this.localize("cancel")},icon:Ext.Msg.INFO,prompt:!0,multiline:!0,value:d,original:d,fn:function(e,f,g){f=f.toLowerCase();"ok"==e&&g.original!=f&&(e=this.down("combo"),0==Ext.String.trim(f).length?e.setValue("empty"):Ext.Ajax.request({url:a.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:f,corpus:c},combo:e,success:function(h,k){var l=Ext.util.JSON.decode(h.responseText);
h=k.combo.getStore();l="keywords-"+l.storedResource.id;h.add({name:l,value:l});k.combo.setValue(l);k.combo.updateLayout()},scope:this}))},scope:this})},scope:this}):Ext.Msg.show({title:this.localize("noEditAutoTitle"),message:this.localize("noEditAutoMessage"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}});Ext.define("Voyant.widget.QuerySearchField",{extend:"Ext.form.field.Tag",mixins:["Voyant.util.Localization"],alias:"widget.querysearchfield",statics:{i18n:{}},config:{corpus:void 0,tokenType:"lexical",isDocsMode:!1,inDocumentsCountOnly:void 0,stopList:void 0,showAggregateInDocumentsCount:!1,clearOnQuery:!1,parentPanel:void 0,currentOriginalRawQueryPlan:void 0},hasCorpusLoadedListener:!1,isClearing:!1,constructor:function(a){a=a||{};Ext.applyIf(a,{minWidth:100,maxWidth:200,matchFieldWidth:!1,minChars:2,
displayField:"term",valueField:"term",filterPickList:!0,createNewOnEnter:!0,createNewOnBlur:!1,autoSelect:!1,tpl:['<ul class="x-list-plain"><tpl for=".">','<li role="option" class="x-boundlist-item" style="white-space: nowrap;">'+(a.itemTpl?a.itemTpl:a.inDocumentsCountOnly?"<tpl><tpl if=\"term.charAt(0)=='@'\">{term}</tpl><tpl if=\"term.charAt(0)!='@'\">{term} ({inDocumentsCount})</tpl></tpl>":"<tpl><tpl if=\"term.charAt(0)=='@'\">{term}</tpl><tpl if=\"term.charAt(0)!='@'\">{term} ({rawFreq})</tpl></tpl>")+
"</li>","</tpl></ul>"],triggers:{help:{weight:2,cls:"fa-trigger form-fa-help-trigger",handler:function(){Ext.Msg.show({title:this.localize("querySearch"),message:this.getIsDocsMode()?this.localize("querySearchDocsModeTip"):this.localize("querySearchTip"),buttons:Ext.OK,icon:Ext.Msg.INFO})},scope:"this"}}});a.showAggregateInDocumentsCount&&(a.triggers.count={cls:"fa-trigger",handler:"onHelpClick",scope:"this",hidden:!0});a.clearOnQuery&&this.setClearOnQuery(a.clearOnQuery);this.callParent(arguments)},
initComponent:function(a){var b=this;b.on("beforequery",function(d){if(d.query){d.query=d.query.trim();var e=d.query.toLowerCase();this.setCurrentOriginalRawQueryPlan(d.query);if("@"!=d.query.charAt(0)){"^"==d.query.charAt(0)&&(d.query=d.query.substring(1),d.cancel=0==d.query.length);"*"==d.query.charAt(0)&&(d.query="."+d.query);if("*"==d.query.charAt(d.query.length-1)||"|"==d.query.charAt(d.query.length-1))d.query=d.query.substring(0,d.query.length-1),d.cancel=0==d.query.length;"."==d.query.charAt(0)&&
(d.cancel=d.query.length<(/\W/.test(d.query.charAt(1))?5:4));try{new RegExp(d.query)}catch(k){d.cancel=!0}-1<d.query.indexOf('"')&&(-1==d.query.indexOf(" ")&&(d.cancel=!0),2!=(d.query.match(/"/)||[]).length&&(d.cancel=!0));-1<d.query.indexOf("*")?-1==d.query.indexOf(" ")&&-1==d.query.indexOf("|")&&(d.query+=",^"+d.query):d.query=d.query+"*"+(-1==d.query.indexOf(" ")&&-1==d.query.indexOf("|")?",^"+d.query+"*":"")}else"@"==d.query&&(d.cancel=!0);var f=b.getParentPanel();if(0==d.cancel&&f){var g="@"==
e.charAt(0)?e.substring(1):e,h;for(h in f.getApplication().getCategoriesManager().getCategories())-1<h.toLowerCase().indexOf(g)&&(d.query="@"+h+("@"==e.charAt(0)?"":","+d.query))}}},this);b.on("change",function(d,e){b.isClearing?b.isClearing=!1:(e=e.map(function(f){return f.replace(/^(\^?)\*/,"$1.*")}),b.up("panel").fireEvent("query",b,e),b.getClearOnQuery()&&(b.isClearing=!0,b.removeValue(b.getValueRecords())),b.triggers.count&&(b.triggers.count.show(),b.triggers.count.getEl().setHtml("0"),0<e.length?
b.getCorpus().getCorpusTerms().load({params:{query:e.map(function(f){return"("+f+")"}).join("|"),tokenType:b.getTokenType(),stopList:b.getStopList(),inDocumentsCountOnly:!0},callback:function(f,g,h){h&&f&&1==f.length&&b.triggers.count.getEl().setHtml(f[0].getInDocumentsCount())}}):b.triggers.count.hide()))});var c=b.findParentBy(function(d){return d.mixins["Voyant.panel.Panel"]});if(null!=c){this.setParentPanel(c);if(c.getCorpus&&c.getCorpus())b.on("afterrender",function(d){this.doSetCorpus(c.getCorpus())});
else c.on("loadedCorpus",function(d,e){b.doSetCorpus(e)},b);b.hasCorpusLoadedListener=!0}b.on("afterrender",function(d){!1!==b.hasCorpusLoadedListener||b.getCorpus()||(c=b.findParentBy(function(e){return e.mixins["Voyant.panel.Panel"]}),null==c&&(c=b.up("window").panel),d=c.getApplication().getCorpus(),void 0!==d?b.doSetCorpus(d):(c.on("loadedCorpus",function(e,f){b.doSetCorpus(f)},b),b.hasCorpusLoadedListener=!0));b.triggers&&b.triggers.help&&Ext.tip.QuickTipManager.register({target:b.triggers.help.getEl(),
text:b.getIsDocsMode()?b.localize("querySearchDocsModeTip"):b.localize("querySearchTip")});b.triggers&&b.triggers.count&&Ext.tip.QuickTipManager.register({target:b.triggers.count.getEl(),text:b.localize("aggregateInDocumentsCount")})});b.on("beforedestroy",function(d){b.triggers&&b.triggers.help&&Ext.tip.QuickTipManager.unregister(b.triggers.help.getEl());b.triggers&&b.triggers.count&&Ext.tip.QuickTipManager.unregister(b.triggers.count.getEl())});b.callParent(arguments)},doSetCorpus:function(a){if(null!=
a){this.setCorpus(a);if(void 0==this.getStopList())if(this.getApiParam)this.setStopList(this.getApiParam("stopList"));else for(var b=this.up("panel");b;){if(b&&b.getApiParam){this.setStopList(b.getApiParam("stopList"));break}b=b.up("panel")}var c=this.getApiParam?this.getApiParam("categories"):void 0;if(!c)for(b=this.up("panel");b;){if(b&&b.getApiParam){c=b.getApiParam("categories");break}b=b.up("panel")}a=a.getCorpusTerms({corpus:a.getAliasOrId(),proxy:{extraParams:{limit:10,tokenType:this.tokenType,
stopList:this.getStopList(),inDocumentsCountOnly:this.getInDocumentsCountOnly(),categories:c}}});this.setStore(a)}}});Ext.define("Voyant.widget.TotalPropertyStatus",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.totalpropertystatus",statics:{i18n:{}},initComponent:function(){Ext.applyIf(this,{tpl:this.localize("totalPropertyStatus"),itemId:"totalpropertystatus",style:"margin-right:5px",listeners:{afterrender:function(a){var b=a.up("grid");if(b){var c=b.getStore();a.updateStatus(c.getTotalCount());b.getStore().on("totalcountchange",a.updateStatus,a)}}}});this.callParent(arguments)},updateStatus:function(a){this.update({count:a})}});Ext.define("Voyant.widget.DocumentSelector",{mixins:["Voyant.util.Localization"],alias:"widget.documentselector",glyph:"xf10c@FontAwesome",statics:{i18n:{}},config:{docs:void 0,corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("documents"),menu:{width:250,fbar:[{xtype:"checkbox",hidden:this.getSingleSelect(),boxLabel:this.localize("all"),listeners:{change:{fn:function(a,
b){this.getMenu().items.each(function(c){c.setChecked(b)})},scope:this}}},{xtype:"tbfill"},{xtype:"button",text:this.localize("ok"),hidden:this.getSingleSelect(),scale:"small",handler:function(a,b){var c=[];this.getMenu().items.each(function(d){d.checked&&c.push(d.docId)},this);(b=a.findParentBy(function(d){return d.mixins["Voyant.panel.Panel"]}))&&b.fireEvent("documentsSelected",a,c);a.findParentBy(function(d){return d.isXType("button")&&d.hasVisibleMenu()?(d.hideMenu(),!0):!1})},scope:this},{xtype:"button",
text:this.localize("cancel"),scale:"small",handler:function(a,b){this.findParentBy(function(c){return c.isXType("button")&&c.hasVisibleMenu()?(c.hideMenu(),!0):!1},this);this.hideMenu()},scope:this}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(c,d){this.setCorpus(d);1==d.getDocumentsCount()?this.hide():a.populate(d.getDocumentsStore().getRange(),!0)},a);var b=a.findParentBy(function(c){return c.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",function(c,d){a.fireEvent("loadedCorpus",
c,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}})},populate:function(a,b){this.setDocs(a);var c=this.getMenu();b&&c.removeAll();var d=this.getSingleSelect(),e="docGroup"+Ext.id();a.forEach(function(f,g){c.add({xtype:"menucheckitem",text:f.getShortTitle(),docId:f.get("id"),checked:d&&0==g||!d,group:d?e:void 0,checkHandler:function(h,k){this.getSingleSelect()&&
k&&(h=this.findParentBy(function(l){return l.mixins["Voyant.panel.Panel"]}))&&h.fireEvent("documentSelected",this,f)},scope:this})},this)}});Ext.define("Voyant.widget.DocumentSelectorButton",{extend:"Ext.button.Button",alias:"widget.documentselectorbutton",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});
Ext.define("Voyant.widget.DocumentSelectorMenuItem",{extend:"Ext.menu.Item",alias:"widget.documentselectormenuitem",mixins:["Voyant.widget.DocumentSelector"],initComponent:function(){this.mixins["Voyant.widget.DocumentSelector"].initComponent.apply(this,arguments);this.callParent()}});Ext.define("Voyant.widget.CorpusDocumentSelector",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.corpusdocumentselector",statics:{i18n:{}},config:{corpus:void 0,singleSelect:!1},initComponent:function(){this.setSingleSelect(void 0==this.config.singleSelect?this.getSingleSelect():this.config.singleSelect);Ext.apply(this,{text:this.localize("scale"),glyph:"xf059@FontAwesome",menu:{items:[{text:this.localize("corpus"),glyph:"xf111@FontAwesome",handler:function(a){var b=
this.findParentBy(function(c){return c.mixins["Voyant.panel.Panel"]});b&&(a.nextSibling().menu.items.each(function(c){c.setChecked(!1,!0)}),b.fireEvent("corpusSelected",this,this.getCorpus()))},scope:this},{xtype:"documentselectormenuitem",singleSelect:this.getSingleSelect()}]},listeners:{afterrender:function(a){a.on("loadedCorpus",function(c,d){this.setCorpus(d);1==d.getDocumentsCount()&&this.hide()},a);var b=a.findParentBy(function(c){return c.mixins["Voyant.panel.Panel"]});b&&(b.on("loadedCorpus",
function(c,d){a.fireEvent("loadedCorpus",c,d)},a),b.getCorpus&&b.getCorpus()?a.fireEvent("loadedCorpus",a,b.getCorpus()):b.getStore&&b.getStore()&&b.getStore().getCorpus&&b.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,b.getStore().getCorpus()))}}});this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadFilenameBuilder",{extend:"Ext.form.FieldContainer",mixins:["Voyant.util.Localization","Ext.form.field.Field"],alias:"widget.downloadfilenamebuilder",statics:{i18n:{}},config:{name:"documentFilename",itemId:"documentFilename",fields:["pubDate","title","author"],value:["pubDate","title"],width:400},initComponent:function(a){a=a||{};this.initField();this.on("afterrender",function(){this.items.eachKey(function(b){new Ext.dd.DropZone(this.items.get(b).getTargetEl(),{ddGroup:"downloadfilename",
getTargetFromEvent:function(c){c=c.getTarget();return c.className&&-1<c.className.indexOf("dragsource")?c.parentNode:c},onNodeDrop:function(c,d,e,f){c.appendChild(d.el.dom);return!0}})},this);this.getFields().map(function(b){b=Ext.isString(b)?{tag:"span",html:this.localize(b+"Label"),value:b}:b;var c=this.queryById(Ext.Array.contains(this.getValue(),b.value)?"enabled":"available");b=Ext.dom.Helper.append(c.getTargetEl(),Ext.apply(b,{cls:"dragsource"}));Ext.create("Ext.dd.DragSource",b,{ddGroup:"downloadfilename"})},
this)},this);this.callParent(arguments)},defaults:{xtype:"container",width:"100%"},items:[{itemId:"enabled",cls:"dropzone dropzone-enabled"},{itemId:"available",cls:"dropzone dropzone-disabled"}],getValue:function(){return this.rendered?this.getTargetEl().query(".dropzone-enabled .dragsource").map(function(a){return a.getAttribute("value")}):this.value},setValue:function(a){this.rendered?this.getTargetEl().query(".dragsource",!1).forEach(function(b){var c=Ext.Array.contains(this.value,b.getAttribute("value"));
c&&b.parent().hasCls("dropzone-disabled")?this.queryById("enabled").getTargetEl().appendChild(b.dom):!c&&b.parent().hasCls("dropzone-enabled")&&this.queryById("available").getTargetEl().appendChild(b.dom)},this):this.value=a}});Ext.define("Voyant.widget.DownloadFileFormat",{extend:"Ext.form.CheckboxGroup",mixins:["Voyant.util.Localization"],alias:"widget.downloadfileformat",statics:{i18n:{}},initComponent:function(a){a=a||{};Ext.apply(this,{labelAlign:a.labelAlign?a.labelAlign:"right"});Ext.applyIf(this,{fieldLabel:this.localize("fieldLabel"),items:[{boxLabel:this.localize("original"),name:"documentFormat",inputValue:"SOURCE"},{boxLabel:this.localize("voyantXml"),name:"documentFormat",inputValue:"VOYANT"},{boxLabel:this.localize("plainText"),
name:"documentFormat",inputValue:"TXT"}],width:450});this.on("afterrender",function(){this.query("checkbox").forEach(function(b){var c=this.localize(b.inputValue+"Tip");-1==c.indexOf(b.inputValue+"Tip")&&Ext.tip.QuickTipManager.register({target:b.getEl(),text:c})},this)},this);this.on("beforedestroy",function(){this.query("checkbox").forEach(function(b){Ext.tip.QuickTipManager.unregister(b.getEl())},this)},this);this.callParent(arguments)}});Ext.define("Voyant.widget.DownloadOptions",{extend:"Ext.form.FieldSet",mixins:["Voyant.util.Localization"],requires:["Voyant.widget.DownloadFileFormat","Voyant.widget.DownloadFilenameBuilder"],alias:"widget.downloadoptions",statics:{i18n:{}},config:{items:[{xtype:"downloadfileformat"},{xtype:"downloadfilenamebuilder"}]},initComponent:function(a){a=a||{};Ext.apply(this,{title:a.title?a.title:this.localize("title")});this.callParent(arguments)}});Ext.define("Voyant.widget.FontFamilyOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.fontfamilyoption",statics:{i18n:{},fonts:[{name:"Georgia",value:"Georgia, serif"},{name:"Palatino",value:'"Palatino Linotype", "Book Antiqua", Palatino, serif'},{name:"Times New Roman",value:'"Times New Roman", Times, serif'},{name:"Arial",value:"Arial, Helvetica, sans-serif"},{name:"Arial Black",value:'"Arial Black", Gadget, sans-serif'},{name:"Comic Sans MS",value:'"Comic Sans MS", cursive, sans-serif'},
{name:"Impact",value:"Impact, Charcoal, sans-serif"},{name:"Lato",value:"LatoWeb"},{name:"Lucida",value:'"Lucida Sans Unicode", "Lucida Grande", sans-serif'},{name:"Tahoma/Geneva",value:"Tahoma, Geneva, sans-serif"},{name:"Trebuchet MS/Helvetica",value:'"Trebuchet MS", Helvetica, sans-serif'},{name:"Verdana/Geneva",value:"Verdana, Geneva, sans-serif"},{name:"Courrier New",value:'"Courier New", Courier, monospace'},{name:"Lucida/Monaco",value:'"Lucida Console", Monaco, monospace'}]},name:"fontFamily",
initComponent:function(a){a=a||{};var b=this.up("window").panel.getApiParam("fontFamily"),c=Ext.ClassManager.getClass(this).fonts;Ext.Array.contains(c.map(function(d){return d.value}),b)||c.splice(0,0,{name:b,value:b});Ext.apply(this,{items:{xtype:"combo",queryMode:"local",name:"fontFamily",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("label"),labelAlign:"right",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c},width:400}});this.callParent(arguments)}});Ext.define("Voyant.widget.ColorPaletteOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.colorpaletteoption",layout:"hbox",statics:{i18n:{}},paletteTpl:new Ext.XTemplate('<tpl for=".">','<div class="color" style="background-color: rgb({color});"></div>',"</tpl>"),paletteStore:new Ext.data.ArrayStore({fields:["id","color"],listeners:{update:function(a,b,c,d,e){},scope:this}}),editPaletteWin:null,spectrum:null,initComponent:function(a){var b=this.up("window").panel.getApplication(),
c=[],d;for(d in b.getPalettes())c.push({name:d,value:d});b=b.getApiParam("palette");Ext.apply(this,{items:[{xtype:"combo",queryMode:"local",value:b,triggerAction:"all",editable:!0,fieldLabel:this.localize("palette"),labelAlign:"right",name:"palette",displayField:"name",valueField:"value",store:{fields:["name","value"],data:c}},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("editList"),ui:"default-toolbar",handler:this.editPalette,scope:this}]});this.callParent(arguments)},editPalette:function(){var a=
this.down("combo").getValue();this.loadPalette(a);this.editPaletteWin=Ext.create("Ext.window.Window",{title:this.localize("paletteEditor"),modal:!0,height:300,width:425,padding:5,layout:{type:"hbox",align:"stretch"},items:[{flex:1,layout:{type:"vbox",align:"stretch"},items:[{height:24,margin:"0 0 5 0",items:[{xtype:"button",text:this.localize("add"),margin:"0 5 0 0",handler:function(b){b=this.spectrum.spectrum("get").toRgb();var c=this.editPaletteWin.down("dataview");this.paletteStore.add([[Ext.id(),
[b.r,b.g,b.b]]]);c.refresh()},scope:this},{xtype:"button",text:this.localize("remove"),margin:"0 5 0 0",handler:function(b){b=this.editPaletteWin.down("dataview");var c=b.getSelectionModel().getSelection()[0];null!=c&&this.paletteStore.remove(c);b.refresh()},scope:this},{xtype:"button",text:this.localize("clear"),handler:function(b){this.paletteStore.removeAll()},scope:this}]},{xtype:"dataview",flex:1,scrollable:"y",store:this.paletteStore,tpl:this.paletteTpl,itemSelector:"div.color",overItemCls:"over",
selectedItemCls:"selected",selectionModel:{mode:"SINGLE"},listeners:{selectionchange:function(b,c,d){null!=c[0]&&(b=c[0].get("color"),b=this.up("window").panel.getApplication().rgbToHex(b),this.spectrum.spectrum("set",b))},scope:this}}]},{itemId:"colorEditor",width:200,margin:"0 0 0 5",html:'<input type="text" style="display: none;" />'}],buttons:[{text:this.localize("saveNewPalette"),handler:function(b){this.savePalette();b.up("window").close()},scope:this},{text:this.localize("cancel"),handler:function(b){b.up("window").close()},
scope:this}],listeners:{close:function(b){this.spectrum&&(this.spectrum.spectrum("destroy"),this.spectrum=null)},scope:this}}).show();this.initSpectrum()},setColorForSelected:function(a){if(null!==this.spectrum){a=a.toRgb();a=[a.r,a.g,a.b];var b=this.editPaletteWin.down("dataview").getSelectionModel().getSelection()[0];null!=b&&b.set("color",a)}},initSpectrum:function(){if(null===this.spectrum){var a=this.editPaletteWin.down("#colorEditor").el.down("input");this.spectrum=$(a.dom).spectrum({flat:!0,
showInput:!0,showButtons:!1,preferredFormat:"hex",change:this.setColorForSelected.bind(this),move:this.setColorForSelected.bind(this)})}},loadPalette:function(a){var b=[];this.up("window").panel.getApplication().getColorPalette(a).forEach(function(c){b.push([Ext.id(),c])},this);this.paletteStore.loadData(b)},savePalette:function(){var a=[];this.paletteStore.each(function(e){a.push(e.get("color"))});var b=Ext.encode(a),c=this.up("window").panel,d=c.getCorpus().getId();Ext.Ajax.request({url:c.getTromboneUrl(),
params:{tool:"resource.StoredResource",storeResource:b,corpus:d},success:function(e,f){e=Ext.util.JSON.decode(e.responseText).storedResource.id;f=this.down("combo");f.getStore().add({name:e,value:e});f.setValue(e);f.updateLayout();c.getApplication().addColorPalette(e,a)},scope:this})}});Ext.define("Voyant.widget.VoyantChart",{extend:"Ext.chart.CartesianChart",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyantchart",statics:{i18n:{},api:{tableJson:void 0}},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},initComponent:function(a){a=a||{};this.on("afterrender",function(){if(a&&"tableJson"in a)Ext.apply(this,this.getConfigFromTableJson(a.tableJson));else if(this.getApiParam("tableJson")){var b=
this.getConfigFromTableJson();this.setAxes(b.axes);this.setSeries(b.series);this.setLegend(b.legend);this.setStore(b.store);this.redraw()}},this);this.callParent(arguments)},getConfigFromTableJson:function(a){a=a||this.getApiParam("tableJson");if(!a)return{};var b=JSON.parse(a);b.headers=b.headers.map(function(g){return g});1==b.headers.length&&(b.headers.push(1),b.rowKey=1,b.rows.forEach(function(g,h){g&&g.push(h)}));var c=[];b.rowKey||(b.rowKey=b.headers[0]);b.rows.forEach(function(g,h){if(g){var k=
{};k[b.rowKey]=h;g=g.forEach(function(l,m){k[b.headers[m]]=l});c.push(k)}});b.config||(b.config={});a={store:{fields:Object.keys(c[0]),data:c},axes:Ext.isArray(b.config.axes)?b.config.axes:[{},{}],series:[],legend:b.config.noLegend||3>Object.keys(c[0]).length?void 0:{docked:"top"}};b.config.axes||(b.config.axes=[{},{}]);a.axes.forEach(function(g,h){Ext.isObject(b.config.axes)?Ext.apply(g,b.config.axes):Ext.isArray(b.config.axes)&&Ext.apply(g,b.config.axes[h]);Ext.applyIf(g,{type:0==h?"numeric":"category",
position:0==h?"left":"bottom",label:0==h?{}:{rotation:{degrees:-30}}})});for(var d=0,e=b.headers.length;d<e;d++)if(b.headers[d]!=b.rowKey){var f={};b.config.series&&(Ext.isObject(b.config.series)?Ext.apply(f,b.config.series):Ext.isArray(b.config.series)&&Ext.apply(f,b.config.series[a.series.length]));Ext.applyIf(f,{type:"line",xField:b.rowKey,yField:b.headers[d],marker:{radius:2},highlightCfg:{scaling:2},tooltip:{trackMouse:!0,renderer:function(g,h,k){g.setHtml(h.get(k.series.getYField())+": "+h.get(k.series.getYField()))}}});
a.series.push(f)}return a}});Ext.define("Voyant.widget.LiveSearchGrid",{extend:"Ext.grid.Panel",searchValue:null,matches:[],currentIndex:null,searchRegExp:null,caseSensitive:!1,regExpMode:!1,matchCls:"keyword",initComponent:function(){this.callParent(arguments)},tagsRe:/<[^>]*>/gm,tagsProtect:"\u000f",onTextFieldChange:function(a,b){var c=this,d=0,e=c.view,f=c.visibleColumnManager.getColumns();e.refresh();c.searchValue=b;c.matches=[];c.currentIndex=null;null!==c.searchValue&&(c.searchRegExp=new RegExp(b,"g"+(c.caseSensitive?
"":"i")),c.store.each(function(g,h){var k=e.getNode(g);k&&Ext.Array.forEach(f,function(l){var m=Ext.fly(k).down(l.getCellInnerSelector(),!0),n;if(m&&0==l.isXType("widgetcolumn")){var r=m.innerHTML.match(c.tagsRe);var u=m.innerHTML.replace(c.tagsRe,c.tagsProtect);u=u.replace(c.searchRegExp,function(q){++d;n||(c.matches.push({record:g,column:l}),n=!0);return'<span class="'+c.matchCls+'">'+q+"</span>"},c);Ext.each(r,function(q){u=u.replace(c.tagsProtect,q)});m.innerHTML=u}})},c),d&&(c.currentIndex=0,
c.gotoCurrent()));null===c.currentIndex&&c.getSelectionModel().deselectAll();a.focus()},privates:{gotoCurrent:function(){var a=this.matches[this.currentIndex];this.getNavigationModel().setPosition(a.record,a.column);this.getSelectionModel().select(a.record)}}});Ext.define("Voyant.widget.ProgressMonitor",{extend:"Ext.Base",mixins:["Voyant.util.Localization"],msgbox:void 0,statics:{i18n:{}},config:{progress:void 0,scope:void 0,success:void 0,failure:void 0,args:void 0,tool:void 0,delay:1E3,maxMillisSinceStart:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);if(!a||!a.progress||!a.progress.id)return Voyant.application.showError(this.localize("noProgress"));this.initConfig(a);this.callParent(arguments);
this.update()},update:function(){var a=this.getProgress(),b=this.getScope();b=b.localize?b.localize(a.code):this.localize(a.code);b=="["+a.code+"]"&&(b=a.message);b+=" ("+parseInt(100*a.completion)+"%)";var c=this.localize(a.status.toLowerCase());this.msgbox&&this.msgbox.msg.html==b&&this.msgbox.progressBar&&this.msgbox.progressBar.getText()==c||(this.msgbox=Ext.Msg.wait(b,this.localize("progress"),{text:c}));if("LAUNCH"==a.status||"RUNNING"==a.status){var d=this;Ext.defer(function(){Ext.Ajax.request({url:Voyant.application.getTromboneUrl(),
params:{tool:"progress.ProgressMonitor",id:a.id,maxMillisSinceStart:d.getMaxMillisSinceStart()}}).then(function(e,f){(e=Ext.decode(e.responseText))&&e.progress.progress?(d.setProgress(e.progress.progress),d.update()):d.finish(!1,d.localize("badProgress"))},function(e,f){d.finish(!1,e)})},this.getDelay(),this)}else this.finish("FINISHED"==a.status,b);5E3>this.getDelay()&&this.setDelay(this.getDelay()+500)},finish:function(a,b){var c=a?this.getSuccess():this.getFailure(),d=this.getArgs(),e=this.getProgress(),
f=this.getScope();this.close();c&&c.apply?c.apply(f,[a?d:b||e]):Voyant.application.showError(b)},close:function(){this.msgbox&&this.msgbox.close();this.destroy()}});Ext.define("Voyant.widget.VoyantTableTransform",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],alias:"widget.voyanttabletransform",statics:{i18n:{},api:{tableHtml:void 0,tableJson:void 0,width:void 0,api:void 0}},html:"",config:{hiddenColumns:void 0},constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(a){var b=this;a=a||{};b.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.config.api&&this.config.api.tableJson&&
this.setApiParam("tableJson",this.config.api.tableJson);b.on("afterrender",function(){b.buildFromParams();var c=this.getTargetEl().down("table");if(c){var d=c.parent(),e=new Ext.ux.grid.TransformGrid(c,{width:this.getApiParam("width")||d.getWidth(),height:this.getApiParam("height")||20+24*c.query("tr").length});e.render(d);if(this.getHiddenColumns()){var f={};Ext.Array.from(this.getHiddenColumns()).forEach(function(g){f[g]=!0});e.getColumns().forEach(function(g){g.text in f&&g.hide()});Ext.defer(function(){e.setWidth(e.getEl().dom.parentNode.offsetWidth)},
10)}}},b);b.callParent(arguments)},buildFromParams:function(){var a=this.getApiParam("tableHtml"),b=this.getApiParam("tableJson");if(a)this.setHtml(a);else if(b){var c="<table><thead><tr>";a=JSON.parse(b);a.headers?a.headers.forEach(function(d){c+="<th>"+d+"</th>"}):a.rows[0].forEach(function(d,e){c+="<th>"+(e+1)+"</th>"});c+="</tr></thead><tbody>";a.rows.forEach(function(d){c+="<tr>";d.forEach(function(e){c+="<td>"+e+"</td>"});c+="</tr>"});c+="</tbody></table>";this.setHtml(c);a.config&&a.config.hidden&&
this.setHiddenColumns(a.config.hidden)}}});
Ext.define("Ext.ux.grid.TransformGrid",{extend:"Ext.grid.Panel",constructor:function(a,b){b=Ext.apply({},b);this.table=Ext.get(a);for(var c=b.fields||[],d=b.columns||[],e=[],f=[],g=a.query("thead th"),h=0,k=g.length,l=a.dom,m,n,r,u;h<k;++h)n=g[h],r=n.innerHTML,u="tcol-"+h,e.push(Ext.applyIf(c[h]||{},{name:u,mapping:"td:nth("+(h+1)+")/@innerHTML"})),f.push(Ext.applyIf(d[h]||{},{text:r,dataIndex:u,flex:1,tooltip:n.title,sortable:!0}));a=b.width?b.width:a.getWidth()+1;b.height&&(m=b.height);Ext.applyIf(b,
{store:{data:l,fields:e,proxy:{type:"memory",reader:{record:"tbody tr",type:"xml"}}},columns:f,width:a,height:m});this.callParent([b]);!1!==b.remove&&l.parentNode.removeChild(l)},doDestroy:function(){this.table.remove();this.tabl=null;this.callParent()}});Ext.define("Voyant.widget.CategoriesOption",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.categoriesoption",statics:{i18n:{}},config:{builderWin:void 0},initComponent:function(){var a=this.up("window").panel.getApiParam("categories"),b=a?[{name:a,value:a}]:[];Ext.apply(this,{layout:"hbox",items:[{xtype:"combo",queryMode:"local",triggerAction:"all",fieldLabel:this.localize("categories"),labelAlign:"right",displayField:"name",valueField:"value",store:{fields:["name",
"value"],data:b},name:"categories",value:a},{width:10},{xtype:"tbspacer"},{xtype:"button",text:this.localize("edit"),ui:"default-toolbar",handler:function(){if(void 0===this.getBuilderWin()){var c=this.up("window").panel;c=Ext.create("Voyant.widget.CategoriesBuilder",{panel:c,height:.75*c.getApplication().getViewport().getHeight(),width:.75*c.getApplication().getViewport().getWidth()});c.on("close",function(d){d=d.getCategoriesId();if(void 0!==d){var e=this.down("combo");e.getStore().add({name:d,
value:d});e.setValue(d);this.up("window").panel.setApiParam("categories",d)}},this);this.setBuilderWin(c)}c=this.down("combo").getValue();this.getBuilderWin().setCategoriesId(c);this.getBuilderWin().show()},scope:this}]});this.callParent(arguments)}});
Ext.define("Voyant.widget.CategoriesBuilder",{extend:"Ext.window.Window",requires:["Voyant.widget.FontFamilyOption"],mixins:["Voyant.util.Localization","Voyant.util.Api"],alias:"widget.categoriesbuilder",statics:{i18n:{title:"Categories Builder",terms:"Terms",term:"Term",rawFreq:"Count",relativeFreq:"Relative",categories:"Categories",addCategory:"Add Category",removeCategory:"Remove Category",removeTerms:"Remove Selected Terms",categoryName:"Category Name",add:"Add",cancel:"Cancel",exists:"Category already exists",
confirmRemove:"Are you sure you want to remove the category?",save:"Save",features:"Features",category:"Category",increaseCategory:"Increase Category Priority",decreaseCategory:"Decrease Category Priority",color:"Color",font:"Font",orientation:"Orientation"},api:{stopList:"auto",query:void 0},features:{color:{xtype:"colorfield",format:"#hex6"},font:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:Voyant.widget.FontFamilyOption.fonts}},
orientation:{xtype:"combobox",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:[{name:"Horizontal",value:0},{name:"Vertical",value:90}]}}}},config:{corpus:void 0,builderWin:void 0,addCategoryWin:void 0,categoriesId:void 0},closeAction:"hide",modal:!0,height:250,width:500,constructor:function(a){a=a||{};a.panel?(this.panel=a.panel,this.app=this.panel.getApplication(),this.categoriesManager=this.app.getCategoriesManager()):window.console&&console.warn("can't find panel!");
this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},initComponent:function(){Ext.apply(this,{header:!1,layout:"fit",onEsc:Ext.emptyFn,items:{xtype:"tabpanel",title:this.localize("title"),tabBarHeaderPosition:1,items:[{layout:"border",title:this.localize("categories"),items:[{title:this.localize("terms"),split:!0,width:250,region:"west",layout:"fit",items:{itemId:"terms",xtype:"grid",store:Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this}),
viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:"terms",copy:!0,enableDrop:!1,dragZone:{getDragText:function(){var a="";this.dragData.records.forEach(function(b){a+=b.get("term")+", "});a=a.substr(0,a.length-2);20<a.length&&(a=a.substr(0,20)+"...");return a}}}},selModel:{mode:"MULTI"},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),dataIndex:"rawFreq",width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),dataIndex:"relativeFreq",
renderer:function(a){return Ext.util.Format.number(1E6*a,"0,000")},width:"autoSize",hidden:!0,sortable:!0}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"}]}],listeners:{query:function(a,b){this.setApiParam("query",b);a=this.queryById("terms").getStore();a.removeAll();a.load()},scope:this}}},{title:this.localize("categories"),itemId:"categories",region:"center",xtype:"panel",layout:{type:"hbox",align:"stretch"},scrollable:"x",dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",items:[{text:this.localize("addCategory"),handler:function(){this.getAddCategoryWin().show()},scope:this},{text:this.localize("removeTerms"),handler:function(){this.queryById("categories").query("grid").forEach(function(a){var b=a.getSelection();b.forEach(function(c){this.categoriesManager.removeTerm(a.category,c.getTerm())},this);a.getStore().remove(b)},this)},scope:this}]}],items:[]}]},{layout:"fit",itemId:"features",title:this.localize("features"),xtype:"grid",
scrollable:"y",store:Ext.create("Ext.data.JsonStore",{fields:["category"]}),columns:[{text:this.localize("category"),dataIndex:"category",sortable:!1,hideable:!1,flex:1}]}]},buttons:[{text:this.localize("cancel"),handler:function(a){this.setCategoriesId(void 0);a.up("window").close()},scope:this},{text:this.localize("save"),handler:function(a){this.processFeatures();this.setColorTermsFromCategoryFeatures();this.app.saveCategoryData().then(function(b){this.setCategoriesId(b);a.up("window").close()}.bind(this),
function(){this.setCategoriesId(void 0);a.up("window").close()}.bind(this))},scope:this}],listeners:{show:function(){this.getCategoriesId()&&this.getCategoriesId()!=this.getApiParam("categories")?this.app.loadCategoryData(this.getCategoriesId()).then(function(a){this.setColorTermsFromCategoryFeatures();this.buildCategories();this.buildFeatures()}.bind(this)):(this.buildCategories(),this.buildFeatures());this.down("tabpanel").setActiveTab(0)},afterrender:function(a){a.on("loadedCorpus",function(b,
c){this.setCorpus(c);this.queryById("terms").getStore().load()},a);this.panel.on("loadedCorpus",function(b,c){a.fireEvent("loadedCorpus",b,c)},a);this.panel.getCorpus&&this.panel.getCorpus()?a.fireEvent("loadedCorpus",a,this.panel.getCorpus()):this.panel.getStore&&this.panel.getStore()&&this.panel.getStore().getCorpus&&this.panel.getStore().getCorpus()&&a.fireEvent("loadedCorpus",a,this.panel.getStore().getCorpus())},scope:this}});this.setAddCategoryWin(Ext.create("Ext.window.Window",{title:this.localize("addCategory"),
modal:!0,closeAction:"hide",layout:"fit",items:{xtype:"form",width:300,defaults:{labelAlign:"right"},items:[{xtype:"textfield",fieldLabel:this.localize("categoryName"),name:"categoryName",allowBlank:!1,validator:function(a){return void 0===this.categoriesManager.getCategoryTerms(a)?!0:this.localize("exists")}.bind(this),enableKeyEvents:!0,listeners:{keypress:function(a,b){b.getKey()===Ext.event.Event.ENTER&&a.up("form").queryById("addCategoryButton").click()},scope:this}}],buttons:[{text:this.localize("cancel"),
handler:function(a){a.up("window").close()}},{itemId:"addCategoryButton",text:this.localize("add"),handler:function(a){var b=a.up("form");b.isValid()&&(b=b.getValues().categoryName,this.addCategory(b),a.up("window").close())},scope:this}]},listeners:{show:function(a){a=a.down("form").getForm();a.reset();a.clearInvalid()}}}));this.callParent(arguments)},addCategory:function(a){this.categoriesManager.addCategory(a);this.queryById("features").getStore().add({category:a});var b=[],c=this.categoriesManager.getCategoryTerms(a);
if(void 0!==c)for(var d=0;d<c.length;d++)b.push({term:c[d]});var e=this.queryById("categories").add({xtype:"grid",category:a,title:a,frame:!0,width:150,margin:"10 0 10 10",layout:"fit",tools:[{type:"close",tooltip:this.localize("removeCategory"),callback:function(g){Ext.Msg.confirm(this.localize("removeCategory"),this.localize("confirmRemove"),function(h){"yes"===h&&this.removeCategory(a)},this)},scope:this}],bbar:[{xtype:"button",text:"",tooltip:this.localize("increaseCategory"),glyph:"xf067@FontAwesome",
handler:function(g){g=g.findParentByType("grid");var h=this.queryById("categories"),k=h.prevChild(g);null!==k&&(h.moveBefore(g,k),this.app.getCategoriesManager().setCategoryRanking(g.getTitle(),h.items.indexOf(g)))},scope:this},"->",{xtype:"button",text:"",tooltip:this.localize("decreaseCategory"),glyph:"xf068@FontAwesome",handler:function(g){g=g.findParentByType("grid");var h=this.queryById("categories"),k=h.nextChild(g);null!==k&&(h.moveAfter(g,k),this.app.getCategoriesManager().setCategoryRanking(g.getTitle(),
h.items.indexOf(g)))},scope:this}],store:Ext.create("Ext.data.JsonStore",{data:b,fields:["term"]}),viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:"terms",dragZone:{getDragText:function(){var g="";this.dragData.records.forEach(function(h){g+=h.get("term")+", "});return g.substr(0,g.length-2)}}}},selModel:{mode:"MULTI"},columns:[{dataIndex:"term",flex:1,sortable:!0}],listeners:{beforedrop:function(g,h){g=this.up("categoriesbuilder").categoriesManager;var k=h.view.up("grid");if(void 0!==k.category)for(var l=
h.records.length-1;0<=l;l--){var m=h.records[l].get("term");g.removeTerm(k.category,m)}},drop:function(g,h){h.view.getSelectionModel().deselectAll();this.getSelectionModel().deselectAll();g=this.up("categoriesbuilder").categoriesManager;for(var k=[],l=0;l<h.records.length;l++){var m=h.records[l].get("term");k.push(m)}g.addTerms(a,k)}}}),f=new Ext.Editor({updateEl:!0,alignment:"l-l",autoSize:{width:"boundEl"},field:{xtype:"textfield",allowBlank:!1,validator:function(g){return void 0===this.categoriesManager.getCategoryTerms(g)||
g===e.getTitle()?!0:this.localize("exists")}.bind(this)},listeners:{complete:function(g,h,k){this.categoriesManager.renameCategory(k,h);this.buildFeatures()},scope:this}});e.header.getTitle().textEl.on("dblclick",function(g,h){f.startEdit(h)})},removeCategory:function(a){var b=this.queryById("categories"),c=b.queryBy(function(d){return d.category&&d.category==a?!0:!1});b.remove(c[0]);b=this.queryById("features").getStore();b.removeAt(b.findExact("category",a));this.categoriesManager.removeCategory(a)},
addFeature:function(a){this.categoriesManager.addFeature(a);this.buildFeatures()},buildFeatures:function(){this.queryById("features").getStore().removeAll();var a=["category"],b=[{sortable:!1,text:this.localize("category"),dataIndex:"category",flex:1}],c=[],d;for(d in this.categoriesManager.getCategories())c.push({category:d});var e=this.categoriesManager.getFeatures(),f=Ext.ClassManager.getClass(this).features,g;for(g in e){a.push(g);e=f[g];var h=Ext.applyIf({feature:g,listeners:{change:function(k,
l){if(k.rendered){var m=k.up("gridview").indexOf(k.el.up("table")),n=k.up("grid").getStore().getAt(m);n?n.set(k.feature,l):window.console&&console.warn("no record for",m,k)}},scope:this}},e);e.listeners&&Ext.applyIf(h.listeners,e.listeners);b.push({sortable:!1,hideable:!1,text:this.localize(g),dataIndex:g,flex:.5,xtype:"widgetcolumn",widget:h});for(d in this.categoriesManager.getCategories())for(e=this.categoriesManager.getCategoryFeature(d,g),h=0;h<c.length;h++)if(c[h].category==d){c[h][g]=e;break}}a=
Ext.create("Ext.data.JsonStore",{fields:a,data:c});this.queryById("features").reconfigure(a,b)},processFeatures:function(){var a=this.queryById("features").getStore(),b=Object.keys(this.categoriesManager.getFeatures());a.each(function(c){var d=c.get("category");b.forEach(function(e){var f=c.get(e);void 0!==f&&this.categoriesManager.setCategoryFeature(d,e,f)},this)},this)},setColorTermsFromCategoryFeatures:function(){for(var a in this.categoriesManager.getCategories()){var b=this.categoriesManager.getCategoryFeature(a,
"color");if(void 0!==b){b=this.app.hexToRgb(b);for(var c=this.categoriesManager.getCategoryTerms(a),d=0;d<c.length;d++)this.app.setColorForTerm(c[d],b)}}},buildCategories:function(){this.queryById("categories").removeAll();var a=this.categoriesManager.getCategories(),b;for(b in a)this.addCategory(b)}});Ext.define("Voyant.widget.VoyantNetworkGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.notebook.util.Embed"],embeddable:["Voyant.widget.VoyantNetworkGraph"],alias:"widget.voyantnetworkgraph",statics:{i18n:{},api:{jsonData:void 0,docId:void 0,docIndex:void 0,json:void 0,api:void 0}},config:{vis:void 0,visLayout:void 0,nodeData:void 0,edgeData:void 0,nodeSelection:void 0,edgeSelection:void 0,currentNode:void 0,currentEdge:void 0,zoom:void 0,zoomExtent:[.25,
8],fixOnDrag:!0,nodeScaling:{minSize:8,maxSize:36,scalingFunction:void 0},edgeScaling:{minSize:1,maxSize:10,scalingFunction:void 0},graphStyle:{node:{normal:{fill:"#c6dbef",fillOpacity:1,stroke:"#6baed6",strokeOpacity:1,strokeWidth:1},highlight:{fill:"#9ecae1",fillOpacity:1,stroke:"#3182bd",strokeOpacity:1,strokeWidth:3}},edge:{normal:{stroke:"#000000",strokeOpacity:.25,strokeWidth:1},highlight:{stroke:"#000000",strokeOpacity:.5,strokeWidth:3}}},graphPhysics:{damping:.4,centralGravity:.1,nodeGravity:-50,
springLength:100,springStrength:.25,collisionScale:1.25}},constructor:function(a){a=a||{};this.setNodeData([]);this.setEdgeData([]);this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);var b={};this.getApiParam("jsonData")?b=Ext.decode(this.getApiParam("jsonData")):this.getApiParam("json")?b=this.getApiParam("json"):a.json?b=a.json:a.edges?(b.edges=a.edges,a.nodes&&(b.nodes=a.nodes)):a&&a.jsonData&&(b=JSON.parse(a.jsonData));this.loadJson(b)},initComponent:function(a){this.on("boxready",
function(b,c){this.initGraph();this.refreshGraph()},this);this.on("resize",function(b,c,d){if(b=this.body.down("svg"))d=this.body,c=d.getHeight(),d=d.getWidth(),b.dom.setAttribute("width",d),b.dom.setAttribute("height",c),this.getVisLayout().force("x",d3.forceX(d/2)).force("y",d3.forceY(c/2)),.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)},this);this.callParent(arguments)},processJson:function(a){a&&a.edges||(a&&a.links&&(a.edges=a.links,delete a.links),a&&a.edges||(a=a||{},a.edges=
[]));a.nodes||(a.nodes=[]);if(0===a.nodes.length){var b={};a.edges.forEach(function(c){["source","target"].forEach(function(d){d=c[d];0==d in b?(b[d]=1,a.nodes.push({term:d})):b[d]++;c.value=1})},this);a.nodes.forEach(function(c){Ext.applyIf(c,{value:void 0===b[c.term]?1:b[c.term]})})}else a.nodes.forEach(function(c){Ext.applyIf(c,{value:1})});return a},loadJson:function(a){this.processJson(a);var b={};this.getNodeData().forEach(function(e){b[e.term]=!0},this);var c=[],d=[];a.nodes.forEach(function(e){void 0===
b[e.term]&&(e.id=this.idGet(e.term),c.push(e))},this);a.edges.forEach(function(e){for(var f=this.idGet(e.source),g=this.idGet(e.target),h=this.getEdgeData(),k=!1,l=0;l<h.length;l++){var m=h[l];if(m.source.id==f&&m.target.id==g||m.target.id==f&&m.source.id==g){k=!0;break}}k||(e.source=f,e.target=g,e.id=f+"-"+g,d.push(e))},this);this.setNodeData(this.getNodeData().concat(c));this.setEdgeData(this.getEdgeData().concat(d));this.refreshGraph()},idGet:function(a){return a.replace(/\W/g,"_")},updateDataForNode:function(a,
b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===a){Ext.apply(c[d],b);break}},updateDataForEdge:function(a,b){for(var c=this.getEdgeData(),d=0;d<c.length;d++)if(c[d].id===a){Ext.apply(c[d],b);break}},addNode:function(a){Ext.isString(a)&&(a={term:a});a.term&&this.loadJson({nodes:[a]})},removeNode:function(a,b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===a){c.splice(d,1);break}var e={};c=this.getEdgeData();for(d=c.length-1;0<=d;d--){var f=!1;c[d].source.id===a&&(f=!0,
e[c[d].target.id]=!0);c[d].target.id===a&&(f=!0,e[c[d].source.id]=!0);f&&c.splice(d,1)}if(b){for(d=0;d<c.length;d++)e[c[d].source.id]&&delete e[c[d].source.id],e[c[d].target.id]&&delete e[c[d].target.id];for(var g in e)this.removeNode(g,!0)}this.refreshGraph()},addEdge:function(a){Ext.isObject(a)&&a.source&&a.target&&this.loadJson({edges:[a]})},removeEdge:function(a,b){for(var c=this.getEdgeData(),d=c.length-1;0<=d;d--)c[d].id===a&&c.splice(d,1);if(b){a={};c=this.getNodeData();for(d=0;d<c.length;d++)a[c[d].id]=
!0;c=this.getEdgeData();for(d=0;d<c.length;d++)a[c[d].source.id]&&delete a[c[d].source.id],a[c[d].target.id]&&delete a[c[d].target.id];for(var e in a)this.removeNode(e,!0)}this.refreshGraph()},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");var b=a.getWidth(),c=a.getHeight(),d=this.getGraphPhysics();this.setVisLayout(d3.forceSimulation().velocityDecay(d.damping).force("x",d3.forceX(b/2).strength(d.centralGravity)).force("y",d3.forceY(c/2).strength(d.centralGravity)).force("link",
d3.forceLink().id(function(f){return f.id}).distance(d.springLength).strength(d.springStrength)).force("charge",d3.forceManyBody().strength(d.nodeGravity)).force("collide",d3.forceCollide().radius(function(f){return Math.sqrt(f.bbox.width*f.bbox.height)*d.collisionScale})).on("tick",function(){this.getEdgeSelection().attr("x1",function(f){return f.source.x}).attr("y1",function(f){return f.source.y}).attr("x2",function(f){return f.target.x}).attr("y2",function(f){return f.target.y});this.getNodeSelection().attr("transform",
function(f){return"translate("+(f.x-.5*f.bbox.width)+","+(f.y-.5*f.bbox.height)+")"});.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){this.zoomToFit()}.bind(this)));a=d3.select(a.dom).append("svg").attr("width",b).attr("height",c);var e=a.append("g");b=d3.zoom().scaleExtent(this.getZoomExtent()).on("zoom",function(){e.attr("transform",d3.event.transform)});this.setZoom(b);a.call(b);this.setEdgeSelection(e.append("g").attr("class","edges").selectAll(".edge"));
this.setNodeSelection(e.append("g").attr("class","nodes").selectAll(".node"));this.setVis(e)},resetGraph:function(){this.setNodeData([]);this.setEdgeData([]);this.refreshGraph()},refreshGraph:function(){if(void 0!==this.getVisLayout()){var a=this.getEdgeData(),b=this.getNodeData(),c=d3.extent(b,function(g){return g.value});d3.sum(b,function(g){return g.value});var d=d3.extent(a,function(g){return g.value});d3.sum(a,function(g){return g.value});var e=this.getEdgeScaling();void 0===e.scalingFunction&&
(e.scalingFunction=d3.scaleLinear().domain(d).range([e.minSize,e.maxSize]));var f=this.getNodeScaling();void 0===f.scalingFunction&&(f.scalingFunction=d3.scaleLog().domain(c).range([f.minSize,f.maxSize]));c=this.getEdgeSelection().data(a,function(g){return g.id});c.exit().remove();d=c.enter().append("line").attr("class","edge").attr("id",function(g){return g.id}).style("cursor","pointer").style("stroke-width",function(g){return e.scalingFunction(g.value)}).on("mouseover",this.edgeMouseOver.bind(this)).on("mouseout",
this.edgeMouseOut.bind(this)).on("click",function(g){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentEdge(g);this.fireEvent("edgeclicked",this,g)}.bind(this));this.setEdgeSelection(d.merge(c));c=this.getNodeSelection().data(b,function(g){return g.id});c.exit().remove();d=c.enter().append("g").attr("class","node").attr("id",function(g){return g.id}).style("cursor","pointer").on("mouseover",this.nodeMouseOver.bind(this)).on("mouseout",this.nodeMouseOut.bind(this)).on("click",
function(g){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.setCurrentNode(g);this.fireEvent("nodeclicked",this,g)}.bind(this)).on("dblclick",function(g){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodedblclicked",this,g)}.bind(this)).on("contextmenu",function(g){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fireEvent("nodecontextclicked",this,g)}.bind(this)).call(d3.drag().on("start",function(g){d3.event.active||this.getVisLayout().alphaTarget(.3).restart();
this.getFixOnDrag()&&(g.fx=g.x,g.fy=g.y);this.fireEvent("nodedragstart",this,g)}.bind(this)).on("drag",function(g){this.getFixOnDrag()?(g.fx=d3.event.x,g.fy=d3.event.y):(g.x=d3.event.x,g.y=d3.event.y);this.fireEvent("nodedrag",this,g)}.bind(this)).on("end",function(g){d3.event.active||this.getVisLayout().alphaTarget(0);this.fireEvent("nodedragend",this,g)}.bind(this)));d.append("rect");d.append("text").text(function(g){return g.term}).attr("font-size",function(g){return f.scalingFunction(g.value)+
"px"}).attr("dominant-baseline","middle").style("user-select","none").each(function(g){g.bbox=this.getBBox()});this.setNodeSelection(d.merge(c));this.getNodeSelection().selectAll("rect").attr("width",function(g){return g.bbox.width+16}).attr("height",function(g){return g.bbox.height+8}).attr("rx",function(g){return Math.max(2,.2*g.bbox.height)}).attr("ry",function(g){return Math.max(2,.2*g.bbox.height)});this.getNodeSelection().selectAll("text").attr("dx",8).attr("dy",function(g){return.5*g.bbox.height+
4});this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getVisLayout().nodes(b);this.getVisLayout().force("link").links(a);this.getVisLayout().alpha(1).restart()}},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;var h=c.getBoundingClientRect(),k=h.width;h=h.height;a=(a||.8)/Math.max(d/k,e/h);f=[k/2-a*f,h/2-a*g];d3.select(c).transition().duration(b||
500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},nodeScaling:function(a,b,c,d){return a===b?.5:Math.max(0,1/(b-a)*(d-a))},applyNodeStyle:function(a,b){b=void 0===b?"normal":b;var c=this.getGraphStyle().node[b];a.selectAll(":not(text)").style("fill",function(d){return c.fill}.bind(this)).style("fill-opacity",function(d){return c.fillOpacity}.bind(this)).style("stroke",function(d){return c.stroke}.bind(this)).style("stroke-opacity",function(d){return c.strokeOpacity}.bind(this)).style("stroke-width",
function(d){return c.strokeWidth}.bind(this))},applyEdgeStyle:function(a,b){b=void 0===b?"normal":b;var c=this.getGraphStyle().edge[b];a.style("stroke",function(d){return c.stroke}.bind(this)).style("stroke-opacity",function(d){return c.strokeOpacity}.bind(this))},edgeMouseOver:function(a){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this));this.getVis().select("#"+a.id).call(this.applyEdgeStyle.bind(this),"highlight")},edgeMouseOut:function(a){this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))},
nodeMouseOver:function(a){this.setCurrentNode(a);this.getNodeSelection().call(this.applyNodeStyle.bind(this));this.getEdgeSelection().each(function(b){if(b.source.id==a.id)var c=b.target.id;else b.target.id==a.id&&(c=b.source.id);void 0!==c&&(this.getVis().select("#"+c).call(this.applyNodeStyle.bind(this),"highlight"),this.getVis().select("#"+b.id).call(this.applyEdgeStyle.bind(this),"highlight"))}.bind(this));this.getVis().select("#"+a.id).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(a){this.getNodeSelection().call(this.applyNodeStyle.bind(this));
this.getEdgeSelection().call(this.applyEdgeStyle.bind(this))}});Ext.define("Voyant.widget.ReaderGraph",{extend:"Ext.container.Container",mixins:["Voyant.util.Localization"],alias:"widget.readergraph",statics:{i18n:{}},config:{parentPanel:void 0,corpus:void 0,documentsStore:void 0,documentTermsStore:void 0,locationMarker:void 0,isDetailedGraph:!0},locationMarkerColor:"#157fcc",DETAILED_GRAPH_DOC_LIMIT:25,LOCATION_UPDATE_FREQ:100,SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,constructor:function(a){this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"hbox"},
items:[]});this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:!0,withPositions:!0,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},simpleSortMode:!0},listeners:{load:function(b,c,d,e){b.sort("docIndex","ASC");var f={},g=0;b.each(function(h){var k=
[],l=h.get("distributions"),m=h.get("docId"),n=h.get("docIndex");h=h.get("term");for(var r=0;r<l.length;r++){var u=r,q=l[r];q>g&&(g=q);k.push([m,n,u,q,h])}f[n]=k},this);if(this.getIsDetailedGraph())for(b=this.query("cartesian"),c=0;c<b.length;c++)d=b[c],e=f[c],void 0!==e?(d.getAxes()[0].setMaximum(g),d.getStore().loadData(e)):d.getStore().removeAll()},scope:this}}));this.callParent(arguments);var a=this.findParentBy(function(b){return b.mixins["Voyant.panel.Panel"]});if(null!=a)if(this.setParentPanel(a),
a.getCorpus&&a.getCorpus())this.on("afterrender",function(b){this.setCorpus(a.getCorpus())},this);else a.on("loadedCorpus",function(b,c){this.setCorpus(c)},this),this.hasCorpusLoadedListener=!0;this.on("boxready",function(){void 0==this.getLocationMarker()&&this.setLocationMarker(Ext.DomHelper.append(this.getEl(),{tag:"div",style:"background-color: "+this.locationMarkerColor+"; height: 100%; width: 2px; position: absolute; top: 0; left: 0;"}))})},updateCorpus:function(a){var b=a.getDocuments();this.setDocumentsStore(b);
this.getDocumentTermsStore().getProxy().setExtraParam("corpus",a.getId());this.setIsDetailedGraph(b.getTotalCount()<this.DETAILED_GRAPH_DOC_LIMIT);this.generateChart(a,this)},loadQueryTerms:function(a){a&&0<a.length&&this.getDocumentTermsStore().load({params:{query:a}})},generateChart:function(a,b){function c(r,u){r=this.getParentPanel().getApplication().getColor(r);return"rgba("+r[0]+","+r[1]+","+r[2]+","+u+")"}function d(r){var u=r.index,q=r.fraction;r=r.relativeHeight;var p=c.call(this,u,.3);u=
c.call(this,u,1);b.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},flex:q,height:"100%",insetPadding:0,background:{type:"linear",degrees:90,stops:[{offset:0,color:p},{offset:r,color:p},{offset:r,color:"white"},{offset:1,color:"white"}]},axes:[{type:"numeric",position:"left",fields:"distribution",hidden:!0},{type:"category",position:"bottom",fields:"bin",hidden:!0}],series:[{type:"line",xField:"bin",yField:"distribution",style:{lineWidth:2,strokeStyle:u},tooltip:{corpus:a,trackMouse:!0,style:"background: #fff",
showDelay:0,dismissDelay:500,hideDelay:5,renderer:function(v,w,B){v.setHtml(a.getDocument(w.get("docIndex")).getTitle()+"<br>"+w.get("term")+": "+w.get("distribution"))}}}],store:Ext.create("Ext.data.ArrayStore",{fields:["docId","docIndex","bin","distribution","term"],data:[]}),listeners:{itemclick:function(v,w,B){},scope:this}}).body.on("click",function(v,w){w=Ext.get(w);v=v.getX();var B=w.getBox();v=(v-B.x)/B.width;w=w.parent(".x-panel");B=w.parent();w=Ext.toArray(B.dom.children).indexOf(w.dom);
this.fireEvent("documentRelativePositionSelected",this,{docIndex:w,fraction:v})},this)}b.removeAll();for(var e=a.getDocuments(),f=a.getWordTokensCount(),g=[],h=Number.MAX_VALUE,k=-1,l=0;l<e.getCount();l++){var m=e.getAt(l),n=m.get("index");m=m.get("tokensCount-lexical");m<h&&(h=m);m>k&&(k=m);g.push({index:n,count:m,fraction:m/f})}if(this.getIsDetailedGraph())for(l=0;l<g.length;l++)m=g[l],m.relativeHeight=m.count==k?1:.25+(m.count-h)/(k-h)*.75,d.call(this,m);else b.add({xtype:"cartesian",plugins:{ptype:"chartitemevents"},
flex:1,height:"100%",insetPadding:0,axes:[{type:"numeric",position:"left",fields:"count",hidden:!0},{type:"category",position:"bottom",fields:"index",hidden:!0}],series:[{type:"bar",xField:"index",yField:"count",style:{minGapWidth:0,minBarWidth:1,lineWidth:0,strokeStyle:"none"},renderer:function(r,u,q,p){return{fillStyle:c.call(this,p,.3)}}.bind(this)}],store:Ext.create("Ext.data.JsonStore",{fields:[{name:"index",type:"int"},{name:"count",type:"int"},{name:"fraction",type:"float"}],data:g}),listeners:{itemclick:function(r,
u,q){r=Ext.get(q.getTarget());q=q.getX();r=r.getBox();var p=r.width/this.getCorpus().getDocuments().getCount();q=(q-r.x)%p/p;u=u.record.data;u=this.getDocumentsStore().getAt(u.index).getIndex();this.fireEvent("documentRelativePositionSelected",this,{docIndex:u,fraction:q})},scope:this}})},moveLocationMarker:function(a,b,c){var d=Ext.get(this.getLocationMarker()),e=d.getX();if(this.getIsDetailedGraph()){var f=this.query("cartesian")[a];f&&(e=f.getX()+f.getWidth()*b)}else f=this.down("cartesian"),e=
f.getWidth()/this.getCorpus().getDocuments().getCount(),e=f.getX()+e*a+e*b;null!=c&&(a=d.getX(),c==this.SCROLL_DOWN&&a>e||c==this.SCROLL_UP&&a<e)&&(e=a);d.setX(e)}});Ext.define("Voyant.panel.Panel",{mixins:["Voyant.util.Localization","Voyant.util.Api","Voyant.util.Toolable","Voyant.util.DetailedError"],requires:["Voyant.widget.QuerySearchField","Voyant.widget.StopListOption","Voyant.widget.CategoriesOption","Voyant.widget.TotalPropertyStatus"],alias:"widget.voyantpanel",statics:{i18n:{},config:{corpusValidated:!1},api:{corpus:void 0,input:void 0,inputFormat:void 0,subtitle:void 0}},config:{corpus:void 0},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);this.mixins["Voyant.util.Toolable"].constructor.apply(this,arguments);this.glyph||(this.glyph=Ext.ClassManager.getClass(this).glyph);this.on("afterrender",function(){"facet"!=this.getXType()&&this.getApiParam("subtitle")&&this.getTitle()&&this.setTitle(this.getTitle()+" <i style='font-size: smaller;'>"+this.getApiParam("subtitle")+"</i>");this.isXType("grid")&&(this.getSelectionModel().on("selectionchange",function(b,c){},this),this.getStore().on("beforeload",function(){this.selectedRecordsToRemember=
this.getSelection()},this),this.getStore().on("load",function(b,c){if(0<Ext.Array.from(this.selectedRecordsToRemember).length){var d={};c=Ext.Array.merge(this.selectedRecordsToRemember,c).filter(function(e){return e.getId()in d?!1:d[e.getId()]=!0});b.isBufferedStore?1==b.currentPage&&(b.data.addAll(c),b.totalCount=c.length,b.fireEvent("refresh",b)):(b.loadRecords(c),this.getSelectionModel().select(this.selectedRecordsToRemember),b.fireEvent("refresh",b),this.selectedRecordsToRemember=[])}},this))},
this);this.on({loadedCorpus:{fn:function(b,c){this.setApiParam("corpus",c.getAliasOrId());this.setCorpus(c)},priority:999,scope:this}})},getApplication:function(){return Voyant.application},getBaseUrl:function(){return this.getApplication().getBaseUrl()},openUrl:function(a){this.getApplication().openUrl.apply(this,arguments)},getTromboneUrl:function(){return this.getApplication().getTromboneUrl()},dispatchEvent:function(){var a=this.getApplication();a.dispatchEvent.apply(a,arguments)},showError:function(a,
b){Ext.isString(a)&&(a={message:a});Ext.applyIf(a,{title:this.localize("error")+" ("+this.localize("title")+")"});this.getApplication().showError(a,b)},showResponseError:function(a,b){this.getApplication().showResponseError(a,b)},toastError:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf071@FontAwesome",title:this.localize("error")});this.toast(a)},toastInfo:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{glyph:"xf05a@FontAwesome",title:this.localize("info")});this.toast(a)},
toast:function(a){Ext.isString(a)&&(a={html:a});Ext.applyIf(a,{slideInDuration:500,shadow:!0,align:"b",anchor:this.getTargetEl()});Ext.toast(a)},hasCorpusAccess:function(a){var b=this.getApplication();if(b){var c=b.getCorpusAccess();if("ADMIN"==c||"ACCESS"==c)return!0}a||(this.getCorpus&&(a=this.getCorpus()),!a&&b.getCorpus&&(a=b.getCorpus()));return a?"NONCONSUMPTIVE"!=a.getNoPasswordAccess()&&"NONE"!=a.getNoPasswordAccess():!1}});Ext.define("Voyant.panel.VoyantTabPanel",{extend:"Ext.tab.Panel",alias:"widget.voyanttabpanel",mixins:["Voyant.panel.Panel"],statics:{i18n:{}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.callParent(arguments)},listeners:{tabchange:function(a,b){this.tools=[];this.getHeader().tools=[];this.query("toolmenu").forEach(function(c){c.destroy()});this.addTool(b.tools);this.getApplication().dispatchEvent("panelChange",
this)},afterrender:function(a){this.fireEvent("tabchange",this,this.getActiveTab())}},showOptionsClick:function(a){var b=a.getActiveTab();b.showOptionsClick&&b.showOptionsClick.apply(b,arguments)}});Ext.define("Voyant.widget.Facet",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.facet",statics:{i18n:{},api:{stopList:"auto",query:void 0}},constructor:function(a){this.callParent(arguments);Ext.applyIf(a||{},{includeTools:[],rowLines:!1,columnLines:!1,subtitle:void 0});this.mixins["Voyant.panel.Panel"].constructor.apply(this,[a])},rowLines:!1,initComponent:function(){var a=this;this.store||(this.store=new Ext.create("Voyant.data.store.CorpusFacets",{proxy:{extraParams:{facet:this.facet}},
parentPanel:this}),this.store.getProxy().on("exception",function(b,c,d,e){a.showResponseError("Unable to fetch facet: "+a.facet,response)}));Ext.applyIf(this,{emptyText:this.localize("emptyText"),hideHeaders:!0,selType:"checkboxmodel",columns:[{renderer:function(b,c,d){return"("+d.getInDocumentsCount()+") "+d.getLabel()},flex:1}]});this.callParent();this.corpus&&this.setStoreCorpus(this.corpus);this.on("loadedCorpus",function(b,c){this.setStoreCorpus(c)},this);this.on("query",function(b,c){this.setApiParam("query",
c);this.store.load({params:this.getApiParams()})})},setStoreCorpus:function(a){this.getStore()&&(this.getStore().setCorpus(a),this.getStore().load())}});Ext.define("Voyant.panel.Bubbles",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubbles",statics:{i18n:{},api:{stopList:"auto",docIndex:0,limit:100,audio:!1,speed:30},glyph:"xf06e@FontAwesome"},config:{options:{xtype:"stoplistoption"},audio:!1},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'<canvas style="width: 100%; height: 100%"></canvas>',dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.bubbles&&this.bubbles.frameRate(a.getValue());this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},
changecomplete:function(a,b){this.setApiParam("speed",b);this.bubbles&&this.bubbles.frameRate(b)},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.setApiParam("audio",
b);this.setAudio(b)},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.getTargetEl().dom.querySelector("canvas");var c=this;Ext.Ajax.request({url:this.getBaseUrl()+"resources/voyant/current/bubbles/bubbles.pjs"}).then(function(d){var e=c.getTargetEl().dom.querySelector("canvas");c.bubbles=new Processing(e,d.responseText);c.bubbles.size(c.getTargetEl().getWidth(),
c.getTargetEl().getHeight());c.bubbles.frameRate(c.getApiParam("speed"));c.bubbles.bindJavascript(c);c.bubbles.noLoop();c.loadDocument()})},this);this.on("resize",function(){this.bubbles&&this.bubbles.size(this.body.getWidth(),this.body.getHeight())});this.on("documentselected",function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocument()})},setAudio:function(a){this.gainNode&&(this.gainNode.gain.value=a?1:0);this.callParent(arguments)},handleCurrentTerm:function(a){this.oscillator&&
(this.oscillator.frequency.value=this.terms[a]?parseInt(2E3*(this.terms[a]-this.minFreq)/(this.maxFreq-this.minFreq)):0)},handleDocFinished:function(){this.gainNode&&(this.gainNode.gain.value=0);var a=parseInt(this.getApiParam("docIndex"));a+1<this.getCorpus().getDocumentsCount()&&(this.setApiParam("docIndex",a+1),this.loadDocument())},loadDocument:function(){var a=this,b=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));this.up("tabpanel")||this.setTitle(this.localize("title")+
" <span class='subtitle'>"+b.getFullLabel()+"</span>");b.loadDocumentTerms(Ext.apply(this.getApiParams(["stopList"]),{limit:100})).then(function(c){a.terms={};c.each(function(d){a.terms[d.getTerm()]=d.getRawFreq()});c=Object.keys(a.terms).map(function(d){return a.terms[d]});a.minFreq=Ext.Array.min(c);a.maxFreq=Ext.Array.max(c);a.getCorpus().loadTokens({whitelist:Object.keys(a.terms),noOthers:!0,limit:0,docIndex:a.getApiParam("docIndex")}).then(function(d){var e=[];d.each(function(f){e.push(f.getTerm().toLowerCase())});
a.bubbles.setLines([b.getTitle(),e.join(" ")]);a.bubbles.loop();a.oscillator.frequency.value=150;a.gainNode.gain.value=a.getAudio()?1:0})})},initComponent:function(){Ext.Loader.loadScript(this.getBaseUrl()+"resources/processingjs/processing.min.js");var a=new (window.AudioContext||window.webkitAudioContext);this.oscillator=a.createOscillator();this.gainNode=a.createGain();this.oscillator.connect(this.gainNode);this.gainNode.connect(a.destination);this.oscillator.frequency.value=0;this.oscillator.start();
this.gainNode.gain.value=0;this.callParent(arguments)}});Ext.define("Voyant.panel.Bubblelines",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.bubblelines",statics:{i18n:{},api:{bins:50,query:null,stopList:"auto",docId:void 0,docIndex:void 0,maxDocs:50},glyph:"xf06e@FontAwesome"},config:{bubblelines:void 0,termStore:void 0,docTermStore:void 0,selectedDocs:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}]},termTpl:new Ext.XTemplate('<tpl for=".">','<div class="term" style="color: rgb({color});float: left;padding: 3px;margin: 2px;">{term}</div>',
"</tpl>"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.setDocTermStore(b.getDocumentTerms({proxy:{extraParams:{withDistributions:"raw",withPositions:!0}},listeners:{load:function(c,d,e,f){d.forEach(function(g){var h=this.processTerms(g),k=g.get("docId");g=g.get("term");var l={};l[g]=h;this.getBubblelines().addTermsToDoc(l,k)},this);this.getBubblelines().doBubblelinesLayout()},scope:this}}));
this.isVisible()&&this.getBubblelines()&&this.initLoad()},this);this.on("activate",function(){this.getCorpus()&&Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.getDocTermsFromQuery(b)},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",b);this.getBubblelines().cache.each(function(c){c.hidden=-1===b.indexOf(c.id)});this.getBubblelines().drawGraph()},this);this.on("termsClicked",function(a,b){if(a!==this){var c=[];b.forEach(function(d){Ext.isString(d)?
c.push(d):d.term?c.push(d.term):d.getTerm&&c.push(d.getTerm())});this.getDocTermsFromQuery(c)}},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(d){d.getTerm()&&c.push(d.getTerm())});this.getDocTermsFromQuery(c)},this);this.down("#granularity").setValue(parseInt(this.getApiParam("bins")))},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"],listeners:{load:function(a,b,c,d){a=this.down("#termsView");for(c=0;c<b.length;c++)a.select(b[c],
!0)},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.getTermStore().removeAll();this.setApiParams({query:null});this.getBubblelines().removeAllTerms();this.getBubblelines().drawGraph()},scope:this},{xtype:"documentselectorbutton"},{xtype:"slider",
itemId:"granularity",fieldLabel:this.localize("granularity"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,maxValue:300,listeners:{changecomplete:function(a,b){this.setApiParams({bins:b});this.getBubblelines().bubbleSpacing=b;this.reloadTermsData()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("separateLines"),boxLabelAlign:"before",checked:!1,handler:function(a,b){this.getBubblelines().SEPARATE_LINES_FOR_TERMS=b;this.getBubblelines().lastClickedBubbles={};this.getBubblelines().setCanvasHeight();
this.getBubblelines().drawGraph()},scope:this}]}],border:!1,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,b,c,d,e,f){e.preventDefault();e.stopPropagation();a.fireEvent("itemcontextmenu",a,b,c,d,e,f);return!1},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return!1},selectionchange:function(a,b){var c=this.down("#termsView"),d=[];c.getStore().each(function(g){-1!==b.indexOf(g)?(d.push(g.get("term")),Ext.fly(c.getNodeByRecord(g)).removeCls("unselected").addCls("selected")):Ext.fly(c.getNodeByRecord(g)).removeCls("selected").addCls("unselected")});for(var e in this.getBubblelines().lastClickedBubbles){a=this.getBubblelines().lastClickedBubbles[e];for(var f in a)-1==d.indexOf(f)&&delete this.getBubblelines().lastClickedBubbles[e][f]}this.getBubblelines().termsFilter=
d;this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},itemcontextmenu:function(a,b,c,d,e){e.preventDefault();e.stopPropagation();var f=a.isSelected(c);(new Ext.menu.Menu({floating:!0,items:[{text:f?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){f?a.deselect(d):a.select(d,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(d);var g=this.getTermStore().getAt(d).get("term");this.getTermStore().removeAt(d);a.refresh();this.getBubblelines().removeTerm(g);
this.getBubblelines().setCanvasHeight();this.getBubblelines().drawGraph()},scope:this}]})).showAt(e.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],listeners:{render:function(a){a=this.down("#canvasParent");this.setBubblelines(new Bubblelines({container:a,clickHandler:this.bubbleClickHandler.bind(this)}));this.getBubblelines().bubbleSpacing=parseInt(this.getApiParam("bins"))},afterlayout:function(a){!1===this.getBubblelines().initialized&&
this.getBubblelines().initializeCanvas()},resize:function(a,b,c){this.getBubblelines().doBubblelinesLayout()},scope:this}}});this.callParent(arguments)},initLoad:function(){var a=[];this.getCorpus().getDocuments().each(function(b,c,d){c=c<this.getApiParam("maxDocs");this.getBubblelines().addDocToCache({id:b.getId(),index:b.getIndex(),title:b.getShortTitle(),totalTokens:b.get("tokensCount-lexical"),terms:{},hidden:!c});c&&a.push(b.getId())},this);this.setApiParam("docId",a);this.getCorpus().getCorpusTerms({autoload:!1}).load({callback:function(b,
c,d){var e=[];b.forEach(function(f,g){e.push(f.get("term"))},this);this.getDocTermsFromQuery(e)},scope:this,params:{limit:this.getApiParam("query")?void 0:5,stopList:this.getApiParams("stopList"),query:this.getApiParam("query")}})},getDocTermsFromQuery:function(a){a&&this.setApiParam("query",a);this.getCorpus()&&this.isVisible()&&this.getDocTermStore().load({params:this.getApiParams()})},reloadTermsData:function(){var a=[],b;for(b in this.getBubblelines().currentTerms)a.push(b);this.getDocTermsFromQuery(a)},
filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(d,e){a.push(d.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.setSelectedDocs(this.getCorpus().getDocuments().clone());var b=this.getSelectedDocs().getCount();if(10<b)for(var c=10;c<b;c++)this.getSelectedDocs().removeAt(10);a=[];this.getSelectedDocs().eachKey(function(d,e){a.push(d)},this);this.setApiParams({docId:a})}else this.setSelectedDocs(this.getCorpus().getDocuments().filterBy(function(d,
e){return-1!=a.indexOf(e)},this))},processTerms:function(a){var b=a.get("term");var c=a.get("rawFreq");var d=a.get("positions");if(0<c){var e=this.getApplication().getColorForTerm(b);-1===this.getTermStore().find("term",b)&&(this.getTermStore().loadData([[b,e]],!0),b=this.getTermStore().find("term",b),this.down("#termsView").select(b,!0));a=a.get("distributions");c={positions:d,distributions:a,rawFreq:c,color:e}}else c=!1;return c},bubbleClickHandler:function(a){this.getApplication().dispatchEvent("termsClicked",
this,a)}});Ext.define("Voyant.panel.Catalogue",{extend:"Ext.panel.Panel",requires:["Voyant.widget.Facet"],mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.catalogue",statics:{i18n:{},api:{config:void 0,stopList:"auto",facet:["facet.title","facet.author","facet.language"],title:void 0,splash:void 0,reader:"reader"},glyph:"xf1ea@FontAwesome"},config:{facets:{},matchingDocIds:[],customResultsHtml:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,
arguments);Ext.apply(this,{title:this.localize("title"),layout:"hbox",items:[{layout:"vbox",height:"100%",align:"stretch",itemId:"facets",defaults:{width:250,flex:1,xtype:"facet",margin:5,border:!0,frame:!0,includeTools:{close:{type:"close",tooltip:this.localize("closeFacetTip"),callback:function(b){delete this.facets[b.facet];b.destroy();this.updateResults()},scope:this},add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}}},items:[]},{xtype:"panel",
html:a.customResultsHtml||"",flex:1,itemId:"results",height:"100%",align:"stretch",scrollable:!0,margin:5,getCorpus:function(){return this.findParentByType("panel").getCorpus()},listeners:{query:function(b,c){this.findParentByType("panel").updateResults(Ext.isString(c)?[c]:c)}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{itemId:"sendToVoyant",text:this.localize("sendToVoyantButton"),disabled:!0,handler:function(){this.mask(this.localize("exportInProgress"));var b=
this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:!0,docId:this.getMatchingDocIds()},success:function(c,d){b.unmask();c=Ext.JSON.decode(c.responseText);c=b.getBaseUrl()+"?corpus="+c.corpus.id;b.openUrl(c)},failure:function(c,d){b.unmask();me.showResponseError("Unable to export corpus: "+b.getCorpus().getId(),c)}})},scope:this},{itemId:"export",text:this.localize("downloadButton"),disabled:!0,handler:function(){this.mask(this.localize("exportInProgress"));
var b=this;Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),params:{corpus:this.getCorpus().getId(),tool:"corpus.CorpusManager",keepDocuments:!0,docId:this.getMatchingDocIds()},success:function(c,d){b.unmask();c=Ext.JSON.decode(c.responseText);b.downloadFromCorpusId(c.corpus.id)},failure:function(c,d){b.unmask();me.showResponseError("Unable to export corpus: "+b.getCorpus().getId(),c)}})},scope:this},{xtype:"querysearchfield",width:200,flex:1},{itemId:"status",xtype:"tbtext"}]}]},{xtype:this.getApiParam("reader"),
flex:1,height:"100%",align:"stretch",header:!1}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(b,c){this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()]));this.getCustomResultsHtml()||(this.getApiParam("splash")?(this.setCustomResultsHtml(this.getApiParam("splash")),this.updateResults()):(this.setCustomResultsHtml((new Ext.XTemplate(this.localize("noMatches"))).apply([c.getDocumentsCount()])),
this.updateResults(),Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",verifyResourceId:"customhtml-"+c.getAliasOrId()},success:function(d,e){(d=Ext.util.JSON.decode(d.responseText))&&d.storedResource&&d.storedResource.id&&Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:"customhtml-"+c.getAliasOrId()},success:function(f,g){(f=Ext.util.JSON.decode(f.responseText))&&f.storedResource&&f.storedResource.resource&&(this.setCustomResultsHtml(f.storedResource.resource),
this.updateResults())},scope:this})},scope:this})))});this.on("afterrender",function(b){var c=this.queryById("facets");this.addFacet({facet:"lexical",includeTools:{add:{type:"plus",tooltip:this.localize("plusFacetTip"),callback:function(){this.addFacet()},scope:this}},store:new Voyant.data.store.CorpusTerms({parentPanel:this,proxy:{extraParams:{stopList:this.getApiParam("stopList")}}})},c);b=this.getApiParam("facet");Ext.isString(b)&&(b=b.split(","));b.forEach(function(d){this.addFacet({facet:d},
c)},this);(b=this.getApiParam("title"))&&this.setTitle(b)})},addFacet:function(a,b){if(!a)return this.selectFacet(function(g){this.addFacet({facet:g})});b=b||this.queryById("facets");var c=a.facet,d='<span style="font-size: smaller;">(<span class="info-tip" data-qtip="'+this.localize("matchingDocuments")+'">{inDocumentsCount}</span>)</span> {term}<span style="font-size: smaller;"> (<span class="info-tip" data-qtip="'+this.localize("rawFreqs")+'">{rawFreq}</span>)</span>',e=this.localize(c+"Title");
e=="["+c+"Title]"&&(e=c.replace(/^facet\./,"").replace(/^extra./,""));this.localize("matchingDocuments");Ext.applyIf(a,{title:e,collapsible:!0,facet:c,columns:[{renderer:function(g,h,k){return'<span style="font-size: smaller;">(<span class="info-tip" data-qtip="'+this.localize("matchingDocuments")+'">'+k.getInDocumentsCount()+"</span>) </span>"+(k.getLabel?k.getLabel():k.getTerm()+'<span style="font-size: smaller;"> (<span class="info-tip" data-qtip="'+this.localize("rawFreqs")+'">'+k.getRawFreq()+
"</span>)</span>")},flex:1}],bbar:[{xtype:"querysearchfield",width:"100%",tokenType:c.replace("facet.",""),itemTpl:d}],corpus:this.getCorpus()});var f=b.add(a);f.getSelectionModel().on("selectionchange",function(g,h){var k=[];h.forEach(function(l){k.push({facet:f.facet,label:l.getLabel?l.getLabel():l.getTerm()})});this.getFacets()[c]=k;this.updateResults()},this);f.on("query",function(g,h){this.getFacets()[f.facet]=[];this.updateResults()},this);return f},updateResults:function(a){var b=this.getFacets();
if(!a){a=[];for(facet in b)b[facet].forEach(function(e){a.push(e.facet+":"+e.label)});if(a)return this.updateResults(a)}var c=this.queryById("results").getTargetEl();c.update(this.getCustomResultsHtml()?this.getCustomResultsHtml():(new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("status").update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()]));this.queryById("sendToVoyant").setDisabled(!0);this.queryById("export").setDisabled(!0);
if(a&&0<a.length){this.mask(this.localize("loading"));var d=this.getCorpus().getDocumentQueryMatches();d.load({params:{query:a,includeDocIds:!0},callback:function(e,f,g){this.unmask();if(e&&0<e.length){this.queryById("status").setHtml(e.length);var h="<ul>",k=[];e.forEach(function(m){m.getDocIds().forEach(function(n){k.push(n);var r=d.getCorpus().getDocument(n),u="<li id='"+c.getId()+"_"+n+"' class='cataloguedoc'>";u+="<a href='#' class='cataloguedoctitle' data='"+n+"'>"+r.getTitle()+"</a>";for(facet in b)if(0!=
b[facet].length){var q="";if("facet.title"!=facet){var p=facet.replace(/^.+?\./,"");if(n=r.get(p)){var v=Ext.isArray(n);v?q+="<li>"+p+"<ul>":n=[n];n.forEach(function(w){var B=!1;b[facet].forEach(function(C){C.label==w?B=!0:-1==C.facet.indexOf("facet")&&C.label.split(/\W+/).forEach(function(N){0<N.trim().length&&-1<w.toLowerCase().indexOf(N.toLowerCase())&&(B=!0)})});q+="<li>"+(v?"":p.replace("extra.","")+": ")+(B?'<span class="keyword">'+w+"</span>":w)+"</li>"});v&&(q+="</ul></li>")}}q&&(u+="<ul>"+
q+"</ul>")}h+=u+"</li>"})});h+="</ul>";c.update(h);var l=this;e=c.query(".cataloguedoctitle");e.forEach(function(m){Ext.get(m).on("click",function(n,r){this.dispatchEvent("documentSelected",l,r.getAttribute("data"))},l)});1==e.length&&this.dispatchEvent("documentSelected",l,e[0].getAttribute("data"));this.queryById("status").update((new Ext.XTemplate(this.localize("queryMatches"))).apply([k.length,this.getCorpus().getDocumentsCount()]));this.setMatchingDocIds(Ext.Array.clone(k));0<k.length&&(this.queryById("export").setDisabled(!1),
this.queryById("sendToVoyant").setDisabled(!1));b.lexical&&(e=k.splice(0,5),this.loadSnippets(e,c.first().first()),k&&0<k.length&&this.loadSnippets(k))}},scope:this})}},loadSnippets:function(a,b){var c=this.queryById("results").getTargetEl(),d=this.getFacets();if(d.lexical){d=d.lexical.map(function(f){return f.facet+":"+f.label});var e=this.getCorpus().getContexts({buffered:!1});b&&b.mask(this.localize("loadingSnippets"));e.load({method:"POST",params:{stripTags:"all",query:d,docId:a,perDocLimit:3,
limit:100,accurateTotalNotNeeded:!0},scope:this,callback:function(f,g,h){b&&b.unmask();if(h&&Ext.isArray(f)&&0<f.length){var k={};f.forEach(function(l){k[l.getDocIndex()]||(k[l.getDocIndex()]=[]);k[l.getDocIndex()].push(l)});for(docIndex in k)g=this.getCorpus().getDocument(docIndex).getId(),f='<li style="list-style-type: none; font-size: smaller;">'+k[docIndex].map(function(l){return l.getHighlightedContext()}).join(" \u2026 ")+"</li>",g=c.down("#"+c.getId()+"_"+g),g.query("ul")&&(f="<ul>"+f+"</ul>"),
g.insertHtml("beforeEnd",f)}}})}},selectFacet:function(a){if(!this.facetsSelectionStore){var b={};this.getCorpus().getDocuments().each(function(d){for(var e in d.getData())"corpus"!=e&&0!==e.indexOf("parent")&&"-1"==e.indexOf("-lexical")&&(b[e]=!0)});b=Object.keys(b);b.sort();this.facetsSelectionStore=Ext.create("Ext.data.ArrayStore",{fields:["text"],data:b.map(function(d){return[d]})})}var c={};this.queryById("facets").items.each(function(d){c[d.facet]=!0});this.facetsSelectionStore.filterBy(function(d){return!("facet."+
d.get("text")in c)});Ext.create("Ext.window.Window",{title:this.localize("selectFacet"),modal:!0,items:{xtype:"form",width:300,items:{xtype:"combo",store:this.facetsSelectionStore,forceSelection:!0,width:300},buttons:[{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(d){d.up("window").close()}},{text:this.localize("select"),glyph:"xf00c@FontAwesome",flex:1,handler:function(d){var e=d.up("window").down("combo").getValue();if(e)a.call(this,"facet."+
e),d.up("window").close();else return this.showError(this.localize("selectValidFacet"))},scope:this}]},bodyPadding:5}).show()}});Ext.define("Voyant.panel.Cirrus",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.cirrus",statics:{i18n:{},api:{stopList:"auto",categories:void 0,whiteList:void 0,limit:500,visible:50,terms:void 0,docId:void 0,docIndex:void 0,inlineData:void 0,fontFamily:'"Palatino Linotype", "Book Antiqua", Palatino, serif',cirrusForceFlash:!1,background:"0xffffff",fade:!0,smoothness:2,diagonals:"none"},glyph:"xf06e@FontAwesome"},config:{mode:void 0,options:[{xtype:"stoplistoption"},{xtype:"listeditor",
name:"whiteList"},{xtype:"categoriesoption"},{xtype:"fontfamilyoption"},{xtype:"colorpaletteoption"}],records:void 0,terms:void 0,cirrusId:void 0,visLayout:void 0,vis:void 0,tip:void 0,sizeAdjustment:100,minFontSize:12,largestWordSize:0,smallestWordSize:1E6},MODE_CORPUS:"corpus",MODE_DOCUMENT:"mode_document",layout:"fit",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.getApplication().getCategoriesManager().addFeature("orientation",
function(){return 90*~~(2*Math.random())});this.setCirrusId(Ext.id(null,"cirrus_"))},initComponent:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:!0},{fieldLabel:this.localize("visibleTerms"),labelWidth:40,width:120,xtype:"slider",increment:25,minValue:25,maxValue:500,listeners:{afterrender:function(b){b.maxValue=this.getApiParam("limit");b.increment=parseInt(b.maxValue/
50);b.setValue(this.getApiParam("visible"))},changecomplete:function(b,c){this.setApiParams({visible:c});this.loadFromTermsRecords()},scope:this}}]}]});this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout();var a=this.getApiParam("inlineData");if(void 0!==a){if("["==a.charAt(0))var b=Ext.decode(a,!0);else if(-1<a.indexOf(":"))b=[],a.split(",").forEach(function(d){parts=d.split(":");b.push({text:parts[0],rawFreq:parseInt(parts[1])})});else{var c={};b=[];a.split(",").forEach(function(d){d in
c?c[d]++:c[d]=1});for(term in c)b.push({text:term,rawFreq:c[term]})}null!==b&&0<b.length&&(this.setApiParam("inlineData",b),this.setTerms(b),this.buildFromTerms())}},resize:function(a,b,c){this.getVisLayout()&&this.getCorpus()&&(this.setAdjustedSizes(),a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),a.down("svg").set({width:b,height:c}),this.getTerms()&&this.getVisLayout().size([b,c]).stop().words(this.getTerms()).start())},loadedCorpus:function(a,b){this.getApplication().getCategoriesManager().addFeature("font",
this.getApiParam("fontFamily"));this.initVisLayout();this.getApiParam("docIndex")?this.fireEvent("documentSelected",this,b.getDocument(this.getApiParam("docIndex"))):this.getApiParam("docId")?this.fireEvent("documentSelected",this,b.getDocument(this.getApiParam("docId"))):this.loadFromCorpus(b)},corpusSelected:function(a,b){this.loadFromCorpus(b)},documentSelected:function(a,b){b&&(a=this.getCorpus(),b=a.getDocument(b),this.setApiParam("docId",b.getId()),b=b.getDocumentTerms({autoload:!1,corpus:a,
pageSize:this.getApiParam("maxVisible"),parentPanel:this}),this.loadFromDocumentTerms(b))},ensureCorpusView:function(a,b){this.getMode()!=this.MODE_CORPUS&&this.loadFromCorpus(b)}},loadFromCorpus:function(a){void 0===this.getApiParam("inlineData")&&(this.setApiParams({docId:void 0,docIndex:void 0}),this.loadFromCorpusTerms(a.getCorpusTerms({autoload:!1,pageSize:this.getApiParam("maxVisible"),parentPanel:this})))},loadFromDocumentTerms:function(a){a.load({callback:function(b,c,d){this.setMode(this.MODE_DOCUMENT);
this.setRecords(c.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromCorpusTerms:function(a){a.load({callback:function(b,c,d){this.setMode(this.MODE_CORPUS);this.setRecords(c.getRecords());this.loadFromTermsRecords()},scope:this,params:this.getApiParams()})},loadFromTermsRecords:function(){var a=this.getRecords(),b=this.getApiParam("visible");b>a.length&&(b=a.length);for(var c=[],d=0;d<b;d++)0<a[d].get("rawFreq")&&c.push({text:a[d].get("term").replace(/"/g,
""),rawFreq:a[d].get("rawFreq")});this.setTerms(c);this.buildFromTerms()},initVisLayout:function(a){if(a||void 0==this.getVisLayout())if(a=this.getApiParam("cirrusForceFlash"),"true"==a||!0===a){this.setApiParam("cirrusForceFlash",!0);a=this.getCirrusId();for(var b={id:a},c=["background","fade","smoothness","diagonals"],d=0;d<c.length;d++)b[c[d]]=this.getApiParam(c[d]);c='<script type="text/javascript" src="'+this.getApplication().getBaseUrl()+'resources/swfobject/swfobject.js">\x3c/script>';this.update(c+
('<script type="text/javascript">cirrusClickHandler'+a+' = function(word, value) {\n\tif (window.console && console.info) console.info(word, value);\n\tvar cirrusTool = Ext.getCmp("'+this.id+'");\n\tcirrusTool.dispatchEvent("termsClicked", cirrusTool, [word]);\n}\ncirrusLoaded'+a+' = function() {\n\tif (window.console && console.info) console.info("cirrus flash loaded");\n}\ncirrusPNGHandler'+a+' = function(base64String) {\n\tvar cirrusTool = Ext.getCmp("'+this.id+'");\n\tcirrusTool.cirrusPNGHandler(base64String);\n}\x3c/script>'),
!0,function(){function e(f){if("undefined"!==typeof swfobject){var g=f.getLayout().getRenderTarget(),h=g.getWidth();g=g.getHeight();var k=f.getApplication().getBaseUrl()+"resources/cirrus/flash/Cirrus.swf";f.add({xtype:"flash",id:b.id,url:k,width:h,height:g,flashVars:b,flashParams:{menu:"false",scale:"showall",allowScriptAccess:"always",bgcolor:"#222222",wmode:"opaque"}});f.cirrusFlashApp=Ext.get(b.id).first().dom}else setTimeout(e,50,f)}e(this)},this)}else d=this.getLayout().getRenderTarget(),d.update(""),
a=d.getWidth(),c=d.getHeight(),this.setVisLayout(d3.layoutCloud().size([a,c]).overflow(!0).padding(1).rotate(function(e){return this.getApplication().getCategoriesManager().getFeatureForTerm("orientation",e.text)}.bind(this)).spiral("archimedean").font(function(e){return this.getApplication().getCategoriesManager().getFeatureForTerm("font",e.text)}.bind(this)).fontSize(function(e){return e.fontSize}.bind(this)).text(function(e){return e.text}).on("end",this.draw.bind(this))),d=d3.select(d.dom).append("svg").attr("id",
this.getCirrusId()).attr("class","cirrusGraph").attr("width",a).attr("height",c),this.setVis(d.append("g").attr("transform","translate("+a/2+","+c/2+")")),void 0===this.getTip()&&this.setTip(Ext.create("Ext.tip.Tip",{}))},buildFromTerms:function(){var a=this.getTerms();if(this.rendered&&a)if(!0===this.getApiParam("cirrusForceFlash"))if(void 0!==this.cirrusFlashApp&&void 0!==this.cirrusFlashApp.clearAll){for(var b=[],c=0;c<a.length;c++){var d=a[c];!d.text&&d.term&&(d.text=d.term);b.push({word:d.text,
size:d.rawFreq,label:d.rawFreq})}this.cirrusFlashApp.clearAll();this.cirrusFlashApp.addWords(b);this.cirrusFlashApp.arrangeWords()}else Ext.defer(this.buildFromTerms,50,this);else{b=1E3;d=-1;for(c=0;c<a.length;c++){var e=a[c].rawFreq;e<b&&(b=e);e>d&&(d=e)}this.setSmallestWordSize(b);this.setLargestWordSize(d);this.setRelativeSizes();this.setAdjustedSizes();this.getVisLayout().words(a).start()}else Ext.defer(this.buildFromTerms,50,this)},draw:function(a,b){var c=this;this.getLayout().getRenderTarget();
var d=this.getVisLayout().size()[0],e=this.getVisLayout().size()[1];b=b?Math.min(d/Math.abs(b[1].x-d/2),d/Math.abs(b[0].x-d/2),e/Math.abs(b[1].y-e/2),e/Math.abs(b[0].y-e/2))/2:1;var f=d3.transition().duration(1E3);a=this.getVis().selectAll("text").data(a,function(h){return h.text});a.exit().transition(f).style("font-size","1px").remove();var g=a.enter().append("text").text(function(h){return h.text}).attr("text-anchor","middle").attr("data-freq",function(h){return h.rawFreq}).attr("transform",function(h){return"translate("+
[h.x,h.y]+")rotate("+h.rotate+")"}).style("font-family",function(h){return c.getApplication().getCategoriesManager().getFeatureForTerm("font",h.text)}).style("fill",function(h){return c.getApplication().getColorForTerm(h.text,!0)}).style("font-size","1px").on("click",function(h){c.dispatchEvent("termsClicked",c,[h.text])}).on("mouseover",function(h){this.getTip().show()}.bind(this)).on("mousemove",function(h){var k=this.getTip();k.update(h.text+": "+h.rawFreq);h=Ext.get(this.getCirrusId()).dom;h=
d3.mouse(h);h[1]+=30;k.setPosition(h)}.bind(this)).on("mouseout",function(h){this.getTip().hide()}.bind(this));a.merge(g).transition(f).style("font-family",function(h){return c.getApplication().getCategoriesManager().getFeatureForTerm("font",h.text)}).style("fill",function(h){return c.getApplication().getColorForTerm(h.text,!0)}).attr("transform",function(h){return"translate("+[h.x,h.y]+")rotate("+h.rotate+")"}).style("font-size",function(h){return h.fontSize+"px"});this.getVis().transition(f).attr("transform",
"translate("+d/2+","+e/2+")scale("+b+")")},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)},calculateSizeAdjustment:function(){var a=this.getTerms();if(void 0!==a){var b=this.getLayout().getRenderTarget();b=b.getWidth()*b.getHeight();1E5>b?this.setMinFontSize(8):this.setMinFontSize(12);for(var c=0,d=0;d<a.length;d++){var e=this.calculateWordArea(a[d]);c+=e}this.setSizeAdjustment(b/c)}},calculateWordArea:function(a){for(var b=Math.log(10*a.relativeSize)*Math.LOG10E,c=(b+a.relativeSize)/2,d=0,e=
0;e<a.text.length;e++){var f=a.text.charAt(e);d="f"==f||"i"==f||"j"==f||"l"==f||"r"==f||"t"==f?d+b/3:"m"==f||"w"==f?d+b/(4/3):d+b/1.9}return c*d},setAdjustedSizes:function(){this.calculateSizeAdjustment();var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b],d=this.findNewRelativeSize(c);c.fontSize=d>this.getMinFontSize()?d:this.getMinFontSize()}},setRelativeSizes:function(){var a=this.getTerms();if(void 0!==a)for(var b=0;b<a.length;b++){var c=a[b];c.relativeSize=this.map(c.rawFreq,
this.getSmallestWordSize(),this.getLargestWordSize(),.1,1)}},findNewRelativeSize:function(a){var b=this.getSizeAdjustment();b*=this.calculateWordArea(a);return(Math.sqrt(6)*Math.sqrt(6*Math.pow(a.text.length,2)+b*a.text.length)-6*a.text.length)/(2*a.text.length)}});Ext.define("Voyant.panel.CollocatesGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.collocatesgraph",statics:{i18n:{},api:{query:void 0,mode:void 0,limit:5,stopList:"auto",terms:void 0,context:5,centralize:void 0},glyph:"xf1e0@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],nodeData:void 0,linkData:void 0,visId:void 0,vis:void 0,visLayout:void 0,nodes:void 0,links:void 0,zoom:void 0,dragging:!1,contextMenu:void 0,currentNode:void 0,networkMode:void 0,
graphStyle:{keywordNode:{normal:{fill:"#c6dbef",stroke:"#6baed6"},highlight:{fill:"#9ecae1",stroke:"#3182bd"}},contextNode:{normal:{fill:"#fdd0a2",stroke:"#fdae6b"},highlight:{fill:"#fd9a53",stroke:"#e6550d"}},link:{normal:{stroke:"#000000",strokeOpacity:.1},highlight:{stroke:"#000000",strokeOpacity:.5}}},graphPhysics:{defaultMode:{damping:.4,centralGravity:.1,nodeGravity:-50,springLength:100,springStrength:.25,collisionScale:1.25},centralizedMode:{damping:.4,centralGravity:.1,nodeGravity:-1,springLength:200,
springStrength:1,collisionScale:1}}},DEFAULT_MODE:0,CENTRALIZED_MODE:1,constructor:function(a){this.setNodeData([]);this.setLinkData([]);this.setVisId(Ext.id(null,"links_"));this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf014@FontAwesome",
handler:this.resetGraph,scope:this},this.localize("context"),{xtype:"slider",itemId:"contextSlider",minValue:3,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParam("context",a.getValue());this.getNetworkMode()===this.DEFAULT_MODE&&(a=this.getNodeData().map(function(c){return c.term}),0<a.length&&(this.setNodeData([]),this.setLinkData([]),this.refresh(),this.loadFromQuery(a)))},scope:this}}]}]});
this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"menucheckitem",text:"Fixed",itemId:"fixed",listeners:{checkchange:function(a,b,c){a=this.getCurrentNode();void 0!==a&&(c={fixed:b},b?(c.fx=a.x,c.fy=a.y):(c.fx=null,c.fy=null),this.updateDataForNode(a.id,c))},scope:this}},{xtype:"button",text:"Fetch Collocates",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==
a&&(this.getNetworkMode()===this.CENTRALIZED_MODE&&(this.resetGraph(),this.setNetworkMode(this.DEFAULT_MODE),this.setApiParam("centralize",void 0),a.start=0,a.limit=this.getApiParam("limit")),this.fetchCollocatesForNode(a))},scope:this},{xtype:"button",text:"Centralize",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==a&&this.doCentralize(a.term);this.getContextMenu().hide()},scope:this},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(a,b){b=this.getCurrentNode();
void 0!==b&&this.removeNode(b.id);a.up("menu").hide()},scope:this}]}));this.on("loadedCorpus",function(a,b){this.isVisible()&&this.initLoad()},this);this.on("activate",function(){this.getCorpus()&&0===this.getNodeData().length&&Ext.Function.defer(this.initLoad,100,this)},this);this.on("query",function(a,b){this.loadFromQuery(b)},this);this.on("resize",function(a,b,c){if(a=Ext.get(this.getVisId()))c=this.body,b=c.getHeight(),c=c.getWidth(),a.el.dom.setAttribute("width",c),a.el.dom.setAttribute("height",
b),this.getVisLayout().force("x",d3.forceX(c/2)).force("y",d3.forceY(b/2)),Ext.Function.defer(this.zoomToFit,100,this)},this);this.callParent(arguments)},initLoad:function(){this.initGraph();this.setNetworkMode(this.DEFAULT_MODE);if(this.getApiParam("centralize")){this.setNetworkMode(this.CENTRALIZED_MODE);var a=this.getApiParam("centralize");this.doCentralize(a)}else{a=3;var b=this.getApiParam("query");void 0!==b&&(a=Ext.isArray(b)?b.length:b.split(",").length);this.getCorpus().getCorpusTerms({autoLoad:!1}).load({params:{limit:a,
query:b,stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")},callback:function(c,d,e){e&&this.loadFromCorpusTermRecords(c)},scope:this})}},loadFromQuery:function(a){if(Ext.isArray(a)&&0==a.length)this.setApiParam("query",void 0),this.resetGraph();else{this.setApiParams({mode:"corpus",query:a});var b=this.getApiParams();b.noCache=!0;(Ext.isString(a)?[a]:a).forEach(function(c){this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(Ext.clone(b),{query:c}),
callback:function(d,e,f){f&&this.loadFromCorpusCollocateRecords(d)},scope:this})},this)}},loadFromCorpusTermRecords:function(a){if(Ext.isArray(a)&&0<a.length){var b=[];a.forEach(function(c){b.push(c.getTerm())});this.loadFromQuery(b)}},loadFromCorpusCollocateRecords:function(a,b){if(Ext.isArray(a)){var c=this.getApiParam("limit"),d=this.getLayout().getRenderTarget(),e=d.getWidth()/2,f=d.getHeight()/2,g={};this.getNodeData().forEach(function(l){g[l.id]=!0},this);var h=[],k=[];a.forEach(function(l,
m){var n=l.getTerm(),r=l.getContextTerm(),u=l.getKeywordRawFreq(),q=l.getContextTermRawFreq(),p=u,v=q;this.getNetworkMode()===this.CENTRALIZED_MODE&&(p=0,v=Math.log(q));0==m&&(void 0===b&&(b=this.idGet(n)),void 0!==g[b]?this.updateDataForNode(b,{title:n+" ("+u+")",type:"keyword",value:p}):(g[b]=!0,m={id:b,term:n,title:n+" ("+u+")",type:"keyword",value:p,start:c,fixed:!1,x:e,y:f},h.push(m)));if(n!=r){n=this.idGet(r);void 0===g[n]&&(g[n]=!0,r={id:n,term:r,title:r+" ("+q+")",type:"context",value:v,start:0,
fixed:!1,x:e,y:f},h.push(r));r=null;q=this.getLinkData();for(v=0;v<q.length;v++)if(m=q[v],m.source.id==b&&m.target.id==n||m.source.id==n&&m.target.id==b){r=m;break}l=l.getContextTermRawFreq();null===r&&k.push({source:b,target:n,value:l,id:b+"-"+n})}},this);this.setNodeData(this.getNodeData().concat(h));this.setLinkData(this.getLinkData().concat(k));this.refresh()}},idGet:function(a){return a.replace(/\W/g,"_")},updateDataForNode:function(a,b){for(var c=this.getNodeData(),d=0;d<c.length;d++)if(c[d].id===
a){Ext.apply(c[d],b);break}},removeNode:function(a,b){b=this.getNodeData();for(var c=0;c<b.length;c++)if(b[c].id===a){b.splice(c,1);break}b=this.getLinkData();for(c=b.length-1;0<=c;c--)b[c].source.id!==a&&b[c].target.id!==a||b.splice(c,1);this.setApiParam("query",Ext.Array.remove(Ext.Array.from(this.getApiParam("query")),a));this.refresh()},doCentralize:function(a){this.setApiParam("centralize",a);this.resetGraph();this.setNetworkMode(this.CENTRALIZED_MODE);a={id:this.idGet(a),term:a,title:a+" (1)",
type:"keyword",value:1E3,start:0};this.setNodeData([a]);this.refresh();var b=this.getApiParam("limit");this.setApiParam("limit",150);this.fetchCollocatesForNode(a);this.setApiParam("limit",b)},applyNetworkMode:function(a){if(this.getVisLayout()){if(a===this.DEFAULT_MODE){var b=this.getGraphPhysics().defaultMode;this.getVisLayout().velocityDecay(b.damping).force("link",d3.forceLink().id(function(c){return c.id}).distance(b.springLength).strength(b.springStrength)).force("charge",d3.forceManyBody().strength(b.nodeGravity)).force("collide",
d3.forceCollide(function(c){return Math.sqrt(c.bbox.width*c.bbox.height)*b.collisionScale}))}else b=this.getGraphPhysics().centralizedMode,this.getVisLayout().velocityDecay(b.damping).force("link",d3.forceLink().id(function(c){return c.id}).distance(b.springLength).strength(b.springStrength)).force("charge",d3.forceManyBody().strength(function(c){return"keyword"===c.type?-1E4:0})).force("collide",d3.forceCollide(function(c){return"keyword"===c.type?c.value:Math.sqrt(c.bbox.width*c.bbox.height)*b.collisionScale}));
this.getVisLayout().force("x").strength(b.centralGravity);this.getVisLayout().force("y").strength(b.centralGravity)}return a},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");var b=a.getWidth(),c=a.getHeight();this.setVisLayout(d3.forceSimulation().force("x",d3.forceX(b/2)).force("y",d3.forceY(c/2)).on("tick",function(){this.getLinks().attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y});
this.getNodes().attr("transform",function(e){var f=e.x,g=e.y;if(this.getNetworkMode()===this.DEFAULT_MODE||"keyword"!==e.type)f-=.5*e.bbox.width,g-=.5*e.bbox.height;return"translate("+f+","+g+")"}.bind(this));!this.getDragging()&&.075>this.getVisLayout().alpha()&&this.getVisLayout().alpha(-1)}.bind(this)).on("end",function(){Ext.Function.defer(this.zoomToFit,100,this)}.bind(this)));a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("class","linksGraph").attr("width",b).attr("height",
c);var d=a.append("g");b=d3.zoom().scaleExtent([.25,4]).on("zoom",function(){d.attr("transform",d3.event.transform)});this.setZoom(b);a.call(b);a.on("click",function(){this.getContextMenu().hide()}.bind(this));this.setLinks(d.append("g").attr("class","links").selectAll(".link"));this.setNodes(d.append("g").attr("class","nodes").selectAll(".node"));this.setVis(d)},resetGraph:function(){this.setNodeData([]);this.setLinkData([]);this.setNetworkMode(this.DEFAULT_MODE);this.refresh()},refresh:function(){var a=
this,b=this.getNodeData(),c=this.getLinkData(),d=this.getLinks().data(c,function(f){return f.id});d.exit().remove();var e=d.enter().append("line").attr("class","link").attr("id",function(f){return f.id}).on("mouseover",a.linkMouseOver.bind(a)).on("mouseout",a.linkMouseOut.bind(a)).on("click",function(f){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.dispatchEvent("termsClicked",this,['"'+f.source.term+" "+f.target.term+'"~'+this.getApiParam("context")])}.bind(a)).style("cursor",
"pointer").style("stroke-width",function(f){return a.getNetworkMode()===a.DEFAULT_MODE?Math.max(1,Math.min(15,Math.sqrt(f.value))):1});this.setLinks(e.merge(d));d=this.getNodes().data(b,function(f){return f.id});d.exit().remove();e=d.enter().append("g").attr("class",function(f){return"node "+f.type}).attr("id",function(f){return f.id}).on("mouseover",a.nodeMouseOver.bind(a)).on("mouseout",a.nodeMouseOut.bind(a)).on("click",function(f){d3.event.stopImmediatePropagation();d3.event.preventDefault();
this.dispatchEvent("termsClicked",this,[f.term])}.bind(a)).on("dblclick",function(f){d3.event.stopImmediatePropagation();d3.event.preventDefault();this.fetchCollocatesForNode(f)}.bind(a)).on("contextmenu",function(f,g){d3.event.preventDefault();g=a.getContextMenu();g.queryById("label").setHtml(f.term);g.queryById("fixed").setChecked(f.fixed);g.showAt(d3.event.pageX+10,d3.event.pageY-50)}).call(d3.drag().on("start",function(f){a.setDragging(!0);d3.event.active||a.getVisLayout().alpha(.3).restart();
f.fx=f.x;f.fy=f.y;f.fixed=!0}).on("drag",function(f){a.getVisLayout().alpha(.3);f.fx=d3.event.x;f.fy=d3.event.y;a.isMasked()?a.isOffCanvas(d3.event.x,d3.event.y)||a.unmask():a.isOffCanvas(d3.event.x,d3.event.y)&&a.mask(a.localize("releaseToRemove"))}).on("end",function(f){a.setDragging(!1);1!=f.fixed&&(f.fx=null,f.fy=null);a.isOffCanvas(d3.event.x,d3.event.y)&&(a.unmask(),a.mask(a.localize("cleaning")),a.removeNode(f.id),a.unmask())}));e.append("title").text(function(f){return f.title});this.getNetworkMode()===
this.DEFAULT_MODE?e.append("rect").style("stroke-width",1).style("stroke-opacity",1):e.filter(function(f){return"keyword"===f.type}).append("circle").style("stroke-width",1).style("stroke-opacity",1);e.append("text").attr("font-family",function(f){return a.getApplication().getCategoriesManager().getFeatureForTerm("font",f.term)}).attr("font-size",function(f){return Math.max(10,Math.sqrt(f.value))}).text(function(f){return f.term}).each(function(f){f.bbox=this.getBBox()}).style("cursor","pointer").style("user-select",
"none").attr("dominant-baseline","middle");this.setNodes(e.merge(d));this.getNetworkMode()===this.DEFAULT_MODE?(this.getVis().selectAll("rect").attr("width",function(f){return f.bbox.width+16}).attr("height",function(f){return f.bbox.height+8}).attr("rx",function(f){return Math.max(2,.2*f.bbox.height)}).attr("ry",function(f){return Math.max(2,.2*f.bbox.height)}).call(this.applyNodeStyle.bind(this)),this.getVis().selectAll("text").attr("dx",8).attr("dy",function(f){return.5*f.bbox.height+4})):(this.getVis().selectAll("circle").attr("r",
function(f){return Math.min(150,f.bbox.width)}).call(this.applyNodeStyle.bind(this)),this.getVis().selectAll("text").attr("dx",function(f){return"keyword"===f.type?.5*-f.bbox.width:8}).attr("dy",function(f){return"keyword"===f.type?0:.5*f.bbox.height+4}));this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVisLayout().nodes(b);this.getVisLayout().force("link").links(c);this.getVisLayout().alpha(1).restart()},isOffCanvas:function(a,b){var c=Ext.get(this.getVisId());return 0>
a||0>b||a>c.getWidth()||b>c.getHeight()},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;var h=c.getBoundingClientRect(),k=h.width;h=h.height;a=(a||.8)/Math.max(d/k,e/h);f=[k/2-a*f,h/2-a*g];1>d||d3.select(c).transition().duration(b||500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},applyNodeStyle:function(a,b){var c=void 0===b?"normal":b;a.style("fill",function(d){d=d.type+"Node";
return this.getGraphStyle()[d][c].fill}.bind(this));a.style("stroke",function(d){d=d.type+"Node";return this.getGraphStyle()[d][c].stroke}.bind(this))},applyLinkStyle:function(a,b){var c=void 0===b?"normal":b;a.style("stroke",function(d){return this.getGraphStyle().link[c].stroke}.bind(this));a.style("stroke-opacity",function(d){return this.getGraphStyle().link[c].strokeOpacity}.bind(this))},linkMouseOver:function(a){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this));this.getVis().select("#"+
a.id).call(this.applyLinkStyle.bind(this),"highlight")},linkMouseOut:function(a){this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},nodeMouseOver:function(a){this.setCurrentNode(a);this.getVis().selectAll("rect").call(this.applyNodeStyle.bind(this));this.getLinks().each(function(b){if(b.source.id==a.id)var c=b.target.id;else b.target.id==a.id&&(c=b.source.id);void 0!==c&&(this.getVis().select("#"+c+" rect").call(this.applyNodeStyle.bind(this),"highlight"),this.getVis().select("#"+
b.id).call(this.applyLinkStyle.bind(this),"highlight"))}.bind(this));this.getVis().select("#"+a.id+" rect").style("stroke-width",3).call(this.applyNodeStyle.bind(this),"highlight")},nodeMouseOut:function(a){this.getContextMenu().isVisible()||this.setCurrentNode(void 0);this.getVis().selectAll("rect").style("stroke-width",1).call(this.applyNodeStyle.bind(this));this.getVis().selectAll("line").call(this.applyLinkStyle.bind(this))},fetchCollocatesForNode:function(a){var b=this.getApiParam("limit"),c=
this.getApiParam("query");c=Ext.Array.from(this.getApiParam("query"));Ext.Array.include(c,a.term);this.setApiParam("query",c);this.getCorpus().getCorpusCollocates({autoLoad:!1}).load({params:Ext.apply(this.getApiParams(),{query:a.term,start:a.start,limit:b}),callback:function(d,e,f){f&&(this.updateDataForNode(a.id,{start:a.start+b}),this.loadFromCorpusCollocateRecords(d,a.id))},scope:this})}});Ext.define("Voyant.panel.Contexts",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Contexts"],alias:"widget.contexts",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:5,expand:50},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=
this;Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.ContextsBuffered",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}}}),selModel:{type:"rowmodel",listeners:{selectionchange:{fn:function(b,c){this.getApplication().dispatchEvent("termLocationClicked",this,c)},scope:this}}},plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},
{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:5,value:5,maxValue:50,increment:5,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("context"))},changecomplete:function(b,c){a.setApiParam("context",b.getValue());a.getStore().clearAndLoad({params:a.getApiParams()})}}},this.localize("expand"),{xtype:"slider",minValue:5,value:5,maxValue:500,increment:10,width:50,listeners:{render:function(b){b.setValue(a.getApiParam("expand"))},changecomplete:function(b,
c){a.setApiParam("expand",c);b=a.getView();c=a.plugins[0].recordsExpanded;var d=b.getStore(),e;for(e in c){var f=d.getByInternalId(e),g=b.getRow(f),h=g.parentNode.childNodes[1];c[e]?b.fireEvent("expandbody",g,f,h,{force:!0}):Ext.fly(h).down(".x-grid-rowbody").setHtml("")}}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("document"),toolTip:this.localize("documentTip"),width:"autoSize",dataIndex:"docIndex",sortable:!0,renderer:function(b,c,d,e,f,g){return g.getCorpus().getDocument(b).getTinyLabel()}},
{text:this.localize("left"),tooltip:this.localize("leftTip"),align:"right",dataIndex:"left",sortable:!0,flex:1},{text:this.localize("term"),tooltip:this.localize("termTip"),dataIndex:"term",sortable:!0,width:"autoSize"},{text:this.localize("right"),tooltip:this.localize("rightTip"),dataIndex:"right",sortable:!0,flex:1},{text:this.localize("position"),tooltip:this.localize("positionTip"),dataIndex:"position",sortable:!0,hidden:!0,flex:1}],listeners:{scope:this,corpusSelected:function(){this.getStore().getCorpus()&&
(this.setApiParams({docId:void 0,docIndex:void 0}),this.getStore().clearAndLoad())},documentsSelected:function(b,c){var d=[],e=this.getStore().getCorpus();c.forEach(function(f){d.push(e.getDocument(f).getId())},this);this.setApiParams({docId:d,docIndex:void 0});this.getStore().clearAndLoad()},documentSegmentTermClicked:{fn:function(b,c){c.term&&(params={query:c.term},c.docId?params.docId=c.docId:params.docIndex=c.docIndex?c.docIndex:0,this.setApiParams(params),this.isVisible()&&this.getStore().clearAndLoad())},
scope:this},documentIndexTermsClicked:{fn:function(b,c){var d={},e=[],f={},g=[];c.forEach(function(h){d[h.term]||(e.push(h.term),d[h.term]=!0);f[h.docIndex]||(g.push(h.docIndex),f[h.docIndex]=!0)});this.setApiParams({docId:void 0,docIndex:g,query:e});this.isVisible()&&this.getStore().clearAndLoad({params:this.getApiParams()})},scope:this},afterrender:function(b){b.getView().on("expandbody",function(c,d,e,f){if(""===e.textContent||f&&f.force){c=Ext.create("Voyant.data.store.Contexts",{stripTags:"all",
corpus:b.getStore().getCorpus()});var g=d.getData();c.load({params:{query:g.query,docIndex:g.docIndex,position:g.position,limit:1,context:b.getApiParam("expand")},callback:function(h,k,l){l&&1==h.length&&(g=h[0].getData(),Ext.fly(k.expandRow).down(".x-grid-rowbody").setHtml(g.left+" <span class='word keyword'>"+g.middle+"</span> "+g.right))},expandRow:e})}})}}});a.on("loadedCorpus",function(b,c){0==this.hasCorpusAccess(c)?this.mask(this.localize("limitedAccess"),"mask-no-spinner"):c.getCorpusTerms({autoLoad:!1}).load({callback:function(d,
e,f){f&&0<d.length&&(this.setApiParam("query",[d[0].getTerm()]),this.getStore().clearAndLoad({params:this.getApiParams()}))},scope:a,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList"),forTool:"contexts"}})});a.on("query",function(b,c){this.setApiParam("query",c);this.getStore().clearAndLoad({params:this.getApiParams()})},a);a.on("documentTermsClicked",function(b,c){var d=[];c.forEach(function(e){d.push({term:e.getTerm(),docIndex:e.getDocIndex()})});this.fireEvent("documentIndexTermsClicked",
this,d)});a.on("termsClicked",function(b,c){var d=[];Ext.isString(c)&&(c=[c]);c.forEach(function(e){void 0!==e.docIndex&&d.push({term:e.term,docIndex:e.docIndex})});0<d.length&&this.fireEvent("documentIndexTermsClicked",this,d)});a.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCollocates",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpuscollocates",statics:{i18n:{},api:{stopList:"auto",context:5,query:void 0,docId:void 0,docIndex:void 0,sort:"contextTermRawFreq"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(b,c){this.isVisible()&&
this.loadFromApis()});a.embedded||a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(b,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(e){d.push(e.get("term"))});this.setApiParams({query:d,docId:void 0,docIndex:void 0});this.isVisible()&&this.loadFromApis()}});this.on("documentsClicked",function(b,c){var d=[];c.forEach(function(e){d.push(e.get("id"))});this.setApiParams({docId:d,docid:void 0,query:void 0});this.isVisible()&&this.loadFromApis()});
this.on("activate",function(){this.getStore().getCorpus()&&this.loadFromApis()},this);this.on("query",function(b,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&(this.getApiParam("query")?this.getStore().clearAndLoad({params:this.getApiParams()}):this.getStore().getCorpus().getCorpusTerms({leadingBufferZone:0,autoLoad:!1}).load({callback:function(a,b,c){if(c){var d=[];a.forEach(function(e){d.push(e.getTerm())});
this.getStore().getProxy().setExtraParam("query",d);this.setApiParam("query",d);this.loadFromApis()}},scope:this,params:{limit:10,stopList:this.getApiParam("stopList")}}))},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusCollocatesBuffered",{parentPanel:this});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(c,d){var e=[],f=this.getApiParam("context");
d.forEach(function(g){e.push('"'+g.getKeyword()+" "+g.getContextTerm()+'"~'+f)});this.getApplication().dispatchEvent("termsClicked",this,e)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},this.localize("context"),{xtype:"slider",minValue:1,value:5,maxValue:30,increment:2,width:50,listeners:{render:function(c){c.setValue(a.getApiParam("context"))},changecomplete:function(c,d){a.setApiParam("context",
c.getValue());a.loadFromApis()}}},{xtype:"corpusdocumentselector"}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize",hidden:!0},{text:this.localize("contextTerm"),dataIndex:"contextTerm",tooltip:this.localize("contextTermTip"),flex:1,sortable:!0},{text:this.localize("contextTermRawFreq"),tooltip:this.localize("contextTermRawFreqTip"),
dataIndex:"contextTermRawFreq",width:"autoSize",sortable:!0}],listeners:{scope:this,termsClicked:function(c,d){if(this.getStore().getCorpus()){var e=[];d.forEach(function(f){Ext.isString(f)?e.push(f):f.term?e.push(f.term):f.getTerm&&e.push(f.getTerm())});0<e.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:e}),this.isVisible()&&this.loadFromApis())}},corpusSelected:function(){this.getStore().getCorpus()&&(this.setApiParams({docId:void 0,docIndex:void 0}),this.loadFromApis())},documentsSelected:function(c,
d){var e=[],f=this.getStore().getCorpus();d.forEach(function(g){e.push(f.getDocument(g).getId())},this);this.setApiParams({docId:e,docIndex:void 0});this.loadFromApis()}}});a.callParent(arguments);a.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.widget.CorpusTermSummary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpustermsummary",statics:{i18n:{},api:{stopList:"auto",query:void 0,limit:5}},config:{corpus:void 0,record:void 0,collocatesStore:void 0,correlationsStore:void 0,phrasesStore:void 0,documentTermsStore:void 0},cls:"corpus-term-summary",constructor:function(a){if(void 0===a.record)return console.warn("CorpusTermSummary: no config.record!"),!1;Ext.apply(this,{items:{itemId:"main",minHeight:200,
scrollable:!0,margin:5},dockedItems:{dock:"bottom",xtype:"toolbar",items:{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{boxready:function(c){c.setValue(this.getApiParam("limit"))},changecomplete:function(c,d){this.setApiParam("limit",d);this.loadStuff()},scope:this}}},listeners:{boxready:function(){this.body.on("click",function(c){(c=c.getTarget(null,null,!0))&&"A"==c.dom.tagName&&c.hasCls("corpus-type")&&this.dispatchEvent("termsClicked",
this,[c.getHtml()])},this,{stopPropagation:!0});this.getDockedItems().forEach(function(c){c.getEl().on("click",null,this,{stopPropagation:!0})});this.loadStuff()},scope:this}});Ext.applyIf(a,{title:this.localize("title")+a.record.getTerm()});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var b=this.getRecord().store.getCorpus();this.setCorpus(b);this.setApiParam("query",this.getRecord().getTerm());this.setCollocatesStore(Ext.create("Voyant.data.store.CorpusCollocates",
{corpus:b}));this.setCorrelationsStore(Ext.create("Voyant.data.store.TermCorrelations",{corpus:b}));this.setPhrasesStore(Ext.create("Voyant.data.store.CorpusNgrams",{corpus:b}));this.setDocumentTermsStore(Ext.create("Voyant.data.store.DocumentTerms",{corpus:b}))},loadStuff:function(){this.getComponent("main").removeAll();for(var a=[],b=0;b<this.getCorpus().getDocumentsCount();b++)a[b]=b;this.getComponent("main").add({xtype:"container",cls:"section",layout:"hbox",align:"bottom",items:[{xtype:"container",
html:'<div class="header">'+this.localize("distribution")+"</div>"},{itemId:"distLine",xtype:"sparklineline",values:[],height:20,width:200}],listeners:{afterrender:function(c){c.mask(this.localize("loading"));this.getDocumentTermsStore().load({params:{query:this.getApiParam("query"),docIndex:a,withDistributions:!0,bins:2*parseInt(this.getApiParam("limit"))},callback:function(d,e,f){f&&d&&0<d.length&&(d=d.map(function(g){return g.getDistributions()}).reduce(function(g,h){return g.concat(h)}),this.down("#distLine").setValues(d),
c.unmask())},scope:this})},scope:this}});this.addSection(this.localize("collocates"),this.getCollocatesStore(),this.getApiParams(),'<tpl for="." between="; "><a href="#" onclick="return false" class="corpus-type keyword" voyant:recordId="{term}">{term}</a><span style="font-size: smaller"> ({val})</span></tpl>',function(c){return{term:c.getContextTerm(),val:c.getContextTermRawFreq()}});this.addSection(this.localize("correlations"),this.getCorrelationsStore(),this.getApiParams(),'<tpl for="." between="; "><a href="#" onclick="return false" class="corpus-type keyword" voyant:recordId="{term}">{term}</a><span style="font-size: smaller"> ({val})</span></tpl>',
function(c){return{term:c.get("source-term"),val:c.get("source").rawFreq}});this.addSection(this.localize("phrases"),this.getPhrasesStore(),Ext.apply({minLength:3,sort:"length"},this.getApiParams()),'<tpl for="."><div>&ldquo;{phrase}&rdquo;</div></tpl>',function(c){return{phrase:c.getTerm()}})},addSection:function(a,b,c,d,e){return this.getComponent("main").add({xtype:"container",html:'<div class="header">'+a+"</div>",cls:"section",listeners:{afterrender:function(f){f.mask(this.localize("loading"));
b.load({params:c,callback:function(g,h,k){k&&g&&0<g.length&&(f.unmask(),Ext.dom.Helper.append(f.getTargetEl().first().first(),(new Ext.XTemplate('<div class="contents">'+d+"</div>")).apply(g.map(e))))}})},scope:this}})}});Ext.define("Voyant.panel.Correlations",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.correlations",statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",minInDocumentsCountRatio:100},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),
emptyText:this.localize("emptyText"),store:Ext.create("Voyant.data.store.TermCorrelationsBuffered",{parentPanel:this}),columns:[{text:this.localize("source"),tooltip:this.localize("sourceTip"),dataIndex:"source-term",sortable:!1},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"source-distributions",widget:{xtype:"sparklineline"},text:"\u2190"},{xtype:"widgetcolumn",tooltip:this.localize("trendTip"),width:100,dataIndex:"target-distributions",widget:{xtype:"sparklineline"},
text:"\u2192",align:"right"},{text:this.localize("target"),tooltip:this.localize("targetTip"),dataIndex:"target-term",sortable:!1},{text:this.localize("correlation"),tooltip:this.localize("correlationTip"),dataIndex:"correlation"},{text:this.localize("significance"),tooltip:this.localize("significanceTip"),dataIndex:"significance"}],listeners:{scope:this,corpusSelected:function(){this.setApiParams({docIndex:void 0,docId:void 0});this.getStore().getProxy().setExtraParam("tool","corpus.CorpusTermCorrelations");
this.getStore().load()},documentsSelected:function(b,c){var d=[],e=this.getStore().getCorpus();c.forEach(function(f){d.push(e.getDocument(f).getId())},this);this.setApiParams({docId:d,docIndex:void 0});this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");this.getStore().load()}},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},{xtype:"tbspacer"},{xtype:"tbtext",itemId:"minInDocumentsCountRatioLabel",
text:a.localize("minInDocumentsCountRatioLabel")},{xtype:"slider",increment:5,minValue:0,maxValue:100,width:75,listeners:{afterrender:function(b){b.setValue(this.getApiParam("minInDocumentsCountRatio"));b.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(a.localize("minInDocumentsCountRatioLabel"))).apply([this.getApiParam("minInDocumentsCountRatio")]))},changecomplete:function(b,c){this.setApiParams({minInDocumentsCountRatio:c});b.up("toolbar").getComponent("minInDocumentsCountRatioLabel").setText((new Ext.XTemplate(a.localize("minInDocumentsCountRatioLabel"))).apply([c]));
this.getStore().load()},scope:this}},{xtype:"corpusdocumentselector"}]}]});a.on("loadedCorpus",function(b,c){1==c.getDocumentsCount()&&this.getStore().getProxy().setExtraParam("tool","corpus.DocumentTermCorrelations");this.isVisible()&&this.getStore().load()});a.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load()},this);a.on("query",function(b,c){this.setApiParam("query",c);this.getStore().load()},a);a.callParent(arguments)}});Ext.define("Voyant.panel.CorpusCreator",{extend:"Ext.form.Panel",requires:["Ext.form.field.File"],mixins:["Voyant.panel.Panel"],alias:"widget.corpuscreator",isConsumptive:!0,statics:{i18n:{},api:{inputFormat:void 0,language:void 0,xmlDocumentsXpath:void 0,xmlGroupByXpath:void 0,xmlContentXpath:void 0,xmlTitleXpath:void 0,xmlAuthorXpath:void 0,xmlPubDateXpath:void 0,xmlPublisherXpath:void 0,xmlPubPlaceXpath:void 0,xmlKeywordsXpath:void 0,xmlCollectionXpath:void 0,xmlExtraMetadataXpath:void 0,htmlGroupByQuery:void 0,
htmlDocumentsQuery:void 0,htmlContentQuery:void 0,htmlTitleQuery:void 0,htmlAuthorQuery:void 0,htmlPubDateQuery:void 0,htmlPublisherQuery:void 0,htmlPubPlaceQuery:void 0,htmlKeywordsQuery:void 0,htmlCollectionQuery:void 0,htmlExtraMetadataQuery:void 0,jsonDocumentsPointer:void 0,jsonContentPointer:void 0,jsonTitlePointer:void 0,jsonAuthorPointer:void 0,jsonPubDatePointer:void 0,jsonPublisherPointer:void 0,jsonPubPlacePointer:void 0,jsonKeywordsPointer:void 0,jsonCollectionPointer:void 0,jsonExtraMetadataPointer:void 0,
tokenization:void 0,adminPassword:void 0,accessPassword:void 0,noPasswordAccess:void 0,tableDocuments:void 0,tableContent:void 0,tableTitle:void 0,tableAuthor:void 0,title:void 0,subTitle:void 0,inputRemoveFrom:void 0,inputRemoveFromAfter:void 0,inputRemoveUntil:void 0,inputRemoveUntilAfter:void 0,sort:void 0}},constructor:function(a){this.callParent(arguments);a=a||{};this.mixins["Voyant.panel.Panel"].constructor.call(this,Ext.apply(a,{includeTools:{gear:!0,help:!0,language:this.getLanguageToolMenu()}}))},
initComponent:function(){var a=this;Ext.apply(a,{title:this.localize("title"),width:800,frame:!0,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},frameHeader:!0,layout:{type:"vbox",align:"stretch"},dockedItems:[{xtype:"toolbar",overflowHandler:"scroller",dock:"bottom",buttonAlign:"right",items:[{text:a.localize("Open"),glyph:"xf115@FontAwesome",tooltip:a.localize("SelectExisting"),hidden:void 0!=this.getCorpus(),handler:function(){Ext.create("Ext.window.Window",{title:a.localize("Open"),
layout:"fit",modal:!0,items:{xtype:"form",submitEmptyText:!1,margin:"5,5,5,5",items:{xtype:"corpusselector"},buttons:[{text:a.localize("Open"),glyph:"xf00c@FontAwesome",handler:function(b){b.up("form").getForm();var c=b.up("form").getForm().getValues().corpus;""!=c?(a.loadCorpus({corpus:c}),b.up("window").close()):Ext.Msg.show({title:a.localize("SelectExisting"),message:a.localize("PleaseSelectExisting"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},flex:1},{text:a.localize("cancel"),glyph:"xf00d@FontAwesome",
flex:1,handler:function(b){b.up("window").close()}}]}}).show()}},{xtype:"fileuploadfield",glyph:"xf093@FontAwesome",name:"upload",buttonOnly:!0,hideLabel:!0,ui:"default-toolbar",buttonText:a.localize("Upload"),listeners:{render:function(b){b.fileInputEl.dom.setAttribute("multiple",!0);Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("UploadLocal")})},beforedestroy:function(b){Ext.tip.QuickTipManager.unregister(b.getEl())},change:function(b,c){if(c){var d=b.up("form").getForm();if(d.isValid()){c=
b.fileInputEl.dom.files;for(var e=/\.(png|gif|jpe?g|xls|mp[234a]|mpeg|exe|wmv|avi|ppt|mpg|tif|wav|mov|psd|wma|ai|bmp|pps|aif|pub|dwg|indd|swf|asf|mbd|dmg|flv)$/i,f=/\.(txt|pdf|html?|xml|docx?|rtf|pages|epub|odt|zip|jar|tar|gz|ar|cpio|bzip2|bz2|gzip|xlsx?)$/i,g=[],h=[],k=0,l=c.length;k<l;k++){var m=c[k].name;e.test(m)?g.push(m.split("/").pop()):f.test(m)||h.push(m.split("/").pop())}0<g.length||0<h.length?Ext.Msg.show({title:a.localize("fileTypesWarning"),icon:Ext.MessageBox.ERROR,message:a.localize("fileTypesMessage")+
"<ul>"+(0<g.length?"<li>"+a.localize("badFiles")+g.slice(0,5).join(", ")+(5<g.length?"\u2026":"")+"</li>":"")+(0<h.length?"<li>"+a.localize("unknownFiles")+h.slice(0,5).join(", ")+(5<h.length?"\u2026":"")+"</li>":"")+"</ul>"+a.localize("sureContinue"),buttons:Ext.Msg.YESNO,fn:function(n){"yes"===n?a.loadForm(d):(b.reset(),b.fileInputEl.dom.setAttribute("multiple",!0))},scope:d}):a.loadForm(d)}}}}},"->",{xtype:"button",scale:"large",glyph:"xf00d@FontAwesome",text:this.localize("cancel"),hidden:void 0==
this.getCorpus(),handler:function(b){(b=this.up("window"))&&b.isFloating()&&b.close()}},{xtype:"button",scale:"large",glyph:"xf00c@FontAwesome",text:this.localize("reveal"),ui:"default",width:200,handler:function(b){var c=b.up("form").down("#input").getValue();if(""!==c){var d=a.getApiParams();delete d.view;delete d.stopList;d.inputFormat&&0!==c.trim().indexOf("<")?Ext.Msg.confirm(a.localize("error"),a.localize("errorNotXmlContinue"),function(e){"yes"==e&&a.loadCorpus(Ext.apply(d,{input:c}))},a):
a.loadCorpus(Ext.apply(d,{input:c}))}else Ext.Msg.show({title:a.localize("noTextProvided"),message:a.localize("pleaseProvideText"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}]}],items:[{html:this.getInitialConfig().addTextLabel,hidden:void 0==this.getInitialConfig().addTextLabel},{height:100,xtype:"textareafield",itemId:"input",emptyText:this.localize("emptyInput")}]});a.on("boxready",function(b){var c=this.getApplication();c.getAllowInput&&"false"==c.getAllowInput()&&(c.getNoAllowInputText&&0<c.getNoAllowInputText().trim().length?
Ext.defer(function(){var d=b.up("container");d.removeAll();d.add({frame:!1,padding:10,style:{borderColor:"#aaa",borderStyle:"solid"},html:c.getNoAllowInputText()})},100):(b.hide(),Ext.create("Ext.window.Window",{layout:"fit",header:!1,modal:!0,bodyPadding:10,items:{html:"<p style='color: red;'>"+b.localize("noAllowInputMessage")+"</p>"}}).show()))});a.callParent(arguments)},loadForm:function(a){var b={tool:this.getCorpus()?"corpus.CorpusMetadata":"corpus.CorpusCreator"};this.getCorpus()&&Ext.apply(b,
{corpus:this.getCorpus().getId(),addDocuments:!0});var c=this.getApiParams();delete c.view;delete c.stopList;Ext.apply(b,c);var d=this.getApplication().getViewport();d.mask(this.localize("uploadingCorpus"));a.submit({url:this.getTromboneUrl(),params:b,failure:function(e,f){d.unmask();f.result&&(f.result.corpus||f.result.stepEnabledCorpusCreator)?(e={corpus:f.result.corpus?f.result.corpus.metadata.id:f.result.stepEnabledCorpusCreator.storedId},Ext.applyIf(e,c),this.setCorpus(void 0),this.loadCorpus(e)):
this.showResponseError("Unable to load corpus.",f.response)},scope:this})},loadCorpus:function(a){this.getCorpus()&&Ext.apply(a,{corpus:this.getCorpus().getId(),addDocuments:!0});var b=this.up("window");b&&b.isFloating()&&b.close();this.getApplication().loadCorpusFromParams(a)},showOptionsClick:function(a){void 0===a.optionsWin&&(a.optionsWin=Ext.create("Ext.window.Window",{title:a.localize("gearWinTitle"),closeAction:"hide",layout:"fit",bodyPadding:10,anchor:"100% 100%",items:[{xtype:"form",defaultType:"textfield",
maxHeight:a.getApplication().getViewport().getHeight()-120,scrollable:!0,fieldDefaults:{labelAlign:"right",labelWidth:110,width:350},items:[{xtype:"combo",fieldLabel:a.localize("inputFormat"),labelWidth:90,name:"inputFormat",queryMode:"local",store:[["",a.localize("inputFormatAuto")],["dtoc","DToC: Dynamic Table of Contexts"],["TEI","TEI: Text Encoding Initative"],["TEI","TEI Corpus"],["RSS","Really Simple Syndication: RSS"]],value:"",listeners:{afterrender:{fn:function(b){var c=this.getApiParam("inputFormat");
c&&b.setValue(c)},scope:a}}},{xtype:"container",html:"<p><i>"+(new Ext.Template(a.localize("advancedOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml"])+"</i></p>",width:375},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-titles' target='voyantdocs'>"+a.localize("corpusOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i></i></p>",width:375},{fieldLabel:a.localize("corpusTitle"),
name:"title"},{fieldLabel:a.localize("corpusSubTitle"),name:"subTitle"},{fieldLabel:a.localize("corpusSort"),name:"sort",xtype:"combo",queryMode:"local",store:[["",a.localize("corpusSortAuto")],["TITLEASC",a.localize("corpusSortTitle")],["AUTHORASC",a.localize("corpusSortAuthor")],["PUBDATEASC",a.localize("corpusSortPubDate")]],value:"",listeners:{afterrender:{fn:function(b){var c=this.getApiParam("sort");c&&b.setValue(c)},scope:a}}}]},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-text' target='voyantdocs'>"+
a.localize("textOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+a.localize("textOptionsText")+"</i></p>",width:375},{fieldLabel:a.localize("inputRemoveUntil"),name:"inputRemoveUntil"},{fieldLabel:a.localize("inputRemoveUntilAfter"),name:"inputRemoveUntilAfter"},{fieldLabel:a.localize("inputRemoveFrom"),name:"inputRemoveFrom"},{fieldLabel:a.localize("inputRemoveFromAfter"),name:"inputRemoveFromAfter"}]},{xtype:"fieldset",title:"<a href='"+
a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-xml' target='voyantdocs'>"+a.localize("xmlOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+a.localize("xmlOptionsText")+"</i></p>",width:375},{fieldLabel:a.localize("xpathContent"),name:"xmlContentXpath"},{fieldLabel:a.localize("xpathTitle"),name:"xmlTitleXpath"},{fieldLabel:a.localize("xpathAuthor"),name:"xmlAuthorXpath"},{fieldLabel:a.localize("xpathDocuments"),name:"xmlDocumentsXpath"},
{fieldLabel:a.localize("xpathGroupBy"),name:"xmlGroupByXpath"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"xmlPubDateXpath"},{fieldLabel:a.localize("xpathPublisher"),name:"xmlPublisherXpath"},{fieldLabel:a.localize("xpathPubPlace"),name:"xmlPubPlaceXpath"},{fieldLabel:a.localize("xpathKeywords"),name:"xmlKeywordsXpath"},{fieldLabel:a.localize("xpathCollection"),name:"xmlCollectionXpath"},
{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"xmlExtraMetadataXpath"}]}]},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html' target='voyantdocs'>"+a.localize("htmlOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+(new Ext.Template(a.localize("htmlOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-html"])+"</i></p>",width:375},{fieldLabel:a.localize("xpathContent"),
name:"htmlContentQuery"},{fieldLabel:a.localize("xpathTitle"),name:"htmlTitleQuery"},{fieldLabel:a.localize("xpathAuthor"),name:"htmlAuthorQuery"},{fieldLabel:a.localize("xpathDocuments"),name:"htmlDocumentsQuery"},{fieldLabel:a.localize("xpathGroupBy"),name:"htmlGroupByQuery"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"htmlPubDateQuery"},{fieldLabel:a.localize("xpathPublisher"),
name:"htmlPublisherQuery"},{fieldLabel:a.localize("xpathPubPlace"),name:"htmlPubPlaceQuery"},{fieldLabel:a.localize("xpathKeywords"),name:"htmlKeywordsQuery"},{fieldLabel:a.localize("xpathCollection"),name:"htmlCollectionQuery"},{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"htmlExtraMetadataQuery"}]}]},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json' target='voyantdocs'>"+a.localize("jsonOptions")+"</a>",collapsible:!0,collapsed:!0,
defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+(new Ext.Template(a.localize("jsonOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-json"])+"</i></p>",width:375},{fieldLabel:a.localize("xpathContent"),name:"jsonContentPointer"},{fieldLabel:a.localize("xpathTitle"),name:"jsonTitlePointer"},{fieldLabel:a.localize("xpathAuthor"),name:"jsonAuthorPointer"},{fieldLabel:a.localize("xpathDocuments"),name:"jsonDocumentsPointer"},{xtype:"fieldset",title:a.localize("xmlAdditionalOptions"),
collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{fieldLabel:a.localize("xpathPubDate"),name:"jsonPubDatePointer"},{fieldLabel:a.localize("xpathPublisher"),name:"jsonPublisherPointer"},{fieldLabel:a.localize("xpathPubPlace"),name:"jsonPubPlacePointer"},{fieldLabel:a.localize("xpathKeywords"),name:"jsonKeywordsPointer"},{fieldLabel:a.localize("xpathCollection"),name:"jsonCollectionPointer"},{xtype:"textareafield",grow:!0,fieldLabel:a.localize("xpathExtra"),name:"jsonExtraMetadataPointer"}]}]},
{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables' target='voyantdocs'>"+a.localize("tableOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+(new Ext.Template(a.localize("tableOptionsText"))).applyTemplate([a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-tables"])+"</i></p>",width:375},{xtype:"combo",fieldLabel:a.localize("tableDocuments"),name:"tableDocuments",queryMode:"local",store:[["",a.localize("tableDocumentsTable")],
["rows",a.localize("tableDocumentsRows")],["columns",a.localize("tableDocumentsColumns")]],forceSelection:!0,value:""},{xtype:"container",html:"<p><i>"+a.localize("tableNoHeadersRowText")+"</i></p>",width:375},{fieldLabel:a.localize("tableNoHeadersRow"),xtype:"checkboxfield",name:"tableNoHeadersRow",inputValue:"true"},{xtype:"container",html:"<p><i>"+a.localize("tableContentText")+"</i></p>",width:375},{fieldLabel:a.localize("tableContent"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,
b)},name:"tableContent"},{xtype:"container",html:"<p><i>"+a.localize("tableMetadataText")+"</i></p>",width:375},{fieldLabel:a.localize("tableAuthor"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableAuthor"},{fieldLabel:a.localize("tableTitle"),validator:function(b){return a.validatePositiveNumbersCsv.call(a,b)},name:"tableTitle"}]},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-processing' target='voyantdocs'>"+a.localize("processingOptions")+
"</a>",collapsible:!0,collapsed:!0,items:[{xtype:"combo",fieldLabel:a.localize("language"),name:"language",queryMode:"local",store:[["",a._localizeClass(Voyant.widget.StopListOption,"auto")],["cn",a._localizeClass(Voyant.widget.StopListOption,"cn")],["bo",a._localizeClass(Voyant.widget.StopListOption,"bo")],["grc",a._localizeClass(Voyant.widget.StopListOption,"grc")]],forceSelection:!0,value:""},{xtype:"combo",fieldLabel:a.localize("tokenization"),name:"tokenization",queryMode:"local",store:[["",
a.localize("tokenizationAuto")],["wordBoundaries",a.localize("tokenizationWordBoundaries")],["whitespace",a.localize("tokenizationWhitespace")]],forceSelection:!0,value:""}]},{xtype:"fieldset",title:"<a href='"+a.getBaseUrl()+"docs/#!/guide/corpuscreator-section-access-management' target='voyantdocs'>"+a.localize("accessOptions")+"</a>",collapsible:!0,collapsed:!0,defaultType:"textfield",items:[{xtype:"container",html:"<p><i>"+a.localize("accessOptionsText")+"</i></p>",width:375},{fieldLabel:a.localize("adminPassword"),
name:"adminPassword"},{fieldLabel:a.localize("accessPassword"),name:"accessPassword"},{xtype:"container",html:"<p><i>"+a.localize("accessModeWithoutPasswordText")+"</i></p>",width:375},{xtype:"combo",fieldLabel:a.localize("accessModeWithoutPassword"),name:"noPasswordAccess",queryMode:"local",store:[["",a.localize("accessModeNonConsumptive")],["none",a.localize("accessModeNone")]],forceSelection:!0,value:""}]}]}],buttons:[{text:a.localize("ok"),handler:function(b,c){b=b.findParentByType("window");
c=b.down("form");c.isValid()?(c=c.getValues(),a.setApiParams(c),b.hide()):a.showError({message:a.localize("invalidForm")})}},{text:a.localize("cancel"),handler:function(b,c){b.findParentByType("window").hide()}}]}));a.optionsWin.showAt(a.getApplication().getViewport().getWidth()/2-200,10)},validatePositiveNumbersCsv:function(a){a=a.trim();if(0<a.length){if(/[^\d,+ ]/.test(a))return this.localize("numbersCommasOnly");if(/\d\s+\d/.test(a))return this.localize("numbersNeedCommas");a=a.split(/\s*[,+]\s*/);
for(var b,c=0,d=a.length;c<d;c++){b=a[c];if(0==b.length)return this.localize("numberEmpty");if(0==parseInt(b))return this.localize("numberZero")}}return!0}});Ext.define("Voyant.panel.DreamScape",{extend:"Ext.Panel",xtype:"dreamscape",mixins:["Voyant.panel.Panel"],statics:{i18n:{},api:{stopList:"auto",hide:[],author:void 0,title:void 0,keyword:void 0,pubDate:void 0,citiesMaxCount:500,minPopulation:1E4,citiesMinFreq:1,connectionsMaxCount:2500,connectionsMinFreq:1,millisPerAnimation:2E3,annotationsId:void 0,source:void 0,overridesId:void 0,filterHasLowerCaseForm:!0,filterIsPersonName:!0,preferredCoordinates:void 0},glyph:"xf124@FontAwesome"},config:{map:void 0,
overlay:void 0,contentEl:void 0,isOpenLayersLoaded:!1,isArcLoaded:!1,animationDelay:25,isProj4Loaded:!1,projection:void 0,filterWidgets:new Ext.util.MixedCollection,drawInteraction:void 0,drawMode:!1,baseLayers:{},annotations:void 0,annotationsLoadedIfAvailable:!1,overrides:{}},html:'<div class="map"></div><div class="ticker"></div>',cls:"dreamscape",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);Ext.Loader.loadScript({url:this.getBaseUrl()+
"resources/openlayers/ol.js",onLoad:function(){void 0===ol.Map.prototype.getLayer&&(ol.Map.prototype.getLayer=function(d){var e=void 0;this.getLayers().forEach(function(f){d===f.get("id")&&(e=f)});return e});this.setIsOpenLayersLoaded(!0)},scope:this});Ext.Loader.loadScript({url:this.getBaseUrl()+"resources/dreamscape/arc.js",onLoad:function(){this.setIsArcLoaded(!0)},scope:this});Ext.Loader.loadScript({url:"https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js",onLoad:function(){this.setIsProj4Loaded(!0)},
scope:this});var b=this.getApiParam("annotationsId");if(b){var c=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:b},scope:this}).then(function(d){d=Ext.JSON.decode(d.responseText);d.storedResource.resource&&(d=Ext.JSON.decode(d.storedResource.resource),Ext.isString(d)&&(d=Ext.JSON.decode(d),c.setAnnotations(d)));c.getAnnotations()||c.showError(c.localize("annotationsLoadFailed"));c.setAnnotationsLoadedIfAvailable(!0)},function(d){c.showResponseError(c.localize("annotationsLoadFailed"),
d);c.setAnnotationsLoadedIfAvailable(!0)})}else this.setAnnotationsLoadedIfAvailable(!0)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var a=this.getApiParam("hide");Ext.isString(a)&&(a=a.split(","),this.setApiParam("hide"));this.getApplication().getBaseUrl();Ext.apply(this,{title:this.localize("title"),bodyBorder:!0,dockedItems:[{dock:"bottom",xtype:"toolbar",itemId:"bottomToolbar",overflowHandler:"scroller",items:[{text:this.localize("display"),tooltip:this.localize("displayTip"),
glyph:"xf013@FontAwesome",menu:{defaults:{xtype:"menucheckitem",checkHandler:function(b,c){var d=this.getMap(),e=b.getItemId();this.getFilterWidgets().each(function(g){d.getLayer(g.getId()+"-"+e).setVisible(c)});var f=Ext.Array.from(this.getApiParam("hide"));c?f=Ext.Array.remove(f,e):(f.push(e),f=Ext.Array.unique(f));this.setApiParam("hide",f);b.getMenu().setDisabled(0==c)},scope:this,checked:!0},items:[{xtype:"menuitem",text:this.localize("baseLayer"),tooltip:this.localize("baseLayerTip"),glyph:"xf279@FontAwesome",
menu:{items:[{xtype:"radiogroup",columns:1,vertical:!0,defaults:{cls:"map-menu-item",handler:function(b,c){if(c){id=b.getItemId();if(b=this.getBaseLayers()[id])b.setOpacity(1),this.getMap().getLayers().setAt(0,b);"osm"==id||"arcGIS"==id?this.getMap().getLayer("overlayLayer").setVisible(!1):this.getMap().getLayer("overlayLayer").setVisible(!0)}},listeners:{afterrender:function(b){Ext.create("Ext.tip.ToolTip",{target:b,html:'<div class="map-menu-item-tooltip '+b.getItemId()+'"></div>',anchor:"right"})}},
scope:this},items:[{boxLabel:this.localize("watercolor"),itemId:"watercolor",cls:["map-menu-item","watercolor"],checked:!0},{boxLabel:this.localize("wms4326"),cls:["map-menu-item","wms4326"],itemId:"wms4326"},{boxLabel:this.localize("osm"),cls:["map-menu-item","osm"],itemId:"osm"},{boxLabel:this.localize("arcGIS"),cls:["map-menu-item","arcGIS"],itemId:"arcGIS"}]}]}},{xtype:"menuitem",text:this.localize("projection"),tooltip:this.localize("projectionTip"),glyph:"xf0ac@FontAwesome",menu:{items:[{xtype:"radiogroup",
columns:1,vertical:!0,defaults:{handler:function(b,c){if(c){var d=this;id=b.getItemId();"webMercatorProjection"===id?this.setProjection(ol.proj.get("EPSG:3857")):"mercatorProjection"===id?this.setProjection(ol.proj.get("EPSG:4326")):"gallPetersProjection"===id?(proj4.defs("cea","+proj=cea +lon_0=0 +lat_ts=45 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"),b=ol.proj.get("cea"),this.setProjection(b)):"sphereMollweideProjection"===id&&(proj4.defs("ESRI:54009","+proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"),
b=ol.proj.get("ESRI:54009"),b.setExtent([-18E6,-9E6,18E6,9E6]),this.setProjection(b));b=this.getProjection().getExtent();c=this.getProjection()==ol.proj.get("EPSG:4326")?360:4.007501668557849E7;b=new ol.View({projection:this.getProjection(),center:ol.extent.getCenter(b||[0,0,0,0]),maxResolution:c/d.body.dom.offsetWidth,zoom:0});var e=this.getMap();e.getLayers().forEach(function(f){f.getSource().getFeatures&&f.getSource().getFeatures().forEach(function(g){var h=g.getGeometry().transform(e.getView().getProjection(),
d.getProjection());g.setGeometry(h)})});e.setView(b)}},listeners:{afterrender:function(b){Ext.create("Ext.tip.ToolTip",{target:b,html:'<div class="map-menu-item-tooltip '+b.getItemId()+'"></div>',anchor:"right"})}},scope:this},items:[{boxLabel:this.localize("webMercatorProjection"),itemId:"webMercatorProjection",cls:["map-menu-item","webMercatorProjection"],checked:!0},{boxLabel:this.localize("mercatorProjection"),cls:["map-menu-item","mercatorProjection"],itemId:"mercatorProjection"},{boxLabel:this.localize("gallPetersProjection"),
cls:["map-menu-item","gallPetersProjection"],itemId:"gallPetersProjection"},{boxLabel:this.localize("sphereMollweideProjection"),cls:["map-menu-item","sphereMollweideProjection"],itemId:"sphereMollweideProjection"}]}]}},"-",{text:this.localize("cities"),checked:0==Ext.Array.contains(a,"cities"),itemId:"cities",menu:{defaults:{labelAlign:"right",labelWidth:140},items:[{xtype:"numberfield",fieldLabel:this.localize("citiesMaxCount"),minValue:1,value:parseInt(this.getApiParam("citiesMaxCount")),listeners:{change:function(b,
c,d){this.getFilterWidgets().each(function(e){this.setApiParam("citiesMaxCount",c);var f=e.getGeonames().getCitiesCount();c<d||c<=f?this.filterUpdate(e):e.getGeonames().hasMoreCities()?e.loadGeonames():(b.setValue(f),this.toastInfo((new Ext.XTemplate(this.localize("allNCitiesShown"))).apply([f])))},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinPopulation"),minValue:1,value:parseInt(this.getApiParam("minPopulation")),listeners:{change:function(b,c,d){this.setApiParam("minPopulation",
c);this.getFilterWidgets().each(function(e){c>d?this.filterUpdate(e):e.loadGeonames()},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("citiesMinFreq"),minValue:1,value:parseInt(this.getApiParam("citiesMinFreq")),listeners:{change:function(b,c,d){this.getFilterWidgets().each(function(e){this.setApiParam("citiesMinFreq",c);c>d?this.filterUpdate(e):e.loadGeonames()},this)},scope:this}}]}},{text:this.localize("connections"),checked:0==Ext.Array.contains(a,"connections"),itemId:"connections",
menu:{defaults:{labelWidth:140,labelAlign:"right"},items:[{xtype:"numberfield",fieldLabel:this.localize("connectionsMaxCount"),minValue:1,value:parseInt(this.getApiParam("connectionsMaxCount")),listeners:{change:function(b,c,d){this.getFilterWidgets().each(function(e){this.setApiParam("connectionsMaxCount",c);c>d?this.filterUpdate(e):e.loadGeonames()},this)},scope:this}},{xtype:"numberfield",fieldLabel:this.localize("connectionsMinFreq"),minValue:1,value:parseInt(this.getApiParam("connectionsMinFreq")),
listeners:{change:function(b,c,d){this.getFilterWidgets().each(function(e){this.setApiParam("connectionsMinFreq",c);c>d?this.filterUpdate(e):e.loadGeonames()},this)},scope:this}}]}},{xtype:"menucheckitem",checked:0==Ext.Array.contains(a,"animation"),text:this.localize("animations"),itemId:"animation",menu:{defaults:{labelWidth:170,labelAlign:"right",width:280},items:[{xtype:"sliderfield",fieldLabel:this.localize("millisPerAnimation"),value:parseInt(this.getApiParam("millisPerAnimation")),minValue:this.getAnimationDelay(),
maxValue:1E4,listeners:{change:function(b,c,d){this.getFilterWidgets().each(function(e){e.setMillisPerAnimation(c);e.animate()},this)},scope:this}}]}}]}},"-",{text:this.localize("add"),itemId:"addFilter",glyph:"xf067@FontAwesome",handler:function(b){for(var c=this.getApplication().getColorPalette(this.getApiParam("palette"),!0),d=c[0],e=0,f=c.length;e<f;e++){var g=!1;this.getFilterWidgets().each(function(h){if(h.getColor()==c[e])return g=!0,!1});if(0==g){d=c[e];break}}d=b.ownerCt.add({xtype:"geonamesfilter",
corpus:this.getCorpus(),color:d,listeners:{removeFilterWidget:function(h){var k=this.getMap(),l=h.getItemId(),m=this.getFilterWidgets();["connections","cities","animation"].forEach(function(n){k.removeLayer(k.getLayer(l+"-"+n))});m.remove(h);0==m.getCount()&&this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()},filterUpdate:this.filterUpdate,scope:this}});this.getFilterWidgets().add(d.getId(),d);b=this.getMap();f=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!0}),
id:d.getId()+"-connections",visible:!0,opacity:.2,style:this.travelStyleFunction.bind(this),updateWhileAnimating:!0,updateWhileInteracting:!0});b.addLayer(f);f=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!0}),id:d.getId()+"-cities",opacity:.5,style:this.cityStyleFunction.bind(this)});b.addLayer(f);d=new ol.layer.Vector({source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!0}),id:d.getId()+"-animation",style:this.animationStyleFunction.bind(this)});b.addLayer(d)},scope:this}]}]});
this.on("loadedCorpus",function(b,c){this.tryInit()},this);this.callParent()},tryInit:function(){if(this.getIsOpenLayersLoaded()&&this.getIsArcLoaded()&&this.getIsProj4Loaded()&&this.getAnnotationsLoadedIfAvailable()){var a=this.body.down(".map").setId(Ext.id()),b=this,c=this.getBaseLayers();c.wms4326=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileWMS({url:"https://ahocevar.com/geoserver/wms",crossOrigin:"",params:{LAYERS:"ne:NE1_HR_LC_SR_W_DR",TILED:!0},projection:"EPSG:4326"})});c.watercolor=
new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({layer:"watercolor",projection:"EPSG:3857"})});c.osm=new ol.layer.Tile({preload:Infinity,source:new ol.source.OSM({projection:"EPSG:3857"})});c.arcGIS=new ol.layer.Tile({preload:Infinity,source:new ol.source.TileArcGISRest({url:"https://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",projection:"EPSG:3857"})});var d=new ol.Map({layers:[c.watercolor,new ol.layer.Tile({preload:Infinity,source:new ol.source.Stamen({cacheize:2048,
layer:"toner-hybrid",projection:"EPSG:3857"}),id:"overlayLayer"})],target:a.getId(),loadTilesWhileInteracting:!0,view:new ol.View({center:[0,0],maxResolution:4.007501668557849E7/b.body.dom.offsetWidth,zoom:0})});d.on("singleclick",this.handleSingleClick,this);d.on("singleclicking",function(g){var h=d.getFeaturesAtPixel(g.pixel);if(h){for(var k=0;k<h.length;k++){var l=h[k];"city"==l.get("type")&&this.handleLocationClick(l)}l=h[0];debugger}if(h){var m=!1;h.forEach(function(n){"city"===n.get("type")&&
n.get("selected")?(b.dispatchEvent("termsClicked",b,[n.get("forms").join("|")]),m=!0):"connection"===n.get("type")&&n.get("selected")&&!m&&(b.getFilterWidgets().each(function(r){r=r.getGeonames();if(null!=r){var u="<ul>",q=-1;r.getAllConnectionOccurrences(n.get("source"),n.get("target")).forEach(function(p){p.docIndex!=q&&(q=p.docIndex,u+="<h4>"+b.getCorpus().getDocument(q).getFullLabel()+":</h4>");u+="<li>"+p.source.left+'<a href="http://www.geonames.org/'+p.source.id+'" target="_blank" docIndex='+
p.docIndex+" offset="+p.source.position+" location="+p.source.form+" cityId="+p.source.id+" coordinates="+JSON.stringify(sourceCoordinates)+' class="termLocationLink">'+p.source.form+"</a> "+p.source.right+" [...] "+p.target.left+'<a href="http://www.geonames.org/'+p.target.id+'" target="_blank" docIndex='+p.docIndex+" offset="+p.target.position+" location="+p.target.form+" cityId="+p.target.id+" coordinates="+JSON.stringify(targetCoordinates)+' class="termLocationLink">'+p.target.form+"</a> "+p.target.right+
"</li>"});r=n.get("text");u+="</ul>";b.getContentEl().setHtml("<h3>"+r+"</h3>"+u);b.getOverlay().setPosition(g.coordinate);Ext.select(".termLocationLink").elements.forEach(function(p){p.onmouseover=function(){b.showTermInCorpus(p.getAttribute("docIndex"),p.getAttribute("offset"),p.getAttribute("location"))}})}}),m=!0)},this)}});var e=new ol.layer.Vector({map:d,source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!1}),zIndex:10,selected:!0,style:function(g){if("city"===g.get("type"))return b.cityStyleFunction(g,
d.getView().getResolution());if("connection"===g.get("type"))return b.travelStyleFunction(g,d.getView().getResolution())},updateWhileAnimating:!0,updateWhileInteracting:!0});a=new ol.layer.Vector({map:d,source:new ol.source.Vector({wrapX:!1,useSpatialIndex:!1}),preview:!0,zIndex:15,id:"preview",style:function(g){if("city"===g.get("type"))return b.cityStyleFunction(g,d.getView().getResolution());if("connection"===g.get("type"))return b.travelStyleFunction(g,d.getView().getResolution())},updateWhileAnimating:!0,
updateWhileInteracting:!0});d.addLayer(a);d.on("pointermove",function(g){var h=d.getEventPixel(g.originalEvent);h=d.hasFeatureAtPixel(h);d.getViewport().style.cursor=h?"pointer":"";if(!b.getDrawMode()&&(e.getSource().clear(),h=g.pixel,h=d.getFeaturesAtPixel(h))){for(var k=0;h[k].get("selected")&&(k++,k!==h.length););if(k<h.length){var l=h[k];h={font:"12px Calibri,sans-serif",textAlign:"center",offsetY:-15,fill:new ol.style.Fill({color:[0,0,0,1]}),stroke:new ol.style.Stroke({color:[255,255,255,.5],
width:4})};h.text=l.get("text");h=new ol.style.Style({text:new ol.style.Text(h),zIndex:1});"annotation"!==l.get("type")&&(k=new ol.Feature({text:l.get("text"),geometry:l.getGeometry(),forms:l.get("forms"),selected:!0,coordinates:l.get("coordinates"),width:l.get("width"),visible:l.get("visible"),color:l.get("color"),type:l.get("type"),confidence:l.get("confidence"),source:l.get("source"),target:l.get("target"),cityId:l.get("cityId")}),e.getSource().addFeature(k));l.getGeometry();g=new ol.Feature({geometry:new ol.geom.Point(g.coordinate),
selected:!0});g.setStyle(h);e.getSource().addFeature(g);"city"===l.get("type")&&b.getMap().getLayers().forEach(function(m){var n=m.get("id");n&&-1!==n.indexOf("connections")&&(connections=m.getSource().getFeatures(),connections.forEach(function(r){r.get("target")!==l.get("cityId")&&r.get("source")!==l.get("cityId")||e.getSource().addFeature(new ol.Feature({geometry:r.getGeometry(),selected:!0,coordinates:r.get("coordinates"),width:r.get("width"),visible:r.get("visible"),color:r.get("color"),type:r.get("type")}))}))})}}});
a=new ol.source.Vector({wrapX:!1});c=new ol.layer.Vector({source:a,id:"annotations"});var f=this.getAnnotations();f&&(f=(new ol.format.GeoJSON).readFeatures(f),a.addFeatures(f));d.addLayer(c);this.setDrawInteraction(new ol.interaction.Draw({source:a,type:"Polygon",freehand:!0,alias:"draw"}));this.getDrawInteraction().on("drawend",function(g){g.feature.set("type","annotation");b.editAnnotation(g.feature)});this.setMap(d);this.getTargetEl().down(".ol-zoom");Ext.create("Ext.Button",{glyph:"xf075@FontAwesome",
cls:"annotate",renderTo:this.getTargetEl().down(".ticker").parent(),tooltip:this.localize("annotateTip"),enableToggle:!0,toggleHandler:function(g,h){h?this.getMap().addInteraction(this.getDrawInteraction()):this.getMap().removeInteraction(this.getDrawInteraction())},scope:this});this.getDockedComponent("bottomToolbar").getComponent("addFilter").click()}else Ext.defer(this.tryInit,500,this)},editAnnotation:function(a){var b=a.get("text");Ext.Msg.show({title:this.localize("editAnnotation"),message:this.localize("editAnnotationMessage"),
buttons:Ext.Msg.OKCANCEL,multiline:!0,value:b,scope:this,callback:function(c,d){if("ok"==c){""==d?this.getMap().getLayer("annotations").getSource().removeFeature(a):a.set("text",d);c=new ol.format.GeoJSON;d=this.getMap().getLayer("annotations").getSource().getFeatures();var e=[],f=this.getProjection();d.forEach(function(g){transformedFeature=g.clone();transformedFeature.getGeometry().transform(f?f:"EPSG:3857","EPSG:3857");e.push(transformedFeature)});c=c.writeFeatures(e);this.storeAnnotations(c)}}})},
storeAnnotations:function(a){this.mask("storingAnnotations");var b=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:JSON.stringify(a)},scope:this}).then(function(c){b.unmask();c=Ext.JSON.decode(c.responseText);b.setApiParam("annotationsId",c.storedResource.id);b.toastInfo(b.localize("annotationsUpdated"))},function(c){b.unmask();b.showResponseError(b.localize("annotationsUpdateFailed"),c)})},travelStyleFunction:function(a,b){var c=new ol.style.Stroke({color:a.get("color"),
width:a.get("width")}),d=[new ol.style.Style({stroke:c})],e=a.getGeometry();a=e.getLastCoordinate();e=e.getCoordinateAt(.9);e=Math.atan2(a[1]-e[1],a[0]-e[0]);var f=new ol.geom.LineString([a,[a[0]-10*b,a[1]+10*b]]);f.rotate(e,a);b=new ol.geom.LineString([a,[a[0]-10*b,a[1]-10*b]]);b.rotate(e,a);d.push(new ol.style.Style({geometry:f,stroke:c}));d.push(new ol.style.Style({geometry:b,stroke:c}));return d},cityStyleFunction:function(a,b){if(a.get("visible")){b=2*Math.PI*a.get("width");var c=a.get("confidence")?
b*a.get("confidence"):b;return new ol.style.Style({image:new ol.style.Circle({radius:a.get("width"),fill:new ol.style.Fill({color:a.get("color")}),stroke:new ol.style.Stroke({lineDash:[c,b-c],color:"rgb(255, 255, 255)",width:2})})})}return!1},animationStyleFunction:function(a){return[new ol.style.Style({stroke:new ol.style.Stroke({color:a.get("color"),width:5})}),new ol.style.Style({geometry:new ol.geom.Circle(a.getGeometry().getFirstCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})}),
new ol.style.Style({geometry:new ol.geom.Circle(a.getGeometry().getLastCoordinate()),stroke:new ol.style.Stroke({color:"white",width:10})})]},showTermInCorpus:function(a,b,c){a=Ext.create("Voyant.data.model.Context",{docIndex:a,position:b,term:c});this.getApplication().dispatchEvent("termLocationClicked",this,[a])},reloadFilters:function(){this.getFilterWidgets().each(function(a){a.loadGeonames()},this)},filterUpdate:function(a){var b=this;a.clearAnimation();var c=this.getMap(),d=a.getColor(),e=parseInt(this.getApiParam("citiesMaxCount")),
f=0;a.getGeonames().eachCity(function(q){q.rawFreq>f&&(f=q.rawFreq)},this,e);var g=c.getLayer(a.getId()+"-cities").getSource(),h=Ext.Array.from(this.getApiParam("hide"));g.clear();var k=parseInt(this.getApiParam("minPopulation")),l=parseInt(this.getApiParam("citiesMinFreq")),m={};a.getGeonames().eachCity(function(q){if((!k||q.population>=k)&&(!l||q.rawFreq>=l)){m[q.id]=!0;var p=[parseFloat(q.lng),parseFloat(q.lat)];q=new ol.Feature({geometry:(new ol.geom.Point(p)).transform(ol.proj.get("EPSG:4326"),
b.getProjection()?b.getProjection():ol.proj.get("EPSG:3857")),text:q.label+" ("+q.rawFreq+")",description:q.label,color:d,selected:!1,width:3+20*Math.sqrt(q.rawFreq/f),visible:!0,coordinates:p,forms:q.forms,cityId:q.id,type:"city",confidence:q.confidence?100*q.confidence:void 0});g.addFeature(q)}},this,e);0<g.getFeatures().length&&c.getView().fit(g.getExtent());c.getLayer(a.getId()+"-cities").setVisible(0==Ext.Array.contains(h,"cities"));g=c.getLayer(a.getId()+"-connections").getSource();g.clear();
0==Object.keys(m).length&&this.toastInfo("No cities available for current criteria.");f=0;a.getGeonames().eachConnection(function(q){q.rawFreq>f&&(f=q.rawFreq)},this);var n=0,r=parseInt(this.getApiParam("connectionsMaxCount")),u=parseInt(this.getApiParam("connectionsMinFreq"));a.getGeonames().eachConnection(function(q){if((!u||q.rawFreq>=u)&&(!r||n<r)&&q.source.id in m&&q.target.id in m&&(!k||q.source.population>=k&&q.target.population>=k)){var p=(new arc.GreatCircle({x:q.source.lng,y:q.source.lat},
{x:q.target.lng,y:q.target.lat})).Arc(100,{offset:100}),v=q.source.label+" -> "+q.target.label+" ("+q.rawFreq+")";p.geometries.forEach(function(w){w=new ol.geom.LineString(w.coords);w.transform(ol.proj.get("EPSG:4326"),b.getProjection()?b.getProjection():ol.proj.get("EPSG:3857"));w=new ol.Feature({geometry:w,text:v,color:d,width:3+10*Math.sqrt(q.rawFreq/f),source:q.source.id,target:q.target.id,type:"connection"});g.addFeature(w)},this);n++}},this);c.getLayer(a.getId()+"-connections").setVisible(0==
Ext.Array.contains(h,"connections"));a.animate()},handleSingleClick:function(a){var b=this.getMap().getFeaturesAtPixel(a.pixel);if(b)for(var c=0;c<b.length;c++){var d=b[c],e=d.get("type");if("city"==e){this.handleLocationClick(a,d);break}else if("connection"==e){this.handleConnectionClick(d,a.pixel[0],a.pixel[1]);break}else if("annotation"==e){this.editAnnotation(d);break}}},handleConnectionClick:function(a,b,c){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewConnections"),tooltip:this.localize("viewConnectionsTip"),
glyph:"xf02d@FontAwesome",handler:function(){this.mask("loadingConnections");var d=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:!0,suppressConnections:!0,sourceId:a.get("source"),targetId:a.get("target"),context:2,limit:25},scope:this}).then(function(e){d.unmask();if((e=Ext.JSON.decode(e.responseText))&&e.dreamscape&&e.dreamscape.connectionOccurrences){var f="<table style='font-size:smaller'>";e.dreamscape.connectionOccurrences.connectionOccurrences.forEach(function(g){f+=
"<tr><td style='text-align: right'>"+g.source.left+"</td><td class='keyword' style='text-align: center'>"+g.source.term+"</td><td>"+g.source.right+"</td><td>\u2026</td><td style='text-align: right'>"+g.target.left+"</td><td class='keyword' style='text-align: center'>"+g.target.term+"</td><td>"+g.target.right+"</td></tr>"});f+="</table>";Ext.Msg.alert(d.localize("occurrences"),f)}},function(e){d.unmask();return d.showError(d.localize("occurrencesNotLoaded"))})},scope:this}]}).showAt(b,c)},handleLocationClick:function(a,
b){var c=b.get("cityId");Ext.create("Ext.menu.Menu",{items:[{text:this.localize("viewOccurrences"),tooltip:this.localize("viewOccurrencesTip"),glyph:"xf02d@FontAwesome",handler:function(){this.mask("loadingOccurrences");var d=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.Dreamscape",corpus:this.getCorpus().getId(),suppressLocations:!0,suppressConnections:!0,suppressConnectionOccurrences:!0,locationId:c,limit:25},scope:this}).then(function(e){d.unmask();if((e=Ext.JSON.decode(e.responseText))&&
e.dreamscape&&e.dreamscape.occurrences){var f="<table style='font-size:smaller'>";e.dreamscape.occurrences.occurrences.forEach(function(g){f+="<tr><td style='text-align: right'>"+g.left+"</td><td class='keyword' style='text-align: center'>"+g.term+"</td><td>"+g.right+"</td></tr>"});f+="</table>";Ext.Msg.alert(d.localize("occurrences"),f)}},function(e){d.unmask();return d.showError(d.localize("occurrencesNotLoaded"))})},scope:this},{text:this.localize("openInVoyant"),tooltip:this.localize("openInVoyantTip"),
glyph:"xf08e@FontAwesome",handler:function(){this.dispatchEvent("termsClicked",this,b.get("forms"))},scope:this},{text:this.localize("editLocation"),tooltip:this.localize("editLocationTip"),glyph:"xf124@FontAwesome",handler:function(){this.mask("loadingAlternatives");var d=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"util.Geonames",query:b.get("forms")},scope:this}).then(function(e){d.unmask();if((e=Ext.JSON.decode(e.responseText))&&e.geonames&&e.geonames.locations){var f=[];Object.values(e.geonames.locations.locations).forEach(function(g){f.push({boxLabel:g.label+
" ("+g.population+")",name:"id",inputValue:g.id,checked:g.id==c})});if(0==f.length)return d.showError(d.localize("editLocationNoLocationsFound"));if(1==f.length&&f[0].inputValue==c)return d.showError(d.localize("editLocationNoAlternativesFound"));Ext.create("Ext.window.Window",{title:d.localize("editLocation"),modal:!0,items:{xtype:"form",items:[{xtype:"radiogroup",columns:1,vertical:!0,items:f}],listeners:{afterrender:function(g){},scope:this},buttons:[{text:d.localize("cancel"),ui:"default-toolbar",
glyph:"xf00d@FontAwesome",flex:1,handler:function(g){g.up("window").destroy()}},{text:d.localize("confirmTitle"),glyph:"xf00c@FontAwesome",flex:1,handler:function(g){var h=g.up("form").getValues().id;if(h&&h!=c){var k={};k[c]=h;d.appendOverrides(k)}g.up("window").destroy()}}]}}).show()}},function(e){d.unmask();d.showResponseError(d.localize("editLocationServerError"),e)})},scope:this},{text:this.localize("removeLocation"),tooltip:this.localize("removeLocationTip"),glyph:"xf00d@FontAwesome",handler:function(){Ext.Msg.confirm(this.localize("removeLocationConfirmTitle"),
this.localize("removeLocationConfirm"),function(d){"yes"==d&&(d={},d[c]="",this.appendOverrides(d))},this)},scope:this}],listeners:{focusleave:function(d){d.destroy()}}}).showAt(a.pixel[0],a.pixel[1])},appendOverrides:function(a,b){if(this.getApiParam("overridesId")&&!b){var c=this;Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("overridesId")},scope:this}).then(function(d){var e=Ext.JSON.decode(d.responseText);e&&e.storedResource&&
e.storedResource.resource?(d=Ext.decode(e.storedResource.resource),Ext.apply(d,a),c.appendOverrides(d,!0)):c.showResponseError(c.localize("overidesRetrieveError"),d)},function(d){c.showResponseError(c.localize("overidesRetrieveError"),d)})}else c=this,Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",storeResource:Ext.encode(a)},scope:this}).then(function(d){var e=Ext.JSON.decode(d.responseText);e&&e.storedResource&&e.storedResource.id?(c.setApiParam("overridesId",
e.storedResource.id),c.reloadFilters()):c.showResponseError(c.localize("overidesRetrieveError"),d)},function(d){c.showResponseError(c.localize("overidesStorageError"),d)})}});
Ext.define("Voyant.widget.GeonamesFilter",{extend:"Ext.Button",xtype:"geonamesfilter",mixins:["Voyant.util.Localization"],statics:{i18n:{filter:"Filter",authorLabel:"authors",titleLabel:"titles",keywordLabel:"full text",pubDateLabel:"dates",loading:"Loading geographical information\u2026",disclaimer:"This is an experimental tool and the accuracy of the data is variable (<a href='{url}' target='_blank'>see help</a>).",noDataForField:"No data seems to be available for this field so it will be disabled.",
close:"Close"}},config:{corpus:void 0,geonames:void 0,color:"#f00",timeout:void 0,currentConnectionOccurrence:void 0,animationLayer:void 0,millisPerAnimation:2E3,stepByStepMode:!1,keepAnimationInFrame:!1},constructor:function(a){a=a||{};var b=new Voyant.data.util.Geonames({corpus:a.corpus});this.setGeonames(b);var c=this;Ext.applyIf(a,{tooltip:this.localize("filterTip"),style:"background-color: white; color: "+a.color,glyph:"xf0b0@FontAwesome",menu:{defaults:{xtype:"querysearchfield",labelWidth:60,
labelAlign:"right",width:250,maxWidth:250,padding:2,listeners:{change:function(d,e){c.loadGeonames()},load:function(d,e,f,g){0==e.length&&""==g.getParams().query&&(Ext.Msg.show({buttonText:{ok:c.localize("close")},icon:Ext.MessageBox.INFO,message:c.localize("noDataForField"),buttons:Ext.Msg.OK}),this.disable())}}},items:[{fieldLabel:this.localize("authorLabel"),tokenType:"author",itemId:"author"},{fieldLabel:this.localize("titleLabel"),itemId:"title",tokenType:"title"},{fieldLabel:this.localize("keywordLabel")},
{xtype:"multislider",fieldLabel:this.localize("pubDateLabel"),itemId:"pubDate",tokenType:"pubDate",values:[0,1],hidden:!0,listeners:{afterrender:function(d){this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMASC"},callback:function(e){if(0==e.length){var f=[];this.getCorpus().each(function(g){var h=parseInt(g.getTitle());0==isNaN(h)&&f.push(parseInt(g.getTitle()))},this);1<f.length&&(d.setMinValue(f[0]),d.setMaxValue(f[f.length-1]),d.tokenType="title",d.suspendEvent("changecomplete"),
d.setValue([f[0],f[f.length-1]]),d.resumeEvent("changecomplete"),d.setVisible(!0))}else d.setMinValue(parseInt(e[0].getTerm())),this.getCorpus().getCorpusTerms().load({params:{tokenType:"pubDate",limit:1,sort:"TERMDESC"},callback:function(g){d.setMaxValue(parseInt(g[0].getTerm()));d.setVisible(!0)},scope:this})},scope:this})},changecomplete:function(d,e){this.loadGeonames()},scope:this}},{xtype:"fieldset",title:"Animation",items:[{xtype:"container",layout:"hbox",defaults:{xtype:"button",text:"",ui:"default-toolbar"},
items:[{glyph:"xf048@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();var d=this.getCurrentConnectionOccurrence();d=this.getGeonames().getConnectionOccurrence(d?d.index-1:0);this.setCurrentConnectionOccurrence(d);this.animate()},scope:this},{glyph:"xf04c@FontAwesome",handler:function(d){"xf04b@FontAwesome"==d.getGlyph().glyphConfig?(this.clearAnimation(),d.setGlyph(new Ext.Glyph("xf04c@FontAwesome")),this.setStepByStepMode(!1),this.animate()):(d.setGlyph(new Ext.Glyph("xf04b@FontAwesome")),
this.setStepByStepMode(!0))},scope:this},{glyph:"xf051@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();var d=this.getCurrentConnectionOccurrence();d=this.getGeonames().getConnectionOccurrence(d?d.index+1:0);this.setCurrentConnectionOccurrence(d);this.animate()},scope:this},{xtype:"tbtext",text:"&nbsp;&nbsp;"},{glyph:"xf01e@FontAwesome",handler:function(){this.getAnimationLayer().getSource().clear();this.clearAnimation();this.setCurrentConnectionOccurrence(this.getGeonames().getConnectionOccurrence(0));
this.animate()},scope:this}]},{xtype:"checkbox",checked:!1,handler:function(d,e){c.setKeepAnimationInFrame(e)},boxLabel:"Keep animation in frame"}]},{xtype:"container",text:"&nbsp;"},{xtype:"button",text:"remove",scope:this,handler:function(d){this.fireEvent("removeFilterWidget",this);d.ownerCt.ownerCmp.destroy()}}]}});this.callParent([a]);this.on("afterrender",function(d){d.getTargetEl().down(".x-btn-glyph").setStyle("color",this.getColor());var e=d.up("panel");e.mask(d.localize("loading"));d.loadGeonames().then(function(f){e.unmask();
if(1==e.getFilterWidgets().getCount()){var g=f.getCitiesCount(),h=f.getTotalCitiesCount(),k=f.getConnectionsCount();f=f.getTotalConnectionsCount();message=d.localize(g==h&&k==f?"loadedAll":"loadedSome")+"<br><br>"+d.localize("disclaimer");e.toastInfo({autoCloseDelay:5E3,closable:!0,maxWidth:"90%",html:(new Ext.Template(d.localize("disclaimer"))).apply({currentCitiesCount:g,totalCitiesCount:h,currentConnectionsCount:k,totalConnectionsCount:f,url:e.getBaseUrl()+"docs/#!/guide/dreamscape"})})}})},this)},
loadGeonames:function(a){var b=this;a=a||{};var c=[];this.query("querysearchfield").forEach(function(g){var h=g.getItemId();g.getValue().forEach(function(k){c.push(h+":"+k)})});var d=this.down("multislider");if(d&&d.isVisible()){var e=d.getValue();c.push(d.tokenType+":["+e[0]+"-"+e[1]+"]")}0<c.length&&!("query"in a)&&(a.query=c);(d=this.up("panel"))&&d.getApiParams&&Ext.applyIf(a,d.getApiParams("minPopulation connectionsMaxCount connectionsMinFreq source overridesId filterHasLowerCaseForm filterIsPersonName preferredCoordinates".split(" ")));
this.mask("\u2026");var f=this.getGeonames();return f.load(a).then(function(){b.unmask();b.fireEvent("filterUpdate",b,f);return f})},clearAnimation:function(){this.getTimeout()&&clearTimeout(this.getTimeout())},animate:function(){var a=this.up("panel");if(a){this.clearAnimation();var b=this.getCurrentConnectionOccurrence();if(b){var c=this.getAnimationLayer();c||(c=this.up("panel").getMap().getLayer(this.getId()+"-animation"),this.setAnimationLayer(c));if(c){var d=c.getSource().getFeatures();if(0==
d.length){if(!a)return;var e=a.getMap().getLayer(this.getId()+"-connections").getSource().getFeatures();d=!1;for(var f=0,g=e.length;f<g;f++)if(b.source.id==e[f].get("source")&&b.target.id==e[f].get("target")){d=e[f];break}if(d){this.getKeepAnimationInFrame()&&(g=a.getMap(),e=a.getMap().getView().calculateExtent(g.getSize()),ol.extent.containsExtent(e,d.getGeometry().getExtent())||(newExtent=ol.extent.extend(e,d.getGeometry().getExtent()),g.getView().fit(newExtent)));d=(new arc.GreatCircle({x:b.source.lng,
y:b.source.lat},{x:b.target.lng,y:b.target.lat})).Arc(100,{offset:100});var h=b.source.label+" -> "+b.target.label;d.geometries.forEach(function(k){var l=new ol.geom.LineString([]);l.transform(ol.proj.get("EPSG:4326"),a.getProjection()?a.getProjection():ol.proj.get("EPSG:3857"));k=new ol.Feature({geometry:l,allcoords:k.coords,text:h,color:this.getColor(),width:5,start:(new Date).getTime()});c.getSource().addFeature(k)},this);a.body.down(".ticker");a.body.down(".ticker").setHtml(b.source.left+" <span class='keyword'>"+
b.source.term+"</span> "+b.source.right+" \u2026 "+b.target.left+" <span class='keyword'>"+b.target.term+"</span> "+b.target.right)}else{if(!this.getGeonames())return;b=this.getGeonames().getConnectionOccurrence(b.index+1);this.setCurrentConnectionOccurrence(b);c.getSource().clear()}return this.setTimeout(setTimeout(this.animate.bind(this),1))}if(0<d.length){g=d[0].getGeometry().getCoordinates();e=d[0].get("allcoords");if(g.length<e.length)return g=((new Date).getTime()-d[0].get("start"))*e.length/
this.getMillisPerAnimation(),line=new ol.geom.LineString(e.slice(0,g)),line.transform(ol.proj.get("EPSG:4326"),a.getProjection()?a.getProjection():ol.proj.get("EPSG:3857")),d[0].set("geometry",line),this.setTimeout(setTimeout(this.animate.bind(this),25));b=this.getGeonames().getConnectionOccurrence(b.index+1);if(!this.getStepByStepMode())return this.setCurrentConnectionOccurrence(b),c.getSource().clear(),this.setTimeout(setTimeout(this.animate.bind(this),1))}}}else if(this.getGeonames()&&(b=this.getGeonames().getConnectionOccurrence(0)))return this.setCurrentConnectionOccurrence(b),
this.setTimeout(setTimeout(this.animate.bind(this),1))}}});Ext.define("Voyant.panel.Knots",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.knots",statics:{i18n:{},api:{query:null,stopList:"auto",docId:void 0,audio:!1},glyph:"xf06e@FontAwesome"},config:{knots:void 0,termStore:void 0,docTermStore:void 0,tokensStore:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"colorpaletteoption"}],refreshInterval:100,startAngle:315,angleIncrement:15,currentTerm:void 0},termTpl:new Ext.XTemplate('<tpl for=".">','<div class="term" style="color: rgb({color});float: left;padding: 3px;margin: 2px;">{term}</div>',
"</tpl>"),constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){a=b.getDocument(0);var c=this.processDocument(a);this.getKnots().setCurrentDoc(c);this.setApiParams({docId:a.getId()});this.getDocTermStore().getProxy().setExtraParam("corpus",b.getId());this.getTokensStore().setCorpus(b);this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},this);this.on("activate",function(){this.getCorpus()&&
Ext.Function.defer(function(){this.getDocTermStore().load({params:{limit:5,stopList:this.getApiParams("stopList")}})},100,this)},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.getDocTermsFromQuery(b)},this);this.on("documentSelected",function(a,b){a=this.getCorpus().getDocument(b);this.setApiParam("docId",a.getId());var c=this.getKnots().currentDoc.terms;b=[];for(var d in c)b.push(d);this.setApiParams({query:b});d=b.length;0===d&&(d=5);this.getKnots().setCurrentDoc(this.processDocument(a));
this.getDocTermStore().load({params:{query:b,limit:d,stopList:this.getApiParams("stopList")}})},this);this.on("termsClicked",function(a,b){var c=[];b.forEach(function(d){Ext.isString(d)?c.push(d):d.term?c.push(d.term):d.getTerm&&c.push(d.getTerm())});0<c.length&&this.getDocTermsFromQuery(c)},this);this.on("corpusTermsClicked",function(a,b){var c=[];b.forEach(function(d){d.getTerm()&&c.push(d.getTerm())});this.getDocTermsFromQuery(c)},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(d){d.getTerm()&&
c.push(d.getTerm())});this.getDocTermsFromQuery(c)},this)},initComponent:function(){this.setTermStore(Ext.create("Ext.data.ArrayStore",{fields:["term","color"]}));this.setDocTermStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:"raw",withPositions:!0},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},
simpleSortMode:!0},listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",this.getApiParam("docId"))},load:function(a,b,c,d){var e={};b&&0<b.length?(b.forEach(function(f){var g=this.processTerms(f);f.get("docId");f=f.get("term");e[f]=g},this),this.getKnots().addTerms(e),this.getKnots().buildGraph()):this.toastInfo({html:this.localize("noTermsFound"),align:"bl"})},scope:this}}));this.setTokensStore(Ext.create("Voyant.data.store.Tokens",{stripTags:"all",listeners:{beforeload:function(a){a.getProxy().setExtraParam("docId",
this.getApiParam("docId"))},load:function(a,b,c,d){var e="",f=this.getCurrentTerm();b.forEach(function(g){e=g.getPosition()==f.tokenId?e+("<strong>"+g.getTerm()+"</strong>"):e+g.getTerm()});Ext.Msg.show({title:this.localize("context"),message:e,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},scope:this}}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{text:this.localize("clearTerms"),glyph:"xf00d@FontAwesome",
handler:function(){this.down("#termsView").getSelectionModel().deselectAll(!0);this.getTermStore().removeAll();this.setApiParams({query:null});this.getKnots().removeAllTerms();this.getKnots().drawGraph()},scope:this},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",itemId:"speed",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:50,width:100,increment:50,minValue:0,maxValue:500,value:500-this.getRefreshInterval(),listeners:{changecomplete:function(a,b){this.setRefreshInterval(500-
b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"startAngle",fieldLabel:this.localize("startAngle"),labelAlign:"right",labelWidth:35,width:85,increment:15,minValue:0,maxValue:360,value:this.getStartAngle(),listeners:{changecomplete:function(a,b){this.setStartAngle(b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"slider",itemId:"tangles",fieldLabel:this.localize("tangles"),labelAlign:"right",labelWidth:30,width:80,increment:5,minValue:5,maxValue:90,
value:this.getAngleIncrement(),listeners:{changecomplete:function(a,b){this.setAngleIncrement(b);this.getKnots()&&this.getKnots().buildGraph()},scope:this}},{xtype:"checkbox",boxLabel:this.localize("sound"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("audio")||"true"==this.getApiParam("audio"));Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("soundTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.getKnots()&&
this.getKnots().setAudio(b)},scope:this}}]}],border:!1,layout:"fit",items:{layout:{type:"vbox",align:"stretch"},defaults:{border:!1},items:[{height:30,itemId:"termsView",xtype:"dataview",store:this.getTermStore(),tpl:this.termTpl,itemSelector:"div.term",overItemCls:"over",selectedItemCls:"selected",selectionModel:{mode:"SIMPLE"},focusCls:"",listeners:{beforeitemclick:function(a,b,c,d,e,f){e.preventDefault();e.stopPropagation();a.fireEvent("itemcontextmenu",a,b,c,d,e,f);return!1},beforecontainerclick:function(){event.preventDefault();
event.stopPropagation();return!1},selectionchange:function(a,b){var c=this.down("#termsView"),d=[];c.getStore().each(function(e){-1!==b.indexOf(e)?(d.push(e.get("term")),Ext.fly(c.getNodeByRecord(e)).removeCls("unselected").addCls("selected")):Ext.fly(c.getNodeByRecord(e)).removeCls("selected").addCls("unselected")});this.getKnots().termsFilter=d;this.getKnots().drawGraph()},itemcontextmenu:function(a,b,c,d,e){e.preventDefault();e.stopPropagation();var f=a.isSelected(c);(new Ext.menu.Menu({floating:!0,
items:[{text:f?this.localize("hideTerm"):this.localize("showTerm"),handler:function(){f?a.deselect(d):a.select(d,!0)},scope:this},{text:this.localize("removeTerm"),handler:function(){a.deselect(d);var g=this.getTermStore().getAt(d).get("term");this.getTermStore().removeAt(d);a.refresh();this.getKnots().removeTerm(g);this.getKnots().drawGraph()},scope:this}]})).showAt(e.getXY())},scope:this}},{flex:1,xtype:"container",autoEl:"div",itemId:"canvasParent",layout:"fit",overflowY:"auto",overflowX:"hidden"}],
listeners:{render:function(a){a=this.down("#canvasParent");this.setKnots(new Knots({container:a,clickHandler:this.knotClickHandler.bind(this),audio:!0===this.getApiParam("audio")||"true"==this.getApiParam("audio")}))},afterlayout:function(a){!1===this.getKnots().initialized&&this.getKnots().initializeCanvas()},resize:function(a,b,c){this.getKnots().doLayout()},scope:this}}});this.callParent(arguments)},updateRefreshInterval:function(a){this.getKnots()&&(50>a?(a=50,this.getKnots().progressiveDraw=
!1):this.getKnots().progressiveDraw=!0,this.getKnots().refreshInterval=a,this.getKnots().buildGraph(this.getKnots().drawStep))},updateStartAngle:function(a){this.getKnots()&&(this.getKnots().startAngle=a,this.getKnots().recache(),this.getKnots().buildGraph())},updateAngleIncrement:function(a){this.getKnots()&&(this.getKnots().angleIncrement=a,this.getKnots().recache(),this.getKnots().buildGraph())},loadFromCorpusTerms:function(a){this.getKnots()&&(this.getKnots().removeAllTerms(),this.getTermStore().removeAll(!0));
a.load({callback:function(b,c,d){var e=[];"string"==typeof e&&(e=[e]);b.forEach(function(f,g){e.push(f.get("term"))},this);this.getDocTermsFromQuery(e)},scope:this,params:{limit:5,stopList:this.getApiParams("stopList")}})},getDocTermsFromQuery:function(a){a&&this.setApiParam("query",a);this.getCorpus()&&this.isVisible()&&(this.setApiParams({query:a}),this.getDocTermStore().load({params:this.getApiParams()}))},reloadTermsData:function(){var a=[],b;for(b in this.bubblelines.currentTerms)a.push(b);this.getDocTermsFromQuery(a)},
filterDocuments:function(){var a=this.getApiParam("docId");""==a&&(a=[],this.getCorpus().getDocuments().each(function(d,e){a.push(d.getId())}),this.setApiParams({docId:a}));"string"==typeof a&&(a=[a]);if(null==a){this.selectedDocs=this.getCorpus().getDocuments().clone();var b=this.selectedDocs.getCount();if(10<b)for(var c=10;c<b;c++)this.selectedDocs.removeAt(10);a=[];this.selectedDocs.eachKey(function(d,e){a.push(d)},this);this.setApiParams({docId:a})}else this.selectedDocs=this.getCorpus().getDocuments().filterBy(function(d,
e){return-1!=a.indexOf(e)},this)},processDocument:function(a){var b=a.getShortTitle();b=b.replace("&hellip;","...");return{id:a.getId(),index:a.get("index"),title:b,totalTokens:a.get("tokensCount-lexical"),terms:{},lineLength:void 0}},processTerms:function(a){var b=a.get("term");var c=a.get("rawFreq"),d=a.get("positions");if(0<c){var e=this.getApplication().getColorForTerm(b);if(-1===this.getTermStore().find("term",b)){this.getTermStore().loadData([[b,e]],!0);var f=this.getTermStore().find("term",
b);this.down("#termsView").select(f,!0)}a=a.get("distributions");b={term:b,positions:d,distributions:a,rawFreq:c,color:e}}else b=!1;return b},knotClickHandler:function(a){this.setCurrentTerm(a);var b=a.tokenId-10;0>b&&(b=0);this.getTokensStore().load({start:b,limit:21});a=[a].map(function(c){return c.term});this.getApplication().dispatchEvent("termsClicked",this,a)}});Ext.define("Voyant.panel.Phrases",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.phrases",isConsumptive:!0,statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,sort:"length",dir:"desc",minLength:2,maxLength:50,overlapFilter:"length"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",
function(b,c){this.isVisible()&&(0==this.hasCorpusAccess(c)?this.mask(this.localize("limitedAccess"),"mask-no-spinner"):this.loadFromApis())});a.embedded||a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("corpusTermsClicked",function(b,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(e){d.push(e.get("term"))});this.setApiParams({query:d,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("activate",function(){this.getStore().getCorpus()&&
this.loadFromApis()},this);this.on("query",function(b,c){this.setApiParam("query",c);this.getStore().getProxy().setExtraParam("query",c);this.loadFromApis()},this)},loadFromApis:function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusNgramsBuffered",{parentPanel:a});b.on("beforeload",function(c){return a.hasCorpusAccess(c.getCorpus())});a.on("sortchange",function(c,d,e,f){this.setApiParam("sort",
d.dataIndex);this.setApiParam("dir",e);c=this.getApiParams("stopList query docId docIndex sort dir minLength maxLength overlapFilter".split(" "));d=this.getStore().getProxy();for(var g in c)d.setExtraParam(g,c[g])},a);Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(c,d){var e=[];this.getApiParam("context");d.forEach(function(f){e.push('"'+f.getTerm()+'"')});this.getApplication().dispatchEvent("termsClicked",
this,e)},scope:this}}}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"},"-",{text:a.localize("length"),tooltip:"test",xtype:"label"},{xtype:"slider",minValue:2,values:[2,30],maxValue:30,increment:1,width:75,tooltip:this.localize("lengthTip"),listeners:{render:{fn:function(c){var d=c.getValues();c.setValue(0,parseInt(this.getApiParam("minLength",d[0])));c.setValue(1,parseInt(this.getApiParam("maxLength",d[1])))},
scope:a},changecomplete:{fn:function(c,d){c=c.getValues();this.setApiParam("minLength",parseInt(c[0]));this.setApiParam("maxLength",parseInt(c[1]));this.getStore().load({params:this.getApiParams()})},scope:a}}},{xtype:"corpusdocumentselector"},"-",{xtype:"button",text:this.localize("overlap"),tooltip:this.localize("overlapTip"),menu:{items:[{xtype:"menucheckitem",text:this.localize("overlapNone"),group:"overlap",inputValue:"none",checkHandler:function(){this.setApiParam("overlapFilter","none");this.getStore().load({params:this.getApiParams()})},
scope:this},{xtype:"menucheckitem",text:this.localize("overlapLength"),group:"overlap",inputValue:"length",checkHandler:function(){this.setApiParam("overlapFilter","length");this.getStore().load({params:this.getApiParams()})},scope:this},{xtype:"menucheckitem",text:this.localize("overlapFreq"),group:"overlap",inputValue:"rawFreq",checkHandler:function(){this.setApiParam("overlapFilter","rawfreq");this.getStore().load({params:this.getApiParams()})},scope:this}],listeners:{afterrender:{fn:function(c){var d=
this.getApiParam("overlapFilter");c.items.each(function(e){e.group&&e.setChecked(e.inputValue==d)},this)},scope:this}}}}]}],columns:[{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("termRawFreqTip"),sortable:!0,width:"autoSize"},{text:this.localize("length"),dataIndex:"length",tooltip:this.localize("lengthTip"),sortable:!0,width:"autoSize"},{xtype:"widgetcolumn",text:this.localize("trend"),
tooltip:this.localize("trendTip"),width:120,dataIndex:"distributions",widget:{xtype:"sparklineline"}}],listeners:{corpusSelected:function(){this.setApiParams({docIndex:void 0,docId:void 0});this.loadFromApis()},documentsSelected:function(c,d){var e=[],f=this.getStore().getCorpus();d.forEach(function(g){e.push(f.getDocument(g).getId())},this);this.setApiParams({docId:e,docIndex:void 0});this.loadFromApis()},termsClicked:{fn:function(c,d){if(this.getStore().getCorpus()){var e=[];d.forEach(function(f){Ext.isString(f)?
e.push(f):f.term?e.push(f.term):f.getTerm&&e.push(f.getTerm())});0<e.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:e}),this.isVisible()&&this.isVisible()&&this.getStore().clearAndLoad({params:this.getApiParams()}))}},scope:this}}});a.callParent(arguments);a.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.CorpusTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.corpusterms",statics:{i18n:{},api:{stopList:"auto",query:void 0,maxBins:100,comparisonCorpus:void 0},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{xtype:"corpusselector",name:"comparisonCorpus",fieldLabel:"comparison corpus"}]},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){var a=this,b=Ext.create("Voyant.data.store.CorpusTermsBuffered",{parentPanel:this,proxy:{extraParams:{withDistributions:"relative",forTool:"corpusterms"}}});Ext.apply(a,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:b,selModel:Ext.create("Ext.selection.CheckboxModel",{pruneRemoved:!1,listeners:{selectionchange:{fn:function(c,d){d&&0<d.length&&this.getApplication().dispatchEvent("corpusTermsClicked",
this,d)},scope:this}},mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}]}],plugins:[{ptype:"rowexpander",rowBodyTpl:new Ext.XTemplate("")}],viewConfig:{listeners:{expandbody:function(c,d,e,f){(""===e.textContent||f&&f.force)&&Ext.create("Voyant.widget.CorpusTermSummary",{record:d,header:!1,renderTo:e.querySelector("div")})},scope:this}},columns:[{xtype:"rownumberer",width:"autoSize",sortable:!1},{text:this.localize("term"),
tooltip:this.localize("termTip"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),tooltip:this.localize("rawFreqTip"),dataIndex:"rawFreq",width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",renderer:function(c){return Ext.util.Format.number(1E6*c,"0,000")},width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativePeakedness"),tooltip:this.localize("relativePeakednessTip"),dataIndex:"relativePeakedness",
renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("relativeSkewness"),tooltip:this.localize("relativeSkewnessTip"),dataIndex:"relativeSkewness",renderer:Ext.util.Format.numberRenderer("0,000.0"),width:"autoSize",hidden:!0,sortable:!0},{text:this.localize("corpusComparisonDifference"),tooltip:this.localize("corpusComparisonDifferenceTip"),dataIndex:"comparisonRelativeFreqDifference",renderer:Ext.util.Format.numberRenderer("0,000.00000"),
width:"autoSize",hidden:!this.getApiParam("comparisonCorpus"),sortable:!0,listeners:{show:function(c,d,e){a.getApiParam("comparisonCorpus")||a.showError(a.localize("noCorpusComparison"))}}},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",widget:{xtype:"sparklineline",tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(c,d){return this.panel.store.getCorpus().getDocument(c).getTitle()+
"<br>"+this.panel.localize("relativeFreqLabel")+" "+Ext.util.Format.number(1E6*d,"0,000")},panel:a})}}]});a.on("loadedCorpus",function(c,d){100<d.getDocumentsCount()&&this.getStore().getProxy().setExtraParam("bins",this.getApiParam("maxBins"));this.isVisible()&&this.getStore().load()},a);a.on("activate",function(){a.getStore().getCorpus()&&a.getStore().load({params:this.getApiParams()})},a);a.on("query",function(c,d){this.setApiParam("query",d);this.getStore().removeAll();this.getStore().load()},
a);a.callParent(arguments)}});Ext.define("Voyant.panel.DocumentTerms",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.DocumentTerms"],alias:"widget.documentterms",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},statics:{i18n:{},api:{stopList:"auto",query:void 0,docId:void 0,docIndex:void 0,bins:10},glyph:"xf0ce@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(c,
d){c=this.getStore();c.setCorpus(d);this.isVisible()&&c.load()});if(a.embedded){window.console&&console.warn(a.embedded.then);var b=Ext.getClass(a.embedded).getName();"Voyant.data.store.DocumentTerms"!=b&&"Voyant.data.model.Document"!=b||this.fireEvent("loadedCorpus",this,a.embedded.getCorpus())}else a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("query",function(c,d){this.fireEvent("corpusTermsClicked",c,d)},this);this.on("corpusTermsClicked",function(c,d){if(this.getStore().getCorpus()){var e=
[];d.forEach(function(f){e.push(Ext.isString(f)?f:f.get("term"))});this.setApiParams({query:e,docId:void 0,docIndex:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})}});this.on("documentsClicked",function(c,d){var e=[];d.forEach(function(f){e.push(f.get("id"))});this.setApiParams({docId:e,query:void 0});this.isVisible()&&this.getStore().load({params:this.getApiParams()})});this.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},
this)},initComponent:function(){var a=Ext.create("Voyant.data.store.DocumentTermsBuffered",{parentPanel:this});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),store:a,selModel:Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:{fn:function(b,c){this.getApplication().dispatchEvent("documentTermsClicked",this,c)},scope:this}},pruneRemoved:!1,mode:"SIMPLE"}),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},
{xtype:"totalpropertystatus"},{xtype:"corpusdocumentselector"}]}],columns:[{text:"#",width:30,dataIndex:"docIndex",sortable:!0,renderer:function(b){return b+1}},{text:this.localize("term"),dataIndex:"term",tooltip:this.localize("termTip"),sortable:!0,flex:1},{text:this.localize("rawFreq"),dataIndex:"rawFreq",tooltip:this.localize("rawFreqTip"),width:"autoSize",sortable:!0},{text:this.localize("relativeFreq"),tooltip:this.localize("relativeFreqTip"),dataIndex:"relativeFreq",width:"autoSize",sortable:!0,
renderer:Ext.util.Format.numberRenderer("0,000")},{text:this.localize("tfidf"),tooltip:this.localize("tfidfTip"),dataIndex:"tfidf",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{text:this.localize("zscore"),tooltip:this.localize("zscoreTip"),dataIndex:"zscore",width:"autoSize",sortable:!0,hidden:!0,renderer:Ext.util.Format.numberRenderer("0,000.000")},{xtype:"widgetcolumn",text:this.localize("trend"),tooltip:this.localize("trendTip"),flex:1,dataIndex:"distributions",
widget:{xtype:"sparklineline"}}],listeners:{termsClicked:{fn:function(b,c){if(this.getStore().getCorpus()){var d=[];c.forEach(function(e){Ext.isString(e)?d.push(e):e.term?d.push(e.term):e.getTerm&&d.push(e.getTerm())});0<d.length&&(this.setApiParams({docIndex:void 0,docId:void 0,query:d}),this.isVisible()&&this.isVisible()&&this.getStore().load({params:this.getApiParams()}))}},scope:this}}});this.callParent(arguments);this.getStore().getProxy().setExtraParam("withDistributions",!0)}});Ext.define("Voyant.panel.Documents",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.documents",isConsumptive:!0,statics:{i18n:{},api:{query:void 0,docIndex:void 0,docId:void 0},glyph:"xf0ce@FontAwesome"},MODE_EDITING:"editing",MODE_NORMAL:"normal",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:this.MODE_NORMAL},constructor:function(a){var b=Ext.create("Voyant.data.store.Documents",{selModel:{pruneRemoved:!1},proxy:{extraParams:{forTool:"documents"}}}),
c=[{xtype:"querysearchfield"},{xtype:"totalpropertystatus"}],d=this;a&&a.mode==this.MODE_EDITING||c.push({text:this.localize("modify"),tooltip:this.localize("modifyTip"),glyph:"xf044@FontAwesome",scope:this,itemId:"modifyButton",handler:function(e){Ext.create("Ext.window.Window",{title:this.localize("title"),modal:!0,width:"80%",minWidth:300,minHeight:200,height:"80%",layout:"fit",frame:!0,border:!0,items:{xtype:"documents",mode:this.MODE_EDITING,corpus:this.getStore().getCorpus(),header:!1,viewConfig:{plugins:{ptype:"gridviewdragdrop"},
listeners:{beforedrop:function(f,g,h,k,l){return this.getStore().getCount()<this.getStore().getCorpus().getDocumentsCount()?(f=this.up("panel"),Ext.Msg.show({title:f.localize("error"),message:f.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),!1):!0}}}},buttons:[{text:this.localize("add"),tooltip:this.localize("addTip"),glyph:"xf067@FontAwesome",handler:function(f){f.up("window").close();Ext.create("Ext.window.Window",{header:!1,modal:!0,layout:"fit",items:{xtype:"corpuscreator",
corpus:this.getStore().getCorpus()}}).show()},scope:this},{text:this.localize("remove"),tooltip:this.localize("removeTip"),glyph:"xf05e@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"remove",scope:this},{text:this.localize("keep"),tooltip:this.localize("keepTip"),glyph:"xf00c@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"keep",scope:this},{text:this.localize("reorder"),
tooltip:this.localize("reorderTip"),glyph:"xf0dc@FontAwesome",hidden:1==this.getStore().getCorpus().getDocumentsCount(),handler:this.keepRemoveReorderHandler,itemId:"reorder",scope:this},{text:"Cancel",glyph:"xf00d@FontAwesome",handler:function(f){f.up("window").close()}}]}).show()}},{text:this.localize("downloadButton"),glyph:"xf019@FontAwesome",itemId:"downloadButton",handler:function(){d.downloadFromCorpusId(d.getStore().getCorpus().getId())}});Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),
columns:[{xtype:"rownumberer",renderer:function(e,f,g){return g.getIndex()+1},sortable:!1},{text:this.localize("documentTitle"),dataIndex:"title",sortable:!0,renderer:function(e,f,g){return g.getTitle()},flex:3},{text:this.localize("documentAuthor"),dataIndex:"author",sortable:!0,hidden:!0,renderer:function(e,f,g){return g.getAuthor()},flex:2},{text:this.localize("documentPubDate"),dataIndex:"pubDate",sortable:!0,hidden:!0,renderer:function(e,f,g){return g.getPubDate()},flex:2},{text:this.localize("documentPublisher"),
dataIndex:"publisher",sortable:!1,hidden:!0,renderer:function(e,f,g){return g.getPublisher()},flex:2},{text:this.localize("documentPubPlace"),dataIndex:"pubPlace",sortable:!1,hidden:!0,renderer:function(e,f,g){return g.getPubPlace()},flex:2},{text:this.localize("documentKeyword"),dataIndex:"keyword",sortable:!1,hidden:!0,renderer:function(e,f,g){return g.getKeyword()},flex:2},{text:this.localize("documentCollection"),dataIndex:"collection",sortable:!1,hidden:!0,renderer:function(e,f,g){return g.getCollection()},
flex:2},{text:this.localize("tokensCountLexical"),dataIndex:"tokensCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),sortable:!0,width:"autoSize"},{text:this.localize("typesCountLexical"),dataIndex:"typesCount-lexical",renderer:Ext.util.Format.numberRenderer("0,000"),width:"autoSize"},{text:this.localize("typeTokenRatioLexical"),dataIndex:"typeTokenRatio-lexical",renderer:function(e){return Ext.util.Format.percent(e)},width:"autoSize"},{text:this.localize("averageWordsPerSentence"),
dataIndex:"averageWordsPerSentence",renderer:Ext.util.Format.numberRenderer("0,000.0"),tooltip:this.localize("averageWordsPerSentenceTip"),width:"autoSize"},{text:this.localize("language"),dataIndex:"language",hidden:!0,renderer:function(e,f,g,h,k,l,m){return m.ownerCt.getLanguage(e)},width:"autoSize"}],store:b,selModel:{type:"rowmodel",mode:"MULTI",listeners:{selectionchange:{fn:function(e,f){this.getApplication().dispatchEvent("documentsClicked",this,f,this.getStore().getCorpus())},scope:this}}},
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:c}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(e,f){this.store.setCorpus(f);if(this.isVisible())this.store.load({params:this.getApiParams()});else this.on("afterrender",function(){this.store.load({params:this.getApiParams()})},this);0==this.hasCorpusAccess(f)&&(this.queryById("modifyButton").hide(),this.queryById("downloadButton").hide())});
this.on("activate",function(){this.getStore().getCorpus()&&this.getStore().load({params:this.getApiParams()})},this);this.on("query",function(e,f){this.setApiParam("query",f);this.store.load({params:this.getApiParams()})});a.embedded&&("Voyant.data.model.Corpus"==Ext.getClass(a.embedded).getName()?a.corpus=a.embedded:"Voyant.data.store.Documents"==Ext.getClass(a.embedded).getName()&&(this.store.setRecords(a.embedded.getData()),a.corpus=a.embedded.getCorpus()));a.corpus&&this.fireEvent("loadedCorpus",
this,a.corpus)},keepRemoveReorderHandler:function(a){var b=a.up("window").down("documents"),c=b.getSelection(),d=b.getStore().getCorpus().getDocumentsCount(),e=a.getItemId();if("reorder"==e){if(b.getStore().getCount()<d)return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderFilteredError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR});docIndex=[];b.getStore().each(function(f){docIndex.push(f.getIndex())},this);for(a=1;a<docIndex.length;a++)if(docIndex[a-1]>docIndex[a])return Ext.Msg.confirm(b.localize("newCorpus"),
(new Ext.Template(b.localize(e+"Documents"))).applyTemplate([c.length]),function(f){"yes"===f&&(docIndex=[],this.getStore().each(function(g){docIndex.push(g.getIndex())},this),f={docIndex:docIndex},f[e+"Documents"]=!0,this.editCorpus(f))},b);return Ext.Msg.show({title:this.localize("error"),message:this.localize("reorderOriginalError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}return 0<c.length?c.length==d?1==d?Ext.Msg.show({title:this.localize("error"),message:this.localize("onlyOneError"),buttons:Ext.Msg.OK,
icon:Ext.Msg.ERROR}):Ext.Msg.show({title:this.localize("error"),message:this.localize("allSelectedError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}):Ext.Msg.confirm(this.localize("newCorpus"),(new Ext.Template(this.localize(e+"SelectedDocuments"))).applyTemplate([c.length]),function(f){"yes"===f&&(docIndex=[],c.forEach(function(g){docIndex.push(g.getIndex())}),f={docIndex:docIndex},f[e+"Documents"]=!0,this.editCorpus(f))},b):b.getApiParam("query")&&b.getStore().getCount()<d?Ext.Msg.confirm(this.localize("newCorpus"),
(new Ext.Template(this.localize(e+"FilteredDocuments"))).applyTemplate([c.length]),function(f){"yes"===f&&(docIndex=[],this.getStore().each(function(g){docIndex.push(g.getIndex())},this),f={docIndex:docIndex},f[e+"Documents"]=!0,this.editCorpus(f))},b):Ext.Msg.show({title:this.localize("error"),message:this.localize("selectOrFilterError"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})},editCorpus:function(a){Ext.apply(a,{tool:"corpus.CorpusManager",corpus:this.getStore().getCorpus().getId()});var b=this.getApplication(),
c=b.getViewport();c.mask(this.localize("Creating new corpus\u2026"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:a,success:function(d){c.unmask();d=Ext.decode(d.responseText);b.openUrl(b.getBaseUrl()+"?corpus="+d.corpus.id)}});(a=this.up("window"))&&a.isFloating()&&a.close()}});Ext.define("Voyant.panel.DocumentsFinder",{extend:"Ext.grid.Panel",require:["Voyant.data.store.DocumentQueryMatches","Ext.grid.plugin.CellEditing"],mixins:["Voyant.panel.Panel"],alias:"widget.documentsfinder",statics:{i18n:{}},config:{exportGridAll:!1},constructor:function(a){this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});this.cellEditing.on("edit",this.onEditComplete,this);var b=this;Ext.apply(this,{title:this.localize("title"),emptyText:this.localize("emptyText"),plugins:[this.cellEditing],
bbar:[{text:this.localize("addRow"),glyph:"xf055@FontAwesome",handler:this.addRow,scope:this},{text:this.localize("exportNewCorpus"),disabled:!0,glyph:"xf08e@FontAwesome",tooltip:this.localize("exportNewCorpusTip"),handler:function(){var c=this.getQueryFromStore();c?(this.setLoading(!0),this.getCorpus().getDocumentQueryMatches().load({params:{query:c,createNewCorpus:!0},callback:function(d,e,f){this.setLoading(!1);f?(d=e.getProxy().getReader().rawData.documentsFinder.corpus,d=this.getBaseUrl()+"?corpus="+
d,Ext.Msg.alert({title:this.localize("title"),message:"<a href='"+d+"' target='_blank'>New Corpus</a>"})):Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:e.getError().response}).show()},scope:this})):Ext.Msg.alert({title:this.localize("title"),message:this.localize("noMatches")})},scope:this,cls:"exportBtn"},{xtype:"tbtext",name:"status",cls:"status"}],columns:[{text:this.localize("query"),dataIndex:"query",renderer:function(c){return Ext.isEmpty(c)?'<span class="placeholder">'+
b.localize("emptyQuery")+"</span>":c},editor:!0,minWidth:150,maxWidth:300},{text:this.localize("field"),dataIndex:"field",editor:{xtype:"combo",typeAhead:!0,triggerAction:"all",forceSelection:!0,value:"",valueField:"value",listeners:{change:function(){Ext.isEmpty(this.getValue())&&this.reset()}},store:new Ext.data.Store({fields:["text","value"],data:[[this.localize("textField"),"text"],[this.localize("advancedField"),"advanced"]]})},width:150,renderer:function(c){return Ext.isEmpty(c)?"":b.localize(c+
"Field")}},{text:this.localize("operator"),dataIndex:"operator",editor:{xtype:"combo",forceSelection:!0,store:new Ext.data.Store({autoDestroy:!0,fields:["text","value"],displayField:"text",valueField:"value",data:[{text:"AND",value:"+"},{text:"OR",value:""}]})},minWidth:75,maxWidth:75},{text:this.localize("count"),dataIndex:"count",renderer:function(c,d,e){return Ext.isEmpty(e.get("query"))?"":Ext.util.Format.number(c,"0,000")},minWidth:100,maxWidth:100},{xtype:"actioncolumn",width:25,getGlyph:"xf014@FontAwesome",
tooltip:this.localize("deleteQueryTip"),menuDisabled:!0,sortable:!1,handler:this.removeRow,scope:this}],store:new Ext.data.Store({autoDestroy:!0,fields:["id","operator","field","query","count"],data:[["","","","",0]]})});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(c,d){if((c=d.getDocuments())&&0<c.getCount()){var e=c.getDocument(0),f=[];["title","author","pubDate","publisher","pubPlace"].forEach(function(g){Ext.isEmpty(e.get(g))||
f.push([this.localize(g+"Field"),g])},this);f&&(c=this.getColumnManager().getHeaderByDataIndex("field").getEditor(),c.getStore().each(function(g){f.push([g.get("text"),g.get("value")])},this),c.setStore(Ext.create("Ext.data.Store",{fields:["text","value"],data:f})));this.updateStatus(0);this.setLoading(!1)}})},removeRow:function(a,b){this.getStore().removeAt(b);0==this.getStore().getCount()&&this.addRow();this.updateAggregate()},addRow:function(){this.store.loadData([["","","","",0]],!0)},onEditComplete:function(a,
b){a=this.getQueryFromRecord(b.record);if(Ext.isEmpty(a))b.record.set("count",""),this.updateAggregate();else{var c=b.view.getCell(b.record,this.getColumnManager().getHeaderByDataIndex("count"));c.mask("loading");this.getCorpus().getDocumentQueryMatches().load({params:{query:a},callback:function(d,e,f){c.unmask();f?b.record.set("count",0==d.length?0:d[0].get("count")):(Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),response:e.getError().response}).show(),b.record.set("count",
0));this.updateAggregate()},scope:this})}},getQueryFromRecord:function(a){if(Ext.isEmpty(a)||Ext.isEmpty(a.get("query")))return"";var b=a.get("query").trim();if(Ext.isEmpty(b))return"";a=a.get("field");return Ext.isEmpty(a?a.trim():a)?b:a+":"+b},getQueryFromStore:function(){var a="";this.getStore().each(function(b){var c=this.getQueryFromRecord(b);Ext.isEmpty(c)||(Ext.isEmpty(a)||(b=b.get("operator"),a+="AND"==b?" + ":" | "),a+=c)},this);console.warn(a);return a},updateAggregate:function(){var a=
this.getStore().sum("count");a&&"string"!=typeof a?1==a?(a=this.getStore().getAt(0).get("count"),this.updateStatus(this.getStore().getAt(0).get("count"))):(a=this.getQueryFromStore(),Ext.isEmpty(a)||(this.status||(this.status=this.down("[cls~=status]")),this.status.mask(this.localize("loading")),this.getCorpus().getDocumentQueryMatches().load({params:{query:a},callback:function(b,c,d){this.status.unmask();d?this.updateStatus(b[0].get("count")):(Ext.create("Voyant.util.ResponseError",{msg:this.localize("unsuccessfulQuery"),
response:c.getError().response}).show(),this.updateStatus(0))},scope:this}))):this.updateStatus(0)},updateStatus:function(a){this.status||(this.status=this.down("[cls~=status]"));this.exportBtn||(this.exportBtn=this.down("[cls~=exportBtn]"));0==a?this.status.update((new Ext.XTemplate(this.localize("noMatches"))).apply([this.getCorpus().getDocumentsCount()])):this.status.update((new Ext.XTemplate(this.localize("queryMatches"))).apply([a,this.getCorpus().getDocumentsCount()]));this.exportBtn.setDisabled(0==
a)}});Ext.define("Voyant.panel.Embedder",{extend:"Ext.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.embedder",statics:{i18n:{title:"Embedded",url:"URL",go:"Go"},api:{url:void 0},glyph:"xf0c1@FontAwesome"},constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.setApiParam("url",a.url);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),layout:{type:"fit"},
items:{xtype:"uxiframe",src:this.getApiParam("url")},tbar:[{xtype:"textfield",value:this.getApiParam("url"),emptyText:this.localize("url"),listeners:{specialkey:function(a,b){b.getKey()==b.ENTER&&a.up("panel").down("uxiframe").load(a.getValue())}}},{xtype:"button",text:this.localize("go"),handler:function(a){var b=a.prev("textfield").getValue();a.up("panel").down("uxiframe").load(b)}}]});this.callParent()},loadUrl:function(a){this.down("uxiframe").load(a)}});Ext.define("Voyant.panel.Fountain",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.fountain",statics:{i18n:{title:"FountainMeter"},api:{stopList:"auto",docIndex:0,speed:30,groups:void 0},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],audio:!1,words:[],groups:{},moveWordsTimeout:void 0},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),
layout:{type:"hbox",align:"stretch"},items:[{html:"<svg></svg>",itemId:"fountain",flex:2},{flex:1,layout:"vbox",items:[{xtype:"polar",itemId:"gauge",width:300,flex:1,store:{fields:["mph","fuel","temp","rpm"],data:[{val:10}]},series:{type:"gauge",colors:this.getApplication().getColorPalette(this.getApplication().getApiParam("palette"),!0),angleField:"val",donut:20}},{width:300,height:16,items:{xtype:"sparklineline",itemId:"gaugsparkline",values:[0,1,2,34],height:16,width:300},listeners:{afterrender:function(a){a.getTargetEl().setStyle("cursor",
"pointer");a.getTargetEl().on("click",function(b,c,d){clearTimeout(this.getMoveWordsTimeout());this.getWords().forEach(function(e){e.svg&&(e.svg.remove(),delete e.svg);e.direction=-1});b=Math.floor(b.event.offsetX*this.getWords().length/c.offsetWidth);this.moveWords(b)},this)},scope:this}}]}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,
width:100,increment:1,minValue:1,maxValue:60,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));this.bubbles&&this.bubbles.frameRate(a.getValue());this.setAudio(a.getValue());Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},changecomplete:function(a,b){this.setApiParam("speed",b);this.bubbles&&this.bubbles.frameRate(b)},scope:this}}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(a,b){this.loadDocument()},this)},loadDocument:function(){var a=this,b=parseInt(this.getApiParam("docIndex"))||0;this.getCorpus().getWordsArray({docIndex:b,stopList:"auto"}).then(function(c){var d=c.map(function(m){return m.toLowerCase()});if(void 0==a.getApiParam("groups")){var e={};d.forEach(function(m){5<m.length&&!(m in e)&&(e[m]=m.length)});d=Math.max.apply(this,Object.values(e));d=d3.scaleLinear().domain([4,
d]).range([.5,1]);for(var f in e)e[f]=d(e[f]);a.setGroups({length:{color:a.getApplication().getColorForTerm("length"),terms:e}})}f=a.getComponent("fountain").getTargetEl();d=f.down("svg");d.set({width:f.getWidth(),height:f.getHeight()});var g=d.dom;d3.select(g).selectAll("*").remove();var h={},k=a.getGroups();a.setWords(c.slice(0,1E3).map(function(m){m=new a.FountainWord(m.toLowerCase());m.word in h?h[m.word]++:h[m.word]=1;m.min=parseInt(Math.random()*g.clientHeight*.05);var n=Math.sqrt(10*Math.random());
m.yshift=1>2*Math.random()?-n:n;m.jump=g.clientHeight/10;m.groupVals={};for(var r in k)m.word in k[r].terms&&(m.groupVals[r]=k[r].terms[m.word]);return m}));Math.max.apply(this,Object.values(h));var l=d3.scaleLog().domain([1,Math.max.apply(this,Object.values(h))]).range([4,12]);a.getWords().forEach(function(m){m.fontSize=l(h[m.word])});a.moveWords()})},FountainWord:function(a){this.word=a;this.direction=-1},moveWords:function(a){var b=this.getWords(),c=this.getComponent("fountain").getTargetEl().down("svg").dom,
d=c.clientHeight,e=c.clientWidth;this.getGroups();for(var f=d3.scaleLinear().domain([0,d]).range([1,0]),g=[],h=0,k=0;k<b.length;k++)if(h++,0==Object.keys(b[k].groupVals).length?g.push(0):Object.values(b[k].groupVals).forEach(function(m){g.push(m)}),0>b[k].direction)if(b[k].svg){var l=parseInt(b[k].svg.attr("y"));b[k].svg.attr("y",l-(l-b[k].min)/5);b[k].svg.attr("x",parseInt(b[k].svg.attr("x"))+b[k].yshift);l=parseInt(b[k].svg.attr("y"));b[k].ys.push(l);l<=b[k].min&&(b[k].direction=1)}else{if(l=d3.select(c).append("text").text(b[k].word).attr("font-size",
b[k].fontSize).attr("text-anchor","middle").attr("x",e/2).attr("y",d-Math.random()*d/5).attr("fill",0==Object.keys(b[k].groupVals).length?"black":this.getApplication().getColorForTerm(Object.keys(b[k].groupVals).shift(),!0)),b[k].ys=[d],b[k].svg=l,!a||k>a)break}else 0<b[k].direction?b[k].svg&&0<b[k].ys.length?(b[k].svg.attr("y",b[k].ys.pop()),b[k].svg.attr("x",parseInt(b[k].svg.attr("x"))+b[k].yshift),b[k].svg.attr("opacity",f(parseInt(b[k].svg.attr("y"))))):b[k].direction=0:"svg"in b[k]&&(b[k].svg.remove(),
delete b[k].svg);a=0==g.length?0:100*Ext.mean(g);c=this.down("polar");c.getStore().getAt(0).set("val",a);c.setSprites({type:"text",text:Ext.util.Format.number(a,"%0.0"),x:145,y:240});a=this.down("sparklineline");a.setValues(100<g.length?this.chunkify(g,100,!0).map(function(m){return Ext.mean(m)}):g);a.setWidth(h*a.ownerCt.getWidth()/b.length);this.setMoveWordsTimeout(Ext.defer(this.moveWords,100,this))},chunkify:function(a,b,c){if(2>b)return[a];var d=a.length,e=[],f=0;if(0===d%b)for(c=Math.floor(d/
b);f<d;)e.push(a.slice(f,f+=c));else if(c)for(;f<d;)c=Math.ceil((d-f)/b--),e.push(a.slice(f,f+=c));else{b--;c=Math.floor(d/b);for(0===d%c&&c--;f<c*b;)e.push(a.slice(f,f+=c));e.push(a.slice(c*b))}return e},initComponent:function(){this.callParent(arguments)}});Ext.define("Voyant.panel.RezoViz",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.rezoviz",statics:{i18n:{},api:{query:void 0,limit:25,stopList:"auto",type:["organization","location","person"],minEdgeCount:2},glyph:"xf1cb@FontAwesome"},config:{network:void 0,nodesStore:void 0,nodesDataSet:void 0,edgesDataSet:void 0,isNetworkBounded:!0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},categorizedNodeOptions:{location:{font:{color:"green"}},person:{font:{color:"maroon"}},
organization:{font:{color:"purple"}}},nodeOptions:{shape:"box",color:{border:"rgba(0,0,0,0.1)",background:"rgba(255,255,255,1)"},scaling:{label:{min:8,max:20}}},edgeOptions:{color:{color:"rgba(0,0,0,0.1)",highlight:"black",hover:"red"},labelHighlightBold:!1},highlightOptions:{font:{color:"white"},color:{background:"black"}},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.setNodesStore(Ext.create("Ext.data.Store",
{fields:["id","term","type","rawFreq"],sortOnLoad:!0,sorters:"term"}));Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",queryMode:"local",valueField:"term",displayField:"term",store:this.getNodesStore(),listeners:{select:function(a,b){this.getNetwork().selectNodes([b.get("id")])},scope:this}},{xtype:"button",text:this.localize("categories"),menu:{items:[{xtype:"menucheckitem",text:this.localize("people"),itemId:"person",
checked:!0},{xtype:"menucheckitem",text:this.localize("locations"),itemId:"location",checked:!0},{xtype:"menucheckitem",text:this.localize("organizations"),itemId:"organization",checked:!0},{xtype:"button",text:this.localize("reload"),style:"margin: 5px;",handler:this.categoriesHandler,scope:this}]}},{xtype:"numberfield",itemId:"minEdgeCount",fieldLabel:this.localize("minEdgeCount"),labelAlign:"right",labelWidth:120,width:170,maxValue:10,minValue:1,allowDecimals:!1,allowExponential:!1,allowOnlyWhitespace:!1,
listeners:{render:function(a){a.setRawValue(this.getApiParam("minEdgeCount"))},change:function(a,b){a.isValid()&&(this.setApiParam("minEdgeCount",b),this.getEntities())},scope:this}},{xtype:"tbseparator"},{xtype:"slider",fieldLabel:this.localize("repulsion"),labelAlign:"right",labelWidth:70,width:150,value:100,increment:10,minValue:0,maxValue:500,listeners:{changecomplete:function(a,b){this.getNetwork().physics.options.repulsion.nodeDistance=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",
fieldLabel:this.localize("stiffness"),labelAlign:"right",labelWidth:70,width:150,value:4,increment:1,minValue:0,maxValue:10,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.springConstant=b;this.getNetwork().startSimulation()},scope:this}},{xtype:"slider",fieldLabel:this.localize("friction"),labelAlign:"right",labelWidth:55,width:150,value:9,increment:10,minValue:0,maxValue:100,listeners:{changecomplete:function(a,b){b/=100;this.getNetwork().physics.options.repulsion.damping=
b;this.getNetwork().startSimulation()},scope:this}}]}]});this.on("loadedCorpus",function(a,b){1==b.getDocumentsCount()&&this.setApiParam("minEdgeCount",1);this.getEntities()},this);this.on("resize",function(a,b,c){},this);this.callParent(arguments)},getEntities:function(){var a=this.getCorpus().getId(),b=this.getLayout().getRenderTarget();b.mask(this.localize("loadingEntities"));Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),method:"POST",params:{tool:"corpus.EntityCollocationsGraph",
type:this.getApiParam("type"),limit:this.getApiParam("limit"),minEdgeCount:this.getApiParam("minEdgeCount"),corpus:a},timeout:6E4,success:function(c){b.unmask();c=Ext.decode(c.responseText);0==c.entityCollocationsGraph.edges.length?(this.showError({msg:this.localize("noEntities")}),Ext.Msg.confirm(this.localize("error"),this.localize("noEntitiesForEdgeCount"),function(d){"yes"===d&&(d=Math.max(1,this.getApiParam("minEdgeCount")-1),this.queryById("minEdgeCount").setRawValue(d),this.setApiParam("minEdgeCount",
d),this.getEntities())},this)):(this.processEntities(c.entityCollocationsGraph),this.initGraph())},scope:this})},processEntities:function(a){var b=a.nodes;a=a.edges;var c=d3.extent(b,function(g){return g.rawFreq}),d=c[0];c=c[1];var e=d3.scaleLinear().domain([d,c]).range([10,24]);d=[];for(c=0;c<b.length;c++){var f=b[c];f.id=c;d.push({id:c,label:f.term,value:b[c].rawFreq,font:{size:e(f.rawFreq),color:this.categorizedNodeOptions[f.type].font.color},type:f.type,rawFreq:f.rawFreq,title:f.term+(f.rawFreq?
" ("+f.rawFreq+")":"")})}this.getNodesStore().loadData(b);b=[];for(c=0;c<a.length;c++)e=a[c].nodes,b.push({from:e[0],to:e[1],title:a[c].count,value:200*a[c].count});this.setNodesDataSet(new vis.DataSet(d));this.setEdgesDataSet(new vis.DataSet(b))},initGraph:function(){var a=this.getLayout().getRenderTarget();a.update("");a.setWidth(a.getWidth());a.setHeight(a.getHeight());var b={interaction:{hover:!0,hoverConnectedEdges:!0,multiselect:!1},physics:{solver:"repulsion",repulsion:{centralGravity:.1}},
nodes:this.nodeOptions,edges:this.edgeOptions},c=new vis.Network(a.dom,{nodes:this.getNodesDataSet(),edges:this.getEdgesDataSet()},b);if(this.getIsNetworkBounded())c.on("beforeDrawing",function(d){var e=this.getLayout().getRenderTarget();d=e.getWidth();e=e.getHeight();var f=c.getPositions(),g;for(g in f){var h=c.canvasToDOM(f[g]);h=c.DOMtoCanvas({x:Math.max(0,Math.min(d,h.x)),y:Math.max(0,Math.min(e,h.y))});c.body.nodes[g].x=h.x;c.body.nodes[g].y=h.y}}.bind(this));c.on("selectNode",function(d){this.doNodeSelect(d.nodes[0])}.bind(this));
c.on("deselectNode",function(d){c.unselectAll();d=d.nodes[0];void 0!==d&&setTimeout(this.doNodeSelect.bind(this),5,d)}.bind(this));c.on("selectEdge",function(d){c.unselectAll()});this.setNetwork(c)},doNodeSelect:function(a){var b=this.getNodesDataSet().get(a).label;this.dispatchEvent("termsClicked",this,[b]);b=this.getNetwork();var c=b.getConnectedNodes(a);c.push(a);a=b.getConnectedEdges(a);b.unselectAll();for(var d=0;d<c.length;d++)b.selectionHandler.selectObject(b.body.nodes[c[d]],!1);for(d=0;d<
a.length;d++)b.selectionHandler.selectObject(b.body.edges[a[d]],!1);b.redraw()},categoriesHandler:function(a){var b=[];a.up("menu").items.each(function(c){c.checked&&b.push(c.itemId)});this.setApiParam("type",b);this.getEntities()},map:function(a,b,c,d,e){return d+(a-b)/(c-b)*(e-d)}});Ext.define("Voyant.panel.Loom",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.loom",statics:{i18n:{title:"Loom",controls:"Controls",frequenciesGroup:"Frequencies",coverageGroup:"Coverage",distributionsGroup:"Distribution",termsGroup:"Terms",inDocumentsLabel:"in documents",inDocumentsLabelTip:"each term must be present in the number of documents defined by this range",spanSomeLabel:"some documents",spanSomeLabelTip:"each term must be present in at least one document defined by this range",
spanAllLabel:"all documents",spanAllLabelTip:"each term must be present in all documents defined by this range",spanOnlyLabel:"only documents",spanOnlyLabelTip:"each term must be present in only the documents defined by this range",rawFreqLabel:"raw frequency",rawFreqLabelTip:"raw term frequencies for the term must be between these values (inclusively)",rawFreqPercentileLabel:"raw frequency percentile",rawFreqPercentileLabelTip:"raw term frequencies for the term must be between these percentile values (inclusively), this is useful for saying something like terms in the top 90th percentile which will provide 10% of words regardless of the variation in values.",
distributionsStdDevLabel:"standard deviation of distributions",distributionsStdDevLabelTip:"the standard deviation of term distribution scores must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",distributionsStdDevPercentileLabel:"percentile of standard deviations of distributions",distributionsStdDevPercentileLabelTip:"the percentile of standard deviations of distributions must be between the defined range of values (lower will be for values that are more consistent, higher will be for values that have greater variability)",
termsLengthLabel:"term length",termsLengthLabelTip:"the length (number of characters) of the term (word)",termsLengthPercentileLabel:"term length percentile",termsLengthPercentileLabelTip:"the percentile of the length (number of characters) of the term (word)",distributionIncreasesLabel:"increases in distribution values",distributionIncreasesLabelTip:"the number of increases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveIncreasesLabel:"consecutive decreases in distribution values",
distributionConsecutiveIncreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",distributionDecreasesLabel:"decreases in distribution values",distributionDecreasesLabelTip:"the number of decreases of the distribution values must be between the defined range (inclusively)",distributionConsecutiveDecreasesLabel:"consecutive decreases in distribution values",distributionConsecutiveDecreasesLabelTip:"the number of consecutive decreases of the distribution values must be between the defined range (inclusively)",
distributionMaxLabel:"distribution maximum",distributionMaxLabelTip:"the maximum of the distribution values must be between the defined range (inclusively)",distributionMinLabel:"distribution minimum",distributionMinLabelTip:"the minimum of the distribution values must be between the defined range (inclusively)",presetsGroup:"pre-sets",presetHighFreq:"terms that are high frequency",presetHighFreqLonger:"terms that are longer and high frequency",presetSingleDoc:"higher frequency terms that only occur once",
presetIncreaseDistributions:"terms that generally increase in frequency",presetDecreaseDistributions:"terms that generally decrease in frequency ",presetNearStartDistributions:"terms that peak in distribution toward the beginning ",presetNearEndDistributions:"terms that peak in distribution toward the end ",presetSporadicDistributions:"terms whose distributions vary the most",visibleTerms:"max terms",scaling:"scaling",scaleLinear:"linear",scaleLog:"logarithmic",scaleSqrt:"square root"},api:{limit:500,
stopList:"auto",inDocuments:void 0,spanSome:void 0,spanAll:void 0,spanOnly:void 0,termLength:void 0,termsLengthPercentile:void 0,rawFreq:void 0,rawFreqPercentile:void 0,distributionsStdDev:void 0,distributionsStdDevPercentile:void 0,distributionIncreases:void 0,distributionDecreases:void 0,distributionConsecutiveIncreases:void 0,distributionConsecutiveDecreases:void 0,distributionMax:void 0,distributionMin:void 0,scaling:"linear"},glyph:"xf1e0@FontAwesome"},config:{store:void 0,terms:void 0,options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}],controls:void 0},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var a=new Ext.util.MixedCollection({allowFunctions:!0});a.addAll({inDocuments:new Voyant.util.LoomControl({group:"coverage",name:"inDocuments",initControl:function(e){this.setMin(1);this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){e=
e.getDistributions().filter(function(f){return 0<f}).length;return e>=this.getLow()&&e<=this.getHigh()}}),spanSome:new Voyant.util.LoomControl({group:"coverage",name:"spanSome",offsetTipText:!0,initControl:function(e){this.setMax(e.getAt(0).getDistributions().length-1)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();for(e=e.getDistributions();f<g+1;f++)if(0<e[f])return!0;return!1}}),spanAll:new Voyant.util.LoomControl({group:"coverage",name:"spanAll",offsetTipText:!0,initControl:function(e){this.setMax(e.getAt(0).getDistributions().length-
1)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();for(e=e.getDistributions();f<g+1;f++)if(0==e[f])return!1;return!0}}),spanOnly:new Voyant.util.LoomControl({group:"coverage",name:"spanOnly",offsetTipText:!0,initControl:function(e){this.setMax(e.getAt(0).getDistributions().length-1)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=0;h<e.length;h++)if(h<f||h>g){if(0<e[h])return!1}else if(0==e[h])return!1;return!0}}),rawFreq:new Voyant.util.LoomControl({group:"frequencies",
name:"rawFreq",offsetTipText:!0,initControl:function(e){e=e.getRange().map(function(f){return f.get("rawFreq")});this.setMin(Ext.Array.min(e));this.setMax(Ext.Array.max(e))},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.get("rawFreq");return e>=f&&e<=g}}),rawFreqPercentile:new Voyant.util.LoomControl({group:"frequencies",name:"rawFreqPercentile",min:0,max:100,initControl:function(e){this.vals=e.getRange().map(function(f){return f.get("rawFreq")});this.vals.sort(function(f,g){return f-
g})},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=Ext.Array.indexOf(this.vals,e.get("rawFreq"));e=Math.round(100*e/this.vals.length);return e>=f&&e<=g}}),distributionsStdDev:new Voyant.util.LoomControl({group:"frequencies",name:"distributionsStdDev",initControl:function(e){var f=Ext.Array.flatten(e.getRange().map(function(h){return h.getDistributions()})),g=d3.scaleLinear().domain([d3.min(f),d3.max(f)]).range([0,100]);e.each(function(h){if(void 0===h.get("distributionsStdDev")){var k=
h.getDistributions(),l=k.map(function(n){return g(n)}),m=Ext.Array.mean(l);k=k.map(function(n){n-=m;return n*n});k=Ext.Array.mean(k);h.set("distributionsStdDev",Math.sqrt(k))}});e=e.getRange().map(function(h){return h.get("distributionsStdDev")});this.setMin(Ext.Array.min(e));this.setMax(Ext.Array.max(e))},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.get("distributionsStdDev");return e>=f&&e<=g}}),distributionsStdDevPercentile:new Voyant.util.LoomControl({group:"frequencies",
name:"distributionsStdDevPercentile",min:0,max:100,initControl:function(e){this.vals=e.getRange().map(function(f){return f.get("distributionsStdDev")});this.vals.sort(function(f,g){return f-g})},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=Ext.Array.indexOf(this.vals,e.get("distributionsStdDev"));e=Math.round(100*e/this.vals.length);return e>=f&&e<=g}}),termsLength:new Voyant.util.LoomControl({group:"terms",name:"termsLength",offsetTipText:!0,initControl:function(e){e=e.getRange().map(function(f){return f.get("term").length});
this.setMin(Ext.Array.min(e));this.setMax(Ext.Array.max(e))},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.get("term").length;return e>=f&&e<=g}}),termsLengthPercentile:new Voyant.util.LoomControl({group:"terms",name:"termsLengthPercentile",min:0,max:100,initControl:function(e){this.vals=e.getRange().map(function(f){return f.get("term").length});this.vals.sort(function(f,g){return f-g})},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=Ext.Array.indexOf(this.vals,
e.get("term").length);e=Math.round(100*e/this.vals.length);return e>=f&&e<=g}}),distributionIncreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionIncreases",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=0,k=1;k<e.length;k++)if(e[k]>e[k-1]&&(h++,h>g))return!1;return h>=f}}),distributionConsecutiveIncreases:new Voyant.util.LoomControl({group:"distributions",
name:"distributionConsecutiveIncreases",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=0,k=1;k<e.length;k++)if(e[k]>e[k-1]){if(h++,h>g)return!1}else h=0;return h>=f}}),distributionDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionDecreases",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=
this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=0,k=1;k<e.length;k++)if(e[k]<e[k-1]&&(h++,h>g))return!1;return h>=f}}),distributionConsecutiveDecreases:new Voyant.util.LoomControl({group:"distributions",name:"distributionConsecutiveDecreases",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=0,k=1;k<e.length;k++)if(e[k]<e[k-1]){if(h++,h>g)return!1}else h=0;return h>=
f}}),distributionMax:new Voyant.util.LoomControl({group:"distributions",name:"distributionMax",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=Ext.Array.max(e);f<g;f++)if(e[f]==h)return!0;return!1}}),distributionMin:new Voyant.util.LoomControl({group:"distributions",name:"distributionMin",initControl:function(e){this.setMax(e.getAt(0).getDistributions().length)},validateRecord:function(e){var f=
this.getLow(),g=this.getHigh();e=e.getDistributions();for(var h=Ext.Array.min(e);f<g;f++)if(e[f]==h)return!0;return!1}})});a.each(function(e){var f=this.getApiParam(e.getName()),g=(f||"").split(",");e.setEnabled(void 0!==f);2==g.length&&(e.setLow(parseInt(g[0])),e.setHigh(parseInt(g[1])));e.on("change",function(h){h.getEnabled()?this.setApiParam(h.getName(),h.getLow()+","+h.getHigh()):this.setApiParam(h.getName(),void 0);this.filterRecords()},this)},this);this.setControls(a);var b=this,c=function(){var e=
b.getApiParams();b.controls.each(function(f){f.setEnabled(!1,!0);f=f.getName();f in e&&b.setApiParam(f,void 0)})},d=[{text:this.localize("presetsGroup"),menu:{items:[{text:this.localize("presetHighFreq"),handler:function(){c();this.filterRecords()},scope:this},{text:this.localize("presetHighFreqLonger"),handler:function(){c();this.controls.getByKey("termsLengthPercentile").setEnabled(!0,!0).setValues(50,100,!0);this.controls.getByKey("rawFreqPercentile").setEnabled(!0,!0).setValues(50,100)},scope:this},
{text:this.localize("presetSingleDoc"),handler:function(){c();this.controls.getByKey("inDocuments").setEnabled(!0,!0).setValues(1,1)},scope:this},{text:this.localize("presetIncreaseDistributions"),handler:function(){c();var e=this.controls.getByKey("distributionIncreases"),f=e.getMax();e.setEnabled(!0,!0).setValues(Math.round(.75*f),f)},scope:this},{text:this.localize("presetDecreaseDistributions"),handler:function(){c();var e=this.controls.getByKey("distributionDecreases"),f=e.getMax();e.setEnabled(!0,
!0).setValues(Math.round(.75*f),f)},scope:this},{text:this.localize("presetNearStartDistributions"),handler:function(){c();var e=this.controls.getByKey("distributionMax"),f=e.getMax();e.setEnabled(!0,!0).setValues(0,Math.round(.2*f))},scope:this},{text:this.localize("presetNearEndDistributions"),handler:function(){c();var e=this.controls.getByKey("distributionMax"),f=e.getMax();e.setEnabled(!0,!0).setValues(Math.round(.8*f),f)},scope:this},{text:this.localize("presetSporadicDistributions"),handler:function(){c();
this.controls.getByKey("distributionsStdDevPercentile").setEnabled(!0,!0).setValues(80,100)},scope:this}]}},{xtype:"tbspacer"}];["frequencies","coverage","distributions","terms"].map(function(e){d.push({text:this.localize(e+"Group"),menu:{items:a.filterBy(function(f){return f.getGroup()==e}).getRange().map(function(f){return{xtype:"menucheckitem",checked:f.getEnabled(),text:this.localize(f.getName()+"Label"),tooltip:this.localize(f.getName()+"LabelTip"),listeners:{beforerender:function(g){g.setChecked(f.getEnabled());
f.on("change",function(){g.setChecked(f.getEnabled())})},click:function(g){f.setEnabled(g.checked);g.getMenu().setDisabled(!g.checked);g.checked?g.getMenu().show():g.getMenu().hide()}},menu:{disabled:!f.getEnabled(),items:{xtype:"multislider",width:100,minValue:f.getMin()||0,maxValue:f.getMax()||0,values:[f.getLow()||0,f.getHigh()||0],tipText:function(g){return f.getOffsetTipText()?g.value+1:g.value},listeners:{beforerender:function(g){g.updateFromControl(f);f.on("change",function(){g.updateFromControl(f)})},
changecomplete:function(g){f.setValues(g.getValues())}},updateFromControl:function(g){this.setMinValue(g.getMin()||0);this.setMaxValue(g.getMax());this.setValue(0,g.getLow()||0);this.setValue(1,void 0===g.getHigh()?g.getMax()||0:g.getHigh())}}}}},this)}})},this);Ext.apply(this,{title:this.localize("title"),layout:{type:"hbox",align:"stretch"},listeners:{afterrender:function(){var e=this.getComponent("terms"),f=this.getComponent("threads");e.on("termHovered",function(g,h){if(g=f.getTargetEl().dom.querySelector("path[term="+
h+"]")){var k=function(l,m){opacity=l.getAttribute("opacity");0<opacity&&(opacity-=.01,l.setAttribute("opacity",opacity),m/=2,Ext.defer(k,m,this,[l,m]))};g.setAttribute("opacity",1);k(g,1E3)}})}},items:[{itemId:"terms",width:100,layout:"fit",listeners:{filterchange:function(e){var f=this.getTargetEl(),g=f.getWidth(),h=f.getHeight(),k=e.getCount();f.setHtml(" ");terms=e.getRange().map(function(u,q){return{term:u.getTerm(),col:Voyant.application.getColorForTerm(u.getTerm(),!0),x:g/2,y:q*h/k}});terms.sort(function(u,
q){return u.term.localeCompare(q.term)});e=d3.select(f.dom).append("svg").attr("width",g).attr("height",h).append("g").attr("transform","translate(-.5,-.5)");var l=Math.ceil(h/terms.length),m=e.selectAll("ytext").data(terms).enter().append("text").text(function(u,q){return u.term}).attr("class","ytext").attr("text-anchor","middle").attr("x",g/2).attr("y",function(u,q){return l*q}).attr("fill",function(u){return Voyant.application.getColorForTerm(u.term,!0)});l=Math.ceil(h/terms.length);var n=d3.fisheye.circular().radius(50).distortion(2);
yFisheye=d3.fisheye.scale(d3.scaleIdentity).domain([0,h]);var r=this;e.on("mousemove",function(){var u=d3.mouse(this);currentItem=Math.round(u[1]*terms.length/h);currentItem=Math.min(currentItem,terms.length-1);n.focus(u[1]);yFisheye.focus(u[1]);var q=m.nodes();q[currentItem]&&r.fireEvent("termHovered",r,q[currentItem].textContent);var p=14,v=Math.max(u[1],p),w=1;d3.select(q[currentItem]).attr("y",function(N){return v}).attr("font-size",p).attr("fill-opacity",w);for(var B=void 0,C=currentItem-1;-1<
C;C--)8<=p?(v-=p,p-=.5):(void 0==B&&(B=v/C),v-=B),.1<w&&(w-=.05),d3.select(q[C]).attr("y",function(N){return v}).attr("font-size",p).attr("fill-opacity",w);p=14;v=Math.max(u[1],p);w=1;B=void 0;C=currentItem+1;for(u=terms.length;C<u;C++)8<=p?(v+=p,p-=.5):(void 0==B&&(B=(h-v)/(u-C)),v+=B),.1<w&&(w-=.05),d3.select(q[C]).attr("y",function(N){return v}).attr("font-size",p).attr("fill-opacity",w)})}}},{itemId:"threads",layout:"fit",flex:1,listeners:{filterchange:function(e){var f=this.getTargetEl(),g=f.getWidth(),
h=f.getHeight();f.setHtml(" ");terms=e.getRange().map(function(p){return{term:p.getTerm(),vals:p.getDistributions()}});var k=d3.select(f.dom).append("svg").attr("width",f.getWidth()).attr("height",f.getHeight());if(0==terms.length)return this.up("panel").toastInfo("No hits");var l=g/terms[0].vals.length;e=this.up("loom").getApiParam("scaling");var m=("sqrt"==e?d3.scaleSqrt():"log"==e?d3.scaleLog():d3.scaleLinear()).domain([Math.max(1E-6,Ext.Array.min(terms.map(function(p){return Ext.Array.min(p.vals)}))),
Math.max(1E-6,Ext.Array.max(terms.map(function(p){return Ext.Array.max(p.vals)})))]).range([1E-6,h-2]),n=d3.line().curve(d3.curveCardinal).x(function(p,v){return l/2+l*v}).y(function(p){return h-1-m(p)}),r=k.append("g").attr("opacity",0),u=r.append("rect").attr("fill","white").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("stroke","rgba(0,0,0,.05)").attr("class","rect").attr("x",100).attr("y",100).attr("width",70).attr("height",16).attr("opacity",1),q=r.append("text").attr("text-anchor",
"middle").attr("alignment-baseline","middle").attr("x",100).attr("y",100).text("testing");terms.forEach(function(p){var v=Voyant.application.getColorForTerm(p.term,!0);k.append("path").datum(p.vals).attr("fill","none").attr("stroke",v).attr("opacity",.5).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1).attr("class","line").attr("d",n);k.append("path").datum(p.vals).attr("fill","none").attr("stroke",v).attr("opacity",0).attr("stroke-width",3).attr("class","line").attr("term",
p.term).attr("d",n).on("mouseover",function(){d3.select(this).attr("opacity",1);var w=d3.mouse(this);r.attr("opacity",1);u.attr("x",w[0]-35).attr("y",w[1]-8+(w[1]>h/2?-18:18));q.text(p.term).attr("fill",v).attr("x",w[0]).attr("y",w[1]+(w[1]>h/2?-18:18))}).on("mouseout",function(){d3.select(this).attr("opacity",0);r.attr("opacity",0)});r.raise()},this)}}}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[d[0],d[2],d[3],d[4],d[5],{fieldLabel:this.localize("visibleTerms"),
labelWidth:70,width:120,xtype:"slider",increment:25,minValue:25,maxValue:5E3,listeners:{afterrender:function(e){e.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(e,f){this.setApiParams({limit:f});this.fireEvent("loadedCorpus",this,this.getCorpus())},scope:this}},{text:this.localize("scaling"),menu:{defaults:{xtype:"menucheckitem",handler:function(e){this.setApiParam("scaling",e.getItemId());this.getComponent("threads").fireEventArgs("filterchange",[this.getStore()])},scope:this,
listeners:{afterrender:function(e){e.setChecked(e.getItemId()==this.getApiParam("scaling"))},scope:this},group:"scaling"},items:[{text:this.localize("scaleLinear"),itemId:"linear"},{text:this.localize("scaleLog"),itemId:"log"},{text:this.localize("scaleSqrt"),itemId:"sqrt"}]}}]}]});this.on("loadedCorpus",function(e,f){e=1==f.getDocumentsCount()?f.getDocumentTerms():f.getCorpusTerms();e.on("load",function(){this.updateControlsFromStore();this.filterRecords()},this);e.on("filterchange",function(){this.getComponent("terms").fireEventArgs("filterchange",
arguments);this.getComponent("threads").fireEventArgs("filterchange",arguments)},this);this.setStore(e);params=this.getApiParams();Ext.apply(params,{withDistributions:!0});e.load({callback:function(g,h,k){this.filterRecords()},scope:this,params:params})},this);this.callParent(arguments)},filterRecords:function(){var a=this.getStore();a.clearFilter();var b=parseInt(this.getApiParam("limit")),c=0;a.filterBy(function(d){return Ext.Array.every(this.getControls().getRange(),function(e){return 0==e.getEnabled()||
e.getValidateRecord().call(e,d)},this)&&c++<b},this)},updateControlsFromStore:function(){var a=this.getStore();this.getControls().each(function(b){b.suspendEvent("change");b.initControl.call(this,a);void 0===b.getMin()&&b.setMin(0);void 0==b.getLow()&&b.setLow(b.getMin());void 0===b.getMax()&&b.setMax(1);void 0==b.getHigh()&&b.setHigh(b.getMax());b.resumeEvent("change")})},revalidate:function(){var a=this.body.down("canvas").dom,b=a.getContext("2d");b.clearRect(0,0,a.width,a.height);var c=this.query("loomcontrol"),
d=new Voyant.panel.LoomTermRecords;this.getStore().each(function(e){var f=e.getDistributions().map(function(g){return!0});Ext.Array.each(c,function(g){if(g.getChecked()&&g.validateRecord){g=g.validateRecord.call(this,g.getField(),e,e.getDistributions());if(Ext.isBoolean(g)&&!g)return f=!1;if(Ext.isArray(g)){for(var h=0;h<f.length;h++)f[h]=f[h]&&g[h];return Ext.Array.some(f,function(k){return k})}}});Ext.isArray(f)&&Ext.Array.some(f,function(g){return g})&&d.add(e)});d.update(a,b)}});
Ext.define("Voyant.panel.LoomTermRecords",{config:{termRecords:[]},constructor:function(a){this.setTermRecords([]);this.callParent(arguments)},add:function(a){this.getTermRecords().push(new Voyant.panel.LoomTermRecord(a))},update:function(a,b){var c=Ext.Array.min(this.getTermRecords().map(function(e){return Ext.Array.min(e.getValues())})),d=Ext.Array.max(this.getTermRecords().map(function(e){return Ext.Array.max(e.getValues())}));this.getTermRecords().forEach(function(e){e.update(a,b,c,d)})}});
Ext.define("Voyant.panel.LoomTermRecord",{config:{record:void 0,values:void 0,term:void 0,texts:void 0},constructor:function(a){this.setRecord(a);this.setValues(a.getDistributions());var b=a.getTerm();this.setTerm(b);this.setTexts(a.getDistributions().map(function(c){return new Ext.draw.sprite.Text({type:"text",text:b})}));this.callParent(arguments)},update:function(a,b,c,d){var e=this.getValues(),f=a.offsetWidth/e.length,g=a.offsetHeight,h=this.getTerm();this.getTexts().forEach(function(k,l){b.fillText(h,
f/2+l*f,g-e[l]*g/d)})}});
Ext.define("Voyant.util.LoomControl",{extend:"Ext.Base",mixins:["Ext.mixin.Observable"],constructor:function(a){this.mixins.observable.constructor.call(this,a);this.callParent(arguments)},config:{group:void 0,name:void 0,enabled:!1,min:void 0,max:void 0,low:void 0,high:void 0,initControls:Ext.emptyFn,validateRecord:Ext.emptyFn,offsetTipText:!1},setMin:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setMax:function(){this.callParent(arguments);this.fireEvent("change",
this);return this},setLow:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setHigh:function(){this.callParent(arguments);this.fireEvent("change",this);return this},setValues:function(a,b){this.suspendEvent("change");Ext.isArray(a)?(this.setLow(a[0]),this.setHigh(a[1])):(this.setLow(a),this.setHigh(b));this.resumeEvent("change");(3>arguments.length||!arguments[2])&&this.fireEvent("change",this);return this},setEnabled:function(){this.callParent(arguments);(2>arguments.length||
!arguments[1])&&this.fireEvent("change",this);return this}});Ext.define("Voyant.panel.MicroSearch",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microsearch",statics:{i18n:{},api:{stopList:"auto",query:void 0},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],maxTokens:0,tokensPerSegment:0,maxVerticalLines:0,maxSegments:0},constructor:function(a){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"}]}]});
this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(b,c){if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(b,c){this.setApiParam("query",c);this.updateSearchResults()})},initialize:function(){var a=this.getTargetEl(),b=this.getCorpus();this.setMaxVerticalLines(Math.floor((a.getHeight()-10)/5));var c=b.getDocumentsCount(),d=10*c,e=Math.floor((a.getWidth()-
d-10)/c);200<e&&(e=200);d=Math.floor(e/3);1>d&&(d=1);this.setMaxSegments(d*this.getMaxVerticalLines());b=b.getDocuments();this.setMaxTokens(b.max("tokensCount-lexical"));this.setTokensPerSegment(this.getMaxTokens()<this.getMaxSegments()?1:Math.ceil(this.getMaxTokens()/this.getMaxSegments()));var f="<table cellpadding='0' cellspacing='0' style='height: 100%'><tr>";this.segments=[];b.each(function(h){docIndex=h.getIndex();f+='<td style="overflow: hidden; vertical-align: top; width: '+e+'px;"><div class="docLabel" style="white-space: nowrap; width: '+
e+'px;" data-qtip="'+h.getFullLabel()+'">'+h.getFullLabel()+'</div><canvas style="display: block;" width="'+e+'" height="'+a.getHeight()+'" id="'+this.body.id+"-"+docIndex+'"></td>';docIndex+1<c&&(f+='<td style="width: 10px;">&nbsp;</td>')},this);f+="</tr></table>";a.update(f);this.updateSearchResults();if(!this.getApiParam("query")){var g=this;return this.getCorpus().loadCorpusTerms({limit:1,stopList:this.getApiParam("stopList"),categories:this.getApiParam("categories")}).then(function(h){h=h.getAt(0).getTerm();
g.down("querysearchfield").addValue(new Voyant.data.model.CorpusTerm({term:h}));g.fireEvent("query",g,[h])})}},updateSearchResults:function(){query=this.getApiParam("query");0==Ext.Array.from(query).length?this.getCorpus().getDocuments().each(function(a){var b=this.redistributeDistributions(a,Array(this.getMaxSegments()));this.drawDocumentDistributions(a,b)},this):(this.mask(this.localize("loading")),this.getCorpus().getDocumentTerms().load({params:{query:Ext.Array.from(query).join("|"),withDistributions:"relative",
bins:this.getMaxSegments(),categories:this.getApiParam("categories")},callback:function(a,b,c){this.unmask();var d=0,e=Number.MAX_VALUE,f=[],g;a.forEach(function(h){var k=this.getCorpus().getDocument(h.getDocIndex()),l=this.redistributeDistributions(k,h.getDistributions());g=Ext.Array.max(l);g>d&&(d=g);l.forEach(function(m){m&&m<e&&(e=m)});f[h.getDocIndex()]=this.redistributeDistributions(k,h.getDistributions())},this);f.forEach(function(h,k){this.drawDocumentDistributions(this.getCorpus().getDocument(k),
h,e||Ext.Array.min(h),d||Ext.Array.max(h))},this)},scope:this}))},redistributeDistributions:function(a,b){a=Math.ceil(a.getLexicalTokensCount()/this.getTokensPerSegment());if(b.length>a){for(var c=[],d=0;d<b.length;d++){var e=parseInt(d*a/b.length);c[e]?c[e].push(b[d]):c[e]=[b[d]]}b=c;for(d=0;d<b.length;d++)b[d]=Ext.Array.mean(b[d])}return b},drawDocumentDistributions:function(a,b,c,d){var e=this.getTargetEl().dom.querySelector("#"+this.body.id+"-"+a.getIndex());a=e.getContext("2d");var f=0;e=e.clientWidth;
for(var g=0,h=0;h<b.length;h++)a.fillStyle=b[h]?"rgba(250,0,0,"+(.8*(b[h]-c)/(d-c)+.2)+")":"rgb(230,230,230)",a.fillRect(f,g,3,3),f+=3,f>=e&&(f=0,g+=5)}});Ext.define("Voyant.panel.Mandala",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.mandala",statics:{i18n:{},api:{stopList:"auto",query:void 0,labels:!0},glyph:"xf1db@FontAwesome"},gutter:5,textFont:"12px sans-serif",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),html:'<div style="text-align: center"><canvas width="800" height="600"></canvas></div>',
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{text:this.localize("add"),glyph:"xf067@FontAwesome",handler:function(){this.editMagnet()},scope:this},{text:this.localize("clear"),glyph:"xf014@FontAwesome",handler:function(){this.setApiParam("query",void 0);this.updateFromQueries(!0);this.editMagnet()},scope:this},{xtype:"checkbox",boxLabel:this.localize("labels"),listeners:{render:function(a){a.setValue(!0===this.getApiParam("labels"));Ext.tip.QuickTipManager.register({target:a.getEl(),
text:this.localize("labelsTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},change:function(a,b){this.setApiParam("labels",b);this.draw()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().dom.querySelector("canvas"),c=this;b.addEventListener("mousemove",function(d){var e=b.getBoundingClientRect(),f=d.clientX-e.left,g=d.clientY-e.top,h=!1,k=parseInt(c.textFont)/
2;c.documents&&c.documents.forEach(function(l){var m=f>l.x-k&&f<l.x+k&&g>l.y-k&&g<l.y+k;m!=l.isHovering&&(h=!0);l.isHovering=m});radius=parseInt(c.textFont)/2;for(term in c.magnets)d=f>c.magnets[term].x-radius&&f<c.magnets[term].x+radius&&g>c.magnets[term].y-radius&&g<c.magnets[term].y+radius,d!=c.magnets[term].isHovering&&(h=!0),c.magnets[term].isHovering=d;h&&c.draw()},!1);b.addEventListener("click",function(d){var e=b.getBoundingClientRect(),f=d.clientX-e.left;d=d.clientY-e.top;parseInt(c.textFont);
for(term in c.magnets)f>c.magnets[term].x-radius&&f<c.magnets[term].x+radius&&d>c.magnets[term].y-radius&&d<c.magnets[term].y+radius&&c.editMagnet(term)},!1)});this.on("loadedCorpus",function(a,b){this.documents=[];a=this.getTargetEl().dom.querySelector("canvas");var c=a.getContext("2d"),d=a.width/2;c.font=this.textFont;b.getDocuments().each(function(e){var f=e.getTinyTitle();this.documents.push({doc:e,label:f,width:c.measureText(f).width,x:d,y:d,matches:[],isHovering:!1})},this);this.updateDocs(a);
this.draw();this.updateFromQueries()},this);this.on("resize",function(){var a=this.getTargetEl().dom.querySelector("canvas"),b=Math.min(this.getTargetEl().getWidth(),this.getTargetEl().getHeight());a.width=b;a.height=b;this.updateMagnets();this.updateDocs();this.draw(a)})},editMagnet:function(a){var b=this,c=Ext.Array.from(b.getApiParam("query"));Ext.create("Ext.window.Window",{title:this.localize("EditMagnet"),modal:!0,items:{xtype:"form",width:300,items:[{xtype:"querysearchfield",corpus:this.getCorpus(),
store:this.getCorpus().getCorpusTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList")}}}),stopList:this.getApiParam("stopList"),listeners:{afterrender:function(d){if(a){var e=new Ext.create("Voyant.data.model.CorpusTerm",{term:a});d.getStore().loadData(e,!0);d.setValue(e)}}}},{xtype:"numberfield",fieldLabel:b.localize("rotateClockwise"),minValue:0,maxValue:c.length-1,value:0,stepValue:1,width:200,name:"rotate"}],buttons:[{text:this.localize("remove"),glyph:"xf0e2@FontAwesome",flex:1,ui:"default-toolbar",
handler:function(d){var e=Ext.Array.filter(Ext.Array.from(b.getApiParam("query")),function(f){return f!=a});b.setApiParam("query",e);b.updateFromQueries(0==e.length);d.up("window").close()},scope:this},{xtype:"tbfill"},{text:this.localize("cancel"),ui:"default-toolbar",glyph:"xf00d@FontAwesome",flex:1,handler:function(d){d.up("window").close()}},{text:this.localize("update"),glyph:"xf00c@FontAwesome",flex:1,handler:function(d){var e=d.up("window").down("querysearchfield").getValue().join("|");if(e){for(var f=
-1,g=0;g<c.length;g++)if(a==c[g]){f=g;c[g]=e;var h=d.up("window").down("numberfield").getValue();h&&(c.splice(g,1),g+=h,g>c.length&&(g-=c.length+1),c.splice(g,0,e));break}-1==f&&c.push(e)}b.setApiParam("query",c);b.updateFromQueries(0==c.length);d.up("window").close()},scope:this}]},bodyPadding:5}).show()},updateFromQueries:function(a){this.magnets=void 0;this.documents.forEach(function(d){d.matches=[]});this.updateDocs();this.draw();if(this.documents){var b=this.getApiParams();b.query||(b.limit=
10);var c=Ext.Array.from(this.getApiParam("query"));(!a||0<c.length)&&this.getCorpus().getCorpusTerms().load({params:Ext.apply(b,{withDistributions:!0}),callback:function(d){var e=this.getTargetEl().dom.querySelector("canvas"),f=e.getContext("2d");diam=e.width;rad=diam/2;f.font=this.textFont;var g={};e=0;for(var h=d.length;e<h;e++){var k=d[e].getTerm();d[e].getDistributions().forEach(function(l,m){0<l&&this.documents[m].matches.push(k)},this);g[k]={record:d[e],colour:this.getApplication().getColor(e),
width:f.measureText(k).width,isHovering:!1}}this.magnets={};c.forEach(function(l){g[l]&&(this.magnets[l]=g[l],delete g[l])},this);for(k in g)this.magnets[k]=g[k];this.setApiParam("query",Object.keys(this.magnets));this.updateMagnets();this.updateDocs();this.draw()},scope:this})}},updateMagnets:function(a){a=this.getTargetEl().dom.querySelector("canvas");a=a.width/2;var b=Object.keys(this.magnets||{}).length,c=0,d;for(d in this.magnets)Ext.apply(this.magnets[d],{x:a+(a-this.gutter-50)*Math.cos(2*Math.PI*
c/b),y:a+(a-this.gutter-50)*Math.sin(2*Math.PI*c/b)}),c++},updateDocs:function(a){a=a||this.getTargetEl().dom.querySelector("canvas");diam=a.width;rad=diam/2;var b=[];if(this.documents){this.documents.forEach(function(d,e){if(0==Ext.Array.from(d.matches).length)b.push(e);else if(1==Ext.Array.from(d.matches).length){var f=15*Math.random()+15,g=15*Math.random()+15;d.targetX=this.magnets[d.matches[0]].x+(0==Math.round(Math.random())?f:-f);d.targetY=this.magnets[d.matches[0]].y+(0==Math.round(Math.random())?
g:-g)}else{g=f=0;var h=d.matches.map(function(n){return this.magnets[n].record.getDistributions()[e]},this),k=Ext.Array.min(h),l=Ext.Array.max(h),m=0;d.matches.forEach(function(n,r){weight=l==k?1:(h[r]-k+k)/(l-k+k);m+=weight;f+=this.magnets[n].x*weight;g+=this.magnets[n].y*weight},this);d.targetX=f/m;d.targetY=g/m}},this);a=0;for(var c=b.length;a<c;a++)Ext.apply(this.documents[a],{targetX:rad+(rad-this.gutter)*Math.cos(2*Math.PI*a/c),targetY:rad+(rad-this.gutter)*Math.sin(2*Math.PI*a/c)})}},draw:function(a,
b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.font=this.textFont;var c=a.width/2;b.clearRect(0,0,a.width,a.height);var d=this.getApiParam("labels");b.beginPath();b.strokeStyle="rgba(0,0,0,.1)";b.fillStyle="rgba(0,0,0,.02)";b.arc(c,c,c-this.gutter,0,2*Math.PI,!1);b.fill();b.lineWidth=2;b.stroke();var e=!1;if(this.documents&&0<this.documents.length){var f=Ext.Array.each(this.documents,function(q){return!q.isHovering},this);!0===f&&(f=Ext.Array.each(Object.keys(this.magnets||
{}),function(q){return!this.magnets[q].isHovering},this));var g={};hoveringDocs=[];this.documents.forEach(function(q,p){q.matches.forEach(function(v,w){b.beginPath();b.moveTo(q.x,q.y);b.lineTo(this.magnets[v].x,this.magnets[v].y);!0===f?b.strokeStyle="rgba("+this.magnets[v].colour.join(",")+",.1)":q.isHovering||this.magnets[v].isHovering?(hoveringDocs[p]=!0,g[v]=!0,b.strokeStyle="rgba("+this.magnets[v].colour.join(",")+",.5)"):b.strokeStyle="rgba(0,0,0,.02)";b.stroke()},this)},this);var h=parseInt(this.textFont)/
2,k=parseInt(this.textFont)+4;this.documents.forEach(function(q,p){if(d||q.isHovering||1==hoveringDocs[p]){var v=q.width+4;b.fillStyle=q.isHovering||1==hoveringDocs[p]||!0===f?"white":"rgba(255,255,255,.05)";b.fillRect(q.x-v/2,q.y-k/2,v,k);b.strokeStyle=q.isHovering||1==hoveringDocs[p]||!0===f?"rgba(0,0,0,.2)":"rgba(0,0,0,.05)";b.strokeRect(q.x-v/2,q.y-k/2,v,k);b.textAlign="center";b.fillStyle=q.isHovering||1==hoveringDocs[p]||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)";b.fillText(q.label,q.x,q.y)}else b.beginPath(),
b.fillStyle="rgba(0,0,0,.8)",b.arc(q.x,q.y,h,0,2*Math.PI),b.fill(),b.stroke();p=Math.abs(q.x-q.targetX);v=Math.abs(q.y-q.targetY);if(0!=p||0!=v)1>p?q.x=q.targetX:(p/=2,q.x=q.x>q.targetX?q.x-p:q.x+p),1>v?q.y=q.targetY:(v/=2,q.y=q.y>q.targetY?q.y-v:q.y+v),e=!0},this);a=0;k=parseInt(this.textFont)+4;b.textAlign="center";b.textBaseline="middle";for(var l in this.magnets)d||l in g||this.magnets[l].isHovering?(a=this.magnets[l].width+4,b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"white":"rgba(255,255,255,.05)",
b.fillRect(this.magnets[l].x-a/2,this.magnets[l].y-k/2,a,k),b.strokeStyle=l in g||this.magnets[l].isHovering||!0===f?"rgb("+this.magnets[l].colour.join(",")+")":"rgba(0,0,0,.05)",b.strokeRect(this.magnets[l].x-a/2,this.magnets[l].y-k/2,a,k),b.textAlign="center",b.fillStyle=l in g||this.magnets[l].isHovering||!0===f?"rgba(0,0,0,.8)":"rgba(0,0,0,.05)",b.fillText(l,this.magnets[l].x,this.magnets[l].y)):(b.beginPath(),b.fillStyle="rgb("+this.magnets[l].colour.join(",")+")",b.strokeStyle="rgb("+this.magnets[l].colour.join(",")+
")",b.arc(this.magnets[l].x,this.magnets[l].y,12,0,2*Math.PI),b.fill(),b.stroke())}if(e){var m=this;setTimeout(function(){m.draw()},100)}else if(this.documents){c=Math.max(c/this.documents.length,50);a=0;for(l=this.documents.length;a<l;a++)for(var n=0;n<l;n++)if(a<n){var r=this.documents[a].x-this.documents[n].x,u=this.documents[a].y-this.documents[n].y;Math.sqrt(r*r+u*u)<c&&(r*=.1,u*=.1,this.documents[a].targetX+=r,this.documents[n].targetX-=r,this.documents[a].targetY+=u,this.documents[n].targetY-=
u,e=!0)}e&&(m=this,setTimeout(function(){m.draw()},100))}}});Ext.define("Voyant.panel.MicroOcp",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.microocp",statics:{i18n:{title:"MicroOCP"},api:{config:void 0,stopList:"auto",uri:void 0},glyph:"xf1ea@FontAwesome"},config:{editor:void 0},constructor:function(a){a=a||{};this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);var b=Ext.create("Ext.data.Store",{fields:[{name:"cocoa",type:"string"}]}),c=this;Ext.apply(this,{title:this.localize("title"),layout:"border",dockedItems:[{dock:"bottom",
xtype:"toolbar",overflowHandler:"scroller",groupId:"tbar",items:[{text:"Create New Voyant Corpus",handler:function(){var d=this.down("grid").getSelectionModel().getSelection().map(function(p){return p.get("cocoa")});if(0==d.length)return this.showError({title:"Error",msg:"No items are selected in the grid (on the right)."});itemsMap={};d.forEach(function(p){itemsMap[p]=!0});var e=this.getEditor().getValue();d=/<(\/)?(\w+)(\s(\w+))?>/g;for(var f,g={};null!=(f=d.exec(e));){var h="/"==f[1],k=f[2],l=
f[4],m=f[4]?f[2]+" "+f[4]:f[2];h||m in itemsMap?(k in g&&(g[k][g[k].length-1].end=f.index),h||(k in g||(g[k]=[]),g[k].push({start:f.index+f[0].length,tag:k,attr:l}))):m in itemsMap&&k in g&&(g[k][g[k].length-1].end=f.index)}isGroupItems=this.getDockedComponent(1).down("checkbox").checked;var n=[];if(isGroupItems){var r={};for(k in g)g[k].forEach(function(p,v){if(v=e.substring(p.start,p.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim())p=p.tag+(p.attr?" "+p.attr:""),r[p]=p in r?r[p]+v:v});for(m in r)n.push({title:m,
text:r[m]})}else for(k in g)g[k].forEach(function(p,v){var w=e.substring(p.start,p.end).replace(/<\/?\w+(\s+\w)*>/g,"").trim();w&&n.push({title:p.tag+(p.attr?" "+p.attr:"")+" "+(v+1),text:w})});if(0==n.length)return this.showError({title:"Error",msg:"No documents found."});this.mask();var u=Ext.Msg.progress("Creating","Creating new corpus."),q=this;(new Corpus({inputFormat:"json",input:Ext.JSON.encode({documents:n}),jsonDocumentsPointer:"/documents",jsonTitlePointer:"/title",jsonContentPointer:"/text"})).then(function(p){u.close();
q.unmask();var v=q.getApplication();q.openUrl(v.getBaseUrl()+"?corpus="+p.getAliasOrId())})},scope:this},{xtype:"checkbox",boxLabel:"Combine documents with the same tag attribute.",checked:!0}]}],items:[{xtype:"panel",autoScroll:!0,flex:1,height:"100%",align:"stretch",header:!1,region:"center",listeners:{boxready:function(){var d=this,e=ace.edit(Ext.getDom(this.getEl()));c.setEditor(e);e.getSession().setMode("ace/mode/xml");e.renderer.setShowPrintMargin(!1);e.renderer.setShowGutter(!1);e.$blockScrolling=
Infinity;e.setOptions({autoScrollEditorIntoView:!0});e.setBehavioursEnabled(!1);e.on("change",function(f){reparse=!1;if("insert"==f.action)0==f.lines[0].indexOf(">")&&(reparse=!0);else if("remove"==f.action)for(var g=0;g<f.lines.length;g++)if(-1<f.lines[g].indexOf(">")){reparse=!0;break}reparse&&Ext.defer(function(){for(var h=e.getValue(),k=/<(\w+)(\s(\w+))?>/g,l,m={};null!=(l=k.exec(h));)l[3]?m[l[1]+" "+l[3]]=!0:m[l[1]]=!0;h=this.up("panel").down("grid").getStore();var n={};h.getRange().forEach(function(r){n[r.get("cocoa")]=
!0});for(item in m)item in n||h.add({cocoa:item});for(inStoreItem in n)inStoreItem in m||(k=h.findRecord("cocoa",inStoreItem),h.remove(k))},100,d)});c.getApiParam("uri")&&Notebook.loadDataFromUrl(c.getApiParam("uri")).then(function(f){c.getEditor().setValue(f)})}}},{xtype:"grid",region:"east",height:"100%",align:"stretch",scrollable:!0,header:!1,width:200,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"SIMPLE"}),store:b,columns:[{text:"COCOA",flex:1,dataIndex:"cocoa"}]}]});this.callParent(arguments);
this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("loadedCorpus",function(d,e){if(!this.getApiParam("uri")){var f=this;e.getPlainText().then(function(g){g=g.replace(/(\r\n|\r|\n)(\r\n|\r|\n)(\r\n|\r|\n)+/g,"\n\n");var h=f.getEditor();h.setValue(g).trim();h.scrollToLine(1,!0,!0,function(){})})}},this);this.on("afterrender",function(d){Ext.Msg.alert("MicroOCP","MicroOCP is an experimental prototype that is intended to give a taste of working with the COCOA markup format (COunt and COncordance on the Atlas). Cocoa tags are like switches, you can place one and that tag remains in effect until the next instance of the tag, which can have an optional attribute (single word). As an enhancement to COCOA, you can also close a tag.<pre>&lt;speaker jack&gt;I'm falling &lt;speaker jill&gt;down the hill.&lt;/speaker&gt;</pre>")})}});Ext.define("Voyant.panel.Reader",{extend:"Ext.panel.Panel",requires:["Voyant.data.store.Tokens"],mixins:["Voyant.panel.Panel"],alias:"widget.reader",isConsumptive:!0,statics:{i18n:{},api:{start:0,limit:1E3,skipToDocId:void 0,query:void 0},glyph:"xf0f6@FontAwesome"},config:{innerContainer:void 0,tokensStore:void 0,documentsStore:void 0,documentTermsStore:void 0,exportVisualization:!1,lastScrollTop:0,scrollIntoView:!1,insertWhere:"beforeEnd",lastLocationUpdate:new Date,options:[{xtype:"stoplistoption"},
{xtype:"categoriesoption"}]},SCROLL_UP:-1,SCROLL_EQ:0,SCROLL_DOWN:1,LOCATION_UPDATE_FREQ:100,INITIAL_LIMIT:1E3,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){var b=Ext.create("Voyant.data.store.Tokens",{parentTool:this,proxy:{extraParams:{forTool:"reader"}}}),c=this;b.on("beforeload",function(d){return c.hasCorpusAccess(d.getCorpus())});b.on("load",function(d,e,f){if(f){var g="",h=this.localize("documentFrequency"),
k=!1,l=-1,m=!1;e.forEach(function(n){0==n.getPosition()&&(g+="<h3>"+this.getDocumentsStore().getById(n.getDocId()).getFullLabel()+"</h3>");n.getDocIndex()!=l&&(k=this.getDocumentsStore().getById(n.getDocId()).isPlainText(),l=n.getDocIndex());if(n.isWord())m=!1,g+="<span class='word' id='"+n.getId()+"' data-qtip='"+h+" "+n.getDocumentRawFreq()+"'>"+n.getTerm()+"</span>";else{n=n.getTermWithLineSpacing(k);var r=0==n.indexOf("<br />");if(!m||!r&&0!=n.trim().length)g+=n,m=r}},this);this.updateText(g);
this.down("querysearchfield").getValue()}},this);this.setTokensStore(b);this.on("query",function(d,e){this.loadQueryTerms(e)},this);this.setDocumentTermsStore(Ext.create("Ext.data.Store",{model:"Voyant.data.model.DocumentTerm",autoLoad:!1,remoteSort:!1,proxy:{type:"ajax",url:Voyant.application.getTromboneUrl(),extraParams:{tool:"corpus.DocumentTerms",withDistributions:!0,withPositions:!0,bins:25,forTool:"reader"},reader:{type:"json",rootProperty:"documentTerms.terms",totalProperty:"documentTerms.total"},
simpleSortMode:!0},listeners:{load:function(d,e,f,g){d.sort("docIndex","ASC");var h;d.each(function(k){h=k.get("term")},this);this.highlightKeywords(h)},scope:this}}));this.on("afterrender",function(){var d=this.down('panel[region="center"]');this.setInnerContainer(d.getLayout().getRenderTarget());d.body.on("scroll",function(e,f){e=this.getLastScrollTop()<f.scrollTop?this.SCROLL_DOWN:this.getLastScrollTop()>f.scrollTop?this.SCROLL_UP:this.SCROLL_EQ;if(e==this.SCROLL_UP&&1>f.scrollTop)this.fetchPrevious(!0);
else if(e==this.SCROLL_DOWN&&f.scrollHeight-f.scrollTop<1.5*f.offsetHeight)this.fetchNext(!1);else{var g=0==f.scrollTop?0:f.scrollHeight-f.scrollTop==f.clientHeight?1:(f.scrollTop+.5*f.clientHeight)/f.scrollHeight;(new Date-this.getLastLocationUpdate()>this.LOCATION_UPDATE_FREQ||0==g||1==g)&&this.updateLocationMarker(g,e)}this.setLastScrollTop(f.scrollTop)},this);d.body.on("click",function(e,f){f=Ext.get(f);f.hasCls("word")&&(e=Voyant.data.model.Token.getInfoFromElement(f),f=f.getHtml(),e=[{term:f,
docIndex:e.docIndex}],this.loadQueryTerms([f]),this.getApplication().dispatchEvent("termsClicked",this,e))},this);this.getCorpus()&&(this.load(),(d=this.getApiParam("query"))&&this.loadQueryTerms(Ext.isString(d)?[d]:d));this.on("loadedCorpus",function(){this.load(!0);var e=this.getApiParam("query");e&&this.loadQueryTerms(Ext.isString(e)?[e]:e)},this)},this);Ext.apply(this,{title:this.localize("title"),cls:"voyant-reader",layout:"fit",items:{layout:"border",items:[{bodyPadding:10,region:"center",border:!1,
autoScroll:!0,html:'<div class="readerContainer"></div>'},{xtype:"readergraph",region:"south",height:40,split:{size:2},splitterResize:!0,border:!1,listeners:{documentRelativePositionSelected:function(d,e){d=this.getDocumentsStore().getAt(e.docIndex);var f=d.get("tokensCount-lexical");e=Math.floor(f*e.fraction)-this.getApiParam("limit")/2;this.setApiParams({skipToDocId:d.getId(),start:0>e?0:e});this.load(!0)},scope:this}}]},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{glyph:"xf060@FontAwesome",
handler:function(){this.fetchPrevious(!0)},scope:this},{glyph:"xf061@FontAwesome",handler:function(){this.fetchNext(!0)},scope:this},{xtype:"tbseparator"},{xtype:"querysearchfield"}]}],listeners:{loadedCorpus:function(d,e){this.getTokensStore().setCorpus(e);this.getDocumentTermsStore().getProxy().setExtraParam("corpus",e.getId());d=e.getDocuments();this.setDocumentsStore(d);this.rendered&&(this.load(),0==this.hasCorpusAccess(e)&&this.mask(this.localize("limitedAccess"),"mask-no-spinner"),(e=this.getApiParam("query"))&&
this.loadQueryTerms(Ext.isString(e)?[e]:e))},termsClicked:function(d,e){var f=[];e.forEach(function(g){Ext.isString(g)?f.push(g):g.term?f.push(g.term):g.getTerm&&f.push(g.getTerm())});0<f.length&&this.loadQueryTerms(f)},corpusTermsClicked:function(d,e){var f=[];e.forEach(function(g){g.getTerm()&&f.push(g.getTerm())});this.loadQueryTerms(f)},documentTermsClicked:function(d,e){var f=[];e.forEach(function(g){g.getTerm()&&f.push(g.getTerm())});this.loadQueryTerms(f)},documentSelected:function(d,e){d=
this.getTokensStore().getCorpus().getDocument(e);this.setApiParams({skipToDocId:d.getId(),start:0});this.load(!0)},documentsClicked:function(d,e,f){0<e.length&&(this.setApiParams({skipToDocId:e[0].getId(),start:0}),this.load(!0))},termLocationClicked:function(d,e){if(void 0!==e[0]){var f=e[0],g=f.get("docIndex"),h=f.get("position");d=h-this.getApiParam("limit")/2;e=this.getCorpus().getDocument(g);this.setApiParams({skipToDocId:e.getId(),start:0>d?0:d});this.load(!0,{callback:function(){var k=this.body.dom.querySelector("#_"+
g+"_"+h);k&&k.scrollIntoView();this.highlightKeywords(f.get("term"),!1)},scope:this})}},documentIndexTermsClicked:function(d,e){void 0!==e[0]&&(d=Ext.create("Voyant.data.model.Token",e[0]),this.fireEvent("termLocationClicked",this,[d]))},scope:this}});this.callParent(arguments)},loadQueryTerms:function(a){a&&0<a.length&&(this.getDocumentTermsStore().load({params:{query:a}}),this.down("readergraph").loadQueryTerms(a))},highlightKeywords:function(a,b){Ext.isArray(a)||(a=[a]);this.getInnerContainer().first().select("span[class*=keyword]").removeCls("keyword");
var c=[],d=new RegExp("^"+a[0]+"$","i");this.getInnerContainer().first().select("span.word").each(function(e,f,g){e.dom.firstChild&&e.dom.firstChild.nodeValue.match(d)&&(e.addCls("keyword"),c.push(e.dom))})},fetchPrevious:function(a){var b=this.getInnerContainer().first(),c=b.first(".word");if(null!=c&&!1===c.hasCls("loading"))for(;c;){if(c.hasCls("word")){b=Voyant.data.model.Token.getInfoFromElement(c);var d=b.docIndex;b=b.position;var e=this.getDocumentsStore().getAt(d),f=this.getApiParam("limit"),
g=!1;if(0===d&&0===b){a=this.down('panel[region="center"]').body;0!=c.getScrollIntoViewXY(a,a.dom.scrollTop,a.dom.scrollLeft).y&&c.dom.scrollIntoView();c.frame("red");break}0<d&&0===b?(g=!0,d--,e=this.getDocumentsStore().getAt(d),d=e.get("tokensCount-lexical"),b=d-f,0>b&&(b=0,this.setApiParam("limit",d))):(f--,b-=f);0>b&&(b=0);c.insertSibling("<div class='loading'>"+this.localize("loading")+"</div>","before",!1).mask();g||c.destroy();c=e.getId();this.setApiParams({skipToDocId:c,start:b});this.setInsertWhere("afterBegin");
this.setScrollIntoView(a);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.first()}},fetchNext:function(a){var b=this.getInnerContainer().first(),c=b.last();if(!1===c.hasCls("loading"))for(;c;){if(c.hasCls("word")){b=Voyant.data.model.Token.getInfoFromElement(c);var d=b.docIndex,e=b.position,f=this.getDocumentsStore().getAt(b.docIndex),g=f.getId();f=f.get("tokensCount-lexical");if(e+this.getApiParam("limit")>=f&&d==this.getCorpus().getDocumentsCount()-1)if(d=f-e,1>=d){c.dom.scrollIntoView();
c.frame("red");break}else this.setApiParam("limit",d);for(d=c.dom.nextSibling;d;)e=d,d=d.nextSibling,e.parentNode.removeChild(e);c.insertSibling("<div class='loading'>"+this.localize("loading")+"</div>","after",!1).mask();c.destroy();this.setApiParams({skipToDocId:g,start:b.position});this.setInsertWhere("beforeEnd");this.setScrollIntoView(a);this.load();this.setApiParam("limit",this.INITIAL_LIMIT);break}c.destroy();c=b.last()}},load:function(a,b){a&&(this.getInnerContainer().first().destroy(),this.getInnerContainer().setHtml('<div class="readerContainer"><div class="loading">'+
this.localize("loading")+"</div></div>"),this.getInnerContainer().first().first().mask());this.getTokensStore().load(Ext.apply(b||{},{params:Ext.apply(this.getApiParams(),{stripTags:"blocksOnly",stopList:""})}))},updateText:function(a){var b=this.getInnerContainer().down(".loading");b&&b.destroy();var c=this.getInnerContainer().first().insertHtml(this.getInsertWhere(),a,!0);c&&this.getScrollIntoView()&&(c.dom.scrollIntoView(),Ext.Function.defer(function(){var d=Ext.get(c.id);d&&d.frame("red")},100));
a=this.down('panel[region="center"]').body.dom;this.updateLocationMarker(0==a.scrollTop?0:a.scrollHeight-a.scrollTop==a.clientHeight?1:(a.scrollTop+.5*a.clientHeight)/a.scrollHeight)},updateLocationMarker:function(a,b){var c=Ext.DomQuery.select(".word",this.getInnerContainer().down(".readerContainer",!0)),d=c[0],e=c[c.length-1];if(void 0!==d&&void 0!==e){c=this.getCorpus();var f=!1;d=Voyant.data.model.Token.getInfoFromElement(Ext.get(d));e=Voyant.data.model.Token.getInfoFromElement(Ext.get(e));0!==
d.position&&(f=!0);for(var g={},h=0,k=d.docIndex;k<=e.docIndex;){var l=c.getDocument(k).get("tokensCount-lexical");k===e.docIndex&&(l=e.position);k===d.docIndex&&(l-=d.position);h+=l;g[k]=l;k++}h=Math.round(h*a);k=a=0;for(l=d.docIndex;l<=e.docIndex&&!(a=l,k+=g[l],k>=h);l++);e=g[a]-(k-h);f&&a===d.docIndex&&(e+=d.position);c=e/c.getDocument(a).get("tokensCount-lexical");this.down("readergraph").moveLocationMarker(a,c,b)}},updateChart:function(){}});Ext.define("Voyant.panel.SimpleDocReader",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.simpledocreader",isConsumptive:!0,statics:{i18n:{},api:{docIndex:void 0,docId:void 0},glyph:"xf0f6@FontAwesome"},config:{},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){Ext.apply(this,{html:'<iframe style="width: 100%; height: 100%; border: none;"></iframe>',dockedItems:[{dock:"bottom",xtype:"toolbar",
overflowHandler:"scroller",items:[{glyph:"xf060@FontAwesome",handler:this.fetchPrevious,scope:this},{glyph:"xf061@FontAwesome",handler:this.fetchNext,scope:this}]}],listeners:{loadedCorpus:function(b,c){"true"!==this.getApiParam("autoLoadOnLoadedCorpus","false")&&this.fireEvent("documentSelected",this,0)},documentSelected:function(b,c){this.setApiParams({docIndex:this.getCorpus().getDocument(c).getIndex(),docId:void 0});this.fetch()},scope:this}});this.callParent(arguments)},fetchPrevious:function(){var a=
void 0!==this.getApiParam("docIndex")?this.getCorpus().getDocument(this.getApiParam("docIndex")):void 0!==this.getApiParam("docId")?this.getCorpus().getDocument(this.getApiParam("docId")):this.getCorpus().getDocument(1);0<a.getIndex()?(this.setApiParams({docIndex:a.getIndex()-1,docId:void 0}),this.fetch()):this.toastInfo(this.localize("noPrevious"))},fetchNext:function(){if(void 0!==this.getApiParam("docIndex"))var a=this.getCorpus().getDocument(this.getApiParam("docIndex"));else if(void 0!==this.getApiParam("docId"))a=
this.getCorpus().getDocument(this.getApiParam("docId"));else return this.setApiParams({docIndex:0,docId:void 0}),this.fetch();a.getIndex()<this.getCorpus().getDocumentsCount()-1?(this.setApiParams({docIndex:a.getIndex()+1,docId:void 0}),this.fetch()):this.toastInfo(this.localize("noNext"))},fetch:function(){var a=void 0!==this.getApiParam("docIndex")?this.getCorpus().getDocument(this.getApiParam("docIndex")):void 0!==this.getApiParam("docId")?this.getCorpus().getDocument(this.getApiParam("docId")):
this.getCorpus().getDocument(0);var b=this.getTargetEl().down("iframe",!0);b.setAttribute("src","about:blank");if(this.getApiParam("originalUrlMetadataKey")){var c=a.get(this.getApiParam("originalUrlMetadataKey"));if(c){b.setAttribute("src",c);return}}a={corpus:this.getCorpus().getId(),docIndex:a.getIndex(),tool:"corpus.DocumentTokens",template:"docTokensPlusStructure2html",outputFormat:"html",limit:0};c=this.getTromboneUrl()+"?"+Ext.Object.toQueryString(a);b.setAttribute("src",c)}});Ext.define("Voyant.panel.ScatterPlot",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Ext.chart.CartesianChart"],alias:"widget.scatterplot",statics:{i18n:{},api:{docId:void 0,analysis:"ca",limit:50,dimensions:3,bins:10,clusters:3,perplexity:15,iterations:1500,comparisonType:"relative",stopList:"auto",target:void 0,term:void 0,query:void 0,whitelist:void 0,label:["summary","docs","terms"],storeJson:void 0},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],
caStore:null,pcaStore:null,tsneStore:null,docSimStore:null,termStore:null,chartMenu:null,newTerm:null,termsTimeout:null,highlightData:{x:0,y:0,r:0},highlightTask:null},tokenFreqTipTemplate:null,docFreqTipTemplate:null,constructor:function(a){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);if("storeJson"in a){var b=JSON.parse(a.storeJson);Ext.apply(a,b)}this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.setCaStore(Ext.create("Voyant.data.store.CAAnalysis",
{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setPcaStore(Ext.create("Voyant.data.store.PCAAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setTsneStore(Ext.create("Voyant.data.store.TSNEAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setDocSimStore(Ext.create("Voyant.data.store.DocSimAnalysis",{listeners:{load:this.maskAndBuildChart,scope:this}}));this.setTermStore(Ext.create("Ext.data.JsonStore",{fields:[{name:"term"},{name:"rawFreq",type:"int"},
{name:"relativeFreq",type:"number"},{name:"coordinates",mapping:"vector"},{name:"category"}],sorters:[{property:"rawFreq",direction:"DESC"}],groupField:"category"}));this.setChartMenu(Ext.create("Ext.menu.Menu",{items:[{text:this.localize("remove"),itemId:"remove",glyph:"xf068@FontAwesome"},{text:this.localize("nearby"),itemId:"nearby",glyph:"xf0b2@FontAwesome"}],listeners:{hide:function(){var a=this.down("#chart").getSeries();a[0].enableToolTips();a[1].enableToolTips()},scope:this}}));this.tokenFreqTipTemplate=
new Ext.Template(this.localize("tokenFreqTip"));this.docFreqTipTemplate=new Ext.Template(this.localize("docFreqTip"));Ext.apply(this,{title:this.localize("title"),layout:"border",autoDestroy:!0,items:[{itemId:"chartParent",region:"center",layout:"fit",tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"filterTerms",width:150},{text:this.localize("labels"),itemId:"labels",glyph:"xf02b@FontAwesome",menu:{items:[{text:this.localize("summaryLabel"),itemId:"summary",xtype:"menucheckitem"},
{text:this.localize("docsLabel"),itemId:"docs",xtype:"menucheckitem"},{text:this.localize("termsLabel"),itemId:"terms",xtype:"menucheckitem"}],listeners:{afterrender:function(a){var b=this.getApiParam("label");a.items.each(function(c){c.setChecked(-1<b.indexOf(c.getItemId()))})},click:function(a,b){a=this.getApiParam("label");var c=b.getItemId();Ext.isString(a)&&(a=[a]);b.checked&&-1==a.indexOf(c)?a.push(c):!b.checked&&-1<a.indexOf(c)&&(a=a.filter(function(d){return d!=c}));this.setApiParam("label",
a);this.doLabels();this.queryById("chart").redraw()},scope:this}}}]},listeners:{query:function(a,b){this.getTermStore().filter([{property:"term",value:b,anyMatch:!0}]);this.filterChart(b)},scope:this}},{itemId:"optionsPanel",title:this.localize("options"),region:"west",split:!0,collapsible:!0,collapseMode:"header",width:135,scrollable:"y",layout:{type:"vbox",align:"stretch"},defaults:{xtype:"button",margin:"5",labelAlign:"top"},items:[{xtype:"label",text:this.localize("input")},{xtype:"documentselectorbutton"},
{text:this.localize("freqsMode"),itemId:"comparisonType",glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("rawFrequencies"),itemId:"comparisonType_raw",group:"freqsMode",xtype:"menucheckitem"},{text:this.localize("relativeFrequencies"),itemId:"comparisonType_relative",group:"freqsMode",xtype:"menucheckitem"},{text:this.localize("tfidf"),itemId:"comparisonType_tfidf",group:"freqsMode",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&
(a=b.getItemId().split("_")[1],a!==this.getApiParam("comparisonType")&&(this.setApiParam("comparisonType",a),this.loadFromApis(!0)))},scope:this}}},{fieldLabel:this.localize("numTerms"),itemId:"limit",xtype:"numberfield",minValue:5,listeners:{change:function(a,b,c){function d(){this.setApiParam("limit",b);this.loadFromApis()}null!==c&&(null!==this.getTermsTimeout()&&clearTimeout(this.getTermsTimeout()),a.isValid()&&this.setTermsTimeout(setTimeout(d.bind(this),500)))},scope:this}},{xtype:"container",
html:'<hr style="border: none; border-top: 1px solid #cfcfcf;"/>'},{xtype:"label",text:this.localize("output")},{text:this.localize("analysis"),itemId:"analysis",glyph:"xf1ec@FontAwesome",overflowHandler:"scroller",menu:{items:[{text:this.localize("pca"),itemId:"analysis_pca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("ca"),itemId:"analysis_ca",group:"analysis",xtype:"menucheckitem"},{text:this.localize("tsne"),itemId:"analysis_tsne",group:"analysis",xtype:"menucheckitem"},{text:this.localize("docSim"),
itemId:"analysis_docSim",group:"analysis",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(a=b.getItemId().split("_")[1],a!==this.getApiParam("analysis")&&(this.doAnalysisChange(a),this.loadFromApis(!0)))},scope:this}}},{fieldLabel:this.localize("perplexity"),itemId:"perplexity",xtype:"slider",minValue:5,maxValue:100,increment:1,listeners:{changecomplete:function(a,b){this.setApiParam("perplexity",b);this.loadFromApis(!0)},scope:this}},{fieldLabel:this.localize("iterations"),itemId:"iterations",
xtype:"slider",minValue:100,maxValue:5E3,increment:100,listeners:{changecomplete:function(a,b){this.setApiParam("iterations",b);this.loadFromApis(!0)},scope:this}},{text:this.localize("clusters"),itemId:"clusters",glyph:"xf192@FontAwesome",menu:{items:[{text:"1",itemId:"clusters_1",group:"clusters",xtype:"menucheckitem"},{text:"2",itemId:"clusters_2",group:"clusters",xtype:"menucheckitem"},{text:"3",itemId:"clusters_3",group:"clusters",xtype:"menucheckitem"},{text:"4",itemId:"clusters_4",group:"clusters",
xtype:"menucheckitem"},{text:"5",itemId:"clusters_5",group:"clusters",xtype:"menucheckitem"}],listeners:{click:function(a,b){void 0!==b&&(a=parseInt(b.getItemId().split("_")[1]),a!==this.getApiParam("clusters")&&(this.setApiParam("clusters",a),this.loadFromApis(!0)))},scope:this}}},{text:this.localize("dimensions"),itemId:"dimensions",glyph:"xf1b2@FontAwesome",menu:{items:[{text:"2",itemId:"dimensions_2",group:"dimensions",xtype:"menucheckitem"},{text:"3",itemId:"dimensions_3",group:"dimensions",
xtype:"menucheckitem"}],listeners:{click:function(a,b){if(void 0!==b&&(a=parseInt(b.getItemId().split("_")[1]),a!==this.getApiParam("dimensions"))){if(3==a&&"ca"==this.getApiParam("analysis")&&3==this.getCorpus().getDocumentsCount())return!1;this.setApiParam("dimensions",a);this.loadFromApis(!0)}},scope:this}}},{itemId:"reloadButton",text:this.localize("reload"),glyph:"xf021@FontAwesome",handler:function(){this.loadFromApis()},scope:this}]},{itemId:"termsGrid",xtype:"grid",title:this.localize("terms"),
region:"east",width:250,split:!0,collapsible:!0,collapseMode:"header",forceFit:!0,features:[{ftype:"grouping",hideGroupedHeader:!0,enableGroupingMenu:!1}],bbar:{overflowHandler:"scroller",items:[{itemId:"nearbyButton",xtype:"button",text:this.localize("nearby"),glyph:"xf0b2@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):(a=b.get("term"),this.getNearbyForTerm(a))},scope:this},
{itemId:"removeButton",xtype:"button",text:this.localize("remove"),glyph:"xf068@FontAwesome",flex:1,handler:function(a){var b=a.up("panel").getSelection()[0];void 0===b?this.toastError({html:this.localize("noTermSelected"),anchor:a.up("panel").getTargetEl()}):(a=b.get("term"),this.removeTerm(a))},scope:this}]},tbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield",itemId:"addTerms",flex:1}]},columns:[{text:this.localize("term"),dataIndex:"term",flex:1,sortable:!0},{text:this.localize("rawFreq"),
dataIndex:"rawFreq",flex:.75,minWidth:70,sortable:!0},{text:this.localize("relFreq"),dataIndex:"relativeFreq",flex:.75,minWidth:70,sortable:!0,hidden:!0}],selModel:{type:"rowmodel",mode:"SINGLE",allowDeselect:!0,toggleOnClick:!0,listeners:{selectionchange:{fn:function(a,b){b=b[0];void 0!==b?(a=b.get("term"),b="document"===b.get("category"),this.selectTerm(a,b),b?(this.queryById("nearbyButton").disable(),this.queryById("removeButton").disable()):(this.queryById("nearbyButton").enable(),this.queryById("removeButton").enable())):
this.selectTerm()},scope:this}}},store:this.getTermStore(),listeners:{expand:function(a){a.getView().refresh()},query:function(a,b){0<b.length&&-1===this.getTermStore().findExact("term",b[0])?(this.setNewTerm(b),this.loadFromApis()):this.setNewTerm(null)},scope:this}}]});this.on("boxready",function(a,b,c){400>b&&(this.queryById("optionsPanel").collapse(),this.queryById("termsGrid").collapse());this.config.storeClass&&this.config.storeData&&this.loadStoreFromJson(this.config.storeClass,this.config.storeData)},
this);this.on("beforedestroy",function(a){a=this.queryById("chart");null!==a&&this.queryById("chartParent").remove(a)},this);this.on("loadedCorpus",function(a,b){a=function(c){var d=this.getApiParam(c);this.queryById(c).down("#"+c+"_"+d).setChecked(!0)}.bind(this);a("analysis");this.doAnalysisChange(this.getApiParam("analysis"));a("comparisonType");a("clusters");this.queryById("perplexity").setValue(this.getApiParam("perplexity"));this.queryById("iterations").setValue(this.getApiParam("iterations"));
3==b.getDocumentsCount()&&this.setApiParam("dimensions",2);a("dimensions");this.getCaStore().setCorpus(b);this.getPcaStore().setCorpus(b);this.getDocSimStore().setCorpus(b);this.loadFromApis()},this);this.on("documentsSelected",function(a,b){this.setApiParam("docId",b);this.loadFromApis()},this);this.callParent(arguments)},doAnalysisChange:function(a){this.setApiParam("analysis",a);this.queryById("nearbyButton").setDisabled("tsne"===a);this.queryById("reloadButton").setVisible("tsne"===a);this.queryById("perplexity").setVisible("tsne"===
a);this.queryById("iterations").setVisible("tsne"===a);"ca"===a&&3==this.getCorpus().getDocumentsCount()&&(this.setApiParam("dimensions",2),this.queryById("dimensions").menu.items.get(0).setChecked(!0))},loadStoreFromJson:function(a,b){"Voyant.data.store.CAAnalysis"==a?(this.getCaStore().loadRawData(b),this.doAnalysisChange("ca"),this.maskAndBuildChart.call(this,this.getCaStore())):"Voyant.data.store.PCAAnalysis"==a?(this.getPcaStore().loadRawData(b),this.doAnalysisChange("pca"),this.maskAndBuildChart.call(this,
this.getPcaStore())):"Voyant.data.store.TSNEAnalysis"==a?(this.getTsneStore().loadRawData(b),this.doAnalysisChange("tsne"),this.maskAndBuildChart.call(this,this.getTsneStore())):"Voyant.data.store.DocSimAnalysis"==a&&(this.getDocSimStore().loadRawData(b),this.doAnalysisChange("docSim"),this.maskAndBuildChart.call(this,this.getDocSimStore()))},maskAndBuildChart:function(a){this.queryById("chartParent").mask(this.localize("plotting"));Ext.defer(this.buildChart,50,this,[a])},buildChart:function(a){var b=
this,c=this.queryById("chart");null!==c&&this.queryById("chartParent").remove(c);this.queryById("termsGrid").getSelectionModel().deselectAll();c=a.getAt(0);var d=this.getApiParam("dimensions");a="";if("pca"===this.getApiParam("analysis")){for(var e=c.getPrincipalComponents(),f=0,g=0;g<e.length;g++)f+=parseFloat(e[g].get("eigenValue"));if(0!=f){a=this.localize("pcTitle")+"\n";var h=["xAxis","yAxis","fill"];for(g=0;g<e.length&&!(g>=d);g++){var k=e[g].get("eigenValue")/f*100;a+=this.localize("pc")+" "+
(g+1)+" ("+this.localize(h[g])+"): "+Math.round(100*k)/100+"%\n"}}}else if("tsne"!==this.getApiParam("analysis"))for(a=this.localize("caTitle")+"\n",h=["xAxis","yAxis","fill"],e=c.getDimensions(),g=0;g<e.length&&!(g>=d);g++)k=e[g].get("percentage"),a+=this.localize("dimension")+" "+(g+1)+" ("+this.localize(h[g])+"): "+Math.round(100*k)/100+"%\n";var l=0,m=Number.MAX_VALUE,n=0,r=Number.MAX_VALUE;"docSim"!==this.getApiParam("analysis")&&this.getTermStore().removeAll();var u=[],q=[];c.getTokens().forEach(function(p){var v=
p.get("rawFreq"),w=p.get("category");void 0===w&&(w="term",p.set("category","term"));var B="term"===w;B&&(v>l&&(l=v),v<m&&(m=v));this.getTermStore().findExact("term",-1===p.get("term"))&&this.getTermStore().addSorted(p);if(3===d){var C=p.get("vector")[2];void 0!==C&&(C<r&&(r=C),C>n&&(n=C))}v={x:p.get("vector")[0],y:p.get("vector")[1]||0,z:p.get("vector")[2]||0,term:p.get("term"),rawFreq:v,relativeFreq:p.get("relativeFreq"),cluster:p.get("cluster"),category:w,disabled:!1};B?u.push(v):("bin"===p.get("category")?
v.term=v.title="Bin "+p.get("docIndex"):(v.docIndex=p.get("docIndex"),p=this.getCorpus().getDocument(v.docIndex),null!==p&&(v.term=p.getShortTitle(),v.title=p.getTitle())),q.push(v))},this);c=this.getTermStore().getCount();this.queryById("limit").setRawValue(c);this.setApiParam("limit",c);c=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex disabled".split(" "),data:u});g=Ext.create("Ext.data.JsonStore",{fields:"term x y z rawFreq relativeFreq cluster category docIndex disabled".split(" "),
data:q});a={itemId:"chart",xtype:"cartesian",interactions:["crosszoom","panzoom","itemhighlight"],plugins:{ptype:"chartitemevents"},axes:[{type:"numeric",position:"bottom",fields:["x"],label:{rotate:{degrees:-30}}},{type:"numeric",position:"left",fields:["y"]}],sprites:[{type:"text",text:a,x:70,y:70}],innerPadding:{top:25,right:25,bottom:25,left:25},series:[{type:"customScatter",xField:"x",yField:"y",store:c,label:{font:"14px Helvetica",field:"term",display:"over"},tooltip:{trackMouse:!0,style:"background: #fff",
renderer:function(p,v,w){p.setHtml(b.tokenFreqTipTemplate.apply([v.get("term"),v.get("rawFreq"),v.get("relativeFreq")]))}},marker:{type:"circle"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(p,v,w,B){p=w.store.getAt(B);if(null!==p){var C=p.get("cluster");-1===C&&(C=0);w=.65;B=1;!0===p.get("disabled")?B=w=.1:3===d&&p.get("z")&&(w=b.interpolate(p.get("z"),r,n,0,1));C=b.getApplication().getColor(C);v.fillStyle="rgba("+C.join(",")+","+w+")";v.strokeStyle="rgba("+C.join(",")+","+
B+")";p=p.get("rawFreq");p=b.interpolate(p,m,l,2,20);v.radius=p}},scope:this},{type:"customScatter",xField:"x",yField:"y",store:g,label:{font:"14px Helvetica",field:"term",display:"over",color:this.getDefaultDocColor(!0)},tooltip:{trackMouse:!0,style:"background: #fff",renderer:function(p,v,w){p.setHtml(b.docFreqTipTemplate.apply([v.get("title"),v.get("rawFreq")]))}},marker:{type:"diamond"},highlight:{fillStyle:"yellow",strokeStyle:"black"},renderer:function(p,v,w,B){p=w.store.getAt(B);null!==p&&
(w=p.get("cluster"),w=-1===w||"docSim"!==b.getApiParam("analysis")?b.getDefaultDocColor():b.getApplication().getColor(w),B=.65,3===d&&p.get("z")&&(B=b.interpolate(p.get("z"),r,n,0,1)),v.fillStyle="rgba("+w.join(",")+","+B+")",v.strokeStyle="rgba("+w.join(",")+",1)",v.radius=5)},scope:this}],listeners:{itemclick:function(p,v,w){p=v.record.data;"doc"===p.category?(p=this.getCorpus().getDocument(p.docIndex),this.getApplication().dispatchEvent("documentsClicked",this,[p])):"term"===p.category&&(p=Ext.create("Voyant.data.model.CorpusTerm",
p),this.getApplication().dispatchEvent("corpusTermsClicked",this,[p]))},render:function(p){p.body.on("contextmenu",function(v,w){v.preventDefault();v=v.getXY();var B=Ext.fly(w).getXY();w=v[0]-B[0];B=v[1]-B[1];var C=this.down("#chart").getItemForPoint(w,B);null!=C&&"term"===C.record.get("category")&&(w=this.down("#chart").getSeries(),w[0].disableToolTips(),w[1].disableToolTips(),B=C.record.get("term"),w=(new Ext.Template(this.localize("removeTerm"))).apply([B]),this.getChartMenu().queryById("remove").setText(w),
w=(new Ext.Template(this.localize("nearbyTerm"))).apply([B]),B=this.getChartMenu().queryById("nearby"),B.setText(w),B.setDisabled("tsne"===this.getApiParam("analysis")),this.getChartMenu().on("click",function(N,P){void 0!==P&&(N=C.record.get("term"),"nearby"===P.getItemId()?this.getNearbyForTerm(N):this.removeTerm(N))},this,{single:!0}),this.getChartMenu().showAt(v))},this)},scope:this}};a=Ext.create("Ext.chart.CartesianChart",a);this.queryById("chartParent").insert(0,a);this.queryById("chartParent").unmask();
this.doLabels();null!==this.getNewTerm()&&(this.selectTerm(this.getNewTerm()[0]),this.setNewTerm(null))},getDefaultDocColor:function(a){return this.getApplication().getColor(6,a)},doLabels:function(){var a=this.queryById("chart"),b=a.getSeries();a=a.getSurface("chart").getItems()[0];var c=this.getApiParam("label");-1<c.indexOf("summary")?a.show():a.hide();-1<c.indexOf("terms")?b[0].getLabel().show():b[0].getLabel().hide();-1<c.indexOf("docs")?b[1].getLabel().show():b[1].getLabel().hide()},selectTerm:function(a,
b){var c=this.down("#chart");if(null!==c)if(void 0===a)c.getSeries()[0].setHighlightItem(null),c.getSeries()[1].setHighlightItem(null);else{if(!0===b){var d=c.getSeries()[1];a=d.getStore().findExact("title",a)}else d=c.getSeries()[0],a=d.getStore().findExact("term",a);if(-1!==a){var e=d.getStore().getAt(a),f=d.getSprites()[0];e={series:d,category:d.getItemInstancing()?"items":"markers",index:a,record:e,field:d.getYField(),sprite:f};d.setHighlightItem(e);b?c.getSeries()[0].setHighlightItem(null):c.getSeries()[1].setHighlightItem(null);
b=this.getPointFromIndex(d,a);this.setHighlightData({x:b[0],y:b[1],r:50});null==this.getHighlightTask()&&this.setHighlightTask(Ext.TaskManager.newTask({run:this.doHighlight,scope:this,interval:25,repeat:this.getHighlightData().r}));this.getHighlightTask().restart()}}},getPointFromIndex:function(a,b){a=a.getSprites()[0];return null!==a.surfaceMatrix?a.attr.matrix.clone().prependMatrix(a.surfaceMatrix).transformPoint([a.attr.dataX[b],a.attr.dataY[b]]):[0,0]},doHighlight:function(){var a=this.down("#chart");
if(0<this.getHighlightData().r){for(var b=a.getSurface(),c=null,d=b.getItems(),e=0;e<d.length;e++){var f=d[e];if("customHighlight"==f.id){c=f;break}}null==c?b.add({id:"customHighlight",type:"circle",strokeStyle:"red",fillStyle:"none",radius:this.getHighlightData().r,x:this.getHighlightData().x,y:this.getHighlightData().y}):(c.setAttributes({x:this.getHighlightData().x,y:this.getHighlightData().y,radius:this.getHighlightData().r}),this.getHighlightData().r-=1.5,0>=this.getHighlightData().r&&(this.getHighlightData().r=
0,b.remove(c,!0)));a.redraw()}},filterChart:function(a){Ext.isString(a)&&(a=[a]);for(var b=[],c=0;c<a.length;c++)b.push(new RegExp(a[c]));a=this.queryById("chart");c=a.getSeries()[0];var d=c.getLabel();c.getStore().each(function(e){var f=!1;if(0==b.length)f=!0;else for(var g=0;g<b.length&&!(f=f||b[g].test(e.get("term")));g++);e.set("disabled",!f);e=e.store.indexOf(e);d.setAttributesFor(e,{hidden:!f})},this);a.redraw()},getCurrentTerms:function(){var a=[];this.getTermStore().each(function(b){"term"===
b.get("category")&&a.push(b.get("term"))});return a},getNearbyForTerm:function(a){var b=Math.max(2E3,Math.round(this.getCorpus().getWordTokensCount()/100));this.setApiParams({limit:b,target:a});this.loadFromApis();this.setApiParam("target",void 0)},removeTerm:function(a){var b=this.down("#chart").getSeries()[0],c=b.getStore().findExact("term",a);b.getStore().removeAt(c);c=this.getTermStore().findExact("term",a);this.getTermStore().removeAt(c);a=this.getTermStore().getCount();this.queryById("limit").setRawValue(a)},
loadFromApis:function(a){this.queryById("chartParent").mask(this.localize("analyzing"));var b={},c=this.getCurrentTerms();null!==this.getNewTerm()&&(c=c.concat(this.getNewTerm()),this.setApiParam("limit",c.length));0<c.length&&(null!==this.getNewTerm()||a)&&(b.query=c.join(","));Ext.apply(b,this.getApiParams());null!=b.target&&(b.term=c);"pca"===b.analysis?this.getPcaStore().load({params:b}):"tsne"===b.analysis?this.getTsneStore().load({params:b}):"docSim"===b.analysis?this.getDocSimStore().load({params:b}):
this.getCaStore().load({params:b})},interpolate:function(a,b,c,d,e){return d+(e-d)*Math.max(0,Math.min(1,(a-b)/(c-b)))}});Ext.define("Ext.chart.series.CustomScatter",{extend:"Ext.chart.series.Scatter",alias:"series.customScatter",type:"customScatter",seriesType:"scatterSeries",tipsDisabled:!1,enableToolTips:function(){this.tipsDisabled=!1},disableToolTips:function(){this.tipsDisabled=!0},showTip:function(a,b){this.tipsDisabled||this.callParent(arguments)}});Ext.define("Voyant.panel.StreamGraph",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.streamgraph",statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,withDistributions:"relative",bins:50,docIndex:void 0,docId:void 0},glyph:"xf1fe@FontAwesome"},config:{visLayout:void 0,vis:void 0,mode:"corpus",layerData:void 0,graphId:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},graphMargin:{top:20,right:60,bottom:110,left:80},MODE_CORPUS:"corpus",MODE_DOCUMENT:"document",
constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setGraphId(Ext.id(null,"streamgraph_"))},initComponent:function(){Ext.apply(this,{title:this.localize("title"),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:["->",{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark","active"]}),listeners:{itemclick:function(a,b,c,d){a=Ext.fly(c.firstElementChild).hasCls("x-legend-inactive");b.set("active",a);b=this.getCurrentTerms();
this.setApiParams({query:b,limit:b.length,stopList:void 0,categories:this.getApiParam("categories")});this.loadFromCorpus()},scope:this}},"->"]}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{xtype:"button",text:this.localize("clearTerms"),handler:function(){this.setApiParams({query:void 0});this.loadFromRecords([])},scope:this},{xtype:"corpusdocumentselector",singleSelect:!0},{text:this.localize("freqsMode"),glyph:"xf201@FontAwesome",tooltip:this.localize("freqsModeTip"),menu:{items:[{text:this.localize("relativeFrequencies"),
checked:!0,itemId:"relative",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","relative"),this.loadFromCorpus())},scope:this},{text:this.localize("rawFrequencies"),checked:!1,itemId:"raw",group:"freqsMode",checkHandler:function(a,b){b&&(this.setApiParam("withDistributions","raw"),this.loadFromCorpus())},scope:this}]}},{xtype:"slider",itemId:"segmentsSlider",fieldLabel:this.localize("segments"),labelAlign:"right",labelWidth:70,width:150,increment:10,minValue:10,
maxValue:300,listeners:{afterrender:function(a){a.setValue(this.getApiParam("bins"))},changecomplete:function(a,b){this.setApiParams({bins:b});this.loadFromCorpus()},scope:this}}]}});this.on("loadedCorpus",function(a,b){1==this.getCorpus().getDocumentsCount()&&this.getMode()!=this.MODE_DOCUMENT&&this.setMode(this.MODE_DOCUMENT);"bins"in this.getModifiedApiParams()||this.getMode()!=this.MODE_CORPUS||(a=b.getDocumentsCount(),this.setApiParam("bins",100<a?100:a));this.isVisible()&&this.loadFromCorpus()},
this);this.on("corpusSelected",function(a,b){a.isXType("corpusdocumentselector")&&(this.setMode(this.MODE_CORPUS),this.setApiParams({docId:void 0,docIndex:void 0}),this.setCorpus(b),this.loadFromCorpus())});this.on("documentSelected",function(a,b){a=b.getId();this.setApiParam("docId",a);this.loadFromDocumentTerms()},this);this.on("query",function(a,b){a=this.getCurrentTerms();a.push(b);this.setApiParams({query:a,limit:a.length,stopList:void 0});this.getMode()===this.MODE_DOCUMENT?this.loadFromDocumentTerms():
this.loadFromCorpusTerms(this.getCorpus().getCorpusTerms())},this);this.on("resize",this.resizeGraph,this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},loadFromCorpus:function(){var a=this.getCorpus();this.getApiParam("docId")||this.getApiParam("docIndex")?this.loadFromDocumentTerms():1==a.getDocumentsCount()?this.loadFromDocument(a.getDocument(0)):this.loadFromCorpusTerms(a.getCorpusTerms())},loadFromCorpusTerms:function(a){var b=this.getApiParams("limit stopList query withDistributions bins categories".split(" "));
b.bins&&b.bins>this.getCorpus().getDocumentsCount()&&(b.bins=this.getCorpus().getDocumentsCount());a.load({callback:function(c,d,e){e?(this.setMode(this.MODE_CORPUS),this.loadFromRecords(c)):Voyant.application.showResponseError(this.localize("failedGetCorpusTerms"),d)},scope:this,params:b})},loadFromDocument:function(a){if(a.then){var b=this;a.then(function(c){b.loadFromDocument(c)})}else"Voyant.data.model.Document"==Ext.getClassName(a)&&(this.setApiParams({docIndex:void 0,query:void 0,docId:a.getId()}),
this.isVisible()&&this.loadFromDocumentTerms())},loadFromDocumentTerms:function(a){this.getCorpus()&&(a=a||this.getCorpus().getDocumentTerms({autoLoad:!1}),a.load({callback:function(b,c,d){d?(this.setMode(this.MODE_DOCUMENT),this.loadFromRecords(b)):Voyant.application.showResponseError(this.localize("failedGetDocumentTerms"),c)},scope:this,params:this.getApiParams("docId docIndex limit stopList query withDistributions bins categories".split(" "))}))},loadFromRecords:function(a){var b=[],c=[];a.forEach(function(d,
e){e=d.getTerm();d=d.get("distributions");for(var f=0;f<d.length;f++)void 0===c[f]&&(c[f]={}),c[f][e]=d[f];b.push({id:e,name:e,mark:this.getApplication().getColorForTerm(e,!0),active:!0})},this);this.setLayerData(c);this.down("[xtype=legend]").getStore().loadData(b);this.doLayout()},doLayout:function(a){a=this.getLayerData();if(void 0!==a){var b=this,c=[];this.down("[xtype=legend]").getStore().each(function(n){c.push(n.getId())});if(this.getMode()===this.MODE_DOCUMENT)var d=this.getApiParam("bins");
else{d=this.getApiParam("bins");var e=this.getCorpus().getDocumentsCount();d=d<e?d:e}this.getVisLayout().keys(c);e=this.getVisLayout()(a);a=this.body.down("svg").getWidth()-this.graphMargin.left-this.graphMargin.right;var f=d3.scaleLinear().domain([0,d-1]).range([0,a]),g=d3.min(e,function(n){return d3.min(n,function(r){return r[0]})}),h=d3.max(e,function(n){return d3.max(n,function(r){return r[1]})});d=this.body.down("svg").getHeight()-this.graphMargin.top-this.graphMargin.bottom;var k=d3.scaleLinear().domain([g,
h]).range([d,0]),l=d3.area().x(function(n,r){return f(r)}).y0(function(n){return k(n[0])}).y1(function(n){return k(n[1])}).curve(d3.curveCatmullRom);if(this.getMode()===this.MODE_CORPUS){var m=[];this.getCorpus().getDocuments().each(function(n){m.push(n.getTinyLabel())});g=d3.scalePoint().domain(m).range([0,a]);h=d3.axisBottom(g)}else h=d3.axisBottom(f);g=d3.axisLeft(k);e=this.getVis().selectAll("path").data(e,function(n){return n});e.attr("d",function(n){return l(n)}).style("fill",function(n){return b.getApplication().getColorForTerm(n.key,
!0)}).select("title").text(function(n){return n.key});e.enter().append("path").attr("d",function(n){return l(n)}).style("fill",function(n){return b.getApplication().getColorForTerm(n.key,!0)}).append("title").text(function(n){return n.key});e.exit().remove();this.getVis().selectAll("g.axis").remove();this.getVis().append("g").attr("class","axis x").attr("transform","translate(0,"+d+")").call(h);this.getMode()===this.MODE_CORPUS?(this.getVis().select("g.axis.x").selectAll("text").each(function(){d3.select(this).attr("text-anchor",
"end").attr("transform","rotate(-45)")}),e=this.localize("documents")):e=this.localize("documentSegments");this.getVis().select("g.axis.x").append("text").attr("text-anchor","middle").attr("transform","translate("+a/2+", "+(this.graphMargin.bottom-30)+")").attr("fill","#000").text(e);this.getVis().append("g").attr("class","axis y").attr("transform","translate(0,0)").call(g);a="raw"===this.getApiParam("withDistributions")?this.localize("rawFrequencies"):this.localize("relativeFrequencies");this.getVis().select("g.axis.y").append("text").attr("text-anchor",
"middle").attr("transform","translate(-"+(this.graphMargin.left-20)+", "+d/2+") rotate(-90)").attr("fill","#000").text(a)}},getCurrentTerms:function(){var a=[];this.down("[xtype=legend]").getStore().each(function(b){b.get("active")&&a.push(b.get("name"))},this);return a},initGraph:function(){if(void 0===this.getVisLayout()){var a=this.getLayout().getRenderTarget();this.setVisLayout(d3.stack().offset(d3.stackOffsetWiggle).order(d3.stackOrderInsideOut));this.setVis(d3.select(a.dom).append("svg").attr("id",
this.getGraphId()).append("g").attr("transform","translate("+this.graphMargin.left+","+this.graphMargin.top+")"));this.resizeGraph()}},resizeGraph:function(){var a=this.body,b=a.getWidth(),c=a.getHeight();d3.select(a.dom).select("svg").attr("width",b).attr("height",c);this.doLayout()}});Ext.define("Voyant.panel.Summary",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.summary",statics:{i18n:{},api:{stopList:"auto",start:0,limit:5,numberOfDocumentsForDistinctiveWords:10},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}]},autoScroll:!0,cls:"corpus-summary",constructor:function(a){Ext.apply(this,{title:this.localize("title"),items:{itemId:"main",cls:"main",margin:10},dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{fieldLabel:this.localize("items"),labelWidth:40,width:120,xtype:"slider",increment:5,minValue:5,maxValue:59,listeners:{afterrender:function(b){b.setValue(this.getApiParam("limit"))},changecomplete:function(b,c){this.setApiParams({limit:c});this.loadSummary()},scope:this}}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("afterrender",function(){this.body.addListener("click",function(b){(b=b.getTarget(null,null,!0))&&"A"==b.dom.tagName&&
(b.hasCls("document-id")?(b=b.getAttribute("val","voyant"),b=this.getCorpus().getDocuments().getById(b),this.dispatchEvent("documentsClicked",this,[b])):b.hasCls("corpus-type")?this.dispatchEvent("termsClicked",this,[b.getHtml()]):b.hasCls("document-type")&&this.dispatchEvent("documentIndexTermsClicked",this,[{term:b.getHtml(),docIndex:b.getAttribute("docIndex","voyant")}]))},this)});this.on("loadedCorpus",function(b,c){if(this.rendered)this.loadSummary();else this.on("afterrender",function(){this.loadSummary()},
this)});a&&a.corpus&&this.fireEvent("loadedCorpus",this,a.corpus);this.on("resize",function(){var b=this.getWidth()-200;this.query("sparklineline").forEach(function(c){c.getWidth()>b&&c.setWidth(b)})},this)},loadSummary:function(){var a=this,b=this.queryById("main");b.removeAll();b.add({html:this.getCorpus().getString()});var c=this.getCorpus().getDocuments().getRange(),d=this.getApiParam("limit");if(1<c.length){c.sort(function(h,k){return k.getLexicalTokensCount()-h.getLexicalTokensCount()});var e=
new Ext.XTemplate('<tpl for="." between="; "><a href="#" onclick="return false" class="document-id" voyant:val="{id}" data-qtip="{title}">{shortTitle}</a><span style="font-size: smaller"> (<span class="info-tip" data-qtip="{valTip}">{val}</span>)</span></a></tpl>');if(25>c.length)var f=4*c.length;else 50>c.length?f=2*c.length:100<c.length&&(f=b.getWidth()-200,f=f<c.length?c.length:f);var g=this.localize("numberOfTerms");b.add({cls:"section",items:[{layout:"hbox",align:"bottom",items:[{html:this.localize("docsLength"),
cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(h){return h.getLexicalTokensCount()}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(h,k){return"("+k+") "+this.panel.getCorpus().getDocument(h).getTitle()},panel:a}),height:16,width:f}]},{html:"<ul><li>"+this.localize("longest")+" "+e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(h){return{id:h.getId(),shortTitle:h.getShortTitle(),
title:h.getTitle(),val:h.getLexicalTokensCount(),valTip:g}}))+"</li><li>"+this.localize("shortest")+" "+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(h){return{id:h.getId(),shortTitle:h.getShortTitle(),title:h.getTitle(),val:h.getLexicalTokensCount(),valTip:g}}))+"</li>"}]});c.sort(function(h,k){return k.getLexicalTypeTokenRatio()-h.getLexicalTypeTokenRatio()});b.add({cls:"section",items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("docsDensity"),
cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(h){return Ext.util.Format.number(h.getLexicalTypeTokenRatio(),"0.000")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(h,k){return"("+k+") "+this.panel.getCorpus().getDocument(h).getTitle()},panel:a}),height:16,width:f}]},{html:"<ul><li>"+this.localize("highest")+e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(h){return{id:h.getId(),
shortTitle:h.getShortTitle(),title:h.getTitle(),val:Ext.util.Format.number(h.getLexicalTypeTokenRatio(),"0.000"),valTip:g}}))+"</li><li>"+this.localize("lowest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(h){return{id:h.getId(),shortTitle:h.getShortTitle(),title:h.getTitle(),val:Ext.util.Format.number(h.getLexicalTypeTokenRatio(),"0.000"),valTip:g}}))+"</li>"}]});c.sort(function(h,k){return k.getAverageWordsPerSentence()-h.getAverageWordsPerSentence()});b.add({cls:"section",
items:[{layout:"hbox",align:"bottom",cls:"section",items:[{html:this.localize("averageWordsPerSentence"),cls:"header"},{xtype:"sparklineline",values:this.getCorpus().getDocuments().getRange().map(function(h){return Ext.util.Format.number(h.getAverageWordsPerSentence(),"0.0")}),tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(h,k){return"("+k+") "+this.panel.getCorpus().getDocument(h).getTitle()},panel:a}),height:16,width:f}]},{html:"<ul><li>"+this.localize("highest")+
e.apply(c.slice(0,c.length>d?d:parseInt(c.length/2)).map(function(h){return{id:h.getId(),shortTitle:h.getShortTitle(),title:h.getTitle(),val:Ext.util.Format.number(h.getAverageWordsPerSentence(),"0.0"),valTip:g}}))+"</li><li>"+this.localize("lowest")+e.apply(c.slice(-(c.length>d?d:parseInt(c.length/2))).reverse().map(function(h){return{id:h.getId(),shortTitle:h.getShortTitle(),title:h.getTitle(),val:Ext.util.Format.number(h.getAverageWordsPerSentence(),"0.0"),valTip:g}}))+"</li>"}]})}else if(d=c[0])b.add({cls:"section",
html:"<b>"+this.localize("docsDensity")+"</b> "+Ext.util.Format.number(d.getLexicalTypeTokenRatio(),"0.000")}),b.add({cls:"section",html:"<b>"+this.localize("averageWordsPerSentence")+"</b> "+Ext.util.Format.number(d.getAverageWordsPerSentence(),"0.0")});b.add({html:this.localize("mostFrequentWords"),cls:"section",listeners:{afterrender:function(h){h.mask(a.localize("loading"));a.getCorpus().getCorpusTerms().load({params:{limit:a.getApiParam("limit"),stopList:a.getApiParam("stopList"),forTool:"summary"},
callback:function(k,l,m){m&&k&&0<k.length&&(h.unmask(),Ext.dom.Helper.append(h.getTargetEl().first().first(),(new Ext.XTemplate('<tpl for="." between="; "><a href="#" onclick="return false" class="corpus-type keyword" voyant:recordId="{id}">{term}</a><span style="font-size: smaller"> ({val})</span></tpl>')).apply(k.map(function(n){return{id:n.getId(),term:n.getTerm(),val:n.getRawFreq()}}))))}})}},scope:this});1<c.length&&b.add({html:this.localize("distinctiveWords")+"<ol></ol>",cls:"section",itemId:"distinctiveWords",
listeners:{afterrender:function(h){a.showMoreDistinctiveWords()}},scope:this})},showMoreDistinctiveWords:function(){var a=this.queryById("distinctiveWords"),b=a.getTargetEl().selectNode("ol"),c=Ext.dom.Query.select("li:not(.more)",b).length,d=parseInt(this.getApiParam("numberOfDocumentsForDistinctiveWords")),e=this.getCorpus().getDocuments().getRange(c,c+d-1);if(e&&Ext.isArray(e)){var f=[];e.forEach(function(g){f.push(g.getIndex())});0<f.length&&this.getCorpus().getDocumentTerms().load({addRecords:!0,
params:{docIndex:f,perDocLimit:parseInt(this.getApiParam("limit")),limit:d*parseInt(this.getApiParam("limit")),stopList:this.getApiParam("stopList"),sort:"TFIDF",dir:"DESC",forTool:"summary"},scope:this,callback:function(g,h,k){var l={};if(k&&g&&Ext.isArray(g)){g.forEach(function(r,u,q){u=r.getDocIndex();u in l||(l[u]=[]);l[u].push({id:r.getId(),docIndex:r.getDocIndex(),type:r.getTerm(),val:Ext.util.Format.number(r.get("rawFreq"),"0,000"),docId:r.get("docId")})});f.forEach(function(r){if(l[r]){var u=
this.getCorpus().getDocument(r);m=l[r].length;Ext.dom.Helper.append(b,{tag:"li","voyant:index":String(r),html:'<a href="#" onclick="return false" class="document-id document-id-distinctive" voyant:val="'+u.get("id")+'">'+u.getShortTitle()+"</a>"+this.localize("colon")+" "+(new Ext.XTemplate(this.localize("documentType"))).apply({types:l[r]})+"."})}},this);a.updateLayout();var m=d;remaining=this.getCorpus().getDocuments().getTotalCount()-c-f.length;if(0<remaining){g=new Ext.Template(this.localize("moreDistinctiveWords"));
var n=Ext.dom.Helper.append(b,{tag:"li",cls:"more",html:g.apply([m>remaining?remaining:m,remaining])},!0);n.on("click",function(){n.remove();this.showMoreDistinctiveWords()},this)}}}})}}});Ext.define("Voyant.panel.TextualArc",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.textualarc",statics:{i18n:{},api:{stopList:"auto",docIndex:0,speed:50,minRawFreq:2},glyph:"xf06e@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"container",items:{xtype:"numberfield",name:"minRawFreq",minValue:1,maxValue:10,value:2,labelWidth:150,labelAlign:"right",initComponent:function(){var a=this.up("window").panel;this.fieldLabel=a.localize(this.fieldLabel);this.on("afterrender",
function(b){Ext.tip.QuickTipManager.register({target:b.getEl(),text:a.localize("minRawFreqTip")})});this.on("beforedestroy",function(b){Ext.tip.QuickTipManager.unregister(b.getEl())});this.callParent(arguments)},fieldLabel:"minRawFreq"}}],perim:[],diam:void 0},tokensFetch:500,constructor:function(){this.mixins["Voyant.util.Localization"].constructor.apply(this,arguments);this.config.options[1].fieldLabel=this.localize(this.config.options[1].fieldLabel);Ext.apply(this,{title:this.localize("title"),
html:'<canvas width="800" height="600"></canvas>',dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"combo",itemId:"search",queryMode:"local",displayField:"term",valueField:"term",width:90,emptyText:this.localize("search"),forceSelection:!0,disabled:!0},{xtype:"documentselectorbutton",singleSelect:!0},{xtype:"slider",fieldLabel:this.localize("speed"),labelAlign:"right",labelWidth:40,width:100,increment:1,minValue:0,maxValue:100,value:30,listeners:{render:function(a){a.setValue(parseInt(this.getApiParam("speed")));
Ext.tip.QuickTipManager.register({target:a.getEl(),text:this.localize("speedTip")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getEl())},changecomplete:function(a,b){this.setApiParam("speed",b);this.isReading=0!==b;this.draw()},scope:this}},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}]});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(a){var b=this.getTargetEl().dom.querySelector("canvas");
this.draw(b);b.addEventListener("mousemove",function(c){if(a.documentTerms){var d=b.getBoundingClientRect(),e=c.clientX-d.left,f=c.clientY-d.top,g={};a.documentTerms.each(function(h){var k=h.get("x"),l=h.get("y");if(k>e-15&&k<e+15&&l>f-15&&l<f+15)return g[h.getTerm()]=!0,!1});if(0!=Object.keys(a.currentTerms||{}).length||0!=Object.keys(g).length)a.currentTerms=g,a.draw(b)}},!1)});this.on("loadedCorpus",function(a,b){this.loadDocument()},this);this.on("documentselected",function(a,b){this.setApiParam("docIndex",
this.getCorpus().getDocument(b).getIndex());this.loadDocument()});this.on("resize",function(){var a=this.getTargetEl().getWidth()-20-20,b=this.getTargetEl().getHeight()-20-20,c=Math.max(a,b),d=c/2,e=Math.min(a,b)/c,f=this.getTargetEl().dom.querySelector("canvas");f.width=this.getTargetEl().getWidth();f.height=this.getTargetEl().getHeight();this.setDiam(c);this.setPerim([]);for(f=parseInt(.75*c);this.getPerim().length<c;)this.getPerim().push({x:20+a/2+d*(a>b?1:e)*Math.cos(2*Math.PI*f/c),y:20+b/2+d*
(b>a?1:e)*Math.sin(2*Math.PI*f/c)}),f++==c&&(f=0)})},draw:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");b=b||a.getContext("2d");b.clearRect(0,0,a.width,a.height);b.fillStyle="rgba(0,0,0,.1)";this.getPerim().forEach(function(d,e){0==e%3&&b.fillRect(d.x-5,d.y,10,1)});if(this.documentTerms&&(this.drawTerms(a,b),this.drawReading(a,b),this.isReading)){var c=this;setTimeout(function(){c.draw()},10)}},drawReading:function(a,b){b=b||this.getTargetEl().dom.querySelector("canvas").getContext("2d");
var c=2E3-1999*parseInt(this.getApiParam("speed"))/100;if(this.isReading&&this.documentTerms){var d=parseInt(this.readingIndex*this.getPerim().length/this.lastToken);b.fillStyle="purple";b.fillRect(this.getPerim()[d].x,this.getPerim()[d].y,5,5);var e=void 0==this.readingStartTime;this.readingStartTime=this.readingStartTime||(new Date).getTime();d=this.readingStartTime+c-(new Date).getTime();if(this.sourceTerm&&this.targetTerm){if(e||0>=d){this.previousBeziers=this.previousBeziers||[];e=this.sourceTerm.get("x");
var f=this.sourceTerm.get("y"),g=this.targetTerm.get("x"),h=this.targetTerm.get("y");this.previousTerm&&this.previousTerm.get("x");this.previousTerm&&this.previousTerm.get("y");var k=Math.max(100,.5*Math.abs(e-g)),l=Math.max(100,.5*Math.abs(f-h));this.previousBeziers.unshift([e,f,e>g?e-k:e+k,h>f?f+l:f-l,g,h]);10<this.previousBeziers.length&&this.previousBeziers.pop()}for(e=0;e<this.previousBeziers.length;e++)b.strokeStyle="rgba(0,0,255,"+(1-.1*e)+")",this.drawBezierSplit.apply(this,Ext.Array.merge([b],
this.previousBeziers[e],[e+1==this.previousBeziers.length?1-d/c:0],[0==e?1-d/c:1]));0>=d&&(this.readingStartTime=void 0,this.read())}e=this.readingIndex+1;for(f=this.tokens.getCount();e<f&&this.tokens.getAt(e).getTerm().toLowerCase()!=this.targetTerm.getTerm();e++);c=e-parseInt(d*(e-this.readingIndex)/c);for(d=this.tokens.getCount();c<e&&!(c<d&&this.tokens.getAt(c).isWord());c++);c=this.tokens.getRange(c,f=Math.min(this.readingIndex+50,this.tokens.getCount())).map(function(m){return m.getTerm()});
b.font="14px sans-serif";b.fillStyle="rgba(0,0,0,.5)";b.textAlign="left";b.fillText(c.join(""),a.width/4,a.height-5);b.clearRect(.75*a.width,a.height-20,a.width,30)}else this.documentTerms&&this.documentTerms.getCount()<this.documentTerms.getTotalCount()&&(c=a.width/4,b.strokeStyle="rgba(0,0,0,.5)",b.fillStyle="rgba(0,0,0,.2)",b.strokeRect(c,a.height-12,2*c,10),b.fillRect(c,a.height-12,this.documentTerms.getCount()*c*2/this.documentTerms.getTotalCount(),10))},drawTerms:function(a,b){a=a||this.getTargetEl().dom.querySelector("canvas");
b=b||a.getContext("2d");b.textAlign="center";this.documentTerms&&0<this.getPerim().length&&this.documentTerms.each(function(c){var d=c.getRawFreq(),e=c.getTerm(),f=c.get("x"),g=c.get("y");isCurrentTerm=this.currentTerms&&e in this.currentTerms;isReadingTerm=this.sourceTerm&&this.sourceTerm.getTerm()==e;b.font=10*a.width/800*Math.log(d)/Math.log(this.maxRawFreq)+(isCurrentTerm||isReadingTerm?10:5)+"px sans-serif";b.fillStyle=isCurrentTerm?"red":isReadingTerm?"blue":"rgba(0,0,0,"+(.9*d/this.maxRawFreq+
.1)+")";if(isCurrentTerm||isReadingTerm)b.strokeStyle=isCurrentTerm?"rgba(255,0,0,.2)":"rgba(0,255,0,.4)",c.getDistributions().forEach(function(h,k){0<h&&this.getPerim()[k]&&(b.beginPath(),b.moveTo(f,g),b.lineTo(this.getPerim()[k].x,this.getPerim()[k].y),b.stroke())},this);b.fillText(e,f,g)},this)},read:function(a){Ext.isNumber(a)?this.readingIndex=a:this.readingIndex++;this.sourceTerm&&(this.previousTerm=this.sourceTerm);a=this.readingIndex;for(var b=this.tokens.getCount();a<b;a++){var c=this.tokens.getAt(a);
c=c.getTerm().toLowerCase();if(c in this.termsMap&&(this.sourceTerm=this.termsMap[c],1<=this.sourceTerm.getRawFreq())){this.readingIndex=a;break}}a=this.readingIndex+1;for(b=this.tokens.getCount();a<b&&!(c=this.tokens.getAt(a),c=c.getTerm().toLowerCase(),c in this.termsMap&&(this.targetTerm=this.termsMap[c],1<=this.targetTerm.getRawFreq()));a++);!this.tokensLoading&&this.tokens.getCount()-this.readingIndex<this.tokensFetch&&this.fetchMoreTokens();this.draw()},loadDocument:function(){this.documentTerms&&
(this.documentTerms.destroy(),this.documentTerms=void 0);this.termsMap={};this.draw();var a=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex")));this.up("tabpanel")||this.setTitle(this.localize("title")+" <span class='subtitle'>"+a.getFullLabel()+"</span>");this.lastToken=parseInt(a.get("lastTokenStartOffset-lexical"));this.documentTerms=a.getDocumentTerms({proxy:{extraParams:{stopList:this.getApiParam("stopList"),bins:this.getDiam(),withDistributions:"raw",minRawFreq:parseInt(this.getApiParam("minRawFreq"))}}});
a=this.queryById("search");a.setDisabled(!0);a.setStore(this.documentTerms);this.fetchMoreDocumentTerms()},fetchMoreDocumentTerms:function(){this.documentTerms?this.documentTerms.load({params:{start:this.documentTerms.getCount(),limit:0==this.documentTerms.getCount()?10:250},callback:function(a){0<a.length?(this.maxRawFreq=this.documentTerms.max("rawFreq"),a.forEach(function(b){var c=y=0;b.get("distributions").forEach(function(d,e){c+=this.getPerim()[e].x*d;y+=this.getPerim()[e].y*d},this);b.set("x",
c/b.getRawFreq());b.set("y",y/b.getRawFreq())},this),Ext.Function.defer(this.fetchMoreDocumentTerms,0,this),this.draw()):(this.queryById("search").setDisabled(!1),this.termsMap={},this.documentTerms.each(function(b){this.termsMap[b.getTerm()]=b},this),this.tokens&&this.tokens.removeAll(!0),this.fetchMoreTokens())},addRecords:!0,scope:this}):this.loadDocument()},fetchMoreTokens:function(){if(!this.tokens)this.tokens=this.getCorpus().getDocument(parseInt(this.getApiParam("docIndex"))).getTokens({proxy:{extraParams:{stripTags:"all"}}}),
this.noMoreTokens=!1;else if(this.noMoreTokens)return;var a=0==this.tokens.getCount();this.tokensLoading=!0;var b=parseInt(this.getApiParam("speed"));this.tokens.load({params:{start:this.tokens.getCount(),limit:50==b&&a?200:Math.pow(110-b,2)},callback:function(c){this.tokensLoading=!1;0<c.length?(c.forEach(function(d){"other"==d.getTokenType()&&d.set("term",d.getTerm().replace(/\s+/g," "))}),a&&(this.previousBeziers=[],this.isReading=!0,this.read(0))):this.noMoreTokens=!0},addRecords:!0,scope:this})},
animatePathDrawing:function(a,b,c,d,e,f,g,h){var k=null,l=function(m){null===k&&(k=m);m=Math.min((m-k)/h,1);a.clearRect(0,0,a.canvas.width,a.canvas.height);drawBezierSplit(a,b,c,d,e,f,g,0,m);1>m&&window.requestAnimationFrame(l)};window.requestAnimationFrame(l)},drawBezierSplit:function(a,b,c,d,e,f,g,h,k){a.beginPath();if(0==h&&1==k)a.moveTo(b,c),a.quadraticCurveTo(d,e,f,g);else if(h!=k){var l=h*h,m=1-h,n=m*m,r=2*h*m,u=n*b+r*d+l*f,q=n*c+r*e+l*g;l=k*k;m=1-k;n=m*m;r=2*k*m;m=n*b+r*d+l*f;l=n*c+r*e+l*g;
b=this.lerp(this.lerp(b,d,h),this.lerp(d,f,h),k);c=this.lerp(this.lerp(c,e,h),this.lerp(e,g,h),k);a.moveTo(u,q);a.quadraticCurveTo(b,c,m,l)}a.stroke();a.closePath()},lerp:function(a,b,c){return(1-c)*a+c*b}});Ext.define("Voyant.panel.TopicContexts",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.topiccontexts",statics:{i18n:{},api:{},glyph:"xf06e@FontAwesome"},constructor:function(a){Ext.apply(this,{title:this.localize("title"),cls:"twic_body"});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{loadedCorpus:function(a,b){this.loadFromCorpus(b)}},loadFromCorpus:function(a){a=Ext.Loader.getPath("resources")+"/twic/current/data/input/json";
var b=TWiC.Level.prototype.Instance();b.LoadJSON(a+"/twic_corpusinfo.json",a+"/twic_corpusmap.json");var c=this;b.m_queue.await(function(){var d=[],e=[],f=new TWiC.TopicBar({x:0,y:635},{width:1280,height:165},"dickinson",b,[]);e.push(f);var g=new TWiC.DocumentBar({x:1055,y:0},{width:225,height:635},"dickinson",b,[]);e.push(g);g=new TWiC.CorpusClusterView({x:0,y:0},{width:1055,height:635},"dickinson",b,[f,g]);d.push(g);f.m_linkedViews.push(g);f=c.getLayout().getRenderTarget();b.Initialize([0,0],{width:f.getWidth(),
height:f.getHeight()},"dickinson",d,e,"#"+f.getId());b.Start()}.bind(b))}});Ext.define("Voyant.panel.TermsBerry",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsberry",statics:{i18n:{},api:{stopList:"auto",context:2,numInitialTerms:75,query:void 0,docIndex:void 0,docId:void 0,categories:void 0},glyph:"xf1db@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],mode:void 0,scalingFactor:3,minRawFreq:void 0,maxRawFreq:void 0,maxCollocateValue:void 0,minFillValue:void 0,maxFillValue:void 0,currentData:{},blacklist:{},
visLayout:void 0,vis:void 0,visInfo:void 0,visId:void 0,currentNode:void 0,tip:void 0,contextMenu:void 0},MODE_TOP:"top",MODE_DISTINCT:"distinct",MIN_TERMS:5,MAX_TERMS:500,COLLOCATES_LIMIT:1E6,MIN_SCALING:1,MAX_SCALING:5,MIN_STROKE_OPACITY:.1,MAX_STROKE_OPACITY:.3,layout:"fit",constructor:function(a){this.setMode(this.MODE_TOP);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,"termspack_"))},initComponent:function(){Ext.apply(this,
{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield",clearOnQuery:!0},{xtype:"button",text:this.localize("strategy"),menu:{items:[{xtype:"menucheckitem",group:"strategy",checked:this.getMode()===this.MODE_TOP,text:this.localize("topTerms"),checkHandler:function(a,b){b&&(this.setMode(this.MODE_TOP),this.doLoad())},scope:this},{xtype:"menucheckitem",group:"strategy",checked:this.getMode()===this.MODE_DISTINCT,text:this.localize("distinctTerms"),
checkHandler:function(a,b){b&&(this.setMode(this.MODE_DISTINCT),this.doLoad())},scope:this}]}},{fieldLabel:this.localize("numTerms"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,listeners:{afterrender:function(a){a.setValue(parseInt(this.getApiParam("numInitialTerms")))},changecomplete:function(a,b){this.setApiParam("numInitialTerms",b);this.doLoad()},scope:this}},{fieldLabel:this.localize("context"),labelWidth:50,labelAlign:"right",
width:120,xtype:"slider",increment:1,minValue:1,maxValue:30,listeners:{afterrender:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParams({context:b});this.doLoad()},scope:this}},{fieldLabel:this.localize("scaling"),labelWidth:50,labelAlign:"right",width:120,xtype:"slider",increment:1,minValue:this.MIN_SCALING,maxValue:this.MAX_SCALING,listeners:{afterrender:function(a){a.setValue(this.getScalingFactor())},changecomplete:function(a,b){this.setScalingFactor(Math.abs(b-
(this.MAX_SCALING+1)));this.reload()},scope:this}}]}]});this.setContextMenu(Ext.create("Ext.menu.Menu",{renderTo:Ext.getBody(),items:[{xtype:"box",itemId:"label",margin:"5px 0px 5px 5px",html:""},{xtype:"menuseparator"},{xtype:"button",text:"Remove",style:"margin: 5px;",handler:function(a,b){a=this.getCurrentNode();void 0!==a&&(delete this.getCurrentData()[a.data.term],this.getBlacklist()[a.data.term]=!0,this.setCurrentNode(void 0));this.getContextMenu().hide();this.reload()},scope:this}]}));this.on("query",
function(a,b){0<b.length&&this.doLoad(b)},this);this.callParent(arguments)},listeners:{boxready:function(){this.initVisLayout()},resize:function(a,b,c){this.getVisLayout()&&this.getCorpus()&&(a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),a.down("svg").set({width:b,height:c}),this.getVisLayout().size([b,c]),this.reload())},loadedCorpus:function(a,b){this.isVisible()&&this.doLoad()},activate:function(){this.getCorpus()&&this.doLoad()}},doLoad:function(a){this.resetVis();void 0===
a&&(this.resetMinMax(),this.setCurrentData({}));this.getMode()===this.MODE_DISTINCT?this.getDistinctTerms(a):this.getTopTerms(a)},reload:function(){var a=this.processCollocates([]);0<a.length&&(this.resetVis(),this.buildVisFromData(a))},resetMinMax:function(){this.setMinRawFreq(void 0);this.setMaxRawFreq(void 0);this.setMaxCollocateValue(void 0);this.setMinFillValue(void 0);this.setMaxFillValue(void 0)},resetVis:function(){var a=this.getVis();a&&a.selectAll(".node").remove()},getTopTerms:function(a){var b=
parseInt(this.getApiParam("numInitialTerms")),c=this.getApiParam("stopList");void 0!==a&&(c=b=void 0);this.getCorpus().getCorpusTerms().load({params:{query:a,limit:b,stopList:c},callback:function(d,e,f){f&&this.loadFromRecords(d)},scope:this})},getDistinctTerms:function(a){var b=parseInt(this.getApiParam("numInitialTerms")),c=this.getApiParam("stopList");void 0!==a&&(c=b=void 0);var d=Math.ceil(parseInt(this.getApiParam("numInitialTerms"))/this.getCorpus().getDocumentsCount());this.getCorpus().getDocumentTerms().load({params:{query:a,
limit:b,perDocLimit:d,stopList:c,sort:"TFIDF",dir:"DESC"},callback:function(e,f,g){g&&this.loadFromRecords(e)},scope:this})},loadFromQuery:function(a){this.getCorpus().getCorpusTerms().load({params:{query:a},callback:function(b,c,d){d&&this.loadFromRecords(b)},scope:this})},loadFromRecords:function(a){if(Ext.isArray(a)&&0<a.length){var b=this.getMaxRawFreq(),c=this.getMinRawFreq(),d=this.getMinFillValue(),e=this.getMaxFillValue(),f=[];a.forEach(function(g){var h=g.getTerm();if(!this.getBlacklist()[h]){var k=
g.getRawFreq(),l=this.getMode()===this.MODE_DISTINCT?g.get("tfidf"):g.getInDocumentsCount();if(void 0===b||k>b)b=k;if(void 0===c||k<c)c=k;if(void 0===e||l>e)e=l;if(void 0===d||l<d)d=l;this.getCurrentData()[h]={term:h,rawFreq:k,relativeFreq:g.get("relativeFreq"),fillValue:l,collocates:[]};f.push(h)}},this);this.setMaxRawFreq(b);this.setMinRawFreq(c);this.setMinFillValue(d);this.setMaxFillValue(e);this.getCollocatesForQuery(f)}},getCollocatesForQuery:function(a){var b=[];for(c in this.getCurrentData())b.push(c);
this.setApiParams({mode:"corpus"});var c=this.getApiParams();this.getCorpus().getCorpusCollocates().load({params:Ext.apply(Ext.clone(c),{query:a,collocatesWhitelist:b,limit:this.COLLOCATES_LIMIT}),callback:function(d,e,f){f&&this.buildVisFromData(this.processCollocates(d))},scope:this})},processCollocates:function(a){for(var b=this.getCurrentData(),c=this.getMaxCollocateValue(),d=0;d<a.length;d++){var e=a[d],f=e.getTerm(),g=e.getContextTerm();e=e.getContextTermRawFreq();if(void 0===c||e>c)c=e;void 0!==
b[f]&&f!=g&&b[f].collocates.push({term:g,value:e})}this.setMaxCollocateValue(c);a=[];for(f in b)a.push(b[f]);return a},buildVisFromData:function(a){var b=this;if(this.getVis()){a.push({term:"$$$root$$$",collocates:[],rawFreq:1});var c=d3.stratify().id(function(h){return h.term}).parentId(function(h){return"$$$root$$$"!==h.term?"$$$root$$$":""})(a).sort(function(h,k){return h.rawFreq<k.rawFreq?1:h.rawFreq>k.rawFreq?-1:0}).sum(function(h){return Math.pow(h.rawFreq,1/b.getScalingFactor())});this.getVisLayout()(c);
c=this.getVis().selectAll(".node").data(c.descendants());c.attr("transform",function(h){return"translate("+h.x+","+h.y+")"});c.selectAll("circle").attr("r",function(h){return h.r});var d=d3.scalePow().exponent(1/3).domain([0,this.getMaxCollocateValue()]).range(["#fff","#bd3163"]);var e=this.getMode()===this.MODE_DISTINCT?d3.scalePow().exponent(.2).domain([this.getMinFillValue(),this.getMaxFillValue()]).range(["#dedede","#fff"]):d3.scaleLinear().domain([this.getMaxFillValue(),this.getMinFillValue()]).range(["#dedede",
"#fff"]);var f=this.getVisLayout().size();f=Math.min(f[0],f[1])/2;a=Math.sqrt(Math.PI*f*f/a.length/Math.PI)/3;f=Math.abs(this.getScalingFactor()-(this.MAX_SCALING+1));f=Math.max(1,f-1);f*=a;var g=d3.scaleLinear().domain([this.getMinRawFreq(),this.getMaxRawFreq()]).range([a,f]);a=c.enter().append("g").attr("class","node").style("visibility",function(h){return 0<h.depth?"visible":"hidden"}).attr("transform",function(h){return"translate("+h.x+","+h.y+")"}).on("click",function(h){b.dispatchEvent("termsClicked",
b,[h.data.term])}).on("mouseover",function(h,k){b.setCurrentNode(h);b.getVis().selectAll("circle").style("stroke-width",1).style("stroke","#111").style("fill",function(n){return e(n.data.fillValue)});d3.select(this).select("circle").style("fill","#89e1c2").style("stroke","#26926c").style("stroke-opacity",b.MAX_STROKE_OPACITY);k=b.getMode()===b.MODE_DISTINCT?b.localize("tfidf"):b.localize("inDocs");if(!b.getContextMenu().isVisible()){k="<b>"+h.data.term+"</b> ("+h.data.rawFreq+")<br/>"+k+": "+h.data.fillValue;
var l=b.getTip();l.update(k);l.show()}for(k=0;k<h.data.collocates.length;k++){var m=h.data.collocates[k];l=b.getVis().selectAll(".node").filter(function(n){return n.data.term===m.term});l.select("circle").style("fill",function(n){return d(m.value)}).style("stroke","#bd3163").style("stroke-opacity",b.MAX_STROKE_OPACITY);l.select("tspan.value").text(function(n){return m.value})}}).on("mousemove",function(){b.getTip().setPosition(d3.event.pageX+5,d3.event.pageY-50)}).on("mouseout",function(){b.getContextMenu().isVisible()||
b.setCurrentNode(void 0);b.getVis().selectAll("circle").style("stroke-opacity",b.MIN_STROKE_OPACITY).style("stroke","#111").style("fill",function(h){return e(h.data.fillValue)});b.getVis().selectAll("tspan.value").text("");b.getTip().hide()}).on("contextmenu",function(h,k){d3.event.preventDefault();b.getTip().hide();k=b.getContextMenu();k.queryById("label").setHtml(h.data.term);k.showAt(d3.event.pageX+5,d3.event.pageY-50)});a.append("circle").attr("id",function(h){return h.data.term.replace(/\W/g,
"_")}).attr("r",function(h){return h.r}).style("fill",function(h){return e(h.data.fillValue)}).style("stroke","#111").style("stroke-opacity",b.MIN_STROKE_OPACITY).style("stroke-width",1);a.append("clipPath").attr("id",function(h){return"clip-"+h.data.term.replace(/\W/g,"_")}).append("use").attr("xlink:href",function(h){return"#"+h.data.term.replace(/\W/g,"_")});a=a.append("text").attr("clip-path",function(h){return"url(#clip-"+h.data.term.replace(/\W/g,"_")+")"}).style("font-family",function(h){return b.getApplication().getCategoriesManager().getFeatureForTerm("font",
h.data.term)}).style("text-anchor","middle").style("cursor","default");a.append("tspan").attr("class","term").attr("font-size",function(h){return g(h.data.rawFreq)}).attr("x",0).attr("y",function(h){return g(h.data.rawFreq)/4}).text(function(h){return h.data.term});a.append("tspan").attr("class","value").attr("font-size",function(h){return.75*g(h.data.rawFreq)}).attr("x",0).attr("y",function(h){return g(h.data.rawFreq)+1});c.exit().remove()}},initVisLayout:function(){var a=this.getLayout().getRenderTarget();
a.update("");var b=a.getWidth(),c=a.getHeight();this.setVisLayout(d3.pack().size([b,c]).padding(1.5));a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("width",b).attr("height",c);this.setVis(a.append("g"));this.setVisInfo(a.append("text").attr("x",10).attr("y",10));void 0===this.getTip()&&this.setTip(Ext.create("Ext.tip.Tip",{}))}});Ext.define("Voyant.panel.TermsRadio",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.termsradio",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],speed:50,termsRadio:void 0},statics:{i18n:{},api:{withDistributions:!0,bins:5,visibleBins:5,docIdType:null,limit:50,mode:null,position:0,selectedWords:[],stopList:"auto",query:null,yAxisScale:"log",speed:50,slider:void 0},glyph:"xf201@FontAwesome"},constructor:function(a){var b=function(c,d,e,f,g){this.setApiParams({mode:c});
this.getTermsRadio().loadRecords(e);(c=this.getApiParam("query"))&&(0==e.length||1==e.length&&0==e[0].getRawFreq()?this.toastInfo({html:this.localize("termNotFound"),align:"bl"}):this.getTermsRadio().highlightQuery(c,!0))};this.corpusStore=Ext.create("Voyant.data.store.CorpusTerms",{listeners:{load:{fn:b.bind(this,"corpus"),scope:this}}});this.documentStore=Ext.create("Voyant.data.store.DocumentTerms",{listeners:{load:{fn:b.bind(this,"document"),scope:this}}});Ext.apply(a,{title:this.localize("title"),
legendMenu:Ext.create("Ext.menu.Menu",{items:[{text:"",itemId:"remove",glyph:"xf068@FontAwesome"}]}),tbar:new Ext.Toolbar({overflowHandler:"scroller",items:{xtype:"legend",store:new Ext.data.JsonStore({fields:["name","mark"]}),listeners:{itemclick:function(c,d,e,f){c=d.get("name");this.getTermsRadio().isTermSelected(c)?this.getTermsRadio().doTermDeselect(c):this.getTermsRadio().doTermSelect(c)},itemcontextmenu:function(c,d,e,f,g){g.preventDefault();c=g.getXY();var h=d.get("name");d=(new Ext.Template(this.localize("removeTerm"))).apply([h]);
this.legendMenu.queryById("remove").setText(d);this.legendMenu.on("click",function(k,l){void 0!==l&&this.doTermDeselect(h,!0)},this,{single:!0});this.legendMenu.showAt(c)},scope:this}}}),bbar:{overflowHandler:"scroller",items:[{xtype:"querysearchfield"},{glyph:"xf04b@FontAwesome",itemId:"play",handler:function(c){"xf04c@FontAwesome"==c.glyph?(this.getTermsRadio().continueTransition=!1,this.mask(this.localize("completingTransition")),c.setPlaying(!1)):(this.getTermsRadio().toggleRightCheck(),c.setPlaying(!0))},
scope:this,setPlaying:function(c){this.setGlyph(c?"xf04c@FontAwesome":"xf04b@FontAwesome")}},{glyph:"xf0e2@FontAwesome",tooltip:this.localize("resetTip"),listeners:{click:{fn:function(){this.queryById("play").setPlaying(!1);this.getTermsRadio().shiftCount=0;this.getTermsRadio().prepareData();this.getTermsRadio().redraw()},scope:this}}},{xtype:"label",forId:"terms",text:this.localize("terms")},{xtype:"slider",itemId:"terms",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(c){c.setValue(parseInt(this.getApiParam("limit")))},
changecomplete:function(c,d){this.setApiParams({limit:d});this.loadStore()},scope:this}},{xtype:"label",forId:"speed",text:this.localize("speed")},{xtype:"slider",itemId:"speed",hideLabel:!0,width:60,increment:5,minValue:5,maxValue:100,listeners:{afterrender:function(c){c.setValue(parseInt(this.getApiParam("speed")));this.setSpeed(c.getValue())},changecomplete:function(c,d){this.setApiParams({speed:d});this.setSpeed(d)},scope:this}},{xtype:"label",itemId:"visibleSegmentsLabel",forId:"visibleBins",
text:this.localize("visibleSegments")},{xtype:"slider",itemId:"visibleBins",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(c){c.setValue(parseInt(this.getApiParam("visibleBins")))},changecomplete:function(c,d){this.setApiParams({visibleBins:d});this.numVisPoints=d;this.loadStore();this.numVisPoints==this.getCorpus().getDocumentsCount()?this.getTermsRadio().hideSlider():"false"!=this.getApiParam("slider")&&this.getTermsRadio().showSlider()},scope:this}},{xtype:"label",
itemId:"segmentsLabel",forId:"segments",text:this.localize("segments")},{xtype:"slider",itemId:"segments",hideLabel:!0,width:60,increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(c){c.setValue(parseInt(this.getApiParam("bins")))},changecomplete:function(c,d){this.setApiParams({bins:d});this.numDataPoints=d;this.loadStore();this.queryById("visibleBins").setMaxValue(d)},scope:this}}]}});this.config.options.push({xtype:"combo",queryMode:"local",triggerAction:"all",forceSelection:!0,
editable:!1,fieldLabel:this.localize("yScale"),labelAlign:"right",name:"yAxisScale",valueField:"value",displayField:"name",store:new Ext.data.JsonStore({fields:["name","value"],data:[{name:this.localize("linear"),value:"linear"},{name:this.localize("log"),value:"log"}]}),listeners:{afterrender:function(c){c.setValue(this.getApiParam("yAxisScale"))},scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.on("boxready",function(c){c=this.getApiParam("slider");
this.setTermsRadio(new TermsRadio({parent:this,container:this.body,showSlider:void 0===c?!0:"true"===c}))},this);this.addListener("corpusTermsClicked",function(c,d){1<this.getCorpus().getDocumentsCount()&&d.forEach(function(e){e=e.getTerm();this.setApiParams({query:e});this.loadStore()})});this.addListener("documentTermsClicked",function(c,d){if(c&&c.xtype==this.xtype)return!1;d.forEach(function(e){e=e.getTerm();this.setApiParams({query:e});this.loadStore()})});this.on("query",function(c,d){this.fireEvent("termsClicked",
c,d)});this.on("termsClicked",function(c,d){d.forEach(function(e){var f;Ext.isString(e)?f=e:e.term?f=e.term:e.getTerm&&(f=e.getTerm());this.setApiParams({query:f});this.loadStore()},this)});this.on("loadedCorpus",function(c,d){this.documentStore.setCorpus(d);this.corpusStore.setCorpus(d);c=this.getApiParams();c.type&&delete c.limit;var e=this.getCorpus().getDocumentsCount(),f=this.queryById("segments"),g=this.queryById("visibleBins");"document"==c.mode||1==e?(this.setApiParam("mode","document"),d=
this.documentStore,g.setMaxValue(f.getValue())):(this.setApiParam("mode","corpus"),delete c.bins,d=this.corpusStore,f.hide(),this.queryById("segmentsLabel").hide(),g=this.queryById("visibleBins"),g.setMaxValue(e),parseInt(this.getApiParam("visibleBins")>e)&&g.setValue(e));d.on("load",function(h,k){for(h=0;3>h;h++){var l=k[h];l&&this.getTermsRadio().highlightRecord(l,!0)}},this,{single:!0});d.load({params:c})},this)},loadStore:function(){this.queryById("play").setPlaying(!1);var a=this.getApiParams();
"document"===this.getApiParam("mode")&&this.documentStore.load({params:a});"corpus"===this.getApiParam("mode")&&(delete a.bins,this.corpusStore.load({params:a}))}});Ext.define("Voyant.panel.Trends",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],requires:["Voyant.data.store.Documents"],alias:"widget.trends",config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"},{name:"bins",xtype:"slider",labelAlign:"right",width:200,minValue:2,maxValue:100,listeners:{afterrender:function(a){var b=a.up("window").panel;a.setFieldLabel(b.localize("segmentsSlider"))}}},{xtype:"radiogroup",labelAlign:"right",columns:3,vertical:!0,name:"withDistributions",items:[{boxLabel:"raw",
name:"withDistributions",inputValue:"raw"},{boxLabel:"relative",name:"withDistributions",inputValue:"relative",style:"margin-left: 1em;"}],listeners:{afterrender:function(a){var b=this.up("window").panel;this.setFieldLabel("frequencies");var c=b.getApiParam("withDistributions");a.getBoxes().forEach(function(d){d.setBoxLabel(b.localize(d.inputValue));d.checked=d.inputValue==c});this.setValue({withDistributions:c})}}},{xtype:"colorpaletteoption"}]},statics:{i18n:{},api:{limit:5,stopList:"auto",query:void 0,
withDistributions:"relative",bins:10,docIndex:void 0,docId:void 0,mode:"corpus",chartType:"barline",labels:!1},glyph:"xf201@FontAwesome"},layout:"fit",documentTermsStore:void 0,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",
items:[{xtype:"querysearchfield"},{itemId:"reset",text:this.localize("reset"),tooltip:this.localize("resetTip"),handler:function(a){this.setApiParams({docIndex:void 0,mode:void 0,query:void 0});this.loadCorpusTerms()},scope:this},{text:this.localize("display"),tooltip:this.localize("displayTip"),glyph:"xf013@FontAwesome",menu:{listeners:{afterrender:function(a){var b=this.getApiParam("chartType");a.items.each(function(c){c.getItemId()==b&&c.addCls(c.activeCls)})},scope:this},defaults:{xtype:"menuitem",
handler:function(a,b){"menucheckitem"==a.xtype?this.setApiParam("labels",a.checked):this.setApiParam("chartType",a.getItemId());this.loadCorpusTerms()},scope:this},items:[{xtype:"menucheckitem",text:this.localize("labels"),tooltip:this.localize("labelsTip"),checked:!0===this.getApiParam("labels")||"true"==this.getApiParam("labels")},"-",{itemId:"area",text:this.localize("area"),tooltip:this.localize("areaTip"),glyph:"xe76b@Sencha-Examples"},{itemId:"bar",text:this.localize("bar"),tooltip:this.localize("barTip"),
glyph:"xe768@Sencha-Examples"},{itemId:"line",text:this.localize("line"),tooltip:this.localize("lineTip"),glyph:"xe773@Sencha-Examples"},{itemId:"stacked",text:this.localize("stacked"),tooltip:this.localize("stackedTip"),glyph:"xe6c8@Sencha-Examples"},{itemId:"barline",text:this.localize("barline"),tooltip:this.localize("barlineTip"),glyph:"xe779@Sencha-Examples"}]}}]}]});this.callParent(arguments)},listeners:{loadedCorpus:function(a,b){this.loadCorpusTerms()},termsClicked:function(a,b){var c=[];
b.forEach(function(d){Ext.isString(d)?c.push(d):d.term?c.push(d.term):d.getTerm&&c.push(d.getTerm())});this.setApiParam("query",c&&0<c.length?c:void 0);this.loadCorpusTerms()},corpusTermsClicked:function(a,b){this.setApiParam("query",b.map(function(c){return c.getTerm()}));this.loadCorpusTerms()},documentSelected:function(a,b){this.setApiParam("docIndex",this.getCorpus().getDocument(b).getIndex());this.loadDocumentTerms()},documentsClicked:function(a,b){1==b.length&&this.fireEvent("documentSelected",
this,b[0])},query:function(a,b){this.fireEvent("termsClicked",this,b)}},loadCorpusTerms:function(a){if(2>this.getCorpus().getDocumentsCount()||"document"==this.getApiParam("mode")||0<Array.from(this.getApiParam("docIndex")||"").length)return this.loadDocumentTerms();if(this.getApiParam("query")){a=a||{};var b=this.getApiParam("withDistributions");Ext.applyIf(a,{bins:this.getCorpus().getDocumentsCount(),limit:100,stopList:""});var c=this.getCorpus().map(function(d){return d.getTinyTitle()});Ext.Array.unique(c).length<
c.length&&(c=c.map(function(d,e){return e+1+")"+d}));Ext.applyIf(a,this.getApiParams());this.getCorpus().getCorpusTerms().load({params:a,callback:function(d,e,f){var g=[],h=[],k=this.getApiParam("chartType");d.forEach(function(l,m){var n=l.get("term");l.get("docIndex");var r=this.getApplication().getColorForTerm(n,!0);l.get("distributions").forEach(function(u,q){g[q]||(g[q]={index:c[q]});g[q]["_"+m]="relative"==b?u.toFixed(7):u;g[q]["term"+m]=n},this);"bar"!=k&&("barline"==k?["bar","line"]:[k]).forEach(function(u){h.push({type:"stacked"==
u?"bar":u,title:n,xField:"index",yField:"_"+m,term:n,colors:[r],label:"barline"==k&&"bar"==u?{display:"none"}:{field:"term"+m}})},this)},this);e=d.map(function(l){return l.getTerm()});f=e.map(function(l){return this.getApplication().getColorForTerm(l,!0)},this);"bar"==k&&h.push({type:"bar",title:e,colors:f,xField:"index",yField:0<g.length?Object.keys(g[0]).filter(function(l){return"_"==l.charAt(0)}):void 0,label:{field:d.map(function(l,m){return"term"+m})}});d=Ext.create("Ext.data.JsonStore",{fields:0<
g.length?Object.keys(g[0]):void 0,data:g});this.buildChart({store:d,series:h,axes:[{type:"numeric",position:"left",increment:1,title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("corpusTitle")}}]})},scope:this})}else this.getCorpus().getCorpusTerms().load({params:{limit:5,stopList:this.getApiParam("stopList")},callback:function(d,e,f){0==d.length?e&&e.error?this.showError(this.localize("noResults")+"<p style='color: red'>"+
e.error+"</p>"):this.showError(this.localize("noResults")):(this.setApiParam("query",d.map(function(g){return g.getTerm()})),this.loadCorpusTerms())},scope:this})},getItemToolTip:function(a,b,c){var d=c.field.split("_"),e=2==d.length?c.index:d[2];d=parseInt(d[1]);var f=c.series.getTitle();f=Ext.isArray(f)?f[d]:f;var g=c.series.getColors();b="<span class='x-legend-item-marker' style='background:"+(1==g.length?g[0]:g[d])+"; left: 2px;'></span> <span style='padding-left: 1.2em; font-weight: bold;'>"+
f+"</span>: "+b.get(c.field)+"<br/><i>"+this.getCorpus().getDocument(e).getShortTitle()+"</i>";b="corpus"==this.getApiParam("mode")?b+("<div style='font-size: smaller'>"+this.localize("dblClickItem")):b+("<br/>"+this.localize("segment")+" "+(c.index+1));a.setHtml(b)},loadDocumentTerms:function(a){if(this.getApiParam("query")){this.setApiParam("mode","document");a=a||{};var b=this.getApiParam("withDistributions");Ext.applyIf(a,{limit:0,sort:"termasc",stopList:void 0});this.getCorpus().map(function(d){return d.getTinyTitle()});
var c=1==this.getCorpus().getDocumentsCount()?this.getCorpus().getDocument(0):this.getCorpus().getDocument(this.getApiParam("docIndex"));Ext.applyIf(a,this.getApiParams());this.getCorpus().getDocumentTerms().load({params:a,callback:function(d,e,f){var g=[],h=[],k=this.getApiParam("chartType");c||d.sort(function(m,n){return m.getTerm()==n.getTerm()?m.getDocIndex()-n.getDocIndex():m.getTerm().localeCompare(n.getTerm())});d.forEach(function(m,n){var r=m.get("term"),u=m.get("docIndex"),q=c?this.getApplication().getColorForTerm(r,
!0):this.getApplication().getColor(u,!0);u=m.get("docIndex");m.get("distributions").forEach(function(p,v){g[v]||(g[v]={docIndex:u,index:v+1});g[v]["_"+n+"_"+u]="relative"==b?p.toFixed(7):p;g[v]["term"+n]=r},this);"bar"!=k&&("barline"==k?["bar","line"]:[k]).forEach(function(p){h.push({type:"stacked"==p?"bar":p,title:c?r:u+1+") "+r,xField:"index",yField:"_"+n+"_"+u,term:r,colors:[q],label:"barline"==k&&"bar"==p?{display:"none"}:{field:"term"+n}})},this)},this);if("bar"==k){var l=Ext.Array.unique(d.map(function(m){return m.getTerm()})).length;
e=d.map(function(m){return 1+m.get("docIndex")+") "+m.getTerm()});d=d.map(function(m){return l?this.getApplication().getColor(m.get("docIndex"),!0):this.getApplication().getColorForTerm(m.getTerm(),!0)},this);h.push({type:"bar",title:0<e.length?e:this.localize("noResults"),colors:d,xField:"index",yField:0<g.length?Object.keys(g[0]).filter(function(m){return"_"==m.charAt(0)}):void 0,label:{field:e}})}d=Ext.create("Ext.data.JsonStore",{fields:0<g.length?Object.keys(g[0]):void 0,data:g});this.buildChart({store:d,
series:h,axes:[{type:"numeric",position:"left",title:{text:this.localize(this.getApiParam("withDistributions")+"Title")}},{type:"category",position:"bottom",title:{text:this.localize("segmentsTitle")+(c?" ("+c.getShortTitle()+")":"")}}]})},scope:this})}else this.getCorpus().getCorpusTerms().load({params:{limit:2>this.getCorpus().getDocumentsCount()?5:2,stopList:this.getApiParam("stopList")},callback:function(d,e,f){this.setApiParam("query",d.map(function(g){return g.getTerm()}));this.loadDocumentTerms()},
scope:this})},buildChart:function(a){var b=this.getApiParam("chartType"),c=!1;if(!0===this.getApiParam("labels")||"true"==this.getApiParam("labels"))c=!0;Ext.applyIf(a,{cls:this.getApiParam("mode")});a.series.forEach(function(e){Ext.applyIf(e,{stacked:"bar"==e.type?!1:!0,showInLegend:"barline"==b&&"line"==e.type?!1:!0,smooth:!0,showMarkers:"bar"==e.type?!1:!0,marker:"barline"==b&&"line"==e.type?null:{type:"circle",radius:2},style:{lineWidth:1,fillOpacity:"barline"==b&&"bar"==e.type?.01:1,strokeOpacity:"barline"==
b&&"bar"==e.type?.1:1},highlight:!0,highlightCfg:{scaling:"bar"==e.type?1.1:2},label:{},tooltip:{trackMouse:!0,renderer:this.getItemToolTip,scope:this},listeners:{itemclick:function(f,g,h,k){this.clickTimer&&clearTimeout(this.clickTimer);if(!this.blockClick)if(this.blockClick=!0,Ext.defer(function(){this.blockClick=!1},1E3,this),"document"==this.getApiParam("mode"))f=g.field.split("_"),h=f[2],h=this.getCorpus().getDocument(h).get("tokensCount-lexical"),h=parseInt(g.index*h/parseInt(this.getApiParam("bins"))),
this.dispatchEvent("documentIndexTermsClicked",this,[{term:g.series.term,docIndex:f[2],position:h}]);else{this.clickTimer&&clearTimeout(this.clickTimer);var l=this;this.clickTimer=setTimeout(function(){l.dispatchEvent("documentIndexTermsClicked",l,[{term:g.series.term,docIndex:g.index}])},300)}},itemdblclick:function(f,g,h,k){this.clickTimer&&clearTimeout(this.clickTimer);this.blockClick=!0;Ext.defer(function(){this.blockClick=!1},1E3,this);"document"!=this.getApiParam("mode")&&Ext.create("Ext.menu.Menu",
{items:[{text:this.localize("drillTerm"),tooltip:this.localize("drillTermTip"),handler:function(){this.setApiParams({mode:"document",query:g.series.term});this.loadDocumentTerms()},scope:this},{text:this.localize("drillDocument"),tooltip:this.localize("drillDocumentTip"),handler:function(){this.setApiParams({mode:"document",docIndex:g.index});this.loadDocumentTerms()},scope:this}],listeners:{hide:function(l){Ext.defer(function(){this.destroy()},200,l)},scope:this}}).showAt(h.pageX,h.pageY)},scope:this}});
Ext.applyIf(e.label,{display:"over",field:"index",fontSize:11,translateY:"line"==b?9:void 0});c||(e.label.display="none")},this);Ext.applyIf(a,{animation:!0,plugins:{ptype:"chartitemevents",moveEvents:!0},legend:{docked:"top",listeners:{itemclick:function(e,f,g,h){if(e.getStore().getCount()<e.chart.series.length&&"barline"==this.getApiParam("chartType")){var k=f.get("name"),l=f.get("disabled");e.chart.series.forEach(function(m){m.getTitle()==k&&m.setHidden(l)});e.chart.redraw()}},scope:this}},interactions:["itemhighlight",
"crosszoom"],listeners:{}});Ext.applyIf(a.listeners,{itemhighlightchange:function(e,f){e.el.dom.style.cursor=f?"pointer":""},afterrender:function(){},scope:this});a.axes.forEach(function(e){Ext.applyIf(e,{title:{},label:{}});Ext.applyIf(e.title,{scaling:.75});Ext.applyIf(e.label,{scaling:.75});if("category"==e.type){var f="";a.store.each(function(g){f+=g.get("index")});f.length>this.getTargetEl().getWidth()/9&&Ext.applyIf(e.label,{rotate:{degrees:-30}});Ext.applyIf(e,{labelInSpan:!0})}},this);this.query("chart").forEach(function(e){this.remove(e,
!0)},this);var d=Ext.create("Ext.chart.CartesianChart",a);this.add(d)},reloadFromChart:function(){var a=this.down("chart");if(a){var b=[];a.series.forEach(function(c){b.push(c.getTitle())});this.fireEvent("termsClicked",this,b)}}});Ext.define("Voyant.panel.NoTool",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.notool",statics:{i18n:{},api:{tool:void 0}},config:{html:void 0,notYetImplemented:"Centroid DocumentInputAdd DocumentTypeCollocateFrequenciesGrid EntitiesBrowser Equalizer FeatureClusters Flowerbed KwicsTagger Lava Mandala MicroSearch NetVizApplet PaperDrill RezoViz Sunburst Termometer Ticker TokensViz ToolBrowser ToolBrowserLarge VoyeurTagline WordCloud VoyeurTagline WordCountFountain".split(" ")},
constructor:function(){Ext.apply(this,{title:this.localize("title")});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},listeners:{boxready:function(a,b,c){var d=this.getApiParam("notool");if(d){Ext.isArray(d)&&(d=d[0]);a=this.getNotYetImplemented();b=0;for(c=a.length;b<c;b++)if(d==a[b])return Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("notImplemented"))).applyTemplate([d]),buttons:Ext.Msg.YESNO,buttonText:{yes:this.localize("currentButton"),
no:this.localize("oldButton")},icon:Ext.Msg.ERROR,scope:this,fn:function(e){if("yes"==e)e=this.getNewUrl();else{e="http://voyant-tools.org/tool/"+d+"/";var f=Ext.Object.fromQueryString(document.location.search);delete f.tool;(queryString=Ext.Object.toQueryString(f))&&(e+="?"+queryString)}window.location.replace(e)}});Ext.Msg.show({title:this.localize("error"),message:(new Ext.Template(this.localize("badToolSpecified"))).applyTemplate([d]),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(e){window.location.replace(this.getNewUrl())}})}else this.config.html||
Ext.Msg.show({title:this.localize("error"),message:this.localize("noToolSpecified"),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR,scope:this,fn:function(e){window.location.replace(this.getNewUrl())}})}},getNewUrl:function(){var a=Ext.Object.fromQueryString(document.location.search);delete a.tool;queryString=Ext.Object.toQueryString(a);return this.getApplication().getBaseUrl()+(queryString?"?"+queryString:"")}});Ext.define("Voyant.panel.VoyantFooter",{extend:"Ext.container.Container",mixins:["Voyant.panel.Panel"],alias:"widget.voyantfooter",statics:{i18n:{}},height:18,cls:"x-tab-bar-default voyant-footer",listeners:{boxready:function(a,b,c){c=["<a href='"+a.getBaseUrl()+"docs/' target='voyantdocs'>"+a.localize("voyantTools")+"</a> ",", <a href='https://csdh-schn.org/stefan-sinclair-in-memoriam/'>St&eacute;fan Sinclair</a> &amp; <a href='https://geoffreyrockwell.com'>Geoffrey Rockwell</a>"," (<a href='https://creativecommons.org/licenses/by/4.0/' target='_blank'><span class='cc'>c</span></a> "+
(new Date).getFullYear()+")"," <a class='privacy' href='"+this.getBaseUrl()+"docs/#!/guide/about-section-privacy-statement' target='top'>"+a.localize("privacy")+"</a>"," v. "+Voyant.application.getVersion()+(Voyant.application.getBuild()?" ("+Voyant.application.getBuild()+")":"")];for(var d="",e=0,f,g=a.getEl(),h=0;h<c.length;h++)f=g.getTextWidth(c[h].replace(/data-qtip.+?--\x3e/,">").replace(/<.+?>/g,"")),e+f<b&&(d+=c[h],e+=f);a.update(d);Ext.tip.QuickTipManager.register({target:a.getTargetEl().dom.querySelector(".privacy"),
text:this.localize("privacyMsg")})},beforedestroy:function(a){Ext.tip.QuickTipManager.unregister(a.getTargetEl().dom.querySelector(".privacy"))}}});Ext.define("Voyant.panel.VoyantHeader",{extend:"Ext.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.voyantheader",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{id:"voyantheader",title:"",layout:"fit",html:'<div id="logo-container"></div>',collapseMode:void 0,collapsible:!0,animCollapse:!1,titleCollapse:!1,floatable:!1,header:!0,hideCollapseTool:!0,listeners:{collapse:this.onCollapse},titleAlign:"center"});this.callParent(arguments);Ext.applyIf(a,{moreTools:["corpusset","scatterplot",
"termsradio"],includeTools:{save:!0,plus:!0,help:!0,language:this.getLanguageToolMenu(),home:{type:"home",tooltip:this.localize("homeTip"),xtype:"toolmenu",glyph:"xf015@FontAwesome",handler:function(b){var c=this.up("panel");Ext.Msg.confirm(c.localize("home"),c.localize("homeConfirm"),function(d){"yes"==d&&(document.location.href=c.getBaseUrl())},this)}}}});this.mixins["Voyant.panel.Panel"].constructor.call(this,a)},onCollapse:function(a){Ext.defer(function(){this.setTitle("<img src='"+this.getBaseUrl()+
"resources/images/voyant-logo-tiny.png' style='vertical-align: middle' alt='Voyant Tools' /> "+this.localize("title"))},10,a)}});Ext.define("Voyant.panel.CorpusSet",{extend:"Ext.panel.Panel",requires:"Voyant.panel.VoyantTabPanel Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.Phrases Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.StreamGraph Voyant.panel.TermsBerry".split(" "),mixins:["Voyant.panel.Panel"],alias:"widget.corpusset",isConsumptive:!0,statics:{i18n:{},
api:{panels:void 0},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"border",header:!1,items:[{region:"west",flex:3,layout:"fit",moreTools:["cirrus","corpusterms"],xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,items:[{xtype:"cirrus"},{xtype:"corpusterms"},{xtype:"collocatesgraph"}]},{region:"center",flex:3,layout:"fit",xtype:"voyanttabpanel",tabBarHeaderPosition:0,items:[{xtype:"reader"},
{xtype:"termsberry"}]},{region:"east",flex:3,layout:"fit",xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["trends","collocatesgraph","corpuscollocates"],items:[{xtype:"trends"},{xtype:"documentterms"}]},{region:"south",flex:2,split:{width:5},layout:"border",items:[{layout:"fit",region:"center",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["summary","documents","phrases"],items:[{xtype:"summary"},{xtype:"documents"},{xtype:"phrases"}]},{layout:"fit",
region:"east",flex:1,xtype:"voyanttabpanel",split:{width:5},tabBarHeaderPosition:0,moreTools:["contexts","documentterms"],items:[{xtype:"contexts"},{xtype:"bubblelines"},{xtype:"correlations"}]}]}],listeners:{boxready:function(){var a=this.getApiParam("panels");if(a){a=a.toLowerCase().split(",");for(var b=this.query("voyanttabpanel"),c=0,d=a.length;c<d;c++){var e=a[c];if(e&&Ext.ClassManager.getByAlias("widget."+e)&&b[c]){var f=b[c];f.getActiveTab().isXType(e)||(f.items.each(function(h,k){if(h.isXType(e))return this.setActiveTab(k),
!1},f),f.getActiveTab().isXType(e)||f.getActiveTab().replacePanel(e))}}}a=this.down("cirrus");var g=this;a&&(a=a.down("toolbar"),a.add({xtype:"tbfill"}),a.add({text:" ",listeners:{click:{fn:function(){g.add({region:"north",width:"100%",html:'<div align="center"><table><tr><td><img src="http://stefansinclair.name/wordpress/wp-content/uploads/2011/07/Sinclair_Stefan_small.jpg" style="height: 60px"></td><td style="text-align: center; padding-left: 2em; padding-right: 2em;">By Athena, you found us hidden<br>up here between the panels!</td><td><img src="http://geoffreyrockwell.com/images/home_09.jpg" style="height: 60px"></td></tr></table></div>'})},
single:!0},render:function(h){h.getTargetEl().dom.className=""}}}))},loadedCorpus:function(a,b){if(0==this.hasCorpusAccess(b)&&!this.getApiParam("panels")){var c=this.query("voyanttabpanel");c[1].setActiveTab(1);c[1].getActiveTab().fireEvent("loadedCorpus",a,b);c[4].setActiveTab(1)}30<b.getDocumentsCount()&&(a=this.down("bubblelines"))&&a.up("voyanttabpanel").remove(a)},panelChange:function(a){var b=[];this.query("voyanttabpanel").forEach(function(c){b.push(c.getActiveTab().xtype)});this.getApplication().setApiParam("panels",
b.join(","))}}});Ext.define("Voyant.panel.ScatterSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.scatterset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"hbox",header:!1,items:[{flex:3,height:"100%",xtype:"scatterplot"},{split:{width:5},flex:1,height:"100%",
layout:"vbox",defaults:{width:"100%",flex:1},items:[{xtype:"documents",collapsible:!0},{xtype:"trends",collapsible:!0},{xtype:"contexts",collapsible:!0}]}]});Ext.define("Voyant.panel.Subset",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.Downloadable"],alias:"widget.subset",isConsumptive:!0,statics:{i18n:{},api:{stopList:"auto",documentFilename:["pubDate","title"],documentFormat:"SOURCE"},glyph:"xf0ce@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],inDocumentsCountOnly:!1,stopList:"auto",store:void 0},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(a){var b=this;Ext.applyIf(b,{introHtml:"",fieldItems:[{xtype:"querysearchfield",fieldLabel:this.localize("titleLabel"),tokenType:"title"},{xtype:"querysearchfield",fieldLabel:this.localize("authorLabel"),tokenType:"author"},{xtype:"querysearchfield",fieldLabel:this.localize("lexicalLabel")}],fieldColumns:2});Ext.applyIf(b,{intro:{margin:"5 0 5 0",layout:"center",items:{itemId:"intro",html:b.introHtml}},fields:{xtype:"container",layout:"center",items:{xtype:"container",
maxWidth:1200,layout:{type:"table",columns:b.fieldColumns},items:b.fieldItems.map(function(c){return{xtype:"container",defaults:{margin:"5 10 5 10",inDocumentsCountOnly:b.getInDocumentsCountOnly(),stopList:b.getStopList(),showAggregateInDocumentsCount:!0,isDocsMode:!0,flex:1,maxWidth:800,labelAlign:"right"},items:Ext.applyIf(c,{fieldLabel:b.localize((c.tokenType?c.tokenType:"lexical")+"Label")})}},this)}},foot:{layout:"center",margin:"20 0 0 0",items:{xtype:"container",layout:{type:"hbox",align:"middle"},
defaults:{margin:"0 5 0 5",width:200},items:[{xtype:"button",itemId:"export",glyph:"xf08e@FontAwesome",text:this.localize("sendToVoyantButton"),handler:b.handleSendToVoyant,scope:b},{xtype:"button",glyph:"xf019@FontAwesome",itemId:"download",text:this.localize("downloadButton"),handler:b.handleExport,scope:b},{xtype:"container",hidden:!0,itemId:"statuscontainer",layout:"vbox",items:[{itemId:"status",bodyStyle:"text-align: center",width:200},{xtype:"container",width:200,items:{xtype:"sparklineline",
chartRangeMin:0,itemId:"sparkline",margin:"0 0 0 10",values:[1,1],height:20,width:200}}]}]}}});Ext.applyIf(b,{items:[b.intro,b.fields,b.foot]});b.on("loadedCorpus",function(c,d){b.getStore().setCorpus(d);void 0==b.getInitialConfig("introHtml")&&void 0==b.getInitialConfig("intro")&&b.queryById("intro").setHtml(d.getString())},b);b.on("query",function(c,d){this.performAggregateQuery(this.getAggregateQuery())});b.setStore(Ext.create("Voyant.data.store.DocumentQueryMatches"));b.callParent([a])},handleSendToVoyant:function(){if(this.getStore().lastOptions&&
this.getStore().lastOptions.params.query){var a=this;this.mask("Creating corpus\u2026");this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0},callback:function(b,c,d){a.unmask();d&&b&&1==b.length&&(b=c.getProxy().getReader().metaData,b=a.getBaseUrl()+"?corpus="+b,a.openUrl(b))}})}else Ext.Msg.alert(this.localize("sendToVoyantButton"),(new Ext.XTemplate(this.localize("sendToVoyantNoQuery"))).apply([this.getBaseUrl()+"?corpus="+this.getStore().getCorpus().getId()]))},
handleExport:function(){if(this.getStore().lastOptions&&this.getStore().lastOptions.params.query){var a=this.getStore().getAt(0);this.getStore().lastOptions.params.query&&a&&0==a.getCount()?this.showMsg({message:this.localize("noMatches")}):this.getStore().load({params:{query:this.getStore().lastOptions.params.query,createNewCorpus:!0,temporaryCorpus:!0},callback:function(b,c,d){d&&b&&1==b.length&&this.downloadFromCorpusId(c.getProxy().getReader().metaData)},scope:this})}else this.downloadFromCorpusId(this.getStore().getCorpus().getId())},
openDownloadCorpus:function(a){a=this.getTromboneUrl()+"?corpus="+a+"&tool=corpus.CorpusExporter&outputFormat=zip&zipFilename=DownloadedVoyantCorpus-"+a+".zip"+(this.getApiParam("documentFormat")?"&documentFormat="+this.getApiParam("documentFormat"):"")+(this.getApiParam("documentFilename")?"&documentFilename="+this.getApiParam("documentFilename"):"");this.openUrl(a)},performAggregateQuery:function(a){var b=this,c=b.queryById("statuscontainer"),d=b.queryById("status"),e=b.queryById("sparkline");c&&
c.show();d&&d.setHtml((new Ext.XTemplate('{0:plural("documents")} matching.')).apply([0]));e&&e.setValues([0,0]);a?(c=this.getStore().getCorpus().getDocumentsCount(),this.getStore().load({params:{query:a,withDistributions:!0,bins:100<c?100:c},callback:function(f,g,h){b.queryById("export");g=b.queryById("sparkline");h&&f&&1==f.length&&(d&&d.setHtml((new Ext.XTemplate('{0:plural("document")} matching.')).apply([f[0].getCount()])),g&&g.setValues(f[0].getDistributions()))}})):this.getStore().lastOptions&&
(this.getStore().lastOptions.params.query=void 0)},getAggregateQuery:function(){var a=[];Ext.ComponentQuery.query("field",this).forEach(function(b){if(b.getTokenType&&b.getValue){var c=b.getTokenType();b=Ext.Array.from(b.getValue());0<b.length&&0<b.length&&a.push("+("+b.map(function(d){return c+":"+d}).join("|")+")")}});return a.join(" ")}});Ext.define("Voyant.panel.CollocatesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.ScatterPlot","Voyant.panel.Documents","Voyant.panel.Trends","Voyant.panel.Contexts"],mixins:["Voyant.panel.Panel"],alias:"widget.collocatesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{layout:"hbox",align:"stretch",width:"100%",height:"100%",flex:2,defaults:{width:"100%",
height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"corpusterms"},{xtype:"documentterms"},{xtype:"corpuscollocates"}]},{width:"100%",height:"100%",split:{width:5},layout:"hbox",flex:3,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"collocatesgraph"}]}]});Ext.define("Voyant.panel.BubblelinesSet",{extend:"Ext.panel.Panel",requires:["Voyant.panel.Bubblelines","Voyant.panel.Contexts","Voyant.panel.Reader"],mixins:["Voyant.panel.Panel"],alias:"widget.bubblelinesset",statics:{i18n:{},glyph:"xf17a@FontAwesome"},constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},layout:"vbox",header:!1,items:[{width:"100%",height:"100%",xtype:"bubblelines",flex:5},{width:"100%",height:"100%",split:{width:5},
layout:"hbox",flex:4,defaults:{width:"100%",height:"100%",flex:1,frame:!0,border:!0},items:[{xtype:"contexts"},{xtype:"reader"}]}]});Ext.define("Voyant.panel.CustomSet",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.customset",statics:{i18n:{},api:{layout:void 0,tableLayout:void 0},glyph:"xf17a@FontAwesome"},header:!1,height:"100%",width:"100%",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(){this.getApiParam("layout")?Ext.apply(this,{layout:"border",
items:[]}):this.getApiParam("tableLayout")&&this.initTableLayout();this.callParent()},listeners:{loadedCorpus:function(a,b){this.getApiParam("layout")&&this.query("panel").forEach(function(c){c.fireEvent("loadedCorpus",a,b)})},boxready:function(a){this.getApiParam("layout")?this.initBorderLayoutComponents():this.getApiParam("tableLayout")?(this.doTableSizing(),this.on("resize",function(b,c,d,e,f){void 0!==e&&void 0!==f&&this.doTableSizing(c/e,d/f)},this)):this.showError(this.localize("noLayoutSpecified"))}},
initBorderLayoutComponents:function(){var a=decodeURI(this.getApiParam("layout")).replace(/r1/g,"region").replace(/i1/g,"items").replace(/s1/g,"split").replace(/c1/g,"collapsible").replace(/c2/g,"collapsed").replace(/w1/g,"width").replace(/h1/g,"height").replace(/p1/g,"%").replace(/"x1":"/g,'"xtype":"').replace(/c3/g,"center").replace(/n1/g,"north").replace(/e1/g,"east").replace(/s2/g,"south").replace(/w2/g,"west").replace(/"xtype":"(\w+)"/g,function(c,d){Ext.ClassManager.getByAlias("widget."+d.toLowerCase())||
(d="Links"==d?"CollocatesGraph":"CorpusGrid"==d?"Documents":"CorpusSummary"==d?"Summary":"CorpusTypeFrequenciesGrid"==d?"CorpusTerms":"DocumentInputAdd"==d?"CorpusTerms":"DocumentTypeCollocateFrequenciesGrid"==d?"CorpusTerms":"DocumentTypeFrequenciesGrid"==d?"DocumentTerms":"DocumentTypeKwicsGrid"==d?"Contexts":"TypeFrequenciesChart"==d?"Trends":"VisualCollocator"==d?"CollocatesGraph":"NoTool");return'"xtype":"'+d.toLowerCase()+'"'+("NoTool"==d?',"html":"'+(new Ext.Template(panel.localize("noSuchTool"))).applyTemplate([d])+
'"':"")});try{var b=Ext.decode(a)}catch(c){b={region:"center",html:"<div>Error constructing layout:"+c+"</div>"}}null==b&&(b={region:"center",html:"<div>Error: no layout information found.</div>"});this.addBorderLayouts(b);this.on("add",function(c,d){d.on("boxready",function(e){})});this.add(b)},addBorderLayouts:function(a){for(var b=Ext.getBody().getSize(),c=0;c<a.length;c++){var d=a[c];Ext.isString(d.width)?d.width=Math.round(b.width*parseInt(d.width)/100):Ext.isString(d.height)&&(d.height=Math.round(b.height*
parseInt(d.height)/100));d.items&&1<d.items.length?(d.layout="border",this.addBorderLayouts(d.items)):d.layout="fit"}},initTableLayout:function(){Ext.suspendLayouts();var a=decodeURI(this.getApiParam("tableLayout"));if(a&&"{"!=a.charAt(0)&&"["!=a.charAt(0)){var b=[];a.replace(/;/g,",").split(/,\s*/).forEach(function(h){b.push(/^"'/.test(h)?h:'"'+h+'"')});a="["+b.join(",")+"]"}a=Ext.decode(a);Ext.isArray(a)&&(a={cells:a});!a.numCols&&a.cells&&Ext.isArray(a.cells)&&(a.numCols=3>a.cells.length?a.cells.length:
5>a.cells.length?Math.ceil(a.cells.length/2):Math.ceil(a.cells.length/3));if(null!=a.numCols&&a.cells&&Ext.isArray(a.cells)){for(var c=[],d=0;d<a.cells.length;d++){var e=a.cells[d];if(Ext.isObject(e))e.cellWidth=parseFloat(e.width)||void 0,e.cellHeight=parseFloat(e.height)||void 0,delete e.width,delete e.height,c.push(e);else if(Ext.isArray(e)){var f=1,g=1;xtype=void 0;e[0]&&Ext.isNumber(e[0])&&(f=e[0],e.shift());e[0]&&Ext.isString(e[0])&&(xtype=e[0].toLowerCase(),e.shift());e[0]&&Ext.isNumber(e[0])&&
(g=e[0]);xtype&&c.push({colspan:f,rowspan:g,xtype:xtype})}else Ext.isString(e)&&c.push({xtype:e.toLowerCase(),colspan:1,rowspan:1})}Ext.apply(this,{layout:{type:"table",width:"100%",height:"100%",columns:a.numCols,tableAttrs:{style:{width:"100%",height:"100%"}},tdAttrs:{style:{padding:"0px",verticalAlign:"top"}}},defaults:{width:10,height:10,border:!0},items:c})}else this.showError("badTableLayoutDefinition");Ext.resumeLayouts()},doTableSizing:function(a,b){var c={},d=this.getTargetEl().down(".x-table-layout"),
e=d.getSize(!1);d=d.dom.rows;for(var f=0;f<d.length;f++)for(var g=d[f].cells,h=0;h<g.length;h++){var k=Ext.get(g[h]),l=k.down(".x-panel"),m=l.id;if(void 0!==a&&void 0!==b)k=l.getSize(!1),k.width*=a,k.height*=b;else{l=k.getSize(!1);var n=Ext.getCmp(m),r=n.initialConfig.cellWidth;n=n.initialConfig.cellHeight;void 0!==r&&(l.width=r/100*e.width,k.setWidth(l.width));void 0!==n&&(l.height=n/100*e.height,k.setHeight(l.height));k=l}c[m]=k}for(var u in c)k=c[u],Ext.getCmp(u).setSize(k);this.updateLayout()}});Ext.define("Voyant.panel.Veliza",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],xtype:"veliza",autoScroll:!0,statics:{i18n:{},api:{script:"",message:void 0},glyph:"xf0e6@FontAwesome"},config:{previous:[]},constructor:function(){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);var a=this;Ext.apply(this,{title:this.localize("title"),glyph:"xf0e6@FontAwesome",layout:{type:"border",align:"stretch"},items:[{itemId:"chat",html:"<form class='chat'></form>",
region:"center",flex:2,autoScroll:!0},{itemId:"script",xtype:"form",region:"east",split:!0,title:this.localize("scriptEditor"),layout:{type:"vbox",align:"stretch"},items:[{html:(new Ext.XTemplate(this.localize("scriptIntro"))).apply([a.getBaseUrl()+"docs/#!/guide/veliza"])},{xtype:"textarea",name:"editor",fieldStyle:"white-space: pre",value:a.getApiParam("script"),flex:1,listeners:{afterrender:function(b){var c=a.getApiParam("corpus");c&&(b.mask(a.localize("loadingScript")),Ext.Ajax.request({url:a.getTromboneUrl(),
params:{tool:"corpus.Veliza",script:a.getApiParam("script"),corpus:c}}).then(function(d){(d=Ext.decode(d.responseText))&&d.veliza&&d.veliza.script?(b.setValue(d.veliza.script),b.resetOriginalValue()):d&&d.veliza&&d.veliza.id?a.setApiParam("script",d.veliza.id):a.showError(a.localize("unableFetchScript"));b.unmask()},function(d){a.showError(d)}))},scope:this}}],collapsed:!0,collapsible:!0,flex:1}],dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"textfield",itemId:"chatfield",
emptyText:this.localize("typeAndEnter"),flex:1,listeners:{specialkey:function(b,c){c.getKey()==c.ENTER&&(a.handleUserSentence(b.getValue()),b.setValue(""))}}},{xtype:"button",text:this.localize("send"),handler:function(){var b=this.up("toolbar").down("textfield");a.handleUserSentence(b.getValue(),!1);b.setValue("")}},{xtype:"button",text:this.localize("fromCorpus"),handler:function(){a.handleUserSentence("",!0)}}]}]});this.callParent();this.on("boxready",function(b){b.addSentence("fromThem","Hello, I'm Veliza, and I'm here to talk to you about your texts (you may know my sister <a href='https://en.wikipedia.org/wiki/ELIZA' target='_blank'>Eliza</a> she's a famous psychotherapist). I'm just learning to talk about text documents, but please, let me know about any anxieties you're feeling about your texts. Type a message in the box below and hit enter. Or, if you're feeling playful, hit the <i>from text</i> bottom in the lower right-hand corner to fetch a sentence from the corpus.");
this.sendApiParamMessage()})},sendApiParamMessage:function(){if(this.getApiParam("message"))if(this.getCorpus()){var a=Ext.Array.from(this.getApiParam("message")),b=a.shift();b&&(a&&this.setApiParam("message",a),this.handleUserSentence(b,void 0,!0))}else Ext.defer(this.sendApiParamMessage,100,this,[!0])},handleUserSentence:function(a,b,c){if((a=a.trim())||b){a&&this.addSentence("myMessage",a);this.mask();var d=this,e=this.getComponent("script").down("textarea");Ext.Ajax.request({url:this.getApplication().getTromboneUrl(),
params:{corpus:d.getCorpus()?d.getCorpus().getId():void 0,tool:"corpus.Veliza",sentence:a,fromCorpus:b?!0:!1,script:e.isDirty()?e.getValue():this.getApiParam("script"),noCache:Ext.id()},success:function(f,g){d.unmask();f=Ext.decode(f.responseText);f.veliza.id&&(d.setApiParam("script",f.veliza.id),e.resetOriginalValue());var h=f.veliza.response;if(g=h.match(/\x3c!-- (.+?) --\x3e/)){g=Ext.decode(g[1]);for(key in g.params)g.params[key]=g.params[key].trim();h+="<br/><iframe width='"+(g.width?g.width:
"100%")+"' height='"+(g.height?g.height:"250px")+"' src='"+d.getApplication().getBaseUrl()+"tool/"+g.tool+"/?corpus="+d.getCorpus().getId()+"&minimal=true&"+Ext.Object.toQueryString(g.params)+"'></iframe>"}g=f.veliza.sentence;d.setPrevious(f.veliza.previous);b?(meta=-1<f.veliza.docIndex?d.getCorpus().getDocument(f.veliza.docIndex).getShortLabel():void 0,d.addSentence("myMessage",g,meta),Ext.Function.defer(function(){this.addSentence("fromThem",h);c||this.body.scroll("b",Infinity)},500,d)):(d.addSentence("fromThem",
h),c||d.body.scroll("b",Infinity));d.getApiParam("message")&&d.sendApiParamMessage()},failure:function(f,g){d.showResponseError("Unable to get response from Veliza.",f)}})}},addSentence:function(a,b,c){var d=this.getComponent("chat").body;d.down("form").insertHtml("beforeEnd",'<div class="message"><div class="'+a+'"><p>'+b+"</p>"+(c?"<date>"+c+"</date>":"")+"</div></div>",!0);d.scroll("b",Infinity)}});Ext.define("Voyant.panel.WordTree",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.wordtree",statics:{i18n:{},api:{query:void 0,docId:void 0,docIndex:void 0,stopList:"auto",context:10,limit:100},glyph:"xf0e8@FontAwesome"},config:{tree:void 0,kwicStore:void 0,options:[{xtype:"stoplistoption"},{xtype:"categoriesoption"}],numBranches:5,lastClick:1},doubleClickDelay:300,constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},
initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"querysearchfield"},'<span data-qtip="'+this.localize("poolTip")+'" class="info-tip">'+this.localize("pool")+"</span>",{xtype:"slider",itemId:"poolSlider",minValue:10,value:100,maxValue:1E3,increment:5,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,b){this.setApiParam("limit",a.getValue());
this.reload()},scope:this}},'<span data-qtip="'+this.localize("branchesTip")+'" class="info-tip">'+this.localize("branches")+"</span>",{xtype:"slider",itemId:"branchesSlider",minValue:2,value:5,maxValue:15,increment:1,width:50,listeners:{render:function(a){a.setValue(this.getNumBranches())},changecomplete:function(a,b){this.setNumBranches(a.getValue());this.reload()},scope:this}},'<span data-qtip="'+this.localize("contextTip")+'" class="info-tip">'+this.localize("context")+"</span>",{xtype:"slider",
itemId:"contextSlider",minValue:3,value:10,maxValue:20,increment:2,width:50,listeners:{render:function(a){a.setValue(this.getApiParam("context"))},changecomplete:function(a,b){this.setApiParam("context",a.getValue());this.reload()},scope:this}}]}]});this.setKwicStore(Ext.create("Voyant.data.store.Contexts",{parentPanel:this,proxy:{extraParams:{stripTags:"all"}},listeners:{load:function(a,b,c,d){c&&this.parseRecords(b)},scope:this}}));this.on("loadedCorpus",function(a,b){b.getCorpusTerms({autoLoad:!1}).load({callback:function(c,
d,e){e&&0<c.length&&(c=c[0].getTerm(),this.setRoot(c))},scope:this,params:{limit:1,query:this.getApiParam("query"),stopList:this.getApiParam("stopList")}})},this);this.on("query",function(a,b){void 0!==b&&""!=b&&this.setRoot(b)},this);this.on("termsClicked",function(a,b){var c=[];b.forEach(function(d){Ext.isString(d)?c.push(d):d.term?c.push(d.term):d.getTerm&&c.push(d.getTerm())});this.setRoot(c)},this);this.on("documentTermsClicked",function(a,b){var c=[];b.forEach(function(d){d.getTerm()&&c.push(d.getTerm())});
this.setRoot(c)},this);this.on("resize",function(a,b,c){a=this.getTree();void 0!==a&&(a.visWidth(b).visHeight(c),a.redraw())},this);this.on("boxready",this.initGraph,this);this.callParent(arguments)},parseRecords:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];d={id:c,prefix:d.getLeft().trim().split(/\s+/),hit:d.getMiddle(),suffix:d.getRight().trim().split(/\s+/)};b.push(d)}var e={},f={};for(c=0;c<b.length;c++){d=b[c];var g=d.prefix[d.prefix.length-1];d=d.suffix[0];e[g]?e[g]++:e[g]=1;f[d]?
f[d]++:f[d]=1}a=[];for(c=0;c<b.length;c++)d=b[c],g=d.prefix[d.prefix.length-1],d=d.suffix[0],a.push({suffix:d,suffixCount:f[d],prefix:g,prefixCount:e[g]});a.sort(function(l,m){var n=l.suffixCount,r=m.suffixCount;l=l.prefixCount;m=m.prefixCount;return l>m?-1:l<m?1:n>r?-1:n<r?1:0});f=Math.min(this.getNumBranches(),a.length);d=[];e=[];for(c=0;c<f;c++)d.push(a[c].suffix),e.push(a[c].prefix);a=[];f=[];g=[];var h=[];for(c=0;c<b.length;c++){var k=b[c];if(-1!=d.indexOf(k.suffix[0])||-1!=e.indexOf(k.suffix[0]))a.push(k.prefix),
f.push(k.hit),g.push(k.suffix),h.push(k.id)}this.getTree().setupFromArrays(a,f,g,h,!1,["token","POS"],"/",["token","POS"]);this.getTree().succeeded()||this.toastInfo({html:this.localize("emptyText"),align:"bl"})},initGraph:function(){var a=this.getLayout().getRenderTarget(),b=a.getWidth(),c=a.getHeight(),d=new doubletree.DoubleTree;d.init("#"+a.getId()).visWidth(b).visHeight(c).handlers({click:this.clickHandler.bind(this)});this.setTree(d)},clickHandler:function(a){var b=(new Date).getTime();if(this.getLastClick()&&
b-this.getLastClick()<this.doubleClickDelay){this.setLastClick(1);for(b=[];null!=a;)b.push(a.name),a=a.parent;this.getApplication().dispatchEvent("termsClicked",this,[b.reverse().join(" ")])}else this.setLastClick(b)},setRoot:function(a){this.setApiParam("query",this.stripPunctuation(a));this.getKwicStore().load({params:this.getApiParams()})},reload:function(){var a=this.getApiParam("query");void 0!==a&&this.setRoot(a)},stripPunctuation:function(a){if(Ext.isString(a))return a.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,
"");var b=[];a.forEach(function(c){b.push(c.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,""))});return b}});Ext.define("Voyant.panel.WordWall",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel","Voyant.util.DiacriticsRemover"],alias:"widget.wordwall",statics:{i18n:{},api:{limit:500,stopList:"auto"},glyph:"xf1e0@FontAwesome"},config:{visId:void 0,vis:void 0,simulation:void 0,nodes:void 0,tempNodes:void 0,zoom:void 0,terms:void 0,segments:void 0,filterOutUniqueTerms:!0,currentSegment:void 0,segmentTerms:void 0,segmentTermsQueue:[],segmentDelay:5E3,segmentDelayTimer:void 0,webWorker:void 0,isSimulating:!1,
transitionTime:2E3,isTransitioning:!1,minFreq:void 0,maxFreq:void 0,letterDistribution:void 0,frequencyScale:void 0,xForceStrength:.2,yForceStrength:.1,chargeStrength:-75,chargeDistance:100,minFontSize:7,maxFontSize:60},count:0,MIN_TERMS:10,MAX_TERMS:2E3,MIN_SCALING:1,MAX_SCALING:20,debugMsg:!1,constructor:function(a){this.mixins["Voyant.util.DiacriticsRemover"].constructor.apply(this,arguments);this.setVisId(Ext.id(null,"wordwall_"));this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,
arguments)},initComponent:function(){Ext.apply(this,{title:this.localize("title"),dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[this.localize("terms"),{width:50,xtype:"slider",minValue:this.MIN_TERMS,maxValue:this.MAX_TERMS,increment:10,listeners:{render:function(a){a.setValue(this.getApiParam("limit"))},changecomplete:function(a,b){this.setApiParam("limit",a.getValue());this.initLoad()},scope:this}},this.localize("delay"),{width:50,xtype:"slider",minValue:1,maxValue:60,
increment:1,listeners:{render:function(a){a.setValue(this.getSegmentDelay()/1E3)},changecomplete:function(a,b){this.setSegmentDelay(1E3*a.getValue());this.restartSegmentTimer()},scope:this}},this.localize("transition"),{width:50,xtype:"slider",minValue:100,maxValue:5E3,increment:1,listeners:{render:function(a){a.setValue(this.getTransitionTime())},changecomplete:function(a,b){this.setTransitionTime(a.getValue())},scope:this}},this.localize("xStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,
increment:10,listeners:{render:function(a){a.setValue(1E3*this.getXForceStrength())},changecomplete:function(a,b){this.setXForceStrength(a.getValue()/1E3)},scope:this}},this.localize("yStrength"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(a){a.setValue(1E3*this.getYForceStrength())},changecomplete:function(a,b){this.setYForceStrength(a.getValue()/1E3)},scope:this}},this.localize("chargeStrength"),{width:50,xtype:"slider",minValue:-1E3,maxValue:0,increment:10,
listeners:{render:function(a){a.setValue(this.getChargeStrength())},changecomplete:function(a,b){this.setChargeStrength(a.getValue())},scope:this}},this.localize("chargeDistance"),{width:50,xtype:"slider",minValue:0,maxValue:1E3,increment:10,listeners:{render:function(a){a.setValue(this.getChargeDistance())},changecomplete:function(a,b){this.setChargeDistance(a.getValue())},scope:this}},{xtype:"button",text:this.localize("stop"),handler:function(a){a.getText()===this.localize("stop")?(clearInterval(this.getSegmentDelayTimer()),
a.setText(this.localize("start"))):(this.restartSegmentTimer(),a.setText(this.localize("stop")))},scope:this},{itemId:"status",xtype:"tbtext",text:""}]}]});this.on("loadedCorpus",function(a,b){this.isVisible()&&this.initLoad()},this);this.on("resize",function(a,b,c){if(a=Ext.get(this.getVisId()))c=this.body,b=c.getHeight(),c=c.getWidth(),a.el.dom.setAttribute("width",c),a.el.dom.setAttribute("height",b)},this);this.callParent(arguments)},initVis:function(){var a=this.getLayout().getRenderTarget();
a.update("");var b=a.getWidth(),c=a.getHeight();a=d3.select(a.dom).append("svg").attr("id",this.getVisId()).attr("class","wordWall").attr("width",b).attr("height",c).append("g");this.setVis(a);this.setNodes(a.append("g").attr("class","nodes").selectAll(".node"));this.setTempNodes(a.append("g").attr("class","tempNodes").selectAll("text"));void 0===this.getWebWorker()&&(this.setWebWorker(new Worker(this.getBaseUrl()+"resources/d3/WordWallWorker.js")),this.getWebWorker().onmessage=this.handleWebWorkerMessage.bind(this))},
initLoad:function(){this.initVis();this.count=0;var a=this.getApiParams();a.tool="corpus.CorpusSegmentTerms";Ext.Ajax.request({url:this.getTromboneUrl(),params:a,success:function(b){b=Ext.decode(b.responseText);this.setSegments(b.corpusSegmentTerms.segments);b=b.corpusSegmentTerms.terms;this.getFilterOutUniqueTerms()&&(b=b.filter(function(c,d){return-1==c.rawFreqs.indexOf(0)}));this.setTerms(b);this.setCurrentSegment(this.getSegments().length);this.getNextSegment();this.restartSegmentTimer()},failure:function(b){this.debugMsg&&
console.log("failed",b)},scope:this})},restartSegmentTimer:function(){clearInterval(this.getSegmentDelayTimer());this.setSegmentDelayTimer(setInterval(function(){this.updateNodePositions()}.bind(this),this.getSegmentDelay()))},getNextSegment:function(){var a=this.getCurrentSegment();a++;a>=this.getSegments().length&&(a=0);this.setCurrentSegment(a);this.debugMsg&&console.log("getNextSegment",a);this.processTermsForSegment(this.getCurrentSegment())},processTermsForSegment:function(a){var b=Number.MAX_VALUE,
c=Number.MIN_VALUE,d={a:0,b:0,c:0,d:0,e:0,f:0,g:0,h:0,i:0,j:0,k:0,l:0,m:0,n:0,o:0,p:0,q:0,r:0,s:0,t:0,u:0,v:0,w:0,x:0,y:0,z:0};this.getTerms().forEach(function(h){h.id=this.idGet(h.term);h.value=h.rawFreqs[a];if(0<h.value){h.value<b&&(b=h.value);h.value>c&&(c=h.value);h.title=h.term+" ("+h.value+")";var k=this.removeDiacritics(h.term.charAt(0)).toLowerCase();h.letter=k;void 0===d[k]&&(d[k]=0);d[k]++}},this);this.setSegmentTerms(this.getTerms().filter(function(h){return 0<h.value}));this.setMinFreq(b);
this.setMaxFreq(c);var e=[],f;for(f in d){var g=d[f]/this.getTerms().length;e.push({letter:f,percent:g})}e.sort(function(h,k){return h.letter<k.letter?-1:h.letter>k.letter?1:0});this.setLetterDistribution(e);this.calculateNodeSizes(this.getSegmentTerms());this.runSimulation(this.getSegmentTerms())},calculateNodeSizes:function(a){var b=this.getTempNodes().data(a,function(f){return f.id}),c=function(f){var g=2*Math.min(1,a.length/this.MAX_TERMS)+1;f=this.getFrequencyScale()(f);return d3.scalePow().exponent(g).domain([0,
1]).range([this.getMinFontSize(),this.getMaxFontSize()])(f)}.bind(this),d=0;b.enter().append("text").attr("fill-opacity",0).attr("font-family",function(f){return"Arial"}).attr("font-size",function(f){var g=c(f.value);return f.fontSize=g}).text(function(f){return f.term}).each(function(f){var g=this.getBBox();f.bbox={};f.bbox.x=g.x;f.bbox.y=g.y;f.bbox.width=g.width;f.bbox.height=g.height;d+=g.width*g.height}).remove();var e=this.getLayout().getRenderTarget();b=e.getWidth();e=e.getHeight();b*=e;d>.6*
b?(this.setMaxFontSize(.9*this.getMaxFontSize()),this.setMinFontSize(.9*this.getMinFontSize()),this.calculateNodeSizes(a)):d<.5*b&&(this.setMaxFontSize(1.1*this.getMaxFontSize()),this.setMinFontSize(1.1*this.getMinFontSize()),this.calculateNodeSizes(a))},runSimulation:function(a){this.setIsSimulating(!0);var b=this.getLayout().getRenderTarget(),c=b.getWidth();b=b.getHeight();this.debugMsg&&console.time("runSim");this.getWebWorker().postMessage({terms:a,width:c,height:b,minFreq:this.getMinFreq(),maxFreq:this.getMaxFreq(),
xForceStrength:this.getXForceStrength(),yForceStrength:this.getYForceStrength(),chargeDistance:this.getChargeDistance(),chargeStrength:this.getChargeStrength(),letterDistribution:this.getLetterDistribution()})},handleWebWorkerMessage:function(a){switch(a.data.type){case "progress":a=parseInt(100*a.data.progress);this.getDockedItems()[1].getComponent("status").update(a+"%");break;case "msg":this.debugMsg&&console.log(a.data.msg);break;case "end":this.debugMsg&&console.timeEnd("runSim"),this.getDockedItems()[1].getComponent("status").update(""),
this.setIsSimulating(!1),this.getSegmentTermsQueue().push(a.data.nodes)}},updateNodePositions:function(){if(this.getIsTransitioning())Ext.Function.defer(this.updateNodePositions,100,this);else{this.count++;var a=this.getSegmentTermsQueue().shift();this.debugMsg&&console.log("queue length",this.getSegmentTermsQueue().length);if(void 0===a)this.debugMsg&&console.log("no nodes",this.count),!1===this.getIsSimulating()&&this.getNextSegment();else{this.setIsTransitioning(!0);0==this.getSegmentTermsQueue().length&&
this.getNextSegment();a=this.getNodes().data(a,function(c){return c.id});a.transition().duration(this.getTransitionTime()).attr("transform",function(c){return"translate("+c.x+","+c.y+")"});var b=a.enter().append("g").attr("class","node").attr("id",function(c){return c.id}).attr("transform",function(c){return"translate("+c.x+","+c.y+")"}).attr("fill-opacity",0);b.append("title").text(function(c){return c.title});b.append("text").attr("font-family",function(c){return"Arial"}).attr("font-size",function(c){return c.fontSize}).attr("fill",
function(c){return this.getApplication().getCategoriesManager().getFeatureForTerm("color",c.term)}.bind(this)).style("cursor","pointer").style("user-select","none").attr("alignment-baseline","middle").text(function(c){return c.term});b.transition().duration(this.getTransitionTime()).attr("fill-opacity",1);b=b.merge(a);b.select("text").transition().duration(this.getTransitionTime()).attr("font-size",function(c){return c.fontSize});a.exit().transition().duration(this.getTransitionTime()).attr("fill-opacity",
0).remove();setTimeout(function(){this.setIsTransitioning(!1)}.bind(this),this.getTransitionTime());this.setNodes(b)}}},updateMinFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},updateMaxFreq:function(){this.setFrequencyScale(d3.scaleLog().domain([this.getMinFreq(),this.getMaxFreq()]).range([0,1]))},zoomToFit:function(a,b){var c=this.getVis().node().getBBox(),d=c.width,e=c.height,f=c.x+d/2,g=c.y+e/2;c=this.getVis().node().parentElement;
var h=c.clientWidth,k=c.clientHeight;a=(a||.8)/Math.max(d/h,e/k);f=[h/2-a*f,k/2-a*g];d3.select(c).transition().duration(b||500).call(this.getZoom().transform,d3.zoomIdentity.translate(f[0],f[1]).scale(a))},idGet:function(a){return a.replace(/\W/g,"_")}});Ext.define("Voyant.panel.Topics",{extend:"Ext.grid.Panel",mixins:["Voyant.panel.Panel","Voyant.widget.LiveSearchGrid"],alias:"widget.topics",statics:{i18n:{},api:{stopList:"auto",numTopics:25,limit:10,iterations:100,perDocLimit:1E3,query:void 0},glyph:"xf1ea@FontAwesome"},config:{options:[{xtype:"stoplistoption"},{xtype:"numberfield",name:"perDocLimit",fieldLabel:"maximum words per document",labelAlign:"right",value:1E3,minValue:1,step:100,listeners:{afterrender:function(a){var b=a.up("window");b&&
b.panel&&(a.setValue(parseInt(b.panel.getApiParam("perDocLimit"))),a.setFieldLabel(b.panel.localize("perDocLimit")))},change:function(a,b){a=a.up("window");5E3<b&&a&&a.panel&&a.panel.toastInfo({html:a.panel.localize("perDocLimitHigh"),anchor:a.getTargetEl(),align:"tr",maxWidth:400})}}},{xtype:"numberfield",name:"iterations",fieldLabel:"iterations per run",labelAlign:"right",value:100,minValue:1,maxValue:1E4,step:50,listeners:{afterrender:function(a){var b=a.up("window");b&&b.panel&&(a.setValue(parseInt(b.panel.getApiParam("iterations"))),
a.setFieldLabel(b.panel.localize("iterations")))}}}],corpus:void 0,documentTopicSmoothing:.1,topicWordSmoothing:.01,vocabularySize:0,vocabularyCounts:{},stopwords:{},docSortSmoothing:10,sumDocSortSmoothing:250,requestedSweeps:0,wordTopicCounts:{},topicWordCounts:[],tokensPerTopic:[],topicWeights:Array(25),documents:[],progress:void 0,totalIterations:0,exportGridAll:!1},zeros:function(a,b){b=b||0;for(var c=Array(a),d=0;d<a;d++)c[d]=b;return c},constructor:function(a){Ext.apply(this,{title:this.localize("title"),
layout:{type:"hbox",pack:"start",align:"stretch"},store:{fields:["topic","scores"],data:[]},columns:[{text:this.localize("topic"),tooltip:this.localize("topicTip"),flex:3,dataIndex:"topic",sortable:!1},{xtype:"widgetcolumn",text:this.localize("scores"),tooltip:this.localize("scoresTip"),flex:1,dataIndex:"scores",widget:{xtype:"sparklineline",tipTpl:new Ext.XTemplate("{[this.getDocumentTitle(values.x,values.y)]}",{getDocumentTitle:function(b,c){return this.panel.getCorpus().getDocument(b).getTitle()+
"<br>coverage: "+Ext.util.Format.number(100*c,"0,000.0")+"%"},panel:this})}}],dockedItems:{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:['<span class="info-tip" data-qtip="'+this.localize("searchTip")+'">'+this.localize("search")+"</span>",{xtype:"textfield",name:"searchField",hideLabel:!0,width:80,listeners:{change:{fn:this.onTextFieldChange,scope:this,buffer:500}}},'<span class="info-tip" data-qtip="'+this.localize("limitTermsTip")+'">'+this.localize("limitTerms")+"</span>",{width:80,
hideLabel:!0,xtype:"slider",increment:1,minValue:1,maxValue:100,listeners:{afterrender:function(b){b.setValue(parseInt(this.getApiParam("limit")))},changecomplete:function(b,c){this.setApiParams({limit:c});this.postSweep()},scope:this}},'<span class="info-tip" data-qtip="'+this.localize("numTopicsTip")+'">'+this.localize("numTopics")+"</span>",{width:80,hideLabel:!0,xtype:"slider",increment:1,minValue:1,maxValue:200,listeners:{afterrender:function(b){b.setValue(parseInt(this.getApiParam("numTopics")))},
changecomplete:function(b,c){this.setApiParams({numTopics:c});this.loadFromExistingDocuments()},scope:this}},{text:(new Ext.Template(this.localize("runIterations"))).apply([100]),itemId:"iterations",glyph:"xf04b@FontAwesome",tooltip:this.localize("runIterationsTip"),handler:this.runIterations,scope:this},{xtype:"tbtext",itemId:"done"},{xtype:"tbfill"},{xtype:"tbtext",html:this.localize("adaptation")}]}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);
this.resetData();this.on("loadedCorpus",function(b,c){this.setCorpus(c);if(this.rendered)this.initialize();else this.on("afterrender",function(){this.initialize()},this)});this.on("query",function(b,c){this.setApiParam("query",c);this.updateSearchResults()})},loadStopwords:function(){this.mask(this.localize("loadingStopWords"));Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.KeywordsManager",stopList:this.getApiParam("stopList"),corpus:this.getCorpus()?this.getCorpus().getAliasOrId():
void 0},success:function(a,b){this.unmask();var c={};Ext.util.JSON.decode(a.responseText).keywords.keywords.forEach(function(d){c[d]=1});this.setStopwords(c);this.loadDocuments()},scope:this})},loadDocuments:function(){this.mask(this.localize("loadingDocuments"));var a=this.getCorpus();a&&Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"corpus.DocumentTokens",corpus:a.getAliasOrId(),outputFormat:"text",template:"docTokens2idsAndText",limit:0,noOthers:!0,perDocLimit:1==a.getDocumentsCount()?
void 0:parseInt(this.getApiParam("perDocLimit"))},success:function(b,c){this.unmask();this.mask(this.localize("parsingDocuments"));b=b.responseText.trim().split(/(\r\n|\r|\n)/);if(1==b.length){if(b=b[0].split(": "),1<b.length){var d=a.getDocument(b[0]);c=b[1].split(" ");d=d.getLexicalTokensCount();d=10>d?d:1E3>d?10:100;d=10;for(var e=Math.floor(c.length/d),f=0;f<d;f++){var g=c.slice(f*e,f*e+e).join(" ");this.parseLine(b[0]+"-"+f+"\t"+b[0]+"-"+f+"\t"+g)}}}else b.forEach(function(h){h=h.split(": ");
if(1<h.length){var k=a.getDocument(h[0]);this.parseLine(h[0]+"\t"+k.getTinyLabel()+"\t"+h[1])}},this);this.unmask();this.runIterations()},scope:this})},resetData:function(){var a=parseInt(this.getApiParam("numTopics"));this.setVocabularyCounts({});this.setSumDocSortSmoothing(this.getDocSortSmoothing()*a);this.setRequestedSweeps(0);this.setWordTopicCounts({});this.setTopicWordCounts([]);this.setTokensPerTopic(this.zeros(a));this.setTopicWeights(this.zeros(a));this.setDocuments([]);this.setTotalIterations(0)},
loadFromExistingDocuments:function(){var a=this.getDocuments().map(function(b){return b.id+"\t"+b.date+"\t"+b.originalText});this.resetData();a.forEach(function(b){this.parseLine(b)},this);this.runIterations()},runIterations:function(){var a=this.getRequestedSweeps(),b=parseInt(this.getApiParam("iterations"));a+=parseInt(b);this.setTotalIterations(this.getTotalIterations()+b);this.setRequestedSweeps(a);this.getProgress()||(b=Ext.MessageBox.show({title:this.localize("runningIterations"),message:(new Ext.Template(this.localize("runningIterationsCount"))).apply([a]),
progress:!0,progressText:"",target:a,customUpdateProgress:function(c){this.updateProgress((this.config.target-c)*this.config.target," iterations")}}),this.setProgress(b),this.updateProgress(a));this.sweep()},updateProgress:function(a){var b=this.getProgress();a=this.getRequestedSweeps();if(b){var c=b.cfg.target;a=(c-a)/c;b.updateProgress(a,100*parseInt(a)+"% done")}},sweep:function(){Date.now();for(var a=parseInt(this.getApiParam("numTopics")),b=this.getVocabularySize(),c=this.getTopicWordSmoothing(),
d=this.getTokensPerTopic(),e=this.getDocuments(),f=this.getWordTopicCounts(),g=this.getTopicWeights(),h=this.getDocumentTopicSmoothing(),k=this.zeros(a),l=0;l<a;l++)k[l]=1/(b*c+d[l]);for(var m=0;m<e.length;m++)for(var n=e[m],r=n.topicCounts,u=0;u<n.tokens.length;u++){var q=n.tokens[u];if(!q.isStopword){d[q.topic]--;var p=f[q.word];p[q.topic]--;r[q.topic]--;k[q.topic]=1/(b*c+d[q.topic]);var v=0;for(l=0;l<a;l++)g[l]=p[l]?(h+r[l])*(c+p[l])*k[l]:(h+r[l])*c*k[l],v+=g[l];l=v*Math.random();v=0;for(l-=g[v];0<
l;)v++,l-=g[v];q.topic=v;d[q.topic]++;p[q.topic]=p[q.topic]?p[q.topic]+1:1;r[q.topic]++;k[q.topic]=1/(b*c+d[q.topic])}}a=this.getRequestedSweeps()-1;this.setRequestedSweeps(a);b=this.getProgress();0<a?(this.updateProgress(a),Ext.defer(this.sweep,0,this)):(b.close(),this.setProgress(void 0),this.postSweep())},postSweep:function(){this.sortTopicWords();var a=this.getStore(),b=(new Ext.Template(this.localize("totalDone"))).apply([Ext.util.Format.number(parseInt(this.getTotalIterations()),"0,000")]);
this.down("#done").setHtml(b);b=parseInt(this.getApiParam("numTopics"));for(var c=this.getTopicWordCounts(),d=[],e=this.getDocuments(),f=this.getDocSortSmoothing(),g=this.getSumDocSortSmoothing(),h=parseInt(this.getApiParam("limit")),k=0;k<b;k++){var l=e.map(function(m,n){return(m.topicCounts[k]+f)/(m.tokens.length+g)});d.push({topic:this.topNWords(c[k],h),scores:l})}a.loadData(d)},topNWords:function(a,b){return a.slice(0,b).map(function(c){return c.word}).join(" ")},sortTopicWords:function(){this.getTopicWordCounts();
var a=parseInt(this.getApiParam("numTopics")),b=this.getWordTopicCounts();var c=[];for(var d=0;d<a;d++)c[d]=[];for(var e in b)for(d in b[e])c[d].push({word:e,count:b[e][d]});for(d=0;d<a;d++)c[d].sort(this.byCountDescending);this.setTopicWordCounts(c)},byCountDescending:function(a,b){return b.count-a.count},initialize:function(){var a=(new Ext.Template(this.localize("runIterations"))).apply([Ext.util.Format.number(parseInt(this.getApiParam("iterations")),"0,000")]);this.down("#iterations").setText(a);
this.loadStopwords()},parseLine:function(a){var b=this.getStopwords(),c=this.getVocabularyCounts(),d=this.getTokensPerTopic(),e=this.getVocabularySize();c=this.getVocabularyCounts();var f=this.getDocuments(),g=parseInt(this.getApiParam("numTopics")),h=this.getWordTopicCounts();if(""!=a){var k=f.length,l="",m=a.split("\t");a=m[0];3==m.length&&(k=m[0],l=m[1],a=m[2]);var n=[];m=a.toLowerCase().split(" ");if(null!=m){var r=this.zeros(g);m.forEach(function(u){if(""!==u){var q=Math.floor(Math.random()*
g);2>=u.length&&(b[u]=1);var p=b[u];p?c[u]=c[u]?c[u]+1:1:(d[q]++,h[u]||(h[u]={},e++,c[u]=0),h[u][q]||(h[u][q]=0),h[u][q]+=1,c[u]+=1,r[q]+=1);n.push({word:u,topic:q,isStopword:p})}});this.setVocabularySize(e);f.push({originalOrder:f.length,id:k,date:l,originalText:a,tokens:n,topicCounts:r})}}}});Ext.define("Voyant.panel.Via",{extend:"Ext.panel.Panel",mixins:["Voyant.panel.Panel"],alias:"widget.via",statics:{i18n:{},api:{stopList:"auto",limit:100,docIndex:void 0},glyph:"xf06e@FontAwesome"},config:{mode:void 0,options:[{xtype:"stoplistoption"},{xtype:"listeditor",name:"whiteList"},{xtype:"categoriesoption"}]},layout:"fit",constructor:function(a){this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments)},initComponent:function(a){Ext.apply(this,{title:this.localize("title"),
dockedItems:[{dock:"bottom",xtype:"toolbar",overflowHandler:"scroller",items:[{xtype:"corpusdocumentselector",singleSelect:!0},{fieldLabel:this.localize("visible"),labelWidth:40,width:120,xtype:"slider",increment:10,minValue:10,maxValue:1E3,listeners:{afterrender:function(b){b.setValue(this.getApiParam("limit"))},changecomplete:function(b,c){this.setApiParams({limit:c});this.loadFromCorpus(this.getCorpus())},scope:this}}]}]});this.callParent(arguments)},listeners:{resize:function(a,b,c){},loadedCorpus:function(a,
b){a=b.get("languageCodes");Ext.Array.each(a,function(c){if("en"!=c)return this.showError(this.localize("englishOnly")),!1},this);1E5<b.getWordTokensCount()&&!this.getApiParam("docIndex")&&this.setApiParam("docIndex",0);this.loadFromCorpus(b)},corpusSelected:function(a,b){this.setApiParam("docIndex","");this.loadFromCorpus(b)},documentSelected:function(a,b){this.setApiParam("docIndex",b.getIndex());this.loadFromCorpus(this.getCorpus())}},loadFromCorpus:function(a){var b=this;this.mask(this.localize("loading"));
var c=this.getApiParams();a.loadRelatedWords(c).then(function(d){b.unmask();d=d.map(function(f){return{source:f.getSource(),target:f.getTarget()}});var e=b.down("voyantnetworkgraph");e?e.loadJson({edges:d}):(e=Ext.create("Voyant.widget.VoyantNetworkGraph",{edges:d,listeners:{nodeclicked:function(f,g){b.dispatchEvent("termsClicked",b,[g.term])}}}),b.add(e))},function(d){b.unmask();d.timedout?b.showError(b.localize("timedout")):b.showError(d)})}});Ext.define("Voyant.notebook.editor.button.Add",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperadd",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf067@FontAwesome",textAlign:"left",listeners:{click:function(a,b){this.findParentByType("notebook").fireEvent("notebookWrapperAdd",this.findParentByType("notebookeditorwrapper"),b)}}});Ext.define("Voyant.notebook.editor.button.Edit",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperedit",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},glyph:"xf040@FontAwesome",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperEdit",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Export",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperexport",statics:{i18n:{tip:"Export",exportTitle:"Export",exportOpen:"Export content into new window",exportDownload:"Download file to your machine",cancelTitle:"Cancel"},exportWin:void 0,getExportWindow:function(a){void 0===this.exportWin&&(this.exportWin=Ext.create("Ext.window.Window",{title:a.localize("exportTitle"),closeAction:"hide",modal:!0,bodyPadding:5,
layout:{type:"vbox",align:"stretch"},defaults:{xtype:"button"},items:[{itemId:"open",text:a.localize("exportOpen"),glyph:"xf08e@FontAwesome"},{itemId:"download",margin:"5 0 0 0",preventDefault:!1,text:a.localize("exportDownload"),glyph:"xf019@FontAwesome",handler:function(g){g.up("window").close()}}],buttons:[{text:a.localize("cancelTitle"),glyph:"xf00d@FontAwesome",handler:function(g){g.up("window").close()}}]}));var b=a.up("notebookcodeeditorwrapper"),c=b.getContent(),d="output"===a.getExportType()?
c.output:c.input,e=b.getCellId()+"."+a.getFileExtension(c.mode);a={type:"text/plain"};try{var f=new File([d],e,a)}catch(g){f=new Blob([d],a)}this.exportWin.down("#open").setHandler(function(g){var h=window.open();h.document.write(d);h.document.close();h.focus();g.up("window").close()});this.exportWin.addListener("show",function(){var g=URL.createObjectURL(f);this.exportWin.down("#download").getEl().set({download:e,href:g})},this,{single:!0});return this.exportWin}},constructor:function(a){Ext.apply(a,
{tooltip:this.localize("tip")});this.callParent(arguments)},config:{exportType:"input"},glyph:"xf08e@FontAwesome",listeners:{click:function(a){Voyant.notebook.editor.button.Export.getExportWindow(a).show()}},getFileExtension:function(a){return"text"===a||"javascript"===a&&"output"===this.getExportType()?"txt":a}});Ext.define("Voyant.notebook.editor.button.Counter",{extend:"Ext.toolbar.TextItem",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappercounter",statics:{i18n:{}},config:{order:0,name:void 0},cls:"notebookwrappercounter",constructor:function(a){Ext.apply(this,{toolTip:this.localize("tip")});this.callParent(arguments)},setOrder:function(a){this.callParent(arguments);this.updateHtml()},updateHtml:function(){var a=this.getOrder()+1,b=this.getName();this.setHtml('<a name="'+b+'" href="#'+b+
'">'+a+"</a>")}});Ext.define("Voyant.notebook.editor.button.MoveDown",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermovedown",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf063@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveDown",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.MoveUp",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermoveup",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf062@FontAwesome",textAlign:"left",listeners:{click:function(){this.findParentByType("notebook").fireEvent("notebookWrapperMoveUp",this.findParentByType("notebookeditorwrapper"))}}});Ext.define("Voyant.notebook.editor.button.Remove",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperremove",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf014@FontAwesome",textAlign:"left",listeners:{click:function(){Ext.Msg.show({buttons:Ext.Msg.OKCANCEL,icon:Ext.MessageBox.QUESTION,msg:this.localize("confirmRemove"),title:this.localize("confirmRemoveTitle"),fn:function(a){"ok"==
a&&this.findParentByType("notebook").fireEvent("notebookWrapperRemove",this.findParentByType("notebookeditorwrapper"))},scope:this})}}});Ext.define("Voyant.notebook.editor.button.Metadata",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrappermetadata",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf02c@FontAwesome",textAlign:"left",listeners:{click:function(a,b){this.findParentByType("notebook").fireEvent("notebookWrapperMetadata",this.findParentByType("notebookeditorwrapper"),b)}}});Ext.define("Voyant.notebook.editor.button.Movement",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.MoveUp","Voyant.notebook.editor.button.MoveDown","Voyant.notebook.editor.button.Remove"],alias:"widget.notebookwrappermovement",statics:{i18n:{}},constructor:function(a){Ext.apply(this,{tooltip:this.localize("tip")});this.callParent(arguments)},glyph:"xf07d@FontAwesome",menu:[{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"},{xtype:"notebookwrapperremove"}]});Ext.define("Voyant.notebook.editor.button.Run",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrun",statics:{i18n:{}},glyph:"xf04b@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunAll",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrunall",statics:{i18n:{}},glyph:"xf04e@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.button.RunUntil",{extend:"Ext.button.Button",mixins:["Voyant.util.Localization"],alias:"widget.notebookwrapperrununtil",statics:{i18n:{}},glyph:"xf050@FontAwesome",constructor:function(a){a=a||{};a.tooltip=this.localize("tip");this.callParent(arguments)}});Ext.define("Voyant.notebook.editor.EditorWrapper",{extend:"Ext.panel.Panel",mixins:["Voyant.util.Localization"],requires:["Voyant.notebook.editor.button.Movement","Voyant.notebook.editor.button.Add"],alias:"widget.notebookeditorwrapper",cls:"notebook-editor-wrapper",config:{cellId:void 0,content:"",isEditing:!1},border:!1,bodyBorder:!1,initComponent:function(){this.setCellId(this.config.cellId);this.on("afterrender",function(){this.getDockedItems().forEach(function(a){a.getTargetEl().setVisibilityMode(Ext.dom.Element.VISIBILITY)});
this.setActiveMode(!1);this.body.on("click",function(){this.removeCls("notebook-editor-wrapper-hover");this.setActiveMode(!0)},this);this.mon(this.getEl(),"mouseover",function(){this.setActiveMode(!0)},this);this.mon(this.getEl(),"mouseout",function(){this.setActiveMode(!1)},this)},this);this.callParent(arguments)},setActiveMode:function(a){this.getDockedItems().forEach(function(b){"right"==b.dock?b.items.each(function(c){0==c.hasCls("notebookwrappercounter")&&c.getTargetEl().setVisibility(a)}):b.getTargetEl().setVisibility(a)},
this);this.getIsEditing()||(a?this.body.addCls("notebook-editor-wrapper-hover"):this.body.removeCls("notebook-editor-wrapper-hover"))}});Ext.define("Voyant.notebook.editor.CodeEditor",{extend:"Ext.Component",alias:"widget.notebookcodeeditor",mixins:["Voyant.util.Localization","Voyant.notebook.util.Embed"],embeddable:["Voyant.notebook.editor.CodeEditor"],cls:"notebook-code-editor",config:{theme:"ace/theme/chrome",mode:"ace/mode/javascript",content:"",docs:void 0,isChangeRegistered:!1,editor:void 0,editedTimeout:void 0,lines:0},statics:{i18n:{},api:{content:void 0}},constructor:function(a){this.callParent(arguments)},listeners:{boxready:function(){var a=
this,b=ace.edit(Ext.getDom(this.getEl()));b.$blockScrolling=Infinity;b.getSession().setUseWorker(!0);b.setTheme(this.getTheme());b.getSession().setMode(this.getMode());b.setOptions({minLines:6,maxLines:Infinity,autoScrollEditorIntoView:!0,scrollPastEnd:!0});b.setHighlightActiveLine(!1);b.setHighlightGutterLine(!1);b.renderer.setShowPrintMargin(!1);b.setValue(this.getContent()?this.getContent():"");b.clearSelection();b.on("focus",function(){setTimeout(function(){a.getEditor().setHighlightGutterLine(!0)},
100)},this);b.on("change",function(c,d){c=d.getSession().getScreenLength();c!=a.getLines()&&(a.up("notebookcodeeditorwrapper").setSize({height:c*d.renderer.lineHeight+d.renderer.scrollBar.getWidth()}),a.setLines(c));if(0==a.getIsChangeRegistered()){if(a.setIsChangeRegistered(!0),d=a.up("notebookcodeeditorwrapper"))d.setIsRun(!1),(d=d.up("notebook"))&&d.setIsEdited(!0)}else a.getEditedTimeout()||a.setEditedTimeout(setTimeout(function(){a.setIsChangeRegistered(!1)},3E4))},this);b.on("blur",function(){a.getEditor().setHighlightGutterLine(!1)});
b.commands.addCommand({name:"run",bindKey:{win:"Shift-Enter",mac:"Shift-Enter"},exec:function(c){(c=a.up("notebookcodeeditorwrapper"))&&c.run()}});b.commands.addCommand({name:"rununtil",bindKey:{win:"Command-Shift-Enter",mac:"Command-Shift-Enter"},exec:function(c){c=a.up("notebookcodeeditorwrapper");c.up("notebook").runUntil(c)}});this.setEditor(b);ace.config.loadModule("ace/ext/tern",function(c){a.getEditor().setOptions({enableTern:{defs:a.docs?["browser","ecma5",a.docs]:["ecma5","browser"],plugins:{doc_comment:{fullDocs:!0}},
useWorker:!0},enableSnippets:!1,enableBasicAutocompletion:!1})})},removed:function(a,b){a.getEditor()&&a.getEditor().destroy()}},switchModes:function(a){this.setMode("ace/mode/"+a);this.getEditor().getSession().setMode(this.getMode())},getValue:function(){return this.getEditor().getValue()}});Ext.define("Voyant.notebook.editor.CodeEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.CodeEditor","Voyant.notebook.editor.button.Run","Voyant.notebook.editor.button.RunAll"],alias:"widget.notebookcodeeditorwrapper",cls:"notebook-code-wrapper",statics:{i18n:{runMultiple:"Run multiple cells",runUntil:"Run up to here",runUntilTip:"Run previous code blocks and this one.",runFrom:"Run from here onwards",runFromTip:"Run this and following code blocks.",codeMode:"select from several formats for this cell",
codeModeTitle:"Code Mode",codeModeTip:"Select from multiple code formats for this cell.",configureTip:"Configuration Options",autoExecuteOnLoad:"auto-run this cell on page load",ok:"OK",cancel:"Cancel"},configWin:void 0,getConfigWindow:function(a){void 0===this.configWin&&(this.configWin=new Ext.Window({title:a.localize("codeModeTitle"),closeAction:"hide",layout:"fit",width:240,items:[{xtype:"form",layout:{type:"vbox",align:"stretch"},bodyPadding:10,items:[{xtype:"fieldset",title:a.localize("modeCode"),
items:[{xtype:"radiofield",boxLabel:a.localize("modeJavascript"),name:"codeMode",inputValue:"javascript",flex:1,listeners:{change:function(c,d,e){c=c.up().queryById("autoExecute");c.setHidden(!d);d||c.setValue(!1)}}},{xtype:"checkbox",boxLabel:a.localize("autoExecuteOnLoad"),name:"autoExecute",itemId:"autoExecute"}]},{xtype:"fieldset",title:a.localize("modeData"),items:[{items:{xtype:"radiofield",boxLabel:a.localize("modeJson"),name:"codeMode",inputValue:"json",flex:1}},{items:{xtype:"radiofield",
boxLabel:a.localize("modeText"),name:"codeMode",inputValue:"text",flex:1}},{items:{xtype:"radiofield",boxLabel:a.localize("modeHtml"),name:"codeMode",inputValue:"html",flex:1}},{items:{xtype:"radiofield",boxLabel:a.localize("modeXml"),name:"codeMode",inputValue:"xml",flex:1}}]}]}],buttons:[{text:a.localize("ok"),itemId:"ok"},{text:a.localize("cancel"),handler:function(c){c.up("window").close()},scope:this}]}));var b=a.getMode();this.configWin.down('radiofield[name=codeMode][inputValue="'+b+'"]').setValue(!0);
this.configWin.down("checkbox#autoExecute").setValue(a.getAutoExecute());this.configWin.down("button#ok").setHandler(function(c){c=c.up("window");var d=c.down("form");d.isDirty()&&(d=d.getValues(),a.switchModes(d.codeMode),a.setAutoExecute("on"===d.autoExecute),a.down("button#config").toggleCls("autoExecute","on"===d.autoExecute),a.up("notebook").setIsEdited(!0));c.close()});return this.configWin}},config:{isRun:!1,autoExecute:!1,mode:"javascript",isWarnedAboutPreviousCells:!1,expandResults:!0,emptyResultsHeight:40,
minimumResultsHeight:120},layout:{type:"vbox",align:"stretch"},height:150,border:!1,EMPTY_RESULTS_TEXT:" ",constructor:function(a){a.mode=void 0!==a.mode?a.mode:this.config.mode;var b=-1<a.mode.indexOf("javascript");this.editor=Ext.create("Voyant.notebook.editor.CodeEditor",{content:Ext.Array.from(a.input).join("\n"),docs:a.docs,mode:"ace/mode/"+a.mode});Ext.apply(this,{dockedItems:[{xtype:"toolbar",dock:"left",defaults:{textAlign:"left"},items:[{xtype:"notebookwrapperadd"},{xtype:"notebookwrapperrun",
hidden:!b,listeners:{click:{fn:this.run,scope:this}}},{glyph:"xf050@FontAwesome",tooltip:this.localize("runMultiple"),itemId:"runMultiple",hidden:!b,listeners:{click:{fn:function(c,d){Ext.create("Ext.menu.Menu",{items:[{text:this.localize("runUntil"),tooltip:this.localize("runUntilTip"),glyph:"xf049@FontAwesome",handler:function(){this.up("notebook").runUntil(this)},scope:this},{text:this.localize("runFrom"),tooltip:this.localize("runFromTip"),glyph:"xf050@FontAwesome",handler:function(){this.up("notebook").runFrom(this)},
scope:this}]}).showAt(d.pageX,d.pageY)},scope:this}}},{xtype:"button",itemId:"config",glyph:"xf013@FontAwesome",tooltip:this.localize("configureTip"),cls:a.autoExecute?"autoExecute":"",handler:function(c,d){Voyant.notebook.editor.CodeEditorWrapper.getConfigWindow(this).show()},scope:this},{xtype:"notebookwrapperexport",hidden:b}]},{xtype:"toolbar",dock:"right",items:[{xtype:"notebookwrappercounter",order:a.order,name:a.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}],
items:[this.editor]});void 0!==a.uiHtml&&this.items.push(this._getUIComponent(a.uiHtml));this.results=this._getResultsComponent(Ext.Array.from(a.output).join(""),a);this.results.setVisible(b);this.items.push(this.results);this.callParent(arguments)},initComponent:function(a){var b=this;b.on("afterrender",function(){this.getTargetEl().on("resize",function(c){b._setResultsHeight();var d=20;b.items.each(function(e){d+=e.getHeight()});b.setSize({height:d})})},this);b.callParent(arguments)},switchModes:function(a){this.setMode(a);
this.editor.switchModes(a);a=-1<a.indexOf("javascript");this.down("notebookwrapperrun").setVisible(a);this.down("notebookwrapperexport").setVisible(!a);this.queryById("runMultiple").setVisible(a);this.results.setVisible(a)},run:function(a){if("ace/mode/javascript"===this.editor.getMode()){if(!0===a||this.getIsWarnedAboutPreviousCells())return this._run();var b=this.up("notebook");Ext.Array.each(b.query("notebookcodeeditorwrapper"),function(c){if(c===this)return this._run(),!1;if(c.editor&&"ace/mode/javascript"===
c.editor.getMode()&&!1===c.getIsRun())return Ext.Msg.confirm(this.localize("previousNotRunTitle"),this.localize("previousNotRun"),function(d){"yes"===d?b.runUntil(this):this._run()},this),this.setIsWarnedAboutPreviousCells(!0),!1},this)}},_run:function(){this.results.show();this.results.update(this.EMPTY_RESULTS_TEXT);this.results.mask("working\u2026");var a=this.editor.getValue();Voyant.notebook.util.Show.TARGET=this.results.getResultsEl();Voyant.notebook.Notebook.currentBlock=this;Voyant.notebook.Notebook.currentNotebook.setCurrentBlock(this);
try{var b=eval.call(window,a)}catch(d){return this.results.unmask(),Voyant.notebook.util.Show.showError(d),this.getTargetEl().fireEvent("resize"),d}this.setIsRun(!0);if(void 0!==b)if(b.then&&b.catch&&b.finally){var c=this;b.then(function(d){c.results.unmask();void 0!==d&&c._showResult(d)}).catch(function(d){c.results.unmask();Voyant.notebook.util.Show.showError(d)}).finally(function(){Ext.defer(function(){this.getTargetEl().fireEvent("resize")},50,c)})}else this.results.unmask(),this._showResult(b),
this.getTargetEl().fireEvent("resize");else this.results.unmask(),this.getTargetEl().fireEvent("resize");return b},_getResultsComponent:function(a,b){var c=this;b=void 0===b.expandResults?c.config.expandResults:b.expandResults;return Ext.create("Ext.Container",{itemId:"parent",cls:"notebook-code-results",height:c.config.emptyResultsHeight,layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",flex:1,layout:{type:"absolute"},items:[{xtype:"component",itemId:"results",x:0,y:0,anchor:"100%",
height:"100%",html:a},{xtype:"toolbar",itemId:"buttons",hidden:!0,x:0,y:0,style:{background:"none",paddingTop:"0px",pointerEvents:"none"},defaults:{style:{pointerEvents:"auto"}},items:["->",{itemId:"expandButton",glyph:b?"xf066@FontAwesome":"xf065@FontAwesome",tooltip:b?"Contract Results":"Expand Results",handler:function(){c.results.doExpandContract()}},{xtype:"notebookwrapperexport",exportType:"output"},{glyph:"xf014@FontAwesome",tooltip:"Remove Results",handler:function(){c.clearResults()}}]}]},
{xtype:"component",itemId:"expandWidget",height:20,hidden:b?!0:!1,style:{textAlign:"center",fontSize:"26px",cursor:"pointer",borderTop:"1px solid #DDD"},html:"&#8943;",listeners:{afterrender:function(d){d.getEl().on("click",function(){c.results.doExpandContract()})}}}],getValue:function(){return this.getResultsEl().dom.cloneNode(!0).innerHTML},getResultsEl:function(){return this.down("#results").getEl()},doExpandContract:function(){var d=c.results.down("#expandButton");c.getExpandResults()?(c.setExpandResults(!1),
d.setTooltip("Expand Results"),d.setGlyph("xf065@FontAwesome")):(c.setExpandResults(!0),d.setTooltip("Contract Results"),d.setGlyph("xf066@FontAwesome"));c.getTargetEl().fireEvent("resize")},update:function(){var d=this.down("#results");d.update.apply(d,arguments)},listeners:{afterrender:function(d){d.getEl().on("mouseover",function(e,f){d.down("#buttons").setVisible(!0)});d.getEl().on("mouseout",function(e,f){d.down("#buttons").setVisible(!1)})}}})},_getUIComponent:function(a){return Ext.create("Ext.Component",
{align:"stretch",cls:"notebook-code-ui",padding:"20 10",html:a,getValue:function(){return this.getTargetEl().dom.cloneNode(!0).innerHTML}})},_showResult:function(a){if(this.results.getResultsEl().dom.innerHTML===this.EMPTY_RESULTS_TEXT)if(a.toString&&(a=a.toString()),a&&a.then){var b=this;a.then(function(c){b.results.update(c);return c})}else this.results.update(a)},_setResultsHeight:function(){var a=this._measureResultsHeight(),b=this.results.getResultsEl(),c=this.results.down("#expandWidget");this.getExpandResults()?
(c.hide(),this.results.setHeight(Math.max(a,this.getEmptyResultsHeight())),b.removeCls("collapsed")):(a=Math.min(Math.max(a,this.getEmptyResultsHeight()),this.getMinimumResultsHeight()),a<this.getMinimumResultsHeight()?c.hide():c.show(),this.results.setHeight(a),b.addCls("collapsed"))},_measureResultsHeight:function(){if(void 0===this.results.paddingHeight){var a=window.getComputedStyle(this.results.getEl().dom);this.results.paddingHeight=parseFloat(a.getPropertyValue("padding-top"))+parseFloat(a.getPropertyValue("padding-bottom"))}a=
this.results.getResultsEl();return 0<a.dom.childElementCount?a.getFirstChild().getHeight()+this.results.paddingHeight:null!==a.dom.firstChild&&a.dom.firstChild.nodeType===Node.TEXT_NODE?Ext.util.TextMetrics.measure(a,a.dom.firstChild.data,a.getWidth()).height+this.results.paddingHeight:this.getEmptyResultsHeight()},clearResults:function(){this.results.show();var a=this.results.el.down(".x-panel");if(a){var b=Ext.getCmp(a.id);b?b.destroy():a.destroy()}else if(this.results.getResultsEl().dom.hasAttribute("data-highcharts-chart")){var c=
this.results.getResultsEl().dom.id,d=void 0;Highcharts.charts.forEach(function(e){void 0!==e&&e.renderTo.id===c&&(d=e)});d?(d.destroy(),a=this.results.getResultsEl().dom,a.style.height="100%",a.style.overflow=""):console.warn("tried to destroy highchart but could not",c)}else this.results.update(" ");this.getTargetEl().fireEvent("resize")},tryToUnmask:function(){Spyral&&Spyral.promises&&Ext.defer(this.tryToUnmask,20,this);if(0===Voyant.application.getDeferredCount()){for(var a in window)"object"==
typeof window[a]&&window[a]&&"opener"!=a&&window[a].isFulfilled&&window[a].isFulfilled()&&(window[a]=window[a].valueOf());this.results.unmask();0===this.results.getTargetEl().getHtml().trim().length&&this.results.hide();this.getTargetEl().fireEvent("resize")}else Ext.defer(this.tryToUnmask,20,this)},getContent:function(){var a={input:this.editor.getValue(),mode:this.getMode()};if("javascript"===a.mode){a.output=this.results.getValue();var b=this.down('component[cls="notebook-code-ui"]');null!==b&&
(a.ui=b.getValue())}return a},setContentAndMode:function(a,b,c){debugger;this.editor.setContent(a);this.switchModes(b||"javascript")}});Ext.define("Voyant.notebook.editor.TextEditor",{extend:"Ext.Component",mixins:["Voyant.util.Localization"],alias:"widget.notebooktexteditor",cls:"notebook-text-editor",config:{ckeditorConfig:{toolbar:[{name:"basicstyles",items:["Bold","Italic","-","RemoveFormat"]},{name:"paragraph",items:"NumberedList BulletedList - Justify Outdent Indent Blockquote JustifyLeft JustifyCenter JustifyRight".split(" ")},{name:"colors",items:["TextColor","BGColor"]},{name:"styles",items:["Styles","Format"]},{name:"links",
items:["Link","Unlink","Anchor"]},{name:"insert",items:["Image","Table"]},{name:"document",items:["inserthtml4x","Sourcedialog","Stopediting"]}],extraPlugins:"stopediting,sourcedialog,justify,colorbutton,inserthtml4x",allowedContent:!0,toolbarCanCollapse:!1,startupFocus:!0},editor:void 0,isEditRegistered:!1,currentHeight:0},statics:{i18n:{}},border:!1,constructor:function(a){Ext.apply(this,{html:a.content?a.content:this.localize("emptyText")});this.callParent(arguments)},listeners:{boxready:function(a){this.getTargetEl().on("click",
function(b,c){"A"!=c.tagName&&this.handleClick(a)},this)},removed:function(a,b){a.getEditor()&&(a.getEditor().focusManager.blur(!0),a.getEditor().destroy())}},handleClick:function(a){if(!a.getEditor()||a.getEditor()&&a.getEditor().readOnly){var b=this.getTargetEl();b.set({contenteditable:!0});this.findParentByType("notebookeditorwrapper").setIsEditing(!0);if(a.getEditor())a.getEditor().setReadOnly(!1);else{var c=CKEDITOR.inline(b.dom,this.getCkeditorConfig());c.on("focus",function(d){this.getTargetEl().dom.innerText==
this.localize("emptyText")&&this.getTargetEl().update("")},this);c.on("blur",function(d){a.findParentByType("notebookeditorwrapper").setIsEditing(!1).getEl().fireEvent("mouseout");c.setReadOnly(!0)});c.on("change",function(){var d=c.container.$.clientHeight;d!=this.getCurrentHeight()&&(this.findParentByType("notebookeditorwrapper").setHeight(d),this.setCurrentHeight(c.container.$.clientHeight));if(this.getIsEditRegistered()){var e=this;setTimeout(function(){e.setIsEditRegistered(!1)},3E4)}else this.findParentByType("notebook").setIsEdited(!0),
this.setIsEditRegistered(!0)},this);this.setEditor(c)}}},getContent:function(){return this.getTargetEl().dom.innerHTML}});Ext.define("Voyant.notebook.editor.TextEditorWrapper",{extend:"Voyant.notebook.editor.EditorWrapper",requires:["Voyant.notebook.editor.TextEditor","Voyant.notebook.editor.button.Edit"],alias:"widget.notebooktexteditorwrapper",cls:"notebook-text-wrapper",config:{content:""},minHeight:85,constructor:function(a){Ext.apply(this,{items:[{xtype:"notebooktexteditor",content:Ext.Array.from(a.input).join("")}],dockedItems:[{xtype:"toolbar",dock:"left",items:[{xtype:"notebookwrapperadd"}]},{xtype:"toolbar",
dock:"right",items:[{xtype:"notebookwrappercounter",order:a.order,name:a.cellId},{xtype:"notebookwrapperremove"},{xtype:"notebookwrappermoveup"},{xtype:"notebookwrappermovedown"}]}]});this.callParent(arguments)},getContent:function(){return this.items.get(0).getContent()}});Ext.define("Voyant.notebook.github.OctokitWrapper",{extend:"Ext.Base",alias:"octokitwrapper",octokit:void 0,constructor:function(a){this.octokit=new Octokit({auth:a.authToken,userAgent:"https://github.com/sgsinclair/Voyant"})},getInfoForAuthenticatedUser:function(){return this.octokit.users.getAuthenticated()},getReposForAuthenticatedUser:function(a,b,c){return this.octokit.repos.listForAuthenticatedUser({affiliation:void 0===a?"owner":a,page:void 0===b?0:b,per_page:void 0===c?10:c})},getReposForUser:function(a,
b,c){return this.octokit.search.repos({q:"user:"+a,page:void 0===b?0:b,per_page:void 0===c?10:c})},searchWithinRepositories:function(a,b,c){console.log(a)},getRepoContents:function(a){a=this.parseFullName(a);return this.getBranchSHAs({owner:a.owner,repo:a.repo,branch:"master"}).then(function(b){return this.getTreeContentsRecursively(b)}.bind(this))},getTreeContentsRecursively:function(a){return this.octokit.git.getTree({owner:a.owner,repo:a.repo,tree_sha:a.baseTreeSHA,recursive:1,headers:{"If-None-Match":""}}).then(function(b){return Object.assign({},
a,{contents:this.unflattenContents(b.data.tree),truncated:b.data.truncated})}.bind(this))},loadFile:function(a,b){a=this.parseFullName(a);var c=a.owner,d=a.repo;return this.octokit.repos.getContents({owner:c,repo:d,ref:"master",path:b}).then(function(e){return{owner:c,repo:d,ref:"master",path:b,sha:e.data.sha,file:atob(e.data.content)}}.bind(this))},doesRepoExist:function(a,b){return this.getRepoContents(a+"/"+b).then(function(c){return!0}.bind(this),function(c){console.log(c);return!1}.bind(this))},
getPermissionsForUser:function(a,b,c){return this.octokit.repos.getCollaboratorPermissionLevel({owner:a,repo:b,username:c}).then(function(d){return d.data.permission}.bind(this),function(d){return"none"}.bind(this))},saveFile:function(a,b,c,d,e,f,g){var h=this;return $jscomp.asyncExecutePromiseGeneratorProgram(function(k){if(1==k.nextAddress)return void 0!==g?k.jumpTo(2):k.yield(h.getLatestFileSHA({owner:a,repo:b,branch:e,path:c}),3);2!=k.nextAddress&&(g=k.yieldResult);return k.return(h.octokit.repos.createOrUpdateFile({owner:a,
repo:b,path:c,content:btoa(d),branch:e,message:f,sha:g}))})},parseFullName:function(a){var b=$jscomp.makeIterator(a.split("/"));a=b.next().value;b=b.next().value;return{owner:a,repo:b}},getBranchSHAs:function(a){return this.octokit.repos.getBranch({owner:a.owner,repo:a.repo,branch:a.branch,headers:{"If-None-Match":""}}).then(function(b){return Object.assign({},a,{baseTreeSHA:b.data.commit.commit.tree.sha,parentCommitSHA:b.data.commit.sha})})},getLatestFileSHA:function(a){var b=this,c,d,e,f,g,h,k,
l,m,n,r;return $jscomp.asyncExecutePromiseGeneratorProgram(function(u){if(1==u.nextAddress)return c=a,d=c.owner,e=c.repo,f=c.branch,g=c.path,u.yield(b.octokit.request({method:"POST",url:"/graphql",query:'{\n\t\t\t\trepository(owner: "'+d+'", name: "'+e+'") {\n\t\t\t\t\tobject(expression: "'+f+":"+g+'") {\n\t\t\t\t\t\t... on Blob {\n\t\t\t\t\t\t\toid\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}'}).catch(function(q){console.log(q)}),2);h=u.yieldResult;k=h.data;l=k.data;m=l.repository;r=(n=m.object)?
n.oid:void 0;return u.return(r)})},unflattenContents:function(a){var b={type:"folder",name:"",path:"",contents:[]},c=function(d,e){return d.contents.find(function(f){return"folder"===f.type&&f.name===e})};a.filter(function(d){return"blob"===d.type}).forEach(function(d){var e=d.path.split("/");e.reduce(function(f,g,h){var k=c(f,g);if(k)return k;if(e.length-1==h)f.contents.push({type:"file",name:g,path:f.path+"/"+g});else return g={type:"folder",name:g,path:f.path+"/"+g,contents:[]},f.contents.push(g),
g},b)});return b}});Ext.define("Voyant.notebook.github.ReposBrowser",{extend:"Ext.container.Container",xtype:"githubreposbrowser",config:{repoType:"owner",selectedNode:void 0,repoId:void 0,path:void 0},octokit:void 0,constructor:function(a){a=a||{};this.octokit=a.octokit;this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"hbox",align:"stretch",pack:"start"},items:[{layout:{type:"vbox",align:"stretch",pack:"start"},flex:1,items:[{layout:{type:"accordion"},items:[{title:"My Repositories",
frame:!0,items:{xtype:"radiogroup",fieldLabel:"Show repositories for which I am",labelAlign:"top",layout:"vbox",items:[{boxLabel:"Owner",name:"repoType",inputValue:"owner",checked:!0},{boxLabel:"Collaborator",name:"repoType",inputValue:"collaborator"},{boxLabel:"Organization Member",name:"repoType",inputValue:"organization_member"}],listeners:{change:function(a,b,c){var d=this;this.setRepoType(b.repoType);this.clearTree(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(e){d.addReposToTree(e.data)},
function(e){console.log(e)})},scope:this}},listeners:{expand:function(){var a=this;this.clearTree(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(b){a.addReposToTree(b.data)},function(b){console.log(b)})},scope:this}},{title:"Public Repositories",frame:!0,layout:"vbox",items:[{fieldLabel:"Limit to user or organization",labelAlign:"top",xtype:"textfield"},{text:"Search",xtype:"button",handler:function(a){var b=this;a=a.prev("textfield").getValue();""!==a&&(this.clearTree(!0),
this.octokit.getReposForUser(a,0,100).then(function(c){b.addReposToTree(c.data.items)},function(c){console.log(c)}))},scope:this}],listeners:{expand:function(){this.clearTree()},scope:this}}]}]},{flex:2,layout:"fit",xtype:"treepanel",itemId:"repoTree",title:"Repositories",scrollable:!0,rootVisible:!1,viewConfig:{emptyText:"No results",listeners:{afteritemexpand:function(a,b,c){if(!1===a.hasChildNodes())switch(a.data.type){case "repo":var d=c.querySelector("tr");Ext.fly(d).addCls("x-grid-tree-loading");
this.octokit.getRepoContents(a.getId()).then(function(e){Ext.fly(d).removeCls("x-grid-tree-loading");this.addRepoContentsToNode(a,e)}.bind(this))}},itemclick:function(a,b,c){this.setSelectedNode(b);this.fireEvent("nodeSelected",this,b.data.type,b)},scope:this}},store:{root:{name:"Root",children:[]}}}],listeners:{boxready:function(){var a=this;this.down("#repoTree").setLoading(!0);this.octokit.getReposForAuthenticatedUser(this.getRepoType(),0,100).then(function(b){a.addReposToTree(b.data)},function(b){console.log(b)})}}});
this.callParent(arguments)},updateSelectedNode:function(a,b){if(void 0!==a){for(b=a;null!==b&&"repo"!==b.data.type;)b=b.parentNode;this.setRepoId(b.getId());this.setPath(a.getId())}else this.setRepoId(void 0),this.setPath(void 0)},clearTree:function(a){var b=this.down("#repoTree");b.getRootNode().removeAll();b.getView().refresh();a&&b.setLoading(!0);this.setSelectedNode(void 0);this.fireEvent("nodeDeselected",this)},addReposToTree:function(a){var b=this.down("#repoTree");b.setLoading(!1);b=b.getRootNode();
a=a.map(function(c){return{id:c.full_name,text:c.full_name,description:c.description,leaf:!1,type:"repo"}});b.appendChild(a)},addRepoContentsToNode:function(a,b){function c(d){var e={id:d.path,text:d.name,type:d.type,leaf:"file"===d.type};!1===e.leaf&&(e.children=[],d.contents.forEach(function(f){e.children.push(c(f))}));return e}b=c(b.contents);a.appendChild(b.children)}});Ext.define("Voyant.notebook.github.FileSaver",{extend:"Ext.container.Container",xtype:"githubfilesaver",config:{currentFile:void 0,username:void 0},octokit:void 0,saveData:void 0,constructor:function(a){a=a||{};this.octokit=a.octokit;this.saveData=a.saveData;this.setCurrentFile(a.currentFile);this.callParent(arguments)},initComponent:function(){Ext.apply(this,{layout:{type:"vbox",pack:"start",align:"stretch"},items:[{xtype:"githubreposbrowser",octokit:this.octokit,itemId:"repoBrowser",flex:1,listeners:{nodeSelected:function(a,
b,c){c=this.queryById("saveForm").getForm();var d=$jscomp.makeIterator(a.getRepoId().split("/")),e=d.next().value;d=d.next().value;c.setValues({owner:e,repo:d});"file"===b?(a=this.getPathComponents(a.getPath()),c.setValues(Object.assign({},a))):"folder"===b?(a=a.getPath().replace(/^\//,""),c.setValues({folder:a,file:""})):"repo"===b&&c.setValues({folder:"",file:""})},nodeDeselected:function(a){},scope:this}},{bodyPadding:"10",height:200,layout:{type:"vbox",pack:"start"},xtype:"form",itemId:"saveForm",
items:[{html:'<span class="x-panel-header-title-default">Repository Path</span>'},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"GitHub User",name:"owner",allowBlank:!1,margin:"0 10 0 0"},{fieldLabel:"Repository Name",allowBlank:!1,name:"repo"}]},{html:'<span class="x-panel-header-title-default">File Path</span>',margin:"10 0 0 0"},{xtype:"container",layout:"hbox",defaults:{xtype:"textfield",labelAlign:"top"},items:[{fieldLabel:"Folder(s)",name:"folder",
allowBlank:!0,margin:"0 10 0 0"},{fieldLabel:"File Name",allowBlank:!1,name:"file"}]},{itemId:"status",html:"",margin:"15 0 0 0"}],listeners:{validitychange:function(a,b){this.fireEvent("formValidityChange",this,b)},scope:this}}],listeners:{boxready:function(){this.initForm()},scope:this}});this.callParent(arguments)},initForm:function(){this.octokit.getInfoForAuthenticatedUser().then(function(a){var b=a.data.login;this.setUsername(b);a=this.queryById("saveForm").getForm();var c=this.getCurrentFile();
void 0!==c?(b=this.getPathComponents(c.path),a.setValues(Object.assign({},{owner:c.owner,repo:c.repo},b))):a.setValues({owner:b})}.bind(this))},getPathComponents:function(a){a=a.split("/");var b=a[a.length-1],c="";2<a.length&&(c=a.slice(0,-1).join("/"));return{folder:c,file:b}},doSave:function(a){var b=this,c,d,e,f,g,h,k,l,m,n,r,u,q;return $jscomp.asyncExecutePromiseGeneratorProgram(function(p){switch(p.nextAddress){case 1:c=b.queryById("saveForm").getForm();if(!c.isValid()){b.setStatus("Form is not valid",
"error");p.jumpTo(0);break}d=c.getValues();e=d.owner;f=d.repo;g=d.folder;k=h=d.file;""!==g&&(k=g+"/"+h);b.setStatus("Checking repository");return p.yield(b.octokit.doesRepoExist(e,f),3);case 3:l=p.yieldResult;if(!l){b.setStatus("The specified repository does not exist","error");p.jumpTo(0);break}b.setStatus("Checking permissions");return p.yield(b.octokit.getPermissionsForUser(e,f,b.getUsername()),5);case 5:m=p.yieldResult;if("none"===m||"read"===m){b.setStatus("You don't have permission to write to this repository",
"error");p.jumpTo(0);break}b.setStatus("Checking file");n="master";r=b.saveData;u={owner:e,repo:f,branch:n,path:k};return p.yield(b.octokit.getLatestFileSHA(u),7);case 7:q=p.yieldResult,void 0!==q?b.octokit.saveFile(e,f,k,r,n,"File updated by Spyral",q).then(function(v){this.setStatus("File updated");setTimeout(function(){this.fireEvent("fileSaved",this,u)}.bind(this),500)}.bind(b),function(v){this.setStatus("Error: "+v.message,"error")}):b.octokit.saveFile(e,f,k,r,n,"File created by Spyral").then(function(v){this.setStatus("File created");
setTimeout(function(){this.fireEvent("fileSaved",this,u)}.bind(this),500)}.bind(b),function(v){this.setStatus("Error: "+v.message,"error")}),p.jumpToEnd()}})},setStatus:function(a,b){var c="";b&&"error"===b&&(c="x-form-invalid-under-default");this.queryById("status").setHtml('<span class="'+c+'">'+a+"</span>")}});Ext.define("Voyant.notebook.github.GitHubDialogs",{extend:"Ext.Component",requires:["Voyant.notebook.github.OctokitWrapper","Voyant.notebook.github.ReposBrowser","Voyant.notebook.github.FileSaver"],alias:"widget.githubdialogs",config:{repoType:"owner",currentFile:void 0},authToken:void 0,octokitWrapper:void 0,currentWindow:void 0,constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},close:function(){void 0!==this.currentWindow&&(this.currentWindow.close(),
this.currentWindow=void 0)},showAuthenticate:function(a){var b=this,c=void 0;c=Ext.create("Ext.window.Window",{title:"Authenticate with GitHub",width:750,height:550,closable:!1,layout:{type:"vbox",align:"middle",pack:"center"},items:[{html:'<div style="margin-bottom: 10px;">You must authorize Spyral to use GitHub on your behalf.</div>'},{xtype:"button",text:"Authorize with GitHub",handler:function(d){function e(f){f.origin===window.location.origin&&"oauth_cookie_set"===f.data&&(window.removeEventListener("message",
e,!1),f.source.close(),b.initOctokitWrapper(),d.up("window").close(),a.call(b))}window.open(Voyant.application.getBaseUrlFull()+"spyral/oauth","_blank");window.addEventListener("message",e,!1)}}],buttons:[{text:"Cancel",handler:function(){b.close()}}]});c.show();this.currentWindow=c},showLoad:function(){var a=this;this.authToken=this.getCookieValue("access-token");if(""===this.authToken)this.showAuthenticate(this.showLoad);else{void 0===this.octokitWrapper&&this.initOctokitWrapper();var b=void 0;
b=Ext.create("Ext.window.Window",{title:"Load from GitHub",width:750,height:550,closable:!1,maximizable:!0,layout:"fit",items:{xtype:"githubreposbrowser",octokit:this.octokitWrapper,itemId:"repoBrowser",listeners:{nodeSelected:function(c,d,e){"file"===d?b.queryById("load").setDisabled(!1):b.queryById("load").setDisabled(!0)},nodeDeselected:function(c){b.queryById("load").setDisabled(!0)}}},buttons:[{text:"Load Selected",itemId:"load",disabled:!0,handler:function(){var c=b.queryById("repoBrowser");
this.loadFile(c.getRepoId(),c.getPath())},scope:this},{text:"Cancel",handler:function(){a.close()}}]});b.show();this.currentWindow=b}},showSave:function(a){var b=this;this.authToken=this.getCookieValue("access-token");if(""===this.authToken)this.showAuthenticate();else{void 0===this.octokitWrapper&&this.initOctokitWrapper();var c=void 0;c=Ext.create("Ext.window.Window",{title:"Save to GitHub",width:750,height:650,closable:!1,maximizable:!0,layout:"fit",items:{xtype:"githubfilesaver",octokit:this.octokitWrapper,
currentFile:this.getCurrentFile(),saveData:a,itemId:"fileSaver",listeners:{formValidityChange:function(d,e){c.queryById("save").setDisabled(!e)},fileSaved:function(d,e){b.fireEvent("fileSaved",b,e)}}},buttons:[{text:"Save",itemId:"save",disabled:!0,handler:function(){c.queryById("fileSaver").doSave()},scope:this},{text:"Cancel",handler:function(){b.close();b.fireEvent("saveCancelled",b)}}]});c.show();this.currentWindow=c}},getCookieValue:function(a){var b=(" "+document.cookie).match(new RegExp("[; ]"+
a+"=([^\\s;]*)"));return a&&b?unescape(b[1]):""},initOctokitWrapper:function(){this.authToken=this.getCookieValue("access-token");this.octokitWrapper=new Voyant.notebook.github.OctokitWrapper({authToken:this.authToken})},loadFileFromId:function(a){var b=decodeURIComponent(a).split("/");3<=b.length&&(a=b[0]+"/"+b[1],b=b.slice(2).join("/"),this.loadFile(a,b))},loadFile:function(a,b){var c=this;this.authToken=this.getCookieValue("access-token");""===this.authToken?this.showAuthenticate(this.loadFile.bind(this,
a,b)):(void 0===this.octokitWrapper&&this.initOctokitWrapper(),this.octokitWrapper.loadFile(a,b).then(function(d){c.setCurrentFile(d);c.fireEvent("fileLoaded",c,d)}))}});Ext.define("Voyant.notebook.StorageDialogs",{extend:"Ext.Component",requires:[],alias:"",config:{accessCode:void 0},constructor:function(a){a=a||{};this.callParent(arguments)},initComponent:function(){this.callParent(arguments)},showSave:function(a,b,c){c=void 0===c?"":c;var d=this,e=""===c;Ext.create("Ext.window.Window",{title:e?"Save New Notebook":"Overwrite Existing Notebook",items:[{xtype:"form",width:450,bodyPadding:5,plugins:["datatip"],listeners:{beforeshowtip:function(f,g,h){return!g.currentTarget.el.hasCls("x-form-invalid")}},
layout:"anchor",defaults:{labelAlign:"right",labelWidth:160,width:360,inputAttrTpl:'spellcheck="false"',xtype:"textfield"},items:[{fieldLabel:"Notebook ID"+(e?" (optional)":""),name:"notebookId",value:c,allowBlank:!0,readOnly:!e,tooltip:"An ID used to identify this notebook. If left blank, one will be generated for you.",validator:function(f){return""==f?!0:null===f.match(/^[\w-]{4,16}$/)?"The ID must be between 4 and 16 alphanumeric characters.":!0}},{fieldLabel:"Access Code",name:"accessCode",allowBlank:!1,
value:e?this.generateAccessCode():this.getAccessCode(),tooltip:"The Access Code is required to overwrite this notebook.",validator:function(f){return null===f.match(/^[\w-]{4,16}$/)?"The access code must be between 4 and 16 alphanumeric characters.":!0}},{fieldLabel:"Email (optional)",name:"email",allowBlank:!0,vtype:"email",hidden:!e,tooltip:"An email will be sent to this address with the Notebook URL and Access Code."}]}],buttons:[{text:"Cancel",ui:"default-toolbar",handler:function(){this.up("window").close();
d.fireEvent("saveCancelled",d)}}," ",{text:"Save",handler:function(f){var g=f.up("window"),h=g.down("form").getForm();if(h.isValid()){var k=h.getValues();k.data=a;k.metadata=b;e&&""!==k.notebookId?d.doesNotebookIdExist(k.notebookId).then(function(l){l?h.findField("notebookId").markInvalid("That Notebook ID already exists."):(d.doSave(k),g.close())}):(f.setDisabled(!0),d.doSave(k).then(function(l){f.setDisabled(!1);l?g.close():h.findField("accessCode").markInvalid("Invalid access code.")}))}}}],listeners:{close:function(){d.fireEvent("close",
d)}}}).show()},doesNotebookIdExist:function(a){var b=new Ext.Deferred;Spyral.Load.trombone({tool:"notebook.GitNotebookManager",action:"exists",id:a,noCache:1}).then(function(c){b.resolve("true"===c.notebook.data)}).catch(function(c){console.log(c)});return b.promise},doSave:function(a){var b=a.notebookId,c=a.accessCode,d=a.email,e=a.data;a=a.metadata;var f=this;a.id=b;return Spyral.Load.trombone({tool:"notebook.GitNotebookManager",action:"save",id:b,accessCode:c,email:d,data:e,metadata:JSON.stringify(a)}).then(function(g){if("true"!==
g.notebook.data)return!1;f.setAccessCode(c);f.fireEvent("fileSaved",f,g.notebook.id);return!0}).catch(function(g){f.fireEvent("fileSaved",f,null);return!1})},generateAccessCode:function(){for(var a="abcdefghijklmnopqrstuvwxyz".split(""),b="";6>b.length;)if(.3>Math.random())b+=Math.floor(9*Math.random());else{var c=a[Math.floor(Math.random()*a.length)];.5>Math.random()&&(c=c.toUpperCase());b+=c}return b},reset:function(){this.setAccessCode(void 0)}});Ext.define("Voyant.notebook.Catalogue",{extend:"Ext.Component",requires:[],alias:"widget.notebookcatalogue",statics:{i18n:{}},window:void 0,store:void 0,template:void 0,config:{},constructor:function(){this.store=Ext.create("Ext.data.JsonStore",{fields:[{name:"id"},{name:"author"},{name:"title"},{name:"description"},{name:"keywords"},{name:"language"},{name:"license"},{name:"created",type:"date"},{name:"modified",type:"date"},{name:"version"}]});this.template=new Ext.XTemplate('<tpl for=".">','<div class="catalogue-notebook">',
'<div class="id">{id}</div>','<div class="title nowrap" title="{title}">{title}</div>','<div class="author nowrap"><i class="fa fa-user" aria-hidden="true"></i> {author}</div>','<div class="dates"><span class="date"><i class="fa fa-clock-o" aria-hidden="true"></i> {[Ext.Date.format(values.modified, "M j Y")]}</span></div>',"</div>","</tpl>");this.callParent(arguments)},initComponent:function(a){this.callParent(arguments)},showWindow:function(){void 0===this.window&&(this.window=Ext.create("Ext.window.Window",
{title:"Notebooks Catalogue",width:700,height:550,layout:{type:"vbox"},closeAction:"hide",items:[{xtype:"toolbar",height:30,hidden:!0,items:[{xtype:"splitbutton",text:"Sort",glyph:"xf161@FontAwesome",menu:{defaults:{xtype:"menucheckitem",group:"sortfield"},items:[{itemId:"id",text:"ID"},{itemId:"created",text:"Created"},{itemId:"modified",text:"Modified",checked:!0},{itemId:"title",text:"Title"},{itemId:"author",text:"Author"}],listeners:{click:function(a,b){a="xf161@FontAwesome"===a.up().getGlyph().glyphConfig?
"DESC":"ASC";this.store.sort(b.itemId,a);this.window.down("#catalogue").refresh()},scope:this}},handler:function(a){if("xf161@FontAwesome"===a.getGlyph().glyphConfig){a.setGlyph("xf160@FontAwesome");var b="ASC"}else a.setGlyph("xf161@FontAwesome"),b="DESC";a=a.menu.down("[checked=true]").itemId;this.store.sort(a,b);this.window.down("#catalogue").refresh()},scope:this}]},{xtype:"dataview",flex:1,width:"100%",padding:10,scrollable:"vertical",itemId:"catalogue",store:this.store,tpl:this.template,itemSelector:"div.catalogue-notebook",
overItemCls:"catalogue-notebook-over",selectedItemCls:"catalogue-notebook-selected"}],buttons:[{text:"Load Selected Notebook",handler:function(a){a=this.window.down("#catalogue").getSelection()[0];void 0!==a&&this.fireEvent("notebookSelected",this,a.get("id"))},scope:this}]}));this.window.show();this.getNotebooks()},hideWindow:function(){void 0!==this.window&&this.window.close()},getNotebooks:function(a,b){this.window.mask("Loading");this.window.down("#catalogue").getSelectionModel().deselectAll();
var c=this;Spyral.Load.trombone({tool:"notebook.GitNotebookManager",action:"catalogue",limit:100,noCache:1}).then(function(d){c.window.unmask();d=JSON.parse(d.notebook.data);c.store.loadRawData(d)}).catch(function(d){c.window.unmask()})}});Ext.define("Voyant.notebook.Notebook",{alternateClassName:["Notebook"],extend:"Ext.panel.Panel",requires:"Voyant.notebook.editor.CodeEditorWrapper Voyant.notebook.editor.TextEditorWrapper Voyant.notebook.util.Show Voyant.panel.Cirrus Voyant.panel.Summary Voyant.notebook.StorageDialogs Voyant.notebook.github.GitHubDialogs".split(" "),mixins:["Voyant.panel.Panel"],alias:"widget.notebook",statics:{i18n:{title:"Spyral",metadataEditor:"Edit Metadata",metadataTitle:"Title",metadataTip:"Edit notebook metadata.",
metadataAuthor:"Author(s)",metadataKeywords:"Keywords",metadataDescription:"Description",metadataLicense:"Licence",metadataLanguage:"Language",metadataReset:"Reset",metadataSave:"Save",metadataCancel:"Cancel",created:"Created",modified:"Modified",clickToEdit:"Click to edit",cantLoadNotebook:"Unable to load Spyral notebook:",cannotLoadJson:"Unable to parse JSON input.",cannotLoadJsonUnrecognized:"Unable to recognize JSON input.",cannotLoadUnrecognized:"Unable to recognize input.",openTitle:"Open",
openMsg:"Paste in Notebook ID, a URL or a Spyral data file (in HTML).",exportHtmlDownload:"HTML (download)",errorParsingDomInput:"An error occurred while parsing the input of the document. The results might still work, except if the code contained HTML tags."},api:{input:void 0,inputEncodedBase64Json:void 0,run:void 0},currentNotebook:void 0},config:{notebookId:void 0,metadata:void 0,isEdited:!1,version:"3.0",currentBlock:void 0,storageSolution:"voyant"},metadataWindow:void 0,voyantStorageDialogs:void 0,
githubDialogs:void 0,catalogueWindow:void 0,spyralTernDocs:void 0,constructor:function(a){Voyant.notebook.Notebook.currentNotebook=this;Ext.apply(a,{title:this.localize("title"),autoScroll:!0,includeTools:{help:!0,gear:!0,save:!0,saveIt:{tooltip:this.localize("saveItTip"),itemId:"saveItTool",xtype:"toolmenu",glyph:"xf0c2@FontAwesome",disabled:!0,items:[{text:"Save",xtype:"menuitem",glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,!1),scope:this},{text:"Save As...",xtype:"menuitem",
glyph:"xf0c2@FontAwesome",handler:this.showSaveDialog.bind(this,!0),scope:this},"-",{text:"Storage",xtype:"menuitem",menu:{items:[{text:"Voyant",xtype:"menucheckitem",group:"storageSolution",checked:!0,handler:this.setStorageSolution.bind(this,"voyant"),scope:this},{text:"GitHub",xtype:"menucheckitem",group:"storageSolution",checked:!1,handler:this.setStorageSolution.bind(this,"github"),scope:this}]}}]},"new":{tooltip:this.localize("newTip"),callback:function(){var b=this.getBaseUrl()+"spyral/";this.getApplication().openUrl(b)},
xtype:"toolmenu",glyph:"xf067@FontAwesome",scope:this},open:{tooltip:this.localize("openTip"),xtype:"toolmenu",glyph:"xf115@FontAwesome",callback:function(b,c){b=this.getStorageSolution();void 0!==b&&(setTimeout(function(){c.toolMenu.hide()}),"github"===b?this.githubDialogs.showLoad():Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(d,e){e=e.trim();"ok"==d&&(this.clear(),this.loadFromString(e))},this,!0))},scope:this,items:[{text:"Load",xtype:"menuitem",glyph:"xf115@FontAwesome",
handler:function(){Ext.Msg.prompt(this.localize("openTitle"),this.localize("openMsg"),function(b,c){c=c.trim();"ok"==b&&(this.clear(),this.loadFromString(c))},this,!0)},scope:this},{text:"Load from GitHub",xtype:"menuitem",glyph:"xf115@FontAwesome",handler:function(){this.githubDialogs.showLoad()},scope:this}]},runall:{tooltip:this.localize("runallTip"),callback:this.runAll,xtype:"toolmenu",glyph:"xf04e@FontAwesome",scope:this},metadata:{tooltip:this.localize("metadataTip"),callback:this.showMetadataEditor,
xtype:"toolmenu",glyph:"xf02c@FontAwesome",scope:this},catalogue:{tooltip:"catalogue",callback:function(){this.catalogueWindow.showWindow()},xtype:"toolmenu",glyph:"xf00b@FontAwesome",scope:this}},items:[{itemId:"spyralHeader",cls:"spyral-header",listeners:{afterrender:function(b){Ext.tip.QuickTipManager.register({target:b.getId(),text:this.localize("clickToEdit")});b.getTargetEl().on("click",function(c){this.showMetadataEditor();b.removeCls("editable")},this);b.mon(b.getEl(),"mouseover",function(){b.addCls("editable")});
b.mon(b.getEl(),"mouseout",function(){b.removeCls("editable")})},scope:this}},{xtype:"container",itemId:"cells"},{itemId:"spyralFooter",cls:"spyral-footer",listeners:{afterrender:function(b){Ext.tip.QuickTipManager.register({target:b.getId(),text:this.localize("clickToEdit")});b.getTargetEl().on("click",function(c){this.showMetadataEditor();b.removeCls("editable")},this);b.mon(b.getEl(),"mouseover",function(){b.addCls("editable")});b.mon(b.getEl(),"mouseout",function(){b.removeCls("editable")})},
scope:this}}],listeners:{afterrender:this.init,notebookWrapperMoveUp:this.notebookWrapperMoveUp,notebookWrapperMoveDown:this.notebookWrapperMoveDown,notebookWrapperRemove:this.notebookWrapperRemove,notebookWrapperAdd:this.notebookWrapperAdd,notebookLoaded:this.autoExecuteCells,scope:this}});this.callParent(arguments);this.mixins["Voyant.panel.Panel"].constructor.apply(this,arguments);this.voyantStorageDialogs=new Voyant.notebook.StorageDialogs({listeners:{fileLoaded:function(b){},fileSaved:function(b,
c){this.unmask();null!==c&&((b=this.getNotebookId())&&c==b||this.setNotebookId(c),this.toastInfo({html:this.localize("saved"),anchor:"tr"}),this.setIsEdited(!1))},saveCancelled:function(){},close:function(){this.unmask()},scope:this}});this.githubDialogs=new Voyant.notebook.github.GitHubDialogs({listeners:{fileLoaded:function(b,c){b=c.owner;var d=c.repo,e=c.path;c=c.file;this.githubDialogs.close();this.clear();this.loadFromString(c);c=encodeURIComponent(b+"/"+d+"/"+e);-1===location.search.indexOf(c)&&
(b=this.getBaseUrl()+"spyral/?githubId="+c,window.history.pushState({url:b},"Spyral Notebook: "+c,b))},fileSaved:function(b,c){b=c.owner;var d=c.repo;c=c.path;this.githubDialogs.close();this.unmask();this.toastInfo({html:this.localize("saved"),anchor:"tr"});this.setIsEdited(!1);c=encodeURIComponent(b+"/"+d+"/"+c);-1===location.search.indexOf(c)&&(b=this.getBaseUrl()+"spyral/?githubId="+c,window.history.pushState({url:b},"Spyral Notebook: "+c,b))},saveCancelled:function(b){this.unmask()},scope:this}});
this.catalogueWindow=new Voyant.notebook.Catalogue({listeners:{notebookSelected:function(b,c){b.hideWindow();this.clear();this.loadFromId(c);this.setNotebookId(c)},scope:this}})},init:function(){window.Corpus=Spyral.Corpus;window.Table=Spyral.Table;window.loadCorpus=function(){return Spyral.Corpus.load.apply(Spyral.Corpus.load,arguments)};window.createTable=function(){return Spyral.Table.create.apply(Spyral.Table,arguments)};window.onbeforeunload=function(){if(this.getIsEdited())return""}.bind(this);
Ext.Ajax.request({url:this.getApplication().getBaseUrlFull()+"resources/spyral/docs/spyral.json",callback:function(a,b,c){b&&(this.spyralTernDocs=Ext.JSON.decode(c.responseText),this.spyralTernDocs.Corpus=this.spyralTernDocs.Spyral.Corpus,this.spyralTernDocs.Table=this.spyralTernDocs.Spyral.Table,this.spyralTernDocs.loadCorpus=this.spyralTernDocs.Spyral.Corpus.load,this.spyralTernDocs.createTable=this.spyralTernDocs.Spyral.Table.create);a=Ext.Object.fromQueryString(document.location.search,!0);b=
Ext.isDefined(a.run);c=/\/spyral\/([\w-]+)\/?$/.exec(location.pathname);var d=Ext.isDefined(a.githubId);"inputJsonArrayOfEncodedBase64"in a?Ext.decode(a.inputJsonArrayOfEncodedBase64).forEach(function(f){f=decodeURIComponent(atob(f));0==f.trim().indexOf("<")?this.addText(f):this.addCode(f)},this):a.input?0===a.input.indexOf("http")&&this.loadFromUrl(a.input,b):c?(this.loadFromId(c[1]),this.setStorageSolution("voyant")):d?(this.githubDialogs.loadFileFromId(a.githubId),this.setStorageSolution("github")):
this.addNew();if(b){var e=this;Ext.defer(function(){e.runAll()},100)}},scope:this})},setBlock:function(a,b,c,d){a=a||"";b=b||1;d=d||{};var e=this.query("notebookeditorwrapper"),f=this.getCurrentBlock().id,g=e.findIndex(function(h){return h.id==f});if(0>g+b||g+b>e.length)Ext.Msg.show({title:this.localize("error"),msg:this.localize("blockDoesNotExist"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});else return e[g+b]&&this.getComponent("cells").remove(e[g+b]),this.addCode(Object.assign({},{input:a,
mode:c||"text"},d),g+b)},getBlock:function(a,b){a=a||0;b=b||{};var c=this.query("notebookcodeeditorwrapper"),d=this.getCurrentBlock().id,e=c.findIndex(function(f){return f.id==d});if(0>e+a||e+a>c.length-1)"failQuietly"in b&&b.failQuietly||Ext.Msg.show({title:this.localize("error"),msg:this.localize("blockDoesNotExist"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});else return content=c[e+a].getContent(),content.input},addNew:function(){this.setMetadata(new Spyral.Metadata({title:"<h1>Spyral Notebook</h1>"}));
this.addText("<p>This is a Spyral Notebook, a dynamic document that combines writing, code and data in service of reading, analyzing and interpreting digital texts.</p><p>Spyral Notebooks are composed of text blocks (like this one) and code blocks (like the one below). You can <span class='marker'>click on the blocks to edit</span> them and add new blocks by clicking add icon that appears in the left column when hovering over a block.</p>");var a=this.addCode("");Ext.defer(function(){a.run()},100,
this)},clear:function(){this.setMetadata(new Spyral.Metadata);this.voyantStorageDialogs.reset();this.getComponent("cells").removeAll()},showSaveDialog:function(a){this.mask(this.localize("saving"));this.getMetadata().setDateNow("modified");var b=this.generateExportHtml(),c=this.getMetadata().clone(),d=document.createElement("div");d.innerHTML=c.title;c.title=d.textContent;d.innerHTML=c.description;c.description=d.textContent;d.remove();d=this.getStorageSolution();a||"voyant"!==d||void 0===this.getNotebookId()||
void 0===this.voyantStorageDialogs.getAccessCode()?"github"===d?this.githubDialogs.showSave(b):this.voyantStorageDialogs.showSave(b,c,a?void 0:this.getNotebookId()):this.voyantStorageDialogs.doSave({notebookId:this.getNotebookId(),data:b,metadata:c,accessCode:this.voyantStorageDialogs.getAccessCode()})},loadFromString:function(a){a=a.trim();if(0==a.indexOf("http"))this.loadFromUrl(a);else if(0==a.indexOf("{")){try{var b=JSON.parse(a)}catch(c){return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadJson")+
"<br><pre style='color: red'>"+c+"</pre>",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR})}if(!b.metadata||!b.blocks)return Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotLoadJsonUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});b.blocks.forEach(function(c){Ext.isString(c)&&""!=c?this.addCode({input:c}):c.input&&("text"==c.type?this.addText(c):this.addCode(c))},this)}else if(/^[\w-_]+$/.test(a))this.loadFromId(a);else{if(0!==a.indexOf("<")||-1==a.indexOf("spyral"))return Ext.Msg.show({title:this.localize("error"),
msg:this.localize("cannotLoadUnrecognized"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});this.loadFromHtmlString(a)}return!0},loadFromId:function(a){this.mask(this.localize("loading"));var b=this;Spyral.Load.trombone({tool:"notebook.GitNotebookManager",action:"load",id:a,noCache:1}).then(function(c){b.unmask();b.loadFromString(c.notebook.data);c.notebook.id&&c.notebook.id!=b.getNotebookId()&&b.setNotebookId(c.notebook.id);b.setIsEdited(!1)}).catch(function(c){b.unmask()})},loadFromHtmlString:function(a){var b=
(new DOMParser).parseFromString(a,"text/html");this.setMetadata(new Spyral.Metadata(b));var c=!1;b.querySelectorAll("section.notebook-editor-wrapper").forEach(function(d){var e=d.classList;if(e.contains("notebooktexteditorwrapper"))e=d.querySelector(".notebook-text-editor").innerHTML,this.addText(e,void 0,d.id);else if(e.contains("notebookcodeeditorwrapper")){var f=d.querySelector(".notebook-code-editor-raw");e=/\beditor-mode-(\w+)\b/.exec(f.className)[1];var g=a.indexOf("<section id='"+d.id+"' class='notebook-editor-wrapper notebookcodeeditorwrapper'>"),
h=a.indexOf("<pre class='notebook-code-editor-raw editor-mode-",g);h=a.indexOf(">",h)+1;var k=a.indexOf("</pre>\n<div class='notebook-code-results",h);if(-1===g||-1===h||-1===k){c=!0;input="javascript"===e?f.innerText:f.innerHTML;debugger}else input=a.substring(h,k);f=null!==/\bautoexec\b/.exec(f.className);g=d.querySelector(".notebook-code-results").innerHTML;h=!1===d.querySelector(".notebook-code-results").classList.contains("collapsed");k=d.querySelector(".notebook-code-ui");k=null!==k?k.innerHTML:
void 0;this.addCode({input:input,output:g,expandResults:h,uiHtml:k,mode:e,autoExecute:f},void 0,d.id)}},this);c&&this.showError(this.localize("errorParsingDomInput"));this.fireEvent("notebookLoaded")},runUntil:function(a){var b=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(c){b.push(c);c.clearResults();if(a&&a==c)return!1},this);this._run(b)},runFrom:function(a){var b=[],c=!1;Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(d){a&&a==d&&(c=!0);c&&(b.push(d),d.clearResults())},
this);this._run(b)},runAll:function(){var a=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(b){a.push(b);b.clearResults()},this);this._run(a)},_run:function(a){if(0<a.length){var b=a.shift().run(!0);if(void 0!==b&&b.then&&b.catch&&b.finally){var c=this;b.then(function(){Ext.defer(c._run,100,c,[a])})}else Ext.defer(this._run,100,this,[a])}},autoExecuteCells:function(){var a=[];Ext.Array.each(this.query("notebookcodeeditorwrapper"),function(b){b.getAutoExecute()&&a.push(b)});this._run(a)},
loadFromUrl:function(a,b){var c=this;Spyral.Load.text(a).then(function(d){c.loadFromString(d)})},addText:function(a,b,c){return this._add(a,b,"notebooktexteditorwrapper",c)},addCode:function(a,b,c,d){return this._add(a,b,"notebookcodeeditorwrapper",c,{docs:this.spyralTernDocs})},_add:function(a,b,c,d,e){Ext.isString(a)&&(a={input:a});var f=this.getComponent("cells");b="undefined"===typeof b?f.items.length:b;d="undefined"===typeof d?Spyral.Util.id():d;return f.insert(b,Ext.apply(a,{xtype:c,order:b,
cellId:d},e))},updateMetadata:function(){this.getMetadata();this.getComponent("spyralHeader").update(this.getInnerHeaderHtml());this.getComponent("spyralFooter").update(this.getInnerFooterHtml());this.setIsEdited(!0)},notebookWrapperMoveUp:function(a){var b=this.getComponent("cells");a=b.items.findIndex("id",a.id);0==a?Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotMoveHigher"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING}):(b.move(a,a-1),this.redoOrder())},notebookWrapperMoveDown:function(a){var b=
this.getComponent("cells");a=b.items.findIndex("id",a.id);a==b.items.getCount()-1?Ext.Msg.show({title:this.localize("error"),msg:this.localize("cannotMoveLower"),buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.WARNING}):(b.move(a,a+1),this.redoOrder())},notebookWrapperRemove:function(a){var b=this.getComponent("cells");b.remove(a);0==b.items.length&&this.addText("(Click to edit).");this.redoOrder()},notebookWrapperAdd:function(a,b){var c=this.getComponent("cells").items.findIndex("id",a.id);a=a.getXType(a);
("notebooktexteditorwrapper"==a&&!b.hasModifier()||"notebookcodeeditorwrapper"==a&&b.hasModifier()?this.addCode("",c+1):this.addText("",c+1)).getTargetEl().scrollIntoView(this.getTargetEl(),null,!0,!0);this.redoOrder()},redoOrder:function(){this.query("notebookwrappercounter").forEach(function(a,b){a.setOrder(b)});this.setIsEdited(!0)},setIsEdited:function(a){this.getHeader()&&(this.getHeader().down("#saveItTool").setDisabled(0==a),a||(this.query("notebookcodeeditor").forEach(function(b){b.setIsChangeRegistered(!1)}),
this.query("notebooktexteditor").forEach(function(b){b.setIsEditRegistered(!1)})));this.callParent(arguments)},setNotebookId:function(a){if(a&&-1===location.pathname.indexOf("/spyral/"+a)){var b=this.getBaseUrl()+"spyral/"+a+"/";window.history.pushState({url:b},"Spyral Notebook: "+a,b)}this.callParent(arguments)},generateExportHtml:function(){var a="<!DOCTYPE HTML>\n<html>\n<head>\n\t<meta charset='UTF-8'>\n"+this.getMetadata().getHeaders(),b=document.getElementById("ace-chrome");b&&(a+=b.outerHTML+
"\n");a+=document.getElementById("voyant-notebooks-styles").outerHTML+"\n<script> // this script checks to see if embedded tools seem to be available\nwindow.addEventListener('load', function() {\nvar hostnames = {}, warned = false;\ndocument.querySelectorAll('iframe').forEach(function(iframeEl) {\nlet url = new URL(iframeEl.src);\nif (!(url.hostname in hostnames) && !warned) {\nhostnames[url.hostname] = true; // mark as fetched\nfetch(url).catch(response => {\nwarned = true;\nalert('This notebook seems to contain one ore more tools that may not be able to load. Possible reasons include a server no longer being accessible (especially if the notebook was generated from a local server), or because of security restrictions.'+url)\n})\n}\n})\n})\n\x3c/script>\n</head>\n<body class='exported-notebook'>"+
this.getHeaderHtml()+"<article class='spyralArticle'>";this.getComponent("cells").items.each(function(c,d){var e=c.isXType("notebookcodeeditorwrapper")?"code":"text";d=c.getContent();var f=c.down("notebookwrappercounter");a+="<section id='"+f.name+"' class='notebook-editor-wrapper "+c.xtype+"'>\n<div class='notebookwrappercounter'>"+f.getTargetEl().dom.innerHTML+"</div>";if("code"===e){e=c.down("notebookcodeeditor").getMode();e=e.substring(e.lastIndexOf("/")+1);f=c.getExpandResults();var g=c.getAutoExecute()?
"autoexec":"";c=c.getTargetEl().query(".ace_text-layer")[0].cloneNode(!0);c.style.setProperty("height","auto");a+="<div class='notebook-code-editor ace-chrome'>\n"+c.outerHTML+"\n</div>\n<pre class='notebook-code-editor-raw editor-mode-"+e+" "+g+"'>"+d.input+"</pre>\n<div class='notebook-code-results"+(f?"":" collapsed")+"'>\n"+d.output+"\n</div>\n";void 0!==d.ui&&(a+="<div class='notebook-code-ui'>\n"+d.ui+"\n</div>\n")}else a+="<div class='notebook-text-editor'>"+d+"</div>\n";a+="</section>\n"});
return a+="</article>\n<footer class='spyral-footer'>"+this.getInnerFooterHtml()+"</footer></body>\n</html>"},getHeaderHtml:function(){return"<header class='spyral-header'>"+this.getInnerHeaderHtml()+"</header>\n"},getInnerHeaderHtml:function(){var a="";this.getMetadata().title&&(a+="<div class='title'>"+this.getMetadata().title+"</div>");this.getMetadata().author&&(a+="<div class='author'>"+this.getMetadata().author+"</div>");return a},getInnerFooterHtml:function(){var a="",b=this.getMetadata();
if(b.author||b.license)a="&copy;",b.author&&(a+=" "+b.author),b.license&&(a+=" ("+b.license+")"),a+=". ";if(b.created||b.modified){var c=b.shortDate("created");b=b.shortDate("modified");c&&(a+=this.localize("created")+" "+c+".");b&&c!=b&&(a+=this.localize("modified")+" "+b+".")}return a},getExtraExportItems:function(){return[{inputValue:"html",boxLabel:this.localize("exportHtml")},{inputValue:"htmlDownload",boxLabel:'<a href="#">'+this.localize("exportHtmlDownload")+"</a>",listeners:{afterrender:function(a){var b=
(this.getNotebookId()||"spyral")+".html",c=this.generateExportHtml(),d={type:"text/html"};try{var e=new File([c],b,d)}catch(f){e=new Blob([c],d)}e=URL.createObjectURL(e);a=a.boxLabelEl.dom.querySelector("a");a.setAttribute("download",b);a.setAttribute("href",e)},scope:this},handler:function(a){a.boxLabelEl.dom.querySelector("a").click();a.up("window").close()}}]},exportHtml:function(){var a=this.generateExportHtml(),b=window.open();b.document.write(a);b.document.close();b.focus()},exportHtmlDownload:function(){var a=
this.generateExportHtml(),b={type:"text/plain"};try{var c=new File([a],"files.txt",b)}catch(d){c=new Blob([a],b)}c=URL.createObjectURL(c);this.getApplication().openUrl(c)},getExportUrl:function(a){return location.href},showMetadataEditor:function(){if(void 0===this.metadataWindow){var a=this;this.metadataWindow=Ext.create("Ext.window.Window",{title:this.localize("metadataEditor"),autoScroll:!0,closeAction:"hide",items:[{xtype:"form",items:{bodyPadding:5,width:600,layout:"anchor",defaults:{anchor:"100%",
labelAlign:"right"},defaultType:"textfield",items:[{fieldLabel:this.localize("metadataTitle"),xtype:"htmleditor",name:"title",height:100,enableAlignments:!1,enableColors:!1,enableFont:!1,enableFontSize:!1,enableLinks:!1,enableLists:!1},{fieldLabel:this.localize("metadataAuthor"),name:"author"},{fieldLabel:this.localize("metadataKeywords"),name:"keywords"},{xtype:"htmleditor",fieldLabel:this.localize("metadataDescription"),name:"description",height:100,enableAlignments:!1,enableColors:!1,enableFont:!1},
{xtype:"combo",fieldLabel:this.localize("metadataLicense"),name:"license",store:{fields:["text"],data:[{text:"Apache License 2.0"},{text:'BSD 3-Clause "New" or "Revised" license'},{text:'BSD 2-Clause "Simplified" or "FreeBSD" license'},{text:"Creative Commons Attribution (CC BY)"},{text:"Creative Commons Attribution-ShareAlike (CC BY-SA)"},{text:"Creative Commons Zero (CC0)"},{text:"GNU General Public License (GPL)"},{text:'GNU Library or "Lesser" General Public License (LGPL)'},{text:"MIT license"},
{text:"Mozilla Public License 2.0"},{text:"Common Development and Distribution License"},{text:"Eclipse Public License"}]}},{xtype:"combo",name:"language",fieldLabel:this.localize("metadataLanguage"),store:{fields:["text"],data:[{text:"Bengali"},{text:"Bhojpuri"},{text:"Egyptian Arabic"},{text:"English"},{text:"French"},{text:"German"},{text:"Gujarati"},{text:"Hausa"},{text:"Hindi"},{text:"Indonesian"},{text:"Italian"},{text:"Japanese"},{text:"Javanese"},{text:"Kannada"},{text:"Korean"},{text:"Mandarin"},
{text:"Marathi"},{text:"Persian"},{text:"Portuguese"},{text:"Russian"},{text:"Southern Min"},{text:"Spanish"},{text:"Standard Arabic"},{text:"Swahili"},{text:"Tamil"},{text:"Telugu"},{text:"Thai"},{text:"Turkish"},{text:"Urdu"},{text:"Vietnamese"},{text:"Western Punjabi"},{text:"Wu Chinese"},{text:"Yue Chinese"}]}}]}}],buttons:[{text:this.localize("metadataCancel"),ui:"default-toolbar",handler:function(){this.up("window").close()}},{text:this.localize("metadataReset"),ui:"default-toolbar",handler:function(){this.up("window").down("form").getForm().reset()}},
" ",{text:this.localize("metadataSave"),handler:function(){var d=this.up("window").down("form").getForm();a.getMetadata().set(d.getValues());a.updateMetadata();this.up("window").close()}}]})}var b=this.getMetadata();void 0===b&&(b=new Spyral.Metadata,this.setMetadata(b));var c=this.metadataWindow.down("form").getForm();c.findField("title").setValue(b.title);c.findField("author").setValue(b.author);c.findField("keywords").setValue(b.keywords);c.findField("description").setValue(b.description);c.findField("license").setValue(b.license||
"Creative Commons Attribution (CC BY)");c.findField("language").setValue(b.language||"English");this.metadataWindow.show()}});Ext.define("Voyant.VoyantApp",{extend:"Ext.app.Application",mixins:["Voyant.util.Deferrable","Voyant.util.Localization","Voyant.util.Api","Voyant.util.Colors"],requires:["Voyant.util.ResponseError"],name:"VoyantApp",statics:{i18n:{},api:{palette:"default",categories:"auto",lang:void 0,debug:void 0}},config:{baseUrl:void 0,tromboneUrl:void 0,categoriesManager:void 0},constructor:function(a){this.setBaseUrl(this.config.baseUrl);this.setTromboneUrl(this.config.baseUrl+"trombone");Voyant.application=
this;this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.mixins["Voyant.util.Colors"].constructor.apply(this,arguments);this.setCategoriesManager(new Spyral.Categories);this.getCategoriesManager().addFeature("color");this.getCategoriesManager().addFeature("font",'"Palatino Linotype", "Book Antiqua", Palatino, serif');this.callParent(arguments);var b=this.getColor;this.getColor=function(d,e){return b.apply(this,[this.getApiParam("palette"),d,e])};var c=this.getColorForTerm;this.getColorForTerm=
function(d,e){return c.apply(this,[this.getApiParam("palette"),d,e])}},getBaseUrl:function(){var a=this.callParent();return 0==a.indexOf("//")?location.protocol+a:a},getBaseUrlFull:function(){return window.location.origin+this.getBaseUrl()},getRelativeUrl:function(){for(var a="",b=0,c=window.location.pathname.substring(this.getBaseUrl().length).split("/").length-1;b<c;b++)a+="../";return a},getTools:function(){return[{type:"maximize"},{type:"help"}]},launch:function(){Ext.tip.QuickTipManager.init();
Ext.apply(Ext.tip.QuickTipManager.getQuickTip(),{showDelay:50});this.callParent(arguments)},tromboneCall:function(a){a=a?a:{};Ext.applyIf(a,{url:this.getTromboneUrl()});a.success||a.failure||a.callback||Ext.applyIf(a,{url:this.getTromboneUrl(),scope:this,callback:function(b,c,d){this.dispatchEvent(a.tool+"Loaded",b,c,d)}});Ext.Ajax.request(a)},getViewport:function(){return Ext.ComponentQuery.query("viewport")[0]},dispatchEvent:function(a,b){var c=this.getViewport().query("panel,chart"),d=!1;this.hasListener&&
this.hasListener(a)&&(this.fireEvent.apply(this,arguments),d=!0);for(var e=0;e<c.length;e++)!c[e].hasListener||!c[e].hasListener(a)||b&&b.getId&&c[e].getId&&b.getId()==c[e].getId()||(d=!0,c[e].fireEvent.apply(c[e],arguments));if(!d){c=["unhandledEvent",b,a];for(e=2;e<arguments.length;e++)c.push(arguments[e]);this.fireEvent.apply(this,c)}},showResponseError:function(a,b){this.showError(Ext.create("Voyant.util.ResponseError",{msg:Ext.isString(a)?a:a.msg,response:b}))},showError:function(a,b){if(a instanceof
Voyant.util.ResponseError)a={message:a.getMsg()+"<p class='error'>\n"+a.getError()+" \u2026 <a href='#' onclick=\"window.open('').document.write(unescape('<pre>"+escape(a.getDetails())+"</pre>')); return false;\">more</a></p>"};else if(Ext.isString(a))a={message:a};else if(Ext.isObject(a)&&(a.responseText||a.statusText))return this.showResponseError(a.statusText,a);Ext.applyIf(a,{title:this.localize("error"),buttons:Ext.Msg.OK,icon:Ext.MessageBox.ERROR,autoScroll:!0});Ext.Msg.show(a)},getToolConfigFromToolXtype:function(a){cls=
Ext.ClassManager.getByAlias("widget."+a);return{xtype:a,title:this._localizeClass(cls,"title"),tooltip:{text:this._localizeClass(cls,"helpTip")},glyph:cls&&cls.glyph?cls.glyph:"xf12e@FontAwesome"}},openUrl:function(a){window.open(a)||Ext.Msg.show({title:"Popup Blocked",buttonText:{ok:"Close"},icon:Ext.MessageBox.INFO,message:"A popup window was blocked. <a href='"+a+"' target='_blank' class='link'>Click here</a> to open the new window.",buttons:Ext.Msg.OK})}});Ext.define("Voyant.VoyantCorpusApp",{extend:"Voyant.VoyantApp",name:"VoyantCorpusApp",requires:"Voyant.panel.CorpusSet Voyant.data.model.Corpus Voyant.panel.VoyantHeader Voyant.panel.VoyantFooter Voyant.panel.CorpusCreator Voyant.panel.Cirrus Voyant.panel.Summary Voyant.panel.DreamScape Voyant.panel.CorpusTerms Voyant.panel.Reader Voyant.panel.Documents Voyant.panel.Trends Voyant.panel.Contexts Voyant.panel.DocumentTerms Voyant.panel.CorpusCollocates Voyant.panel.CollocatesGraph Voyant.panel.Phrases Voyant.panel.ScatterPlot Voyant.panel.TopicContexts Voyant.panel.TermsRadio Voyant.panel.TermsBerry".split(" "),
statics:{i18n:{},api:{toolFlow:void 0}},constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},config:{corpus:void 0,corpusAccess:void 0,moreTools:[{i18n:"moreToolsScaleCorpus",glyph:"xf065@FontAwesome",items:"cirrus corpusterms bubblelines correlations corpuscollocates dreamscape loom mandala microsearch streamgraph phrases documents summary trends scatterplot termsradio topics veliza wordtree".split(" ")},{i18n:"moreToolsScaleDocument",
glyph:"xf066@FontAwesome",items:"bubbles cirrus contexts documentterms reader textualarc trends knots topics".split(" ")},{i18n:"moreToolsTypeViz",glyph:"xf06e@FontAwesome",items:"cirrus bubblelines bubbles collocatesgraph dreamscape loom knots mandala microsearch streamgraph scatterplot textualarc trends termsberry termsradio wordtree".split(" ")},{i18n:"moreToolsTypeGrid",glyph:"xf0ce@FontAwesome",items:"corpusterms corpuscollocates correlations phrases contexts documentterms documents topics".split(" ")},
{i18n:"moreToolsTypeOther",glyph:"xf035@FontAwesome",items:["reader","summary","veliza"]}]},launch:function(a){this.callParent(arguments);if(this.hasQueryToLoad()){var b=Ext.Object.fromQueryString(document.location.search);!b.corpus&&this.getCorpusId&&this.getCorpusId()&&(b.corpus=this.getCorpusId());a&&a.useCache&&(b.useCache=a.useCache);this.loadCorpusFromParams(b);if(b.palette)if(-1<b.palette.indexOf(",")){var c=Ext.decode(b.palette);this.addColorPalette(b.palette,c)}else this.loadColorPaletteForCorpus(b.corpus,
b.palette)}else(b=this.getViewport())&&(b=b.down("corpuscreator"))&&b.toastInfo({html:this.localize("didYouKnowText"),title:this.localize("didYouKnow"),anchor:b.down("textareafield"),align:"tr",listeners:{beforeclose:{fn:function(){this.getHeader().getTools().forEach(function(d){"gear"!=d.type&&"help"!=d.type||d.getEl().frame("#ff0000",1,{duration:3E3})})},scope:b}}})},loadCorpusFromParams:function(a){var b=this,c=b.getViewport();c.mask(this.localize("fetchingCorpus"));a.archive&&(Ext.isString(a.archive)&&
(a.archive=[a.archive]),a.archive=a.archive.map(function(d){return d.replace("/blogs.sub.uni-hamburg.de/hup/lhn/","/wikis.sub.uni-hamburg.de/lhn/index.php/").replace("/hup.sub.uni-hamburg.de/","/wikis.sub.uni-hamburg.de/")}));this.validateCorpusLoadParams(a);(new Voyant.data.model.Corpus(a)).then(function(d){c.unmask();b.setCorpus(d);b.validateCorpusAccess()&&b.dispatchEvent("loadedCorpus",this,d)}).otherwise(function(){c.unmask()})},validateCorpusLoadParams:function(a){},validateCorpusAccess:function(){var a=
this,b=a.getViewport(),c=this.getCorpus();if(c&&c.requiresPassword()&&!a.getViewport().query("panel").every(function(f){return!f.isConsumptive})){var d=c.getNoPasswordAccess(),e=Ext.create("Ext.window.Window",{title:a.localize("passwordRequiredTitle"),layout:"fit",items:{padding:10,flex:1,width:300,layout:{type:"vbox",align:"stretch"},items:[{html:"<p>"+a.localize("passwordRequiredMessage")+"</p>"+("NONCONSUMPTIVE"==d?"<p>"+a.localize("nonConsumptiveMessage")+"</p>":"")+"</p>"},{xtype:"textfield",
fieldLabel:a.localize("password")}],bbar:{layout:{pack:"center"},items:[{text:a.localize("passwordValidateButton"),ui:"default",handler:function(){var f=e.query("textfield")[0].getValue().trim();0==f.length?a.showError({message:a.localize("noPasswordGiven")}):(e.mask(),Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSession:f},method:"POST",success:function(g,h){e.unmask();g=g.responseText;"ADMIN"==g||"ACCESS"==g?(e.close(),b.unmask(),a.setCorpusAccess(g),a.dispatchEvent("loadedCorpus",
this,c)):a.showError({message:a.localize("badPassword")})},failure:function(g,h){e.unmask();a.showError({message:a.localize("passwordValidationError")})}}))}},{text:a.localize("nonConsumptiveButton"),hidden:"NONE"==c.getNoPasswordAccess(),handler:function(){e.mask();Ext.Ajax.request({url:a.getTromboneUrl(),params:{corpus:c.getId(),passwordForSessionRemove:!0},method:"POST",callback:function(f,g){e.unmask();e.close();b.unmask();a.dispatchEvent("loadedCorpus",a,c)}})}}]}}}).show();return!1}return!0},
hasQueryToLoad:function(a){a||(a=Ext.Object.fromQueryString(document.location.search));return a.corpus||a.input||this.getCorpusId&&this.getCorpusId()},loadColorPaletteForCorpus:function(a,b){Ext.Ajax.request({url:this.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:b,corpus:a},success:function(c,d){c=Ext.util.JSON.decode(c.responseText).storedResource.resource;c=Ext.decode(c);this.addColorPalette(b,c)},failure:function(c){this.setApiParam("palette",void 0)},scope:this})},
loadCategoryData:function(a){return this.getCategoriesManager().load(a,{trombone:Voyant.application.getTromboneUrl()})},saveCategoryData:function(a){return this.getCategoriesManager().save({},{trombone:Voyant.application.getTromboneUrl()})},listeners:{loadedCorpus:function(a,b){this.setCorpus(b);this.getApiParam("categories")&&this.loadCategoryData(this.getApiParam("categories")).then(function(){for(var c in this.getCategoriesManager().getCategories()){var d=this.getCategoriesManager().getCategoryFeature(c,
"color");if(void 0!==d){d=this.hexToRgb(d);for(var e=this.getCategoriesManager().getCategoryTerms(c),f=0;f<e.length;f++)this.setColorForTerm(e[f],d)}}}.bind(this));this.on("unhandledEvent",function(c,d,e){c=this.getBaseUrl()+"?corpus="+b.getAliasOrId();var f=this.getModifiedApiParams()||{};delete f.view;if("termsClicked"==d)if(Ext.isArray(e)&&"term"in e[0]&&"docIndex"in e[0]){var g={},h={};e.forEach(function(l){g[l.term]=!0;h[l.docIndex]=!0});f.query=Object.keys(g);f.docIndex=Object.keys(h)}else f.query=
e;else if("documentsClicked"==d){var k=[];e.forEach&&e.forEach(function(l){k.push(l.getIndex())});f.docIndex=k}else if("corpusTermsClicked"==d)e.map&&(f.query=e.map(function(l){return l.getTerm()}));else if("documentTermsClicked"==d)e.map&&(f.query=e.map(function(l){return l.getTerm()}),f.docIndex=e.map(function(l){return l.getDocIndex()}));else{console&&console.warn("Unhandled event: "+d,e);return}f.toolFlow&&(d=Ext.Array.from(f.toolFlow.split(",")),f.view=d.shift(),0<d.length?f.toolFlow=d.join(","):
delete f.toolFlow);c+="&"+Ext.Object.toQueryString(f);this.openUrl(c)})}}});Ext.define("Voyant.panel.DocumentClusters",{extend:"Ext.panel.Panel",alias:"widget.documentclusters",title:"Document Clusters"});
Ext.define("Voyant.VoyantCorpusToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantCorpusToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:!0,items:[{xtype:"cirrus",collapsible:!0},{xtype:"corpusterms",collapsible:!0},{xtype:"documents",collapsible:!0},{xtype:"rezoviz",collapsible:!0},{xtype:"trends",
collapsible:!0},{xtype:"documentclusters",collapsible:!0}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantDefaultApp",{extend:"Voyant.VoyantCorpusApp",mixins:["Voyant.util.Api"],name:"VoyantDefaultApp",constructor:function(){this.mixins["Voyant.util.Api"].constructor.apply(this,arguments);this.callParent(arguments)},statics:{i18n:{},api:{view:"corpusset",stopList:"auto",panels:void 0,rtl:void 0}},listeners:{loadedCorpus:function(a,b){this.viewport.down("voyantheader").collapse();this.viewport.down("#toolsContainer").setActiveItem(1);a=this.getCorpusId&&this.getCorpusId()?this.getCorpusId():
void 0;if(window.history.pushState&&!a){a=b.getAliasOrId();b=Ext.Object.fromQueryString(document.location.search);var c=this.getBaseUrl()+"?corpus="+a,d;for(d in b)if("corpus"!==d){var e=Ext.isString(b[d])?[b[d]]:b[d];Ext.isArray(e)&&e.forEach(function(f){c+="&"+d+"="+f})}window.history.pushState({corpus:a},"Corpus: "+a,c)}}},getViewComponent:function(){return this.viewport.down("#toolsContainer-main")},launch:function(){var a=Ext.Object.fromQueryString(document.location.search)||{},b=this.getApiParam("view",
"CorpusSet"),c=b.toLowerCase();if(!Ext.ClassManager.getByAlias("widget."+c)||a.noskin)Ext.Msg.show({title:this.localize("noViewErrorTitle"),message:(new Ext.Template(this.localize(a.noskin?"noViewKnownErrorTpl":"noViewErrorTpl"))).apply({view:a.noskin?a.noskin:b,additional:a.noskin&&"convert"==a.noskin?this.localize(a.noskin+"SkinMsg"):""}),buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR}),c="corpusset";this.viewport=Ext.create("Ext.container.Viewport",{layout:"border",rtl:void 0!==this.getApiParam("rtl")||
"ar"==Voyant.util.Localization.LANGUAGE||"he"==Voyant.util.Localization.LANGUAGE,items:[{xtype:"voyantheader",region:"north"},{region:"south",xtype:"voyantfooter"},{region:"center",layout:"card",itemId:"toolsContainer",activeItem:0,items:[{xtype:"container",layout:{type:"vbox",pack:"center",align:"center"},items:[{xtype:"corpuscreator"},{xtype:"container",width:800,html:"<div id='voyantIs' style='font-style: italic; text-align: center; margin-top: 10px;'><div>"+this.localize("voyantIs")+"</div>"+
(-1==this.localize("translatedBy").indexOf("English")?"<div>"+this.localize("translatedBy")+"</div>":"")+(this.getCorpusCreatorText&&0<this.getCorpusCreatorText().trim().length?"<div id='corpusCreatorText'>"+this.getCorpusCreatorText()+"</div>":"")}]},{layout:"fit",itemId:"toolsContainer-main",items:{xtype:c}}]}]});this.callParent(arguments)}});Ext.define("Voyant.panel.MoreLikeThis",{extend:"Ext.panel.Panel",alias:"widget.morelikethis",title:"More Like this"});
Ext.define("Voyant.VoyantDocumentToolsetApp",{extend:"Voyant.VoyantCorpusApp",requires:["Voyant.panel.Contexts","Voyant.panel.CollocatesGraph","Voyant.panel.Trends"],name:"VoyantDocumentToolsetApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{region:"south",xtype:"voyantfooter"},{xtype:"tabpanel",region:"center",split:!0,items:[{xtype:"cirrus",collapsible:!0},{xtype:"documentterms",collapsible:!0},{xtype:"contexts",collapsible:!0},{xtype:"collocatesgraph",collapsible:!0},
{xtype:"trends",collapsible:!0},{xtype:"morelikethis",collapsible:!0}],flex:6}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantNotebookApp",{extend:"Voyant.VoyantApp",requires:["Voyant.panel.VoyantFooter","Voyant.notebook.Notebook","Voyant.data.model.Corpus","Voyant.notebook.util.Show"],name:"VoyantNotebookApp",launch:function(){Ext.create("Ext.container.Viewport",{layout:"border",items:[{xtype:"notebook",region:"center"},{xtype:"voyantfooter",region:"south"}]});this.callParent(arguments)}});Ext.define("Voyant.VoyantToolApp",{extend:"Voyant.VoyantCorpusApp",name:"VoyantToolApp",statics:{api:{minimal:void 0,embeddedApiId:void 0}},launch:function(){var a=[],b=this;this.getApiParam("minimal")||a.push({region:"south",xtype:"voyantfooter"});a.push({region:"center",layout:"fit",itemId:"toolcontainer",items:{xtype:this.getApiParam("embeddedApiId")?"container":this.getTool()},listeners:{afterrender:function(c){if(b.getApiParam("embeddedApiId")){var d=b.getDeferred(this);c.mask(this.localize("loadingConfiguration"));
Ext.Ajax.request({url:b.getTromboneUrl(),params:{tool:"resource.StoredResource",retrieveResourceId:this.getApiParam("embeddedApiId")}}).then(function(e){d.resolve();e=Ext.util.JSON.decode(e.responseText);e=decodeURIComponent(e.storedResource.resource);e=Ext.decode(e);var f=Ext.create({xtype:b.getTool()});f.setApiParams(e);c.unmask();c.remove(c.down("container"));c.add(f);e.corpus&&b.loadCorpusFromParams(e)}).otherwise(function(e){b.getTargetEl&&(Voyant.notebook.util.Show.TARGET=b.getTargetEl(),showError(e));
Voyant.application.showError(e);d.reject()})}},scope:this}});Ext.create("Ext.container.Viewport",{layout:"border",items:a});this.callParent(arguments)}});
//# sourceMappingURL=voyant.min.map.js
